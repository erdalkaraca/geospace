import{$ as D,a0 as E,a1 as b,a2 as L,a3 as g,a4 as m,a5 as C,a6 as f,a7 as O,a8 as F,O as T,a9 as V,aa as k,ab as I,ac as M,ad as A,ae as _,af as U,ag as R,ah as P,ai as j,J as N}from"./index-CNuu7pZ0.js";const q=async a=>{var s;const e={interactions:E({keyboard:!1}),controls:D((s=a.mapOptions)==null?void 0:s.controls)},t=a.modules?async i=>a.modules[i]:void 0,r=await b(a.gsMap,e,a.env,t),o=typeof a.containerSelector=="string"?document.querySelector(a.containerSelector):a.containerSelector;return r.setTarget(o),r};class ${constructor(e,t){this.isDestroyed=!1,this.gsMap=e,this.env=t}async reattached(){}async render(e){try{this.olMap=await q({containerSelector:e,gsMap:this.gsMap,env:this.env,mapOptions:{controls:{zoom:!1,attribution:!1}}}),this.operations=new z(this.olMap,this),this.olMap&&(this.olMap.getLayers().getArray().forEach(t=>{L.bindToLayer(t)}),this.olMap.once("rendercomplete",()=>{this.setupEventListeners()}))}catch(t){throw console.error("Failed to render map:",t),t}}async modelToUI(e){if(!this.olMap)throw new Error("Map not initialized");e&&(this.gsMap=e);const t=this.olMap.getTarget();if(!t||typeof t=="string")throw new Error("Map container not found or invalid");this.destroy(),t.innerHTML="",this.isDestroyed=!1,await this.render(t)}getOperations(){if(!this.operations)throw new Error("Operations not available - map not rendered yet");return this.operations}getViewExtent(){if(!this.olMap)throw new Error("OpenLayers map not available for extent calculation");return this.olMap.getView().calculateExtent()}setOnDirty(e){this.onDirtyCallback=e}setOnSync(e){this.onSyncCallback=e}triggerDirty(){this.isDestroyed||!this.onDirtyCallback||this.onDirtyCallback()}triggerSync(e){this.isDestroyed||!this.onSyncCallback||this.onSyncCallback(e)}syncViewToModel(){if(!this.olMap)return;const e=this.olMap.getView(),t=e.getCenter(),r=e.getZoom(),o=e.getRotation();t&&r!==void 0&&this.triggerSync({type:"viewChanged",view:{center:t,zoom:r,rotation:o}})}syncLayerFeaturesToModel(e){if(!this.olMap)return;const r=this.olMap.getLayers().item(e);if(!(r instanceof g))return;const o=r.getSource();if(!o)return;const i=o.getFeatures().map(n=>m(n));this.triggerSync({type:"featuresChanged",layerIndex:e,features:i})}setupEventListeners(){this.olMap&&(this.olMap.getView().on("change:center",()=>{this.syncViewToModel(),this.triggerDirty()}),this.olMap.getView().on("change:resolution",()=>{this.syncViewToModel(),this.triggerDirty()}),this.olMap.getView().on("change:rotation",()=>{this.syncViewToModel(),this.triggerDirty()}),this.olMap.getLayers().on("add",()=>this.triggerDirty()),this.olMap.getLayers().on("remove",()=>this.triggerDirty()),this.olMap.getControls().on("add",()=>this.triggerDirty()),this.olMap.getControls().on("remove",()=>this.triggerDirty()),this.olMap.getOverlays().on("add",()=>this.triggerDirty()),this.olMap.getOverlays().on("remove",()=>this.triggerDirty()))}destroy(){var e;this.isDestroyed=!0,(e=this.olMap)==null||e.dispose(),this.olMap=void 0}}class z{constructor(e,t){if(this.olMap=e,this.renderer=t,!e)throw new Error("OpenLayers map is required for operations")}async setZoom(e){this.olMap.getView().setZoom(e)}async setCenter(e){this.olMap.getView().setCenter(e)}async switchColorMode(e){const t=this.olMap;let r=t.get("darkmode")??!1;e==="dark"?r=!0:e==="light"?r=!1:r=!r,t.set("darkmode",r),document.querySelectorAll("canvas").forEach(s=>{s.style.filter=r?"invert(100%)":""}),t.render()}async addLayer(e,t){const r=C(e);t?this.olMap.getLayers().insertAt(0,r):this.olMap.getLayers().push(r),L.bindToLayer(r)}async deleteLayer(e){this.olMap.getLayers().removeAt(e)}async renameLayer(e,t){const r=this.olMap.getLayers();e>=0&&e<r.getLength()&&r.item(e).set(f,t)}async moveLayer(e,t){const r=this.olMap.getLayers();if(e>=0&&e<r.getLength()&&t>=0&&t<r.getLength()&&e!==t){const o=r.item(e);r.removeAt(e),r.insertAt(t,o)}}async setLayerVisible(e,t){const r=this.olMap.getLayers();e>=0&&e<r.getLength()&&r.item(e).setVisible(t)}async applyStyles(e,t){const r=this.olMap.getLayers();let o;if(typeof e=="number"||typeof e=="string"&&e.trim().match(/\d+/)){const s=parseInt(e.toString())-1;s>=0&&s<r.getLength()&&(o=r.item(s))}else{const s=e.toString().trim().toLowerCase();for(let i=0;i<r.getLength();i++){const n=r.item(i);if(n.get(f)===s){o=n;break}}}if(!o)throw new Error(`Layer not found: ${e}`);L.bindToLayer(o)}async addMarker(e,t){var n;const r=t||"geocoded-markers",o=this.olMap.getLayers();let s=o.getArray().find(l=>l.get(f)===r);s||(s=new g({source:new O,[f]:r}),o.push(s));const i=F(e);(n=s.getSource())==null||n.addFeature(i)}async addControlFromModule(e){}async removeControl(e){}async addOverlayFromModule(e,t){}async removeOverlay(e){}setCursor(e){const t=this.olMap.getViewport();t&&(t.style.cursor=e)}async enableDrawing(e,t){this.disableSelection(),this.drawInteraction&&this.olMap.removeInteraction(this.drawInteraction),this.activeDrawingLayerIndex=t,this.setCursor("crosshair");const o=this.olMap.getLayers().item(t);if(!(o instanceof g))throw new Error("Drawing only supported on vector layers");const s=o.getSource();if(!s)throw new Error("Layer has no source");const i=o.get("sourceType");if(i&&i!==T.Features)throw new Error("Drawing only supported on layers with in-memory features, not URL-loaded data");this.drawInteraction=new V({source:s,type:e});const n=()=>{var l;this.renderer&&this.activeDrawingLayerIndex!==void 0&&this.renderer.syncLayerFeaturesToModel(this.activeDrawingLayerIndex),(l=this.renderer)==null||l.triggerDirty()};s.on("addfeature",n),this.drawInteraction._featureAddedListener=n,this.drawInteraction._sourceRef=s,this.olMap.addInteraction(this.drawInteraction)}async disableDrawing(){if(this.drawInteraction){const e=this.drawInteraction._featureAddedListener,t=this.drawInteraction._sourceRef;e&&t&&t.un("addfeature",e),this.olMap.removeInteraction(this.drawInteraction),this.drawInteraction=void 0,this.setCursor("")}}async enableFeatureSelection(e){this.disableDrawing(),this.disableSelection();const t=this.olMap.getLayers(),r=t.getArray().filter(s=>s instanceof g);if(r.length===0)throw new Error("No vector layers available for selection");if(e>=0&&e<t.getLength()){this.activeDrawingLayerIndex=e;const s=t.item(e);s instanceof g&&(this.activeSelectionLayer=s)}const o={condition:I,layers:r,hitTolerance:5,style:s=>{const i=new U({color:"rgba(255, 255, 0, 1)",width:3}),n=new R({color:"rgba(255, 255, 0, 0.3)"});return new P({image:new j({radius:7,fill:n,stroke:i}),stroke:i,fill:n})}};this.selectInteraction=new k(o),this.selectInteraction.on("select",s=>{var i;if(s.selected.length>0){const n=s.selected[0];let l=-1;if(t.getArray().forEach((w,h)=>{if(w instanceof g){const y=w.getSource();y&&y.hasFeature(n)&&(l=h)}}),l>=0&&this.renderer){const w=m(n),h=n.getGeometry(),y={};if(h){const d=h.getType();try{if(d==="LineString"||d==="MultiLineString")y.length=M(h,{projection:this.olMap.getView().getProjection()});else if(d==="Polygon"||d==="MultiPolygon"){y.area=A(h,{projection:this.olMap.getView().getProjection()});const u=d==="Polygon"?h.getCoordinates()[0]:h.getCoordinates()[0][0];if(u&&u.length>0){const S=new _(u);y.length=M(S,{projection:this.olMap.getView().getProjection()})}}}catch(u){console.warn("Error calculating feature metrics:",u)}}this.renderer.triggerSync({type:"featureSelected",layerIndex:l,feature:w,metrics:y})}}else s.deselected.length>0&&((i=this.renderer)==null||i.triggerSync({type:"featureDeselected"}))}),this.olMap.addInteraction(this.selectInteraction),this.setCursor("pointer")}async deleteSelectedFeatures(){var r,o;if(!this.selectInteraction)throw new Error("No selection interaction active");const e=this.selectInteraction.getFeatures();if(e.getLength()===0)throw new Error("No features selected");const t=(r=this.activeSelectionLayer)==null?void 0:r.getSource();if(!t)throw new Error("No active layer source");e.forEach(s=>{t.removeFeature(s)}),e.clear(),this.renderer&&this.activeDrawingLayerIndex!==void 0&&this.renderer.syncLayerFeaturesToModel(this.activeDrawingLayerIndex),(o=this.renderer)==null||o.triggerDirty()}async disableSelection(){var e;this.selectInteraction&&(this.olMap.removeInteraction(this.selectInteraction),this.selectInteraction=void 0,this.activeSelectionLayer=void 0,this.setCursor(""),(e=this.renderer)==null||e.triggerSync({type:"featureDeselected"}))}}N.resolveUrl=async a=>{try{return await v(a)}catch(e){return console.warn("Failed to resolve asset via host:",e),a}};let c;const p=new Map;let Z=0;window.addEventListener("message",a=>{const{id:e,success:t,assetUrl:r,error:o}=a.data;if(p.has(e)){const{resolve:s,reject:i,timeout:n}=p.get(e);clearTimeout(n),p.delete(e),t?s(r):i(new Error(o))}});async function v(a){return new Promise((e,t)=>{const r=`asset_${++Z}`,o=setTimeout(()=>{p.delete(r),t(new Error("Asset resolution timeout"))},5e3);p.set(r,{resolve:e,reject:t,timeout:o}),window.parent.postMessage({type:"resolveAsset",id:r,path:a},"*")})}async function x(a,e){switch(a){case"render":return c=new $(e.gsMap,e.env),c.setOnDirty(()=>{window.parent.postMessage({type:"dirty"},"*")}),c.setOnSync(t=>{window.parent.postMessage({type:"sync",event:t},"*")}),await c.render("#map-container"),{success:!0};case"modelToUI":return c&&await c.modelToUI(e),{success:!0};case"getViewExtent":return c?{extent:c.getViewExtent()}:{extent:[0,0,0,0]};case"resolveAsset":try{return{success:!0,assetUrl:await v(e.path)}}catch(t){return{success:!1,error:t.message}}default:if(c&&c.getOperations){const t=c.getOperations();if(t[a]&&typeof t[a]=="function")return await t[a](...Object.values(e||{})),{success:!0}}throw new Error(`Unknown method: ${a}`)}}window.addEventListener("message",async a=>{const{id:e,method:t,params:r}=a.data;let o;try{o=await x(t,r)}catch(s){o={error:s.message}}a.source.postMessage({id:e,...o},a.origin)});document.addEventListener("click",()=>{window.parent.postMessage({type:"iframeClicked"},"*")},!0);window.parent.postMessage({type:"rendererReady"},"*");
