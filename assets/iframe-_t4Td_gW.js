import"./modulepreload-polyfill-B5Qt9EMX.js";import{d as C,a as T,t as I,V as u,K as S,b as g,c as D,e as F,F as k,g as V,f as M,h as O,G as A,D as U,S as _,i as x,j as R,C as j,k as P,l as q,m as L,n as z,L as G,o as v,p as m,v as H,r as N}from"./index-C8ZI3MYM.js";import"./preload-helper-WQhrSmCl.js";import"./chunk.LTSJC6DR-BTS7fm5P.js";const $=async n=>{const e={interactions:T({keyboard:!1}),controls:C(n.mapOptions?.controls)};let t=n.importer;!t&&n.modules&&(t=async i=>{const o=n.modules[i];if(o)return typeof o=="string"?import(o):o;throw new Error(`Module not found: ${i}`)});const r=await I(n.gsMap,e,n.env,t),s=typeof n.containerSelector=="string"?document.querySelector(n.containerSelector):n.containerSelector;return r.setTarget(s),r};function K(n){const e=n.getGeometry();return v({geometry:v({type:e.getType(),coordinates:[]}),state:n.get(m)})}class Y{constructor(e,t){this.isDestroyed=!1,this.styleCache=new Map,this.gsMap=e,this.env=t}async reattached(){}async render(e){try{this.olMap=await $({containerSelector:e,gsMap:this.gsMap,env:this.env,mapOptions:{controls:{zoom:!1,attribution:!1}}}),this.operations=new Z(this.olMap,this),this.applyStylesToLayers(),this.olMap.once("rendercomplete",()=>{this.setupEventListeners()})}catch(t){throw console.error("Failed to render map:",t),t}}applyStylesToLayers(){if(!this.olMap)return;this.olMap.getLayers().getArray().forEach(t=>{t instanceof u&&this.applyStyleToVectorLayer(t)})}applyStyleToVectorLayer(e){const t=e.get(S),r=s=>{if(!(s instanceof k))return;const i=K(s),o=this.gsMap.styleRules,a=this.gsMap.styles;if(o&&a){const c=V(i,o,a,t);if(c&&c.id){let l=this.styleCache.get(c.id);return l||(l=M(c),this.styleCache.set(c.id,l)),l}else if(c)return M(c)}};e.setStyle(r)}clearStyleCache(){this.styleCache.clear()}async modelToUI(e){if(!this.olMap)throw new Error("Map not initialized");e&&(this.gsMap=e),this.clearStyleCache();const t=this.olMap.getTarget();if(!t||typeof t=="string")throw new Error("Map container not found or invalid");this.destroy(),t.innerHTML="",this.isDestroyed=!1,await this.render(t)}getOperations(){if(!this.operations)throw new Error("Operations not available - map not rendered yet");return this.operations}async getViewExtent(){if(console.debug("Getting view extent"),!this.olMap)throw new Error("OpenLayers map not available for extent calculation");const t=this.olMap.getView().calculateExtent();return console.debug(`View extent: ${t}`),t}setOnDirty(e){this.onDirtyCallback=e}setOnSync(e){this.onSyncCallback=e}triggerDirty(){this.isDestroyed||!this.onDirtyCallback||this.onDirtyCallback()}triggerSync(e){this.isDestroyed||!this.onSyncCallback||this.onSyncCallback(e)}syncViewToModel(){if(!this.olMap)return;const e=this.olMap.getView(),t=e.getCenter(),r=e.getZoom(),s=e.getRotation();t&&r!==void 0&&this.triggerSync({type:"viewChanged",view:{center:t,zoom:r,rotation:s}})}syncLayerFeaturesToModel(e){if(!this.olMap)return;const t=this.olMap.getLayers();let r;for(let a=0;a<t.getLength();a++){const c=t.item(a);if(c.get(g)===e){r=c;break}}if(!r||!(r instanceof u))return;const s=r.getSource();if(!s)return;const o=s.getFeatures().map(a=>D(a));this.triggerSync({type:"featuresChanged",layerUuid:e,features:o})}setupEventListeners(){this.olMap&&(this.olMap.getView().on("change:center",()=>{this.syncViewToModel(),this.triggerDirty()}),this.olMap.getView().on("change:resolution",()=>{this.syncViewToModel(),this.triggerDirty()}),this.olMap.getView().on("change:rotation",()=>{this.syncViewToModel(),this.triggerDirty()}),this.olMap.getLayers().on("add",()=>this.triggerDirty()),this.olMap.getLayers().on("remove",()=>this.triggerDirty()),this.olMap.getControls().on("add",()=>this.triggerDirty()),this.olMap.getControls().on("remove",()=>this.triggerDirty()),this.olMap.getOverlays().on("add",()=>this.triggerDirty()),this.olMap.getOverlays().on("remove",()=>this.triggerDirty()))}destroy(){if(this.isDestroyed=!0,this.clearStyleCache(),this.operations){const e=this.operations;e.cleanup&&e.cleanup()}this.olMap&&F(this.olMap),this.olMap?.dispose(),this.olMap=void 0}}class Z{constructor(e,t){if(this.olMap=e,this.renderer=t,!e)throw new Error("OpenLayers map is required for operations");this.keyDownListener=s=>{s.key==="Escape"&&(this.drawInteraction&&(this.disableDrawing(),this.renderer?.triggerSync({type:"drawingDisabled"})),this.selectInteraction&&this.disableSelection())};const r=this.olMap.getTargetElement();r&&r instanceof HTMLElement&&(r.setAttribute("tabindex","-1"),r.addEventListener("keydown",this.keyDownListener))}async setZoom(e){this.olMap.getView().setZoom(e)}async setCenter(e){this.olMap.getView().setCenter(e)}async switchColorMode(e){const t=this.olMap;let r=t.get("darkmode")??!1;e==="dark"?r=!0:e==="light"?r=!1:r=!r,t.set("darkmode",r),document.querySelectorAll("canvas").forEach(i=>{i.style.filter=r?"invert(100%)":""}),t.render()}async addLayer(e,t){const r=O(e);t?this.olMap.getLayers().insertAt(0,r):this.olMap.getLayers().push(r)}async deleteLayer(e){const t=this.olMap.getLayers();for(let r=0;r<t.getLength();r++)if(t.item(r).get(g)===e){t.removeAt(r);return}}async renameLayer(e,t){const r=this.olMap.getLayers();for(let s=0;s<r.getLength();s++){const i=r.item(s);if(i.get(g)===e){i.set(S,t);return}}}async moveLayer(e,t){const r=this.olMap.getLayers();let s=-1,i=-1;for(let o=0;o<r.getLength();o++){const a=r.item(o);a.get(g)===e&&(s=o),t&&a.get(g)===t&&(i=o)}if(!(s<0)){if(t){if(i<0||s===i)return}else i=s>0?s-1:s+1;if(i>=0&&i<r.getLength()&&s!==i){const o=r.item(s);r.removeAt(s),r.insertAt(i,o)}}}async setLayerVisible(e,t){const r=this.olMap.getLayers();for(let s=0;s<r.getLength();s++){const i=r.item(s);if(i.get(g)===e){i.setVisible(t);return}}}async addControlFromModule(e){}async removeControl(e){}async addOverlayFromModule(e,t){}async removeOverlay(e){}setCursor(e){const t=this.olMap.getViewport();t&&(t.style.cursor=e)}async enableDrawing(e,t){this.disableSelection(),this.drawInteraction&&this.olMap.removeInteraction(this.drawInteraction),this.activeDrawingLayerUuid=t,this.setCursor("crosshair");const r=this.olMap.getLayers();let s;for(let c=0;c<r.getLength();c++){const l=r.item(c);if(l.get(g)===t){s=l;break}}if(!s||!(s instanceof u))throw new Error("Drawing only supported on vector layers");const i=s.getSource();if(!i)throw new Error("Layer has no source");const o=s.get("sourceType");if(o&&o!==A.Features)throw new Error("Drawing only supported on layers with in-memory features, not URL-loaded data");this.drawInteraction=new U({source:i,type:e});const a=c=>{const l=c.feature;if(l&&!l.get(g)){const h=H();l.set(g,h);const d=l.get(m)||{};d.uuid=h,l.set(m,d)}this.renderer&&this.activeDrawingLayerUuid&&this.renderer.syncLayerFeaturesToModel(this.activeDrawingLayerUuid),this.renderer?.triggerDirty()};i.on("addfeature",a),this.drawInteraction._featureAddedListener=a,this.drawInteraction._sourceRef=i,this.olMap.addInteraction(this.drawInteraction)}async disableDrawing(){if(this.drawInteraction){const e=this.drawInteraction._featureAddedListener,t=this.drawInteraction._sourceRef;e&&t&&t.un("addfeature",e),this.olMap.removeInteraction(this.drawInteraction),this.drawInteraction=void 0,this.setCursor("")}}cleanup(){if(this.keyDownListener){const e=this.olMap.getTargetElement();e&&e instanceof HTMLElement&&e.removeEventListener("keydown",this.keyDownListener),this.keyDownListener=void 0}}async enableFeatureSelection(){this.disableDrawing(),this.disableSelection();const e=this.olMap.getLayers(),t=e.getArray().filter(o=>o instanceof u);if(t.length===0)throw new Error("No vector layers available for selection");const s=this.renderer?.gsMap?.styles?.selection,i={condition:q,layers:t,hitTolerance:5,style:s?M(s):o=>{const a=new _({color:"rgba(255, 255, 0, 1)",width:3}),c=new x({color:"rgba(255, 255, 0, 0.3)"});return new R({image:new j({radius:7,fill:c,stroke:a}),stroke:a,fill:c})}};this.selectInteraction=new P(i),this.selectInteraction.on("select",o=>{if(o.selected.length>0){const a=o.selected[0];let c;if(e.getArray().forEach(l=>{if(l instanceof u){const h=l.getSource();if(h&&h.hasFeature(a)){const d=l.get(g);d&&(c=d)}}}),c&&this.renderer){const l=D(a),h=a.getGeometry(),d={};if(h){const p=h.getType();try{if(p==="LineString"||p==="MultiLineString")d.length=L(h,{projection:this.olMap.getView().getProjection()});else if(p==="Polygon"||p==="MultiPolygon"){d.area=z(h,{projection:this.olMap.getView().getProjection()});const f=p==="Polygon"?h.getCoordinates()[0]:h.getCoordinates()[0][0];if(f&&f.length>0){const b=new G(f);d.length=L(b,{projection:this.olMap.getView().getProjection()})}}}catch(f){console.warn("Error calculating feature metrics:",f)}}this.renderer.triggerSync({type:"featureSelected",layerUuid:c,feature:l,metrics:d})}}else o.deselected.length>0&&this.renderer?.triggerSync({type:"featureDeselected"})}),this.olMap.addInteraction(this.selectInteraction),this.setCursor("pointer")}async deleteSelectedFeatures(){if(!this.selectInteraction)throw new Error("No selection interaction active");const e=this.selectInteraction.getFeatures();if(e.getLength()===0)throw new Error("No features selected");const t=new Set,r=this.olMap.getLayers();e.forEach(s=>{for(let i=0;i<r.getLength();i++){const o=r.item(i);if(o instanceof u){const a=o.getSource();if(a&&a.hasFeature(s)){a.removeFeature(s);const c=o.get(g);c&&t.add(c);break}}}}),e.clear(),this.renderer&&t.size>0&&t.forEach(s=>{this.renderer.syncLayerFeaturesToModel(s)}),this.renderer?.triggerDirty()}async disableSelection(){this.selectInteraction&&(this.olMap.removeInteraction(this.selectInteraction),this.selectInteraction=void 0,this.setCursor(""),this.renderer?.triggerSync({type:"featureDeselected"}))}}N.resolveUrl=async n=>{try{return await E(n)}catch(e){return console.warn("Failed to resolve asset via host:",e),n}};let y;const w=new Map;let W=0;window.addEventListener("message",n=>{const{id:e,success:t,assetUrl:r,error:s}=n.data;if(w.has(e)){const{resolve:i,reject:o,timeout:a}=w.get(e);clearTimeout(a),w.delete(e),t?i(r):o(new Error(s))}});async function E(n){return new Promise((e,t)=>{const r=`asset_${++W}`,s=setTimeout(()=>{w.delete(r),t(new Error("Asset resolution timeout"))},5e3);w.set(r,{resolve:e,reject:t,timeout:s}),window.parent.postMessage({type:"resolveAsset",id:r,path:n},"*")})}async function B(n,e){switch(n){case"render":return y=new Y(e.gsMap,e.env),y.setOnDirty(()=>{window.parent.postMessage({type:"dirty"},"*")}),y.setOnSync(t=>{window.parent.postMessage({type:"sync",event:t},"*")}),await y.render("#map-container"),{success:!0};case"modelToUI":return y&&await y.modelToUI(e),{success:!0};case"getViewExtent":return y?{extent:await y.getViewExtent()}:{extent:[0,0,0,0]};case"captureScreenshot":if(y&&y.olMap){const t=y.olMap;await new Promise(o=>{t.renderSync(),t.once("rendercomplete",()=>{o()}),setTimeout(()=>{o()},2e3)});const r=t.getSize(),s=r?r[0]:t.getViewport().clientWidth,i=r?r[1]:t.getViewport().clientHeight;try{const o=t.getViewport().querySelector("canvas");return o?{success:!0,dataUrl:o.toDataURL("image/png"),width:s,height:i}:{success:!1,error:"Map canvas not found"}}catch(o){return{success:!1,error:`Failed to capture canvas: ${o.message}`}}}else return{success:!1,error:"Map renderer not available"};case"resolveAsset":try{return{success:!0,assetUrl:await E(e.path)}}catch(t){return{success:!1,error:t.message}}default:if(y&&y.getOperations){const t=y.getOperations();if(t[n]&&typeof t[n]=="function")return await t[n](...Object.values(e||{})),{success:!0}}throw new Error(`Unknown method: ${n}`)}}window.addEventListener("message",async n=>{const{id:e,method:t,params:r}=n.data;let s;try{s=await B(t,r)}catch(i){s={error:i.message}}n.source.postMessage({id:e,...s},n.origin)});document.addEventListener("click",()=>{window.parent.postMessage({type:"iframeClicked"},"*")},!0);window.parent.postMessage({type:"rendererReady"},"*");
