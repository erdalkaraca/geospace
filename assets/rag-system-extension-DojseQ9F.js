const __vite__mapDeps=(i,m=__vite__mapDeps,d=(m.f||(m.f=["assets/rag-integration-OPE_9al8.js","assets/main-DCJ5rN70.js","assets/index-D_931DYw.js","assets/index-aP6FMjSZ.css","assets/main-DQjgvuwU.css"])))=>i.map(i=>d[i]);
import{p as sb,g as fi,_ as ty,b as ob,n as cb,r as Kr,e as ub,x as ct,E as lo,d as lb,t as db}from"./index-D_931DYw.js";import{z as $r,W as fb,X as Zd,j as hb,Y as pb,s as Ah,Z as mb,y as gb,p as yb,F as Ir,D as vb,w as Va,r as _b,k as wb,b as ft,a as er,t as Qr,u as td,h as xn,e as bb,d as Qn,V as Eb}from"./main-DCJ5rN70.js";function Xi(e){"@babel/helpers - typeof";return Xi=typeof Symbol=="function"&&typeof Symbol.iterator=="symbol"?function(t){return typeof t}:function(t){return t&&typeof Symbol=="function"&&t.constructor===Symbol&&t!==Symbol.prototype?"symbol":typeof t},Xi(e)}function xb(e,t){if(Xi(e)!="object"||!e)return e;var r=e[Symbol.toPrimitive];if(r!==void 0){var n=r.call(e,t);if(Xi(n)!="object")return n;throw new TypeError("@@toPrimitive must return a primitive value.")}return String(e)}function Sb(e){var t=xb(e,"string");return Xi(t)=="symbol"?t:t+""}function kb(e,t){for(var r=0;r<t.length;r++){var n=t[r];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,Sb(n.key),n)}}function Bn(e,t,r){return t&&kb(e.prototype,t),Object.defineProperty(e,"prototype",{writable:!1}),e}function Ib(e){return e[e.length-1]}function Jd(e){return Array.isArray(e)?e.slice(0):[e]}function Ob(e,t){e=e.slice(0);for(var r=[];e.length;){var n=e.splice(0,t);r.push(n)}return r}function Qd(e){return Array.isArray(e)}function Tb(e){return e!=null}function vu(e,t){var r=0,n=-1;for(var a of e){n=n+1;var i=t(a,n);if(i)r=r+1;else break}return r}function pa(e,t){var r=t.length;if(r!==0){var n=e.length;e.length=n+t.length;for(var a=0;a<r;++a)e[n+a]=t[a]}}function Rb(e){return e.filter(function(t,r,n){return n.indexOf(t)===r})}function Nn(e){for(var t="",r=0;r<e.length;r++){var n=e[r];if(n==="-")return parseInt(t,10);t+=n}throw new Error("malformatted revision: "+e)}function nn(e,t){var r=t?Nn(t._rev)+1:1;return r+"-"+e}function $b(e){var t=e.split("."),r=t.length;return r===1?n=>n[e]:n=>{for(var a=n,i=0;i<r;++i){var s=t[i];if(a=a[s],typeof a>"u")return a}return a}}function at(e){return Object.assign({},e)}function Ab(e){return Object.keys(e)[0]}function zo(e,t=!1){if(!e)return e;if(!t&&Array.isArray(e))return e.sort((n,a)=>typeof n=="string"&&typeof a=="string"?n.localeCompare(a):typeof n=="object"?1:-1).map(n=>zo(n,t));if(typeof e=="object"&&!Array.isArray(e)){var r={};return Object.keys(e).sort((n,a)=>n.localeCompare(a)).forEach(n=>{r[n]=zo(e[n],t)}),r}return e}function rd(e){if(!e||e===null||typeof e!="object")return e;if(Array.isArray(e)){for(var t=new Array(e.length),r=t.length;r--;)t[r]=rd(e[r]);return t}var n={};for(var a in e)n[a]=rd(e[a]);return n}var Ut=rd;function en(e,t,r){return Object.defineProperty(e,t,{get:function(){return r}}),r}var Yd=1;function Ea(){return{lwt:Yd}}function yr(){return""}function Cb(e){return Object.assign({},e,{_meta:void 0,_deleted:void 0,_rev:void 0})}function Pb(e,t,r){if(t.length!==r.length)return!1;for(var n=0,a=t.length;n<a;){var i=t[n],s=r[n];if(n++,i._rev!==s._rev||i[e]!==s[e])return!1}return!0}var Nb=Object.defineProperty,Db=(e,t,r)=>t in e?Nb(e,t,{enumerable:!0,configurable:!0,writable:!0,value:r}):e[t]=r,Ka=(e,t,r)=>(Db(e,typeof t!="symbol"?t+"":t,r),r);class An{constructor(t,r){Ka(this,"words"),Ka(this,"sigBytes"),t=this.words=t||[],this.sigBytes=r===void 0?t.length*4:r}toString(t){return(t||Lb).stringify(this)}concat(t){if(this.clamp(),this.sigBytes%4)for(let r=0;r<t.sigBytes;r++){const n=t.words[r>>>2]>>>24-r%4*8&255;this.words[this.sigBytes+r>>>2]|=n<<24-(this.sigBytes+r)%4*8}else for(let r=0;r<t.sigBytes;r+=4)this.words[this.sigBytes+r>>>2]=t.words[r>>>2];return this.sigBytes+=t.sigBytes,this}clamp(){this.words[this.sigBytes>>>2]&=4294967295<<32-this.sigBytes%4*8,this.words.length=Math.ceil(this.sigBytes/4)}clone(){return new An([...this.words])}}const Lb={stringify(e){const t=[];for(let r=0;r<e.sigBytes;r++){const n=e.words[r>>>2]>>>24-r%4*8&255;t.push((n>>>4).toString(16),(n&15).toString(16))}return t.join("")}},Mb={parse(e){const t=e.length,r=[];for(let n=0;n<t;n++)r[n>>>2]|=(e.charCodeAt(n)&255)<<24-n%4*8;return new An(r,t)}},jb={parse(e){return Mb.parse(unescape(encodeURIComponent(e)))}};class Fb{constructor(){Ka(this,"_data",new An),Ka(this,"_nDataBytes",0),Ka(this,"_minBufferSize",0),Ka(this,"blockSize",512/32)}reset(){this._data=new An,this._nDataBytes=0}_append(t){typeof t=="string"&&(t=jb.parse(t)),this._data.concat(t),this._nDataBytes+=t.sigBytes}_doProcessBlock(t,r){}_process(t){let r,n=this._data.sigBytes/(this.blockSize*4);t?n=Math.ceil(n):n=Math.max((n|0)-this._minBufferSize,0);const a=n*this.blockSize,i=Math.min(a*4,this._data.sigBytes);if(a){for(let s=0;s<a;s+=this.blockSize)this._doProcessBlock(this._data.words,s);r=this._data.words.splice(0,a),this._data.sigBytes-=i}return new An(r,i)}}class Bb extends Fb{update(t){return this._append(t),this._process(),this}finalize(t){t&&this._append(t)}}var Ub=Object.defineProperty,zb=(e,t,r)=>t in e?Ub(e,t,{enumerable:!0,configurable:!0,writable:!0,value:r}):e[t]=r,qb=(e,t,r)=>(zb(e,t+"",r),r);const Ch=[1779033703,-1150833019,1013904242,-1521486534,1359893119,-1694144372,528734635,1541459225],Hb=[1116352408,1899447441,-1245643825,-373957723,961987163,1508970993,-1841331548,-1424204075,-670586216,310598401,607225278,1426881987,1925078388,-2132889090,-1680079193,-1046744716,-459576895,-272742522,264347078,604807628,770255983,1249150122,1555081692,1996064986,-1740746414,-1473132947,-1341970488,-1084653625,-958395405,-710438585,113926993,338241895,666307205,773529912,1294757372,1396182291,1695183700,1986661051,-2117940946,-1838011259,-1564481375,-1474664885,-1035236496,-949202525,-778901479,-694614492,-200395387,275423344,430227734,506948616,659060556,883997877,958139571,1322822218,1537002063,1747873779,1955562222,2024104815,-2067236844,-1933114872,-1866530822,-1538233109,-1090935817,-965641998],Yn=[];class Kb extends Bb{constructor(){super(...arguments),qb(this,"_hash",new An([...Ch]))}reset(){super.reset(),this._hash=new An([...Ch])}_doProcessBlock(t,r){const n=this._hash.words;let a=n[0],i=n[1],s=n[2],o=n[3],c=n[4],u=n[5],d=n[6],h=n[7];for(let p=0;p<64;p++){if(p<16)Yn[p]=t[r+p]|0;else{const T=Yn[p-15],B=(T<<25|T>>>7)^(T<<14|T>>>18)^T>>>3,U=Yn[p-2],K=(U<<15|U>>>17)^(U<<13|U>>>19)^U>>>10;Yn[p]=B+Yn[p-7]+K+Yn[p-16]}const y=c&u^~c&d,g=a&i^a&s^i&s,w=(a<<30|a>>>2)^(a<<19|a>>>13)^(a<<10|a>>>22),b=(c<<26|c>>>6)^(c<<21|c>>>11)^(c<<7|c>>>25),x=h+b+y+Hb[p]+Yn[p],O=w+g;h=d,d=u,u=c,c=o+x|0,o=s,s=i,i=a,a=x+O|0}n[0]=n[0]+a|0,n[1]=n[1]+i|0,n[2]=n[2]+s|0,n[3]=n[3]+o|0,n[4]=n[4]+c|0,n[5]=n[5]+u|0,n[6]=n[6]+d|0,n[7]=n[7]+h|0}finalize(t){super.finalize(t);const r=this._nDataBytes*8,n=this._data.sigBytes*8;return this._data.words[n>>>5]|=128<<24-n%32,this._data.words[(n+64>>>9<<4)+14]=Math.floor(r/4294967296),this._data.words[(n+64>>>9<<4)+15]=r,this._data.sigBytes=this._data.words.length*4,this._process(),this._hash}}function Gb(e){return new Kb().finalize(e).toString()}function Wb(e){return Promise.resolve(Gb(e))}async function Vb(e){var t=new TextEncoder().encode(e),r=await crypto.subtle.digest("SHA-256",t),n=Array.prototype.map.call(new Uint8Array(r),a=>("00"+a.toString(16)).slice(-2)).join("");return n}var Zb=typeof crypto<"u"&&typeof crypto.subtle<"u"&&typeof crypto.subtle.digest=="function",ry=Zb?Vb:Wb;function Jb(){return new Promise(e=>setTimeout(e,0))}function Qb(e=0){return new Promise(t=>setTimeout(t,e))}function Yb(e){return e&&typeof e.then=="function"?e:Promise.resolve(e)}var Xb=Promise.resolve(!0),Or=Promise.resolve(!1),Xd=Promise.resolve(null),gr=Promise.resolve();function yc(e=1e4){return typeof requestIdleCallback=="function"?new Promise(t=>{requestIdleCallback(()=>t(),{timeout:e})}):Qb(0)}var _u=gr;function e0(e=void 0){return _u=_u.then(()=>yc(e)),_u}function t0(e,t){return e.reduce((r,n)=>r.then(n),Promise.resolve(t))}var r0=/\./g,Ph="abcdefghijklmnopqrstuvwxyz";function bs(e=10){for(var t="",r=0;r<e;r++)t+=Ph.charAt(Math.floor(Math.random()*Ph.length));return t}function ny(e){e+="";var t=e.charAt(0).toUpperCase();return t+e.substr(1)}function Mi(e){for(;e.charAt(0)===".";)e=e.substr(1);for(;e.slice(-1)===".";)e=e.slice(0,-1);return e}function es(e,t){if(e===t)return!0;if(e&&t&&typeof e=="object"&&typeof t=="object"){if(e.constructor!==t.constructor)return!1;var r,n;if(Array.isArray(e)){if(r=e.length,r!==t.length)return!1;for(n=r;n--!==0;)if(!es(e[n],t[n]))return!1;return!0}if(e.constructor===RegExp)return e.source===t.source&&e.flags===t.flags;if(e.valueOf!==Object.prototype.valueOf)return e.valueOf()===t.valueOf();if(e.toString!==Object.prototype.toString)return e.toString()===t.toString();var a=Object.keys(e);if(r=a.length,r!==Object.keys(t).length)return!1;for(n=r;n--!==0;)if(!Object.prototype.hasOwnProperty.call(t,a[n]))return!1;for(n=r;n--!==0;){var i=a[n];if(!es(e[i],t[i]))return!1}return!0}return e!==e&&t!==t}var nd=e=>{var t=typeof e;return e!==null&&(t==="object"||t==="function")},wu=new Set(["__proto__","prototype","constructor"]),n0=new Set("0123456789");function ay(e){var t=[],r="",n="start",a=!1;for(var i of e)switch(i){case"\\":{if(n==="index")throw new Error("Invalid character in an index");if(n==="indexEnd")throw new Error("Invalid character after an index");a&&(r+=i),n="property",a=!a;break}case".":{if(n==="index")throw new Error("Invalid character in an index");if(n==="indexEnd"){n="property";break}if(a){a=!1,r+=i;break}if(wu.has(r))return[];t.push(r),r="",n="property";break}case"[":{if(n==="index")throw new Error("Invalid character in an index");if(n==="indexEnd"){n="index";break}if(a){a=!1,r+=i;break}if(n==="property"){if(wu.has(r))return[];t.push(r),r=""}n="index";break}case"]":{if(n==="index"){t.push(Number.parseInt(r,10)),r="",n="indexEnd";break}if(n==="indexEnd")throw new Error("Invalid character after an index")}default:{if(n==="index"&&!n0.has(i))throw new Error("Invalid character in an index");if(n==="indexEnd")throw new Error("Invalid character after an index");n==="start"&&(n="property"),a&&(a=!1,r+="\\"),r+=i}}switch(a&&(r+="\\"),n){case"property":{if(wu.has(r))return[];t.push(r);break}case"index":throw new Error("Index was not closed");case"start":{t.push("");break}}return t}function iy(e,t){if(typeof t!="number"&&Array.isArray(e)){var r=Number.parseInt(t,10);return Number.isInteger(r)&&e[r]===e[t]}return!1}function a0(e,t){if(iy(e,t))throw new Error("Cannot use string index")}function Dn(e,t,r){if(Array.isArray(t)&&(t=t.join(".")),!t.includes(".")&&!t.includes("["))return e[t];if(!nd(e)||typeof t!="string")return r===void 0?e:r;var n=ay(t);if(n.length===0)return r;for(var a=0;a<n.length;a++){var i=n[a];if(iy(e,i)?e=a===n.length-1?void 0:null:e=e[i],e==null){if(a!==n.length-1)return r;break}}return e===void 0?r:e}function sy(e,t,r){if(Array.isArray(t)&&(t=t.join(".")),!nd(e)||typeof t!="string")return e;for(var n=e,a=ay(t),i=0;i<a.length;i++){var s=a[i];a0(e,s),i===a.length-1?e[s]=r:nd(e[s])||(e[s]=typeof a[i+1]=="number"?[]:{}),e=e[s]}return n}function ma(e,t){var r=e.get(t);if(typeof r>"u")throw new Error("missing value from map "+t);return r}function an(e,t,r,n){var a=e.get(t);return typeof a>"u"&&(a=r(),e.set(t,a)),a}function et(e){var t=e.split("-"),r="RxDB";return t.forEach(n=>{r+=ny(n)}),r+="Plugin",new Error(`You are using a function which must be overwritten by a plugin.
        You should either prevent the usage of this function or add the plugin via:
            import { `+r+" } from 'rxdb/plugins/"+e+`';
            addRxPlugin(`+r+`);
        `)}function i0(e){var t={name:e.name,message:e.message,rxdb:e.rxdb,parameters:e.parameters,extensions:e.extensions,code:e.code,url:e.url,stack:e.stack?e.stack.replace(/\n/g,` 
 `):void 0};return t}var bu=0;function Rt(){var e=Date.now();e=e+.01,e<=bu&&(e=bu+.01);var t=parseFloat(e.toFixed(2));return bu=t,t}function Ue(e,t){if(!e)throw t||(t=""),new Error("ensureNotFalsy() is falsy: "+t);return e}var Es={bufferSize:1,refCount:!0},oy="15.39.0",Eu={},s0="6da4936d1425ff3a5c44c02342c6daf791d266be3ae8479b8ec59e261df41b93";function ts(e,t){return ts=Object.setPrototypeOf?Object.setPrototypeOf.bind():function(r,n){return r.__proto__=n,r},ts(e,t)}function ef(e,t){e.prototype=Object.create(t.prototype),e.prototype.constructor=e,ts(e,t)}function ad(e){return ad=Object.setPrototypeOf?Object.getPrototypeOf.bind():function(t){return t.__proto__||Object.getPrototypeOf(t)},ad(e)}function o0(e){try{return Function.toString.call(e).indexOf("[native code]")!==-1}catch{return typeof e=="function"}}function cy(){try{var e=!Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],function(){}))}catch{}return(cy=function(){return!!e})()}function c0(e,t,r){if(cy())return Reflect.construct.apply(null,arguments);var n=[null];n.push.apply(n,t);var a=new(e.bind.apply(e,n));return r&&ts(a,r.prototype),a}function qo(e){var t=typeof Map=="function"?new Map:void 0;return qo=function(n){if(n===null||!o0(n))return n;if(typeof n!="function")throw new TypeError("Super expression must either be null or a function");if(t!==void 0){if(t.has(n))return t.get(n);t.set(n,a)}function a(){return c0(n,arguments,ad(this).constructor)}return a.prototype=Object.create(n.prototype,{constructor:{value:a,enumerable:!1,writable:!0,configurable:!0}}),ts(a,n)},qo(e)}var rt={isDevMode(){return!1},deepFreezeWhenDevMode(e){return e},tunnelErrorMessage(e){return"RxDB Error-Code "+e+`.
        Error messages are not included in RxDB core to reduce build size.
        `}};function u0(e){var t="";return Object.keys(e).length===0||(t+=`Given parameters: {
`,t+=Object.keys(e).map(r=>{var n="[object Object]";try{r==="errors"?n=e[r].map(a=>JSON.stringify(a,Object.getOwnPropertyNames(a))):n=JSON.stringify(e[r],function(a,i){return i===void 0?null:i},2)}catch{}return r+":"+n}).join(`
`),t+="}"),t}function uy(e,t,r){return"RxError ("+t+`):
`+e+`
`+u0(r)}var l0=(function(e){function t(n,a,i={}){var s,o=uy(a,n,i);return s=e.call(this,o)||this,s.code=n,s.message=o,s.url=tf(n),s.parameters=i,s.rxdb=!0,s}ef(t,e);var r=t.prototype;return r.toString=function(){return this.message},Bn(t,[{key:"name",get:function(){return"RxError ("+this.code+")"}},{key:"typeError",get:function(){return!1}}])})(qo(Error)),d0=(function(e){function t(n,a,i={}){var s,o=uy(a,n,i);return s=e.call(this,o)||this,s.code=n,s.message=o,s.url=tf(n),s.parameters=i,s.rxdb=!0,s}ef(t,e);var r=t.prototype;return r.toString=function(){return this.message},Bn(t,[{key:"name",get:function(){return"RxTypeError ("+this.code+")"}},{key:"typeError",get:function(){return!0}}])})(qo(TypeError));function tf(e){return"https://rxdb.info/errors.html?console=errors#"+e}function ly(e){return`
 You can find out more about this error here: `+tf(e)+" "}function ye(e,t){return new l0(e,rt.tunnelErrorMessage(e)+ly(e),t)}function tr(e,t){return new d0(e,rt.tunnelErrorMessage(e)+ly(e),t)}function vc(e){return e&&e.status===409?e:!1}var f0={409:"document write conflict",422:"schema validation error",510:"attachment data missing"};function h0(e){return ye("COL20",{name:f0[e.status],document:e.documentId,writeError:e})}var rs={preAddRxPlugin:[],preCreateRxDatabase:[],createRxDatabase:[],preCreateRxCollection:[],createRxCollection:[],createRxState:[],postDestroyRxCollection:[],postRemoveRxCollection:[],preCreateRxSchema:[],createRxSchema:[],preCreateRxQuery:[],prePrepareQuery:[],createRxDocument:[],postCreateRxDocument:[],preCreateRxStorageInstance:[],preStorageWrite:[],preMigrateDocument:[],postMigrateDocument:[],preDestroyRxDatabase:[],postRemoveRxDatabase:[],postCleanup:[],preReplicationMasterWrite:[],preReplicationMasterWriteDocumentsHandle:[]};function vr(e,t){rs[e].length>0&&rs[e].forEach(r=>r(t))}function xs(e,t){return Promise.all(rs[e].map(r=>r(t)))}function Xa(e,t){var r=t;r=r.replace(r0,".properties."),r="properties."+r,r=Mi(r);var n=Dn(e,r);return n}function p0(e,t,r){if(typeof t.primaryKey=="string")return r;var n=xa(t,r),a=r[e];if(a&&a!==n)throw ye("DOC19",{args:{documentData:r,existingPrimary:a,newPrimary:n},schema:t});return r[e]=n,r}function cr(e){return typeof e=="string"?e:e.key}function m0(e){var t=cr(e.primaryKey),r=Xa(e,t);return Ue(r.maxLength)}function xa(e,t){if(typeof e.primaryKey=="string")return t[e.primaryKey];var r=e.primaryKey;return r.fields.map(n=>{var a=Dn(t,n);if(typeof a>"u")throw ye("DOC18",{args:{field:n,documentData:t}});return a}).join(r.separator)}function g0(e){var t=zo(e,!0);return t}function y0(e){return["_deleted",e]}function _c(e){e=at(e);var t=cr(e.primaryKey);e.properties=at(e.properties),e.additionalProperties=!1,Object.prototype.hasOwnProperty.call(e,"keyCompression")||(e.keyCompression=!1),e.indexes=e.indexes?e.indexes.slice(0):[],e.required=e.required?e.required.slice(0):[],e.encrypted=e.encrypted?e.encrypted.slice(0):[],e.properties._rev={type:"string",minLength:1},e.properties._attachments={type:"object"},e.properties._deleted={type:"boolean"},e.properties._meta=v0,e.required=e.required?e.required.slice(0):[],e.required.push("_deleted"),e.required.push("_rev"),e.required.push("_meta"),e.required.push("_attachments");var r=dy(e);pa(e.required,r),e.required=e.required.filter(i=>!i.includes(".")).filter((i,s,o)=>o.indexOf(i)===s),e.version=e.version||0;var n=e.indexes.map(i=>{var s=Qd(i)?i.slice(0):[i];return s.includes(t)||s.push(t),s[0]!=="_deleted"&&s.unshift("_deleted"),s});n.length===0&&n.push(y0(t)),n.push(["_meta.lwt",t]),e.internalIndexes&&e.internalIndexes.map(i=>{n.push(i)});var a=new Set;return n.filter(i=>{var s=i.join(",");return a.has(s)?!1:(a.add(s),!0)}),e.indexes=n,e}var v0={type:"object",properties:{lwt:{type:"number",minimum:Yd,maximum:1e15,multipleOf:.01}},additionalProperties:!0,required:["lwt"]};function dy(e){var t=Object.keys(e.properties).filter(n=>e.properties[n].final),r=cr(e.primaryKey);return t.push(r),typeof e.primaryKey!="string"&&e.primaryKey.fields.forEach(n=>t.push(n)),t}function _0(e,t){for(var r=Object.keys(e.defaultValues),n=0;n<r.length;++n){var a=r[n];(!Object.prototype.hasOwnProperty.call(t,a)||typeof t[a]>"u")&&(t[a]=e.defaultValues[a])}return t}var fy=(function(){function e(r,n){this.jsonSchema=r,this.hashFunction=n,this.indexes=w0(this.jsonSchema),this.primaryPath=cr(this.jsonSchema.primaryKey),this.finalFields=dy(this.jsonSchema)}var t=e.prototype;return t.validateChange=function(n,a){this.finalFields.forEach(i=>{if(!es(n[i],a[i]))throw ye("DOC9",{dataBefore:n,dataAfter:a,fieldName:i,schema:this.jsonSchema})})},t.getDocumentPrototype=function(){var n={},a=Xa(this.jsonSchema,"");return Object.keys(a).forEach(i=>{var s=i;n.__defineGetter__(i,function(){if(!(!this.get||typeof this.get!="function")){var o=this.get(s);return o}}),Object.defineProperty(n,i+"$",{get:function(){return this.get$(s)},enumerable:!1,configurable:!1}),Object.defineProperty(n,i+"$$",{get:function(){return this.get$$(s)},enumerable:!1,configurable:!1}),Object.defineProperty(n,i+"_",{get:function(){return this.populate(s)},enumerable:!1,configurable:!1})}),en(this,"getDocumentPrototype",()=>n),n},t.getPrimaryOfDocumentData=function(n){return xa(this.jsonSchema,n)},Bn(e,[{key:"version",get:function(){return this.jsonSchema.version}},{key:"defaultValues",get:function(){var r={};return Object.entries(this.jsonSchema.properties).filter(([,n])=>Object.prototype.hasOwnProperty.call(n,"default")).forEach(([n,a])=>r[n]=a.default),en(this,"defaultValues",r)}},{key:"hash",get:function(){return en(this,"hash",this.hashFunction(JSON.stringify(this.jsonSchema)))}}])})();function w0(e){return(e.indexes||[]).map(t=>Qd(t)?t:[t])}function b0(e){var t=e.version?e.version:0,r=0;return new Array(t).fill(0).map(()=>r++)}function E0(e,t,r=!0){r&&vr("preCreateRxSchema",e);var n=_c(e);n=g0(n),rt.deepFreezeWhenDevMode(n);var a=new fy(n,t);return vr("createRxSchema",a),a}function gt(e){return typeof e=="function"}function x0(e){return gt(e?.lift)}function Gr(e){return function(t){if(x0(t))return t.lift(function(r){try{return e(r,this)}catch(n){this.error(n)}});throw new TypeError("Unable to lift unknown Observable type")}}var id=function(e,t){return id=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(r,n){r.__proto__=n}||function(r,n){for(var a in n)Object.prototype.hasOwnProperty.call(n,a)&&(r[a]=n[a])},id(e,t)};function Sa(e,t){if(typeof t!="function"&&t!==null)throw new TypeError("Class extends value "+String(t)+" is not a constructor or null");id(e,t);function r(){this.constructor=e}e.prototype=t===null?Object.create(t):(r.prototype=t.prototype,new r)}function S0(e,t,r,n){function a(i){return i instanceof r?i:new r(function(s){s(i)})}return new(r||(r=Promise))(function(i,s){function o(d){try{u(n.next(d))}catch(h){s(h)}}function c(d){try{u(n.throw(d))}catch(h){s(h)}}function u(d){d.done?i(d.value):a(d.value).then(o,c)}u((n=n.apply(e,t||[])).next())})}function hy(e,t){var r={label:0,sent:function(){if(i[0]&1)throw i[1];return i[1]},trys:[],ops:[]},n,a,i,s=Object.create((typeof Iterator=="function"?Iterator:Object).prototype);return s.next=o(0),s.throw=o(1),s.return=o(2),typeof Symbol=="function"&&(s[Symbol.iterator]=function(){return this}),s;function o(u){return function(d){return c([u,d])}}function c(u){if(n)throw new TypeError("Generator is already executing.");for(;s&&(s=0,u[0]&&(r=0)),r;)try{if(n=1,a&&(i=u[0]&2?a.return:u[0]?a.throw||((i=a.return)&&i.call(a),0):a.next)&&!(i=i.call(a,u[1])).done)return i;switch(a=0,i&&(u=[u[0]&2,i.value]),u[0]){case 0:case 1:i=u;break;case 4:return r.label++,{value:u[1],done:!1};case 5:r.label++,a=u[1],u=[0];continue;case 7:u=r.ops.pop(),r.trys.pop();continue;default:if(i=r.trys,!(i=i.length>0&&i[i.length-1])&&(u[0]===6||u[0]===2)){r=0;continue}if(u[0]===3&&(!i||u[1]>i[0]&&u[1]<i[3])){r.label=u[1];break}if(u[0]===6&&r.label<i[1]){r.label=i[1],i=u;break}if(i&&r.label<i[2]){r.label=i[2],r.ops.push(u);break}i[2]&&r.ops.pop(),r.trys.pop();continue}u=t.call(e,r)}catch(d){u=[6,d],a=0}finally{n=i=0}if(u[0]&5)throw u[1];return{value:u[0]?u[1]:void 0,done:!0}}}function ei(e){var t=typeof Symbol=="function"&&Symbol.iterator,r=t&&e[t],n=0;if(r)return r.call(e);if(e&&typeof e.length=="number")return{next:function(){return e&&n>=e.length&&(e=void 0),{value:e&&e[n++],done:!e}}};throw new TypeError(t?"Object is not iterable.":"Symbol.iterator is not defined.")}function ga(e,t){var r=typeof Symbol=="function"&&e[Symbol.iterator];if(!r)return e;var n=r.call(e),a,i=[],s;try{for(;(t===void 0||t-- >0)&&!(a=n.next()).done;)i.push(a.value)}catch(o){s={error:o}}finally{try{a&&!a.done&&(r=n.return)&&r.call(n)}finally{if(s)throw s.error}}return i}function ya(e,t,r){if(r||arguments.length===2)for(var n=0,a=t.length,i;n<a;n++)(i||!(n in t))&&(i||(i=Array.prototype.slice.call(t,0,n)),i[n]=t[n]);return e.concat(i||Array.prototype.slice.call(t))}function Za(e){return this instanceof Za?(this.v=e,this):new Za(e)}function k0(e,t,r){if(!Symbol.asyncIterator)throw new TypeError("Symbol.asyncIterator is not defined.");var n=r.apply(e,t||[]),a,i=[];return a=Object.create((typeof AsyncIterator=="function"?AsyncIterator:Object).prototype),o("next"),o("throw"),o("return",s),a[Symbol.asyncIterator]=function(){return this},a;function s(y){return function(g){return Promise.resolve(g).then(y,h)}}function o(y,g){n[y]&&(a[y]=function(w){return new Promise(function(b,x){i.push([y,w,b,x])>1||c(y,w)})},g&&(a[y]=g(a[y])))}function c(y,g){try{u(n[y](g))}catch(w){p(i[0][3],w)}}function u(y){y.value instanceof Za?Promise.resolve(y.value.v).then(d,h):p(i[0][2],y)}function d(y){c("next",y)}function h(y){c("throw",y)}function p(y,g){y(g),i.shift(),i.length&&c(i[0][0],i[0][1])}}function I0(e){if(!Symbol.asyncIterator)throw new TypeError("Symbol.asyncIterator is not defined.");var t=e[Symbol.asyncIterator],r;return t?t.call(e):(e=typeof ei=="function"?ei(e):e[Symbol.iterator](),r={},n("next"),n("throw"),n("return"),r[Symbol.asyncIterator]=function(){return this},r);function n(i){r[i]=e[i]&&function(s){return new Promise(function(o,c){s=e[i](s),a(o,c,s.done,s.value)})}}function a(i,s,o,c){Promise.resolve(c).then(function(u){i({value:u,done:o})},s)}}var py=(function(e){return e&&typeof e.length=="number"&&typeof e!="function"});function my(e){return gt(e?.then)}function rf(e){var t=function(n){Error.call(n),n.stack=new Error().stack},r=e(t);return r.prototype=Object.create(Error.prototype),r.prototype.constructor=r,r}var xu=rf(function(e){return function(r){e(this),this.message=r?r.length+` errors occurred during unsubscription:
`+r.map(function(n,a){return a+1+") "+n.toString()}).join(`
  `):"",this.name="UnsubscriptionError",this.errors=r}});function sd(e,t){if(e){var r=e.indexOf(t);0<=r&&e.splice(r,1)}}var wc=(function(){function e(t){this.initialTeardown=t,this.closed=!1,this._parentage=null,this._finalizers=null}return e.prototype.unsubscribe=function(){var t,r,n,a,i;if(!this.closed){this.closed=!0;var s=this._parentage;if(s)if(this._parentage=null,Array.isArray(s))try{for(var o=ei(s),c=o.next();!c.done;c=o.next()){var u=c.value;u.remove(this)}}catch(w){t={error:w}}finally{try{c&&!c.done&&(r=o.return)&&r.call(o)}finally{if(t)throw t.error}}else s.remove(this);var d=this.initialTeardown;if(gt(d))try{d()}catch(w){i=w instanceof xu?w.errors:[w]}var h=this._finalizers;if(h){this._finalizers=null;try{for(var p=ei(h),y=p.next();!y.done;y=p.next()){var g=y.value;try{Nh(g)}catch(w){i=i??[],w instanceof xu?i=ya(ya([],ga(i)),ga(w.errors)):i.push(w)}}}catch(w){n={error:w}}finally{try{y&&!y.done&&(a=p.return)&&a.call(p)}finally{if(n)throw n.error}}}if(i)throw new xu(i)}},e.prototype.add=function(t){var r;if(t&&t!==this)if(this.closed)Nh(t);else{if(t instanceof e){if(t.closed||t._hasParent(this))return;t._addParent(this)}(this._finalizers=(r=this._finalizers)!==null&&r!==void 0?r:[]).push(t)}},e.prototype._hasParent=function(t){var r=this._parentage;return r===t||Array.isArray(r)&&r.includes(t)},e.prototype._addParent=function(t){var r=this._parentage;this._parentage=Array.isArray(r)?(r.push(t),r):r?[r,t]:t},e.prototype._removeParent=function(t){var r=this._parentage;r===t?this._parentage=null:Array.isArray(r)&&sd(r,t)},e.prototype.remove=function(t){var r=this._finalizers;r&&sd(r,t),t instanceof e&&t._removeParent(this)},e.EMPTY=(function(){var t=new e;return t.closed=!0,t})(),e})(),gy=wc.EMPTY;function yy(e){return e instanceof wc||e&&"closed"in e&&gt(e.remove)&&gt(e.add)&&gt(e.unsubscribe)}function Nh(e){gt(e)?e():e.unsubscribe()}var O0={Promise:void 0},T0={setTimeout:function(e,t){for(var r=[],n=2;n<arguments.length;n++)r[n-2]=arguments[n];return setTimeout.apply(void 0,ya([e,t],ga(r)))},clearTimeout:function(e){return clearTimeout(e)},delegate:void 0};function vy(e){T0.setTimeout(function(){throw e})}function Dh(){}function Ro(e){e()}var nf=(function(e){Sa(t,e);function t(r){var n=e.call(this)||this;return n.isStopped=!1,r?(n.destination=r,yy(r)&&r.add(n)):n.destination=A0,n}return t.create=function(r,n,a){return new ti(r,n,a)},t.prototype.next=function(r){this.isStopped||this._next(r)},t.prototype.error=function(r){this.isStopped||(this.isStopped=!0,this._error(r))},t.prototype.complete=function(){this.isStopped||(this.isStopped=!0,this._complete())},t.prototype.unsubscribe=function(){this.closed||(this.isStopped=!0,e.prototype.unsubscribe.call(this),this.destination=null)},t.prototype._next=function(r){this.destination.next(r)},t.prototype._error=function(r){try{this.destination.error(r)}finally{this.unsubscribe()}},t.prototype._complete=function(){try{this.destination.complete()}finally{this.unsubscribe()}},t})(wc),R0=(function(){function e(t){this.partialObserver=t}return e.prototype.next=function(t){var r=this.partialObserver;if(r.next)try{r.next(t)}catch(n){fo(n)}},e.prototype.error=function(t){var r=this.partialObserver;if(r.error)try{r.error(t)}catch(n){fo(n)}else fo(t)},e.prototype.complete=function(){var t=this.partialObserver;if(t.complete)try{t.complete()}catch(r){fo(r)}},e})(),ti=(function(e){Sa(t,e);function t(r,n,a){var i=e.call(this)||this,s;return gt(r)||!r?s={next:r??void 0,error:n??void 0,complete:a??void 0}:s=r,i.destination=new R0(s),i}return t})(nf);function fo(e){vy(e)}function $0(e){throw e}var A0={closed:!0,next:Dh,error:$0,complete:Dh},af=(function(){return typeof Symbol=="function"&&Symbol.observable||"@@observable"})();function Ss(e){return e}function C0(e){return e.length===0?Ss:e.length===1?e[0]:function(r){return e.reduce(function(n,a){return a(n)},r)}}var ir=(function(){function e(t){t&&(this._subscribe=t)}return e.prototype.lift=function(t){var r=new e;return r.source=this,r.operator=t,r},e.prototype.subscribe=function(t,r,n){var a=this,i=N0(t)?t:new ti(t,r,n);return Ro(function(){var s=a,o=s.operator,c=s.source;i.add(o?o.call(i,c):c?a._subscribe(i):a._trySubscribe(i))}),i},e.prototype._trySubscribe=function(t){try{return this._subscribe(t)}catch(r){t.error(r)}},e.prototype.forEach=function(t,r){var n=this;return r=Lh(r),new r(function(a,i){var s=new ti({next:function(o){try{t(o)}catch(c){i(c),s.unsubscribe()}},error:i,complete:a});n.subscribe(s)})},e.prototype._subscribe=function(t){var r;return(r=this.source)===null||r===void 0?void 0:r.subscribe(t)},e.prototype[af]=function(){return this},e.prototype.pipe=function(){for(var t=[],r=0;r<arguments.length;r++)t[r]=arguments[r];return C0(t)(this)},e.prototype.toPromise=function(t){var r=this;return t=Lh(t),new t(function(n,a){var i;r.subscribe(function(s){return i=s},function(s){return a(s)},function(){return n(i)})})},e.create=function(t){return new e(t)},e})();function Lh(e){var t;return(t=e??O0.Promise)!==null&&t!==void 0?t:Promise}function P0(e){return e&&gt(e.next)&&gt(e.error)&&gt(e.complete)}function N0(e){return e&&e instanceof nf||P0(e)&&yy(e)}function _y(e){return gt(e[af])}function wy(e){return Symbol.asyncIterator&&gt(e?.[Symbol.asyncIterator])}function by(e){return new TypeError("You provided "+(e!==null&&typeof e=="object"?"an invalid object":"'"+e+"'")+" where a stream was expected. You can provide an Observable, Promise, ReadableStream, Array, AsyncIterable, or Iterable.")}function D0(){return typeof Symbol!="function"||!Symbol.iterator?"@@iterator":Symbol.iterator}var Ey=D0();function xy(e){return gt(e?.[Ey])}function Sy(e){return k0(this,arguments,function(){var r,n,a,i;return hy(this,function(s){switch(s.label){case 0:r=e.getReader(),s.label=1;case 1:s.trys.push([1,,9,10]),s.label=2;case 2:return[4,Za(r.read())];case 3:return n=s.sent(),a=n.value,i=n.done,i?[4,Za(void 0)]:[3,5];case 4:return[2,s.sent()];case 5:return[4,Za(a)];case 6:return[4,s.sent()];case 7:return s.sent(),[3,2];case 8:return[3,10];case 9:return r.releaseLock(),[7];case 10:return[2]}})})}function ky(e){return gt(e?.getReader)}function pn(e){if(e instanceof ir)return e;if(e!=null){if(_y(e))return L0(e);if(py(e))return M0(e);if(my(e))return j0(e);if(wy(e))return Iy(e);if(xy(e))return F0(e);if(ky(e))return B0(e)}throw by(e)}function L0(e){return new ir(function(t){var r=e[af]();if(gt(r.subscribe))return r.subscribe(t);throw new TypeError("Provided object does not correctly implement Symbol.observable")})}function M0(e){return new ir(function(t){for(var r=0;r<e.length&&!t.closed;r++)t.next(e[r]);t.complete()})}function j0(e){return new ir(function(t){e.then(function(r){t.closed||(t.next(r),t.complete())},function(r){return t.error(r)}).then(null,vy)})}function F0(e){return new ir(function(t){var r,n;try{for(var a=ei(e),i=a.next();!i.done;i=a.next()){var s=i.value;if(t.next(s),t.closed)return}}catch(o){r={error:o}}finally{try{i&&!i.done&&(n=a.return)&&n.call(a)}finally{if(r)throw r.error}}t.complete()})}function Iy(e){return new ir(function(t){U0(e,t).catch(function(r){return t.error(r)})})}function B0(e){return Iy(Sy(e))}function U0(e,t){var r,n,a,i;return S0(this,void 0,void 0,function(){var s,o;return hy(this,function(c){switch(c.label){case 0:c.trys.push([0,5,6,11]),r=I0(e),c.label=1;case 1:return[4,r.next()];case 2:if(n=c.sent(),!!n.done)return[3,4];if(s=n.value,t.next(s),t.closed)return[2];c.label=3;case 3:return[3,1];case 4:return[3,11];case 5:return o=c.sent(),a={error:o},[3,11];case 6:return c.trys.push([6,,9,10]),n&&!n.done&&(i=r.return)?[4,i.call(r)]:[3,8];case 7:c.sent(),c.label=8;case 8:return[3,10];case 9:if(a)throw a.error;return[7];case 10:return[7];case 11:return t.complete(),[2]}})})}function sn(e,t,r,n,a){return new z0(e,t,r,n,a)}var z0=(function(e){Sa(t,e);function t(r,n,a,i,s,o){var c=e.call(this,r)||this;return c.onFinalize=s,c.shouldUnsubscribe=o,c._next=n?function(u){try{n(u)}catch(d){r.error(d)}}:e.prototype._next,c._error=i?function(u){try{i(u)}catch(d){r.error(d)}finally{this.unsubscribe()}}:e.prototype._error,c._complete=a?function(){try{a()}catch(u){r.error(u)}finally{this.unsubscribe()}}:e.prototype._complete,c}return t.prototype.unsubscribe=function(){var r;if(!this.shouldUnsubscribe||this.shouldUnsubscribe()){var n=this.closed;e.prototype.unsubscribe.call(this),!n&&((r=this.onFinalize)===null||r===void 0||r.call(this))}},t})(nf),Oy={now:function(){return(Oy.delegate||Date).now()},delegate:void 0};function q0(e){return e&&gt(e.schedule)}function sf(e){return e[e.length-1]}function H0(e){return gt(sf(e))?e.pop():void 0}function ks(e){return q0(sf(e))?e.pop():void 0}function Ty(e,t){return typeof sf(e)=="number"?e.pop():t}function Cn(e,t,r,n,a){n===void 0&&(n=0),a===void 0&&(a=!1);var i=t.schedule(function(){r(),a?e.add(this.schedule(null,n)):this.unsubscribe()},n);if(e.add(i),!a)return i}var K0=Array.isArray,G0=Object.getPrototypeOf,W0=Object.prototype,V0=Object.keys;function Z0(e){if(e.length===1){var t=e[0];if(K0(t))return{args:t,keys:null};if(J0(t)){var r=V0(t);return{args:r.map(function(n){return t[n]}),keys:r}}}return{args:e,keys:null}}function J0(e){return e&&typeof e=="object"&&G0(e)===W0}function Ry(e,t){return t===void 0&&(t=0),Gr(function(r,n){r.subscribe(sn(n,function(a){return Cn(n,e,function(){return n.next(a)},t)},function(){return Cn(n,e,function(){return n.complete()},t)},function(a){return Cn(n,e,function(){return n.error(a)},t)}))})}function $y(e,t){return t===void 0&&(t=0),Gr(function(r,n){n.add(e.schedule(function(){return r.subscribe(n)},t))})}function Q0(e,t){return pn(e).pipe($y(t),Ry(t))}function Y0(e,t){return pn(e).pipe($y(t),Ry(t))}function X0(e,t){return new ir(function(r){var n=0;return t.schedule(function(){n===e.length?r.complete():(r.next(e[n++]),r.closed||this.schedule())})})}function eE(e,t){return new ir(function(r){var n;return Cn(r,t,function(){n=e[Ey](),Cn(r,t,function(){var a,i,s;try{a=n.next(),i=a.value,s=a.done}catch(o){r.error(o);return}s?r.complete():r.next(i)},0,!0)}),function(){return gt(n?.return)&&n.return()}})}function Ay(e,t){if(!e)throw new Error("Iterable cannot be null");return new ir(function(r){Cn(r,t,function(){var n=e[Symbol.asyncIterator]();Cn(r,t,function(){n.next().then(function(a){a.done?r.complete():r.next(a.value)})},0,!0)})})}function tE(e,t){return Ay(Sy(e),t)}function rE(e,t){if(e!=null){if(_y(e))return Q0(e,t);if(py(e))return X0(e,t);if(my(e))return Y0(e,t);if(wy(e))return Ay(e,t);if(xy(e))return eE(e,t);if(ky(e))return tE(e,t)}throw by(e)}function Is(e,t){return t?rE(e,t):pn(e)}function bt(e,t){return Gr(function(r,n){var a=0;r.subscribe(sn(n,function(i){n.next(e.call(t,i,a++))}))})}var nE=Array.isArray;function aE(e,t){return nE(t)?e.apply(void 0,ya([],ga(t))):e(t)}function iE(e){return bt(function(t){return aE(e,t)})}function sE(e,t){return e.reduce(function(r,n,a){return r[n]=t[a],r},{})}function oE(){for(var e=[],t=0;t<arguments.length;t++)e[t]=arguments[t];var r=ks(e),n=H0(e),a=Z0(e),i=a.args,s=a.keys;if(i.length===0)return Is([],r);var o=new ir(cE(i,r,s?function(c){return sE(s,c)}:Ss));return n?o.pipe(iE(n)):o}function cE(e,t,r){return r===void 0&&(r=Ss),function(n){Mh(t,function(){for(var a=e.length,i=new Array(a),s=a,o=a,c=function(d){Mh(t,function(){var h=Is(e[d],t),p=!1;h.subscribe(sn(n,function(y){i[d]=y,p||(p=!0,o--),o||n.next(r(i.slice()))},function(){--s||n.complete()}))},n)},u=0;u<a;u++)c(u)},n)}}function Mh(e,t,r){e?Cn(r,e,t):t()}function uE(e,t,r,n,a,i,s,o){var c=[],u=0,d=0,h=!1,p=function(){h&&!c.length&&!u&&t.complete()},y=function(w){return u<n?g(w):c.push(w)},g=function(w){u++;var b=!1;pn(r(w,d++)).subscribe(sn(t,function(x){t.next(x)},function(){b=!0},void 0,function(){if(b)try{u--;for(var x=function(){var O=c.shift();s||g(O)};c.length&&u<n;)x();p()}catch(O){t.error(O)}}))};return e.subscribe(sn(t,y,function(){h=!0,p()})),function(){}}function on(e,t,r){return r===void 0&&(r=1/0),gt(t)?on(function(n,a){return bt(function(i,s){return t(n,i,a,s)})(pn(e(n,a)))},r):(typeof t=="number"&&(r=t),Gr(function(n,a){return uE(n,a,e,r)}))}function of(e){return e===void 0&&(e=1/0),on(Ss,e)}function lE(){return of(1)}var dE=rf(function(e){return function(){e(this),this.name="ObjectUnsubscribedError",this.message="object unsubscribed"}}),nr=(function(e){Sa(t,e);function t(){var r=e.call(this)||this;return r.closed=!1,r.currentObservers=null,r.observers=[],r.isStopped=!1,r.hasError=!1,r.thrownError=null,r}return t.prototype.lift=function(r){var n=new jh(this,this);return n.operator=r,n},t.prototype._throwIfClosed=function(){if(this.closed)throw new dE},t.prototype.next=function(r){var n=this;Ro(function(){var a,i;if(n._throwIfClosed(),!n.isStopped){n.currentObservers||(n.currentObservers=Array.from(n.observers));try{for(var s=ei(n.currentObservers),o=s.next();!o.done;o=s.next()){var c=o.value;c.next(r)}}catch(u){a={error:u}}finally{try{o&&!o.done&&(i=s.return)&&i.call(s)}finally{if(a)throw a.error}}}})},t.prototype.error=function(r){var n=this;Ro(function(){if(n._throwIfClosed(),!n.isStopped){n.hasError=n.isStopped=!0,n.thrownError=r;for(var a=n.observers;a.length;)a.shift().error(r)}})},t.prototype.complete=function(){var r=this;Ro(function(){if(r._throwIfClosed(),!r.isStopped){r.isStopped=!0;for(var n=r.observers;n.length;)n.shift().complete()}})},t.prototype.unsubscribe=function(){this.isStopped=this.closed=!0,this.observers=this.currentObservers=null},Object.defineProperty(t.prototype,"observed",{get:function(){var r;return((r=this.observers)===null||r===void 0?void 0:r.length)>0},enumerable:!1,configurable:!0}),t.prototype._trySubscribe=function(r){return this._throwIfClosed(),e.prototype._trySubscribe.call(this,r)},t.prototype._subscribe=function(r){return this._throwIfClosed(),this._checkFinalizedStatuses(r),this._innerSubscribe(r)},t.prototype._innerSubscribe=function(r){var n=this,a=this,i=a.hasError,s=a.isStopped,o=a.observers;return i||s?gy:(this.currentObservers=null,o.push(r),new wc(function(){n.currentObservers=null,sd(o,r)}))},t.prototype._checkFinalizedStatuses=function(r){var n=this,a=n.hasError,i=n.thrownError,s=n.isStopped;a?r.error(i):s&&r.complete()},t.prototype.asObservable=function(){var r=new ir;return r.source=this,r},t.create=function(r,n){return new jh(r,n)},t})(ir),jh=(function(e){Sa(t,e);function t(r,n){var a=e.call(this)||this;return a.destination=r,a.source=n,a}return t.prototype.next=function(r){var n,a;(a=(n=this.destination)===null||n===void 0?void 0:n.next)===null||a===void 0||a.call(n,r)},t.prototype.error=function(r){var n,a;(a=(n=this.destination)===null||n===void 0?void 0:n.error)===null||a===void 0||a.call(n,r)},t.prototype.complete=function(){var r,n;(n=(r=this.destination)===null||r===void 0?void 0:r.complete)===null||n===void 0||n.call(r)},t.prototype._subscribe=function(r){var n,a;return(a=(n=this.source)===null||n===void 0?void 0:n.subscribe(r))!==null&&a!==void 0?a:gy},t})(nr);function Fh(){for(var e=[],t=0;t<arguments.length;t++)e[t]=arguments[t];return lE()(Is(e,ks(e)))}var fE=new ir(function(e){return e.complete()});function ns(e,t){return t===void 0&&(t=Ss),e=e??hE,Gr(function(r,n){var a,i=!0;r.subscribe(sn(n,function(s){var o=t(s);(i||!e(a,o))&&(i=!1,a=o,n.next(s))}))})}function hE(e,t){return e===t}function tt(e,t){return Gr(function(r,n){var a=0;r.subscribe(sn(n,function(i){return e.call(t,i,a++)&&n.next(i)}))})}var pE=rf(function(e){return function(){e(this),this.name="EmptyError",this.message="no elements in sequence"}});function mE(){for(var e=[],t=0;t<arguments.length;t++)e[t]=arguments[t];var r=ks(e),n=Ty(e,1/0);return Gr(function(a,i){of(n)(Is(ya([a],ga(e)),r)).subscribe(i)})}function gE(){for(var e=[],t=0;t<arguments.length;t++)e[t]=arguments[t];return mE.apply(void 0,ya([],ga(e)))}var na=(function(e){Sa(t,e);function t(r){var n=e.call(this)||this;return n._value=r,n}return Object.defineProperty(t.prototype,"value",{get:function(){return this.getValue()},enumerable:!1,configurable:!0}),t.prototype._subscribe=function(r){var n=e.prototype._subscribe.call(this,r);return!n.closed&&r.next(this._value),n},t.prototype.getValue=function(){var r=this,n=r.hasError,a=r.thrownError,i=r._value;if(n)throw a;return this._throwIfClosed(),i},t.prototype.next=function(r){e.prototype.next.call(this,this._value=r)},t})(nr),yE=(function(e){Sa(t,e);function t(r,n,a){r===void 0&&(r=1/0),n===void 0&&(n=1/0),a===void 0&&(a=Oy);var i=e.call(this)||this;return i._bufferSize=r,i._windowTime=n,i._timestampProvider=a,i._buffer=[],i._infiniteTimeWindow=!0,i._infiniteTimeWindow=n===1/0,i._bufferSize=Math.max(1,r),i._windowTime=Math.max(1,n),i}return t.prototype.next=function(r){var n=this,a=n.isStopped,i=n._buffer,s=n._infiniteTimeWindow,o=n._timestampProvider,c=n._windowTime;a||(i.push(r),!s&&i.push(o.now()+c)),this._trimBuffer(),e.prototype.next.call(this,r)},t.prototype._subscribe=function(r){this._throwIfClosed(),this._trimBuffer();for(var n=this._innerSubscribe(r),a=this,i=a._infiniteTimeWindow,s=a._buffer,o=s.slice(),c=0;c<o.length&&!r.closed;c+=i?1:2)r.next(o[c]);return this._checkFinalizedStatuses(r),n},t.prototype._trimBuffer=function(){var r=this,n=r._bufferSize,a=r._timestampProvider,i=r._buffer,s=r._infiniteTimeWindow,o=(s?1:2)*n;if(n<1/0&&o<i.length&&i.splice(0,i.length-o),!s){for(var c=a.now(),u=0,d=1;d<i.length&&i[d]<=c;d+=2)u=d;u&&i.splice(0,u+1)}},t})(nr);function vE(e){e===void 0&&(e={});var t=e.connector,r=t===void 0?function(){return new nr}:t,n=e.resetOnError,a=n===void 0?!0:n,i=e.resetOnComplete,s=i===void 0?!0:i,o=e.resetOnRefCountZero,c=o===void 0?!0:o;return function(u){var d,h,p,y=0,g=!1,w=!1,b=function(){h?.unsubscribe(),h=void 0},x=function(){b(),d=p=void 0,g=w=!1},O=function(){var T=d;x(),T?.unsubscribe()};return Gr(function(T,B){y++,!w&&!g&&b();var U=p=p??r();B.add(function(){y--,y===0&&!w&&!g&&(h=Su(O,c))}),U.subscribe(B),!d&&y>0&&(d=new ti({next:function(K){return U.next(K)},error:function(K){w=!0,b(),h=Su(x,a,K),U.error(K)},complete:function(){g=!0,b(),h=Su(x,s),U.complete()}}),pn(T).subscribe(d))})(u)}}function Su(e,t){for(var r=[],n=2;n<arguments.length;n++)r[n-2]=arguments[n];if(t===!0){e();return}if(t!==!1){var a=new ti({next:function(){a.unsubscribe(),e()}});return pn(t.apply(void 0,ya([],ga(r)))).subscribe(a)}}function Os(e,t,r){var n,a,i,s,o=!1;return e&&typeof e=="object"?(n=e.bufferSize,s=n===void 0?1/0:n,a=e.windowTime,t=a===void 0?1/0:a,i=e.refCount,o=i===void 0?!1:i,r=e.scheduler):s=e??1/0,vE({connector:function(){return new yE(s,t,r)},resetOnError:!0,resetOnComplete:!1,resetOnRefCountZero:o})}function Ts(){for(var e=[],t=0;t<arguments.length;t++)e[t]=arguments[t];var r=ks(e);return Gr(function(n,a){(r?Fh(e,n,r):Fh(e,n)).subscribe(a)})}function _E(e,t){return Gr(function(r,n){var a=null,i=0,s=!1,o=function(){return s&&!a&&n.complete()};r.subscribe(sn(n,function(c){a?.unsubscribe();var u=0,d=i++;pn(e(c,d)).subscribe(a=sn(n,function(h){return n.next(t?t(c,h,d,u++):h)},function(){a=null,o()}))},function(){s=!0,o()}))})}function Cy(e){return e.documentData?e.documentData:e.previousDocumentData}function wE(e){switch(e.operation){case"INSERT":return{operation:e.operation,id:e.documentId,doc:e.documentData,previous:null};case"UPDATE":return{operation:e.operation,id:e.documentId,doc:rt.deepFreezeWhenDevMode(e.documentData),previous:e.previousDocumentData?e.previousDocumentData:"UNKNOWN"};case"DELETE":return{operation:e.operation,id:e.documentId,doc:null,previous:e.previousDocumentData}}}function sa(e,t){return new Promise(function(r,n){var a=new ti({next:function(i){r(i),a.unsubscribe()},error:n,complete:function(){n(new pE)}});e.subscribe(a)})}function bE(){for(var e=[],t=0;t<arguments.length;t++)e[t]=arguments[t];var r=ks(e),n=Ty(e,1/0),a=e;return a.length?a.length===1?pn(a[0]):of(n)(Is(a,r)):fE}function cf(e){return e[e.length-1]}function EE(e){const t=typeof e;return e!==null&&(t==="object"||t==="function")}function Bh(e,t,r){if(Array.isArray(t)&&(t=t.join(".")),!EE(e)||typeof t!="string")return e;const n=t.split(".");if(n.length===0)return r;for(let a=0;a<n.length;a++){const i=n[a];if(xE(e,i)?e=a===n.length-1?void 0:null:e=e[i],e==null){if(a!==n.length-1)return r;break}}return e===void 0?r:e}function xE(e,t){if(typeof t!="number"&&Array.isArray(e)){const r=Number.parseInt(t,10);return Number.isInteger(r)&&e[r]===e[t]}return!1}const Py=e=>!!e.queryParams.limit,SE=e=>e.queryParams.limit===1,kE=e=>!!(e.queryParams.skip&&e.queryParams.skip>0),IE=e=>e.changeEvent.operation==="DELETE",OE=e=>e.changeEvent.operation==="INSERT",TE=e=>e.changeEvent.operation==="UPDATE",RE=e=>Py(e)&&e.previousResults.length>=e.queryParams.limit,$E=e=>{const t=e.queryParams.sortFields,r=e.changeEvent.previous,n=e.changeEvent.doc;if(!n)return!1;if(!r)return!0;for(let a=0;a<t.length;a++){const i=t[a],s=Bh(r,i),o=Bh(n,i);if(s!==o)return!0}return!1},AE=e=>{const t=e.changeEvent.id;if(e.keyDocumentMap)return e.keyDocumentMap.has(t);{const r=e.queryParams.primaryKey,n=e.previousResults;for(let a=0;a<n.length;a++)if(n[a][r]===t)return!0;return!1}},CE=e=>{const t=e.previousResults[0];return!!(t&&t[e.queryParams.primaryKey]===e.changeEvent.id)},PE=e=>{const t=cf(e.previousResults);return!!(t&&t[e.queryParams.primaryKey]===e.changeEvent.id)},NE=e=>{const t=e.changeEvent.previous;if(!t)return!1;const r=e.previousResults[0];return r?r[e.queryParams.primaryKey]===e.changeEvent.id?!0:e.queryParams.sortComparator(t,r)<0:!1},DE=e=>{const t=e.changeEvent.previous;if(!t)return!1;const r=cf(e.previousResults);return r?r[e.queryParams.primaryKey]===e.changeEvent.id?!0:e.queryParams.sortComparator(t,r)>0:!1},LE=e=>{const t=e.changeEvent.doc;if(!t)return!1;const r=e.previousResults[0];return r?r[e.queryParams.primaryKey]===e.changeEvent.id?!0:e.queryParams.sortComparator(t,r)<0:!1},ME=e=>{const t=e.changeEvent.doc;if(!t)return!1;const r=cf(e.previousResults);return r?r[e.queryParams.primaryKey]===e.changeEvent.id?!0:e.queryParams.sortComparator(t,r)>0:!1},jE=e=>{const t=e.changeEvent.previous;return t?e.queryParams.queryMatcher(t):!1},FE=e=>{const t=e.changeEvent.doc;return t?e.queryParams.queryMatcher(t):!1},BE=e=>e.previousResults.length===0,UE={0:OE,1:TE,2:IE,3:Py,4:SE,5:kE,6:BE,7:RE,8:CE,9:PE,10:$E,11:AE,12:NE,13:DE,14:LE,15:ME,16:jE,17:FE};function zE(e,t,r,n){var a=e.length,i=a-1,s=0;if(a===0)return e.push(t),0;for(var o;n<=i;)s=n+(i-n>>1),o=e[s],r(o,t)<=0?n=s+1:i=s-1;return r(o,t)<=0&&s++,e.splice(s,0,t),s}const qE=e=>{},uf=e=>{e.previousResults.unshift(e.changeEvent.doc),e.keyDocumentMap&&e.keyDocumentMap.set(e.changeEvent.id,e.changeEvent.doc)},lf=e=>{e.previousResults.push(e.changeEvent.doc),e.keyDocumentMap&&e.keyDocumentMap.set(e.changeEvent.id,e.changeEvent.doc)},df=e=>{const t=e.previousResults.shift();e.keyDocumentMap&&t&&e.keyDocumentMap.delete(t[e.queryParams.primaryKey])},ff=e=>{const t=e.previousResults.pop();e.keyDocumentMap&&t&&e.keyDocumentMap.delete(t[e.queryParams.primaryKey])},HE=e=>{df(e),lf(e)},KE=e=>{ff(e),uf(e)},GE=e=>{df(e),uf(e)},WE=e=>{ff(e),lf(e)},Ny=e=>{e.keyDocumentMap&&e.keyDocumentMap.delete(e.changeEvent.id);const t=e.queryParams.primaryKey,r=e.previousResults;for(let n=0;n<r.length;n++)if(r[n][t]===e.changeEvent.id){r.splice(n,1);break}},VE=e=>{const t=e.changeEvent.doc,r=e.queryParams.primaryKey,n=e.previousResults;for(let a=0;a<n.length;a++)if(n[a][r]===e.changeEvent.id){n[a]=t,e.keyDocumentMap&&e.keyDocumentMap.set(e.changeEvent.id,t);break}},ZE=e=>{const t={_id:"wrongHuman"+new Date().getTime()};e.previousResults.length=0,e.previousResults.push(t),e.keyDocumentMap&&(e.keyDocumentMap.clear(),e.keyDocumentMap.set(t._id,t))},Dy=e=>{const t=e.changeEvent.id,r=e.changeEvent.doc;if(e.keyDocumentMap){if(e.keyDocumentMap.has(t))return;e.keyDocumentMap.set(t,r)}else if(e.previousResults.find(a=>a[e.queryParams.primaryKey]===t))return;zE(e.previousResults,r,e.queryParams.sortComparator,0)},JE=e=>{Ny(e),Dy(e)},QE=e=>{throw new Error("Action runFullQueryAgain must be implemented by yourself")},YE=e=>{throw new Error("Action unknownAction should never be called")},XE=["doNothing","insertFirst","insertLast","removeFirstItem","removeLastItem","removeFirstInsertLast","removeLastInsertFirst","removeFirstInsertFirst","removeLastInsertLast","removeExisting","replaceExisting","alwaysWrong","insertAtSortPosition","removeExistingAndInsertAtSortPosition","runFullQueryAgain","unknownAction"],ex={doNothing:qE,insertFirst:uf,insertLast:lf,removeFirstItem:df,removeLastItem:ff,removeFirstInsertLast:HE,removeLastInsertFirst:KE,removeFirstInsertFirst:GE,removeLastInsertLast:WE,removeExisting:Ny,replaceExisting:VE,alwaysWrong:ZE,insertAtSortPosition:Dy,removeExistingAndInsertAtSortPosition:JE,runFullQueryAgain:QE,unknownAction:YE},tx=40;function ku(e){return e.charCodeAt(0)-tx}function rx(e){return e?"1":"0"}function Uh(e,t){const r=[];for(let n=0,a=e.length;n<a;n+=t)r.push(e.substring(n,n+t));return r}function nx(e){const t=new Map,n=2+parseInt(e.charAt(0)+e.charAt(1),10)*2,a=e.substring(2,n),i=Uh(a,2);for(let w=0;w<i.length;w++){const b=i[w],x=b.charAt(0),O=ku(b.charAt(1));t.set(x,O)}const s=e.substring(n,e.length-3),o=Uh(s,4);for(let w=0;w<o.length;w++){const b=o[w],x=b.charAt(0),O=b.charAt(1),T=b.charAt(2),B=ku(b.charAt(3));if(!t.has(O))throw new Error("missing node with id "+O);if(!t.has(T))throw new Error("missing node with id "+T);const U=t.get(O),K=t.get(T),q={l:B,0:U,1:K};t.set(x,q)}const c=e.slice(-3),u=c.charAt(0),d=c.charAt(1),h=ku(c.charAt(2)),p=t.get(u),y=t.get(d);return{l:h,0:p,1:y}}function ax(e,t,r){let n=e,a=e.l;for(;;){const i=t[a](r),s=rx(i);if(n=n[s],typeof n=="number"||typeof n=="string")return n;a=n.l}}const ix="14a1b,c+d2e5f0g/h.i4j*k-l)m(n6oeh6pnm6qen6ril6snh6tin6ubo9vce9wmh9xns9yne9zmi9{cm9|ad9}cp9~aq9ae9bf9bq9cg9ck9cn9nd9np9nq9nf9ng9nm9nk9mr9ms9mt9mj9mk9ml9mn9mc8{8}888mn88m8m4z4w4z44444m4v7yn77~777n777m77m7m7m5m5m55m555m55m5m552|2u2222x222|222222n2n222n2/an/bn/cn///////////,cn,,,,,,,ac0bc00000000000m-m-----------3333(((++++11*m*.";let Iu;function sx(){return Iu||(Iu=nx(ix)),Iu}const ox=e=>ax(sx(),UE,e);function cx(e){const t=ox(e);return XE[t]}function ux(e,t,r,n,a){const i=ex[e];return i({queryParams:t,changeEvent:r,previousResults:n,keyDocumentMap:a}),n}var Ja="",Qa=Number.MIN_SAFE_INTEGER;function lx(e,t){var r=t.selector,n=e.indexes?e.indexes.slice(0):[];t.index&&(n=[t.index]);var a=!!t.sort.find(d=>Object.values(d)[0]==="desc"),i=new Set;Object.keys(r).forEach(d=>{var h=Xa(e,d);h&&h.type==="boolean"&&Object.prototype.hasOwnProperty.call(r[d],"$eq")&&i.add(d)});var s=t.sort.map(d=>Object.keys(d)[0]),o=s.filter(d=>!i.has(d)).join(","),c=-1,u;if(n.forEach(d=>{var h=!0,p=!0,y=d.map(O=>{var T=r[O],B=T?Object.keys(T):[],U={};if(!T||!B.length){var K=p?Qa:Ja;U={startKey:K,endKey:h?Ja:Qa,inclusiveStart:!0,inclusiveEnd:!0}}else B.forEach(q=>{if(hf.has(q)){var G=T[q],Oe=px(q,G);U=Object.assign(U,Oe)}});return typeof U.startKey>"u"&&(U.startKey=Qa),typeof U.endKey>"u"&&(U.endKey=Ja),typeof U.inclusiveStart>"u"&&(U.inclusiveStart=!0),typeof U.inclusiveEnd>"u"&&(U.inclusiveEnd=!0),p&&!U.inclusiveStart&&(p=!1),h&&!U.inclusiveEnd&&(h=!1),U}),g=y.map(O=>O.startKey),w=y.map(O=>O.endKey),b={index:d,startKeys:g,endKeys:w,inclusiveEnd:h,inclusiveStart:p,sortSatisfiedByIndex:!a&&o===d.filter(O=>!i.has(O)).join(","),selectorSatisfiedByIndex:hx(d,t.selector,g,w)},x=mx(e,t,b);(x>=c||t.index)&&(c=x,u=b)}),!u)throw ye("SNH",{query:t});return u}var hf=new Set(["$eq","$gt","$gte","$lt","$lte"]),dx=new Set(["$eq","$gt","$gte"]),fx=new Set(["$eq","$lt","$lte"]);function hx(e,t,r,n){var a=Object.entries(t),i=a.find(([q,G])=>{if(!e.includes(q))return!0;var Oe=Object.entries(G).find(([Me,qe])=>!hf.has(Me));return Oe});if(i||t.$and||t.$or)return!1;var s=[],o=new Set;for(var[c,u]of Object.entries(t)){if(!e.includes(c))return!1;var d=Object.keys(u).filter(q=>dx.has(q));if(d.length>1)return!1;var h=d[0];if(h&&o.add(c),h!=="$eq"){if(s.length>0)return!1;s.push(h)}}var p=[],y=new Set;for(var[g,w]of Object.entries(t)){if(!e.includes(g))return!1;var b=Object.keys(w).filter(q=>fx.has(q));if(b.length>1)return!1;var x=b[0];if(x&&y.add(g),x!=="$eq"){if(p.length>0)return!1;p.push(x)}}var O=0;for(var T of e){for(var B of[o,y]){if(!B.has(T)&&B.size>0)return!1;B.delete(T)}var U=r[O],K=n[O];if(U!==K&&o.size>0&&y.size>0)return!1;O++}return!0}function px(e,t){switch(e){case"$eq":return{startKey:t,endKey:t,inclusiveEnd:!0,inclusiveStart:!0};case"$lte":return{endKey:t,inclusiveEnd:!0};case"$gte":return{startKey:t,inclusiveStart:!0};case"$lt":return{endKey:t,inclusiveEnd:!1};case"$gt":return{startKey:t,inclusiveStart:!1};default:throw new Error("SNH")}}function mx(e,t,r){var n=0,a=d=>{d>0&&(n=n+d)},i=10,s=vu(r.startKeys,d=>d!==Qa&&d!==Ja);a(s*i);var o=vu(r.startKeys,d=>d!==Ja&&d!==Qa);a(o*i);var c=vu(r.startKeys,(d,h)=>d===r.endKeys[h]);a(c*i*1.5);var u=r.sortSatisfiedByIndex?5:0;return a(u),n}class ka extends Error{}const gx=2147483647,yx=-2147483648,vx=Number.MAX_SAFE_INTEGER,_x=Number.MIN_SAFE_INTEGER,cn=Symbol("missing"),Ly=Object.freeze(new Error("mingo: cycle detected while processing object/array")),wx="[object Object]",bx=/^\[object ([a-zA-Z0-9]+)\]$/,Rs=e=>{const t=Ox(e);let r=0,n=t.length;for(;n;)r=(r<<5)-r^t.charCodeAt(--n);return r>>>0},My=new Set(["null","undefined","boolean","number","string","date","regexp"]),Ex={null:0,undefined:0,number:1,string:2,object:3,array:4,boolean:5,date:6,regexp:7,function:8},Wt=(e,t)=>{e===cn&&(e=void 0),t===cn&&(t=void 0);const[r,n]=[e,t].map(a=>Ex[as(a).toLowerCase()]);return r!==n?r-n:r===1||r===2||r===6?e<t?-1:e>t?1:0:qr(e,t)?0:e<t?-1:e>t?1:0};function yt(e,t){if(!e)throw new ka(t)}const as=e=>bx.exec(Object.prototype.toString.call(e))[1],Ou=e=>typeof e=="boolean",un=e=>typeof e=="string",rr=e=>!isNaN(e)&&typeof e=="number",vt=Array.isArray,st=e=>{if(!e)return!1;const t=Object.getPrototypeOf(e);return(t===Object.prototype||t===null)&&wx===Object.prototype.toString.call(e)},bc=e=>e===Object(e),Ho=e=>e instanceof Date,Gi=e=>e instanceof RegExp,pf=e=>typeof e=="function",$t=e=>e==null,ri=(e,t)=>e.includes(t),jy=(e,t)=>!ri(e,t),ni=(e,t=!0)=>!!e||t&&e==="",hi=e=>$t(e)||un(e)&&!e||e instanceof Array&&e.length===0||st(e)&&Object.keys(e).length===0,zh=e=>e===cn,pi=e=>e instanceof Array?e:[e],ar=(e,t)=>!!e&&Object.prototype.hasOwnProperty.call(e,t),mf=e=>typeof ArrayBuffer<"u"&&ArrayBuffer.isView(e),xx=[Ho,Gi,mf],od=(e,t)=>{if($t(e))return e;if(t.has(e))throw Ly;const r=e.constructor;if(xx.some(n=>n(e)))return new r(e);try{if(t.add(e),vt(e))return e.map(n=>od(n,t));if(st(e)){const n={};for(const a in e)n[a]=od(e[a],t);return n}}finally{t.delete(e)}return e},cd=e=>od(e,new Set),Sx=(e,t)=>st(e)&&st(t)||vt(e)&&vt(t);function ud(e,t,r){if(r=r||{flatten:!1},zh(e)||$t(e))return t;if(zh(t)||$t(t))return e;if(!Sx(e,t)){if(r.skipValidation)return t||e;throw Error("mismatched types. must both be array or object")}if(r.skipValidation=!0,vt(e)){const n=e,a=t;if(r.flatten){let i=0,s=0;for(;i<n.length&&s<a.length;)n[i]=ud(n[i++],a[s++],r);for(;s<a.length;)n.push(t[s++])}else $s(n,a)}else for(const n in t)e[n]=ud(e[n],t[n],r);return e}function ld(e,t=Rs){const r=new Map;return e.forEach((n,a)=>{const i=By(n,t);r.has(i)?r.get(i).some(s=>qr(e[s],n))||r.get(i).push(a):r.set(i,[a])}),r}function gf(e,t=Rs){if(e.some(o=>o.length==0))return[];if(e.length===1)return Array.from(e);const r=Tx(e.map((o,c)=>[c,o.length]),o=>o[1]),n=e[r[0][0]],a=ld(n,t),i=new Map,s=new Array;return a.forEach((o,c)=>{const u=o.map(y=>n[y]),d=u.map(y=>0),h=u.map(y=>[r[0][0],0]);let p=!1;for(let y=1;y<e.length;y++){const[g,w]=r[y],b=e[g];if(i.has(y)||i.set(y,ld(b)),i.get(y).has(c)){const x=i.get(y).get(c).map(O=>b[O]);p=u.map((O,T)=>x.some((B,U)=>{const K=d[T];return qr(O,B)&&(d[T]++,g<h[T][0]&&(h[T]=[g,i.get(y).get(c)[U]])),K<d[T]})).some(Boolean)}if(!p)return}p&&$s(s,d.map((y,g)=>y===e.length-1?[u[g],h[g]]:cn).filter(y=>y!==cn))}),s.sort((o,c)=>{const[u,[d,h]]=o,[p,[y,g]]=c,w=Wt(d,y);return w!==0?w:Wt(h,g)}).map(o=>o[0])}function Fy(e,t=0){const r=new Array;function n(a,i){for(let s=0,o=a.length;s<o;s++)vt(a[s])&&(i>0||i<0)?n(a[s],Math.max(-1,i-1)):r.push(a[s])}return n(e,t),r}const kx=e=>{let[t,r]=[Object.getPrototypeOf(e),Object.getOwnPropertyNames(e)],n=t;for(;!r.length&&t!==Object.prototype&&t!==Array.prototype;)n=t,r=Object.getOwnPropertyNames(t),t=Object.getPrototypeOf(t);const a={};return r.forEach(i=>a[i]=e[i]),[a,n]};function qr(e,t){if(e===t||Object.is(e,t))return!0;const r=!!e&&e.constructor||e;if(e===null||t===null||e===void 0||t===void 0||r!==t.constructor||r===Function)return!1;if(r===Array||r===Object){const i=Object.keys(e),s=Object.keys(t);if(i.length!==s.length||new Set([...i,...s]).size!=i.length)return!1;for(const o of i)if(!qr(e[o],t[o]))return!1;return!0}const n=Object.getPrototypeOf(e);return(mf(e)||n!==Object.prototype&&n!==Array.prototype&&Object.prototype.hasOwnProperty.call(n,"toString"))&&e.toString()===t.toString()}function Ix(e,t=Rs){const r=e.map(n=>cn);return ld(e,t).forEach((n,a)=>{n.forEach(i=>r[i]=e[i])}),r.filter(n=>n!==cn)}const $o=(e,t)=>{if(e===null)return"null";if(e===void 0)return"undefined";const r=e.constructor;switch(r){case RegExp:case Number:case Boolean:case Function:case Symbol:return e.toString();case String:return JSON.stringify(e);case Date:return e.toISOString()}if(mf(e))return r.name+"["+e.toString()+"]";if(t.has(e))throw Ly;try{if(t.add(e),vt(e))return"["+e.map(s=>$o(s,t)).join(",")+"]";if(r===Object)return"{"+Object.keys(e).sort().map(s=>s+":"+$o(e[s],t)).join(",")+"}";const n=Object.getPrototypeOf(e);if(n!==Object.prototype&&n!==Array.prototype&&Object.prototype.hasOwnProperty.call(n,"toString"))return r.name+"("+JSON.stringify(e.toString())+")";const[a,i]=kx(e);return r.name+$o(a,t)}finally{t.delete(e)}},Ox=e=>$o(e,new Set);function By(e,t){return t=t||Rs,$t(e)?null:t(e).toString()}function Tx(e,t,r=Wt){if(hi(e))return e;const n=new Array,a=new Array;for(let i=0;i<e.length;i++){const s=e[i],o=t(s,i);$t(o)?a.push(s):n.push([o,s])}return n.sort((i,s)=>r(i[0],s[0])),$s(a,n.map(i=>i[1]))}function Rx(e,t,r=Rs){if(e.length<1)return new Map;const n=new Map,a=new Map;for(let i=0;i<e.length;i++){const s=e[i],o=t(s,i),c=By(o,r);if(c===null)a.has(null)?a.get(null).push(s):a.set(null,[s]);else{const u=n.has(c)?n.get(c).find(d=>qr(d,o)):null;$t(u)?(a.set(o,[s]),n.has(c)?n.get(c).push(o):n.set(c,[o])):a.get(u).push(s)}}return a}const Tu=5e4;function $s(e,...t){return e instanceof Array?t.reduce((r,n)=>{let a=Math.ceil(n.length/Tu),i=0;for(;a-- >0;)Array.prototype.push.apply(r,n.slice(i,i+Tu)),i+=Tu;return r},e):t.filter(bc).reduce((r,n)=>(Object.assign(r,n),r),e)}function dd(e,t){return bc(e)?e[t]:void 0}function $x(e,t){if(t<1)return e;for(;t--&&e.length===1;)e=e[0];return e}function mi(e,t,r){let n=0;function a(s,o){let c=s;for(let u=0;u<o.length;u++){const d=o[u];if(/^\d+$/.exec(d)===null&&c instanceof Array){if(u===0&&n>0)break;n+=1;const p=o.slice(u);c=c.reduce((y,g)=>{const w=a(g,p);return w!==void 0&&y.push(w),y},[]);break}else c=dd(c,d);if(c===void 0)break}return c}const i=My.has(as(e).toLowerCase())?e:a(e,t.split("."));return i instanceof Array&&r?.unwrapArray?$x(i,n):i}function Ao(e,t,r){const n=t.split("."),a=n[0],i=n.slice(1).join("."),s=/^\d+$/.exec(a)!==null,o=n.length>1;let c,u;if(e instanceof Array)if(s)c=dd(e,Number(a)),o&&(c=Ao(c,i,r)),c=[c];else{c=[];for(const d of e)u=Ao(d,t,r),r?.preserveMissing?(u===void 0&&(u=cn),c.push(u)):u!==void 0&&c.push(u)}else{if(u=dd(e,a),o&&(u=Ao(u,i,r)),u===void 0)return;c=r?.preserveKeys?{...e}:{},c[a]=u}return c}function fd(e){if(e instanceof Array)for(let t=e.length-1;t>=0;t--)e[t]===cn?e.splice(t,1):fd(e[t]);else if(st(e))for(const t in e)ar(e,t)&&fd(e[t])}const qh=/^\d+$/;function is(e,t,r,n){const a=t.split("."),i=a[0],s=a.slice(1).join(".");if(a.length===1)(st(e)||vt(e)&&qh.test(i))&&r(e,i);else{n?.buildGraph&&$t(e[i])&&(e[i]={});const o=e[i];if(!o)return;const c=!!(a.length>1&&qh.test(a[1]));o instanceof Array&&n?.descendArray&&!c?o.forEach(u=>is(u,s,r,n)):is(o,s,r,n)}}function Ax(e,t,r){is(e,t,(n,a)=>{n[a]=pf(r)?r(n[a]):r},{buildGraph:!0})}function Hh(e,t,r){is(e,t,(n,a)=>{if(n instanceof Array){if(/^\d+$/.test(a))n.splice(parseInt(a),1);else if(r&&r.descendArray)for(const i of n)st(i)&&delete i[a]}else st(n)&&delete n[a]},r)}const Cx=/^\$[a-zA-Z0-9_]+$/;function Ia(e){return Cx.test(e)}function Uy(e){if(My.has(as(e).toLowerCase()))return Gi(e)?{$regex:e}:{$eq:e};if(bc(e)){if(!Object.keys(e).some(Ia))return{$eq:e};if(ar(e,"$regex")){const r={...e};return r.$regex=new RegExp(e.$regex,e.$options),delete r.$options,r}}return e}var ji=(e=>(e.CLONE_ALL="CLONE_ALL",e.CLONE_INPUT="CLONE_INPUT",e.CLONE_OUTPUT="CLONE_OUTPUT",e.CLONE_OFF="CLONE_OFF",e))(ji||{});class oa{constructor(t,r,n,a=Date.now()){this._opts=t,this._root=r,this._local=n,this.timestamp=a,this.update(r,n)}static init(t,r,n){return t instanceof oa?new oa(t._opts,$t(t.root)?r:t.root,Object.assign({},t.local,n)):new oa(t,r,n)}update(t,r){return this._root=t,this._local=r&&Object.assign({},r,{variables:Object.assign({},this._local?.variables,r?.variables)}),this}getOptions(){return Object.freeze({...this._opts,context:va.from(this._opts.context)})}get root(){return this._root}get local(){return this._local}get idKey(){return this._opts.idKey}get collation(){return this._opts?.collation}get processingMode(){return this._opts?.processingMode||"CLONE_OFF"}get useStrictMode(){return this._opts?.useStrictMode}get scriptEnabled(){return this._opts?.scriptEnabled}get useGlobalContext(){return this._opts?.useGlobalContext}get hashFunction(){return this._opts?.hashFunction}get collectionResolver(){return this._opts?.collectionResolver}get jsonSchemaValidator(){return this._opts?.jsonSchemaValidator}get variables(){return this._opts?.variables}get context(){return this._opts?.context}}function Ko(e){return e instanceof oa?e.getOptions():Object.freeze({idKey:"_id",scriptEnabled:!0,useStrictMode:!0,useGlobalContext:!0,processingMode:"CLONE_OFF",...e,context:e?.context?va.from(e?.context):va.init({})})}var ai=(e=>(e.ACCUMULATOR="accumulator",e.EXPRESSION="expression",e.PIPELINE="pipeline",e.PROJECTION="projection",e.QUERY="query",e.WINDOW="window",e))(ai||{});class va{constructor(t){this.operators={accumulator:{},expression:{},pipeline:{},projection:{},query:{},window:{}};for(const[r,n]of Object.entries(t))this.addOperators(r,n)}static init(t={}){return new va(t)}static from(t){return new va(t.operators)}addOperators(t,r){for(const[n,a]of Object.entries(r))this.getOperator(t,n)||(this.operators[t][n]=a);return this}addAccumulatorOps(t){return this.addOperators("accumulator",t)}addExpressionOps(t){return this.addOperators("expression",t)}addQueryOps(t){return this.addOperators("query",t)}addPipelineOps(t){return this.addOperators("pipeline",t)}addProjectionOps(t){return this.addOperators("projection",t)}addWindowOps(t){return this.addOperators("window",t)}getOperator(t,r){return t in this.operators&&this.operators[t][r]||null}}const ra=va.init();function Kh(e,t){for(const[r,n]of Object.entries(t)){yt(pf(n)&&Ia(r),`'${r}' is not a valid operator`);const a=ca(e,r,null);yt(!a||n===a,`${r} already exists for '${e}' operators. Cannot change operator function once registered.`)}switch(e){case"accumulator":ra.addAccumulatorOps(t);break;case"expression":ra.addExpressionOps(t);break;case"pipeline":ra.addPipelineOps(t);break;case"projection":ra.addProjectionOps(t);break;case"query":ra.addQueryOps(t);break;case"window":ra.addWindowOps(t);break}}function ca(e,t,r){const{context:n,useGlobalContext:a}=r||{},i=n?n.getOperator(e,t):null;return!i&&a?ra.getOperator(e,t):i}const Gh={$$ROOT(e,t,r){return r.root},$$CURRENT(e,t,r){return e},$$REMOVE(e,t,r){},$$NOW(e,t,r){return new Date(r.timestamp)}},hd={$$KEEP(e,t,r){return e},$$PRUNE(e,t,r){},$$DESCEND(e,t,r){if(!ar(t,"$cond"))return e;let n;for(const[a,i]of Object.entries(e))if(bc(i)){if(i instanceof Array){const s=[];for(let o of i)st(o)&&(o=Wh(o,t,r.update(o))),$t(o)||s.push(o);n=s}else n=Wh(i,t,r.update(i));$t(n)?delete e[a]:e[a]=n}return e}};function Nt(e,t,r,n){const a=oa.init(n,e);if(r=r||"",Ia(r)){const i=ca("expression",r,n);if(i)return i(e,t,a);const s=ca("accumulator",r,n);if(s)return e instanceof Array||(e=Nt(e,t,null,a),t=null),yt(e instanceof Array,`'${r}' target must be an array.`),s(e,t,a.update(null,a.local));throw new ka(`operator '${r}' is not registered`)}if(un(t)&&t.length>0&&t[0]==="$"){if(ar(hd,t))return t;let i=a.root;const s=t.split(".");if(ar(Gh,s[0]))i=Gh[s[0]](e,null,a),t=t.slice(s[0].length+1);else if(s[0].slice(0,2)==="$$"){i=Object.assign({},a.variables,{this:e},a.local?.variables);const o=s[0].slice(2);yt(ar(i,o),`Use of undefined variable: ${o}`),t=t.slice(2)}else t=t.slice(1);return t===""?i:mi(i,t)}if(vt(t))return t.map(i=>Nt(e,i,null,a));if(st(t)){const i={};for(const[s,o]of Object.entries(t))if(i[s]=Nt(e,o,s,a),["expression","accumulator"].some(c=>!!ca(c,s,n)))return yt(Object.keys(t).length===1,"Invalid aggregation expression '"+JSON.stringify(t)+"'"),i[s];return i}return t}function Wh(e,t,r){const n=Nt(e,t,null,r);return ar(hd,n)?hd[n](e,t,r):n}function ii(e){return e instanceof Vh?e:new Vh(e)}function Px(...e){let t=0;return ii(()=>{for(;t<e.length;){const r=e[t].next();if(!r.done)return r;t++}return{done:!0}})}function Nx(e){return!!e&&typeof e=="object"&&e?.next instanceof Function}function Dx(e,t){const r=e.slice(t+1);e.splice(t),Array.prototype.push.apply(e,r)}const pd=new Error;function Lx(e,t,r){let n=!1,a=-1,i=0;return function(s){try{e:for(;!n;){let o=e();a++;let c=-1;const u=t.length;let d=!1;for(;++c<u;){const h=t[c];switch(h.action){case 0:o=h.func(o,a);break;case 1:if(!h.func(o,a))continue e;break;case 2:--h.count,h.count||(d=!0);break;case 3:--h.count,h.count||Dx(t,c);continue e;default:break e}}if(n=d,s)r[i++]=o;else return{value:o,done:!1}}}catch(o){if(o!==pd)throw o}return n=!0,{done:n}}}let Vh=class{constructor(t){this.iteratees=[],this.yieldedValues=[],this.isDone=!1;let r;if(t instanceof Function&&(t={next:t}),Nx(t)){const n=t;r=()=>{const a=n.next();if(a.done)throw pd;return a.value}}else if(t instanceof Array){const n=t,a=n.length;let i=0;r=()=>{if(i<a)return n[i++];throw pd}}else if(!(t instanceof Function))throw new ka("Lazy must be initialized with an array, generator, or function.");this.getNext=Lx(r,this.iteratees,this.yieldedValues)}push(t,r){return typeof r=="function"?this.iteratees.push({action:t,func:r}):typeof r=="number"&&this.iteratees.push({action:t,count:r}),this}next(){return this.getNext()}map(t){return this.push(0,t)}filter(t){return this.push(1,t)}take(t){return t>0?this.push(2,t):this}drop(t){return t>0?this.push(3,t):this}transform(t){const r=this;let n;return ii(()=>(n||(n=ii(t(r.value()))),n.next()))}value(){return this.isDone||(this.isDone=this.getNext(!0).done),this.yieldedValues}each(t){for(;;){const r=this.next();if(r.done)break;if(t(r.value)===!1)return!1}return!0}reduce(t,r){let n=this.next();for(r===void 0&&!n.done&&(r=n.value,n=this.next());!n.done;)r=t(r,n.value),n=this.next();return r}size(){return this.reduce((t,r)=>++t,0)}[Symbol.iterator](){return this}};class Mx{constructor(t,r){this.pipeline=t,this.options=Ko(r)}stream(t){let r=ii(t);const n=this.options.processingMode;(n==ji.CLONE_ALL||n==ji.CLONE_INPUT)&&r.map(cd);const a=new Array;if(!hi(this.pipeline))for(const i of this.pipeline){const s=Object.keys(i),o=s[0],c=ca(ai.PIPELINE,o,this.options);yt(s.length===1&&!!c,`invalid pipeline operator ${o}`),a.push(o),r=c(r,i[o],this.options)}return(n==ji.CLONE_OUTPUT||n==ji.CLONE_ALL&&gf([["$group","$unwind"],a]).length)&&r.map(cd),r}run(t){return this.stream(t).value()}}class jx{constructor(t,r,n,a){this.source=t,this.predicate=r,this.projection=n,this.options=a,this.operators=[],this.result=null,this.buffer=[]}fetch(){return this.result?this.result:(st(this.projection)&&this.operators.push({$project:this.projection}),this.result=ii(this.source).filter(this.predicate),this.operators.length>0&&(this.result=new Mx(this.operators,this.options).stream(this.result)),this.result)}fetchAll(){const t=ii([...this.buffer]);return this.buffer=[],Px(t,this.fetch())}all(){return this.fetchAll().value()}count(){return this.all().length}skip(t){return this.operators.push({$skip:t}),this}limit(t){return this.operators.push({$limit:t}),this}sort(t){return this.operators.push({$sort:t}),this}collation(t){return this.options={...this.options,collation:t},this}next(){if(this.buffer.length>0)return this.buffer.pop();const t=this.fetch().next();if(!t.done)return t.value}hasNext(){if(this.buffer.length>0)return!0;const t=this.fetch().next();return t.done?!1:(this.buffer.push(t.value),!0)}map(t){return this.all().map(t)}forEach(t){this.all().forEach(t)}[Symbol.iterator](){return this.fetchAll()}}class ln{constructor(t,r){this.condition=t,this.options=Ko(r),this.compiled=[],this.compile()}compile(){yt(st(this.condition),`query criteria must be an object: ${JSON.stringify(this.condition)}`);const t={};for(const[r,n]of Object.entries(this.condition)){if(r==="$where")Object.assign(t,{field:r,expr:n});else if(ri(["$and","$or","$nor","$expr","$jsonSchema"],r))this.processOperator(r,r,n);else{yt(!Ia(r),`unknown top level operator: ${r}`);for(const[a,i]of Object.entries(Uy(n)))this.processOperator(r,a,i)}t.field&&this.processOperator(t.field,t.field,t.expr)}}processOperator(t,r,n){const a=ca(ai.QUERY,r,this.options);if(!a)throw new ka(`unknown query operator ${r}`);const i=a(t,n,this.options);this.compiled.push(i)}test(t){for(let r=0,n=this.compiled.length;r<n;r++)if(!this.compiled[r](t))return!1;return!0}find(t,r){return new jx(t,n=>this.test(n),r||{},this.options)}remove(t){return t.reduce((r,n)=>(this.test(n)||r.push(n),r),[])}}const Fx=(e,t,r)=>{if(hi(t)||!st(t))return e;let n=Wt;const a=r.collation;return st(a)&&un(a.locale)&&(n=Ux(a)),e.transform(i=>{const s=Object.keys(t);for(const o of s.reverse()){const c=Rx(i,d=>mi(d,o),r.hashFunction),u=Array.from(c.keys()).sort(n);t[o]===-1&&u.reverse(),i=[],u.reduce((d,h)=>$s(d,c.get(h)),i)}return i})},Bx={1:"base",2:"accent",3:"variant"};function Ux(e){const t={sensitivity:Bx[e.strength||3],caseFirst:e.caseFirst==="off"?"false":e.caseFirst||"false",numeric:e.numericOrdering||!1,ignorePunctuation:e.alternate==="shifted"};(e.caseLevel||!1)===!0&&(t.sensitivity==="base"&&(t.sensitivity="case"),t.sensitivity==="accent"&&(t.sensitivity="variant"));const r=new Intl.Collator(e.locale,t);return(n,a)=>{if(!un(n)||!un(a))return Wt(n,a);const i=r.compare(n,a);return i<0?-1:i>0?1:0}}function Dt(e){const t=(r,n,a)=>{const i={unwrapArray:!0},s=Math.max(1,r.split(".").length-1);return o=>{const c=mi(o,r,i);return e(c,n,{...a,depth:s})}};return t.op="query",t}function gi(e){return(t,r,n)=>{const a=Nt(t,r,null,n);return e(...a)}}function yf(e,t,r){if(qr(e,t)||$t(e)&&$t(t))return!0;if(e instanceof Array){const n=qr.bind(null,t);return e.some(n)||Fy(e,r?.depth).some(n)}return!1}function zy(e,t,r){return!yf(e,t,r)}function qy(e,t,r){return $t(e)?t.some(n=>n===null):gf([pi(e),t],r?.hashFunction).length>0}function zx(e,t,r){return!qy(e,t,r)}function Hy(e,t,r){return Ec(e,t,(n,a)=>Wt(n,a)<0)}function Ky(e,t,r){return Ec(e,t,(n,a)=>Wt(n,a)<=0)}function Gy(e,t,r){return Ec(e,t,(n,a)=>Wt(n,a)>0)}function Wy(e,t,r){return Ec(e,t,(n,a)=>Wt(n,a)>=0)}function qx(e,t,r){return pi(e).some(n=>t.length===2&&n%t[0]===t[1])}function Hx(e,t,r){const n=pi(e),a=i=>un(i)&&ni(t.exec(i),r?.useStrictMode);return n.some(a)||Fy(n,1).some(a)}function Kx(e,t,r){return(t===!1||t===0)&&e===void 0||(t===!0||t===1)&&e!==void 0}function Gx(e,t,r){if(!vt(e)||!vt(t)||!e.length||!t.length)return!1;let n=!0;for(const a of t){if(!n)break;st(a)&&ri(Object.keys(a),"$elemMatch")?n=Vy(e,a.$elemMatch,r):a instanceof RegExp?n=e.some(i=>typeof i=="string"&&a.test(i)):n=e.some(i=>qr(a,i))}return n}function Wx(e,t,r){return Array.isArray(e)&&e.length===t}function Vx(e){return Ia(e)&&["$and","$or","$nor"].indexOf(e)===-1}function Vy(e,t,r){if(vt(e)&&!hi(e)){let n=s=>s,a=t;Object.keys(t).every(Vx)&&(a={temp:t},n=s=>({temp:s}));const i=new ln(a,r);for(let s=0,o=e.length;s<o;s++)if(i.test(n(e[s])))return!0}return!1}const Zh=e=>e===null,Jh=e=>rr(e)&&e>=yx&&e<=gx&&e.toString().indexOf(".")===-1,Qh=e=>rr(e)&&e>=_x&&e<=vx&&e.toString().indexOf(".")===-1,Zx={array:vt,bool:Ou,boolean:Ou,date:Ho,decimal:rr,double:rr,int:Jh,long:Qh,number:rr,null:Zh,object:st,regex:Gi,regexp:Gi,string:un,undefined:$t,function:e=>{throw new ka("unsupported type key `function`.")},1:rr,2:un,3:st,4:vt,6:$t,8:Ou,9:Ho,10:Zh,11:Gi,16:Jh,18:Qh,19:rr};function Yh(e,t,r){const n=Zx[t];return n?n(e):!1}function Jx(e,t,r){return Array.isArray(t)?t.findIndex(n=>Yh(e,n))>=0:Yh(e,t)}function Ec(e,t,r){return pi(e).some(n=>as(n)===as(t)&&r(n,t))}const Qx=(e,t,r)=>{const n=Nt(e,t,null,r);return ni(n,r.useStrictMode)&&n.every(a=>ni(a,r.useStrictMode))},Yx=(e,t,r)=>{const n=pi(t);if(n.length==0)return!1;if(n.length==1)return!Nt(e,n[0],null,r);throw"Expression $not takes exactly 1 argument"},Xx=(e,t,r)=>{const n=Nt(e,t,null,r),a=r.useStrictMode;return ni(n,a)&&n.some(i=>ni(i,a))},eS=Object.freeze(Object.defineProperty({__proto__:null,$and:Qx,$not:Yx,$or:Xx},Symbol.toStringTag,{value:"Module"})),tS=(e,t,r)=>{const n=Nt(e,t,null,r);return n[0]>n[1]?1:n[0]<n[1]?-1:0},rS=gi(yf),nS=gi(Gy),aS=gi(Wy),iS=gi(Hy),sS=gi(Ky),oS=gi(zy),cS=Object.freeze(Object.defineProperty({__proto__:null,$cmp:tS,$eq:rS,$gt:nS,$gte:aS,$lt:iS,$lte:sS,$ne:oS},Symbol.toStringTag,{value:"Module"})),Xh=(e,t)=>{const r={};return e.split("").forEach((n,a)=>r[n]=t*(a+1)),r};({...Xh("ABCDEFGHIKLM",1),...Xh("NOPQRSTUVWXY",-1)});const ep={undefined:null,null:null,NaN:NaN,Infinity:new Error,"-Infinity":new Error};function ur(e,t=ep){const r=Object.assign({},ep,t),n=new Set(Object.keys(r));return(a,i,s)=>{const o=Nt(a,i,null,s);if(n.has(`${o}`)){const c=r[`${o}`];if(c instanceof Error)throw new ka(`cannot apply $${e.name} to -inf, value must in (-inf,inf)`);return c}return e(o)}}ur(Math.acos,{Infinity:1/0,0:new Error});ur(Math.acosh,{Infinity:1/0,0:new Error});ur(Math.asin);ur(Math.asinh,{Infinity:1/0,"-Infinity":-1/0});ur(Math.atan);ur(Math.atanh,{1:1/0,"-1":-1/0});ur(Math.cos);ur(Math.cosh,{"-Infinity":1/0,Infinity:1/0});const uS=Math.PI/180;ur(e=>e*uS,{Infinity:1/0,"-Infinity":1/0});const lS=180/Math.PI;ur(e=>e*lS,{Infinity:1/0,"-Infinity":-1/0});ur(Math.sin);ur(Math.sinh,{"-Infinity":-1/0,Infinity:1/0});ur(Math.tan);const dS=(e,t,r)=>{if(hi(t))return e;let n=Object.keys(t),a=!1;Zy(t,r);const i=r.idKey;if(ri(n,i)){const o=t[i];(o===0||o===!1)&&(n=n.filter(jy.bind(null,[i])),a=n.length==0)}else n.push(i);const s=oa.init(r);return e.map(o=>md(o,t,s.update(o),n,a))};function md(e,t,r,n,a){let i={},s=!1,o=!1;const c=[];a&&c.push(r.idKey);for(const u of n){let d;const h=t[u];if(u!==r.idKey&&ri([0,!1],h)&&(o=!0),u===r.idKey&&hi(h))d=e[u];else if(un(h))d=Nt(e,h,u,r);else if(!ri([1,!0],h))if(h instanceof Array)d=h.map(y=>{const g=Nt(e,y,null,r);return $t(g)?null:g});else if(st(h)){const y=h,g=Object.keys(h),w=g.length==1?g[0]:"",b=ca(ai.PROJECTION,w,r);if(b)w==="$slice"?pi(y[w]).every(rr)?(d=b(e,y[w],u,r),s=!0):d=Nt(e,y,u,r):d=b(e,y[w],u,r);else if(Ia(w))d=Nt(e,y[w],w,r);else if(ar(e,u)){Zy(y,r);let x=e[u];x instanceof Array?d=x.map(O=>md(O,y,r,g,!1)):(x=st(x)?x:e,d=md(x,y,r,g,!1))}else d=Nt(e,h,null,r)}else{c.push(u);continue}const p=Ao(e,u,{preserveMissing:!0});p!==void 0&&ud(i,p,{flatten:!0}),jy([0,1,!1,!0],h)&&(d===void 0?Hh(i,u,{descendArray:!0}):Ax(i,u,d))}if(fd(i),(s||o||a)&&(i=$s({},e,i),c.length>0))for(const u of c)Hh(i,u,{descendArray:!0});return i}function Zy(e,t){const r=[!1,!1];for(const[n,a]of Object.entries(e)){if(n===t?.idKey)return;a===0||a===!1?r[0]=!0:(a===1||a===!0)&&(r[1]=!0),yt(!(r[0]&&r[1]),"Projection cannot have a mix of inclusion and exclusion.")}}const Jy=(e,t,r)=>{yt(vt(t),"Invalid expression: $and expects value to be an Array.");const n=t.map(a=>new ln(a,r));return a=>n.every(i=>i.test(a))},vf=(e,t,r)=>{yt(vt(t),"Invalid expression. $or expects value to be an Array");const n=t.map(a=>new ln(a,r));return a=>n.some(i=>i.test(a))},Qy=(e,t,r)=>{yt(vt(t),"Invalid expression. $nor expects value to be an array.");const n=vf("$or",t,r);return a=>!n(a)},Yy=(e,t,r)=>{const n={};n[e]=Uy(t);const a=new ln(n,r);return i=>!a.test(i)},Xy=Dt(yf),ev=Dt(Gy),tv=Dt(Wy),rv=Dt(qy),nv=Dt(Hy),av=Dt(Ky),iv=Dt(zy),sv=Dt(zx);function fS(e,t,r){return n=>Nt(n,t,null,r)}function hS(e,t,r){if(!r?.jsonSchemaValidator)throw new ka("Missing option 'jsonSchemaValidator'. Configure to use '$jsonSchema' operator.");const n=r?.jsonSchemaValidator(t);return a=>n(a)}const ov=Dt(qx),cv=Dt(Hx);function pS(e,t,r){yt(r.scriptEnabled,"$where operator requires 'scriptEnabled' option to be true");const n=t;return yt(pf(n),"$where only accepts a Function object"),a=>ni(n.call(a),r?.useStrictMode)}const mS=Dt(Gx),uv=Dt(Vy),lv=Dt(Wx),dv=Dt(Kx),fv=Dt(Jx);var tp=!1;function gS(e){return tp||(Kh(ai.PIPELINE,{$sort:Fx,$project:dS}),Kh(ai.QUERY,{$and:Jy,$eq:Xy,$elemMatch:uv,$exists:dv,$gt:ev,$gte:tv,$in:rv,$lt:nv,$lte:av,$ne:iv,$nin:sv,$mod:ov,$nor:Qy,$not:Yy,$or:vf,$regex:cv,$size:lv,$type:fv}),tp=!0),new ln(e)}function ss(e,t){var r=cr(e.primaryKey);t=at(t);var n=Ut(t);if(typeof n.skip!="number"&&(n.skip=0),n.selector?(n.selector=n.selector,Object.entries(n.selector).forEach(([u,d])=>{(typeof d!="object"||d===null)&&(n.selector[u]={$eq:d})})):n.selector={},n.index){var a=Jd(n.index);a.includes(r)||a.push(r),n.index=a}if(n.sort){var c=n.sort.find(u=>Ab(u)===r);c||(n.sort=n.sort.slice(0),n.sort.push({[r]:"asc"}))}else if(n.index)n.sort=n.index.map(u=>({[u]:"asc"}));else{if(e.indexes){var i=new Set;Object.entries(n.selector).forEach(([u,d])=>{var h=!1;typeof d=="object"&&d!==null?h=!!Object.keys(d).find(p=>hf.has(p)):h=!0,h&&i.add(u)});var s=-1,o;e.indexes.forEach(u=>{var d=Qd(u)?u:[u],h=d.findIndex(p=>!i.has(p));h>0&&h>s&&(s=h,o=d)}),o&&(n.sort=o.map(u=>({[u]:"asc"})))}n.sort||(n.sort=[{[r]:"asc"}])}return n}function hv(e,t){if(!t.sort)throw ye("SNH",{query:t});var r=[];t.sort.forEach(a=>{var i=Object.keys(a)[0],s=Object.values(a)[0];r.push({key:i,direction:s,getValueFn:$b(i)})});var n=(a,i)=>{for(var s=0;s<r.length;++s){var o=r[s],c=o.getValueFn(a),u=o.getValueFn(i);if(c!==u){var d=o.direction==="asc"?Wt(c,u):Wt(u,c);return d}}};return n}function _f(e,t){if(!t.sort)throw ye("SNH",{query:t});var r=gS(t.selector),n=a=>r.test(a);return n}async function Ba(e,t){var r=await e.exec();if(!r)return null;if(Array.isArray(r))return Promise.all(r.map(a=>t(a)));if(r instanceof Map)return Promise.all([...r.values()].map(a=>t(a)));var n=await t(r);return n}function yS(e,t){return!t.sort||t.sort.length===0?[e]:t.sort.map(r=>Object.keys(r)[0])}var vS=new WeakMap;function _S(e){return an(vS,e,()=>{var t=e.collection,r=ss(t.storageInstance.schema,Ut(e.mangoQuery)),n=t.schema.primaryPath,a=hv(t.schema.jsonSchema,r),i=(u,d)=>{var h={docA:u,docB:d};return a(h.docA,h.docB)},s=_f(t.schema.jsonSchema,r),o=u=>{var d={doc:u};return s(d.doc)},c={primaryKey:e.collection.schema.primaryPath,skip:r.skip,limit:r.limit,sortFields:yS(n,r),sortComparator:i,queryMatcher:o};return c})}function wS(e,t){if(!e.collection.database.eventReduce)return{runFullQueryAgain:!0};var r=_S(e),n=Ue(e._result).docsData.slice(0),a=Ue(e._result).docsDataMap,i=!1,s=t.map(c=>wE(c)).filter(Tb),o=s.find(c=>{var u={queryParams:r,changeEvent:c,previousResults:n,keyDocumentMap:a},d=cx(u);if(d==="runFullQueryAgain")return!0;if(d!=="doNothing")return i=!0,ux(d,r,c,n,a),!1});return o?{runFullQueryAgain:!0}:{runFullQueryAgain:!1,changed:i,newResults:n}}var bS=(function(){function e(){this._map=new Map}var t=e.prototype;return t.getByQuery=function(n){var a=n.toString();return an(this._map,a,()=>n)},e})();function ES(){return new bS}function rp(e,t){t.uncached=!0;var r=t.toString();e._map.delete(r)}function xS(e){return e.refCount$.observers.length}var SS=100,kS=30*1e3,IS=(e,t)=>(r,n)=>{if(!(n._map.size<e)){var a=Rt()-t,i=[],s=Array.from(n._map.values());for(var o of s)if(!(xS(o)>0)){if(o._lastEnsureEqual===0&&o._creationTime<a){rp(n,o);continue}i.push(o)}var c=i.length-e;if(!(c<=0)){var u=i.sort((h,p)=>h._lastEnsureEqual-p._lastEnsureEqual),d=u.slice(0,c);d.forEach(h=>rp(n,h))}}},pv=IS(SS,kS),Ru=new WeakSet;function OS(e){Ru.has(e)||(Ru.add(e),Jb().then(()=>e0(200)).then(()=>{e.destroyed||e.cacheReplacementPolicy(e,e._queryCache),Ru.delete(e)}))}var mv=(function(){function e(r,n,a){this.cacheItemByDocId=new Map,this.tasks=new Set,this.registry=typeof FinalizationRegistry=="function"?new FinalizationRegistry(i=>{var s=i.docId,o=this.cacheItemByDocId.get(s);o&&(o[0].delete(i.revisionHeight),o[0].size===0&&this.cacheItemByDocId.delete(s))}):void 0,this.primaryPath=r,this.changes$=n,this.documentCreator=a,n.subscribe(i=>{this.tasks.add(()=>{for(var s=this.cacheItemByDocId,o=0;o<i.length;o++){var c=i[o],u=s.get(c.documentId);if(u){var d=c.documentData;d||(d=c.previousDocumentData),u[1]=d}}}),this.tasks.size<=1&&yc().then(()=>{this.processTasks()})})}var t=e.prototype;return t.processTasks=function(){if(this.tasks.size!==0){var n=Array.from(this.tasks);n.forEach(a=>a()),this.tasks.clear()}},t.getLatestDocumentData=function(n){this.processTasks();var a=ma(this.cacheItemByDocId,n);return a[1]},t.getLatestDocumentDataIfExists=function(n){this.processTasks();var a=this.cacheItemByDocId.get(n);if(a)return a[1]},Bn(e,[{key:"getCachedRxDocuments",get:function(){var r=np(this);return en(this,"getCachedRxDocuments",r)}},{key:"getCachedRxDocument",get:function(){var r=np(this);return en(this,"getCachedRxDocument",n=>r([n])[0])}}])})();function np(e){var t=e.primaryPath,r=e.cacheItemByDocId,n=e.registry,a=rt.deepFreezeWhenDevMode,i=e.documentCreator,s=o=>{for(var c=new Array(o.length),u=[],d=0;d<o.length;d++){var h=o[d],p=h[t],y=Nn(h._rev),g=void 0,w=void 0,b=r.get(p);b?(g=b[0],w=g.get(y)):(g=new Map,b=[g,h],r.set(p,b));var x=w?w.deref():void 0;x||(h=a(h),x=i(h),g.set(y,RS(x)),n&&u.push(x)),c[d]=x}return u.length>0&&n&&(e.tasks.add(()=>{for(var O=0;O<u.length;O++){var T=u[O];n.register(T,{docId:T.primary,revisionHeight:Nn(T.revision)})}}),e.tasks.size<=1&&yc().then(()=>{e.processTasks()})),c};return s}function gv(e,t){var r=e.getCachedRxDocuments;return r(t)}var TS=typeof WeakRef=="function",RS=TS?$S:AS;function $S(e){return new WeakRef(e)}function AS(e){return{deref(){return e}}}var ap=(function(){function e(r,n,a){this.time=Rt(),this.query=r,this.count=a,this.documents=gv(this.query.collection._docCache,n)}var t=e.prototype;return t.getValue=function(n){var a=this.query.op;if(a==="count")return this.count;if(a==="findOne"){var i=this.documents.length===0?null:this.documents[0];if(!i&&n)throw ye("QU10",{collection:this.query.collection.name,query:this.query.mangoQuery,op:a});return i}else return a==="findByIds"?this.docsMap:this.documents.slice(0)},Bn(e,[{key:"docsData",get:function(){return en(this,"docsData",this.documents.map(r=>r._data))}},{key:"docsDataMap",get:function(){var r=new Map;return this.documents.forEach(n=>{r.set(n.primary,n._data)}),en(this,"docsDataMap",r)}},{key:"docsMap",get:function(){for(var r=new Map,n=this.documents,a=0;a<n.length;a++){var i=n[a];r.set(i.primary,i)}return en(this,"docsMap",r)}}])})(),CS=0,PS=function(){return++CS},yv=(function(){function e(r,n,a,i={}){this.id=PS(),this._execOverDatabaseCount=0,this._creationTime=Rt(),this._lastEnsureEqual=0,this.uncached=!1,this.refCount$=new na(null),this._result=null,this._latestChangeEvent=-1,this._lastExecStart=0,this._lastExecEnd=0,this._ensureEqualQueue=Or,this.op=r,this.mangoQuery=n,this.collection=a,this.other=i,n||(this.mangoQuery=Co()),this.isFindOneByIdQuery=MS(this.collection.schema.primaryPath,n)}var t=e.prototype;return t._setResultData=function(n){if(typeof n>"u")throw ye("QU18",{database:this.collection.database.name,collection:this.collection.name});if(typeof n=="number"){this._result=new ap(this,[],n);return}else n instanceof Map&&(n=Array.from(n.values()));var a=new ap(this,n,n.length);this._result=a},t._execOverDatabase=async function(){if(this._execOverDatabaseCount=this._execOverDatabaseCount+1,this._lastExecStart=Rt(),this.op==="count"){var n=this.getPreparedQuery(),a=await this.collection.storageInstance.count(n);if(a.mode==="slow"&&!this.collection.database.allowSlowCount)throw ye("QU14",{collection:this.collection,queryObj:this.mangoQuery});return a.count}if(this.op==="findByIds"){var i=Ue(this.mangoQuery.selector)[this.collection.schema.primaryPath].$in,s=new Map,o=[];if(i.forEach(d=>{var h=this.collection._docCache.getLatestDocumentDataIfExists(d);if(h){if(!h._deleted){var p=this.collection._docCache.getCachedRxDocument(h);s.set(d,p)}}else o.push(d)}),o.length>0){var c=await this.collection.storageInstance.findDocumentsById(o,!1);c.forEach(d=>{var h=this.collection._docCache.getCachedRxDocument(d);s.set(h.primary,h)})}return s}var u=LS(this);return u.then(d=>(this._lastExecEnd=Rt(),d))},t.exec=async function(n){if(n&&this.op!=="findOne")throw ye("QU9",{collection:this.collection.name,query:this.mangoQuery,op:this.op});await ip(this);var a=Ue(this._result);return a.getValue(n)},t.toString=function(){var n=zo({op:this.op,query:this.mangoQuery,other:this.other},!0),a=JSON.stringify(n);return this.toString=()=>a,a},t.getPreparedQuery=function(){var n={rxQuery:this,mangoQuery:ss(this.collection.schema.jsonSchema,this.mangoQuery)};n.mangoQuery.selector._deleted={$eq:!1},n.mangoQuery.index&&n.mangoQuery.index.unshift("_deleted"),vr("prePrepareQuery",n);var a=xc(this.collection.schema.jsonSchema,n.mangoQuery);return this.getPreparedQuery=()=>a,a},t.doesDocumentDataMatch=function(n){return n._deleted?!1:this.queryMatcher(n)},t.remove=function(){return this.exec().then(n=>Array.isArray(n)?Promise.all(n.map(a=>a.remove())):n.remove())},t.incrementalRemove=function(){return Ba(this.asRxQuery,n=>n.incrementalRemove())},t.update=function(n){throw et("update")},t.patch=function(n){return Ba(this.asRxQuery,a=>a.patch(n))},t.incrementalPatch=function(n){return Ba(this.asRxQuery,a=>a.incrementalPatch(n))},t.modify=function(n){return Ba(this.asRxQuery,a=>a.modify(n))},t.incrementalModify=function(n){return Ba(this.asRxQuery,a=>a.incrementalModify(n))},t.where=function(n){throw et("query-builder")},t.sort=function(n){throw et("query-builder")},t.skip=function(n){throw et("query-builder")},t.limit=function(n){throw et("query-builder")},Bn(e,[{key:"$",get:function(){if(!this._$){var r=this.collection.$.pipe(tt(n=>!n.isLocal),Ts(null),on(()=>ip(this)),bt(()=>this._result),Os(Es),ns((n,a)=>!!(n&&n.time===Ue(a).time)),tt(n=>!!n),bt(n=>Ue(n).getValue()));this._$=bE(r,this.refCount$.pipe(tt(()=>!1)))}return this._$}},{key:"$$",get:function(){var r=this.collection.database.getReactivityFactory();return r.fromObservable(this.$,void 0,this.collection.database)}},{key:"queryMatcher",get:function(){var r=this.collection.schema.jsonSchema,n=ss(this.collection.schema.jsonSchema,this.mangoQuery);return en(this,"queryMatcher",_f(r,n))}},{key:"asRxQuery",get:function(){return this}}])})();function Co(){return{selector:{}}}function NS(e){return e.collection._queryCache.getByQuery(e)}function Ua(e,t,r,n){vr("preCreateRxQuery",{op:e,queryObj:t,collection:r,other:n});var a=new yv(e,t,r,n);return a=NS(a),OS(r),a}function vv(e){var t=e.asRxQuery.collection._changeEventBuffer.getCounter();return e._latestChangeEvent>=t}async function ip(e){return e.collection.awaitBeforeReads.size>0&&await Promise.all(Array.from(e.collection.awaitBeforeReads).map(t=>t())),e.collection.database.destroyed||vv(e)?!1:(e._ensureEqualQueue=e._ensureEqualQueue.then(()=>DS(e)),e._ensureEqualQueue)}function DS(e){if(e._lastEnsureEqual=Rt(),e.collection.database.destroyed||vv(e))return Or;var t=!1,r=!1;if(e._latestChangeEvent===-1&&(r=!0),!r){var n=e.asRxQuery.collection._changeEventBuffer.getFrom(e._latestChangeEvent+1);if(n===null)r=!0;else{e._latestChangeEvent=e.asRxQuery.collection._changeEventBuffer.getCounter();var a=e.asRxQuery.collection._changeEventBuffer.reduceByLastOfDoc(n);if(e.op==="count"){var i=Ue(e._result).count,s=i;a.forEach(c=>{var u=c.previousDocumentData&&e.doesDocumentDataMatch(c.previousDocumentData),d=e.doesDocumentDataMatch(c.documentData);!u&&d&&s++,u&&!d&&s--}),s!==i&&(t=!0,e._setResultData(s))}else{var o=wS(e,a);o.runFullQueryAgain?r=!0:o.changed&&(t=!0,e._setResultData(o.newResults))}}}return r?e._execOverDatabase().then(c=>(e._latestChangeEvent=e.collection._changeEventBuffer.getCounter(),typeof c=="number"?((!e._result||c!==e._result.count)&&(t=!0,e._setResultData(c)),t):((!e._result||!Pb(e.collection.schema.primaryPath,c,e._result.docsData))&&(t=!0,e._setResultData(c)),t))):Promise.resolve(t)}function xc(e,t){if(!t.sort)throw ye("SNH",{query:t});var r=lx(e,t);return{query:t,queryPlan:r}}async function LS(e){var t=[],r=e.collection;if(e.isFindOneByIdQuery)if(Array.isArray(e.isFindOneByIdQuery)){var n=e.isFindOneByIdQuery;if(n=n.filter(d=>{var h=e.collection._docCache.getLatestDocumentDataIfExists(d);return h?(h._deleted||t.push(h),!1):!0}),n.length>0){var a=await r.storageInstance.findDocumentsById(n,!1);pa(t,a)}}else{var i=e.isFindOneByIdQuery,s=e.collection._docCache.getLatestDocumentDataIfExists(i);if(!s){var o=await r.storageInstance.findDocumentsById([i],!1);o[0]&&(s=o[0])}s&&!s._deleted&&t.push(s)}else{var c=e.getPreparedQuery(),u=await r.storageInstance.query(c);t=u.documents}return t}function MS(e,t){if(!t.skip&&t.selector&&Object.keys(t.selector).length===1&&t.selector[e]){var r=t.selector[e];if(typeof r=="string")return r;if(Object.keys(r).length===1&&typeof r.$eq=="string"||Object.keys(r).length===1&&Array.isArray(r.$eq)&&!r.$eq.find(n=>typeof n!="string"))return r.$eq}return!1}var jS="_rxdb_internal";async function As(e,t){var r=await e.findDocumentsById([t],!1),n=r[0];if(n)return n}async function os(e,t,r){var n=await e.bulkWrite([t],r);if(n.error.length>0){var a=n.error[0];throw a}else{var i=cr(e.schema.primaryKey),s=sr(i,[t],n),o=s[0];return o}}function FS(e,t){var r=As(e,t),n=e.changeStream().pipe(bt(a=>a.events.find(i=>i.documentId===t)),tt(a=>!!a),bt(a=>Promise.resolve(Ue(a).documentData)),Ts(r),_E(a=>a),tt(a=>!!a));return n}function cs(e){return Object.assign({},...e)}function Go(e,t,r,n){if(n)throw n.status===409?ye("CONFLICT",{collection:e.name,id:t,writeError:n,data:r}):n.status===422?ye("VD2",{collection:e.name,id:t,writeError:n,data:r}):n}function BS(e,t,r,n,a,i,s){for(var o=!!e.schema.attachments,c=[],u=[],d=[],h=bs(10),p={id:h,events:[],checkpoint:null,context:a,startTime:Rt(),endTime:0},y=p.events,g=[],w=[],b=[],x=r.size>0,O,T=n.length,B=function(){var K=n[U],q=K.document,G=K.previous,Oe=q[t],Me=q._deleted,qe=G&&G._deleted,Ae=void 0;x&&(Ae=r.get(Oe));var Ve;if(Ae){var fe=Ae._rev;if(!G||G&&fe!==G._rev){var J={isError:!0,status:409,documentId:Oe,writeRow:K,documentInDb:Ae};return d.push(J),1}var te=o?$u(K):K;o&&(Me?G&&Object.keys(G._attachments).forEach(Te=>{w.push({documentId:Oe,attachmentId:Te,digest:Ue(G)._attachments[Te].digest})}):(Object.entries(q._attachments).find(([Te,Ge])=>{var je=G?G._attachments[Te]:void 0;return!je&&!Ge.data&&(Ve={documentId:Oe,documentInDb:Ae,isError:!0,status:510,writeRow:K,attachmentId:Te}),!0}),Ve||Object.entries(q._attachments).forEach(([Te,Ge])=>{var je=G?G._attachments[Te]:void 0;if(!je)g.push({documentId:Oe,attachmentId:Te,attachmentData:Ge,digest:Ge.digest});else{var _t=te.document._attachments[Te].digest;Ge.data&&je.digest!==_t&&b.push({documentId:Oe,attachmentId:Te,attachmentData:Ge,digest:Ge.digest})}}))),Ve?d.push(Ve):(o?u.push($u(te)):u.push(te),O=te);var Q=null,re=null,xe=null;if(qe&&!Me)xe="INSERT",Q=o?Br(q):q;else if(G&&!qe&&!Me)xe="UPDATE",Q=o?Br(q):q,re=G;else if(Me)xe="DELETE",Q=Ue(q),re=G;else throw ye("SNH",{args:{writeRow:K}});var Re={documentId:Oe,documentData:Q,previousDocumentData:re,operation:xe};y.push(Re)}else{var Y=!!Me;if(o&&Object.entries(q._attachments).forEach(([Te,Ge])=>{Ge.data?g.push({documentId:Oe,attachmentId:Te,attachmentData:Ge,digest:Ge.digest}):(Ve={documentId:Oe,isError:!0,status:510,writeRow:K,attachmentId:Te},d.push(Ve))}),Ve||(o?c.push($u(K)):c.push(K),O=K),!Y){var H={documentId:Oe,operation:"INSERT",documentData:o?Br(q):q,previousDocumentData:o&&G?Br(G):G};y.push(H)}}},U=0;U<T;U++)B();return{bulkInsertDocs:c,bulkUpdateDocs:u,newestRow:O,errors:d,eventBulk:p,attachmentsAdd:g,attachmentsRemove:w,attachmentsUpdate:b}}function $u(e){return{previous:e.previous,document:Br(e.document)}}function US(e){return atob(e).length}function zS(e){var t=e.data;if(!t)return e;var r={length:US(t),digest:e.digest,type:e.type};return r}function Br(e){if(!e._attachments||Object.keys(e._attachments).length===0)return e;var t=at(e);return t._attachments={},Object.entries(e._attachments).forEach(([r,n])=>{t._attachments[r]=zS(n)}),t}function Cs(e){return Object.assign({},e,{_meta:at(e._meta)})}var _v=new WeakMap;function wf(e,t,r){rt.deepFreezeWhenDevMode(r);var n=cr(t.schema.primaryKey),a={originalStorageInstance:t,schema:t.schema,internals:t.internals,collectionName:t.collectionName,databaseName:t.databaseName,options:t.options,bulkWrite(i,s){for(var o=e.token,c=new Array(i.length),u=Rt(),d=0;d<i.length;d++){var h=i[d],p=Cs(h.document);p._meta.lwt=u;var y=h.previous;p._rev=nn(o,y),c[d]={document:p,previous:y}}return vr("preStorageWrite",{storageInstance:this.originalStorageInstance,rows:c}),e.lockedRun(()=>t.bulkWrite(c,s)).then(g=>{var w={error:[]},b=sr(n,c,g);_v.set(w,b);var x=g.error.length===0?[]:g.error.filter(T=>T.status===409&&!T.writeRow.previous&&!T.writeRow.document._deleted&&Ue(T.documentInDb)._deleted?!0:(w.error.push(T),!1));if(x.length>0){var O=x.map(T=>({previous:T.documentInDb,document:Object.assign({},T.writeRow.document,{_rev:nn(e.token,T.documentInDb)})}));return e.lockedRun(()=>t.bulkWrite(O,s)).then(T=>{pa(w.error,T.error);var B=sr(n,O,T);return pa(b,B),w})}return w})},query(i){return e.lockedRun(()=>t.query(i))},count(i){return e.lockedRun(()=>t.count(i))},findDocumentsById(i,s){return e.lockedRun(()=>t.findDocumentsById(i,s))},getAttachmentData(i,s,o){return e.lockedRun(()=>t.getAttachmentData(i,s,o))},getChangedDocumentsSince:t.getChangedDocumentsSince?(i,s)=>e.lockedRun(()=>t.getChangedDocumentsSince(Ue(i),s)):void 0,cleanup(i){return e.lockedRun(()=>t.cleanup(i))},remove(){return e.storageInstances.delete(a),e.lockedRun(()=>t.remove())},close(){return e.storageInstances.delete(a),e.lockedRun(()=>t.close())},changeStream(){return t.changeStream()},conflictResultionTasks(){return t.conflictResultionTasks()},resolveConflictResultionTask(i){if(i.output.isEqual)return t.resolveConflictResultionTask(i);var s=Object.assign({},i.output.documentData,{_meta:Ea(),_rev:yr(),_attachments:{}}),o=at(s);return delete o._meta,delete o._rev,delete o._attachments,t.resolveConflictResultionTask({id:i.id,output:{isEqual:!1,documentData:o}})}};return e.storageInstances.add(a),a}function qS(e){if(e.schema.keyCompression)throw ye("UT5",{args:{params:e}});if(gd(e.schema))throw ye("UT6",{args:{params:e}});if(e.schema.attachments&&e.schema.attachments.compression)throw ye("UT7",{args:{params:e}})}function gd(e){return!!(e.encrypted&&e.encrypted.length>0||e.attachments&&e.attachments.encrypted)}function HS(e,t,r){var n=cr(e.schema.primaryKey),a=r?r.lwt:Yd,i=r?r.id:"";return ss(e.schema,{selector:{$or:[{"_meta.lwt":{$gt:a}},{"_meta.lwt":{$eq:a},[n]:{$gt:r?i:""}}],"_meta.lwt":{$gte:a}},sort:[{"_meta.lwt":"asc"},{[n]:"asc"}],skip:0,limit:t})}async function wv(e,t,r){if(e.getChangedDocumentsSince)return e.getChangedDocumentsSince(t,r);var n=cr(e.schema.primaryKey),a=xc(e.schema,HS(e,t,r)),i=await e.query(a),s=i.documents,o=Ib(s);return{documents:s,checkpoint:o?{id:o[n],lwt:o._meta.lwt}:r||{id:"",lwt:0}}}function sr(e,t,r){var n=_v.get(r);if(n)return n;var a=[];if(r.error.length>0){for(var i=new Set,s=0;s<r.error.length;s++){var o=r.error[s];i.add(o.documentId)}for(var c=0;c<t.length;c++){var u=t[c].document;i.has(u[e])||a.push(Br(u))}}else{a.length=t.length-r.error.length;for(var d=0;d<t.length;d++){var h=t[d].document;a[d]=Br(h)}}return a}var bv=(function(){function e(r,n,a,i){this.queueByDocId=new Map,this.isRunning=!1,this.storageInstance=r,this.primaryPath=n,this.preWrite=a,this.postWrite=i}var t=e.prototype;return t.addWrite=function(n,a){var i=n[this.primaryPath],s=an(this.queueByDocId,i,()=>[]),o=new Promise((c,u)=>{var d={lastKnownDocumentState:n,modifier:a,resolve:c,reject:u};Ue(s).push(d),this.triggerRun()});return o},t.triggerRun=async function(){if(!(this.isRunning===!0||this.queueByDocId.size===0)){this.isRunning=!0;var n=[],a=this.queueByDocId;this.queueByDocId=new Map,await Promise.all(Array.from(a.entries()).map(async([s,o])=>{var c=KS(o.map(h=>h.lastKnownDocumentState)),u=c;for(var d of o)try{u=await d.modifier(Ut(u))}catch(h){d.reject(h),d.reject=()=>{},d.resolve=()=>{}}try{await this.preWrite(u,c)}catch(h){o.forEach(p=>p.reject(h));return}n.push({previous:c,document:u})}));var i=n.length>0?await this.storageInstance.bulkWrite(n,"incremental-write"):{error:[]};return await Promise.all(sr(this.primaryPath,n,i).map(s=>{var o=s[this.primaryPath];this.postWrite(s);var c=ma(a,o);c.forEach(u=>u.resolve(s))})),i.error.forEach(s=>{var o=s.documentId,c=ma(a,o),u=vc(s);if(u){var d=an(this.queueByDocId,o,()=>[]);c.reverse().forEach(p=>{p.lastKnownDocumentState=Ue(u.documentInDb),Ue(d).unshift(p)})}else{var h=h0(s);c.forEach(p=>p.reject(h))}}),this.isRunning=!1,this.triggerRun()}},e})();function sp(e){var t=async r=>{var n=Cb(r);n._deleted=r._deleted;var a=await e(n),i=Object.assign({},a,{_meta:r._meta,_attachments:r._attachments,_rev:r._rev,_deleted:typeof a._deleted<"u"?a._deleted:r._deleted});return typeof i._deleted>"u"&&(i._deleted=!1),i};return t}function KS(e){var t=e[0],r=Nn(t._rev);return e.forEach(n=>{var a=Nn(n._rev);a>r&&(t=n,r=a)}),t}var Sc={get primaryPath(){var e=this;if(e.isInstanceOfRxDocument)return e.collection.schema.primaryPath},get primary(){var e=this;if(e.isInstanceOfRxDocument)return e._data[e.primaryPath]},get revision(){var e=this;if(e.isInstanceOfRxDocument)return e._data._rev},get deleted$(){var e=this;if(e.isInstanceOfRxDocument)return e.$.pipe(bt(t=>t._data._deleted))},get deleted$$(){var e=this,t=e.collection.database.getReactivityFactory();return t.fromObservable(e.deleted$,e.getLatest().deleted,e.collection.database)},get deleted(){var e=this;if(e.isInstanceOfRxDocument)return e._data._deleted},getLatest(){var e=this.collection._docCache.getLatestDocumentData(this.primary);return this.collection._docCache.getCachedRxDocument(e)},get $(){var e=this;return e.collection.$.pipe(tt(t=>!t.isLocal),tt(t=>t.documentId===this.primary),bt(t=>Cy(t)),Ts(e.collection._docCache.getLatestDocumentData(this.primary)),ns((t,r)=>t._rev===r._rev),bt(t=>this.collection._docCache.getCachedRxDocument(t)),Os(Es))},get $$(){var e=this,t=e.collection.database.getReactivityFactory();return t.fromObservable(e.$,e.getLatest()._data,e.collection.database)},get$(e){if(rt.isDevMode()){if(e.includes(".item."))throw ye("DOC1",{path:e});if(e===this.primaryPath)throw ye("DOC2");if(this.collection.schema.finalFields.includes(e))throw ye("DOC3",{path:e});var t=Xa(this.collection.schema.jsonSchema,e);if(!t)throw ye("DOC4",{path:e})}return this.$.pipe(bt(r=>Dn(r,e)),ns())},get$$(e){var t=this.get$(e),r=this.collection.database.getReactivityFactory();return r.fromObservable(t,this.getLatest().get(e),this.collection.database)},populate(e){var t=Xa(this.collection.schema.jsonSchema,e),r=this.get(e);if(!r)return Xd;if(!t)throw ye("DOC5",{path:e});if(!t.ref)throw ye("DOC6",{path:e,schemaObj:t});var n=this.collection.database.collections[t.ref];if(!n)throw ye("DOC7",{ref:t.ref,path:e,schemaObj:t});return t.type==="array"?n.findByIds(r).exec().then(a=>{var i=a.values();return Array.from(i)}):n.findOne(r).exec()},get(e){return Sv(this,e)},toJSON(e=!1){if(e)return rt.deepFreezeWhenDevMode(this._data);var t=at(this._data);return delete t._rev,delete t._attachments,delete t._deleted,delete t._meta,rt.deepFreezeWhenDevMode(t)},toMutableJSON(e=!1){return Ut(this.toJSON(e))},update(e){throw et("update")},incrementalUpdate(e){throw et("update")},updateCRDT(e){throw et("crdt")},putAttachment(){throw et("attachments")},getAttachment(){throw et("attachments")},allAttachments(){throw et("attachments")},get allAttachments$(){throw et("attachments")},async modify(e,t){var r=this._data,n=await sp(e)(r);return this._saveData(n,r)},incrementalModify(e,t){return this.collection.incrementalWriteQueue.addWrite(this._data,sp(e)).then(r=>this.collection._docCache.getCachedRxDocument(r))},patch(e){var t=this._data,r=Ut(t);return Object.entries(e).forEach(([n,a])=>{r[n]=a}),this._saveData(r,t)},incrementalPatch(e){return this.incrementalModify(t=>(Object.entries(e).forEach(([r,n])=>{t[r]=n}),t))},async _saveData(e,t){if(e=at(e),this._data._deleted)throw ye("DOC11",{id:this.primary,document:this});await xv(this.collection,e,t);var r=[{previous:t,document:e}],n=await this.collection.storageInstance.bulkWrite(r,"rx-document-save-data"),a=n.error[0];return Go(this.collection,this.primary,e,a),await this.collection._runHooks("post","save",e,this),this.collection._docCache.getCachedRxDocument(sr(this.collection.schema.primaryPath,r,n)[0])},remove(){var e=this.collection;if(this.deleted)return Promise.reject(ye("DOC13",{document:this,id:this.primary}));var t=at(this._data),r;return e._runHooks("pre","remove",t,this).then(async()=>{t._deleted=!0;var n=[{previous:this._data,document:t}],a=await e.storageInstance.bulkWrite(n,"rx-document-remove"),i=a.error[0];return Go(e,this.primary,t,i),sr(this.collection.schema.primaryPath,n,a)[0]}).then(n=>(r=n,this.collection._runHooks("post","remove",t,this))).then(()=>this.collection._docCache.getCachedRxDocument(r))},incrementalRemove(){return this.incrementalModify(async e=>(await this.collection._runHooks("pre","remove",e,this),e._deleted=!0,e)).then(async e=>(await this.collection._runHooks("post","remove",e._data,e),e))},destroy(){throw ye("DOC14")}};function Ev(e=Sc){var t=function(n,a){this.collection=n,this._data=a,this._propertyCache=new Map,this.isInstanceOfRxDocument=!0};return t.prototype=e,t}function GS(e,t,r){var n=new e(t,r);return vr("createRxDocument",n),n}function xv(e,t,r){return t._meta=Object.assign({},r._meta,t._meta),rt.isDevMode()&&e.schema.validateChange(r,t),e._runHooks("pre","save",t,r)}function Sv(e,t){return an(e._propertyCache,t,()=>{var r=Dn(e._data,t);if(typeof r!="object"||r===null||Array.isArray(r))return rt.deepFreezeWhenDevMode(r);var n=new Proxy(at(r),{get(a,i){if(typeof i!="string")return a[i];var s=i.charAt(i.length-1);if(s==="$")if(i.endsWith("$$")){var o=i.slice(0,-2);return e.get$$(Mi(t+"."+o))}else{var c=i.slice(0,-1);return e.get$(Mi(t+"."+c))}else if(s==="_"){var u=i.slice(0,-1);return e.populate(Mi(t+"."+u))}else{var d=a[i];return typeof d=="number"||typeof d=="string"||typeof d=="boolean"?d:Sv(e,Mi(t+"."+i))}}});return n})}var ua="collection",bf="storage-token",Po="rx-migration-status",WS="RxInternalDocument",Ef=_c({version:0,title:WS,primaryKey:{key:"id",fields:["context","key"],separator:"|"},type:"object",properties:{id:{type:"string",maxLength:200},key:{type:"string"},context:{type:"string",enum:[ua,bf,Po,"OTHER"]},data:{type:"object",additionalProperties:!0}},indexes:[],required:["key","context","data"],additionalProperties:!1,sharding:{shards:1,mode:"collection"}});function si(e,t){return xa(Ef,{key:e,context:t})}async function kv(e){var t=xc(e.schema,{selector:{context:ua,_deleted:{$eq:!1}},sort:[{id:"asc"}],skip:0}),r=await e.query(t),n=r.documents;return n}var Iv="storageToken",VS=si(Iv,bf);async function ZS(e){var t=bs(10),r=e.password?await e.hashFunction(JSON.stringify(e.password)):void 0,n={id:VS,context:bf,key:Iv,data:{rxdbVersion:e.rxdbVersion,token:t,instanceToken:e.token,passwordHash:r},_deleted:!1,_meta:Ea(),_rev:yr(),_attachments:{}},a=[{document:n}],i=await e.internalStore.bulkWrite(a,"internal-add-storage-token");if(!i.error[0])return sr("id",a,i)[0];var s=Ue(i.error[0]);if(s.isError&&vc(s)){var o=s;if(!JS(o.documentInDb.data.rxdbVersion,e.rxdbVersion))throw ye("DM5",{args:{database:e.name,databaseStateVersion:o.documentInDb.data.rxdbVersion,codeVersion:e.rxdbVersion}});if(r&&r!==o.documentInDb.data.passwordHash)throw ye("DB1",{passwordHash:r,existingPasswordHash:o.documentInDb.data.passwordHash});var c=o.documentInDb;return Ue(c)}throw s}function JS(e,t){if(!e||t.includes("beta")&&t!==e)return!1;var r=e.split(".")[0],n=t.split(".")[0];return r===n}async function QS(e,t,r){if(e.schema.version!==r.version)throw ye("SNH",{schema:r,version:e.schema.version,name:e.name,collection:e,args:{storageCollectionName:t}});for(var n=yd(e.name,e.schema.jsonSchema),a=si(n,ua);;){var i=await As(e.database.internalStore,a),s=Ut(Ue(i)),o=s.data.connectedStorages.find(c=>c.collectionName===t&&c.schema.version===r.version);if(o)return;s.data.connectedStorages.push({collectionName:t,schema:r});try{await os(e.database.internalStore,{previous:Ue(i),document:s},"add-connected-storage-to-collection")}catch(c){if(!vc(c))throw c}}}function yd(e,t){return e+"-"+t.version}function ho(e,t){return t=at(t),t=_0(e,t),typeof e.jsonSchema.primaryKey!="string"&&(t=p0(e.primaryPath,e.jsonSchema,t)),t._meta=Ea(),Object.prototype.hasOwnProperty.call(t,"_deleted")||(t._deleted=!1),Object.prototype.hasOwnProperty.call(t,"_attachments")||(t._attachments={}),Object.prototype.hasOwnProperty.call(t,"_rev")||(t._rev=yr()),t}async function YS(e,t){t.multiInstance=e.multiInstance;var r=await e.storage.createStorageInstance(t);return r}async function Ov(e,t,r,n,a,i,s){var o=await kv(t),c=o.filter(p=>p.data.name===a),u=[];c.forEach(p=>{u.push({collectionName:p.data.name,schema:p.data.schema,isCollection:!0}),p.data.connectedStorages.forEach(y=>u.push({collectionName:y.collectionName,isCollection:!1,schema:y.schema}))});var d=new Set;if(u=u.filter(p=>{var y=p.collectionName+"||"+p.schema.version;return d.has(y)?!1:(d.add(y),!0)}),await Promise.all(u.map(async p=>{var y=await e.createStorageInstance({collectionName:p.collectionName,databaseInstanceToken:r,databaseName:n,multiInstance:!1,options:{},schema:p.schema,password:i,devMode:rt.isDevMode()});await y.remove(),p.isCollection&&await xs("postRemoveRxCollection",{storage:e,databaseName:n,collectionName:a})})),s){var h=c.map(p=>{var y=Cs(p);return y._deleted=!0,y._meta.lwt=Rt(),y._rev=nn(r,p),{previous:p,document:y}});await t.bulkWrite(h,"rx-database-remove-collection-all")}}function pr(e){if(e.destroyed)throw ye("COL21",{collection:e.name,version:e.schema.version})}var XS=(function(){function e(r){this.subs=[],this.counter=0,this.eventCounterMap=new WeakMap,this.buffer=[],this.limit=100,this.tasks=new Set,this.collection=r,this.subs.push(this.collection.database.eventBulks$.pipe(tt(n=>n.collectionName===this.collection.name),tt(n=>{var a=n.events[0];return!a.isLocal})).subscribe(n=>{this.tasks.add(()=>this._handleChangeEvents(n.events)),this.tasks.size<=1&&yc().then(()=>{this.processTasks()})}))}var t=e.prototype;return t.processTasks=function(){if(this.tasks.size!==0){var n=Array.from(this.tasks);n.forEach(a=>a()),this.tasks.clear()}},t._handleChangeEvents=function(n){var a=this.counter;this.counter=this.counter+n.length,n.length>this.limit?this.buffer=n.slice(n.length*-1):(pa(this.buffer,n),this.buffer=this.buffer.slice(this.limit*-1));for(var i=a+1,s=this.eventCounterMap,o=0;o<n.length;o++){var c=n[o];s.set(c,i+o)}},t.getCounter=function(){return this.processTasks(),this.counter},t.getBuffer=function(){return this.processTasks(),this.buffer},t.getArrayIndexByPointer=function(n){this.processTasks();var a=this.buffer[0],i=this.eventCounterMap.get(a);if(n<i)return null;var s=n-i;return s},t.getFrom=function(n){this.processTasks();var a=[],i=this.getArrayIndexByPointer(n);if(i===null)return null;for(;;){var s=this.buffer[i];if(i++,s)a.push(s);else return a}},t.runFrom=function(n,a){this.processTasks();var i=this.getFrom(n);if(i===null)throw new Error("out of bounds");i.forEach(s=>a(s))},t.reduceByLastOfDoc=function(n){return this.processTasks(),n.slice(0)},t.destroy=function(){this.tasks.clear(),this.subs.forEach(n=>n.unsubscribe())},e})();function ek(e){return new XS(e)}var tk=new WeakMap;function rk(e){var t=e.schema.getDocumentPrototype(),r=ik(e),n=Sc,a={};return[t,r,n].forEach(i=>{var s=Object.getOwnPropertyNames(i);s.forEach(o=>{var c=Object.getOwnPropertyDescriptor(i,o),u=!0;(o.startsWith("_")||o.endsWith("_")||o.startsWith("$")||o.endsWith("$"))&&(u=!1),typeof c.value=="function"?Object.defineProperty(a,o,{get(){return c.value.bind(this)},enumerable:u,configurable:!1}):(c.enumerable=u,c.configurable=!1,c.writable&&(c.writable=!1),Object.defineProperty(a,o,c))})}),a}function nk(e){return an(tk,e,()=>Ev(rk(e)))}function ak(e,t,r){var n=GS(t,e,rt.deepFreezeWhenDevMode(r));return e._runHooksSync("post","create",r,n),vr("postCreateRxDocument",n),n}function ik(e){var t={};return Object.entries(e.methods).forEach(([r,n])=>{t[r]=n}),t}async function Wo(e,t){var r=xa(e.input.metaInstance.schema,{isCheckpoint:"1",itemId:t}),n=await e.input.metaInstance.findDocumentsById([r],!1),a=n[0];if(e.lastCheckpointDoc[t]=a,a)return a.checkpointData}async function Vo(e,t,r){e.checkpointQueue=e.checkpointQueue.then(async()=>{var n=e.lastCheckpointDoc[t];if(r&&!e.events.canceled.getValue()&&(!n||JSON.stringify(n.checkpointData)!==JSON.stringify(r))){var a={id:"",isCheckpoint:"1",itemId:t,_deleted:!1,_attachments:{},checkpointData:r,_meta:Ea(),_rev:yr()};for(a.id=xa(e.input.metaInstance.schema,a);!e.events.canceled.getValue();){if(n&&(a.checkpointData=cs([n.checkpointData,a.checkpointData])),a._meta.lwt=Rt(),a._rev=nn(await e.checkpointKey,n),e.events.canceled.getValue())return;var i=[{previous:n,document:a}],s=await e.input.metaInstance.bulkWrite(i,"replication-set-checkpoint"),o=sr(e.primaryPath,i,s)[0];if(o){e.lastCheckpointDoc[t]=o;return}else{var c=s.error[0];if(c.status!==409)throw c;n=Ue(c.documentInDb),a._rev=nn(await e.checkpointKey,n)}}}}),await e.checkpointQueue}async function sk(e){var t=await e.hashFunction([e.identifier,e.forkInstance.databaseName,e.forkInstance.collectionName].join("||"));return"rx_storage_replication_"+t}function op(e,t,r,n,a){var i=Object.assign({},n,{_attachments:t&&n._attachments?n._attachments:{},_meta:r?n._meta:Object.assign({},a?a._meta:{},{lwt:Rt()}),_rev:r?n._rev:yr()});return i._rev||(i._rev=nn(e,a)),i}function In(e,t,r){var n=at(e);return t||delete n._attachments,r||(delete n._meta,delete n._rev),n}function vd(e,t){return e.hasAttachments?t.map(r=>{var n=Ut(r.document);return n.docData=Br(n.docData),{document:n,previous:r.previous}}):t}function _d(e){for(;;)if(e.underlyingPersistentStorage)e=e.underlyingPersistentStorage;else return e}var No="RxReplicationProtocolMetaData";function cp(e,t){var r=m0(e),n={title:No,primaryKey:{key:"id",fields:["itemId","isCheckpoint"],separator:"|"},type:"object",version:e.version,additionalProperties:!1,properties:{id:{type:"string",minLength:1,maxLength:r+2},isCheckpoint:{type:"string",enum:["0","1"],minLength:1,maxLength:1},itemId:{type:"string",maxLength:r>4?r:4},checkpointData:{type:"object",additionalProperties:!0},docData:{type:"object",properties:e.properties},isResolvedConflict:{type:"string"}},keyCompression:e.keyCompression,required:["id","isCheckpoint","itemId"]};t&&(n.encrypted=["docData"]);var a=_c(n);return a}function Tv(e,t){return e.input.metaInstance.findDocumentsById(t.map(r=>{var n=xa(e.input.metaInstance.schema,{itemId:r,isCheckpoint:"0"});return n}),!0).then(r=>{var n={};return Object.values(r).forEach(a=>{n[a.itemId]={docData:a.docData,metaDocument:a}}),n})}async function Zo(e,t,r,n){var a=t[e.primaryPath],i=r?Cs(r):{id:"",isCheckpoint:"0",itemId:a,docData:t,_attachments:{},_deleted:!1,_rev:yr(),_meta:{lwt:0}};i.docData=t,n&&(i.isResolvedConflict=n),i._meta.lwt=Rt(),i.id=xa(e.input.metaInstance.schema,i),i._rev=nn(await e.checkpointKey,r);var s={previous:r,document:i};return s}async function ok(e){if(e.input.initialCheckpoint&&e.input.initialCheckpoint.downstream){var t=await Wo(e,"down");t||await Vo(e,"down",e.input.initialCheckpoint.downstream)}var r=await e.input.hashFunction(e.input.identifier),n=e.input.replicationHandler,a=0,i=[];function s(g){e.stats.down.addNewTask=e.stats.down.addNewTask+1;var w={time:a++,task:g};i.push(w),e.streamQueue.down=e.streamQueue.down.then(()=>{for(var b=[];i.length>0;){e.events.active.down.next(!0);var x=Ue(i.shift());if(!(x.time<c)){if(x.task==="RESYNC")if(b.length===0){b.push(x.task);break}else break;b.push(x.task)}}if(b.length!==0)return b[0]==="RESYNC"?u():d(b)}).then(()=>{e.events.active.down.next(!1),!e.firstSyncDone.down.getValue()&&!e.events.canceled.getValue()&&e.firstSyncDone.down.next(!0)})}if(s("RESYNC"),!e.events.canceled.getValue()){var o=n.masterChangeStream$.pipe(on(async g=>(await sa(e.events.active.up.pipe(tt(w=>!w))),g))).subscribe(g=>{e.stats.down.masterChangeStreamEmit=e.stats.down.masterChangeStreamEmit+1,s(g)});sa(e.events.canceled.pipe(tt(g=>!!g))).then(()=>o.unsubscribe())}var c=-1;async function u(){if(e.stats.down.downstreamResyncOnce=e.stats.down.downstreamResyncOnce+1,!e.events.canceled.getValue()){e.checkpointQueue=e.checkpointQueue.then(()=>Wo(e,"down"));for(var g=await e.checkpointQueue,w=[];!e.events.canceled.getValue();){c=a++;var b=await n.masterChangesSince(g,e.input.pullBatchSize);if(b.documents.length===0||(g=cs([g,b.checkpoint]),w.push(y(b.documents,g)),b.documents.length<e.input.pullBatchSize))break}await Promise.all(w)}}function d(g){e.stats.down.downstreamProcessChanges=e.stats.down.downstreamProcessChanges+1;var w=[],b=null;return g.forEach(x=>{if(x==="RESYNC")throw new Error("SNH");pa(w,x.documents),b=cs([b,x.checkpoint])}),y(w,Ue(b))}var h=gr,p={docs:{}};function y(g,w){var b=e.primaryPath;return e.stats.down.persistFromMaster=e.stats.down.persistFromMaster+1,g.forEach(x=>{var O=x[b];p.docs[O]=x}),p.checkpoint=w,h=h.then(()=>{var x=p.docs;p.docs={};var O=p.checkpoint,T=Object.keys(x);if(e.events.canceled.getValue()||T.length===0)return gr;var B=[],U={},K={},q=[];return Promise.all([e.input.forkInstance.findDocumentsById(T,!0),Tv(e,T)]).then(([G,Oe])=>{var Me=new Map;return G.forEach(qe=>Me.set(qe[b],qe)),Promise.all(T.map(async qe=>{var Ae=Me.get(qe),Ve=Ae?In(Ae,e.hasAttachments,!1):void 0,Y=x[qe],H=Oe[qe];H&&Ae&&H.metaDocument.isResolvedConflict===Ae._rev&&await e.streamQueue.up;var fe=!H||!Ve?!1:await e.input.conflictHandler({realMasterState:H.docData,newDocumentState:Ve},"downstream-check-if-equal-0").then(xe=>xe.isEqual);if(!fe&&H&&H.docData._rev&&Ae&&Ae._meta[e.input.identifier]&&Nn(Ae._rev)===Ae._meta[e.input.identifier]&&(fe=!0),Ae&&H&&fe===!1||Ae&&!H)return gr;var J=Ve?await e.input.conflictHandler({realMasterState:Y,newDocumentState:Ve},"downstream-check-if-equal-1").then(xe=>xe.isEqual):!1;if(Ve&&J)return(!H||fe===!1)&&q.push(await Zo(e,Ve,H?H.metaDocument:void 0)),gr;var te=Object.assign({},Y,Ae?{_meta:at(Ae._meta),_attachments:e.hasAttachments&&Y._attachments?Y._attachments:{},_rev:yr()}:{_meta:{lwt:Rt()},_rev:yr(),_attachments:e.hasAttachments&&Y._attachments?Y._attachments:{}});if(Y._rev){var Q=Ae?Nn(Ae._rev)+1:1;te._meta[e.input.identifier]=Q,e.input.keepMeta&&(te._rev=Y._rev)}e.input.keepMeta&&Y._meta&&(te._meta=Y._meta);var re={previous:Ae,document:te};re.document._rev=re.document._rev?re.document._rev:nn(r,re.previous),B.push(re),U[qe]=re,K[qe]=await Zo(e,Y,H?H.metaDocument:void 0)}))}).then(async()=>{if(B.length>0)return e.input.forkInstance.bulkWrite(B,await e.downstreamBulkWriteFlag).then(G=>{var Oe=sr(e.primaryPath,B,G);Oe.forEach(Me=>{var qe=Me[b];e.events.processed.down.next(U[qe]),q.push(K[qe])}),G.error.forEach(Me=>{Me.status!==409&&e.events.error.next(ye("RC_PULL",{writeError:Me}))})})}).then(()=>{if(q.length>0)return e.input.metaInstance.bulkWrite(vd(e,q),"replication-down-write-meta").then(G=>{G.error.forEach(Oe=>{e.events.error.next(ye("RC_PULL",{id:Oe.documentId,writeError:Oe}))})})}).then(()=>{Vo(e,"down",O)})}).catch(x=>e.events.error.next(x)),h}}var Jo=function(e,t){var r=Br(e.newDocumentState),n=Br(e.realMasterState);return es(r,n)?Promise.resolve({isEqual:!0}):Promise.resolve({isEqual:!1,documentData:e.realMasterState})};async function ck(e,t,r){var n=e.input.conflictHandler,a=await n(t,"replication-resolve-conflict");if(!a.isEqual){var i=Object.assign({},a.documentData,{_meta:at(r._meta),_rev:yr(),_attachments:at(r._attachments)});return i._meta.lwt=Rt(),i._rev=nn(await e.checkpointKey,r),{resolvedDoc:i,output:a}}}async function wd(e,t,r,n){if(!r._attachments||n&&!n._attachments)throw new Error("_attachments missing");var a=r[e],i=new Set(n&&n._attachments?Object.keys(n._attachments):[]);return await Promise.all(Object.entries(r._attachments).map(async([s,o])=>{if((!i.has(s)||n&&Ue(n._attachments)[s].digest!==o.digest)&&!o.data){var c=await t.getAttachmentData(a,s,o.digest);o.data=c}})),r}async function uk(e){if(e.input.initialCheckpoint&&e.input.initialCheckpoint.upstream){var t=await Wo(e,"up");t||await Vo(e,"up",e.input.initialCheckpoint.upstream)}var r=e.input.replicationHandler;e.streamQueue.up=e.streamQueue.up.then(()=>u().then(()=>{d()}));var n=0,a=-1,i=[],s=Or,o={docs:{}},c=e.input.forkInstance.changeStream().subscribe(async p=>{if(p.context!==await e.downstreamBulkWriteFlag)return e.stats.up.forkChangeStreamEmit=e.stats.up.forkChangeStreamEmit+1,i.push({task:p,time:n++}),e.events.active.up.getValue()||e.events.active.up.next(!0),e.input.waitBeforePersist?e.input.waitBeforePersist().then(()=>d()):d()});sa(e.events.canceled.pipe(tt(p=>!!p))).then(()=>c.unsubscribe());async function u(){if(e.stats.up.upstreamInitialSync=e.stats.up.upstreamInitialSync+1,!e.events.canceled.getValue()){e.checkpointQueue=e.checkpointQueue.then(()=>Wo(e,"up"));for(var p=await e.checkpointQueue,y=new Set,g=async function(){a=n++,y.size>3&&await Promise.race(Array.from(y));var x=await wv(e.input.forkInstance,e.input.pushBatchSize,p);if(x.documents.length===0)return 1;p=cs([p,x.checkpoint]);var O=h(x.documents,Ue(p));y.add(O),O.catch().then(()=>y.delete(O))};!e.events.canceled.getValue()&&!await g(););var w=await Promise.all(y),b=w.find(x=>!!x);b?await u():!e.firstSyncDone.up.getValue()&&!e.events.canceled.getValue()&&e.firstSyncDone.up.next(!0)}}function d(){if(e.events.canceled.getValue()||i.length===0){e.events.active.up.next(!1);return}e.stats.up.processTasks=e.stats.up.processTasks+1,e.events.active.up.next(!0),e.streamQueue.up=e.streamQueue.up.then(()=>{for(var p=[],y={};i.length>0;){var g=Ue(i.shift());g.time<a||(pa(p,g.task.events.map(b=>b.documentData)),y=cs([y,g.task.checkpoint]))}var w=p.length===0?Or:h(p,y);return w.then(()=>{i.length===0?e.events.active.up.next(!1):d()})})}function h(p,y){return e.stats.up.persistToMaster=e.stats.up.persistToMaster+1,p.forEach(g=>{var w=g[e.primaryPath];o.docs[w]=g}),o.checkpoint=y,s=s.then(async()=>{if(e.events.canceled.getValue())return!1;var g=o.docs;o.docs={};var w=o.checkpoint,b=Object.keys(g);if(b.length===0)return!1;var x=await Tv(e,b),O={},T=[],B={},U={};if(await Promise.all(b.map(async J=>{var te=g[J];U[J]=te;var Q=In(te,e.hasAttachments,!!e.input.keepMeta),re=x[J];re&&re.metaDocument.isResolvedConflict!==te._rev&&(await e.input.conflictHandler({realMasterState:re.docData,newDocumentState:Q},"upstream-check-if-equal")).isEqual||re&&re.docData._rev&&Nn(te._rev)===te._meta[e.input.identifier]||(T.push(J),O[J]={assumedMasterState:re?re.docData:void 0,newDocumentState:Q},B[J]=await Zo(e,Q,re?re.metaDocument:void 0))})),T.length===0)return!1;var K=Object.values(O),q=new Set,G={},Oe=Ob(K,e.input.pushBatchSize);await Promise.all(Oe.map(async J=>{e.hasAttachments&&await Promise.all(J.map(async Q=>{Q.newDocumentState=await wd(e.primaryPath,e.input.forkInstance,Ut(Q.newDocumentState),Q.assumedMasterState)}));var te=await r.masterWrite(J);te.forEach(Q=>{var re=Q[e.primaryPath];q.add(re),G[re]=Q})}));var Me=[];if(T.forEach(J=>{q.has(J)||(e.events.processed.up.next(O[J]),Me.push(B[J]))}),e.events.canceled.getValue())return!1;Me.length>0&&await e.input.metaInstance.bulkWrite(vd(e,Me),"replication-up-write-meta");var qe=!1;if(q.size>0){e.stats.up.persistToMasterHadConflicts=e.stats.up.persistToMasterHadConflicts+1;var Ae=[],Ve={};if(await Promise.all(Object.entries(G).map(([J,te])=>{var Q=O[J],re={newDocumentState:Q.newDocumentState,assumedMasterState:Q.assumedMasterState,realMasterState:te};return ck(e,re,U[J]).then(async xe=>{if(xe){e.events.resolvedConflicts.next({input:re,output:xe.output}),Ae.push({previous:U[J],document:xe.resolvedDoc});var Re=x[J];Ve[J]=await Zo(e,Ue(te),Re?Re.metaDocument:void 0,xe.resolvedDoc._rev)}})})),Ae.length>0){qe=!0,e.stats.up.persistToMasterConflictWrites=e.stats.up.persistToMasterConflictWrites+1;var Y=await e.input.forkInstance.bulkWrite(Ae,"replication-up-write-conflict"),H=[],fe=sr(e.primaryPath,Ae,Y);fe.forEach(J=>{var te=J[e.primaryPath];H.push(Ve[te])}),H.length>0&&await e.input.metaInstance.bulkWrite(vd(e,H),"replication-up-write-conflict-meta")}}return Vo(e,"up",w),qe}).catch(g=>(e.events.error.next(g),!1)),s}}function lk(e){e=at(e),e.forkInstance=_d(e.forkInstance),e.metaInstance=_d(e.metaInstance);var t=sk(e),r={primaryPath:cr(e.forkInstance.schema.primaryKey),hasAttachments:!!e.forkInstance.schema.attachments,input:e,checkpointKey:t,downstreamBulkWriteFlag:t.then(n=>"replication-downstream-"+n),events:{canceled:new na(!1),active:{down:new na(!0),up:new na(!0)},processed:{down:new nr,up:new nr},resolvedConflicts:new nr,error:new nr},stats:{down:{addNewTask:0,downstreamProcessChanges:0,downstreamResyncOnce:0,masterChangeStreamEmit:0,persistFromMaster:0},up:{forkChangeStreamEmit:0,persistToMaster:0,persistToMasterConflictWrites:0,persistToMasterHadConflicts:0,processTasks:0,upstreamInitialSync:0}},firstSyncDone:{down:new na(!1),up:new na(!1)},streamQueue:{down:gr,up:gr},checkpointQueue:gr,lastCheckpointDoc:{}};return ok(r),uk(r),r}function dk(e){return sa(oE([e.firstSyncDone.down.pipe(tt(t=>!!t)),e.firstSyncDone.up.pipe(tt(t=>!!t))])).then(()=>{})}function fk(e,t,r,n=!1){e=_d(e);var a=!!e.schema.attachments,i=cr(e.schema.primaryKey),s={masterChangeStream$:e.changeStream().pipe(on(async o=>{var c={checkpoint:o.checkpoint,documents:await Promise.all(o.events.map(async u=>{var d=In(u.documentData,a,n);return a&&(d=await wd(i,e,Ut(d),void 0)),d}))};return c})),masterChangesSince(o,c){return wv(e,c,o).then(async u=>({checkpoint:u.documents.length>0?u.checkpoint:o,documents:await Promise.all(u.documents.map(async d=>{var h=In(d,a,n);return a&&(h=await wd(i,e,Ut(h),void 0)),h}))}))},async masterWrite(o){var c={};o.forEach(w=>{var b=w.newDocumentState[i];c[b]=w});var u=Object.keys(c),d=await e.findDocumentsById(u,!0),h=new Map;d.forEach(w=>h.set(w[i],w));var p=[],y=[];if(await Promise.all(Object.entries(c).map(async([w,b])=>{var x=h.get(w);x?x&&!b.assumedMasterState?p.push(In(x,a,n)):(await t({realMasterState:In(x,a,n),newDocumentState:Ue(b.assumedMasterState)},"rxStorageInstanceToReplicationHandler-masterWrite")).isEqual===!0?y.push({previous:x,document:op(r,a,n,b.newDocumentState,x)}):p.push(In(x,a,n)):y.push({document:op(r,a,n,b.newDocumentState)})})),y.length>0){var g=await e.bulkWrite(y,"replication-master-write");g.error.forEach(w=>{if(w.status!==409)throw new Error("non conflict error");p.push(In(Ue(w.documentInDb),a,n))})}return p}};return s}async function hk(e){e.events.canceled.next(!0),e.events.active.up.complete(),e.events.active.down.complete(),e.events.processed.up.complete(),e.events.processed.down.complete(),e.events.resolvedConflicts.complete(),e.events.canceled.complete(),await e.checkpointQueue}var Rv=["pre","post"],$v=["insert","save","remove","create"],up=!1,Av=(function(){function e(r,n,a,i,s={},o={},c={},u={},d={},h=pv,p={},y=Jo){this.storageInstance={},this.timeouts=new Set,this.incrementalWriteQueue={},this.awaitBeforeReads=new Set,this._incrementalUpsertQueues=new Map,this.synced=!1,this.hooks={},this._subs=[],this._docCache={},this._queryCache=ES(),this.$={},this.checkpoint$={},this._changeEventBuffer={},this.onDestroy=[],this.destroyed=!1,this.onRemove=[],this.database=r,this.name=n,this.schema=a,this.internalStorageInstance=i,this.instanceCreationOptions=s,this.migrationStrategies=o,this.methods=c,this.attachments=u,this.options=d,this.cacheReplacementPolicy=h,this.statics=p,this.conflictHandler=y,pk(this.asRxCollection)}var t=e.prototype;return t.prepare=async function(){this.storageInstance=wf(this.database,this.internalStorageInstance,this.schema.jsonSchema),this.incrementalWriteQueue=new bv(this.storageInstance,this.schema.primaryPath,(c,u)=>xv(this,c,u),c=>this._runHooks("post","save",c));var n=this.database.eventBulks$.pipe(tt(c=>c.collectionName===this.name));this.$=n.pipe(on(c=>c.events)),this.checkpoint$=n.pipe(bt(c=>c.checkpoint)),this._changeEventBuffer=ek(this.asRxCollection);var a;this._docCache=new mv(this.schema.primaryPath,this.database.eventBulks$.pipe(tt(c=>c.collectionName===this.name&&!c.events[0].isLocal),bt(c=>c.events)),c=>(a||(a=nk(this.asRxCollection)),ak(this.asRxCollection,a,c)));var i=this.database.internalStore.changeStream().pipe(tt(c=>{var u=this.name+"-"+this.schema.version,d=c.events.find(h=>h.documentData.context==="collection"&&h.documentData.key===u&&h.operation==="DELETE");return!!d})).subscribe(async()=>{await this.destroy(),await Promise.all(this.onRemove.map(c=>c()))});this._subs.push(i);var s=await this.database.storageToken,o=this.storageInstance.changeStream().subscribe(c=>{for(var u=new Array(c.events.length),d=c.events,h=this.name,p=rt.deepFreezeWhenDevMode,y=0;y<d.length;y++){var g=d[y];u[y]={documentId:g.documentId,collectionName:h,isLocal:!1,operation:g.operation,documentData:p(g.documentData),previousDocumentData:p(g.previousDocumentData)}}var w={id:c.id,internal:!1,collectionName:this.name,storageToken:s,events:u,databaseToken:this.database.token,checkpoint:c.checkpoint,context:c.context,endTime:c.endTime,startTime:c.startTime};this.database.$emit(w)});return this._subs.push(o),this._subs.push(this.storageInstance.conflictResultionTasks().subscribe(c=>{this.conflictHandler(c.input,c.context).then(u=>{this.storageInstance.resolveConflictResultionTask({id:c.id,output:u})})})),gr},t.cleanup=function(n){throw pr(this),et("cleanup")},t.migrationNeeded=function(){throw et("migration-schema")},t.getMigrationState=function(){throw et("migration-schema")},t.startMigration=function(n=10){return pr(this),this.getMigrationState().startMigration(n)},t.migratePromise=function(n=10){return this.getMigrationState().migratePromise(n)},t.insert=async function(n){pr(this);var a=await this.bulkInsert([n]),i=a.error[0];Go(this,n[this.schema.primaryPath],n,i);var s=Ue(a.success[0]);return s},t.bulkInsert=async function(n){if(pr(this),n.length===0)return{success:[],error:[]};var a=this.schema.primaryPath,i=new Set,s;if(this.hasHooks("pre","insert"))s=await Promise.all(n.map(b=>{var x=ho(this.schema,b);return this._runHooks("pre","insert",x).then(()=>(i.add(x[a]),{document:x}))}));else{s=new Array(n.length);for(var o=this.schema,c=0;c<n.length;c++){var u=n[c],d=ho(o,u);i.add(d[a]),s[c]={document:d}}}if(i.size!==n.length)throw ye("COL22",{collection:this.name,args:{documents:n}});var h=await this.storageInstance.bulkWrite(s,"rx-collection-bulk-insert"),p,y=this,g={get success(){if(!p){var b=sr(y.schema.primaryPath,s,h);p=gv(y._docCache,b)}return p},error:h.error};if(this.hasHooks("post","insert")){var w=new Map;s.forEach(b=>{var x=b.document;w.set(x[a],x)}),await Promise.all(g.success.map(b=>this._runHooks("post","insert",w.get(b.primary),b)))}return g},t.bulkRemove=async function(n){pr(this);var a=this.schema.primaryPath;if(n.length===0)return{success:[],error:[]};var i=await this.findByIds(n).exec(),s=[],o=new Map;Array.from(i.values()).forEach(y=>{var g=y.toMutableJSON(!0);s.push(g),o.set(y.primary,g)}),await Promise.all(s.map(y=>{var g=y[this.schema.primaryPath];return this._runHooks("pre","remove",y,i.get(g))}));var c=s.map(y=>{var g=at(y);return g._deleted=!0,{previous:y,document:g}}),u=await this.storageInstance.bulkWrite(c,"rx-collection-bulk-remove"),d=sr(this.schema.primaryPath,c,u),h=d.map(y=>y[a]);await Promise.all(h.map(y=>this._runHooks("post","remove",o.get(y),i.get(y))));var p=h.map(y=>ma(i,y));return{success:p,error:u.error}},t.bulkUpsert=async function(n){pr(this);var a=[],i=new Map;n.forEach(u=>{var d=ho(this.schema,u),h=d[this.schema.primaryPath];if(!h)throw ye("COL3",{primaryPath:this.schema.primaryPath,data:d,schema:this.schema.jsonSchema});i.set(h,d),a.push(d)});var s=await this.bulkInsert(a),o=s.success.slice(0),c=[];return await Promise.all(s.error.map(async u=>{if(u.status!==409)c.push(u);else{var d=u.documentId,h=ma(i,d),p=Ue(u.documentInDb),y=this._docCache.getCachedRxDocuments([p])[0],g=await y.incrementalModify(()=>h);o.push(g)}})),{error:c,success:o}},t.upsert=async function(n){pr(this);var a=await this.bulkUpsert([n]);return Go(this.asRxCollection,n[this.schema.primaryPath],n,a.error[0]),a.success[0]},t.incrementalUpsert=function(n){pr(this);var a=ho(this.schema,n),i=a[this.schema.primaryPath];if(!i)throw ye("COL4",{data:n});var s=this._incrementalUpsertQueues.get(i);return s||(s=gr),s=s.then(()=>gk(this,i,a)).then(o=>o.inserted?o.doc:mk(o.doc,a)),this._incrementalUpsertQueues.set(i,s),s},t.find=function(n){if(pr(this),typeof n=="string")throw ye("COL5",{queryObj:n});n||(n=Co());var a=Ua("find",n,this);return a},t.findOne=function(n){if(pr(this),typeof n=="number"||Array.isArray(n))throw tr("COL6",{queryObj:n});var a;if(typeof n=="string")a=Ua("findOne",{selector:{[this.schema.primaryPath]:n},limit:1},this);else{if(n||(n=Co()),n.limit)throw ye("QU6");n=at(n),n.limit=1,a=Ua("findOne",n,this)}return a},t.count=function(n){pr(this),n||(n=Co());var a=Ua("count",n,this);return a},t.findByIds=function(n){pr(this);var a={selector:{[this.schema.primaryPath]:{$in:n.slice(0)}}},i=Ua("findByIds",a,this);return i},t.exportJSON=function(){throw et("json-dump")},t.importJSON=function(n){throw et("json-dump")},t.insertCRDT=function(n){throw et("crdt")},t.addPipeline=function(n){throw et("pipeline")},t.addHook=function(n,a,i,s=!1){if(typeof i!="function")throw tr("COL7",{key:a,when:n});if(!Rv.includes(n))throw tr("COL8",{key:a,when:n});if(!$v.includes(a))throw ye("COL9",{key:a});if(n==="post"&&a==="create"&&s===!0)throw ye("COL10",{when:n,key:a,parallel:s});var o=i.bind(this),c=s?"parallel":"series";this.hooks[a]=this.hooks[a]||{},this.hooks[a][n]=this.hooks[a][n]||{series:[],parallel:[]},this.hooks[a][n][c].push(o)},t.getHooks=function(n,a){return!this.hooks[a]||!this.hooks[a][n]?{series:[],parallel:[]}:this.hooks[a][n]},t.hasHooks=function(n,a){if(!this.hooks[a]||!this.hooks[a][n])return!1;var i=this.getHooks(n,a);return i?i.series.length>0||i.parallel.length>0:!1},t._runHooks=function(n,a,i,s){var o=this.getHooks(n,a);if(!o)return gr;var c=o.series.map(u=>()=>u(i,s));return t0(c).then(()=>Promise.all(o.parallel.map(u=>u(i,s))))},t._runHooksSync=function(n,a,i,s){if(this.hasHooks(n,a)){var o=this.getHooks(n,a);o&&o.series.forEach(c=>c(i,s))}},t.promiseWait=function(n){var a=new Promise(i=>{var s=setTimeout(()=>{this.timeouts.delete(s),i()},n);this.timeouts.add(s)});return a},t.destroy=async function(){return this.destroyed?Or:(await Promise.all(this.onDestroy.map(n=>n())),this.destroyed=!0,Array.from(this.timeouts).forEach(n=>clearTimeout(n)),this._changeEventBuffer&&this._changeEventBuffer.destroy(),this.database.requestIdlePromise().then(()=>this.storageInstance.close()).then(()=>(this._subs.forEach(n=>n.unsubscribe()),delete this.database.collections[this.name],xs("postDestroyRxCollection",this).then(()=>!0))))},t.remove=async function(){await this.destroy(),await Promise.all(this.onRemove.map(n=>n())),await Ov(this.database.storage,this.database.internalStore,this.database.token,this.database.name,this.name,this.database.password,this.database.hashFunction)},Bn(e,[{key:"insert$",get:function(){return this.$.pipe(tt(r=>r.operation==="INSERT"))}},{key:"update$",get:function(){return this.$.pipe(tt(r=>r.operation==="UPDATE"))}},{key:"remove$",get:function(){return this.$.pipe(tt(r=>r.operation==="DELETE"))}},{key:"asRxCollection",get:function(){return this}}])})();function pk(e){if(!up){up=!0;var t=Object.getPrototypeOf(e);$v.forEach(r=>{Rv.map(n=>{var a=n+ny(r);t[a]=function(i,s){return this.addHook(n,r,i,s)}})})}}function mk(e,t){return e.incrementalModify(r=>t)}function gk(e,t,r){var n=e._docCache.getLatestDocumentDataIfExists(t);return n?Promise.resolve({doc:e._docCache.getCachedRxDocuments([n])[0],inserted:!1}):e.findOne(t).exec().then(a=>a?{doc:a,inserted:!1}:e.insert(r).then(i=>({doc:i,inserted:!0})))}function yk({database:e,name:t,schema:r,instanceCreationOptions:n={},migrationStrategies:a={},autoMigrate:i=!0,statics:s={},methods:o={},attachments:c={},options:u={},localDocuments:d=!1,cacheReplacementPolicy:h=pv,conflictHandler:p=Jo}){var y={databaseInstanceToken:e.token,databaseName:e.name,collectionName:t,schema:r.jsonSchema,options:n,multiInstance:e.multiInstance,password:e.password,devMode:rt.isDevMode()};return vr("preCreateRxStorageInstance",y),YS(e,y).then(g=>{var w=new Av(e,t,r,g,n,a,o,c,u,h,s,p);return w.prepare().then(()=>{Object.entries(s).forEach(([x,O])=>{Object.defineProperty(w,x,{get:()=>O.bind(w)})});var b=gr;return i&&w.schema.version!==0&&(b=w.migratePromise()),b}).then(()=>(vr("createRxCollection",{collection:w,creator:{name:t,schema:r,storageInstance:g,instanceCreationOptions:n,migrationStrategies:a,methods:o,attachments:c,options:u,cacheReplacementPolicy:h,localDocuments:d,statics:s}}),w)).catch(b=>g.close().then(()=>Promise.reject(b)))})}var Cv=function(){var t=arguments.length>0&&arguments[0]!==void 0?arguments[0]:1;this._parallels=t||1,this._qC=0,this._iC=new Set,this._lHN=0,this._hPM=new Map,this._pHM=new Map};Cv.prototype={isIdle:function(){return this._qC<this._parallels},lock:function(){this._qC++},unlock:function(){this._qC--,bd(this)},wrapCall:function(t){var r=this;this.lock();var n;try{n=t()}catch(a){throw this.unlock(),a}return!n.then||typeof n.then!="function"?(this.unlock(),n):n.then(function(a){return r.unlock(),a}).catch(function(a){throw r.unlock(),a})},requestIdlePromise:function(t){var r=this;t=t||{};var n,a=new Promise(function(o){return n=o}),i=function(){Au(r,a),n()};if(a._manRes=i,t.timeout){var s=setTimeout(function(){a._manRes()},t.timeout);a._timeoutObj=s}return this._iC.add(a),bd(this),a},cancelIdlePromise:function(t){Au(this,t)},requestIdleCallback:function(t,r){var n=this._lHN++,a=this.requestIdlePromise(r);return this._hPM.set(n,a),this._pHM.set(a,n),a.then(function(){return t()}),n},cancelIdleCallback:function(t){var r=this._hPM.get(t);this.cancelIdlePromise(r)},clear:function(){var t=this;this._iC.forEach(function(r){return Au(t,r)}),this._qC=0,this._iC.clear(),this._hPM=new Map,this._pHM=new Map}};function vk(e){if(e._iC.size!==0){var t=e._iC.values(),r=t.next().value;r._manRes(),setTimeout(function(){return bd(e)},0)}}function Au(e,t){if(t){if(t._timeoutObj&&clearTimeout(t._timeoutObj),e._pHM.has(t)){var r=e._pHM.get(t);e._hPM.delete(r),e._pHM.delete(t)}e._iC.delete(t)}}function bd(e){e._tryIR||e._iC.size===0||(e._tryIR=!0,setTimeout(function(){if(!e.isIdle()){e._tryIR=!1;return}setTimeout(function(){if(!e.isIdle()){e._tryIR=!1;return}vk(e),e._tryIR=!1},0)},0))}class xf{ttl;map=new Map;_to=!1;constructor(t){this.ttl=t}has(t){return this.map.has(t)}add(t){this.map.set(t,Pv()),this._to||(this._to=!0,setTimeout(()=>{this._to=!1,_k(this)},0))}clear(){this.map.clear()}}function _k(e){const t=Pv()-e.ttl,r=e.map[Symbol.iterator]();for(;;){const n=r.next().value;if(!n)return;const a=n[0];if(n[1]<t)e.map.delete(a);else return}}function Pv(){return Date.now()}var Qo=new Set,Sf=(function(){function e(r,n,a,i,s,o,c=!1,u={},d,h,p,y,g){this.idleQueue=new Cv,this.rxdbVersion=oy,this.storageInstances=new Set,this._subs=[],this.startupErrors=[],this.onDestroy=[],this.destroyed=!1,this.collections={},this.states={},this.eventBulks$=new nr,this.observable$=this.eventBulks$.pipe(on(w=>w.events)),this.storageToken=Or,this.storageTokenDocument=Or,this.emittedEventBulkIds=new xf(60*1e3),this.name=r,this.token=n,this.storage=a,this.instanceCreationOptions=i,this.password=s,this.multiInstance=o,this.eventReduce=c,this.options=u,this.internalStore=d,this.hashFunction=h,this.cleanupPolicy=p,this.allowSlowCount=y,this.reactivity=g,this.name!=="pseudoInstance"&&(this.internalStore=wf(this.asRxDatabase,d,Ef),this.storageTokenDocument=ZS(this.asRxDatabase).catch(w=>this.startupErrors.push(w)),this.storageToken=this.storageTokenDocument.then(w=>w.data.token).catch(w=>this.startupErrors.push(w)))}var t=e.prototype;return t.getReactivityFactory=function(){if(!this.reactivity)throw ye("DB14",{database:this.name});return this.reactivity},t.$emit=function(n){this.emittedEventBulkIds.has(n.id)||(this.emittedEventBulkIds.add(n.id),this.eventBulks$.next(n))},t.removeCollectionDoc=async function(n,a){var i=await As(this.internalStore,si(yd(n,a),ua));if(!i)throw ye("SNH",{name:n,schema:a});var s=Cs(i);s._deleted=!0,await this.internalStore.bulkWrite([{document:s,previous:i}],"rx-database-remove-collection")},t.addCollections=async function(n){var a={},i={},s=[],o={};await Promise.all(Object.entries(n).map(async([d,h])=>{var p=d,y=h.schema;a[p]=y;var g=E0(y,this.hashFunction);if(i[p]=g,this.collections[d])throw ye("DB3",{name:d});var w=yd(d,y),b={id:si(w,ua),key:w,context:ua,data:{name:p,schemaHash:await g.hash,schema:g.jsonSchema,version:g.version,connectedStorages:[]},_deleted:!1,_meta:Ea(),_rev:yr(),_attachments:{}};s.push({document:b});var x=Object.assign({},h,{name:p,schema:g,database:this}),O=at(h);O.database=this,O.name=d,vr("preCreateRxCollection",O),x.conflictHandler=O.conflictHandler,o[p]=x}));var c=await this.internalStore.bulkWrite(s,"rx-database-add-collection");await Sk(this),await Promise.all(c.error.map(async d=>{if(d.status!==409)throw ye("DB12",{database:this.name,writeError:d});var h=Ue(d.documentInDb),p=h.data.name,y=i[p];if(h.data.schemaHash!==await y.hash)throw ye("DB6",{database:this.name,collection:p,previousSchemaHash:h.data.schemaHash,schemaHash:await y.hash,previousSchema:h.data.schema,schema:Ue(a[p])})}));var u={};return await Promise.all(Object.keys(n).map(async d=>{var h=o[d],p=await yk(h);u[d]=p,this.collections[d]=p,this[d]||Object.defineProperty(this,d,{get:()=>this.collections[d]})})),u},t.lockedRun=function(n){return this.idleQueue.wrapCall(n)},t.requestIdlePromise=function(){return this.idleQueue.requestIdlePromise()},t.exportJSON=function(n){throw et("json-dump")},t.addState=function(n){throw et("state")},t.importJSON=function(n){throw et("json-dump")},t.backup=function(n){throw et("backup")},t.leaderElector=function(){throw et("leader-election")},t.isLeader=function(){throw et("leader-election")},t.waitForLeadership=function(){throw et("leader-election")},t.migrationStates=function(){throw et("migration-schema")},t.destroy=async function(){return this.destroyed||(this.destroyed=!0,await xs("preDestroyRxDatabase",this),this.eventBulks$.complete(),this._subs.map(n=>n.unsubscribe()),this.name==="pseudoInstance")?Or:this.requestIdlePromise().then(()=>Promise.all(this.onDestroy.map(n=>n()))).then(()=>Promise.all(Object.keys(this.collections).map(n=>this.collections[n]).map(n=>n.destroy()))).then(()=>this.internalStore.close()).then(()=>Qo.delete(this.storage.name+"|"+this.name)).then(()=>!0)},t.remove=function(){return this.destroy().then(()=>Ek(this.name,this.storage,this.password))},Bn(e,[{key:"$",get:function(){return this.observable$}},{key:"asRxDatabase",get:function(){return this}}])})();function wk(e,t){var r=t.name+"|"+e;if(Qo.has(r))throw ye("DB8",{name:e,storage:t.name,link:"https://rxdb.info/rx-database.html#ignoreduplicate"})}async function Nv(e,t,r,n,a,i){var s=await t.createStorageInstance({databaseInstanceToken:e,databaseName:r,collectionName:jS,schema:Ef,options:n,multiInstance:a,password:i,devMode:rt.isDevMode()});return s}function bk({storage:e,instanceCreationOptions:t,name:r,password:n,multiInstance:a=!0,eventReduce:i=!0,ignoreDuplicate:s=!1,options:o={},cleanupPolicy:c,allowSlowCount:u=!1,localDocuments:d=!1,hashFunction:h=ry,reactivity:p}){vr("preCreateRxDatabase",{storage:e,instanceCreationOptions:t,name:r,password:n,multiInstance:a,eventReduce:i,ignoreDuplicate:s,options:o,localDocuments:d}),s||wk(r,e),Qo.add(e.name+"|"+r);var y=bs(10);return Nv(y,e,r,t,a,n).catch(g=>{throw Qo.delete(e.name+"|"+r),g}).then(g=>{var w=new Sf(r,y,e,t,n,a,i,o,g,h,c,u,p);return xs("createRxDatabase",{database:w,creator:{storage:e,instanceCreationOptions:t,name:r,password:n,multiInstance:a,eventReduce:i,ignoreDuplicate:s,options:o,localDocuments:d}}).then(()=>w)})}async function Ek(e,t,r){var n=bs(10),a=await Nv(n,t,e,{},!1,r),i=await kv(a),s=new Set;i.forEach(c=>s.add(c.data.name));var o=Array.from(s);return await Promise.all(o.map(c=>Ov(t,a,n,e,c,r))),await xs("postRemoveRxDatabase",{databaseName:e,storage:t}),await a.remove(),o}function xk(e){return e instanceof Sf}async function Sk(e){if(await e.storageToken,e.startupErrors[0])throw e.startupErrors[0]}var kk={RxSchema:fy.prototype,RxDocument:Sc,RxQuery:yv.prototype,RxCollection:Av.prototype,RxDatabase:Sf.prototype},Cu=new Set,lp=new Set;function kc(e){if(vr("preAddRxPlugin",{plugin:e,plugins:Cu}),!Cu.has(e)){{if(lp.has(e.name))throw ye("PL3",{name:e.name,plugin:e});Cu.add(e),lp.add(e.name)}if(!e.rxdb)throw tr("PL1",{plugin:e});e.init&&e.init(),e.prototypes&&Object.entries(e.prototypes).forEach(([t,r])=>r(kk[t])),e.overwritable&&Object.assign(rt,e.overwritable),e.hooks&&Object.entries(e.hooks).forEach(([t,r])=>{r.after&&rs[t].push(r.after),r.before&&rs[t].unshift(r.before)})}}function Ik(e){return e&&typeof e.then=="function"}Promise.resolve(!1);var Ok=Promise.resolve(!0),tn=Promise.resolve();function aa(e,t){return e||(e=0),new Promise(function(r){return setTimeout(function(){return r(t)},e)})}function Tk(e,t){return Math.floor(Math.random()*(t-e+1)+e)}function Ps(){return Math.random().toString(36).substring(2)}var Pu=0;function Ns(){var e=Date.now()*1e3;return e<=Pu&&(e=Pu+1),Pu=e,e}function Rk(){return typeof navigator<"u"&&typeof navigator.locks<"u"&&typeof navigator.locks.request=="function"}var $k=Ns,Ak="native";function Ck(e){var t={time:Ns(),messagesCallback:null,bc:new BroadcastChannel(e),subFns:[]};return t.bc.onmessage=function(r){t.messagesCallback&&t.messagesCallback(r.data)},t}function Pk(e){e.bc.close(),e.subFns=[]}function Nk(e,t){try{return e.bc.postMessage(t,!1),tn}catch(r){return Promise.reject(r)}}function Dk(e,t){e.messagesCallback=t}function Lk(){if(typeof globalThis<"u"&&globalThis.Deno&&globalThis.Deno.args)return!0;if((typeof window<"u"||typeof self<"u")&&typeof BroadcastChannel=="function"){if(BroadcastChannel._pubkey)throw new Error("BroadcastChannel: Do not overwrite window.BroadcastChannel with this module, this is not a polyfill");return!0}else return!1}function Mk(){return 150}var jk={create:Ck,close:Pk,onMessage:Dk,postMessage:Nk,canBeUsed:Lk,type:Ak,averageResponseTime:Mk,microSeconds:$k};function kf(){var e=arguments.length>0&&arguments[0]!==void 0?arguments[0]:{},t=JSON.parse(JSON.stringify(e));return typeof t.webWorkerSupport>"u"&&(t.webWorkerSupport=!0),t.idb||(t.idb={}),t.idb.ttl||(t.idb.ttl=1e3*45),t.idb.fallbackInterval||(t.idb.fallbackInterval=150),e.idb&&typeof e.idb.onclose=="function"&&(t.idb.onclose=e.idb.onclose),t.localstorage||(t.localstorage={}),t.localstorage.removeTimeout||(t.localstorage.removeTimeout=1e3*60),e.methods&&(t.methods=e.methods),t.node||(t.node={}),t.node.ttl||(t.node.ttl=1e3*60*2),t.node.maxParallelWrites||(t.node.maxParallelWrites=2048),typeof t.node.useFastPath>"u"&&(t.node.useFastPath=!0),t}var Fk=Ns,Bk="pubkey.broadcast-channel-0-",dn="messages",Ic={durability:"relaxed"},Uk="idb";function Dv(){if(typeof indexedDB<"u")return indexedDB;if(typeof window<"u"){if(typeof window.mozIndexedDB<"u")return window.mozIndexedDB;if(typeof window.webkitIndexedDB<"u")return window.webkitIndexedDB;if(typeof window.msIndexedDB<"u")return window.msIndexedDB}return!1}function If(e){e.commit&&e.commit()}function zk(e){var t=Dv(),r=Bk+e,n=t.open(r);return n.onupgradeneeded=function(a){var i=a.target.result;i.createObjectStore(dn,{keyPath:"id",autoIncrement:!0})},new Promise(function(a,i){n.onerror=function(s){return i(s)},n.onsuccess=function(){a(n.result)}})}function qk(e,t,r){var n=Date.now(),a={uuid:t,time:n,data:r},i=e.transaction([dn],"readwrite",Ic);return new Promise(function(s,o){i.oncomplete=function(){return s()},i.onerror=function(u){return o(u)};var c=i.objectStore(dn);c.add(a),If(i)})}function Hk(e,t){var r=e.transaction(dn,"readonly",Ic),n=r.objectStore(dn),a=[],i=IDBKeyRange.bound(t+1,1/0);if(n.getAll){var s=n.getAll(i);return new Promise(function(c,u){s.onerror=function(d){return u(d)},s.onsuccess=function(d){c(d.target.result)}})}function o(){try{return i=IDBKeyRange.bound(t+1,1/0),n.openCursor(i)}catch{return n.openCursor()}}return new Promise(function(c,u){var d=o();d.onerror=function(h){return u(h)},d.onsuccess=function(h){var p=h.target.result;p?p.value.id<t+1?p.continue(t+1):(a.push(p.value),p.continue()):(If(r),c(a))}})}function Kk(e,t){if(e.closed)return Promise.resolve([]);var r=e.db.transaction(dn,"readwrite",Ic),n=r.objectStore(dn);return Promise.all(t.map(function(a){var i=n.delete(a);return new Promise(function(s){i.onsuccess=function(){return s()}})}))}function Gk(e,t){var r=Date.now()-t,n=e.transaction(dn,"readonly",Ic),a=n.objectStore(dn),i=[];return new Promise(function(s){a.openCursor().onsuccess=function(o){var c=o.target.result;if(c){var u=c.value;u.time<r?(i.push(u),c.continue()):(If(n),s(i))}else s(i)}})}function Wk(e){return Gk(e.db,e.options.idb.ttl).then(function(t){return Kk(e,t.map(function(r){return r.id}))})}function Vk(e,t){return t=kf(t),zk(e).then(function(r){var n={closed:!1,lastCursorId:0,channelName:e,options:t,uuid:Ps(),eMIs:new xf(t.idb.ttl*2),writeBlockPromise:tn,messagesCallback:null,readQueuePromises:[],db:r};return r.onclose=function(){n.closed=!0,t.idb.onclose&&t.idb.onclose()},Lv(n),n})}function Lv(e){e.closed||Mv(e).then(function(){return aa(e.options.idb.fallbackInterval)}).then(function(){return Lv(e)})}function Zk(e,t){return!(e.uuid===t.uuid||t.eMIs.has(e.id)||e.data.time<t.messagesCallbackTime)}function Mv(e){return e.closed||!e.messagesCallback?tn:Hk(e.db,e.lastCursorId).then(function(t){var r=t.filter(function(n){return!!n}).map(function(n){return n.id>e.lastCursorId&&(e.lastCursorId=n.id),n}).filter(function(n){return Zk(n,e)}).sort(function(n,a){return n.time-a.time});return r.forEach(function(n){e.messagesCallback&&(e.eMIs.add(n.id),e.messagesCallback(n.data))}),tn})}function Jk(e){e.closed=!0,e.db.close()}function Qk(e,t){return e.writeBlockPromise=e.writeBlockPromise.then(function(){return qk(e.db,e.uuid,t)}).then(function(){Tk(0,10)===0&&Wk(e)}),e.writeBlockPromise}function Yk(e,t,r){e.messagesCallbackTime=r,e.messagesCallback=t,Mv(e)}function Xk(){return!!Dv()}function eI(e){return e.idb.fallbackInterval*2}var tI={create:Vk,close:Jk,onMessage:Yk,postMessage:Qk,canBeUsed:Xk,type:Uk,averageResponseTime:eI,microSeconds:Fk},rI=Ns,nI="pubkey.broadcastChannel-",aI="localstorage";function jv(){var e;if(typeof window>"u")return null;try{e=window.localStorage,e=window["ie8-eventlistener/storage"]||window.localStorage}catch{}return e}function Fv(e){return nI+e}function iI(e,t){return new Promise(function(r){aa().then(function(){var n=Fv(e.channelName),a={token:Ps(),time:Date.now(),data:t,uuid:e.uuid},i=JSON.stringify(a);jv().setItem(n,i);var s=document.createEvent("Event");s.initEvent("storage",!0,!0),s.key=n,s.newValue=i,window.dispatchEvent(s),r()})})}function sI(e,t){var r=Fv(e),n=function(i){i.key===r&&t(JSON.parse(i.newValue))};return window.addEventListener("storage",n),n}function oI(e){window.removeEventListener("storage",e)}function cI(e,t){if(t=kf(t),!Bv())throw new Error("BroadcastChannel: localstorage cannot be used");var r=Ps(),n=new xf(t.localstorage.removeTimeout),a={channelName:e,uuid:r,eMIs:n};return a.listener=sI(e,function(i){a.messagesCallback&&i.uuid!==r&&(!i.token||n.has(i.token)||i.data.time&&i.data.time<a.messagesCallbackTime||(n.add(i.token),a.messagesCallback(i.data)))}),a}function uI(e){oI(e.listener)}function lI(e,t,r){e.messagesCallbackTime=r,e.messagesCallback=t}function Bv(){var e=jv();if(!e)return!1;try{var t="__broadcastchannel_check";e.setItem(t,"works"),e.removeItem(t)}catch{return!1}return!0}function dI(){var e=120,t=navigator.userAgent.toLowerCase();return t.includes("safari")&&!t.includes("chrome")?e*2:e}var fI={create:cI,close:uI,onMessage:lI,postMessage:iI,canBeUsed:Bv,type:aI,averageResponseTime:dI,microSeconds:rI},Uv=Ns,hI="simulate",Of=new Set;function pI(e){var t={time:Uv(),name:e,messagesCallback:null};return Of.add(t),t}function mI(e){Of.delete(e)}var zv=5;function gI(e,t){return new Promise(function(r){return setTimeout(function(){var n=Array.from(Of);n.forEach(function(a){a.name===e.name&&a!==e&&a.messagesCallback&&a.time<t.time&&a.messagesCallback(t)}),r()},zv)})}function yI(e,t){e.messagesCallback=t}function vI(){return!0}function _I(){return zv}var wI={create:pI,close:mI,onMessage:yI,postMessage:gI,canBeUsed:vI,type:hI,averageResponseTime:_I,microSeconds:Uv},dp=[jk,tI,fI];function bI(e){var t=[].concat(e.methods,dp).filter(Boolean);if(e.type){if(e.type==="simulate")return wI;var r=t.find(function(a){return a.type===e.type});if(r)return r;throw new Error("method-type "+e.type+" not found")}e.webWorkerSupport||(t=t.filter(function(a){return a.type!=="idb"}));var n=t.find(function(a){return a.canBeUsed()});if(n)return n;throw new Error("No usable method found in "+JSON.stringify(dp.map(function(a){return a.type})))}var qv=new Set,EI=0,Oc=function(t,r){this.id=EI++,qv.add(this),this.name=t,this.options=kf(r),this.method=bI(this.options),this._iL=!1,this._onML=null,this._addEL={message:[],internal:[]},this._uMP=new Set,this._befC=[],this._prepP=null,xI(this)};Oc._pubkey=!0;Oc.prototype={postMessage:function(t){if(this.closed)throw new Error("BroadcastChannel.postMessage(): Cannot post message after channel has closed "+JSON.stringify(t));return fp(this,"message",t)},postInternal:function(t){return fp(this,"internal",t)},set onmessage(e){var t=this.method.microSeconds(),r={time:t,fn:e};pp(this,"message",this._onML),e&&typeof e=="function"?(this._onML=r,hp(this,"message",r)):this._onML=null},addEventListener:function(t,r){var n=this.method.microSeconds(),a={time:n,fn:r};hp(this,t,a)},removeEventListener:function(t,r){var n=this._addEL[t].find(function(a){return a.fn===r});pp(this,t,n)},close:function(){var t=this;if(!this.closed){qv.delete(this),this.closed=!0;var r=this._prepP?this._prepP:tn;return this._onML=null,this._addEL.message=[],r.then(function(){return Promise.all(Array.from(t._uMP))}).then(function(){return Promise.all(t._befC.map(function(n){return n()}))}).then(function(){return t.method.close(t._state)})}},get type(){return this.method.type},get isClosed(){return this.closed}};function fp(e,t,r){var n=e.method.microSeconds(),a={time:n,type:t,data:r},i=e._prepP?e._prepP:tn;return i.then(function(){var s=e.method.postMessage(e._state,a);return e._uMP.add(s),s.catch().then(function(){return e._uMP.delete(s)}),s})}function xI(e){var t=e.method.create(e.name,e.options);Ik(t)?(e._prepP=t,t.then(function(r){e._state=r})):e._state=t}function Hv(e){return e._addEL.message.length>0||e._addEL.internal.length>0}function hp(e,t,r){e._addEL[t].push(r),SI(e)}function pp(e,t,r){e._addEL[t]=e._addEL[t].filter(function(n){return n!==r}),kI(e)}function SI(e){if(!e._iL&&Hv(e)){var t=function(a){e._addEL[a.type].forEach(function(i){a.time>=i.time&&i.fn(a.data)})},r=e.method.microSeconds();e._prepP?e._prepP.then(function(){e._iL=!0,e.method.onMessage(e._state,t,r)}):(e._iL=!0,e.method.onMessage(e._state,t,r))}}function kI(e){if(e._iL&&!Hv(e)){e._iL=!1;var t=e.method.microSeconds();e.method.onMessage(e._state,null,t)}}function II(e){if(typeof WorkerGlobalScope=="function"&&self instanceof WorkerGlobalScope){var t=self.close.bind(self);self.close=function(){return e(),t()}}else{if(typeof window.addEventListener!="function")return;window.addEventListener("beforeunload",function(){e()},!0),window.addEventListener("unload",function(){e()},!0)}}function OI(e){process.on("exit",function(){return e()}),process.on("beforeExit",function(){return e().then(function(){return process.exit()})}),process.on("SIGINT",function(){return e().then(function(){return process.exit()})}),process.on("uncaughtException",function(t){return e().then(function(){console.trace(t),process.exit(101)})})}var TI=Object.prototype.toString.call(typeof process<"u"?process:0)==="[object process]",RI=TI?OI:II,Wi=new Set,mp=!1;function $I(){mp||(mp=!0,RI(CI))}function AI(e){if($I(),typeof e!="function")throw new Error("Listener is no function");Wi.add(e);var t={remove:function(){return Wi.delete(e)},run:function(){return Wi.delete(e),e()}};return t}function CI(){var e=[];return Wi.forEach(function(t){e.push(t()),Wi.delete(t)}),Promise.all(e)}function la(e,t){var r={context:"leader",action:t,token:e.token};return e.broadcastChannel.postInternal(r)}function Kv(e){e.isLeader=!0,e._hasLeader=!0;var t=AI(function(){return e.die()});e._unl.push(t);var r=function(a){a.context==="leader"&&a.action==="apply"&&la(e,"tell"),a.context==="leader"&&a.action==="tell"&&!e._dpLC&&(e._dpLC=!0,e._dpL(),la(e,"tell"))};return e.broadcastChannel.addEventListener("internal",r),e._lstns.push(r),la(e,"tell")}var Gv=function(t,r){var n=this;this.broadcastChannel=t,t._befC.push(function(){return n.die()}),this._options=r,this.isLeader=!1,this.isDead=!1,this.token=Ps(),this._lstns=[],this._unl=[],this._dpL=function(){},this._dpLC=!1,this._wKMC={},this.lN="pubkey-bc||"+t.method.type+"||"+t.name};Gv.prototype={hasLeader:function(){var t=this;return navigator.locks.query().then(function(r){var n=r.held?r.held.filter(function(a){return a.name===t.lN}):[];return!!(n&&n.length>0)})},awaitLeadership:function(){var t=this;if(!this._wLMP){this._wKMC.c=new AbortController;var r=new Promise(function(n,a){t._wKMC.res=n,t._wKMC.rej=a});this._wLMP=new Promise(function(n){navigator.locks.request(t.lN,{signal:t._wKMC.c.signal},function(){return t._wKMC.c=void 0,Kv(t),n(),r}).catch(function(){})})}return this._wLMP},set onduplicate(e){},die:function(){var t=this;return this._lstns.forEach(function(r){return t.broadcastChannel.removeEventListener("internal",r)}),this._lstns=[],this._unl.forEach(function(r){return r.remove()}),this._unl=[],this.isLeader&&(this.isLeader=!1),this.isDead=!0,this._wKMC.res&&this._wKMC.res(),this._wKMC.c&&this._wKMC.c.abort("LeaderElectionWebLock.die() called"),la(this,"death")}};var Wv=function(t,r){var n=this;this.broadcastChannel=t,this._options=r,this.isLeader=!1,this._hasLeader=!1,this.isDead=!1,this.token=Ps(),this._aplQ=tn,this._aplQC=0,this._unl=[],this._lstns=[],this._dpL=function(){},this._dpLC=!1;var a=function(s){s.context==="leader"&&(s.action==="death"&&(n._hasLeader=!1),s.action==="tell"&&(n._hasLeader=!0))};this.broadcastChannel.addEventListener("internal",a),this._lstns.push(a)};Wv.prototype={hasLeader:function(){return Promise.resolve(this._hasLeader)},applyOnce:function(t){var r=this;if(this.isLeader)return aa(0,!0);if(this.isDead)return aa(0,!1);if(this._aplQC>1)return this._aplQ;var n=function(){if(r.isLeader)return Ok;var i=!1,s,o=new Promise(function(d){s=function(){i=!0,d()}}),c=function(h){h.context==="leader"&&h.token!=r.token&&(h.action==="apply"&&h.token>r.token&&s(),h.action==="tell"&&(s(),r._hasLeader=!0))};r.broadcastChannel.addEventListener("internal",c);var u=t?r._options.responseTime*4:r._options.responseTime;return la(r,"apply").then(function(){return Promise.race([aa(u),o.then(function(){return Promise.reject(new Error)})])}).then(function(){return la(r,"apply")}).then(function(){return Promise.race([aa(u),o.then(function(){return Promise.reject(new Error)})])}).catch(function(){}).then(function(){return r.broadcastChannel.removeEventListener("internal",c),i?!1:Kv(r).then(function(){return!0})})};return this._aplQC=this._aplQC+1,this._aplQ=this._aplQ.then(function(){return n()}).then(function(){r._aplQC=r._aplQC-1}),this._aplQ.then(function(){return r.isLeader})},awaitLeadership:function(){return this._aLP||(this._aLP=PI(this)),this._aLP},set onduplicate(e){this._dpL=e},die:function(){var t=this;return this._lstns.forEach(function(r){return t.broadcastChannel.removeEventListener("internal",r)}),this._lstns=[],this._unl.forEach(function(r){return r.remove()}),this._unl=[],this.isLeader&&(this._hasLeader=!1,this.isLeader=!1),this.isDead=!0,la(this,"death")}};function PI(e){return e.isLeader?tn:new Promise(function(t){var r=!1;function n(){r||(r=!0,e.broadcastChannel.removeEventListener("internal",i),t(!0))}e.applyOnce().then(function(){e.isLeader&&n()});var a=function s(){return aa(e._options.fallbackInterval).then(function(){if(!(e.isDead||r))if(e.isLeader)n();else return e.applyOnce(!0).then(function(){e.isLeader?n():s()})})};a();var i=function(o){o.context==="leader"&&o.action==="death"&&(e._hasLeader=!1,e.applyOnce().then(function(){e.isLeader&&n()}))};e.broadcastChannel.addEventListener("internal",i),e._lstns.push(i)})}function NI(e,t){return e||(e={}),e=JSON.parse(JSON.stringify(e)),e.fallbackInterval||(e.fallbackInterval=3e3),e.responseTime||(e.responseTime=t.method.averageResponseTime(t.options)),e}function DI(e,t){if(e._leaderElector)throw new Error("BroadcastChannel already has a leader-elector");t=NI(t,e);var r=Rk()?new Gv(e,t):new Wv(e,t);return e._befC.push(function(){return r.die()}),e._leaderElector=r,r}var Yo=new Map;function LI(e,t,r,n){var a=Yo.get(t);return a||(a={bc:new Oc(["RxDB:",e,r].join("|")),refs:new Set},Yo.set(t,a)),a.refs.add(n),a.bc}function gp(e,t){var r=Yo.get(e);if(r&&(r.refs.delete(t),r.refs.size===0))return Yo.delete(e),r.bc.close()}function MI(e,t,r,n){if(t.multiInstance){var a=LI(e,t.databaseInstanceToken,r.databaseName,r),i=new nr,s=p=>{p.storageName===e&&p.databaseName===t.databaseName&&p.collectionName===t.collectionName&&p.version===t.schema.version&&i.next(p.eventBulk)};a.addEventListener("message",s);var o=r.changeStream(),c=!1,u=o.subscribe(p=>{c||a.postMessage({storageName:e,databaseName:t.databaseName,collectionName:t.collectionName,version:t.schema.version,eventBulk:p})});r.changeStream=function(){return i.asObservable().pipe(gE(o))};var d=r.close.bind(r);r.close=async function(){return c=!0,u.unsubscribe(),a.removeEventListener("message",s),await gp(t.databaseInstanceToken,r),d()};var h=r.remove.bind(r);r.remove=async function(){return c=!0,u.unsubscribe(),a.removeEventListener("message",s),await gp(t.databaseInstanceToken,r),h()}}}var Do={exports:{}},jI=Do.exports,yp;function FI(){return yp||(yp=1,(function(e,t){(function(r,n){e.exports=n()})(jI,function(){var r=function(l,f){return(r=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(m,v){m.__proto__=v}||function(m,v){for(var _ in v)Object.prototype.hasOwnProperty.call(v,_)&&(m[_]=v[_])})(l,f)},n=function(){return(n=Object.assign||function(l){for(var f,m=1,v=arguments.length;m<v;m++)for(var _ in f=arguments[m])Object.prototype.hasOwnProperty.call(f,_)&&(l[_]=f[_]);return l}).apply(this,arguments)};function a(l,f,m){for(var v,_=0,E=f.length;_<E;_++)!v&&_ in f||((v=v||Array.prototype.slice.call(f,0,_))[_]=f[_]);return l.concat(v||Array.prototype.slice.call(f))}var i=typeof globalThis<"u"?globalThis:typeof self<"u"?self:typeof window<"u"?window:sb,s=Object.keys,o=Array.isArray;function c(l,f){return typeof f!="object"||s(f).forEach(function(m){l[m]=f[m]}),l}typeof Promise>"u"||i.Promise||(i.Promise=Promise);var u=Object.getPrototypeOf,d={}.hasOwnProperty;function h(l,f){return d.call(l,f)}function p(l,f){typeof f=="function"&&(f=f(u(l))),(typeof Reflect>"u"?s:Reflect.ownKeys)(f).forEach(function(m){g(l,m,f[m])})}var y=Object.defineProperty;function g(l,f,m,v){y(l,f,c(m&&h(m,"get")&&typeof m.get=="function"?{get:m.get,set:m.set,configurable:!0}:{value:m,configurable:!0,writable:!0},v))}function w(l){return{from:function(f){return l.prototype=Object.create(f.prototype),g(l.prototype,"constructor",l),{extend:p.bind(null,l.prototype)}}}}var b=Object.getOwnPropertyDescriptor,x=[].slice;function O(l,f,m){return x.call(l,f,m)}function T(l,f){return f(l)}function B(l){if(!l)throw new Error("Assertion Failed")}function U(l){i.setImmediate?setImmediate(l):setTimeout(l,0)}function K(l,f){if(typeof f=="string"&&h(l,f))return l[f];if(!f)return l;if(typeof f!="string"){for(var m=[],v=0,_=f.length;v<_;++v){var E=K(l,f[v]);m.push(E)}return m}var S=f.indexOf(".");if(S!==-1){var k=l[f.substr(0,S)];return k==null?void 0:K(k,f.substr(S+1))}}function q(l,f,m){if(l&&f!==void 0&&!("isFrozen"in Object&&Object.isFrozen(l)))if(typeof f!="string"&&"length"in f){B(typeof m!="string"&&"length"in m);for(var v=0,_=f.length;v<_;++v)q(l,f[v],m[v])}else{var E,S,k=f.indexOf(".");k!==-1?(E=f.substr(0,k),(S=f.substr(k+1))===""?m===void 0?o(l)&&!isNaN(parseInt(E))?l.splice(E,1):delete l[E]:l[E]=m:q(k=!(k=l[E])||!h(l,E)?l[E]={}:k,S,m)):m===void 0?o(l)&&!isNaN(parseInt(f))?l.splice(f,1):delete l[f]:l[f]=m}}function G(l){var f,m={};for(f in l)h(l,f)&&(m[f]=l[f]);return m}var Oe=[].concat;function Me(l){return Oe.apply([],l)}var Vr="BigUint64Array,BigInt64Array,Array,Boolean,String,Date,RegExp,Blob,File,FileList,FileSystemFileHandle,FileSystemDirectoryHandle,ArrayBuffer,DataView,Uint8ClampedArray,ImageBitmap,ImageData,Map,Set,CryptoKey".split(",").concat(Me([8,16,32,64].map(function(l){return["Int","Uint","Float"].map(function(f){return f+l+"Array"})}))).filter(function(l){return i[l]}),qe=new Set(Vr.map(function(l){return i[l]})),Ae=null;function Ve(l){return Ae=new WeakMap,l=(function f(m){if(!m||typeof m!="object")return m;var v=Ae.get(m);if(v)return v;if(o(m)){v=[],Ae.set(m,v);for(var _=0,E=m.length;_<E;++_)v.push(f(m[_]))}else if(qe.has(m.constructor))v=m;else{var S,k=u(m);for(S in v=k===Object.prototype?{}:Object.create(k),Ae.set(m,v),m)h(m,S)&&(v[S]=f(m[S]))}return v})(l),Ae=null,l}var Y={}.toString;function H(l){return Y.call(l).slice(8,-1)}var fe=typeof Symbol<"u"?Symbol.iterator:"@@iterator",J=typeof fe=="symbol"?function(l){var f;return l!=null&&(f=l[fe])&&f.apply(l)}:function(){return null};function te(l,f){return f=l.indexOf(f),0<=f&&l.splice(f,1),0<=f}var Q={};function re(l){var f,m,v,_;if(arguments.length===1){if(o(l))return l.slice();if(this===Q&&typeof l=="string")return[l];if(_=J(l)){for(m=[];!(v=_.next()).done;)m.push(v.value);return m}if(l==null)return[l];if(typeof(f=l.length)!="number")return[l];for(m=new Array(f);f--;)m[f]=l[f];return m}for(f=arguments.length,m=new Array(f);f--;)m[f]=arguments[f];return m}var xe=typeof Symbol<"u"?function(l){return l[Symbol.toStringTag]==="AsyncFunction"}:function(){return!1},ue=["Unknown","Constraint","Data","TransactionInactive","ReadOnly","Version","NotFound","InvalidState","InvalidAccess","Abort","Timeout","QuotaExceeded","Syntax","DataClone"],hr=["Modify","Bulk","OpenFailed","VersionChange","Schema","Upgrade","InvalidTable","MissingAPI","NoSuchDatabase","InvalidArgument","SubTransaction","Unsupported","Internal","DatabaseClosed","PrematureCommit","ForeignAwait"].concat(ue),Re={VersionChanged:"Database version changed by other database connection",DatabaseClosed:"Database has been closed",Abort:"Transaction aborted",TransactionInactive:"Transaction has already completed or failed",MissingAPI:"IndexedDB API missing. Please visit https://tinyurl.com/y2uuvskb"};function Te(l,f){this.name=l,this.message=f}function Ge(l,f){return l+". Errors: "+Object.keys(f).map(function(m){return f[m].toString()}).filter(function(m,v,_){return _.indexOf(m)===v}).join(`
`)}function je(l,f,m,v){this.failures=f,this.failedKeys=v,this.successCount=m,this.message=Ge(l,f)}function _t(l,f){this.name="BulkError",this.failures=Object.keys(f).map(function(m){return f[m]}),this.failuresByPos=f,this.message=Ge(l,this.failures)}w(Te).from(Error).extend({toString:function(){return this.name+": "+this.message}}),w(je).from(Te),w(_t).from(Te);var zn=hr.reduce(function(l,f){return l[f]=f+"Error",l},{}),wi=Te,we=hr.reduce(function(l,f){var m=f+"Error";function v(_,E){this.name=m,_?typeof _=="string"?(this.message="".concat(_).concat(E?`
 `+E:""),this.inner=E||null):typeof _=="object"&&(this.message="".concat(_.name," ").concat(_.message),this.inner=_):(this.message=Re[f]||m,this.inner=null)}return w(v).from(wi),l[f]=v,l},{});we.Syntax=SyntaxError,we.Type=TypeError,we.Range=RangeError;var Pr=ue.reduce(function(l,f){return l[f+"Error"]=we[f],l},{}),dr=hr.reduce(function(l,f){return["Syntax","Type","Range"].indexOf(f)===-1&&(l[f+"Error"]=we[f]),l},{});function Ke(){}function br(l){return l}function Ra(l,f){return l==null||l===br?f:function(m){return f(l(m))}}function fr(l,f){return function(){l.apply(this,arguments),f.apply(this,arguments)}}function $a(l,f){return l===Ke?f:function(){var m=l.apply(this,arguments);m!==void 0&&(arguments[0]=m);var v=this.onsuccess,_=this.onerror;this.onsuccess=null,this.onerror=null;var E=f.apply(this,arguments);return v&&(this.onsuccess=this.onsuccess?fr(v,this.onsuccess):v),_&&(this.onerror=this.onerror?fr(_,this.onerror):_),E!==void 0?E:m}}function js(l,f){return l===Ke?f:function(){l.apply(this,arguments);var m=this.onsuccess,v=this.onerror;this.onsuccess=this.onerror=null,f.apply(this,arguments),m&&(this.onsuccess=this.onsuccess?fr(m,this.onsuccess):m),v&&(this.onerror=this.onerror?fr(v,this.onerror):v)}}function Aa(l,f){return l===Ke?f:function(m){var v=l.apply(this,arguments);c(m,v);var _=this.onsuccess,E=this.onerror;return this.onsuccess=null,this.onerror=null,m=f.apply(this,arguments),_&&(this.onsuccess=this.onsuccess?fr(_,this.onsuccess):_),E&&(this.onerror=this.onerror?fr(E,this.onerror):E),v===void 0?m===void 0?void 0:m:c(v,m)}}function jc(l,f){return l===Ke?f:function(){return f.apply(this,arguments)!==!1&&l.apply(this,arguments)}}function ce(l,f){return l===Ke?f:function(){var m=l.apply(this,arguments);if(m&&typeof m.then=="function"){for(var v=this,_=arguments.length,E=new Array(_);_--;)E[_]=arguments[_];return m.then(function(){return f.apply(v,E)})}return f.apply(this,arguments)}}dr.ModifyError=je,dr.DexieError=Te,dr.BulkError=_t;var Lt=typeof location<"u"&&/^(http|https):\/\/(localhost|127\.0\.0\.1)/.test(location.href);function ke(l){Lt=l}var me={},$e=100,Vr=typeof Promise>"u"?[]:(function(){var l=Promise.resolve();if(typeof crypto>"u"||!crypto.subtle)return[l,u(l),l];var f=crypto.subtle.digest("SHA-512",new Uint8Array([0]));return[f,u(f),l]})(),ue=Vr[0],hr=Vr[1],Vr=Vr[2],hr=hr&&hr.then,ae=ue&&ue.constructor,Ie=!!Vr,Se=function(l,f){bi.push([l,f]),qn&&(queueMicrotask(Lw),qn=!1)},xt=!0,qn=!0,Nr=[],Fs=[],Fc=br,gn={id:"global",global:!0,ref:0,unhandleds:[],onunhandled:Ke,pgp:!1,env:{},finalize:Ke},ve=gn,bi=[],Hn=0,Bs=[];function oe(l){if(typeof this!="object")throw new TypeError("Promises must be constructed via new");this._listeners=[],this._lib=!1;var f=this._PSD=ve;if(typeof l!="function"){if(l!==me)throw new TypeError("Not a function");return this._state=arguments[1],this._value=arguments[2],void(this._state===!1&&Uc(this,this._value))}this._state=null,this._value=null,++f.ref,(function m(v,_){try{_(function(E){if(v._state===null){if(E===v)throw new TypeError("A promise cannot be resolved with itself.");var S=v._lib&&Ca();E&&typeof E.then=="function"?m(v,function(k,R){E instanceof oe?E._then(k,R):E.then(k,R)}):(v._state=!0,v._value=E,th(v)),S&&Pa()}},Uc.bind(null,v))}catch(E){Uc(v,E)}})(this,l)}var Bc={get:function(){var l=ve,f=Hs;function m(v,_){var E=this,S=!l.global&&(l!==ve||f!==Hs),k=S&&!vn(),R=new oe(function(A,N){zc(E,new eh(nh(v,l,S,k),nh(_,l,S,k),A,N,l))});return this._consoleTask&&(R._consoleTask=this._consoleTask),R}return m.prototype=me,m},set:function(l){g(this,"then",l&&l.prototype===me?Bc:{get:function(){return l},set:Bc.set})}};function eh(l,f,m,v,_){this.onFulfilled=typeof l=="function"?l:null,this.onRejected=typeof f=="function"?f:null,this.resolve=m,this.reject=v,this.psd=_}function Uc(l,f){var m,v;Fs.push(f),l._state===null&&(m=l._lib&&Ca(),f=Fc(f),l._state=!1,l._value=f,v=l,Nr.some(function(_){return _._value===v._value})||Nr.push(v),th(l),m&&Pa())}function th(l){var f=l._listeners;l._listeners=[];for(var m=0,v=f.length;m<v;++m)zc(l,f[m]);var _=l._PSD;--_.ref||_.finalize(),Hn===0&&(++Hn,Se(function(){--Hn==0&&qc()},[]))}function zc(l,f){if(l._state!==null){var m=l._state?f.onFulfilled:f.onRejected;if(m===null)return(l._state?f.resolve:f.reject)(l._value);++f.psd.ref,++Hn,Se(Dw,[m,l,f])}else l._listeners.push(f)}function Dw(l,f,m){try{var v,_=f._value;!f._state&&Fs.length&&(Fs=[]),v=Lt&&f._consoleTask?f._consoleTask.run(function(){return l(_)}):l(_),f._state||Fs.indexOf(_)!==-1||(function(E){for(var S=Nr.length;S;)if(Nr[--S]._value===E._value)return Nr.splice(S,1)})(f),m.resolve(v)}catch(E){m.reject(E)}finally{--Hn==0&&qc(),--m.psd.ref||m.psd.finalize()}}function Lw(){Kn(gn,function(){Ca()&&Pa()})}function Ca(){var l=xt;return qn=xt=!1,l}function Pa(){var l,f,m;do for(;0<bi.length;)for(l=bi,bi=[],m=l.length,f=0;f<m;++f){var v=l[f];v[0].apply(null,v[1])}while(0<bi.length);qn=xt=!0}function qc(){var l=Nr;Nr=[],l.forEach(function(v){v._PSD.onunhandled.call(null,v._value,v)});for(var f=Bs.slice(0),m=f.length;m;)f[--m]()}function Us(l){return new oe(me,!1,l)}function it(l,f){var m=ve;return function(){var v=Ca(),_=ve;try{return _n(m,!0),l.apply(this,arguments)}catch(E){f&&f(E)}finally{_n(_,!1),v&&Pa()}}}p(oe.prototype,{then:Bc,_then:function(l,f){zc(this,new eh(null,null,l,f,ve))},catch:function(l){if(arguments.length===1)return this.then(null,l);var f=l,m=arguments[1];return typeof f=="function"?this.then(null,function(v){return(v instanceof f?m:Us)(v)}):this.then(null,function(v){return(v&&v.name===f?m:Us)(v)})},finally:function(l){return this.then(function(f){return oe.resolve(l()).then(function(){return f})},function(f){return oe.resolve(l()).then(function(){return Us(f)})})},timeout:function(l,f){var m=this;return l<1/0?new oe(function(v,_){var E=setTimeout(function(){return _(new we.Timeout(f))},l);m.then(v,_).finally(clearTimeout.bind(null,E))}):this}}),typeof Symbol<"u"&&Symbol.toStringTag&&g(oe.prototype,Symbol.toStringTag,"Dexie.Promise"),gn.env=rh(),p(oe,{all:function(){var l=re.apply(null,arguments).map(Ks);return new oe(function(f,m){l.length===0&&f([]);var v=l.length;l.forEach(function(_,E){return oe.resolve(_).then(function(S){l[E]=S,--v||f(l)},m)})})},resolve:function(l){return l instanceof oe?l:l&&typeof l.then=="function"?new oe(function(f,m){l.then(f,m)}):new oe(me,!0,l)},reject:Us,race:function(){var l=re.apply(null,arguments).map(Ks);return new oe(function(f,m){l.map(function(v){return oe.resolve(v).then(f,m)})})},PSD:{get:function(){return ve},set:function(l){return ve=l}},totalEchoes:{get:function(){return Hs}},newPSD:yn,usePSD:Kn,scheduler:{get:function(){return Se},set:function(l){Se=l}},rejectionMapper:{get:function(){return Fc},set:function(l){Fc=l}},follow:function(l,f){return new oe(function(m,v){return yn(function(_,E){var S=ve;S.unhandleds=[],S.onunhandled=E,S.finalize=fr(function(){var k,R=this;k=function(){R.unhandleds.length===0?_():E(R.unhandleds[0])},Bs.push(function A(){k(),Bs.splice(Bs.indexOf(A),1)}),++Hn,Se(function(){--Hn==0&&qc()},[])},S.finalize),l()},f,m,v)})}}),ae&&(ae.allSettled&&g(oe,"allSettled",function(){var l=re.apply(null,arguments).map(Ks);return new oe(function(f){l.length===0&&f([]);var m=l.length,v=new Array(m);l.forEach(function(_,E){return oe.resolve(_).then(function(S){return v[E]={status:"fulfilled",value:S}},function(S){return v[E]={status:"rejected",reason:S}}).then(function(){return--m||f(v)})})})}),ae.any&&typeof AggregateError<"u"&&g(oe,"any",function(){var l=re.apply(null,arguments).map(Ks);return new oe(function(f,m){l.length===0&&m(new AggregateError([]));var v=l.length,_=new Array(v);l.forEach(function(E,S){return oe.resolve(E).then(function(k){return f(k)},function(k){_[S]=k,--v||m(new AggregateError(_))})})})}),ae.withResolvers&&(oe.withResolvers=ae.withResolvers));var St={awaits:0,echoes:0,id:0},Mw=0,zs=[],qs=0,Hs=0,jw=0;function yn(l,f,m,v){var _=ve,E=Object.create(_);return E.parent=_,E.ref=0,E.global=!1,E.id=++jw,gn.env,E.env=Ie?{Promise:oe,PromiseProp:{value:oe,configurable:!0,writable:!0},all:oe.all,race:oe.race,allSettled:oe.allSettled,any:oe.any,resolve:oe.resolve,reject:oe.reject}:{},f&&c(E,f),++_.ref,E.finalize=function(){--this.parent.ref||this.parent.finalize()},v=Kn(E,l,m,v),E.ref===0&&E.finalize(),v}function Na(){return St.id||(St.id=++Mw),++St.awaits,St.echoes+=$e,St.id}function vn(){return!!St.awaits&&(--St.awaits==0&&(St.id=0),St.echoes=St.awaits*$e,!0)}function Ks(l){return St.echoes&&l&&l.constructor===ae?(Na(),l.then(function(f){return vn(),f},function(f){return vn(),lt(f)})):l}function Fw(){var l=zs[zs.length-1];zs.pop(),_n(l,!1)}function _n(l,f){var m,v=ve;(f?!St.echoes||qs++&&l===ve:!qs||--qs&&l===ve)||queueMicrotask(f?(function(_){++Hs,St.echoes&&--St.echoes!=0||(St.echoes=St.awaits=St.id=0),zs.push(ve),_n(_,!0)}).bind(null,l):Fw),l!==ve&&(ve=l,v===gn&&(gn.env=rh()),Ie&&(m=gn.env.Promise,f=l.env,(v.global||l.global)&&(Object.defineProperty(i,"Promise",f.PromiseProp),m.all=f.all,m.race=f.race,m.resolve=f.resolve,m.reject=f.reject,f.allSettled&&(m.allSettled=f.allSettled),f.any&&(m.any=f.any))))}function rh(){var l=i.Promise;return Ie?{Promise:l,PromiseProp:Object.getOwnPropertyDescriptor(i,"Promise"),all:l.all,race:l.race,allSettled:l.allSettled,any:l.any,resolve:l.resolve,reject:l.reject}:{}}function Kn(l,f,m,v,_){var E=ve;try{return _n(l,!0),f(m,v,_)}finally{_n(E,!1)}}function nh(l,f,m,v){return typeof l!="function"?l:function(){var _=ve;m&&Na(),_n(f,!0);try{return l.apply(this,arguments)}finally{_n(_,!1),v&&queueMicrotask(vn)}}}function Hc(l){Promise===ae&&St.echoes===0?qs===0?l():enqueueNativeMicroTask(l):setTimeout(l,0)}(""+hr).indexOf("[native code]")===-1&&(Na=vn=Ke);var lt=oe.reject,Gn="",Wr="Invalid key provided. Keys must be of type string, number, Date or Array<string | number | Date>.",ah="String expected.",Da=[],Gs="__dbnames",Kc="readonly",Gc="readwrite";function Wn(l,f){return l?f?function(){return l.apply(this,arguments)&&f.apply(this,arguments)}:l:f}var ih={type:3,lower:-1/0,lowerOpen:!1,upper:[[]],upperOpen:!1};function Ws(l){return typeof l!="string"||/\./.test(l)?function(f){return f}:function(f){return f[l]===void 0&&l in f&&delete(f=Ve(f))[l],f}}function sh(){throw we.Type()}function He(l,f){try{var m=oh(l),v=oh(f);if(m!==v)return m==="Array"?1:v==="Array"?-1:m==="binary"?1:v==="binary"?-1:m==="string"?1:v==="string"?-1:m==="Date"?1:v!=="Date"?NaN:-1;switch(m){case"number":case"Date":case"string":return f<l?1:l<f?-1:0;case"binary":return(function(_,E){for(var S=_.length,k=E.length,R=S<k?S:k,A=0;A<R;++A)if(_[A]!==E[A])return _[A]<E[A]?-1:1;return S===k?0:S<k?-1:1})(ch(l),ch(f));case"Array":return(function(_,E){for(var S=_.length,k=E.length,R=S<k?S:k,A=0;A<R;++A){var N=He(_[A],E[A]);if(N!==0)return N}return S===k?0:S<k?-1:1})(l,f)}}catch{}return NaN}function oh(l){var f=typeof l;return f!="object"?f:ArrayBuffer.isView(l)?"binary":(l=H(l),l==="ArrayBuffer"?"binary":l)}function ch(l){return l instanceof Uint8Array?l:ArrayBuffer.isView(l)?new Uint8Array(l.buffer,l.byteOffset,l.byteLength):new Uint8Array(l)}var uh=(nt.prototype._trans=function(l,f,m){var v=this._tx||ve.trans,_=this.name,E=Lt&&typeof console<"u"&&console.createTask&&console.createTask("Dexie: ".concat(l==="readonly"?"read":"write"," ").concat(this.name));function S(A,N,I){if(!I.schema[_])throw new we.NotFound("Table "+_+" not part of transaction");return f(I.idbtrans,I)}var k=Ca();try{var R=v&&v.db._novip===this.db._novip?v===ve.trans?v._promise(l,S,m):yn(function(){return v._promise(l,S,m)},{trans:v,transless:ve.transless||ve}):(function A(N,I,L,$){if(N.idbdb&&(N._state.openComplete||ve.letThrough||N._vip)){var P=N._createTransaction(I,L,N._dbSchema);try{P.create(),N._state.PR1398_maxLoop=3}catch(D){return D.name===zn.InvalidState&&N.isOpen()&&0<--N._state.PR1398_maxLoop?(console.warn("Dexie: Need to reopen db"),N.close({disableAutoOpen:!1}),N.open().then(function(){return A(N,I,L,$)})):lt(D)}return P._promise(I,function(D,C){return yn(function(){return ve.trans=P,$(D,C,P)})}).then(function(D){if(I==="readwrite")try{P.idbtrans.commit()}catch{}return I==="readonly"?D:P._completion.then(function(){return D})})}if(N._state.openComplete)return lt(new we.DatabaseClosed(N._state.dbOpenError));if(!N._state.isBeingOpened){if(!N._state.autoOpen)return lt(new we.DatabaseClosed);N.open().catch(Ke)}return N._state.dbReadyPromise.then(function(){return A(N,I,L,$)})})(this.db,l,[this.name],S);return E&&(R._consoleTask=E,R=R.catch(function(A){return console.trace(A),lt(A)})),R}finally{k&&Pa()}},nt.prototype.get=function(l,f){var m=this;return l&&l.constructor===Object?this.where(l).first(f):l==null?lt(new we.Type("Invalid argument to Table.get()")):this._trans("readonly",function(v){return m.core.get({trans:v,key:l}).then(function(_){return m.hook.reading.fire(_)})}).then(f)},nt.prototype.where=function(l){if(typeof l=="string")return new this.db.WhereClause(this,l);if(o(l))return new this.db.WhereClause(this,"[".concat(l.join("+"),"]"));var f=s(l);if(f.length===1)return this.where(f[0]).equals(l[f[0]]);var m=this.schema.indexes.concat(this.schema.primKey).filter(function(k){if(k.compound&&f.every(function(A){return 0<=k.keyPath.indexOf(A)})){for(var R=0;R<f.length;++R)if(f.indexOf(k.keyPath[R])===-1)return!1;return!0}return!1}).sort(function(k,R){return k.keyPath.length-R.keyPath.length})[0];if(m&&this.db._maxKey!==Gn){var E=m.keyPath.slice(0,f.length);return this.where(E).equals(E.map(function(R){return l[R]}))}!m&&Lt&&console.warn("The query ".concat(JSON.stringify(l)," on ").concat(this.name," would benefit from a ")+"compound index [".concat(f.join("+"),"]"));var v=this.schema.idxByName;function _(k,R){return He(k,R)===0}var S=f.reduce(function(I,R){var A=I[0],N=I[1],I=v[R],L=l[R];return[A||I,A||!I?Wn(N,I&&I.multi?function($){return $=K($,R),o($)&&$.some(function(P){return _(L,P)})}:function($){return _(L,K($,R))}):N]},[null,null]),E=S[0],S=S[1];return E?this.where(E.name).equals(l[E.keyPath]).filter(S):m?this.filter(S):this.where(f).equals("")},nt.prototype.filter=function(l){return this.toCollection().and(l)},nt.prototype.count=function(l){return this.toCollection().count(l)},nt.prototype.offset=function(l){return this.toCollection().offset(l)},nt.prototype.limit=function(l){return this.toCollection().limit(l)},nt.prototype.each=function(l){return this.toCollection().each(l)},nt.prototype.toArray=function(l){return this.toCollection().toArray(l)},nt.prototype.toCollection=function(){return new this.db.Collection(new this.db.WhereClause(this))},nt.prototype.orderBy=function(l){return new this.db.Collection(new this.db.WhereClause(this,o(l)?"[".concat(l.join("+"),"]"):l))},nt.prototype.reverse=function(){return this.toCollection().reverse()},nt.prototype.mapToClass=function(l){var f,m=this.db,v=this.name;function _(){return f!==null&&f.apply(this,arguments)||this}(this.schema.mappedClass=l).prototype instanceof sh&&((function(R,A){if(typeof A!="function"&&A!==null)throw new TypeError("Class extends value "+String(A)+" is not a constructor or null");function N(){this.constructor=R}r(R,A),R.prototype=A===null?Object.create(A):(N.prototype=A.prototype,new N)})(_,f=l),Object.defineProperty(_.prototype,"db",{get:function(){return m},enumerable:!1,configurable:!0}),_.prototype.table=function(){return v},l=_);for(var E=new Set,S=l.prototype;S;S=u(S))Object.getOwnPropertyNames(S).forEach(function(R){return E.add(R)});function k(R){if(!R)return R;var A,N=Object.create(l.prototype);for(A in R)if(!E.has(A))try{N[A]=R[A]}catch{}return N}return this.schema.readHook&&this.hook.reading.unsubscribe(this.schema.readHook),this.schema.readHook=k,this.hook("reading",k),l},nt.prototype.defineClass=function(){return this.mapToClass(function(l){c(this,l)})},nt.prototype.add=function(l,f){var m=this,v=this.schema.primKey,_=v.auto,E=v.keyPath,S=l;return E&&_&&(S=Ws(E)(l)),this._trans("readwrite",function(k){return m.core.mutate({trans:k,type:"add",keys:f!=null?[f]:null,values:[S]})}).then(function(k){return k.numFailures?oe.reject(k.failures[0]):k.lastResult}).then(function(k){if(E)try{q(l,E,k)}catch{}return k})},nt.prototype.update=function(l,f){return typeof l!="object"||o(l)?this.where(":id").equals(l).modify(f):(l=K(l,this.schema.primKey.keyPath),l===void 0?lt(new we.InvalidArgument("Given object does not contain its primary key")):this.where(":id").equals(l).modify(f))},nt.prototype.put=function(l,f){var m=this,v=this.schema.primKey,_=v.auto,E=v.keyPath,S=l;return E&&_&&(S=Ws(E)(l)),this._trans("readwrite",function(k){return m.core.mutate({trans:k,type:"put",values:[S],keys:f!=null?[f]:null})}).then(function(k){return k.numFailures?oe.reject(k.failures[0]):k.lastResult}).then(function(k){if(E)try{q(l,E,k)}catch{}return k})},nt.prototype.delete=function(l){var f=this;return this._trans("readwrite",function(m){return f.core.mutate({trans:m,type:"delete",keys:[l]})}).then(function(m){return m.numFailures?oe.reject(m.failures[0]):void 0})},nt.prototype.clear=function(){var l=this;return this._trans("readwrite",function(f){return l.core.mutate({trans:f,type:"deleteRange",range:ih})}).then(function(f){return f.numFailures?oe.reject(f.failures[0]):void 0})},nt.prototype.bulkGet=function(l){var f=this;return this._trans("readonly",function(m){return f.core.getMany({keys:l,trans:m}).then(function(v){return v.map(function(_){return f.hook.reading.fire(_)})})})},nt.prototype.bulkAdd=function(l,f,m){var v=this,_=Array.isArray(f)?f:void 0,E=(m=m||(_?void 0:f))?m.allKeys:void 0;return this._trans("readwrite",function(S){var A=v.schema.primKey,k=A.auto,A=A.keyPath;if(A&&_)throw new we.InvalidArgument("bulkAdd(): keys argument invalid on tables with inbound keys");if(_&&_.length!==l.length)throw new we.InvalidArgument("Arguments objects and keys must have the same length");var R=l.length,A=A&&k?l.map(Ws(A)):l;return v.core.mutate({trans:S,type:"add",keys:_,values:A,wantResults:E}).then(function(P){var I=P.numFailures,L=P.results,$=P.lastResult,P=P.failures;if(I===0)return E?L:$;throw new _t("".concat(v.name,".bulkAdd(): ").concat(I," of ").concat(R," operations failed"),P)})})},nt.prototype.bulkPut=function(l,f,m){var v=this,_=Array.isArray(f)?f:void 0,E=(m=m||(_?void 0:f))?m.allKeys:void 0;return this._trans("readwrite",function(S){var A=v.schema.primKey,k=A.auto,A=A.keyPath;if(A&&_)throw new we.InvalidArgument("bulkPut(): keys argument invalid on tables with inbound keys");if(_&&_.length!==l.length)throw new we.InvalidArgument("Arguments objects and keys must have the same length");var R=l.length,A=A&&k?l.map(Ws(A)):l;return v.core.mutate({trans:S,type:"put",keys:_,values:A,wantResults:E}).then(function(P){var I=P.numFailures,L=P.results,$=P.lastResult,P=P.failures;if(I===0)return E?L:$;throw new _t("".concat(v.name,".bulkPut(): ").concat(I," of ").concat(R," operations failed"),P)})})},nt.prototype.bulkUpdate=function(l){var f=this,m=this.core,v=l.map(function(S){return S.key}),_=l.map(function(S){return S.changes}),E=[];return this._trans("readwrite",function(S){return m.getMany({trans:S,keys:v,cache:"clone"}).then(function(k){var R=[],A=[];l.forEach(function(I,L){var $=I.key,P=I.changes,D=k[L];if(D){for(var C=0,M=Object.keys(P);C<M.length;C++){var j=M[C],F=P[j];if(j===f.schema.primKey.keyPath){if(He(F,$)!==0)throw new we.Constraint("Cannot update primary key in bulkUpdate()")}else q(D,j,F)}E.push(L),R.push($),A.push(D)}});var N=R.length;return m.mutate({trans:S,type:"put",keys:R,values:A,updates:{keys:v,changeSpecs:_}}).then(function(I){var L=I.numFailures,$=I.failures;if(L===0)return N;for(var P=0,D=Object.keys($);P<D.length;P++){var C,M=D[P],j=E[Number(M)];j!=null&&(C=$[M],delete $[M],$[j]=C)}throw new _t("".concat(f.name,".bulkUpdate(): ").concat(L," of ").concat(N," operations failed"),$)})})})},nt.prototype.bulkDelete=function(l){var f=this,m=l.length;return this._trans("readwrite",function(v){return f.core.mutate({trans:v,type:"delete",keys:l})}).then(function(S){var _=S.numFailures,E=S.lastResult,S=S.failures;if(_===0)return E;throw new _t("".concat(f.name,".bulkDelete(): ").concat(_," of ").concat(m," operations failed"),S)})},nt);function nt(){}function Ei(l){function f(S,k){if(k){for(var R=arguments.length,A=new Array(R-1);--R;)A[R-1]=arguments[R];return m[S].subscribe.apply(null,A),l}if(typeof S=="string")return m[S]}var m={};f.addEventType=E;for(var v=1,_=arguments.length;v<_;++v)E(arguments[v]);return f;function E(S,k,R){if(typeof S!="object"){var A;k=k||jc;var N={subscribers:[],fire:R=R||Ke,subscribe:function(I){N.subscribers.indexOf(I)===-1&&(N.subscribers.push(I),N.fire=k(N.fire,I))},unsubscribe:function(I){N.subscribers=N.subscribers.filter(function(L){return L!==I}),N.fire=N.subscribers.reduce(k,R)}};return m[S]=f[S]=N}s(A=S).forEach(function(I){var L=A[I];if(o(L))E(I,A[I][0],A[I][1]);else{if(L!=="asap")throw new we.InvalidArgument("Invalid event config");var $=E(I,br,function(){for(var P=arguments.length,D=new Array(P);P--;)D[P]=arguments[P];$.subscribers.forEach(function(C){U(function(){C.apply(null,D)})})})}})}}function xi(l,f){return w(f).from({prototype:l}),f}function La(l,f){return!(l.filter||l.algorithm||l.or)&&(f?l.justLimit:!l.replayFilter)}function Wc(l,f){l.filter=Wn(l.filter,f)}function Vc(l,f,m){var v=l.replayFilter;l.replayFilter=v?function(){return Wn(v(),f())}:f,l.justLimit=m&&!v}function Vs(l,f){if(l.isPrimKey)return f.primaryKey;var m=f.getIndexByKeyPath(l.index);if(!m)throw new we.Schema("KeyPath "+l.index+" on object store "+f.name+" is not indexed");return m}function lh(l,f,m){var v=Vs(l,f.schema);return f.openCursor({trans:m,values:!l.keysOnly,reverse:l.dir==="prev",unique:!!l.unique,query:{index:v,range:l.range}})}function Zs(l,f,m,v){var _=l.replayFilter?Wn(l.filter,l.replayFilter()):l.filter;if(l.or){var E={},S=function(k,R,A){var N,I;_&&!_(R,A,function(L){return R.stop(L)},function(L){return R.fail(L)})||((I=""+(N=R.primaryKey))=="[object ArrayBuffer]"&&(I=""+new Uint8Array(N)),h(E,I)||(E[I]=!0,f(k,R,A)))};return Promise.all([l.or._iterate(S,m),dh(lh(l,v,m),l.algorithm,S,!l.keysOnly&&l.valueMapper)])}return dh(lh(l,v,m),Wn(l.algorithm,_),f,!l.keysOnly&&l.valueMapper)}function dh(l,f,m,v){var _=it(v?function(E,S,k){return m(v(E),S,k)}:m);return l.then(function(E){if(E)return E.start(function(){var S=function(){return E.continue()};f&&!f(E,function(k){return S=k},function(k){E.stop(k),S=Ke},function(k){E.fail(k),S=Ke})||_(E.value,E,function(k){return S=k}),S()})})}var Vr=Symbol(),Si=(fh.prototype.execute=function(l){if(this.add!==void 0){var f=this.add;if(o(f))return a(a([],o(l)?l:[],!0),f).sort();if(typeof f=="number")return(Number(l)||0)+f;if(typeof f=="bigint")try{return BigInt(l)+f}catch{return BigInt(0)+f}throw new TypeError("Invalid term ".concat(f))}if(this.remove!==void 0){var m=this.remove;if(o(m))return o(l)?l.filter(function(v){return!m.includes(v)}).sort():[];if(typeof m=="number")return Number(l)-m;if(typeof m=="bigint")try{return BigInt(l)-m}catch{return BigInt(0)-m}throw new TypeError("Invalid subtrahend ".concat(m))}return f=(f=this.replacePrefix)===null||f===void 0?void 0:f[0],f&&typeof l=="string"&&l.startsWith(f)?this.replacePrefix[1]+l.substring(f.length):l},fh);function fh(l){Object.assign(this,l)}var Bw=(Ze.prototype._read=function(l,f){var m=this._ctx;return m.error?m.table._trans(null,lt.bind(null,m.error)):m.table._trans("readonly",l).then(f)},Ze.prototype._write=function(l){var f=this._ctx;return f.error?f.table._trans(null,lt.bind(null,f.error)):f.table._trans("readwrite",l,"locked")},Ze.prototype._addAlgorithm=function(l){var f=this._ctx;f.algorithm=Wn(f.algorithm,l)},Ze.prototype._iterate=function(l,f){return Zs(this._ctx,l,f,this._ctx.table.core)},Ze.prototype.clone=function(l){var f=Object.create(this.constructor.prototype),m=Object.create(this._ctx);return l&&c(m,l),f._ctx=m,f},Ze.prototype.raw=function(){return this._ctx.valueMapper=null,this},Ze.prototype.each=function(l){var f=this._ctx;return this._read(function(m){return Zs(f,l,m,f.table.core)})},Ze.prototype.count=function(l){var f=this;return this._read(function(m){var v=f._ctx,_=v.table.core;if(La(v,!0))return _.count({trans:m,query:{index:Vs(v,_.schema),range:v.range}}).then(function(S){return Math.min(S,v.limit)});var E=0;return Zs(v,function(){return++E,!1},m,_).then(function(){return E})}).then(l)},Ze.prototype.sortBy=function(l,f){var m=l.split(".").reverse(),v=m[0],_=m.length-1;function E(R,A){return A?E(R[m[A]],A-1):R[v]}var S=this._ctx.dir==="next"?1:-1;function k(R,A){return He(E(R,_),E(A,_))*S}return this.toArray(function(R){return R.sort(k)}).then(f)},Ze.prototype.toArray=function(l){var f=this;return this._read(function(m){var v=f._ctx;if(v.dir==="next"&&La(v,!0)&&0<v.limit){var _=v.valueMapper,E=Vs(v,v.table.core.schema);return v.table.core.query({trans:m,limit:v.limit,values:!0,query:{index:E,range:v.range}}).then(function(k){return k=k.result,_?k.map(_):k})}var S=[];return Zs(v,function(k){return S.push(k)},m,v.table.core).then(function(){return S})},l)},Ze.prototype.offset=function(l){var f=this._ctx;return l<=0||(f.offset+=l,La(f)?Vc(f,function(){var m=l;return function(v,_){return m===0||(m===1?--m:_(function(){v.advance(m),m=0}),!1)}}):Vc(f,function(){var m=l;return function(){return--m<0}})),this},Ze.prototype.limit=function(l){return this._ctx.limit=Math.min(this._ctx.limit,l),Vc(this._ctx,function(){var f=l;return function(m,v,_){return--f<=0&&v(_),0<=f}},!0),this},Ze.prototype.until=function(l,f){return Wc(this._ctx,function(m,v,_){return!l(m.value)||(v(_),f)}),this},Ze.prototype.first=function(l){return this.limit(1).toArray(function(f){return f[0]}).then(l)},Ze.prototype.last=function(l){return this.reverse().first(l)},Ze.prototype.filter=function(l){var f;return Wc(this._ctx,function(m){return l(m.value)}),(f=this._ctx).isMatch=Wn(f.isMatch,l),this},Ze.prototype.and=function(l){return this.filter(l)},Ze.prototype.or=function(l){return new this.db.WhereClause(this._ctx.table,l,this)},Ze.prototype.reverse=function(){return this._ctx.dir=this._ctx.dir==="prev"?"next":"prev",this._ondirectionchange&&this._ondirectionchange(this._ctx.dir),this},Ze.prototype.desc=function(){return this.reverse()},Ze.prototype.eachKey=function(l){var f=this._ctx;return f.keysOnly=!f.isMatch,this.each(function(m,v){l(v.key,v)})},Ze.prototype.eachUniqueKey=function(l){return this._ctx.unique="unique",this.eachKey(l)},Ze.prototype.eachPrimaryKey=function(l){var f=this._ctx;return f.keysOnly=!f.isMatch,this.each(function(m,v){l(v.primaryKey,v)})},Ze.prototype.keys=function(l){var f=this._ctx;f.keysOnly=!f.isMatch;var m=[];return this.each(function(v,_){m.push(_.key)}).then(function(){return m}).then(l)},Ze.prototype.primaryKeys=function(l){var f=this._ctx;if(f.dir==="next"&&La(f,!0)&&0<f.limit)return this._read(function(v){var _=Vs(f,f.table.core.schema);return f.table.core.query({trans:v,values:!1,limit:f.limit,query:{index:_,range:f.range}})}).then(function(v){return v.result}).then(l);f.keysOnly=!f.isMatch;var m=[];return this.each(function(v,_){m.push(_.primaryKey)}).then(function(){return m}).then(l)},Ze.prototype.uniqueKeys=function(l){return this._ctx.unique="unique",this.keys(l)},Ze.prototype.firstKey=function(l){return this.limit(1).keys(function(f){return f[0]}).then(l)},Ze.prototype.lastKey=function(l){return this.reverse().firstKey(l)},Ze.prototype.distinct=function(){var l=this._ctx,l=l.index&&l.table.schema.idxByName[l.index];if(!l||!l.multi)return this;var f={};return Wc(this._ctx,function(_){var v=_.primaryKey.toString(),_=h(f,v);return f[v]=!0,!_}),this},Ze.prototype.modify=function(l){var f=this,m=this._ctx;return this._write(function(v){var _,E,S;S=typeof l=="function"?l:(_=s(l),E=_.length,function(C){for(var M=!1,j=0;j<E;++j){var F=_[j],z=l[F],W=K(C,F);z instanceof Si?(q(C,F,z.execute(W)),M=!0):W!==z&&(q(C,F,z),M=!0)}return M});var k=m.table.core,I=k.schema.primaryKey,R=I.outbound,A=I.extractKey,N=200,I=f.db._options.modifyChunkSize;I&&(N=typeof I=="object"?I[k.name]||I["*"]||200:I);function L(C,F){var j=F.failures,F=F.numFailures;P+=C-F;for(var z=0,W=s(j);z<W.length;z++){var ie=W[z];$.push(j[ie])}}var $=[],P=0,D=[];return f.clone().primaryKeys().then(function(C){function M(F){var z=Math.min(N,C.length-F);return k.getMany({trans:v,keys:C.slice(F,F+z),cache:"immutable"}).then(function(W){for(var ie=[],V=[],X=R?[]:null,se=[],ne=0;ne<z;++ne){var de=W[ne],Le={value:Ve(de),primKey:C[F+ne]};S.call(Le,Le.value,Le)!==!1&&(Le.value==null?se.push(C[F+ne]):R||He(A(de),A(Le.value))===0?(V.push(Le.value),R&&X.push(C[F+ne])):(se.push(C[F+ne]),ie.push(Le.value)))}return Promise.resolve(0<ie.length&&k.mutate({trans:v,type:"add",values:ie}).then(function(Fe){for(var Be in Fe.failures)se.splice(parseInt(Be),1);L(ie.length,Fe)})).then(function(){return(0<V.length||j&&typeof l=="object")&&k.mutate({trans:v,type:"put",keys:X,values:V,criteria:j,changeSpec:typeof l!="function"&&l,isAdditionalChunk:0<F}).then(function(Fe){return L(V.length,Fe)})}).then(function(){return(0<se.length||j&&l===Zc)&&k.mutate({trans:v,type:"delete",keys:se,criteria:j,isAdditionalChunk:0<F}).then(function(Fe){return L(se.length,Fe)})}).then(function(){return C.length>F+z&&M(F+N)})})}var j=La(m)&&m.limit===1/0&&(typeof l!="function"||l===Zc)&&{index:m.index,range:m.range};return M(0).then(function(){if(0<$.length)throw new je("Error modifying one or more objects",$,P,D);return C.length})})})},Ze.prototype.delete=function(){var l=this._ctx,f=l.range;return La(l)&&(l.isPrimKey||f.type===3)?this._write(function(m){var v=l.table.core.schema.primaryKey,_=f;return l.table.core.count({trans:m,query:{index:v,range:_}}).then(function(E){return l.table.core.mutate({trans:m,type:"deleteRange",range:_}).then(function(S){var k=S.failures;if(S.lastResult,S.results,S=S.numFailures,S)throw new je("Could not delete some values",Object.keys(k).map(function(R){return k[R]}),E-S);return E-S})})}):this.modify(Zc)},Ze);function Ze(){}var Zc=function(l,f){return f.value=null};function Uw(l,f){return l<f?-1:l===f?0:1}function zw(l,f){return f<l?-1:l===f?0:1}function Qt(l,f,m){return l=l instanceof ph?new l.Collection(l):l,l._ctx.error=new(m||TypeError)(f),l}function Ma(l){return new l.Collection(l,function(){return hh("")}).limit(0)}function Js(l,f,m,v){var _,E,S,k,R,A,N,I=m.length;if(!m.every(function(P){return typeof P=="string"}))return Qt(l,ah);function L(P){_=P==="next"?function(C){return C.toUpperCase()}:function(C){return C.toLowerCase()},E=P==="next"?function(C){return C.toLowerCase()}:function(C){return C.toUpperCase()},S=P==="next"?Uw:zw;var D=m.map(function(C){return{lower:E(C),upper:_(C)}}).sort(function(C,M){return S(C.lower,M.lower)});k=D.map(function(C){return C.upper}),R=D.map(function(C){return C.lower}),N=(A=P)==="next"?"":v}L("next"),l=new l.Collection(l,function(){return wn(k[0],R[I-1]+v)}),l._ondirectionchange=function(P){L(P)};var $=0;return l._addAlgorithm(function(P,D,C){var M=P.key;if(typeof M!="string")return!1;var j=E(M);if(f(j,R,$))return!0;for(var F=null,z=$;z<I;++z){var W=(function(ie,V,X,se,ne,de){for(var Le=Math.min(ie.length,se.length),Fe=-1,Be=0;Be<Le;++Be){var Yt=V[Be];if(Yt!==se[Be])return ne(ie[Be],X[Be])<0?ie.substr(0,Be)+X[Be]+X.substr(Be+1):ne(ie[Be],se[Be])<0?ie.substr(0,Be)+se[Be]+X.substr(Be+1):0<=Fe?ie.substr(0,Fe)+V[Fe]+X.substr(Fe+1):null;ne(ie[Be],Yt)<0&&(Fe=Be)}return Le<se.length&&de==="next"?ie+X.substr(ie.length):Le<ie.length&&de==="prev"?ie.substr(0,X.length):Fe<0?null:ie.substr(0,Fe)+se[Fe]+X.substr(Fe+1)})(M,j,k[z],R[z],S,A);W===null&&F===null?$=z+1:(F===null||0<S(F,W))&&(F=W)}return D(F!==null?function(){P.continue(F+N)}:C),!1}),l}function wn(l,f,m,v){return{type:2,lower:l,upper:f,lowerOpen:m,upperOpen:v}}function hh(l){return{type:1,lower:l,upper:l}}var ph=(Object.defineProperty(kt.prototype,"Collection",{get:function(){return this._ctx.table.db.Collection},enumerable:!1,configurable:!0}),kt.prototype.between=function(l,f,m,v){m=m!==!1,v=v===!0;try{return 0<this._cmp(l,f)||this._cmp(l,f)===0&&(m||v)&&(!m||!v)?Ma(this):new this.Collection(this,function(){return wn(l,f,!m,!v)})}catch{return Qt(this,Wr)}},kt.prototype.equals=function(l){return l==null?Qt(this,Wr):new this.Collection(this,function(){return hh(l)})},kt.prototype.above=function(l){return l==null?Qt(this,Wr):new this.Collection(this,function(){return wn(l,void 0,!0)})},kt.prototype.aboveOrEqual=function(l){return l==null?Qt(this,Wr):new this.Collection(this,function(){return wn(l,void 0,!1)})},kt.prototype.below=function(l){return l==null?Qt(this,Wr):new this.Collection(this,function(){return wn(void 0,l,!1,!0)})},kt.prototype.belowOrEqual=function(l){return l==null?Qt(this,Wr):new this.Collection(this,function(){return wn(void 0,l)})},kt.prototype.startsWith=function(l){return typeof l!="string"?Qt(this,ah):this.between(l,l+Gn,!0,!0)},kt.prototype.startsWithIgnoreCase=function(l){return l===""?this.startsWith(l):Js(this,function(f,m){return f.indexOf(m[0])===0},[l],Gn)},kt.prototype.equalsIgnoreCase=function(l){return Js(this,function(f,m){return f===m[0]},[l],"")},kt.prototype.anyOfIgnoreCase=function(){var l=re.apply(Q,arguments);return l.length===0?Ma(this):Js(this,function(f,m){return m.indexOf(f)!==-1},l,"")},kt.prototype.startsWithAnyOfIgnoreCase=function(){var l=re.apply(Q,arguments);return l.length===0?Ma(this):Js(this,function(f,m){return m.some(function(v){return f.indexOf(v)===0})},l,Gn)},kt.prototype.anyOf=function(){var l=this,f=re.apply(Q,arguments),m=this._cmp;try{f.sort(m)}catch{return Qt(this,Wr)}if(f.length===0)return Ma(this);var v=new this.Collection(this,function(){return wn(f[0],f[f.length-1])});v._ondirectionchange=function(E){m=E==="next"?l._ascending:l._descending,f.sort(m)};var _=0;return v._addAlgorithm(function(E,S,k){for(var R=E.key;0<m(R,f[_]);)if(++_===f.length)return S(k),!1;return m(R,f[_])===0||(S(function(){E.continue(f[_])}),!1)}),v},kt.prototype.notEqual=function(l){return this.inAnyRange([[-1/0,l],[l,this.db._maxKey]],{includeLowers:!1,includeUppers:!1})},kt.prototype.noneOf=function(){var l=re.apply(Q,arguments);if(l.length===0)return new this.Collection(this);try{l.sort(this._ascending)}catch{return Qt(this,Wr)}var f=l.reduce(function(m,v){return m?m.concat([[m[m.length-1][1],v]]):[[-1/0,v]]},null);return f.push([l[l.length-1],this.db._maxKey]),this.inAnyRange(f,{includeLowers:!1,includeUppers:!1})},kt.prototype.inAnyRange=function(M,f){var m=this,v=this._cmp,_=this._ascending,E=this._descending,S=this._min,k=this._max;if(M.length===0)return Ma(this);if(!M.every(function(j){return j[0]!==void 0&&j[1]!==void 0&&_(j[0],j[1])<=0}))return Qt(this,"First argument to inAnyRange() must be an Array of two-value Arrays [lower,upper] where upper must not be lower than lower",we.InvalidArgument);var R=!f||f.includeLowers!==!1,A=f&&f.includeUppers===!0,N,I=_;function L(j,F){return I(j[0],F[0])}try{(N=M.reduce(function(j,F){for(var z=0,W=j.length;z<W;++z){var ie=j[z];if(v(F[0],ie[1])<0&&0<v(F[1],ie[0])){ie[0]=S(ie[0],F[0]),ie[1]=k(ie[1],F[1]);break}}return z===W&&j.push(F),j},[])).sort(L)}catch{return Qt(this,Wr)}var $=0,P=A?function(j){return 0<_(j,N[$][1])}:function(j){return 0<=_(j,N[$][1])},D=R?function(j){return 0<E(j,N[$][0])}:function(j){return 0<=E(j,N[$][0])},C=P,M=new this.Collection(this,function(){return wn(N[0][0],N[N.length-1][1],!R,!A)});return M._ondirectionchange=function(j){I=j==="next"?(C=P,_):(C=D,E),N.sort(L)},M._addAlgorithm(function(j,F,z){for(var W,ie=j.key;C(ie);)if(++$===N.length)return F(z),!1;return!P(W=ie)&&!D(W)||(m._cmp(ie,N[$][1])===0||m._cmp(ie,N[$][0])===0||F(function(){I===_?j.continue(N[$][0]):j.continue(N[$][1])}),!1)}),M},kt.prototype.startsWithAnyOf=function(){var l=re.apply(Q,arguments);return l.every(function(f){return typeof f=="string"})?l.length===0?Ma(this):this.inAnyRange(l.map(function(f){return[f,f+Gn]})):Qt(this,"startsWithAnyOf() only works with strings")},kt);function kt(){}function Dr(l){return it(function(f){return ki(f),l(f.target.error),!1})}function ki(l){l.stopPropagation&&l.stopPropagation(),l.preventDefault&&l.preventDefault()}var Ii="storagemutated",Jc="x-storagemutated-1",bn=Ei(null,Ii),qw=(Lr.prototype._lock=function(){return B(!ve.global),++this._reculock,this._reculock!==1||ve.global||(ve.lockOwnerFor=this),this},Lr.prototype._unlock=function(){if(B(!ve.global),--this._reculock==0)for(ve.global||(ve.lockOwnerFor=null);0<this._blockedFuncs.length&&!this._locked();){var l=this._blockedFuncs.shift();try{Kn(l[1],l[0])}catch{}}return this},Lr.prototype._locked=function(){return this._reculock&&ve.lockOwnerFor!==this},Lr.prototype.create=function(l){var f=this;if(!this.mode)return this;var m=this.db.idbdb,v=this.db._state.dbOpenError;if(B(!this.idbtrans),!l&&!m)switch(v&&v.name){case"DatabaseClosedError":throw new we.DatabaseClosed(v);case"MissingAPIError":throw new we.MissingAPI(v.message,v);default:throw new we.OpenFailed(v)}if(!this.active)throw new we.TransactionInactive;return B(this._completion._state===null),(l=this.idbtrans=l||(this.db.core||m).transaction(this.storeNames,this.mode,{durability:this.chromeTransactionDurability})).onerror=it(function(_){ki(_),f._reject(l.error)}),l.onabort=it(function(_){ki(_),f.active&&f._reject(new we.Abort(l.error)),f.active=!1,f.on("abort").fire(_)}),l.oncomplete=it(function(){f.active=!1,f._resolve(),"mutatedParts"in l&&bn.storagemutated.fire(l.mutatedParts)}),this},Lr.prototype._promise=function(l,f,m){var v=this;if(l==="readwrite"&&this.mode!=="readwrite")return lt(new we.ReadOnly("Transaction is readonly"));if(!this.active)return lt(new we.TransactionInactive);if(this._locked())return new oe(function(E,S){v._blockedFuncs.push([function(){v._promise(l,f,m).then(E,S)},ve])});if(m)return yn(function(){var E=new oe(function(S,k){v._lock();var R=f(S,k,v);R&&R.then&&R.then(S,k)});return E.finally(function(){return v._unlock()}),E._lib=!0,E});var _=new oe(function(E,S){var k=f(E,S,v);k&&k.then&&k.then(E,S)});return _._lib=!0,_},Lr.prototype._root=function(){return this.parent?this.parent._root():this},Lr.prototype.waitFor=function(l){var f,m=this._root(),v=oe.resolve(l);m._waitingFor?m._waitingFor=m._waitingFor.then(function(){return v}):(m._waitingFor=v,m._waitingQueue=[],f=m.idbtrans.objectStore(m.storeNames[0]),(function E(){for(++m._spinCount;m._waitingQueue.length;)m._waitingQueue.shift()();m._waitingFor&&(f.get(-1/0).onsuccess=E)})());var _=m._waitingFor;return new oe(function(E,S){v.then(function(k){return m._waitingQueue.push(it(E.bind(null,k)))},function(k){return m._waitingQueue.push(it(S.bind(null,k)))}).finally(function(){m._waitingFor===_&&(m._waitingFor=null)})})},Lr.prototype.abort=function(){this.active&&(this.active=!1,this.idbtrans&&this.idbtrans.abort(),this._reject(new we.Abort))},Lr.prototype.table=function(l){var f=this._memoizedTables||(this._memoizedTables={});if(h(f,l))return f[l];var m=this.schema[l];if(!m)throw new we.NotFound("Table "+l+" not part of transaction");return m=new this.db.Table(l,m,this),m.core=this.db.core.table(l),f[l]=m},Lr);function Lr(){}function Qc(l,f,m,v,_,E,S){return{name:l,keyPath:f,unique:m,multi:v,auto:_,compound:E,src:(m&&!S?"&":"")+(v?"*":"")+(_?"++":"")+mh(f)}}function mh(l){return typeof l=="string"?l:l?"["+[].join.call(l,"+")+"]":""}function Yc(l,f,m){return{name:l,primKey:f,indexes:m,mappedClass:null,idxByName:(v=function(_){return[_.name,_]},m.reduce(function(_,E,S){return S=v(E,S),S&&(_[S[0]]=S[1]),_},{}))};var v}var Oi=function(l){try{return l.only([[]]),Oi=function(){return[[]]},[[]]}catch{return Oi=function(){return Gn},Gn}};function Xc(l){return l==null?function(){}:typeof l=="string"?(f=l).split(".").length===1?function(m){return m[f]}:function(m){return K(m,f)}:function(m){return K(m,l)};var f}function gh(l){return[].slice.call(l)}var Hw=0;function Ti(l){return l==null?":id":typeof l=="string"?l:"[".concat(l.join("+"),"]")}function Kw(l,f,R){function v(C){if(C.type===3)return null;if(C.type===4)throw new Error("Cannot convert never type to IDBKeyRange");var $=C.lower,P=C.upper,D=C.lowerOpen,C=C.upperOpen;return $===void 0?P===void 0?null:f.upperBound(P,!!C):P===void 0?f.lowerBound($,!!D):f.bound($,P,!!D,!!C)}function _(L){var $,P=L.name;return{name:P,schema:L,mutate:function(D){var C=D.trans,M=D.type,j=D.keys,F=D.values,z=D.range;return new Promise(function(W,ie){W=it(W);var V=C.objectStore(P),X=V.keyPath==null,se=M==="put"||M==="add";if(!se&&M!=="delete"&&M!=="deleteRange")throw new Error("Invalid operation type: "+M);var ne,de=(j||F||{length:1}).length;if(j&&F&&j.length!==F.length)throw new Error("Given keys array must have same length as given values array.");if(de===0)return W({numFailures:0,failures:{},results:[],lastResult:void 0});function Le(Mt){++Yt,ki(Mt)}var Fe=[],Be=[],Yt=0;if(M==="deleteRange"){if(z.type===4)return W({numFailures:Yt,failures:Be,results:[],lastResult:void 0});z.type===3?Fe.push(ne=V.clear()):Fe.push(ne=V.delete(v(z)))}else{var X=se?X?[F,j]:[F,null]:[j,null],Ne=X[0],Ct=X[1];if(se)for(var Pt=0;Pt<de;++Pt)Fe.push(ne=Ct&&Ct[Pt]!==void 0?V[M](Ne[Pt],Ct[Pt]):V[M](Ne[Pt])),ne.onerror=Le;else for(Pt=0;Pt<de;++Pt)Fe.push(ne=V[M](Ne[Pt])),ne.onerror=Le}function uo(Mt){Mt=Mt.target.result,Fe.forEach(function(Jn,yu){return Jn.error!=null&&(Be[yu]=Jn.error)}),W({numFailures:Yt,failures:Be,results:M==="delete"?j:Fe.map(function(Jn){return Jn.result}),lastResult:Mt})}ne.onerror=function(Mt){Le(Mt),uo(Mt)},ne.onsuccess=uo})},getMany:function(D){var C=D.trans,M=D.keys;return new Promise(function(j,F){j=it(j);for(var z,W=C.objectStore(P),ie=M.length,V=new Array(ie),X=0,se=0,ne=function(Fe){Fe=Fe.target,V[Fe._pos]=Fe.result,++se===X&&j(V)},de=Dr(F),Le=0;Le<ie;++Le)M[Le]!=null&&((z=W.get(M[Le]))._pos=Le,z.onsuccess=ne,z.onerror=de,++X);X===0&&j(V)})},get:function(D){var C=D.trans,M=D.key;return new Promise(function(j,F){j=it(j);var z=C.objectStore(P).get(M);z.onsuccess=function(W){return j(W.target.result)},z.onerror=Dr(F)})},query:($=A,function(D){return new Promise(function(C,M){C=it(C);var j,F,z,X=D.trans,W=D.values,ie=D.limit,ne=D.query,V=ie===1/0?void 0:ie,se=ne.index,ne=ne.range,X=X.objectStore(P),se=se.isPrimaryKey?X:X.index(se.name),ne=v(ne);if(ie===0)return C({result:[]});$?((V=W?se.getAll(ne,V):se.getAllKeys(ne,V)).onsuccess=function(de){return C({result:de.target.result})},V.onerror=Dr(M)):(j=0,F=!W&&"openKeyCursor"in se?se.openKeyCursor(ne):se.openCursor(ne),z=[],F.onsuccess=function(de){var Le=F.result;return Le?(z.push(W?Le.value:Le.primaryKey),++j===ie?C({result:z}):void Le.continue()):C({result:z})},F.onerror=Dr(M))})}),openCursor:function(D){var C=D.trans,M=D.values,j=D.query,F=D.reverse,z=D.unique;return new Promise(function(W,ie){W=it(W);var se=j.index,V=j.range,X=C.objectStore(P),X=se.isPrimaryKey?X:X.index(se.name),se=F?z?"prevunique":"prev":z?"nextunique":"next",ne=!M&&"openKeyCursor"in X?X.openKeyCursor(v(V),se):X.openCursor(v(V),se);ne.onerror=Dr(ie),ne.onsuccess=it(function(de){var Le,Fe,Be,Yt,Ne=ne.result;Ne?(Ne.___id=++Hw,Ne.done=!1,Le=Ne.continue.bind(Ne),Fe=(Fe=Ne.continuePrimaryKey)&&Fe.bind(Ne),Be=Ne.advance.bind(Ne),Yt=function(){throw new Error("Cursor not stopped")},Ne.trans=C,Ne.stop=Ne.continue=Ne.continuePrimaryKey=Ne.advance=function(){throw new Error("Cursor not started")},Ne.fail=it(ie),Ne.next=function(){var Ct=this,Pt=1;return this.start(function(){return Pt--?Ct.continue():Ct.stop()}).then(function(){return Ct})},Ne.start=function(Ct){function Pt(){if(ne.result)try{Ct()}catch(Mt){Ne.fail(Mt)}else Ne.done=!0,Ne.start=function(){throw new Error("Cursor behind last entry")},Ne.stop()}var uo=new Promise(function(Mt,Jn){Mt=it(Mt),ne.onerror=Dr(Jn),Ne.fail=Jn,Ne.stop=function(yu){Ne.stop=Ne.continue=Ne.continuePrimaryKey=Ne.advance=Yt,Mt(yu)}});return ne.onsuccess=it(function(Mt){ne.onsuccess=Pt,Pt()}),Ne.continue=Le,Ne.continuePrimaryKey=Fe,Ne.advance=Be,Pt(),uo},W(Ne)):W(null)},ie)})},count:function(D){var C=D.query,M=D.trans,j=C.index,F=C.range;return new Promise(function(z,W){var ie=M.objectStore(P),V=j.isPrimaryKey?ie:ie.index(j.name),ie=v(F),V=ie?V.count(ie):V.count();V.onsuccess=it(function(X){return z(X.target.result)}),V.onerror=Dr(W)})}}}var E,S,k,N=(S=R,k=gh((E=l).objectStoreNames),{schema:{name:E.name,tables:k.map(function(L){return S.objectStore(L)}).map(function(L){var $=L.keyPath,C=L.autoIncrement,P=o($),D={},C={name:L.name,primaryKey:{name:null,isPrimaryKey:!0,outbound:$==null,compound:P,keyPath:$,autoIncrement:C,unique:!0,extractKey:Xc($)},indexes:gh(L.indexNames).map(function(M){return L.index(M)}).map(function(z){var j=z.name,F=z.unique,W=z.multiEntry,z=z.keyPath,W={name:j,compound:o(z),keyPath:z,unique:F,multiEntry:W,extractKey:Xc(z)};return D[Ti(z)]=W}),getIndexByKeyPath:function(M){return D[Ti(M)]}};return D[":id"]=C.primaryKey,$!=null&&(D[Ti($)]=C.primaryKey),C})},hasGetAll:0<k.length&&"getAll"in S.objectStore(k[0])&&!(typeof navigator<"u"&&/Safari/.test(navigator.userAgent)&&!/(Chrome\/|Edge\/)/.test(navigator.userAgent)&&[].concat(navigator.userAgent.match(/Safari\/(\d*)/))[1]<604)}),R=N.schema,A=N.hasGetAll,N=R.tables.map(_),I={};return N.forEach(function(L){return I[L.name]=L}),{stack:"dbcore",transaction:l.transaction.bind(l),table:function(L){if(!I[L])throw new Error("Table '".concat(L,"' not found"));return I[L]},MIN_KEY:-1/0,MAX_KEY:Oi(f),schema:R}}function Gw(l,f,m,v){var _=m.IDBKeyRange;return m.indexedDB,{dbcore:(v=Kw(f,_,v),l.dbcore.reduce(function(E,S){return S=S.create,n(n({},E),S(E))},v))}}function Qs(l,v){var m=v.db,v=Gw(l._middlewares,m,l._deps,v);l.core=v.dbcore,l.tables.forEach(function(_){var E=_.name;l.core.schema.tables.some(function(S){return S.name===E})&&(_.core=l.core.table(E),l[E]instanceof l.Table&&(l[E].core=_.core))})}function Ys(l,f,m,v){m.forEach(function(_){var E=v[_];f.forEach(function(S){var k=(function R(A,N){return b(A,N)||(A=u(A))&&R(A,N)})(S,_);(!k||"value"in k&&k.value===void 0)&&(S===l.Transaction.prototype||S instanceof l.Transaction?g(S,_,{get:function(){return this.table(_)},set:function(R){y(this,_,{value:R,writable:!0,configurable:!0,enumerable:!0})}}):S[_]=new l.Table(_,E))})})}function eu(l,f){f.forEach(function(m){for(var v in m)m[v]instanceof l.Table&&delete m[v]})}function Ww(l,f){return l._cfg.version-f._cfg.version}function Vw(l,f,m,v){var _=l._dbSchema;m.objectStoreNames.contains("$meta")&&!_.$meta&&(_.$meta=Yc("$meta",vh("")[0],[]),l._storeNames.push("$meta"));var E=l._createTransaction("readwrite",l._storeNames,_);E.create(m),E._completion.catch(v);var S=E._reject.bind(E),k=ve.transless||ve;yn(function(){return ve.trans=E,ve.transless=k,f!==0?(Qs(l,m),A=f,((R=E).storeNames.includes("$meta")?R.table("$meta").get("version").then(function(N){return N??A}):oe.resolve(A)).then(function(N){return L=N,$=E,P=m,D=[],N=(I=l)._versions,C=I._dbSchema=eo(0,I.idbdb,P),(N=N.filter(function(M){return M._cfg.version>=L})).length!==0?(N.forEach(function(M){D.push(function(){var j=C,F=M._cfg.dbschema;to(I,j,P),to(I,F,P),C=I._dbSchema=F;var z=tu(j,F);z.add.forEach(function(se){ru(P,se[0],se[1].primKey,se[1].indexes)}),z.change.forEach(function(se){if(se.recreate)throw new we.Upgrade("Not yet support for changing primary key");var ne=P.objectStore(se.name);se.add.forEach(function(de){return Xs(ne,de)}),se.change.forEach(function(de){ne.deleteIndex(de.name),Xs(ne,de)}),se.del.forEach(function(de){return ne.deleteIndex(de)})});var W=M._cfg.contentUpgrade;if(W&&M._cfg.version>L){Qs(I,P),$._memoizedTables={};var ie=G(F);z.del.forEach(function(se){ie[se]=j[se]}),eu(I,[I.Transaction.prototype]),Ys(I,[I.Transaction.prototype],s(ie),ie),$.schema=ie;var V,X=xe(W);return X&&Na(),z=oe.follow(function(){var se;(V=W($))&&X&&(se=vn.bind(null,null),V.then(se,se))}),V&&typeof V.then=="function"?oe.resolve(V):z.then(function(){return V})}}),D.push(function(j){var F,z,W=M._cfg.dbschema;F=W,z=j,[].slice.call(z.db.objectStoreNames).forEach(function(ie){return F[ie]==null&&z.db.deleteObjectStore(ie)}),eu(I,[I.Transaction.prototype]),Ys(I,[I.Transaction.prototype],I._storeNames,I._dbSchema),$.schema=I._dbSchema}),D.push(function(j){I.idbdb.objectStoreNames.contains("$meta")&&(Math.ceil(I.idbdb.version/10)===M._cfg.version?(I.idbdb.deleteObjectStore("$meta"),delete I._dbSchema.$meta,I._storeNames=I._storeNames.filter(function(F){return F!=="$meta"})):j.objectStore("$meta").put(M._cfg.version,"version"))})}),(function M(){return D.length?oe.resolve(D.shift()($.idbtrans)).then(M):oe.resolve()})().then(function(){yh(C,P)})):oe.resolve();var I,L,$,P,D,C}).catch(S)):(s(_).forEach(function(N){ru(m,N,_[N].primKey,_[N].indexes)}),Qs(l,m),void oe.follow(function(){return l.on.populate.fire(E)}).catch(S));var R,A})}function Zw(l,f){yh(l._dbSchema,f),f.db.version%10!=0||f.objectStoreNames.contains("$meta")||f.db.createObjectStore("$meta").add(Math.ceil(f.db.version/10-1),"version");var m=eo(0,l.idbdb,f);to(l,l._dbSchema,f);for(var v=0,_=tu(m,l._dbSchema).change;v<_.length;v++){var E=(function(S){if(S.change.length||S.recreate)return console.warn("Unable to patch indexes of table ".concat(S.name," because it has changes on the type of index or primary key.")),{value:void 0};var k=f.objectStore(S.name);S.add.forEach(function(R){Lt&&console.debug("Dexie upgrade patch: Creating missing index ".concat(S.name,".").concat(R.src)),Xs(k,R)})})(_[v]);if(typeof E=="object")return E.value}}function tu(l,f){var m,v={del:[],add:[],change:[]};for(m in l)f[m]||v.del.push(m);for(m in f){var _=l[m],E=f[m];if(_){var S={name:m,def:E,recreate:!1,del:[],add:[],change:[]};if(""+(_.primKey.keyPath||"")!=""+(E.primKey.keyPath||"")||_.primKey.auto!==E.primKey.auto)S.recreate=!0,v.change.push(S);else{var k=_.idxByName,R=E.idxByName,A=void 0;for(A in k)R[A]||S.del.push(A);for(A in R){var N=k[A],I=R[A];N?N.src!==I.src&&S.change.push(I):S.add.push(I)}(0<S.del.length||0<S.add.length||0<S.change.length)&&v.change.push(S)}}else v.add.push([m,E])}return v}function ru(l,f,m,v){var _=l.db.createObjectStore(f,m.keyPath?{keyPath:m.keyPath,autoIncrement:m.auto}:{autoIncrement:m.auto});return v.forEach(function(E){return Xs(_,E)}),_}function yh(l,f){s(l).forEach(function(m){f.db.objectStoreNames.contains(m)||(Lt&&console.debug("Dexie: Creating missing table",m),ru(f,m,l[m].primKey,l[m].indexes))})}function Xs(l,f){l.createIndex(f.name,f.keyPath,{unique:f.unique,multiEntry:f.multi})}function eo(l,f,m){var v={};return O(f.objectStoreNames,0).forEach(function(_){for(var E=m.objectStore(_),S=Qc(mh(A=E.keyPath),A||"",!0,!1,!!E.autoIncrement,A&&typeof A!="string",!0),k=[],R=0;R<E.indexNames.length;++R){var N=E.index(E.indexNames[R]),A=N.keyPath,N=Qc(N.name,A,!!N.unique,!!N.multiEntry,!1,A&&typeof A!="string",!1);k.push(N)}v[_]=Yc(_,S,k)}),v}function to(l,f,m){for(var v=m.db.objectStoreNames,_=0;_<v.length;++_){var E=v[_],S=m.objectStore(E);l._hasGetAll="getAll"in S;for(var k=0;k<S.indexNames.length;++k){var R=S.indexNames[k],A=S.index(R).keyPath,N=typeof A=="string"?A:"["+O(A).join("+")+"]";!f[E]||(A=f[E].idxByName[N])&&(A.name=R,delete f[E].idxByName[N],f[E].idxByName[R]=A)}}typeof navigator<"u"&&/Safari/.test(navigator.userAgent)&&!/(Chrome\/|Edge\/)/.test(navigator.userAgent)&&i.WorkerGlobalScope&&i instanceof i.WorkerGlobalScope&&[].concat(navigator.userAgent.match(/Safari\/(\d*)/))[1]<604&&(l._hasGetAll=!1)}function vh(l){return l.split(",").map(function(f,m){var v=(f=f.trim()).replace(/([&*]|\+\+)/g,""),_=/^\[/.test(v)?v.match(/^\[(.*)\]$/)[1].split("+"):v;return Qc(v,_||null,/\&/.test(f),/\*/.test(f),/\+\+/.test(f),o(_),m===0)})}var Jw=(ro.prototype._parseStoresSpec=function(l,f){s(l).forEach(function(m){if(l[m]!==null){var v=vh(l[m]),_=v.shift();if(_.unique=!0,_.multi)throw new we.Schema("Primary key cannot be multi-valued");v.forEach(function(E){if(E.auto)throw new we.Schema("Only primary key can be marked as autoIncrement (++)");if(!E.keyPath)throw new we.Schema("Index must have a name and cannot be an empty string")}),f[m]=Yc(m,_,v)}})},ro.prototype.stores=function(m){var f=this.db;this._cfg.storesSource=this._cfg.storesSource?c(this._cfg.storesSource,m):m;var m=f._versions,v={},_={};return m.forEach(function(E){c(v,E._cfg.storesSource),_=E._cfg.dbschema={},E._parseStoresSpec(v,_)}),f._dbSchema=_,eu(f,[f._allTables,f,f.Transaction.prototype]),Ys(f,[f._allTables,f,f.Transaction.prototype,this._cfg.tables],s(_),_),f._storeNames=s(_),this},ro.prototype.upgrade=function(l){return this._cfg.contentUpgrade=ce(this._cfg.contentUpgrade||Ke,l),this},ro);function ro(){}function nu(l,f){var m=l._dbNamesDB;return m||(m=l._dbNamesDB=new Zr(Gs,{addons:[],indexedDB:l,IDBKeyRange:f})).version(1).stores({dbnames:"name"}),m.table("dbnames")}function au(l){return l&&typeof l.databases=="function"}function iu(l){return yn(function(){return ve.letThrough=!0,l()})}function su(l){return!("from"in l)}var At=function(l,f){if(!this){var m=new At;return l&&"d"in l&&c(m,l),m}c(this,arguments.length?{d:1,from:l,to:1<arguments.length?f:l}:{d:0})};function Ri(l,f,m){var v=He(f,m);if(!isNaN(v)){if(0<v)throw RangeError();if(su(l))return c(l,{from:f,to:m,d:1});var _=l.l,v=l.r;if(He(m,l.from)<0)return _?Ri(_,f,m):l.l={from:f,to:m,d:1,l:null,r:null},wh(l);if(0<He(f,l.to))return v?Ri(v,f,m):l.r={from:f,to:m,d:1,l:null,r:null},wh(l);He(f,l.from)<0&&(l.from=f,l.l=null,l.d=v?v.d+1:1),0<He(m,l.to)&&(l.to=m,l.r=null,l.d=l.l?l.l.d+1:1),m=!l.r,_&&!l.l&&$i(l,_),v&&m&&$i(l,v)}}function $i(l,f){su(f)||(function m(v,R){var E=R.from,S=R.to,k=R.l,R=R.r;Ri(v,E,S),k&&m(v,k),R&&m(v,R)})(l,f)}function _h(l,f){var m=no(f),v=m.next();if(v.done)return!1;for(var _=v.value,E=no(l),S=E.next(_.from),k=S.value;!v.done&&!S.done;){if(He(k.from,_.to)<=0&&0<=He(k.to,_.from))return!0;He(_.from,k.from)<0?_=(v=m.next(k.from)).value:k=(S=E.next(_.from)).value}return!1}function no(l){var f=su(l)?null:{s:0,n:l};return{next:function(m){for(var v=0<arguments.length;f;)switch(f.s){case 0:if(f.s=1,v)for(;f.n.l&&He(m,f.n.from)<0;)f={up:f,n:f.n.l,s:1};else for(;f.n.l;)f={up:f,n:f.n.l,s:1};case 1:if(f.s=2,!v||He(m,f.n.to)<=0)return{value:f.n,done:!1};case 2:if(f.n.r){f.s=3,f={up:f,n:f.n.r,s:0};continue}case 3:f=f.up}return{done:!0}}}}function wh(l){var f,m,v=(((f=l.r)===null||f===void 0?void 0:f.d)||0)-(((m=l.l)===null||m===void 0?void 0:m.d)||0),_=1<v?"r":v<-1?"l":"";_&&(f=_=="r"?"l":"r",m=n({},l),v=l[_],l.from=v.from,l.to=v.to,l[_]=v[_],m[_]=v[f],(l[f]=m).d=bh(m)),l.d=bh(l)}function bh(m){var f=m.r,m=m.l;return(f?m?Math.max(f.d,m.d):f.d:m?m.d:0)+1}function ao(l,f){return s(f).forEach(function(m){l[m]?$i(l[m],f[m]):l[m]=(function v(_){var E,S,k={};for(E in _)h(_,E)&&(S=_[E],k[E]=!S||typeof S!="object"||qe.has(S.constructor)?S:v(S));return k})(f[m])}),l}function ou(l,f){return l.all||f.all||Object.keys(l).some(function(m){return f[m]&&_h(f[m],l[m])})}p(At.prototype,((hr={add:function(l){return $i(this,l),this},addKey:function(l){return Ri(this,l,l),this},addKeys:function(l){var f=this;return l.forEach(function(m){return Ri(f,m,m)}),this},hasKey:function(l){var f=no(this).next(l).value;return f&&He(f.from,l)<=0&&0<=He(f.to,l)}})[fe]=function(){return no(this)},hr));var Vn={},cu={},uu=!1;function io(l){ao(cu,l),uu||(uu=!0,setTimeout(function(){uu=!1,lu(cu,!(cu={}))},0))}function lu(l,f){f===void 0&&(f=!1);var m=new Set;if(l.all)for(var v=0,_=Object.values(Vn);v<_.length;v++)Eh(S=_[v],l,m,f);else for(var E in l){var S,k=/^idb\:\/\/(.*)\/(.*)\//.exec(E);k&&(E=k[1],k=k[2],(S=Vn["idb://".concat(E,"/").concat(k)])&&Eh(S,l,m,f))}m.forEach(function(R){return R()})}function Eh(l,f,m,v){for(var _=[],E=0,S=Object.entries(l.queries.query);E<S.length;E++){for(var k=S[E],R=k[0],A=[],N=0,I=k[1];N<I.length;N++){var L=I[N];ou(f,L.obsSet)?L.subscribers.forEach(function(C){return m.add(C)}):v&&A.push(L)}v&&_.push([R,A])}if(v)for(var $=0,P=_;$<P.length;$++){var D=P[$],R=D[0],A=D[1];l.queries.query[R]=A}}function Qw(l){var f=l._state,m=l._deps.indexedDB;if(f.isBeingOpened||l.idbdb)return f.dbReadyPromise.then(function(){return f.dbOpenError?lt(f.dbOpenError):l});f.isBeingOpened=!0,f.dbOpenError=null,f.openComplete=!1;var v=f.openCanceller,_=Math.round(10*l.verno),E=!1;function S(){if(f.openCanceller!==v)throw new we.DatabaseClosed("db.open() was cancelled")}function k(){return new oe(function(L,$){if(S(),!m)throw new we.MissingAPI;var P=l.name,D=f.autoSchema||!_?m.open(P):m.open(P,_);if(!D)throw new we.MissingAPI;D.onerror=Dr($),D.onblocked=it(l._fireOnBlocked),D.onupgradeneeded=it(function(C){var M;N=D.transaction,f.autoSchema&&!l._options.allowEmptyDB?(D.onerror=ki,N.abort(),D.result.close(),(M=m.deleteDatabase(P)).onsuccess=M.onerror=it(function(){$(new we.NoSuchDatabase("Database ".concat(P," doesnt exist")))})):(N.onerror=Dr($),C=C.oldVersion>Math.pow(2,62)?0:C.oldVersion,I=C<1,l.idbdb=D.result,E&&Zw(l,N),Vw(l,C/10,N,$))},$),D.onsuccess=it(function(){N=null;var C,M,j,F,z,W=l.idbdb=D.result,ie=O(W.objectStoreNames);if(0<ie.length)try{var V=W.transaction((F=ie).length===1?F[0]:F,"readonly");if(f.autoSchema)M=W,j=V,(C=l).verno=M.version/10,j=C._dbSchema=eo(0,M,j),C._storeNames=O(M.objectStoreNames,0),Ys(C,[C._allTables],s(j),j);else if(to(l,l._dbSchema,V),((z=tu(eo(0,(z=l).idbdb,V),z._dbSchema)).add.length||z.change.some(function(X){return X.add.length||X.change.length}))&&!E)return console.warn("Dexie SchemaDiff: Schema was extended without increasing the number passed to db.version(). Dexie will add missing parts and increment native version number to workaround this."),W.close(),_=W.version+1,E=!0,L(k());Qs(l,V)}catch{}Da.push(l),W.onversionchange=it(function(X){f.vcFired=!0,l.on("versionchange").fire(X)}),W.onclose=it(function(X){l.on("close").fire(X)}),I&&(z=l._deps,V=P,W=z.indexedDB,z=z.IDBKeyRange,au(W)||V===Gs||nu(W,z).put({name:V}).catch(Ke)),L()},$)}).catch(function(L){switch(L?.name){case"UnknownError":if(0<f.PR1398_maxLoop)return f.PR1398_maxLoop--,console.warn("Dexie: Workaround for Chrome UnknownError on open()"),k();break;case"VersionError":if(0<_)return _=0,k()}return oe.reject(L)})}var R,A=f.dbReadyResolve,N=null,I=!1;return oe.race([v,(typeof navigator>"u"?oe.resolve():!navigator.userAgentData&&/Safari\//.test(navigator.userAgent)&&!/Chrom(e|ium)\//.test(navigator.userAgent)&&indexedDB.databases?new Promise(function(L){function $(){return indexedDB.databases().finally(L)}R=setInterval($,100),$()}).finally(function(){return clearInterval(R)}):Promise.resolve()).then(k)]).then(function(){return S(),f.onReadyBeingFired=[],oe.resolve(iu(function(){return l.on.ready.fire(l.vip)})).then(function L(){if(0<f.onReadyBeingFired.length){var $=f.onReadyBeingFired.reduce(ce,Ke);return f.onReadyBeingFired=[],oe.resolve(iu(function(){return $(l.vip)})).then(L)}})}).finally(function(){f.openCanceller===v&&(f.onReadyBeingFired=null,f.isBeingOpened=!1)}).catch(function(L){f.dbOpenError=L;try{N&&N.abort()}catch{}return v===f.openCanceller&&l._close(),lt(L)}).finally(function(){f.openComplete=!0,A()}).then(function(){var L;return I&&(L={},l.tables.forEach(function($){$.schema.indexes.forEach(function(P){P.name&&(L["idb://".concat(l.name,"/").concat($.name,"/").concat(P.name)]=new At(-1/0,[[[]]]))}),L["idb://".concat(l.name,"/").concat($.name,"/")]=L["idb://".concat(l.name,"/").concat($.name,"/:dels")]=new At(-1/0,[[[]]])}),bn(Ii).fire(L),lu(L,!0)),l})}function du(l){function f(E){return l.next(E)}var m=_(f),v=_(function(E){return l.throw(E)});function _(E){return function(R){var k=E(R),R=k.value;return k.done?R:R&&typeof R.then=="function"?R.then(m,v):o(R)?Promise.all(R).then(m,v):m(R)}}return _(f)()}function so(l,f,m){for(var v=o(l)?l.slice():[l],_=0;_<m;++_)v.push(f);return v}var Yw={stack:"dbcore",name:"VirtualIndexMiddleware",level:1,create:function(l){return n(n({},l),{table:function(f){var m=l.table(f),v=m.schema,_={},E=[];function S(I,L,$){var P=Ti(I),D=_[P]=_[P]||[],C=I==null?0:typeof I=="string"?1:I.length,M=0<L,M=n(n({},$),{name:M?"".concat(P,"(virtual-from:").concat($.name,")"):$.name,lowLevelIndex:$,isVirtual:M,keyTail:L,keyLength:C,extractKey:Xc(I),unique:!M&&$.unique});return D.push(M),M.isPrimaryKey||E.push(M),1<C&&S(C===2?I[0]:I.slice(0,C-1),L+1,$),D.sort(function(j,F){return j.keyTail-F.keyTail}),M}f=S(v.primaryKey.keyPath,0,v.primaryKey),_[":id"]=[f];for(var k=0,R=v.indexes;k<R.length;k++){var A=R[k];S(A.keyPath,0,A)}function N(I){var L,$=I.query.index;return $.isVirtual?n(n({},I),{query:{index:$.lowLevelIndex,range:(L=I.query.range,$=$.keyTail,{type:L.type===1?2:L.type,lower:so(L.lower,L.lowerOpen?l.MAX_KEY:l.MIN_KEY,$),lowerOpen:!0,upper:so(L.upper,L.upperOpen?l.MIN_KEY:l.MAX_KEY,$),upperOpen:!0})}}):I}return n(n({},m),{schema:n(n({},v),{primaryKey:f,indexes:E,getIndexByKeyPath:function(I){return(I=_[Ti(I)])&&I[0]}}),count:function(I){return m.count(N(I))},query:function(I){return m.query(N(I))},openCursor:function(I){var L=I.query.index,$=L.keyTail,P=L.isVirtual,D=L.keyLength;return P?m.openCursor(N(I)).then(function(M){return M&&C(M)}):m.openCursor(I);function C(M){return Object.create(M,{continue:{value:function(j){j!=null?M.continue(so(j,I.reverse?l.MAX_KEY:l.MIN_KEY,$)):I.unique?M.continue(M.key.slice(0,D).concat(I.reverse?l.MIN_KEY:l.MAX_KEY,$)):M.continue()}},continuePrimaryKey:{value:function(j,F){M.continuePrimaryKey(so(j,l.MAX_KEY,$),F)}},primaryKey:{get:function(){return M.primaryKey}},key:{get:function(){var j=M.key;return D===1?j[0]:j.slice(0,D)}},value:{get:function(){return M.value}}})}}})}})}};function fu(l,f,m,v){return m=m||{},v=v||"",s(l).forEach(function(_){var E,S,k;h(f,_)?(E=l[_],S=f[_],typeof E=="object"&&typeof S=="object"&&E&&S?(k=H(E))!==H(S)?m[v+_]=f[_]:k==="Object"?fu(E,S,m,v+_+"."):E!==S&&(m[v+_]=f[_]):E!==S&&(m[v+_]=f[_])):m[v+_]=void 0}),s(f).forEach(function(_){h(l,_)||(m[v+_]=f[_])}),m}function hu(l,f){return f.type==="delete"?f.keys:f.keys||f.values.map(l.extractKey)}var Xw={stack:"dbcore",name:"HooksMiddleware",level:2,create:function(l){return n(n({},l),{table:function(f){var m=l.table(f),v=m.schema.primaryKey;return n(n({},m),{mutate:function(_){var E=ve.trans,S=E.table(f).hook,k=S.deleting,R=S.creating,A=S.updating;switch(_.type){case"add":if(R.fire===Ke)break;return E._promise("readwrite",function(){return N(_)},!0);case"put":if(R.fire===Ke&&A.fire===Ke)break;return E._promise("readwrite",function(){return N(_)},!0);case"delete":if(k.fire===Ke)break;return E._promise("readwrite",function(){return N(_)},!0);case"deleteRange":if(k.fire===Ke)break;return E._promise("readwrite",function(){return(function I(L,$,P){return m.query({trans:L,values:!1,query:{index:v,range:$},limit:P}).then(function(D){var C=D.result;return N({type:"delete",keys:C,trans:L}).then(function(M){return 0<M.numFailures?Promise.reject(M.failures[0]):C.length<P?{failures:[],numFailures:0,lastResult:void 0}:I(L,n(n({},$),{lower:C[C.length-1],lowerOpen:!0}),P)})})})(_.trans,_.range,1e4)},!0)}return m.mutate(_);function N(I){var L,$,P,D=ve.trans,C=I.keys||hu(v,I);if(!C)throw new Error("Keys missing");return(I=I.type==="add"||I.type==="put"?n(n({},I),{keys:C}):n({},I)).type!=="delete"&&(I.values=a([],I.values)),I.keys&&(I.keys=a([],I.keys)),L=m,P=C,(($=I).type==="add"?Promise.resolve([]):L.getMany({trans:$.trans,keys:P,cache:"immutable"})).then(function(M){var j=C.map(function(F,z){var W,ie,V,X=M[z],se={onerror:null,onsuccess:null};return I.type==="delete"?k.fire.call(se,F,X,D):I.type==="add"||X===void 0?(W=R.fire.call(se,F,I.values[z],D),F==null&&W!=null&&(I.keys[z]=F=W,v.outbound||q(I.values[z],v.keyPath,F))):(W=fu(X,I.values[z]),(ie=A.fire.call(se,W,F,X,D))&&(V=I.values[z],Object.keys(ie).forEach(function(ne){h(V,ne)?V[ne]=ie[ne]:q(V,ne,ie[ne])}))),se});return m.mutate(I).then(function(F){for(var z=F.failures,W=F.results,ie=F.numFailures,F=F.lastResult,V=0;V<C.length;++V){var X=(W||C)[V],se=j[V];X==null?se.onerror&&se.onerror(z[V]):se.onsuccess&&se.onsuccess(I.type==="put"&&M[V]?I.values[V]:X)}return{failures:z,results:W,numFailures:ie,lastResult:F}}).catch(function(F){return j.forEach(function(z){return z.onerror&&z.onerror(F)}),Promise.reject(F)})})}}})}})}};function xh(l,f,m){try{if(!f||f.keys.length<l.length)return null;for(var v=[],_=0,E=0;_<f.keys.length&&E<l.length;++_)He(f.keys[_],l[E])===0&&(v.push(m?Ve(f.values[_]):f.values[_]),++E);return v.length===l.length?v:null}catch{return null}}var eb={stack:"dbcore",level:-1,create:function(l){return{table:function(f){var m=l.table(f);return n(n({},m),{getMany:function(v){if(!v.cache)return m.getMany(v);var _=xh(v.keys,v.trans._cache,v.cache==="clone");return _?oe.resolve(_):m.getMany(v).then(function(E){return v.trans._cache={keys:v.keys,values:v.cache==="clone"?Ve(E):E},E})},mutate:function(v){return v.type!=="add"&&(v.trans._cache=null),m.mutate(v)}})}}}};function Sh(l,f){return l.trans.mode==="readonly"&&!!l.subscr&&!l.trans.explicit&&l.trans.db._options.cache!=="disabled"&&!f.schema.primaryKey.outbound}function kh(l,f){switch(l){case"query":return f.values&&!f.unique;case"get":case"getMany":case"count":case"openCursor":return!1}}var tb={stack:"dbcore",level:0,name:"Observability",create:function(l){var f=l.schema.name,m=new At(l.MIN_KEY,l.MAX_KEY);return n(n({},l),{transaction:function(v,_,E){if(ve.subscr&&_!=="readonly")throw new we.ReadOnly("Readwrite transaction in liveQuery context. Querier source: ".concat(ve.querier));return l.transaction(v,_,E)},table:function(v){var _=l.table(v),E=_.schema,S=E.primaryKey,I=E.indexes,k=S.extractKey,R=S.outbound,A=S.autoIncrement&&I.filter(function($){return $.compound&&$.keyPath.includes(S.keyPath)}),N=n(n({},_),{mutate:function($){function P(ne){return ne="idb://".concat(f,"/").concat(v,"/").concat(ne),F[ne]||(F[ne]=new At)}var D,C,M,j=$.trans,F=$.mutatedParts||($.mutatedParts={}),z=P(""),W=P(":dels"),ie=$.type,se=$.type==="deleteRange"?[$.range]:$.type==="delete"?[$.keys]:$.values.length<50?[hu(S,$).filter(function(ne){return ne}),$.values]:[],V=se[0],X=se[1],se=$.trans._cache;return o(V)?(z.addKeys(V),(se=ie==="delete"||V.length===X.length?xh(V,se):null)||W.addKeys(V),(se||X)&&(D=P,C=se,M=X,E.indexes.forEach(function(ne){var de=D(ne.name||"");function Le(Be){return Be!=null?ne.extractKey(Be):null}function Fe(Be){return ne.multiEntry&&o(Be)?Be.forEach(function(Yt){return de.addKey(Yt)}):de.addKey(Be)}(C||M).forEach(function(Be,Ct){var Ne=C&&Le(C[Ct]),Ct=M&&Le(M[Ct]);He(Ne,Ct)!==0&&(Ne!=null&&Fe(Ne),Ct!=null&&Fe(Ct))})}))):V?(X={from:(X=V.lower)!==null&&X!==void 0?X:l.MIN_KEY,to:(X=V.upper)!==null&&X!==void 0?X:l.MAX_KEY},W.add(X),z.add(X)):(z.add(m),W.add(m),E.indexes.forEach(function(ne){return P(ne.name).add(m)})),_.mutate($).then(function(ne){return!V||$.type!=="add"&&$.type!=="put"||(z.addKeys(ne.results),A&&A.forEach(function(de){for(var Le=$.values.map(function(Ne){return de.extractKey(Ne)}),Fe=de.keyPath.findIndex(function(Ne){return Ne===S.keyPath}),Be=0,Yt=ne.results.length;Be<Yt;++Be)Le[Be][Fe]=ne.results[Be];P(de.name).addKeys(Le)})),j.mutatedParts=ao(j.mutatedParts||{},F),ne})}}),I=function(P){var D=P.query,P=D.index,D=D.range;return[P,new At((P=D.lower)!==null&&P!==void 0?P:l.MIN_KEY,(D=D.upper)!==null&&D!==void 0?D:l.MAX_KEY)]},L={get:function($){return[S,new At($.key)]},getMany:function($){return[S,new At().addKeys($.keys)]},count:I,query:I,openCursor:I};return s(L).forEach(function($){N[$]=function(P){var D=ve.subscr,C=!!D,M=Sh(ve,_)&&kh($,P)?P.obsSet={}:D;if(C){var j=function(X){return X="idb://".concat(f,"/").concat(v,"/").concat(X),M[X]||(M[X]=new At)},F=j(""),z=j(":dels"),D=L[$](P),C=D[0],D=D[1];if(($==="query"&&C.isPrimaryKey&&!P.values?z:j(C.name||"")).add(D),!C.isPrimaryKey){if($!=="count"){var W=$==="query"&&R&&P.values&&_.query(n(n({},P),{values:!1}));return _[$].apply(this,arguments).then(function(X){if($==="query"){if(R&&P.values)return W.then(function(Le){return Le=Le.result,F.addKeys(Le),X});var se=P.values?X.result.map(k):X.result;(P.values?F:z).addKeys(se)}else if($==="openCursor"){var ne=X,de=P.values;return ne&&Object.create(ne,{key:{get:function(){return z.addKey(ne.primaryKey),ne.key}},primaryKey:{get:function(){var Le=ne.primaryKey;return z.addKey(Le),Le}},value:{get:function(){return de&&F.addKey(ne.primaryKey),ne.value}}})}return X})}z.add(m)}}return _[$].apply(this,arguments)}}),N}})}};function Ih(l,f,m){if(m.numFailures===0)return f;if(f.type==="deleteRange")return null;var v=f.keys?f.keys.length:"values"in f&&f.values?f.values.length:1;return m.numFailures===v?null:(f=n({},f),o(f.keys)&&(f.keys=f.keys.filter(function(_,E){return!(E in m.failures)})),"values"in f&&o(f.values)&&(f.values=f.values.filter(function(_,E){return!(E in m.failures)})),f)}function pu(l,f){return m=l,((v=f).lower===void 0||(v.lowerOpen?0<He(m,v.lower):0<=He(m,v.lower)))&&(l=l,(f=f).upper===void 0||(f.upperOpen?He(l,f.upper)<0:He(l,f.upper)<=0));var m,v}function Oh(l,f,L,v,_,E){if(!L||L.length===0)return l;var S=f.query.index,k=S.multiEntry,R=f.query.range,A=v.schema.primaryKey.extractKey,N=S.extractKey,I=(S.lowLevelIndex||S).extractKey,L=L.reduce(function($,P){var D=$,C=[];if(P.type==="add"||P.type==="put")for(var M=new At,j=P.values.length-1;0<=j;--j){var F,z=P.values[j],W=A(z);M.hasKey(W)||(F=N(z),(k&&o(F)?F.some(function(ne){return pu(ne,R)}):pu(F,R))&&(M.addKey(W),C.push(z)))}switch(P.type){case"add":var ie=new At().addKeys(f.values?$.map(function(de){return A(de)}):$),D=$.concat(f.values?C.filter(function(de){return de=A(de),!ie.hasKey(de)&&(ie.addKey(de),!0)}):C.map(function(de){return A(de)}).filter(function(de){return!ie.hasKey(de)&&(ie.addKey(de),!0)}));break;case"put":var V=new At().addKeys(P.values.map(function(de){return A(de)}));D=$.filter(function(de){return!V.hasKey(f.values?A(de):de)}).concat(f.values?C:C.map(function(de){return A(de)}));break;case"delete":var X=new At().addKeys(P.keys);D=$.filter(function(de){return!X.hasKey(f.values?A(de):de)});break;case"deleteRange":var se=P.range;D=$.filter(function(de){return!pu(A(de),se)})}return D},l);return L===l?l:(L.sort(function($,P){return He(I($),I(P))||He(A($),A(P))}),f.limit&&f.limit<1/0&&(L.length>f.limit?L.length=f.limit:l.length===f.limit&&L.length<f.limit&&(_.dirty=!0)),E?Object.freeze(L):L)}function Th(l,f){return He(l.lower,f.lower)===0&&He(l.upper,f.upper)===0&&!!l.lowerOpen==!!f.lowerOpen&&!!l.upperOpen==!!f.upperOpen}function rb(l,f){return(function(m,v,_,E){if(m===void 0)return v!==void 0?-1:0;if(v===void 0)return 1;if((v=He(m,v))===0){if(_&&E)return 0;if(_)return 1;if(E)return-1}return v})(l.lower,f.lower,l.lowerOpen,f.lowerOpen)<=0&&0<=(function(m,v,_,E){if(m===void 0)return v!==void 0?1:0;if(v===void 0)return-1;if((v=He(m,v))===0){if(_&&E)return 0;if(_)return-1;if(E)return 1}return v})(l.upper,f.upper,l.upperOpen,f.upperOpen)}function nb(l,f,m,v){l.subscribers.add(m),v.addEventListener("abort",function(){var _,E;l.subscribers.delete(m),l.subscribers.size===0&&(_=l,E=f,setTimeout(function(){_.subscribers.size===0&&te(E,_)},3e3))})}var ab={stack:"dbcore",level:0,name:"Cache",create:function(l){var f=l.schema.name;return n(n({},l),{transaction:function(m,v,_){var E,S,k=l.transaction(m,v,_);return v==="readwrite"&&(S=(E=new AbortController).signal,_=function(R){return function(){if(E.abort(),v==="readwrite"){for(var A=new Set,N=0,I=m;N<I.length;N++){var L=I[N],$=Vn["idb://".concat(f,"/").concat(L)];if($){var P=l.table(L),D=$.optimisticOps.filter(function(de){return de.trans===k});if(k._explicit&&R&&k.mutatedParts)for(var C=0,M=Object.values($.queries.query);C<M.length;C++)for(var j=0,F=(ie=M[C]).slice();j<F.length;j++)ou((V=F[j]).obsSet,k.mutatedParts)&&(te(ie,V),V.subscribers.forEach(function(de){return A.add(de)}));else if(0<D.length){$.optimisticOps=$.optimisticOps.filter(function(de){return de.trans!==k});for(var z=0,W=Object.values($.queries.query);z<W.length;z++)for(var ie,V,X,se=0,ne=(ie=W[z]).slice();se<ne.length;se++)(V=ne[se]).res!=null&&k.mutatedParts&&(R&&!V.dirty?(X=Object.isFrozen(V.res),X=Oh(V.res,V.req,D,P,V,X),V.dirty?(te(ie,V),V.subscribers.forEach(function(de){return A.add(de)})):X!==V.res&&(V.res=X,V.promise=oe.resolve({result:X}))):(V.dirty&&te(ie,V),V.subscribers.forEach(function(de){return A.add(de)})))}}}A.forEach(function(de){return de()})}}},k.addEventListener("abort",_(!1),{signal:S}),k.addEventListener("error",_(!1),{signal:S}),k.addEventListener("complete",_(!0),{signal:S})),k},table:function(m){var v=l.table(m),_=v.schema.primaryKey;return n(n({},v),{mutate:function(E){var S=ve.trans;if(_.outbound||S.db._options.cache==="disabled"||S.explicit||S.idbtrans.mode!=="readwrite")return v.mutate(E);var k=Vn["idb://".concat(f,"/").concat(m)];return k?(S=v.mutate(E),E.type!=="add"&&E.type!=="put"||!(50<=E.values.length||hu(_,E).some(function(R){return R==null}))?(k.optimisticOps.push(E),E.mutatedParts&&io(E.mutatedParts),S.then(function(R){0<R.numFailures&&(te(k.optimisticOps,E),(R=Ih(0,E,R))&&k.optimisticOps.push(R),E.mutatedParts&&io(E.mutatedParts))}),S.catch(function(){te(k.optimisticOps,E),E.mutatedParts&&io(E.mutatedParts)})):S.then(function(R){var A=Ih(0,n(n({},E),{values:E.values.map(function(N,I){var L;return R.failures[I]?N:(N=(L=_.keyPath)!==null&&L!==void 0&&L.includes(".")?Ve(N):n({},N),q(N,_.keyPath,R.results[I]),N)})}),R);k.optimisticOps.push(A),queueMicrotask(function(){return E.mutatedParts&&io(E.mutatedParts)})}),S):v.mutate(E)},query:function(E){if(!Sh(ve,v)||!kh("query",E))return v.query(E);var S=((A=ve.trans)===null||A===void 0?void 0:A.db._options.cache)==="immutable",I=ve,k=I.requery,R=I.signal,A=(function(P,D,C,M){var j=Vn["idb://".concat(P,"/").concat(D)];if(!j)return[];if(!(D=j.queries[C]))return[null,!1,j,null];var F=D[(M.query?M.query.index.name:null)||""];if(!F)return[null,!1,j,null];switch(C){case"query":var z=F.find(function(W){return W.req.limit===M.limit&&W.req.values===M.values&&Th(W.req.query.range,M.query.range)});return z?[z,!0,j,F]:[F.find(function(W){return("limit"in W.req?W.req.limit:1/0)>=M.limit&&(!M.values||W.req.values)&&rb(W.req.query.range,M.query.range)}),!1,j,F];case"count":return z=F.find(function(W){return Th(W.req.query.range,M.query.range)}),[z,!!z,j,F]}})(f,m,"query",E),N=A[0],I=A[1],L=A[2],$=A[3];return N&&I?N.obsSet=E.obsSet:(I=v.query(E).then(function(P){var D=P.result;if(N&&(N.res=D),S){for(var C=0,M=D.length;C<M;++C)Object.freeze(D[C]);Object.freeze(D)}else P.result=Ve(D);return P}).catch(function(P){return $&&N&&te($,N),Promise.reject(P)}),N={obsSet:E.obsSet,promise:I,subscribers:new Set,type:"query",req:E,dirty:!1},$?$.push(N):($=[N],(L=L||(Vn["idb://".concat(f,"/").concat(m)]={queries:{query:{},count:{}},objs:new Map,optimisticOps:[],unsignaledParts:{}})).queries.query[E.query.index.name||""]=$)),nb(N,$,k,R),N.promise.then(function(P){return{result:Oh(P.result,E,L?.optimisticOps,v,N,S)}})}})}})}};function oo(l,f){return new Proxy(l,{get:function(m,v,_){return v==="db"?f:Reflect.get(m,v,_)}})}var Zr=(dt.prototype.version=function(l){if(isNaN(l)||l<.1)throw new we.Type("Given version is not a positive number");if(l=Math.round(10*l)/10,this.idbdb||this._state.isBeingOpened)throw new we.Schema("Cannot add version when database is open");this.verno=Math.max(this.verno,l);var f=this._versions,m=f.filter(function(v){return v._cfg.version===l})[0];return m||(m=new this.Version(l),f.push(m),f.sort(Ww),m.stores({}),this._state.autoSchema=!1,m)},dt.prototype._whenReady=function(l){var f=this;return this.idbdb&&(this._state.openComplete||ve.letThrough||this._vip)?l():new oe(function(m,v){if(f._state.openComplete)return v(new we.DatabaseClosed(f._state.dbOpenError));if(!f._state.isBeingOpened){if(!f._state.autoOpen)return void v(new we.DatabaseClosed);f.open().catch(Ke)}f._state.dbReadyPromise.then(m,v)}).then(l)},dt.prototype.use=function(l){var f=l.stack,m=l.create,v=l.level,_=l.name;return _&&this.unuse({stack:f,name:_}),l=this._middlewares[f]||(this._middlewares[f]=[]),l.push({stack:f,create:m,level:v??10,name:_}),l.sort(function(E,S){return E.level-S.level}),this},dt.prototype.unuse=function(l){var f=l.stack,m=l.name,v=l.create;return f&&this._middlewares[f]&&(this._middlewares[f]=this._middlewares[f].filter(function(_){return v?_.create!==v:!!m&&_.name!==m})),this},dt.prototype.open=function(){var l=this;return Kn(gn,function(){return Qw(l)})},dt.prototype._close=function(){var l=this._state,f=Da.indexOf(this);if(0<=f&&Da.splice(f,1),this.idbdb){try{this.idbdb.close()}catch{}this.idbdb=null}l.isBeingOpened||(l.dbReadyPromise=new oe(function(m){l.dbReadyResolve=m}),l.openCanceller=new oe(function(m,v){l.cancelOpen=v}))},dt.prototype.close=function(m){var f=(m===void 0?{disableAutoOpen:!0}:m).disableAutoOpen,m=this._state;f?(m.isBeingOpened&&m.cancelOpen(new we.DatabaseClosed),this._close(),m.autoOpen=!1,m.dbOpenError=new we.DatabaseClosed):(this._close(),m.autoOpen=this._options.autoOpen||m.isBeingOpened,m.openComplete=!1,m.dbOpenError=null)},dt.prototype.delete=function(l){var f=this;l===void 0&&(l={disableAutoOpen:!0});var m=0<arguments.length&&typeof arguments[0]!="object",v=this._state;return new oe(function(_,E){function S(){f.close(l);var k=f._deps.indexedDB.deleteDatabase(f.name);k.onsuccess=it(function(){var R,A,N;R=f._deps,A=f.name,N=R.indexedDB,R=R.IDBKeyRange,au(N)||A===Gs||nu(N,R).delete(A).catch(Ke),_()}),k.onerror=Dr(E),k.onblocked=f._fireOnBlocked}if(m)throw new we.InvalidArgument("Invalid closeOptions argument to db.delete()");v.isBeingOpened?v.dbReadyPromise.then(S):S()})},dt.prototype.backendDB=function(){return this.idbdb},dt.prototype.isOpen=function(){return this.idbdb!==null},dt.prototype.hasBeenClosed=function(){var l=this._state.dbOpenError;return l&&l.name==="DatabaseClosed"},dt.prototype.hasFailed=function(){return this._state.dbOpenError!==null},dt.prototype.dynamicallyOpened=function(){return this._state.autoSchema},Object.defineProperty(dt.prototype,"tables",{get:function(){var l=this;return s(this._allTables).map(function(f){return l._allTables[f]})},enumerable:!1,configurable:!0}),dt.prototype.transaction=function(){var l=(function(f,m,v){var _=arguments.length;if(_<2)throw new we.InvalidArgument("Too few arguments");for(var E=new Array(_-1);--_;)E[_-1]=arguments[_];return v=E.pop(),[f,Me(E),v]}).apply(this,arguments);return this._transaction.apply(this,l)},dt.prototype._transaction=function(l,f,m){var v=this,_=ve.trans;_&&_.db===this&&l.indexOf("!")===-1||(_=null);var E,S,k=l.indexOf("?")!==-1;l=l.replace("!","").replace("?","");try{if(S=f.map(function(A){if(A=A instanceof v.Table?A.name:A,typeof A!="string")throw new TypeError("Invalid table argument to Dexie.transaction(). Only Table or String are allowed");return A}),l=="r"||l===Kc)E=Kc;else{if(l!="rw"&&l!=Gc)throw new we.InvalidArgument("Invalid transaction mode: "+l);E=Gc}if(_){if(_.mode===Kc&&E===Gc){if(!k)throw new we.SubTransaction("Cannot enter a sub-transaction with READWRITE mode when parent transaction is READONLY");_=null}_&&S.forEach(function(A){if(_&&_.storeNames.indexOf(A)===-1){if(!k)throw new we.SubTransaction("Table "+A+" not included in parent transaction.");_=null}}),k&&_&&!_.active&&(_=null)}}catch(A){return _?_._promise(null,function(N,I){I(A)}):lt(A)}var R=(function A(N,I,L,$,P){return oe.resolve().then(function(){var D=ve.transless||ve,C=N._createTransaction(I,L,N._dbSchema,$);if(C.explicit=!0,D={trans:C,transless:D},$)C.idbtrans=$.idbtrans;else try{C.create(),C.idbtrans._explicit=!0,N._state.PR1398_maxLoop=3}catch(F){return F.name===zn.InvalidState&&N.isOpen()&&0<--N._state.PR1398_maxLoop?(console.warn("Dexie: Need to reopen db"),N.close({disableAutoOpen:!1}),N.open().then(function(){return A(N,I,L,null,P)})):lt(F)}var M,j=xe(P);return j&&Na(),D=oe.follow(function(){var F;(M=P.call(C,C))&&(j?(F=vn.bind(null,null),M.then(F,F)):typeof M.next=="function"&&typeof M.throw=="function"&&(M=du(M)))},D),(M&&typeof M.then=="function"?oe.resolve(M).then(function(F){return C.active?F:lt(new we.PrematureCommit("Transaction committed too early. See http://bit.ly/2kdckMn"))}):D.then(function(){return M})).then(function(F){return $&&C._resolve(),C._completion.then(function(){return F})}).catch(function(F){return C._reject(F),lt(F)})})}).bind(null,this,E,S,_,m);return _?_._promise(E,R,"lock"):ve.trans?Kn(ve.transless,function(){return v._whenReady(R)}):this._whenReady(R)},dt.prototype.table=function(l){if(!h(this._allTables,l))throw new we.InvalidTable("Table ".concat(l," does not exist"));return this._allTables[l]},dt);function dt(l,f){var m=this;this._middlewares={},this.verno=0;var v=dt.dependencies;this._options=f=n({addons:dt.addons,autoOpen:!0,indexedDB:v.indexedDB,IDBKeyRange:v.IDBKeyRange,cache:"cloned"},f),this._deps={indexedDB:f.indexedDB,IDBKeyRange:f.IDBKeyRange},v=f.addons,this._dbSchema={},this._versions=[],this._storeNames=[],this._allTables={},this.idbdb=null,this._novip=this;var _,E,S,k,R,A={dbOpenError:null,isBeingOpened:!1,onReadyBeingFired:null,openComplete:!1,dbReadyResolve:Ke,dbReadyPromise:null,cancelOpen:Ke,openCanceller:null,autoSchema:!0,PR1398_maxLoop:3,autoOpen:f.autoOpen};A.dbReadyPromise=new oe(function(I){A.dbReadyResolve=I}),A.openCanceller=new oe(function(I,L){A.cancelOpen=L}),this._state=A,this.name=l,this.on=Ei(this,"populate","blocked","versionchange","close",{ready:[ce,Ke]}),this.on.ready.subscribe=T(this.on.ready.subscribe,function(I){return function(L,$){dt.vip(function(){var P,D=m._state;D.openComplete?(D.dbOpenError||oe.resolve().then(L),$&&I(L)):D.onReadyBeingFired?(D.onReadyBeingFired.push(L),$&&I(L)):(I(L),P=m,$||I(function C(){P.on.ready.unsubscribe(L),P.on.ready.unsubscribe(C)}))})}}),this.Collection=(_=this,xi(Bw.prototype,function(M,C){this.db=_;var $=ih,P=null;if(C)try{$=C()}catch(j){P=j}var D=M._ctx,C=D.table,M=C.hook.reading.fire;this._ctx={table:C,index:D.index,isPrimKey:!D.index||C.schema.primKey.keyPath&&D.index===C.schema.primKey.name,range:$,keysOnly:!1,dir:"next",unique:"",algorithm:null,filter:null,replayFilter:null,justLimit:!0,isMatch:null,offset:0,limit:1/0,error:P,or:D.or,valueMapper:M!==br?M:null}})),this.Table=(E=this,xi(uh.prototype,function(I,L,$){this.db=E,this._tx=$,this.name=I,this.schema=L,this.hook=E._allTables[I]?E._allTables[I].hook:Ei(null,{creating:[$a,Ke],reading:[Ra,br],updating:[Aa,Ke],deleting:[js,Ke]})})),this.Transaction=(S=this,xi(qw.prototype,function(I,L,$,P,D){var C=this;this.db=S,this.mode=I,this.storeNames=L,this.schema=$,this.chromeTransactionDurability=P,this.idbtrans=null,this.on=Ei(this,"complete","error","abort"),this.parent=D||null,this.active=!0,this._reculock=0,this._blockedFuncs=[],this._resolve=null,this._reject=null,this._waitingFor=null,this._waitingQueue=null,this._spinCount=0,this._completion=new oe(function(M,j){C._resolve=M,C._reject=j}),this._completion.then(function(){C.active=!1,C.on.complete.fire()},function(M){var j=C.active;return C.active=!1,C.on.error.fire(M),C.parent?C.parent._reject(M):j&&C.idbtrans&&C.idbtrans.abort(),lt(M)})})),this.Version=(k=this,xi(Jw.prototype,function(I){this.db=k,this._cfg={version:I,storesSource:null,dbschema:{},tables:{},contentUpgrade:null}})),this.WhereClause=(R=this,xi(ph.prototype,function(I,L,$){if(this.db=R,this._ctx={table:I,index:L===":id"?null:L,or:$},this._cmp=this._ascending=He,this._descending=function(P,D){return He(D,P)},this._max=function(P,D){return 0<He(P,D)?P:D},this._min=function(P,D){return He(P,D)<0?P:D},this._IDBKeyRange=R._deps.IDBKeyRange,!this._IDBKeyRange)throw new we.MissingAPI})),this.on("versionchange",function(I){0<I.newVersion?console.warn("Another connection wants to upgrade database '".concat(m.name,"'. Closing db now to resume the upgrade.")):console.warn("Another connection wants to delete database '".concat(m.name,"'. Closing db now to resume the delete request.")),m.close({disableAutoOpen:!1})}),this.on("blocked",function(I){!I.newVersion||I.newVersion<I.oldVersion?console.warn("Dexie.delete('".concat(m.name,"') was blocked")):console.warn("Upgrade '".concat(m.name,"' blocked by other connection holding version ").concat(I.oldVersion/10))}),this._maxKey=Oi(f.IDBKeyRange),this._createTransaction=function(I,L,$,P){return new m.Transaction(I,L,$,m._options.chromeTransactionDurability,P)},this._fireOnBlocked=function(I){m.on("blocked").fire(I),Da.filter(function(L){return L.name===m.name&&L!==m&&!L._state.vcFired}).map(function(L){return L.on("versionchange").fire(I)})},this.use(eb),this.use(ab),this.use(tb),this.use(Yw),this.use(Xw);var N=new Proxy(this,{get:function(I,L,$){if(L==="_vip")return!0;if(L==="table")return function(D){return oo(m.table(D),N)};var P=Reflect.get(I,L,$);return P instanceof uh?oo(P,N):L==="tables"?P.map(function(D){return oo(D,N)}):L==="_createTransaction"?function(){return oo(P.apply(this,arguments),N)}:P}});this.vip=N,v.forEach(function(I){return I(m)})}var co,hr=typeof Symbol<"u"&&"observable"in Symbol?Symbol.observable:"@@observable",ib=(mu.prototype.subscribe=function(l,f,m){return this._subscribe(l&&typeof l!="function"?l:{next:l,error:f,complete:m})},mu.prototype[hr]=function(){return this},mu);function mu(l){this._subscribe=l}try{co={indexedDB:i.indexedDB||i.mozIndexedDB||i.webkitIndexedDB||i.msIndexedDB,IDBKeyRange:i.IDBKeyRange||i.webkitIDBKeyRange}}catch{co={indexedDB:null,IDBKeyRange:null}}function Rh(l){var f,m=!1,v=new ib(function(_){var E=xe(l),S,k=!1,R={},A={},N={get closed(){return k},unsubscribe:function(){k||(k=!0,S&&S.abort(),I&&bn.storagemutated.unsubscribe($))}};_.start&&_.start(N);var I=!1,L=function(){return Hc(P)},$=function(D){ao(R,D),ou(A,R)&&L()},P=function(){var D,C,M;!k&&co.indexedDB&&(R={},D={},S&&S.abort(),S=new AbortController,M=(function(j){var F=Ca();try{E&&Na();var z=yn(l,j);return z=E?z.finally(vn):z}finally{F&&Pa()}})(C={subscr:D,signal:S.signal,requery:L,querier:l,trans:null}),Promise.resolve(M).then(function(j){m=!0,f=j,k||C.signal.aborted||(R={},(function(F){for(var z in F)if(h(F,z))return;return 1})(A=D)||I||(bn(Ii,$),I=!0),Hc(function(){return!k&&_.next&&_.next(j)}))},function(j){m=!1,["DatabaseClosedError","AbortError"].includes(j?.name)||k||Hc(function(){k||_.error&&_.error(j)})}))};return setTimeout(L,0),N});return v.hasValue=function(){return m},v.getValue=function(){return f},v}var Zn=Zr;function gu(l){var f=En;try{En=!0,bn.storagemutated.fire(l),lu(l,!0)}finally{En=f}}p(Zn,n(n({},dr),{delete:function(l){return new Zn(l,{addons:[]}).delete()},exists:function(l){return new Zn(l,{addons:[]}).open().then(function(f){return f.close(),!0}).catch("NoSuchDatabaseError",function(){return!1})},getDatabaseNames:function(l){try{return f=Zn.dependencies,m=f.indexedDB,f=f.IDBKeyRange,(au(m)?Promise.resolve(m.databases()).then(function(v){return v.map(function(_){return _.name}).filter(function(_){return _!==Gs})}):nu(m,f).toCollection().primaryKeys()).then(l)}catch{return lt(new we.MissingAPI)}var f,m},defineClass:function(){return function(l){c(this,l)}},ignoreTransaction:function(l){return ve.trans?Kn(ve.transless,l):l()},vip:iu,async:function(l){return function(){try{var f=du(l.apply(this,arguments));return f&&typeof f.then=="function"?f:oe.resolve(f)}catch(m){return lt(m)}}},spawn:function(l,f,m){try{var v=du(l.apply(m,f||[]));return v&&typeof v.then=="function"?v:oe.resolve(v)}catch(_){return lt(_)}},currentTransaction:{get:function(){return ve.trans||null}},waitFor:function(l,f){return f=oe.resolve(typeof l=="function"?Zn.ignoreTransaction(l):l).timeout(f||6e4),ve.trans?ve.trans.waitFor(f):f},Promise:oe,debug:{get:function(){return Lt},set:function(l){ke(l)}},derive:w,extend:c,props:p,override:T,Events:Ei,on:bn,liveQuery:Rh,extendObservabilitySet:ao,getByKeyPath:K,setByKeyPath:q,delByKeyPath:function(l,f){typeof f=="string"?q(l,f,void 0):"length"in f&&[].map.call(f,function(m){q(l,m,void 0)})},shallowClone:G,deepClone:Ve,getObjectDiff:fu,cmp:He,asap:U,minKey:-1/0,addons:[],connections:Da,errnames:zn,dependencies:co,cache:Vn,semVer:"4.0.10",version:"4.0.10".split(".").map(function(l){return parseInt(l)}).reduce(function(l,f,m){return l+f/Math.pow(10,2*m)})})),Zn.maxKey=Oi(Zn.dependencies.IDBKeyRange),typeof dispatchEvent<"u"&&typeof addEventListener<"u"&&(bn(Ii,function(l){En||(l=new CustomEvent(Jc,{detail:l}),En=!0,dispatchEvent(l),En=!1)}),addEventListener(Jc,function(l){l=l.detail,En||gu(l)}));var ja,En=!1,$h=function(){};return typeof BroadcastChannel<"u"&&(($h=function(){(ja=new BroadcastChannel(Jc)).onmessage=function(l){return l.data&&gu(l.data)}})(),typeof ja.unref=="function"&&ja.unref(),bn(Ii,function(l){En||ja.postMessage(l)})),typeof addEventListener<"u"&&(addEventListener("pagehide",function(l){if(!Zr.disableBfCache&&l.persisted){Lt&&console.debug("Dexie: handling persisted pagehide"),ja?.close();for(var f=0,m=Da;f<m.length;f++)m[f].close({disableAutoOpen:!1})}}),addEventListener("pageshow",function(l){!Zr.disableBfCache&&l.persisted&&(Lt&&console.debug("Dexie: handling persisted pageshow"),$h(),gu({all:new At(-1/0,[[]])}))})),oe.rejectionMapper=function(l,f){return!l||l instanceof Te||l instanceof TypeError||l instanceof SyntaxError||!l.name||!Pr[l.name]?l:(f=new Pr[l.name](f||l.message,l),"stack"in l&&g(f,"stack",{get:function(){return this.inner.stack}}),f)},ke(Lt),n(Zr,Object.freeze({__proto__:null,Dexie:Zr,liveQuery:Rh,Entity:sh,cmp:He,PropModSymbol:Vr,PropModification:Si,replacePrefix:function(l,f){return new Si({replacePrefix:[l,f]})},add:function(l){return new Si({add:l})},remove:function(l){return new Si({remove:l})},default:Zr,RangeSet:At,mergeRanges:$i,rangesOverlap:_h}),{default:Zr}),Zr})})(Do)),Do.exports}var BI=FI();const Ed=fi(BI),vp=Symbol.for("Dexie"),Xo=globalThis[vp]||(globalThis[vp]=Ed);if(Ed.semVer!==Xo.semVer)throw new Error(`Two different versions of Dexie loaded in the same app: ${Ed.semVer} and ${Xo.semVer}`);const{liveQuery:TN,mergeRanges:RN,rangesOverlap:$N,RangeSet:AN,cmp:CN,Entity:PN,PropModSymbol:NN,PropModification:DN,replacePrefix:LN,add:MN,remove:jN}=Xo;var ec="docs",UI="changes",_p="attachments",Vv="dexie",wp=new Map,Lo=new Map;function zI(e,t,r,n){var a="rxdb-dexie-"+e+"--"+n.version+"--"+t,i=an(wp,a,()=>{var s=(async()=>{var o=at(r);o.autoOpen=!1;var c=new Xo(a,o),u={[ec]:KI(n),[UI]:"++sequence, id",[_p]:"id"};return c.version(1).stores(u),await c.open(),{dexieDb:c,dexieTable:c[ec],dexieAttachmentsTable:c[_p],booleanIndexes:GI(n)}})();return wp.set(a,i),Lo.set(i,0),s});return i}async function qI(e){var t=await e,r=Lo.get(e),n=r-1;n===0?(t.dexieDb.close(),Lo.delete(e)):Lo.set(e,n)}var xd="__";function yi(e){var t=e.split(".");if(t.length>1)return t.map(n=>yi(n)).join(".");if(e.startsWith("|")){var r=e.substring(1);return xd+r}else return e}function Zv(e){var t=e.split(".");if(t.length>1)return t.map(n=>Zv(n)).join(".");if(e.startsWith(xd)){var r=e.substring(xd.length);return"|"+r}else return e}function HI(e,t){if(!t)return t;var r=at(t);return r=Sd(r),e.forEach(n=>{var a=Dn(t,n),i=a?"1":"0",s=yi(n);sy(r,s,i)}),r}function Jv(e,t){return t&&(t=at(t),t=kd(t),e.forEach(r=>{var n=Dn(t,r),a=n==="1";sy(t,r,a)}),t)}function Sd(e){if(!e||typeof e=="string"||typeof e=="number"||typeof e=="boolean")return e;if(Array.isArray(e))return e.map(r=>Sd(r));if(typeof e=="object"){var t={};return Object.entries(e).forEach(([r,n])=>{typeof n=="object"&&(n=Sd(n)),t[yi(r)]=n}),t}}function kd(e){if(!e||typeof e=="string"||typeof e=="number"||typeof e=="boolean")return e;if(Array.isArray(e))return e.map(r=>kd(r));if(typeof e=="object"){var t={};return Object.entries(e).forEach(([r,n])=>{(typeof n=="object"||Array.isArray(e))&&(n=kd(n)),t[Zv(r)]=n}),t}}function KI(e){var t=[],r=cr(e.primaryKey);t.push([r]),t.push(["_deleted",r]),e.indexes&&e.indexes.forEach(i=>{var s=Jd(i);t.push(s)}),t.push(["_meta.lwt",r]),t.push(["_meta.lwt"]),t=t.map(i=>i.map(s=>yi(s)));var n=t.map(i=>i.length===1?i[0]:"["+i.join("+")+"]");n=n.filter((i,s,o)=>o.indexOf(i)===s);var a=n.join(", ");return a}async function bp(e,t){var r=await e,n=await r.dexieTable.bulkGet(t);return n.map(a=>Jv(r.booleanIndexes,a))}function po(e,t){return e+"||"+t}function GI(e){var t=new Set,r=[];return e.indexes?(e.indexes.forEach(n=>{var a=Jd(n);a.forEach(i=>{if(!t.has(i)){t.add(i);var s=Xa(e,i);s.type==="boolean"&&r.push(i)}})}),r.push("_deleted"),Rb(r)):r}function Ep(e){return e===Qa?-1/0:e}function xp(e,t,r){if(e.includes(t)){var n=r===Ja||r===!0?"1":"0";return n}else return r}function Qv(e,t,r){if(!r){if(typeof window>"u")throw new Error("IDBKeyRange missing");r=window.IDBKeyRange}var n=t.startKeys.map((s,o)=>{var c=t.index[o];return xp(e,c,s)}).map(Ep),a=t.endKeys.map((s,o)=>{var c=t.index[o];return xp(e,c,s)}).map(Ep),i=r.bound(n,a,!t.inclusiveStart,!t.inclusiveEnd);return i}async function Sp(e,t){var r=await e.internals,n=t.query,a=n.skip?n.skip:0,i=n.limit?n.limit:1/0,s=a+i,o=t.queryPlan,c=!1;o.selectorSatisfiedByIndex||(c=_f(e.schema,t.query));var u=Qv(r.booleanIndexes,o,r.dexieDb._options.IDBKeyRange),d=o.index,h=[];if(await r.dexieDb.transaction("r",r.dexieTable,async y=>{var g=y.idbtrans,w=g.objectStore(ec),b,x;x="["+d.map(T=>yi(T)).join("+")+"]",b=w.index(x);var O=b.openCursor(u);await new Promise(T=>{O.onsuccess=function(B){var U=B.target.result;if(U){var K=Jv(r.booleanIndexes,U.value);(!c||c(K))&&h.push(K),o.sortSatisfiedByIndex&&h.length===s?T():U.continue()}else T()}})}),!o.sortSatisfiedByIndex){var p=hv(e.schema,t.query);h=h.sort(p)}return h=h.slice(a,s),{documents:h}}async function WI(e,t){var r=await e.internals,n=t.queryPlan,a=n.index,i=Qv(r.booleanIndexes,n,r.dexieDb._options.IDBKeyRange),s=-1;return await r.dexieDb.transaction("r",r.dexieTable,async o=>{var c=o.idbtrans,u=c.objectStore(ec),d,h;h="["+a.map(y=>yi(y)).join("+")+"]",d=u.index(h);var p=d.count(i);s=await new Promise((y,g)=>{p.onsuccess=function(){y(p.result)},p.onerror=w=>g(w)})}),s}var VI=Rt(),Nu=!1,ZI=(function(){function e(r,n,a,i,s,o,c,u){this.changes$=new nr,this.instanceId=VI++,this.storage=r,this.databaseName=n,this.collectionName=a,this.schema=i,this.internals=s,this.options=o,this.settings=c,this.devMode=u,this.primaryPath=cr(this.schema.primaryKey)}var t=e.prototype;return t.bulkWrite=async function(n,a){Xn(this),!Nu&&(!Eu.premium||typeof Eu.premium!="string"||await ry(Eu.premium)!==s0)&&console.warn(["-------------- RxDB Open Core RxStorage -------------------------------","You are using the free Dexie.js based RxStorage implementation from RxDB https://rxdb.info/rx-storage-dexie.html?console=dexie ","While this is a great option, we want to let you know that there are faster storage solutions available in our premium plugins.","For professional users and production environments, we highly recommend considering these premium options to enhance performance and reliability."," https://rxdb.info/premium?console=dexie ","If you already purchased premium access you can disable this log by calling the setPremiumFlag() function from rxdb-premium/plugins/shared.","---------------------------------------------------------------------"].join(`
`)),Nu=!0,n.forEach(d=>{if(!d.document._rev||d.previous&&!d.previous._rev)throw ye("SNH",{args:{row:d}})});var i=await this.internals,s={error:[]};this.devMode&&(n=n.map(d=>{var h=Cs(d.document);return{previous:d.previous,document:h}}));var o=n.map(d=>d.document[this.primaryPath]),c;if(await i.dexieDb.transaction("rw",i.dexieTable,i.dexieAttachmentsTable,async()=>{var d=new Map,h=await bp(this.internals,o);h.forEach(g=>{var w=g;return w&&d.set(w[this.primaryPath],w),w}),c=BS(this,this.primaryPath,d,n,a),s.error=c.errors;var p=[];c.bulkInsertDocs.forEach(g=>{p.push(g.document)}),c.bulkUpdateDocs.forEach(g=>{p.push(g.document)}),p=p.map(g=>HI(i.booleanIndexes,g)),p.length>0&&await i.dexieTable.bulkPut(p);var y=[];c.attachmentsAdd.forEach(g=>{y.push({id:po(g.documentId,g.attachmentId),data:g.attachmentData.data})}),c.attachmentsUpdate.forEach(g=>{y.push({id:po(g.documentId,g.attachmentId),data:g.attachmentData.data})}),await i.dexieAttachmentsTable.bulkPut(y),await i.dexieAttachmentsTable.bulkDelete(c.attachmentsRemove.map(g=>po(g.documentId,g.attachmentId)))}),c=Ue(c),c.eventBulk.events.length>0){var u=Ue(c.newestRow).document;c.eventBulk.checkpoint={id:u[this.primaryPath],lwt:u._meta.lwt},c.eventBulk.endTime=Rt(),this.changes$.next(c.eventBulk)}return s},t.findDocumentsById=async function(n,a){Xn(this);var i=await this.internals,s=[];return await i.dexieDb.transaction("r",i.dexieTable,async()=>{var o=await bp(this.internals,n);o.forEach(c=>{c&&(!c._deleted||a)&&s.push(c)})}),s},t.query=function(n){return Xn(this),Sp(this,n)},t.count=async function(n){if(n.queryPlan.selectorSatisfiedByIndex){var a=await WI(this,n);return{count:a,mode:"fast"}}else{var i=await Sp(this,n);return{count:i.documents.length,mode:"slow"}}},t.changeStream=function(){return Xn(this),this.changes$.asObservable()},t.cleanup=async function(n){Xn(this);var a=await this.internals;return await a.dexieDb.transaction("rw",a.dexieTable,async()=>{var i=Rt()-n,s=await a.dexieTable.where("_meta.lwt").below(i).toArray(),o=[];s.forEach(c=>{c._deleted==="1"&&o.push(c[this.primaryPath])}),await a.dexieTable.bulkDelete(o)}),!0},t.getAttachmentData=async function(n,a,i){Xn(this);var s=await this.internals,o=po(n,a);return await s.dexieDb.transaction("r",s.dexieAttachmentsTable,async()=>{var c=await s.dexieAttachmentsTable.get(o);if(c)return c.data;throw new Error("attachment missing documentId: "+n+" attachmentId: "+a)})},t.remove=async function(){Xn(this);var n=await this.internals;return await n.dexieTable.clear(),this.close()},t.close=function(){return this.closed?this.closed:(this.closed=(async()=>{this.changes$.complete(),await qI(this.internals)})(),this.closed)},t.conflictResultionTasks=function(){return new nr},t.resolveConflictResultionTask=async function(n){},e})();async function JI(e,t,r){var n=zI(t.databaseName,t.collectionName,r,t.schema),a=new ZI(e,t.databaseName,t.collectionName,t.schema,n,t.options,r,t.devMode);return await MI(Vv,t,a),Promise.resolve(a)}function Xn(e){if(e.closed)throw new Error("RxStorageInstanceDexie is closed "+e.databaseName+"-"+e.collectionName)}var QI=(function(){function e(r){this.name=Vv,this.rxdbVersion=oy,this.settings=r}var t=e.prototype;return t.createStorageInstance=function(n){return qS(n),JI(this,n,this.settings)},e})();function YI(e={}){var t=new QI(e);return t}var XI=["__proto__","constructor","prototype"];function Fi(e,t){Object.keys(t).forEach(r=>{XI.includes(r)||(typeof e[r]>"u"?e[r]=t[r]:Vi(t[r])?Fi(e[r],t[r]):e[r]=t[r])})}function Vi(e){return e.toString()==="[object Object]"}var Tc=(function(){function e(r,n){if(this.options={},this._conditions={},this._fields={},this._path=n,r){var a=this;r.selector&&a.find(r.selector),r.limit&&a.limit(r.limit),r.skip&&a.skip(r.skip),r.sort&&r.sort.forEach(i=>a.sort(i))}}var t=e.prototype;return t.where=function(n,a){if(!arguments.length)return this;var i=typeof arguments[0];if(i==="string")return this._path=arguments[0],arguments.length===2&&(this._conditions[this._path]=arguments[1]),this;if(i==="object"&&!Array.isArray(arguments[0]))return this.merge(arguments[0]);throw tr("MQ1",{path:arguments[0]})},t.equals=function(n){this._ensurePath("equals");var a=this._path;return this._conditions[a]=n,this},t.eq=function(n){this._ensurePath("eq");var a=this._path;return this._conditions[a]=n,this},t.or=function(n){var a=this._conditions.$or||(this._conditions.$or=[]);return Array.isArray(n)||(n=[n]),a.push.apply(a,n),this},t.nor=function(n){var a=this._conditions.$nor||(this._conditions.$nor=[]);return Array.isArray(n)||(n=[n]),a.push.apply(a,n),this},t.and=function(n){var a=this._conditions.$and||(this._conditions.$and=[]);return Array.isArray(n)||(n=[n]),a.push.apply(a,n),this},t.mod=function(n,a){var i,s;arguments.length===1?(this._ensurePath("mod"),i=arguments[0],s=this._path):arguments.length===2&&!Array.isArray(arguments[1])?(this._ensurePath("mod"),i=arguments.slice(),s=this._path):arguments.length===3?(i=arguments.slice(1),s=arguments[0]):(i=arguments[1],s=arguments[0]);var o=this._conditions[s]||(this._conditions[s]={});return o.$mod=i,this},t.exists=function(n,a){var i,s;arguments.length===0?(this._ensurePath("exists"),i=this._path,s=!0):arguments.length===1?typeof arguments[0]=="boolean"?(this._ensurePath("exists"),i=this._path,s=arguments[0]):(i=arguments[0],s=!0):arguments.length===2&&(i=arguments[0],s=arguments[1]);var o=this._conditions[i]||(this._conditions[i]={});return o.$exists=s,this},t.elemMatch=function(n,a){if(arguments[0]===null)throw tr("MQ2");var i,s,o;if(typeof arguments[0]=="function")this._ensurePath("elemMatch"),s=this._path,i=arguments[0];else if(Vi(arguments[0]))this._ensurePath("elemMatch"),s=this._path,o=arguments[0];else if(typeof arguments[1]=="function")s=arguments[0],i=arguments[1];else if(arguments[1]&&Vi(arguments[1]))s=arguments[0],o=arguments[1];else throw tr("MQ2");i&&(o=new e,i(o),o=o._conditions);var c=this._conditions[s]||(this._conditions[s]={});return c.$elemMatch=o,this},t.sort=function(n){if(!n)return this;var a,i=typeof n;if(Array.isArray(n)){a=n.length;for(var s=0;s<n.length;++s)tO(this.options,n[s][0],n[s][1]);return this}if(arguments.length===1&&i==="string"){n=n.split(/\s+/),a=n.length;for(var o=0;o<a;++o){var c=n[o];if(c){var u=c[0]==="-"?-1:1;u===-1&&(c=c.substring(1)),kp(this.options,c,u)}}return this}if(Vi(n)){var d=Object.keys(n);return d.forEach(h=>kp(this.options,h,n[h])),this}throw tr("MQ3",{args:arguments})},t.merge=function(n){if(!n)return this;if(!Ip(n))throw tr("MQ4",{source:n});return n instanceof e?(n._conditions&&Fi(this._conditions,n._conditions),n._fields&&(this._fields||(this._fields={}),Fi(this._fields,n._fields)),n.options&&(this.options||(this.options={}),Fi(this.options,n.options)),n._distinct&&(this._distinct=n._distinct),this):(Fi(this._conditions,n),this)},t.find=function(n){return Ip(n)&&this.merge(n),this},t._ensurePath=function(n){if(!this._path)throw ye("MQ5",{method:n})},t.toJSON=function(){var n={selector:this._conditions};return this.options.skip&&(n.skip=this.options.skip),this.options.limit&&(n.limit=this.options.limit),this.options.sort&&(n.sort=eO(this.options.sort)),{query:n,path:this._path}},e})();function eO(e){return Object.entries(e).map(([t,r])=>{var n=r===1?"asc":"desc",a={[t]:n};return a})}var Yv=["limit","skip","maxScan","batchSize","comment"];Yv.forEach(function(e){Tc.prototype[e]=function(t){return this.options[e]=t,this}});var Xv=["gt","gte","lt","lte","ne","in","nin","all","regex","size"];Xv.forEach(function(e){Tc.prototype[e]=function(){var t,r;arguments.length===1?(this._ensurePath(e),r=arguments[0],t=this._path):(r=arguments[1],t=arguments[0]);var n=this._conditions[t]===null||typeof this._conditions[t]=="object"?this._conditions[t]:this._conditions[t]={};if(e==="regex"){if(r instanceof RegExp)throw ye("QU16",{field:t,query:this._conditions});typeof r=="string"?n["$"+e]=r:(n["$"+e]=r.$regex,r.$options&&(n.$options=r.$options))}else n["$"+e]=r;return this}});function kp(e,t,r){if(Array.isArray(e.sort))throw tr("MQ6",{opts:e,field:t,value:r});if(r&&r.$meta){var n=e.sort||(e.sort={});n[t]={$meta:r.$meta};return}var a=String(r||1).toLowerCase();if(!/^(?:ascending|asc|descending|desc|1|-1)$/.test(a))throw Array.isArray(r)&&(r="["+r+"]"),tr("MQ7",{field:t,value:r});var i=e.sort||(e.sort={}),s=r.toString().replace("asc","1").replace("ascending","1").replace("desc","-1").replace("descending","-1");i[t]=parseInt(s,10)}function tO(e,t,r){if(e.sort=e.sort||[],!Array.isArray(e.sort))throw tr("MQ8",{opts:e,field:t,value:r});e.sort.push([t,r])}function Ip(e){return e instanceof Tc||Vi(e)}function rO(e,t){return new Tc(e,t)}var Op="queryBuilderPath";function nO(e,t,r){var n=rO(Ut(e.mangoQuery),e.other[Op]);n[t](r);var a=n.toJSON();return Ua(e.op,a.query,e.collection,{...e.other,[Op]:a.path})}function Du(e,t){e[t]=function(r){if(rt.isDevMode()&&this.op==="findByIds")throw ye("QU17",{collection:this.collection.name,query:this.mangoQuery});return nO(this,t,r)}}var aO={name:"query-builder",rxdb:!0,prototypes:{RxQuery(e){["where","equals","eq","or","nor","and","mod","exists","elemMatch","sort"].forEach(t=>{Du(e,t)}),Yv.forEach(t=>{Du(e,t)}),Xv.forEach(t=>{Du(e,t)})}}};async function e_(e){var t=b0(e.collection.schema.jsonSchema).map(n=>e.collection.name+"-"+n),r=await e.database.internalStore.findDocumentsById(t.map(n=>si(n,ua)),!1);if(r.length>1)throw new Error("more than one old collection meta found");return r[0]}function iO(e,t,r){var n=at(r._attachments),a=Ut(r),i=a._meta;delete a._meta,a._attachments=n;for(var s=t+1,o=Promise.resolve(a),c=function(){var u=s;o=o.then(d=>sO(e,u,d)),s++};s<=e.schema.version;)c();return o.then(u=>u===null?Xd:(u._meta=i,u))}function sO(e,t,r){if(r===null)return Xd;var n=e.migrationStrategies[t](r,e),a=Yb(n);return a}async function t_(e){if(e.collection.schema.version===0)return Or;var t=await e_(e);return!!t}var oO=200,r_=new WeakMap;function cO(e){var t=n_(e.database),r=t.getValue().slice(0);r.push(e),t.next(r)}function n_(e){return an(r_,e,()=>new na([]))}function uO(e){var t=r_.get(e);t&&t.complete()}var lO=(function(){function e(r,n,a=[r.name,"v",r.schema.version].join("-")){this.started=!1,this.updateStatusHandlers=[],this.updateStatusQueue=Xb,this.collection=r,this.migrationStrategies=n,this.statusDocKey=a,this.database=r.database,this.oldCollectionMeta=e_(this),this.mustMigrate=t_(this),this.statusDocId=si(this.statusDocKey,Po),cO(this),this.$=FS(this.database.internalStore,this.statusDocId).pipe(tt(i=>!!i),bt(i=>Ue(i).data),Os(Es))}var t=e.prototype;return t.getStatus=function(){return sa(this.$)},t.startMigration=async function(n=oO){var a=await this.mustMigrate;if(a){if(this.started)throw ye("DM1");this.started=!0;var i=void 0;if(this.database.multiInstance){i=new Oc(["rx-migration-state",this.database.name,this.collection.name,this.collection.schema.version].join("|"));var s=DI(i);await s.awaitLeadership()}var o=await this.oldCollectionMeta,c=await this.database.storage.createStorageInstance({databaseName:this.database.name,collectionName:this.collection.name,databaseInstanceToken:this.database.token,multiInstance:this.database.multiInstance,options:{},schema:o.data.schema,password:this.database.password,devMode:rt.isDevMode()}),u=await this.getConnectedStorageInstances(),d=await this.countAllDoucments([c].concat(u.map(h=>h.oldStorage)));await this.updateStatus(h=>(h.count.total=d,h));try{await Promise.all(u.map(async h=>{await QS(this.collection,h.newStorage.collectionName,h.newStorage.schema),await this.migrateStorage(h.oldStorage,h.newStorage,n),await h.newStorage.close()})),await this.migrateStorage(c,this.collection.storageInstance.originalStorageInstance,n)}catch(h){await c.close(),await this.updateStatus(p=>(p.status="ERROR",p.error=i0(h),p));return}await os(this.database.internalStore,{previous:o,document:Object.assign({},o,{_deleted:!0})},"rx-migration-remove-collection-meta"),await this.updateStatus(h=>(h.status="DONE",h)),i&&await i.close()}},t.updateStatus=function(n){return this.updateStatusHandlers.push(n),this.updateStatusQueue=this.updateStatusQueue.then(async()=>{if(this.updateStatusHandlers.length!==0){var a=this.updateStatusHandlers;for(this.updateStatusHandlers=[];;){var i=await As(this.database.internalStore,this.statusDocId),s=Ut(i);i||(s={id:this.statusDocId,key:this.statusDocKey,context:Po,data:{collectionName:this.collection.name,status:"RUNNING",count:{total:0,handled:0,percent:0}},_deleted:!1,_meta:Ea(),_rev:yr(),_attachments:{}});var o=Ue(s).data;for(var c of a)o=c(o);if(o.count.percent=Math.round(o.count.handled/o.count.total*100),s&&i&&es(s.data,i.data))break;try{await os(this.database.internalStore,{previous:i,document:Ue(s)},Po);break}catch(u){if(!vc(u))throw u}}}}),this.updateStatusQueue},t.migrateStorage=async function(n,a,i){var s=await this.database.storage.createStorageInstance({databaseName:this.database.name,collectionName:"rx-migration-state-meta-"+this.collection.name+"-"+this.collection.schema.version,databaseInstanceToken:this.database.token,multiInstance:this.database.multiInstance,options:{},schema:cp(n.schema,gd(n.schema)),password:this.database.password,devMode:rt.isDevMode()}),o=fk(a,Jo,this.database.token,!0),c=lk({keepMeta:!0,identifier:["rx-migration-state",this.collection.name,n.schema.version,this.collection.schema.version].join("-"),replicationHandler:{masterChangesSince(){return Promise.resolve({checkpoint:null,documents:[]})},masterWrite:async d=>{d=await Promise.all(d.map(async p=>{var y=p.newDocumentState;if(a.schema.title===No&&(y=p.newDocumentState.docData,p.newDocumentState.isCheckpoint==="1"))return{assumedMasterState:void 0,newDocumentState:p.newDocumentState};var g=await iO(this.collection,n.schema.version,y),w={assumedMasterState:void 0,newDocumentState:a.schema.title===No?Object.assign({},p.newDocumentState,{docData:g}):g};return w})),d=d.filter(p=>!!p.newDocumentState);var h=await o.masterWrite(d);return h},masterChangeStream$:new nr().asObservable()},forkInstance:n,metaInstance:s,pushBatchSize:i,pullBatchSize:0,conflictHandler:Jo,hashFunction:this.database.hashFunction}),u=!1;if(c.events.error.subscribe(d=>u=d),c.events.processed.up.subscribe(()=>{this.updateStatus(d=>(d.count.handled=d.count.handled+1,d))}),await dk(c),await hk(c),await this.updateStatusQueue,u)throw await s.close(),u;await Promise.all([n.remove(),s.remove()])},t.countAllDoucments=async function(n){var a=0;return await Promise.all(n.map(async i=>{var s=xc(i.schema,ss(i.schema,{selector:{}})),o=await i.count(s);a+=o.count})),a},t.getConnectedStorageInstances=async function(){var n=await this.oldCollectionMeta,a=[];return await Promise.all(await Promise.all(n.data.connectedStorages.map(async i=>{if(i.schema.title!==No)throw new Error("unknown migration handling for schema");var s=cp(Ut(this.collection.schema.jsonSchema),gd(i.schema));s.version=this.collection.schema.version;var[o,c]=await Promise.all([this.database.storage.createStorageInstance({databaseInstanceToken:this.database.token,databaseName:this.database.name,devMode:rt.isDevMode(),multiInstance:this.database.multiInstance,options:{},schema:i.schema,password:this.database.password,collectionName:i.collectionName}),this.database.storage.createStorageInstance({databaseInstanceToken:this.database.token,databaseName:this.database.name,devMode:rt.isDevMode(),multiInstance:this.database.multiInstance,options:{},schema:s,password:this.database.password,collectionName:i.collectionName})]);a.push({oldStorage:o,newStorage:c})}))),a},t.migratePromise=async function(n){this.startMigration(n);var a=await this.mustMigrate;if(!a)return{status:"DONE",collectionName:this.collection.name,count:{handled:0,percent:0,total:0}};var i=await Promise.race([sa(this.$.pipe(tt(s=>s.status==="DONE"))),sa(this.$.pipe(tt(s=>s.status==="ERROR")))]);if(i.status==="ERROR")throw ye("DM4",{collection:this.collection.name,error:i.error});return i},e})(),dO=Ev(),fO=(function(e){function t(r,n,a){var i;return i=e.call(this,null,n)||this,i.id=r,i.parent=a,i}return ef(t,e),t})(dO),Zi={get isLocal(){return!0},get allAttachments$(){throw ye("LD1",{document:this})},get primaryPath(){return"id"},get primary(){return this.id},get $(){var e=this,t=ma(Id,this.parent);return e.parent.$.pipe(tt(r=>r.documentId===this.primary),tt(r=>r.isLocal),bt(r=>Cy(r)),Ts(t.docCache.getLatestDocumentData(this.primary)),ns((r,n)=>r._rev===n._rev),bt(r=>t.docCache.getCachedRxDocument(r)),Os(Es))},get $$(){var e=this,t=Lu(e),r=t.getReactivityFactory();return r.fromObservable(e.$,e.getLatest()._data,t)},get deleted$$(){var e=this,t=Lu(e),r=t.getReactivityFactory();return r.fromObservable(e.deleted$,e.getLatest().deleted,t)},getLatest(){var e=ma(Id,this.parent),t=e.docCache.getLatestDocumentData(this.primary);return e.docCache.getCachedRxDocument(t)},get(e){if(e="data."+e,!!this._data){if(typeof e!="string")throw tr("LD2",{objPath:e});var t=Dn(this._data,e);return t=rt.deepFreezeWhenDevMode(t),t}},get$(e){if(e="data."+e,rt.isDevMode()){if(e.includes(".item."))throw ye("LD3",{objPath:e});if(e===this.primaryPath)throw ye("LD4")}return this.$.pipe(bt(t=>t._data),bt(t=>Dn(t,e)),ns())},get$$(e){var t=Lu(this),r=t.getReactivityFactory();return r.fromObservable(this.get$(e),this.getLatest().get(e),t)},async incrementalModify(e){var t=await Ji(this.parent);return t.incrementalWriteQueue.addWrite(this._data,async r=>(r.data=await e(r.data,this),r)).then(r=>t.docCache.getCachedRxDocument(r))},incrementalPatch(e){return this.incrementalModify(t=>(Object.entries(e).forEach(([r,n])=>{t[r]=n}),t))},async _saveData(e){var t=await Ji(this.parent),r=this._data;e.id=this.id;var n=[{previous:r,document:e}];return t.storageInstance.bulkWrite(n,"local-document-save-data").then(a=>{if(a.error[0])throw a.error[0];var i=sr(this.collection.schema.primaryPath,n,a)[0];e=at(e),e._rev=i._rev})},async remove(){var e=await Ji(this.parent),t=at(this._data);return t._deleted=!0,os(e.storageInstance,{previous:this._data,document:t},"local-document-remove").then(r=>e.docCache.getCachedRxDocument(r))}},Tp=!1,hO=()=>{if(!Tp){Tp=!0;var e=Sc,t=Object.getOwnPropertyNames(e);t.forEach(n=>{var a=Object.getOwnPropertyDescriptor(Zi,n);if(!a){var i=Object.getOwnPropertyDescriptor(e,n);Object.defineProperty(Zi,n,i)}});var r=n=>()=>{throw ye("LD6",{functionName:n})};["populate","update","putAttachment","getAttachment","allAttachments"].forEach(n=>Zi[n]=r(n))}};function pO(e,t){hO();var r=new fO(e.id,e,t);return Object.setPrototypeOf(r,Zi),r.prototype=Zi,r}function Lu(e){var t=e.parent;return xk(t)?t:t.database}var tc=new WeakMap,Id=new WeakMap;function Rp(e){var t=e.database?e.database:e,r=e.database?e.name:"",n=(async()=>{var a=await a_(t.token,t.storage,t.name,r,t.instanceCreationOptions,t.multiInstance);a=wf(t,a,i_);var i=new mv("id",t.eventBulks$.pipe(tt(d=>{var h=!1;return(r===""&&!d.collectionName||r!==""&&d.collectionName===r)&&(h=!0),h&&d.events[0].isLocal}),bt(d=>d.events)),d=>pO(d,e)),s=new bv(a,"id",()=>{},()=>{}),o=await t.storageToken,c=a.changeStream().subscribe(d=>{for(var h=new Array(d.events.length),p=d.events,y=e.database?e.name:void 0,g=0;g<p.length;g++){var w=p[g];h[g]={documentId:w.documentId,collectionName:y,isLocal:!0,operation:w.operation,documentData:rt.deepFreezeWhenDevMode(w.documentData),previousDocumentData:rt.deepFreezeWhenDevMode(w.previousDocumentData)}}var b={id:d.id,internal:!1,collectionName:e.database?e.name:void 0,storageToken:o,events:h,databaseToken:t.token,checkpoint:d.checkpoint,context:d.context,endTime:d.endTime,startTime:d.startTime};t.$emit(b)});e._subs.push(c);var u={database:t,parent:e,storageInstance:a,docCache:i,incrementalWriteQueue:s};return Id.set(e,u),u})();tc.set(e,n)}function Ji(e){var t=tc.get(e);if(!t){var r=e.database?e.database:e,n=e.database?e.name:"";throw ye("LD8",{database:r.name,collection:n})}return t}function a_(e,t,r,n,a,i){return t.createStorageInstance({databaseInstanceToken:e,databaseName:r,collectionName:mO(n),schema:i_,options:a,multiInstance:i,devMode:rt.isDevMode()})}function $p(e){var t=tc.get(e);if(t)return tc.delete(e),t.then(r=>r.storageInstance.close())}async function Ap(e,t,r){var n=bs(10),a=await a_(n,e,t,r,{},!1);await a.remove()}function mO(e){return"plugin-local-documents-"+e}var i_=_c({title:"RxLocalDocument",version:0,primaryKey:"id",type:"object",properties:{id:{type:"string",maxLength:128},data:{type:"object",additionalProperties:!0}},required:["id","data"]});async function Cp(e,t){var r=await Ji(this),n={id:e,data:t,_deleted:!1,_meta:Ea(),_rev:yr(),_attachments:{}};return os(r.storageInstance,{document:n},"local-document-insert").then(a=>r.docCache.getCachedRxDocument(a))}function Pp(e,t){return this.getLocal(e).then(r=>{if(r)return r.incrementalModify(()=>t);var n=this.insertLocal(e,t);return n})}async function Np(e){var t=await Ji(this),r=t.docCache,n=r.getLatestDocumentDataIfExists(e);return n?Promise.resolve(r.getCachedRxDocument(n)):As(t.storageInstance,e).then(a=>a?t.docCache.getCachedRxDocument(a):null)}function Dp(e){return this.$.pipe(Ts(null),on(async t=>{if(t)return{changeEvent:t};var r=await this.getLocal(e);return{doc:r}}),on(async t=>{if(t.changeEvent){var r=t.changeEvent;if(!r.isLocal||r.documentId!==e)return{use:!1};var n=await this.getLocal(e);return{use:!0,doc:n}}else return{use:!0,doc:t.doc}}),tt(t=>t.use),bt(t=>t.doc))}var gO={name:"local-documents",rxdb:!0,prototypes:{RxCollection:e=>{e.insertLocal=Cp,e.upsertLocal=Pp,e.getLocal=Np,e.getLocal$=Dp},RxDatabase:e=>{e.insertLocal=Cp,e.upsertLocal=Pp,e.getLocal=Np,e.getLocal$=Dp}},hooks:{createRxDatabase:{before:e=>{e.creator.localDocuments&&Rp(e.database)}},createRxCollection:{before:e=>{e.creator.localDocuments&&Rp(e.collection)}},preDestroyRxDatabase:{after:e=>$p(e)},postDestroyRxCollection:{after:e=>$p(e)},postRemoveRxDatabase:{after:e=>Ap(e.storage,e.databaseName,"")},postRemoveRxCollection:{after:e=>Ap(e.storage,e.databaseName,e.collectionName)}},overwritable:{}},yO=new WeakMap,vO={name:"migration-schema",rxdb:!0,init(){kc(gO)},hooks:{preDestroyRxDatabase:{after:uO}},prototypes:{RxDatabase:e=>{e.migrationStates=function(){return n_(this).pipe(Os(Es))}},RxCollection:e=>{e.getMigrationState=function(){return an(yO,this,()=>new lO(this.asRxCollection,this.migrationStrategies))},e.migrationNeeded=function(){return this.schema.version===0?Or:t_(this.getMigrationState())}}}},_O=vO;const Rc=e=>Dt((t,r,n)=>{let a=0;if(r instanceof Array)for(const i of r)a=a|1<<i;else a=r;return e(t&a,a)}),wO=Rc((e,t)=>e==0),bO=Rc((e,t)=>e==t),EO=Rc((e,t)=>e<t),xO=Rc((e,t)=>e>0),SO=Object.freeze(Object.defineProperty({__proto__:null,$all:mS,$and:Jy,$bitsAllClear:wO,$bitsAllSet:bO,$bitsAnyClear:EO,$bitsAnySet:xO,$elemMatch:uv,$eq:Xy,$exists:dv,$expr:fS,$gt:ev,$gte:tv,$in:rv,$jsonSchema:hS,$lt:nv,$lte:av,$mod:ov,$ne:iv,$nin:sv,$nor:Qy,$not:Yy,$or:vf,$regex:cv,$size:lv,$type:fv,$where:pS},Symbol.toStringTag,{value:"Module"})),Tf=(e,t)=>{switch(e){case"deep":return cd(t);case"copy":return Ho(t)?new Date(t):vt(t)?[...t]:st(t)?{...t}:t;default:return t}},kO=/^[a-z]+[a-zA-Z0-9]*$/;function s_(e){if(!e.includes(".$"))return[{parent:e,selector:e},[]];const t=e.indexOf(".$"),r=e.indexOf("]"),n=e.substring(0,t),a=e.substring(t+3,r);yt(a===""||kO.test(a),"The filter <identifier> must begin with a lowercase letter and contain only alphanumeric characters.");const i=e.substring(r+2),[s,o]=i?s_(i):[];return[{selector:e,parent:n,child:a||"$",next:s},[a,...o||[]].filter(Boolean)]}const Jt=(e,t,r,n,a)=>{const{parent:i,child:s,next:o}=t;if(!s){let u=!1;return is(e,i,(h,p)=>u=!!n(h,p)||u,a),u}const c=mi(e,i);return vt(c)?c.map((u,d)=>r[s]&&!r[s].test({[s]:u})?!1:o?Jt(u,o,r,n,a):n(c,d)).some(Boolean):!1};function lr(e,t,r,n){const a=[];for(const[i,s]of Object.entries(e)){const[o,c]=s_(i);if(!c.length)n(s,o,{})&&a.push(o.parent);else{const u={};t.forEach(h=>{Object.keys(h).forEach(p=>{c.forEach(y=>{(p===y||p.startsWith(y+"."))&&(u[y]=u[y]||{},Object.assign(u[y],{[p]:h[p]}))})})});const d={};for(const[h,p]of Object.entries(u))d[h]=new ln(p,r.queryOptions);n(s,o,d)&&a.push(o.parent)}}return a}const IO=(e,t,r=[],n={})=>lr(t,r,n,(a,i,s)=>{const o={$each:[a]};return st(a)&&ar(a,"$each")&&Object.assign(o,a),Jt(e,i,s,(c,u)=>{const d=c[u]||=[];return gf([d,o.$each]).length===o.$each.length?!1:(c[u]=Tf(n.cloneMode,Ix(d.concat(o.$each))),!0)},{buildGraph:!0})}),OO=new Set(["and","or","xor"]),TO=(e,t,r=[],n={})=>lr(t,r,n,(a,i,s)=>{const o=Object.keys(a);return yt(o.length===1&&OO.has(o[0]),`Invalid bit operator '${o[0]}'. Must be one of 'and', 'or', or 'xor'.`),Jt(e,i,s,(c,u)=>{let d=c[u];const h=a[o[0]];if(d!==void 0&&!(rr(d)&&rr(h)))return!1;switch(d=d||0,o[0]){case"and":c[u]=d&h;break;case"or":c[u]=d|h;break;case"xor":c[u]=d^h;break}return c[u]!==d},{buildGraph:!0})}),RO=(e,t,r=[],n={})=>{const a=Date.now();return lr(t,r,n,(i,s,o)=>Jt(e,s,o,(c,u)=>(c[u]=a,!0),{buildGraph:!0}))},$O=(e,t,r=[],n={})=>lr(t,r,n,(a,i,s)=>{if(!i.child){const o=mi(e,i.parent);yt(o===void 0||rr(o),"cannot apply $inc to a value of non-numeric type")}return Jt(e,i,s,(o,c)=>(o[c]=(o[c]||=0)+a,!0),{buildGraph:!0})}),AO=(e,t,r=[],n={})=>lr(t,r,n,(a,i,s)=>Jt(e,i,s,(o,c)=>o[c]!==void 0&&Wt(o[c],a)>-1?!1:(o[c]=a,!0),{buildGraph:!0})),CO=(e,t,r=[],n={})=>lr(t,r,n,(a,i,s)=>Jt(e,i,s,(o,c)=>o[c]!==void 0&&Wt(o[c],a)<1?!1:(o[c]=a,!0),{buildGraph:!0})),PO=(e,t,r=[],n={})=>lr(t,r,n,(a,i,s)=>Jt(e,i,s,(o,c)=>{const u=o[c];return o[c]=o[c]===void 0?0:o[c]*a,o[c]!==u},{buildGraph:!0})),NO=(e,t,r=[],n={})=>lr(t,r,n,(a,i,s)=>Jt(e,i,s,(o,c)=>{const u=o[c];return yt(vt(u),`path '${i.selector}' contains an element of non-array type.`),u.length?(a===-1?u.splice(0,1):u.pop(),!0):!1})),o_=(e,t,r=[],n={})=>lr(t,r,n,(a,i,s)=>{const o=!st(a)||Object.keys(a).some(Ia),c=new ln(o?{k:a}:a,n.queryOptions),u=o?d=>c.test({k:d}):d=>c.test(d);return Jt(e,i,s,(d,h)=>{const p=d[h],y=new Array;return p.map(w=>{const b=u(w);return b||y.push(w),b}).some(Boolean)?(d[h]=y,!0):!1})}),DO=(e,t,r=[],n={})=>{const a={};return Object.entries(t).forEach(([i,s])=>{a[i]={$in:s}}),o_(e,a,r,n)},LO=Object.freeze(["$each","$slice","$sort","$position"]),MO=(e,t,r=[],n={})=>lr(t,r,n,(a,i,s)=>{const o={$each:[a]};return st(a)&&LO.some(c=>ar(a,c))&&Object.assign(o,a),Jt(e,i,s,(c,u)=>{const d=c[u]||=[],h=d.slice(0,o.$slice||d.length),p=d.length,y=rr(o.$position)?o.$position:d.length;if(d.splice(y,0,...Tf(n.cloneMode,o.$each)),o.$sort){const g=st(o.$sort)?Object.keys(o.$sort||{}).pop():"",w=g?o.$sort[g]:o.$sort,b=g?x=>mi(x,g):x=>x;d.sort((x,O)=>w*Wt(b(x),b(O)))}return rr(o.$slice)&&(o.$slice<0?d.splice(0,d.length+o.$slice):d.splice(o.$slice)),p!=d.length||!qr(h,d)},{descendArray:!0,buildGraph:!0})}),c_=(e,t,r=[],n={})=>lr(t,r,n,(a,i,s)=>Jt(e,i,s,(o,c)=>qr(o[c],a)?!1:(o[c]=Tf(n.cloneMode,a),!0),{buildGraph:!0})),jO=(e,t,r=[],n={})=>{const a=[],i=lr(t,r,n,(s,o,c)=>Jt(e,o,c,(u,d)=>ar(u,d)?(a.push(...c_(e,{[s]:u[d]},r,n)),delete u[d],!0):!1));return Array.from(new Set(i.concat(a)))},FO=(e,t,r=[],n={})=>lr(t,r,n,(a,i,s)=>Jt(e,i,s,(o,c)=>ar(o,c)?(vt(o)?o[c]=null:delete o[c],!0):!1)),Lp=Object.freeze(Object.defineProperty({__proto__:null,$addToSet:IO,$bit:TO,$currentDate:RO,$inc:$O,$max:AO,$min:CO,$mul:PO,$pop:NO,$pull:o_,$pullAll:DO,$push:MO,$rename:jO,$set:c_,$unset:FO},Symbol.toStringTag,{value:"Module"}));function u_(e){return e={...e,queryOptions:Ko(e.queryOptions)},e.queryOptions.context.addQueryOps(SO).addExpressionOps(eS).addExpressionOps(cS),(t,r,n=[],a={},i={})=>{const s=Object.assign({cloneMode:"copy"},e,i);Object.assign(s,{queryOptions:Ko(Object.assign({useStrictMode:!1},s?.queryOptions))}),n=n||[],a=a||{};const o=Object.entries(r);yt(o.length===1,"Update expression must contain only one operator.");const[c,u]=o[0];yt(ar(Lp,c),`Update operator '${c}' is not supported.`);const d=Lp[c];return Object.keys(a).length&&!(a instanceof ln?a:new ln(a,s.queryOptions)).test(t)?[]:d(t,u,n,s)}}u_({});var Mu;function l_(e,t){if(!Mu){var r=u_({cloneMode:"none"});Mu=(n,a)=>{var i=Ut(n);return r(i,a),i}}return Mu(e,t)}function BO(e){return this.incrementalModify(t=>{var r=l_(t,e);return r})}function UO(e){var t=this._data,r=l_(t,e);return this._saveData(r,t)}async function zO(e){return Ba(this.asRxQuery,t=>t.update(e))}var qO={name:"update",rxdb:!0,prototypes:{RxDocument:e=>{e.update=UO,e.incrementalUpdate=BO},RxQuery:e=>{e.update=zO}}};const Fa=$r("EmbeddingService");Zd.allowRemoteModels=!0;Zd.allowLocalModels=!1;Zd.remoteHost="https://huggingface.co";class HO{constructor(){this.modelName="Xenova/all-MiniLM-L6-v2",this.EMBEDDING_DIMENSION=384,this.DEFAULT_OPTIONS={pooling:"mean",normalize:!0}}async initialize(){if(this.pipePromise)try{await this.pipePromise;return}catch{Fa.warn("Previous initialization failed, retrying..."),this.pipePromise=void 0}Fa.info(`Initializing embedding service with model: ${this.modelName}`);try{this.pipePromise=fb("feature-extraction",this.modelName,{quantized:!1}),await this.pipePromise,Fa.info("Embedding service initialized successfully")}catch(t){const r=t?.message||String(t),n=t?JSON.stringify(t):"";throw Fa.error(`Failed to initialize embedding service: ${r}${n?` - ${n}`:""}`),this.pipePromise=void 0,new Error(`Embedding service initialization failed: ${r}`)}}async generateEmbedding(t,r={}){this.pipePromise||await this.initialize();const n=await this.pipePromise,a={...this.DEFAULT_OPTIONS,...r};try{const i=await n(t,{pooling:a.pooling,normalize:a.normalize}),s=Array.from(i.data);return s.length!==this.EMBEDDING_DIMENSION&&Fa.warn(`Unexpected embedding dimension: ${s.length}, expected ${this.EMBEDDING_DIMENSION}`),s}catch(i){throw Fa.error(`Failed to generate embedding: ${i}`),i}}async generateEmbeddings(t,r={}){const n=[];for(const a of t){const i=await this.generateEmbedding(a,r);n.push(i)}return n}getEmbeddingDimension(){return this.EMBEDDING_DIMENSION}getModelName(){return this.modelName}}const Ai=new HO,Ln={PREVIEW:500,CONTEXT:150},ea={FILE_NAME_MATCH:10,FILE_PATH_MATCH:5,CONTENT_MATCH:1,FILE_NAME_EXACT:20,FILE_PATH_EXACT:10,EXACT_PHRASE:5,TERM_COVERAGE:15},mo={DEFAULT_LIMIT:5,MAX_LIMIT:20},KO={SAMPLE_VECTOR_COUNT:5},Bi=["idx0","idx1","idx2","idx3","idx4"],GO={LONG:1e3};function WO(e,t){if(e.length!==t.length)throw new Error(`Vector dimensions must match: ${e.length} vs ${t.length}`);let r=0;for(let n=0;n<e.length;n++){const a=e[n]-t[n];r+=a*a}return Math.sqrt(r)}function VO(e,t,r){const n=[];if(r&&r.length>0)for(let a=0;a<e;a++)if(a<r.length)n.push({vector:r[a],idx:a});else{const i=[];for(let s=0;s<t;s++)i.push(Math.random()*2-1);n.push({vector:i,idx:a})}else for(let a=0;a<e;a++){const i=[];for(let s=0;s<t;s++)i.push(Math.random()*2-1);n.push({vector:i,idx:a})}return n}function Mp(e,t){if(t.length!==Bi.length)throw new Error(`Sample vectors count (${t.length}) must match index field count (${Bi.length})`);const r={};for(let n=0;n<Bi.length;n++)r[Bi[n]]=WO(e,t[n].vector);return r}function ZO(e,t){if(e.length!==t.length)throw new Error(`Vector dimensions must match: ${e.length} vs ${t.length}`);let r=0,n=0,a=0;for(let s=0;s<e.length;s++)r+=e[s]*t[s],n+=e[s]*e[s],a+=t[s]*t[s];const i=Math.sqrt(n)*Math.sqrt(a);return i===0?0:r/i}const JO=500,QO=50,YO=100;class jp{constructor(t={}){this.chunkSize=t.chunkSize??JO,this.chunkOverlap=t.chunkOverlap??QO,this.minChunkSize=t.minChunkSize??YO}chunkDocument(t,r,n){if(r.length<=this.chunkSize){const c=`${n} ${r}`;return[{id:`${t}:chunk:0`,documentId:t,chunkIndex:0,text:c,startOffset:0,endOffset:r.length}]}const a=[],i=this.chunkSize-this.chunkOverlap;let s=0,o=0;for(;s<r.length;){const c=Math.min(s+this.chunkSize,r.length),u=r.substring(s,c);if(u.trim().length<this.minChunkSize&&a.length>0)break;const d=o===0?`${n} ${u}`:u;a.push({id:`${t}:chunk:${o}`,documentId:t,chunkIndex:o,text:d,startOffset:s,endOffset:c}),s+=i,o++}return a}getChunkContext(t,r){const n=t.chunkIndex>0?r[t.chunkIndex-1]:null,a=t.chunkIndex<r.length-1?r[t.chunkIndex+1]:null;let i="";return n&&(i+=`[Previous: ${n.text.substring(Math.max(0,n.text.length-Ln.CONTEXT))}]

`),i+=t.text,a&&(i+=`

[Next: ${a.text.substring(0,Ln.CONTEXT)}]`),i}}var XO=Object.defineProperty,Et=(e,t)=>{for(var r in t)XO(e,r,{get:t[r],enumerable:!0})},d_=class{pageContent;metadata;id;constructor(e){this.pageContent=e.pageContent!==void 0?e.pageContent.toString():"",this.metadata=e.metadata??{},this.id=e.id}},ju,Fp;function eT(){return Fp||(Fp=1,ju=function(e,t){if(typeof e!="string")throw new TypeError("Expected a string");return t=typeof t>"u"?"_":t,e.replace(/([a-z\d])([A-Z])/g,"$1"+t+"$2").replace(/([A-Z]+)([A-Z][a-z\d]+)/g,"$1"+t+"$2").toLowerCase()}),ju}var tT=eT();const rT=fi(tT);var go={exports:{}},Bp;function nT(){if(Bp)return go.exports;Bp=1;const e=/[\p{Lu}]/u,t=/[\p{Ll}]/u,r=/^[\p{Lu}](?![\p{Lu}])/gu,n=/([\p{Alpha}\p{N}_]|$)/u,a=/[_.\- ]+/,i=new RegExp("^"+a.source),s=new RegExp(a.source+n.source,"gu"),o=new RegExp("\\d+"+n.source,"gu"),c=(p,y,g)=>{let w=!1,b=!1,x=!1;for(let O=0;O<p.length;O++){const T=p[O];w&&e.test(T)?(p=p.slice(0,O)+"-"+p.slice(O),w=!1,x=b,b=!0,O++):b&&x&&t.test(T)?(p=p.slice(0,O-1)+"-"+p.slice(O-1),x=b,b=!1,w=!0):(w=y(T)===T&&g(T)!==T,x=b,b=g(T)===T&&y(T)!==T)}return p},u=(p,y)=>(r.lastIndex=0,p.replace(r,g=>y(g))),d=(p,y)=>(s.lastIndex=0,o.lastIndex=0,p.replace(s,(g,w)=>y(w)).replace(o,g=>y(g))),h=(p,y)=>{if(!(typeof p=="string"||Array.isArray(p)))throw new TypeError("Expected the input to be `string | string[]`");if(y={pascalCase:!1,preserveConsecutiveUppercase:!1,...y},Array.isArray(p)?p=p.map(x=>x.trim()).filter(x=>x.length).join("-"):p=p.trim(),p.length===0)return"";const g=y.locale===!1?x=>x.toLowerCase():x=>x.toLocaleLowerCase(y.locale),w=y.locale===!1?x=>x.toUpperCase():x=>x.toLocaleUpperCase(y.locale);return p.length===1?y.pascalCase?w(p):g(p):(p!==g(p)&&(p=c(p,g,w)),p=p.replace(i,""),y.preserveConsecutiveUppercase?p=u(p,g):p=g(p),y.pascalCase&&(p=w(p.charAt(0))+p.slice(1)),d(p,w))};return go.exports=h,go.exports.default=h,go.exports}nT();function aT(e,t){return t?.[e]||rT(e)}function iT(e,t,r){const n={};for(const a in e)Object.hasOwn(e,a)&&(n[t(a,r)]=e[a]);return n}var sT={};Et(sT,{Serializable:()=>us,get_lc_unique_name:()=>Rf});function Up(e){return Array.isArray(e)?[...e]:{...e}}function oT(e,t){const r=Up(e);for(const[n,a]of Object.entries(t)){const[i,...s]=n.split(".").reverse();let o=r;for(const c of s.reverse()){if(o[c]===void 0)break;o[c]=Up(o[c]),o=o[c]}o[i]!==void 0&&(o[i]={lc:1,type:"secret",id:[a]})}return r}function Rf(e){const t=Object.getPrototypeOf(e);return typeof e.lc_name=="function"&&(typeof t.lc_name!="function"||e.lc_name()!==t.lc_name())?e.lc_name():e.name}var us=class f_{lc_serializable=!1;lc_kwargs;static lc_name(){return this.name}get lc_id(){return[...this.lc_namespace,Rf(this.constructor)]}get lc_secrets(){}get lc_attributes(){}get lc_aliases(){}get lc_serializable_keys(){}constructor(t,...r){this.lc_serializable_keys!==void 0?this.lc_kwargs=Object.fromEntries(Object.entries(t||{}).filter(([n])=>this.lc_serializable_keys?.includes(n))):this.lc_kwargs=t??{}}toJSON(){if(!this.lc_serializable)return this.toJSONNotImplemented();if(this.lc_kwargs instanceof f_||typeof this.lc_kwargs!="object"||Array.isArray(this.lc_kwargs))return this.toJSONNotImplemented();const t={},r={},n=Object.keys(this.lc_kwargs).reduce((a,i)=>(a[i]=i in this?this[i]:this.lc_kwargs[i],a),{});for(let a=Object.getPrototypeOf(this);a;a=Object.getPrototypeOf(a))Object.assign(t,Reflect.get(a,"lc_aliases",this)),Object.assign(r,Reflect.get(a,"lc_secrets",this)),Object.assign(n,Reflect.get(a,"lc_attributes",this));return Object.keys(r).forEach(a=>{let i=this,s=n;const[o,...c]=a.split(".").reverse();for(const u of c.reverse()){if(!(u in i)||i[u]===void 0)return;(!(u in s)||s[u]===void 0)&&(typeof i[u]=="object"&&i[u]!=null?s[u]={}:Array.isArray(i[u])&&(s[u]=[])),i=i[u],s=s[u]}o in i&&i[o]!==void 0&&(s[o]=s[o]||i[o])}),{lc:1,type:"constructor",id:this.lc_id,kwargs:iT(Object.keys(r).length?oT(n,r):n,aT,t)}}toJSONNotImplemented(){return{lc:1,type:"not_implemented",id:this.lc_id}}};function cT(e){return!!(e&&typeof e=="object"&&"type"in e&&e.type==="tool_call")}var uT=class extends Error{output;constructor(e,t){super(e),this.output=t}};const h_=Symbol.for("ls:tracing_async_local_storage"),Qi=Symbol.for("lc:context_variables"),lT=e=>{globalThis[h_]=e},ls=()=>globalThis[h_];function ds(e){return typeof e=="object"&&e!==null&&"type"in e&&typeof e.type=="string"&&"source_type"in e&&(e.source_type==="url"||e.source_type==="base64"||e.source_type==="text"||e.source_type==="id")}function dT(e){return ds(e)&&e.source_type==="url"&&"url"in e&&typeof e.url=="string"}function fT(e){return ds(e)&&e.source_type==="base64"&&"data"in e&&typeof e.data=="string"}function hT(e){return ds(e)&&e.source_type==="id"&&"id"in e&&typeof e.id=="string"}function zp({dataUrl:e,asTypedArray:t=!1}){const r=e.match(/^data:(\w+\/\w+);base64,([A-Za-z0-9+/]+=*)$/);let n;if(r){n=r[1].toLowerCase();const a=t?Uint8Array.from(atob(r[2]),i=>i.charCodeAt(0)):r[2];return{mime_type:n,data:a}}}function Ee(e,t){return Ce(e)&&e.type===t}function Ce(e){return typeof e=="object"&&e!==null}function Ur(e){return Array.isArray(e)}function he(e){return typeof e=="string"}function kr(e){return typeof e=="number"}function $f(e){return e instanceof Uint8Array}function qp(e){try{return JSON.parse(e)}catch{return}}const fs=e=>e();function pT(e){if(e.type==="char_location"&&he(e.document_title)&&kr(e.start_char_index)&&kr(e.end_char_index)&&he(e.cited_text)){const{document_title:t,start_char_index:r,end_char_index:n,cited_text:a,...i}=e;return{...i,type:"citation",source:"char",title:t??void 0,startIndex:r,endIndex:n,citedText:a}}if(e.type==="page_location"&&he(e.document_title)&&kr(e.start_page_number)&&kr(e.end_page_number)&&he(e.cited_text)){const{document_title:t,start_page_number:r,end_page_number:n,cited_text:a,...i}=e;return{...i,type:"citation",source:"page",title:t??void 0,startIndex:r,endIndex:n,citedText:a}}if(e.type==="content_block_location"&&he(e.document_title)&&kr(e.start_block_index)&&kr(e.end_block_index)&&he(e.cited_text)){const{document_title:t,start_block_index:r,end_block_index:n,cited_text:a,...i}=e;return{...i,type:"citation",source:"block",title:t??void 0,startIndex:r,endIndex:n,citedText:a}}if(e.type==="web_search_result_location"&&he(e.url)&&he(e.title)&&he(e.encrypted_index)&&he(e.cited_text)){const{url:t,title:r,encrypted_index:n,cited_text:a,...i}=e;return{...i,type:"citation",source:"url",url:t,title:r,startIndex:Number(n),endIndex:Number(n),citedText:a}}if(e.type==="search_result_location"&&he(e.source)&&he(e.title)&&kr(e.start_block_index)&&kr(e.end_block_index)&&he(e.cited_text)){const{source:t,title:r,start_block_index:n,end_block_index:a,cited_text:i,...s}=e;return{...s,type:"citation",source:"search",url:t,title:r??void 0,startIndex:n,endIndex:a,citedText:i}}}function p_(e){if(Ee(e,"document")&&Ce(e.source)&&"type"in e.source){if(e.source.type==="base64"&&he(e.source.media_type)&&he(e.source.data))return{type:"file",mimeType:e.source.media_type,data:e.source.data};if(e.source.type==="url"&&he(e.source.url))return{type:"file",url:e.source.url};if(e.source.type==="file"&&he(e.source.file_id))return{type:"file",fileId:e.source.file_id};if(e.source.type==="text"&&he(e.source.data))return{type:"file",mimeType:String(e.source.media_type??"text/plain"),data:e.source.data}}else if(Ee(e,"image")&&Ce(e.source)&&"type"in e.source){if(e.source.type==="base64"&&he(e.source.media_type)&&he(e.source.data))return{type:"image",mimeType:e.source.media_type,data:e.source.data};if(e.source.type==="url"&&he(e.source.url))return{type:"image",url:e.source.url};if(e.source.type==="file"&&he(e.source.file_id))return{type:"image",fileId:e.source.file_id}}}function mT(e){function*t(){for(const r of e){const n=p_(r);n?yield n:yield r}}return Array.from(t())}function Hp(e){function*t(){const r=typeof e.content=="string"?[{type:"text",text:e.content}]:e.content;for(const n of r){if(Ee(n,"text")&&he(n.text)){const{text:a,citations:i,...s}=n;if(Ur(i)&&i.length){const o=i.reduce((c,u)=>{const d=pT(u);return d?[...c,d]:c},[]);yield{...s,type:"text",text:a,annotations:o};continue}else{yield{...s,type:"text",text:a};continue}}else if(Ee(n,"thinking")&&he(n.thinking)){const{thinking:a,signature:i,...s}=n;yield{...s,type:"reasoning",reasoning:a,signature:i};continue}else if(Ee(n,"redacted_thinking")){yield{type:"non_standard",value:n};continue}else if(Ee(n,"tool_use")&&he(n.name)&&he(n.id)){yield{type:"tool_call",id:n.id,name:n.name,args:n.input};continue}else if(Ee(n,"input_json_delta")){if(yT(e)&&e.tool_call_chunks?.length){const a=e.tool_call_chunks[0];yield{type:"tool_call_chunk",id:a.id,name:a.name,args:a.args,index:a.index};continue}}else if(Ee(n,"server_tool_use")&&he(n.name)&&he(n.id)){const{name:a,id:i}=n;if(a==="web_search"){const s=fs(()=>{if(typeof n.input=="string")return n.input;if(Ce(n.input)&&he(n.input.query))return n.input.query;if(he(n.partial_json)){const o=qp(n.partial_json);if(o?.query)return o.query}return""});yield{id:i,type:"server_tool_call",name:"web_search",args:{query:s}};continue}else if(n.name==="code_execution"){const s=fs(()=>{if(typeof n.input=="string")return n.input;if(Ce(n.input)&&he(n.input.code))return n.input.code;if(he(n.partial_json)){const o=qp(n.partial_json);if(o?.code)return o.code}return""});yield{id:i,type:"server_tool_call",name:"code_execution",args:{code:s}};continue}}else if(Ee(n,"web_search_tool_result")&&he(n.tool_use_id)&&Ur(n.content)){const{content:a,tool_use_id:i}=n,s=a.reduce((o,c)=>Ee(c,"web_search_result")?[...o,c.url]:o,[]);yield{type:"server_tool_call_result",name:"web_search",toolCallId:i,status:"success",output:{urls:s}};continue}else if(Ee(n,"code_execution_tool_result")&&he(n.tool_use_id)&&Ce(n.content)){yield{type:"server_tool_call_result",name:"code_execution",toolCallId:n.tool_use_id,status:"success",output:n.content};continue}else if(Ee(n,"mcp_tool_use")){yield{id:n.id,type:"server_tool_call",name:"mcp_tool_use",args:n.input};continue}else if(Ee(n,"mcp_tool_result")&&he(n.tool_use_id)&&Ce(n.content)){yield{type:"server_tool_call_result",name:"mcp_tool_use",toolCallId:n.tool_use_id,status:"success",output:n.content};continue}else if(Ee(n,"container_upload")){yield{type:"server_tool_call",name:"container_upload",args:n.input};continue}else if(Ee(n,"search_result")){yield{id:n.id,type:"non_standard",value:n};continue}else if(Ee(n,"tool_result")){yield{id:n.id,type:"non_standard",value:n};continue}else{const a=p_(n);if(a){yield a;continue}}yield{type:"non_standard",value:n}}}return Array.from(t())}const gT={translateContent:Hp,translateContentChunk:Hp};function yT(e){return typeof e?._getType=="function"&&typeof e.concat=="function"&&e._getType()==="ai"}function vT(e){return dT(e)?{type:e.type,mimeType:e.mime_type,url:e.url,metadata:e.metadata}:fT(e)?{type:e.type,mimeType:e.mime_type??"application/octet-stream",data:e.data,metadata:e.metadata}:hT(e)?{type:e.type,mimeType:e.mime_type,fileId:e.id,metadata:e.metadata}:e}function _T(e){return e.map(vT)}function wT(e){return!!(Ee(e,"image_url")&&Ce(e.image_url)||Ee(e,"input_audio")&&Ce(e.input_audio)||Ee(e,"file")&&Ce(e.file))}function bT(e){if(Ee(e,"image_url")&&Ce(e.image_url)&&he(e.image_url.url)){const t=zp({dataUrl:e.image_url.url});return t?{type:"image",mimeType:t.mime_type,data:t.data}:{type:"image",url:e.image_url.url}}else{if(Ee(e,"input_audio")&&Ce(e.input_audio)&&he(e.input_audio.data)&&he(e.input_audio.format))return{type:"audio",data:e.input_audio.data,mimeType:`audio/${e.input_audio.format}`};if(Ee(e,"file")&&Ce(e.file)&&he(e.file.data)){const t=zp({dataUrl:e.file.data});if(t)return{type:"file",data:t.data,mimeType:t.mime_type};if(he(e.file.file_id))return{type:"file",fileId:e.file.file_id}}}return e}function ET(e){const t=[];typeof e.content=="string"?t.push({type:"text",text:e.content}):t.push(...Af(e.content));for(const r of e.tool_calls??[])t.push({type:"tool_call",id:r.id,name:r.name,args:r.args});return t}function xT(e){const t=[];typeof e.content=="string"?t.push({type:"text",text:e.content}):t.push(...Af(e.content));for(const r of e.tool_calls??[])t.push({type:"tool_call",id:r.id,name:r.name,args:r.args});return t}function Af(e){const t=[];for(const r of e)wT(r)?t.push(bT(r)):t.push(r);return t}function ST(e){if(e.type==="url_citation"){const{url:t,title:r,start_index:n,end_index:a}=e;return{type:"citation",url:t,title:r,startIndex:n,endIndex:a}}if(e.type==="file_citation"){const{file_id:t,filename:r,index:n}=e;return{type:"citation",title:r,startIndex:n,endIndex:n,fileId:t}}return e}function m_(e){function*t(){Ce(e.additional_kwargs?.reasoning)&&Ur(e.additional_kwargs.reasoning.summary)&&(yield{type:"reasoning",reasoning:e.additional_kwargs.reasoning.summary.reduce((a,i)=>Ce(i)&&he(i.text)?`${a}${i.text}`:a,"")});const r=typeof e.content=="string"?[{type:"text",text:e.content}]:e.content;for(const n of r)if(Ee(n,"text")){const{text:a,annotations:i,...s}=n;Array.isArray(i)?yield{...s,type:"text",text:String(a),annotations:i.map(ST)}:yield{...s,type:"text",text:String(a)}}for(const n of e.tool_calls??[])yield{type:"tool_call",id:n.id,name:n.name,args:n.args};if(Ce(e.additional_kwargs)&&Ur(e.additional_kwargs.tool_outputs))for(const n of e.additional_kwargs.tool_outputs){if(Ee(n,"web_search_call")){yield{id:n.id,type:"server_tool_call",name:"web_search",args:{query:n.query}};continue}else if(Ee(n,"file_search_call")){yield{id:n.id,type:"server_tool_call",name:"file_search",args:{query:n.query}};continue}else if(Ee(n,"computer_call")){yield{type:"non_standard",value:n};continue}else if(Ee(n,"code_interpreter_call")){if(he(n.code)&&(yield{id:n.id,type:"server_tool_call",name:"code_interpreter",args:{code:n.code}}),Ur(n.outputs)){const a=fs(()=>{if(n.status!=="in_progress"){if(n.status==="completed")return 0;if(n.status==="incomplete")return 127;if(n.status!=="interpreting"&&n.status==="failed")return 1}});for(const i of n.outputs)if(Ee(i,"logs")){yield{type:"server_tool_call_result",toolCallId:n.id??"",status:"success",output:{type:"code_interpreter_output",returnCode:a??0,stderr:[0,void 0].includes(a)?void 0:String(i.logs),stdout:[0,void 0].includes(a)?String(i.logs):void 0}};continue}}continue}else if(Ee(n,"mcp_call")){yield{id:n.id,type:"server_tool_call",name:"mcp_call",args:n.input};continue}else if(Ee(n,"mcp_list_tools")){yield{id:n.id,type:"server_tool_call",name:"mcp_list_tools",args:n.input};continue}else if(Ee(n,"mcp_approval_request")){yield{type:"non_standard",value:n};continue}else if(Ee(n,"image_generation_call")){yield{type:"non_standard",value:n};continue}Ce(n)&&(yield{type:"non_standard",value:n})}}return Array.from(t())}function kT(e){function*t(){yield*m_(e);for(const r of e.tool_call_chunks??[])yield{type:"tool_call_chunk",id:r.id,name:r.name,args:r.args}}return Array.from(t())}const IT={translateContent:e=>typeof e.content=="string"?ET(e):m_(e),translateContentChunk:e=>typeof e.content=="string"?xT(e):kT(e)};function OT(e){return typeof e=="object"&&e!==null&&"type"in e&&"content"in e&&(typeof e.content=="string"||Array.isArray(e.content))}function TT(e,t="pretty"){return t==="pretty"?RT(e):JSON.stringify(e)}function RT(e){const t=[],r=` ${e.type.charAt(0).toUpperCase()+e.type.slice(1)} Message `,n=Math.floor((80-r.length)/2),a="=".repeat(n),i=r.length%2===0?a:`${a}=`;if(t.push(`${a}${r}${i}`),e.type==="ai"){const s=e;if(s.tool_calls&&s.tool_calls.length>0){t.push("Tool Calls:");for(const o of s.tool_calls){t.push(`  ${o.name} (${o.id})`),t.push(` Call ID: ${o.id}`),t.push("  Args:");for(const[c,u]of Object.entries(o.args))t.push(`    ${c}: ${u}`)}}}if(e.type==="tool"){const s=e;s.name&&t.push(`Name: ${s.name}`)}return typeof e.content=="string"&&e.content.trim()&&(t.length>1&&t.push(""),t.push(e.content)),t.join(`
`)}const Fu=Symbol.for("langchain.message");function g_(e,t){return typeof e=="string"?e===""?t:typeof t=="string"?e+t:Array.isArray(t)&&t.some(r=>ds(r))?[{type:"text",source_type:"text",text:e},...t]:[{type:"text",text:e},...t]:Array.isArray(t)?$c(e,t)??[...e,...t]:t===""?e:Array.isArray(e)&&e.some(r=>ds(r))?[...e,{type:"file",source_type:"text",text:t}]:[...e,{type:"text",text:t}]}function $T(e,t){return e==="error"||t==="error"?"error":"success"}function AT(e,t){function r(n,a){if(typeof n!="object"||n===null||n===void 0)return n;if(a>=t)return Array.isArray(n)?"[Array]":"[Object]";if(Array.isArray(n))return n.map(s=>r(s,a+1));const i={};for(const s of Object.keys(n))i[s]=r(n[s],a+1);return i}return JSON.stringify(r(e,0),null,2)}var y_=class extends us{lc_namespace=["langchain_core","messages"];lc_serializable=!0;get lc_aliases(){return{additional_kwargs:"additional_kwargs",response_metadata:"response_metadata"}}[Fu]=!0;id;name;content;additional_kwargs;response_metadata;_getType(){return this.type}getType(){return this._getType()}constructor(e){const t=typeof e=="string"||Array.isArray(e)?{content:e}:e;t.additional_kwargs||(t.additional_kwargs={}),t.response_metadata||(t.response_metadata={}),super(t),this.name=t.name,t.content===void 0&&t.contentBlocks!==void 0?(this.content=t.contentBlocks,this.response_metadata={output_version:"v1",...t.response_metadata}):t.content!==void 0?(this.content=t.content??[],this.response_metadata=t.response_metadata):(this.content=[],this.response_metadata=t.response_metadata),this.additional_kwargs=t.additional_kwargs,this.id=t.id}get text(){return typeof this.content=="string"?this.content:Array.isArray(this.content)?this.content.map(e=>typeof e=="string"?e:e.type==="text"?e.text:"").join(""):""}get contentBlocks(){const e=typeof this.content=="string"?[{type:"text",text:this.content}]:this.content;return[_T,Af,mT].reduce((n,a)=>a(n),e)}toDict(){return{type:this.getType(),data:this.toJSON().kwargs}}static lc_name(){return"BaseMessage"}get _printableFields(){return{id:this.id,content:this.content,name:this.name,additional_kwargs:this.additional_kwargs,response_metadata:this.response_metadata}}static isInstance(e){return typeof e=="object"&&e!==null&&Fu in e&&e[Fu]===!0&&OT(e)}_updateId(e){this.id=e,this.lc_kwargs.id=e}get[Symbol.toStringTag](){return this.constructor.lc_name()}[Symbol.for("nodejs.util.inspect.custom")](e){if(e===null)return this;const t=AT(this._printableFields,Math.max(4,e));return`${this.constructor.lc_name()} ${t}`}toFormattedString(e="pretty"){return TT(this,e)}};function _a(e={},t={}){const r={...e};for(const[n,a]of Object.entries(t))if(r[n]==null)r[n]=a;else{if(a==null)continue;if(typeof r[n]!=typeof a||Array.isArray(r[n])!==Array.isArray(a))throw new Error(`field[${n}] already exists in the message chunk, but with a different type.`);if(typeof r[n]=="string"){if(n==="type")continue;["id","name","output_version","model_provider"].includes(n)?r[n]=a:r[n]+=a}else if(typeof r[n]=="object"&&!Array.isArray(r[n]))r[n]=_a(r[n],a);else if(Array.isArray(r[n]))r[n]=$c(r[n],a);else{if(r[n]===a)continue;console.warn(`field[${n}] already exists in this message chunk and value has unsupported type.`)}}return r}function $c(e,t){if(!(e===void 0&&t===void 0)){if(e===void 0||t===void 0)return e||t;{const r=[...e];for(const n of t)if(typeof n=="object"&&n!==null&&"index"in n&&typeof n.index=="number"){const a=r.findIndex(i=>{const s=typeof i=="object",o="index"in i&&i.index===n.index,c="id"in i&&"id"in n&&i?.id===n?.id,u=!("id"in i)||!i?.id||!("id"in n)||!n?.id;return s&&o&&(c||u)});a!==-1&&typeof r[a]=="object"&&r[a]!==null?r[a]=_a(r[a],n):r.push(n)}else{if(typeof n=="object"&&n!==null&&"text"in n&&n.text==="")continue;r.push(n)}return r}}}function CT(e,t){if(!e&&!t)throw new Error("Cannot merge two undefined objects.");if(!e||!t)return e||t;if(typeof e!=typeof t)throw new Error(`Cannot merge objects of different types.
Left ${typeof e}
Right ${typeof t}`);if(typeof e=="string"&&typeof t=="string")return e+t;if(Array.isArray(e)&&Array.isArray(t))return $c(e,t);if(typeof e=="object"&&typeof t=="object")return _a(e,t);if(e===t)return e;throw new Error(`Can not merge objects of different types.
Left ${e}
Right ${t}`)}var v_=class extends y_{static isInstance(e){return super.isInstance(e)&&"concat"in e&&typeof e.concat=="function"}},PT={};Et(PT,{ToolMessage:()=>DT,ToolMessageChunk:()=>LT,defaultToolCallParser:()=>MT,isDirectToolOutput:()=>NT,isToolMessage:()=>jT,isToolMessageChunk:()=>FT});function NT(e){return e!=null&&typeof e=="object"&&"lc_direct_tool_output"in e&&e.lc_direct_tool_output===!0}var DT=class extends y_{static lc_name(){return"ToolMessage"}get lc_aliases(){return{tool_call_id:"tool_call_id"}}lc_direct_tool_output=!0;type="tool";status;tool_call_id;metadata;artifact;constructor(e,t,r){const n=typeof e=="string"||Array.isArray(e)?{content:e,name:r,tool_call_id:t}:e;super(n),this.tool_call_id=n.tool_call_id,this.artifact=n.artifact,this.status=n.status,this.metadata=n.metadata}static isInstance(e){return super.isInstance(e)&&e.type==="tool"}get _printableFields(){return{...super._printableFields,tool_call_id:this.tool_call_id,artifact:this.artifact}}},LT=class extends v_{type="tool";tool_call_id;status;artifact;constructor(e){super(e),this.tool_call_id=e.tool_call_id,this.artifact=e.artifact,this.status=e.status}static lc_name(){return"ToolMessageChunk"}concat(e){const t=this.constructor;return new t({content:g_(this.content,e.content),additional_kwargs:_a(this.additional_kwargs,e.additional_kwargs),response_metadata:_a(this.response_metadata,e.response_metadata),artifact:CT(this.artifact,e.artifact),tool_call_id:this.tool_call_id,id:this.id??e.id,status:$T(this.status,e.status)})}get _printableFields(){return{...super._printableFields,tool_call_id:this.tool_call_id,artifact:this.artifact}}};function MT(e){const t=[],r=[];for(const n of e)if(n.function){const a=n.function.name;try{const i=JSON.parse(n.function.arguments);t.push({name:a||"",args:i||{},id:n.id})}catch{r.push({name:a,args:n.function.arguments,id:n.id,error:"Malformed args."})}}else continue;return[t,r]}function jT(e){return typeof e=="object"&&e!==null&&"getType"in e&&typeof e.getType=="function"&&e.getType()==="tool"}function FT(e){return e._getType()==="tool"}function BT(e){if(typeof e>"u")return null;try{return JSON.parse(e)}catch{}let t="";const r=[];let n=!1,a=!1;for(let i of e){if(n)i==='"'&&!a?n=!1:i===`
`&&!a?i="\\n":i==="\\"?a=!a:a=!1;else if(i==='"')n=!0,a=!1;else if(i==="{")r.push("}");else if(i==="[")r.push("]");else if(i==="}"||i==="]")if(r&&r[r.length-1]===i)r.pop();else return null;t+=i}n&&(t+='"');for(let i=r.length-1;i>=0;i-=1)t+=r[i];try{return JSON.parse(t)}catch{return null}}function Cf(e){switch(e){case"csv":return"text/csv";case"doc":return"application/vnd.openxmlformats-officedocument.wordprocessingml.document";case"docx":return"application/vnd.openxmlformats-officedocument.wordprocessingml.document";case"html":return"text/html";case"md":return"text/markdown";case"pdf":return"application/pdf";case"txt":return"text/plain";case"xls":return"application/vnd.ms-excel";case"xlsx":return"application/vnd.openxmlformats-officedocument.spreadsheetml.sheet";case"gif":return"image/gif";case"jpeg":return"image/jpeg";case"jpg":return"image/jpeg";case"png":return"image/png";case"webp":return"image/webp";case"flv":return"video/flv";case"mkv":return"video/mkv";case"mov":return"video/mov";case"mp4":return"video/mp4";case"mpeg":return"video/mpeg";case"mpg":return"video/mpg";case"three_gp":return"video/three_gp";case"webm":return"video/webm";case"wmv":return"video/wmv";default:return"application/octet-stream"}}function UT(e){if(Ce(e.document)&&Ce(e.document.source)){const t=Ce(e.document)&&he(e.document.format)?e.document.format:"",r=Cf(t);if(Ce(e.document.source)){if(Ce(e.document.source.s3Location)&&he(e.document.source.s3Location.uri))return{type:"file",mimeType:r,fileId:e.document.source.s3Location.uri};if($f(e.document.source.bytes))return{type:"file",mimeType:r,data:e.document.source.bytes};if(he(e.document.source.text))return{type:"file",mimeType:r,data:Buffer.from(e.document.source.text).toString("base64")};if(Ur(e.document.source.content)){const n=e.document.source.content.reduce((a,i)=>Ce(i)&&he(i.text)?a+i.text:a,"");return{type:"file",mimeType:r,data:n}}}}return{type:"non_standard",value:e}}function zT(e){if(Ee(e,"image")&&Ce(e.image)){const t=Ce(e.image)&&he(e.image.format)?e.image.format:"",r=Cf(t);if(Ce(e.image.source)){if(Ce(e.image.source.s3Location)&&he(e.image.source.s3Location.uri))return{type:"image",mimeType:r,fileId:e.image.source.s3Location.uri};if($f(e.image.source.bytes))return{type:"image",mimeType:r,data:e.image.source.bytes}}}return{type:"non_standard",value:e}}function qT(e){if(Ee(e,"video")&&Ce(e.video)){const t=Ce(e.video)&&he(e.video.format)?e.video.format:"",r=Cf(t);if(Ce(e.video.source)){if(Ce(e.video.source.s3Location)&&he(e.video.source.s3Location.uri))return{type:"video",mimeType:r,fileId:e.video.source.s3Location.uri};if($f(e.video.source.bytes))return{type:"video",mimeType:r,data:e.video.source.bytes}}}return{type:"non_standard",value:e}}function Kp(e){function*t(){const r=typeof e.content=="string"?[{type:"text",text:e.content}]:e.content;for(const n of r){if(Ee(n,"cache_point")){yield{type:"non_standard",value:n};continue}else if(Ee(n,"citations_content")&&Ce(n.citationsContent)){const a=Ur(n.citationsContent.content)?n.citationsContent.content.reduce((s,o)=>Ce(o)&&he(o.text)?s+o.text:s,""):"",i=Ur(n.citationsContent.citations)?n.citationsContent.citations.reduce((s,o)=>{if(Ce(o)){const c=Ur(o.sourceContent)?o.sourceContent.reduce((d,h)=>Ce(h)&&he(h.text)?d+h.text:d,""):"",u=fs(()=>{if(Ce(o.location)){const d=o.location.documentChar||o.location.documentPage||o.location.documentChunk;if(Ce(d))return{source:kr(d.documentIndex)?d.documentIndex.toString():void 0,startIndex:kr(d.start)?d.start:void 0,endIndex:kr(d.end)?d.end:void 0}}return{}});s.push({type:"citation",citedText:c,...u})}return s},[]):[];yield{type:"text",text:a,annotations:i};continue}else if(Ee(n,"document")&&Ce(n.document)){yield UT(n);continue}else if(Ee(n,"guard_content")){yield{type:"non_standard",value:n};continue}else if(Ee(n,"image")&&Ce(n.image)){yield zT(n);continue}else if(Ee(n,"reasoning_content")&&he(n.reasoningText)){yield{type:"reasoning",reasoning:n.reasoningText};continue}else if(Ee(n,"text")&&he(n.text)){yield{type:"text",text:n.text};continue}else if(Ee(n,"tool_result")){yield{type:"non_standard",value:n};continue}else{if(Ee(n,"tool_call"))continue;if(Ee(n,"video")&&Ce(n.video)){yield qT(n);continue}}yield{type:"non_standard",value:n}}}return Array.from(t())}const HT={translateContent:Kp,translateContentChunk:Kp};function Gp(e){function*t(){const r=typeof e.content=="string"?[{type:"text",text:e.content}]:e.content;for(const n of r){if(Ee(n,"text")&&he(n.text)){yield{type:"text",text:n.text};continue}else if(Ee(n,"inlineData")&&Ce(n.inlineData)&&he(n.inlineData.mimeType)&&he(n.inlineData.data)){yield{type:"file",mimeType:n.inlineData.mimeType,data:n.inlineData.data};continue}else if(Ee(n,"functionCall")&&Ce(n.functionCall)&&he(n.functionCall.name)&&Ce(n.functionCall.args)){yield{type:"tool_call",id:e.id,name:n.functionCall.name,args:n.functionCall.args};continue}else if(Ee(n,"functionResponse")){yield{type:"non_standard",value:n};continue}else if(Ee(n,"fileData")&&Ce(n.fileData)&&he(n.fileData.mimeType)&&he(n.fileData.fileUri)){yield{type:"file",mimeType:n.fileData.mimeType,fileId:n.fileData.fileUri};continue}else if(Ee(n,"executableCode")){yield{type:"non_standard",value:n};continue}else if(Ee(n,"codeExecutionResult")){yield{type:"non_standard",value:n};continue}yield{type:"non_standard",value:n}}}return Array.from(t())}const KT={translateContent:Gp,translateContentChunk:Gp};function Wp(e){function*t(){const r=typeof e.content=="string"?[{type:"text",text:e.content}]:e.content;for(const n of r){if(Ee(n,"reasoning")&&he(n.reasoning)){const a=fs(()=>{const i=r.indexOf(n);if(Ur(e.additional_kwargs?.signatures)&&i>=0)return e.additional_kwargs.signatures.at(i)});he(a)?yield{type:"reasoning",reasoning:n.reasoning,signature:a}:yield{type:"reasoning",reasoning:n.reasoning};continue}else if(Ee(n,"text")&&he(n.text)){yield{type:"text",text:n.text};continue}else if(Ee(n,"image_url")){if(he(n.image_url))if(n.image_url.startsWith("data:")){const a=/^data:([^;]+);base64,(.+)$/,i=n.image_url.match(a);i?yield{type:"image",data:i[2],mimeType:i[1]}:yield{type:"image",url:n.image_url}}else yield{type:"image",url:n.image_url};continue}else if(Ee(n,"media")&&he(n.mimeType)&&he(n.data)){yield{type:"file",mimeType:n.mimeType,data:n.data};continue}yield{type:"non_standard",value:n}}}return Array.from(t())}const GT={translateContent:Wp,translateContentChunk:Wp};globalThis.lc_block_translators_registry??=new Map([["anthropic",gT],["bedrock-converse",HT],["google-genai",KT],["google-vertexai",GT],["openai",IT]]);function WT(e){return globalThis.lc_block_translators_registry.get(e)}function VT(e,t){return _a(e??{},t??{})}function __(e,t){const r={};return(e?.audio!==void 0||t?.audio!==void 0)&&(r.audio=(e?.audio??0)+(t?.audio??0)),(e?.image!==void 0||t?.image!==void 0)&&(r.image=(e?.image??0)+(t?.image??0)),(e?.video!==void 0||t?.video!==void 0)&&(r.video=(e?.video??0)+(t?.video??0)),(e?.document!==void 0||t?.document!==void 0)&&(r.document=(e?.document??0)+(t?.document??0)),(e?.text!==void 0||t?.text!==void 0)&&(r.text=(e?.text??0)+(t?.text??0)),r}function ZT(e,t){const r={...__(e,t)};return(e?.cache_read!==void 0||t?.cache_read!==void 0)&&(r.cache_read=(e?.cache_read??0)+(t?.cache_read??0)),(e?.cache_creation!==void 0||t?.cache_creation!==void 0)&&(r.cache_creation=(e?.cache_creation??0)+(t?.cache_creation??0)),r}function JT(e,t){const r={...__(e,t)};return(e?.reasoning!==void 0||t?.reasoning!==void 0)&&(r.reasoning=(e?.reasoning??0)+(t?.reasoning??0)),r}function QT(e,t){return{input_tokens:(e?.input_tokens??0)+(t?.input_tokens??0),output_tokens:(e?.output_tokens??0)+(t?.output_tokens??0),total_tokens:(e?.total_tokens??0)+(t?.total_tokens??0),input_token_details:ZT(e?.input_token_details,t?.input_token_details),output_token_details:JT(e?.output_token_details,t?.output_token_details)}}var w_=class extends v_{type="ai";tool_calls=[];invalid_tool_calls=[];tool_call_chunks=[];usage_metadata;constructor(e){let t;if(typeof e=="string"||Array.isArray(e))t={content:e,tool_calls:[],invalid_tool_calls:[],tool_call_chunks:[]};else if(e.tool_call_chunks===void 0||e.tool_call_chunks.length===0)t={...e,tool_calls:e.tool_calls??[],invalid_tool_calls:[],tool_call_chunks:[],usage_metadata:e.usage_metadata!==void 0?e.usage_metadata:void 0};else{const n=(e.tool_call_chunks??[]).reduce((s,o)=>{const c=s.findIndex(([u])=>"id"in o&&o.id&&"index"in o&&o.index!==void 0?o.id===u.id&&o.index===u.index:"id"in o&&o.id?o.id===u.id:"index"in o&&o.index!==void 0?o.index===u.index:!1);return c!==-1?s[c].push(o):s.push([o]),s},[]),a=[],i=[];for(const s of n){let o=null;const c=s[0]?.name??"",u=s.map(p=>p.args||"").join(""),d=u.length?u:"{}",h=s[0]?.id;try{if(o=BT(d),!h||o===null||typeof o!="object"||Array.isArray(o))throw new Error("Malformed tool call chunk args.");a.push({name:c,args:o,id:h,type:"tool_call"})}catch{i.push({name:c,args:d,id:h,error:"Malformed args.",type:"invalid_tool_call"})}}t={...e,tool_calls:a,invalid_tool_calls:i,usage_metadata:e.usage_metadata!==void 0?e.usage_metadata:void 0}}super(t),this.tool_call_chunks=t.tool_call_chunks??this.tool_call_chunks,this.tool_calls=t.tool_calls??this.tool_calls,this.invalid_tool_calls=t.invalid_tool_calls??this.invalid_tool_calls,this.usage_metadata=t.usage_metadata}get lc_aliases(){return{...super.lc_aliases,tool_calls:"tool_calls",invalid_tool_calls:"invalid_tool_calls",tool_call_chunks:"tool_call_chunks"}}static lc_name(){return"AIMessageChunk"}get contentBlocks(){if(this.response_metadata&&"output_version"in this.response_metadata&&this.response_metadata.output_version==="v1")return this.content;if(this.response_metadata&&"model_provider"in this.response_metadata&&typeof this.response_metadata.model_provider=="string"){const t=WT(this.response_metadata.model_provider);if(t)return t.translateContent(this)}const e=super.contentBlocks;if(this.tool_calls&&typeof this.content!="string"){const t=this.content.filter(r=>r.type==="tool_call").map(r=>r.id);for(const r of this.tool_calls)r.id&&!t.includes(r.id)&&e.push({...r,type:"tool_call",id:r.id,name:r.name,args:r.args})}return e}get _printableFields(){return{...super._printableFields,tool_calls:this.tool_calls,tool_call_chunks:this.tool_call_chunks,invalid_tool_calls:this.invalid_tool_calls,usage_metadata:this.usage_metadata}}concat(e){const t={content:g_(this.content,e.content),additional_kwargs:_a(this.additional_kwargs,e.additional_kwargs),response_metadata:VT(this.response_metadata,e.response_metadata),tool_call_chunks:[],id:this.id??e.id};if(this.tool_call_chunks!==void 0||e.tool_call_chunks!==void 0){const n=$c(this.tool_call_chunks,e.tool_call_chunks);n!==void 0&&n.length>0&&(t.tool_call_chunks=n)}(this.usage_metadata!==void 0||e.usage_metadata!==void 0)&&(t.usage_metadata=QT(this.usage_metadata,e.usage_metadata));const r=this.constructor;return new r(t)}static isInstance(e){return super.isInstance(e)&&e.type==="ai"}};function YT(e,t="Human",r="AI"){const n=[];for(const a of e){let i;if(a._getType()==="human")i=t;else if(a._getType()==="ai")i=r;else if(a._getType()==="system")i="System";else if(a._getType()==="tool")i="Tool";else if(a._getType()==="generic")i=a.role;else throw new Error(`Got unsupported message type: ${a._getType()}`);const s=a.name?`${a.name}, `:"",o=typeof a.content=="string"?a.content:JSON.stringify(a.content,null,2);n.push(`${i}: ${s}${o}`)}return n.join(`
`)}var XT={},eR={};Et(eR,{getEnv:()=>k_,getEnvironmentVariable:()=>da,getRuntimeEnvironment:()=>I_,isBrowser:()=>b_,isDeno:()=>Ac,isJsDom:()=>x_,isNode:()=>S_,isWebWorker:()=>E_});const b_=()=>typeof window<"u"&&typeof window.document<"u",E_=()=>typeof globalThis=="object"&&globalThis.constructor&&globalThis.constructor.name==="DedicatedWorkerGlobalScope",x_=()=>typeof window<"u"&&window.name==="nodejs"||typeof navigator<"u"&&navigator.userAgent.includes("jsdom"),Ac=()=>typeof Deno<"u",S_=()=>typeof process<"u"&&typeof process.versions<"u"&&typeof process.versions.node<"u"&&!Ac(),k_=()=>{let e;return b_()?e="browser":S_()?e="node":E_()?e="webworker":x_()?e="jsdom":Ac()?e="deno":e="other",e};let Bu;function I_(){return Bu===void 0&&(Bu={library:"langchain-js",runtime:k_()}),Bu}function da(e){try{return typeof process<"u"?XT?.[e]:Ac()?Deno?.env.get(e):void 0}catch{return}}const tR=/^(?:[0-9a-f]{8}-[0-9a-f]{4}-[1-8][0-9a-f]{3}-[89ab][0-9a-f]{3}-[0-9a-f]{12}|00000000-0000-0000-0000-000000000000|ffffffff-ffff-ffff-ffff-ffffffffffff)$/i;function Mo(e){return typeof e=="string"&&tR.test(e)}var Ot=[];for(var Uu=0;Uu<256;++Uu)Ot.push((Uu+256).toString(16).slice(1));function rR(e,t=0){return(Ot[e[t+0]]+Ot[e[t+1]]+Ot[e[t+2]]+Ot[e[t+3]]+"-"+Ot[e[t+4]]+Ot[e[t+5]]+"-"+Ot[e[t+6]]+Ot[e[t+7]]+"-"+Ot[e[t+8]]+Ot[e[t+9]]+"-"+Ot[e[t+10]]+Ot[e[t+11]]+Ot[e[t+12]]+Ot[e[t+13]]+Ot[e[t+14]]+Ot[e[t+15]]).toLowerCase()}var yo,nR=new Uint8Array(16);function aR(){if(!yo&&(yo=typeof crypto<"u"&&crypto.getRandomValues&&crypto.getRandomValues.bind(crypto),!yo))throw new Error("crypto.getRandomValues() not supported. See https://github.com/uuidjs/uuid#getrandomvalues-not-supported");return yo(nR)}var iR=typeof crypto<"u"&&crypto.randomUUID&&crypto.randomUUID.bind(crypto);const Vp={randomUUID:iR};function Yr(e,t,r){if(Vp.randomUUID&&!e)return Vp.randomUUID();e=e||{};var n=e.random||(e.rng||aR)();return n[6]=n[6]&15|64,n[8]=n[8]&63|128,rR(n)}var sR={};Et(sR,{BaseCallbackHandler:()=>Ds,callbackHandlerPrefersStreaming:()=>cR,isBaseCallbackHandler:()=>O_});var oR=class{};function cR(e){return"lc_prefer_streaming"in e&&e.lc_prefer_streaming}var Ds=class extends oR{lc_serializable=!1;get lc_namespace(){return["langchain_core","callbacks",this.name]}get lc_secrets(){}get lc_attributes(){}get lc_aliases(){}get lc_serializable_keys(){}static lc_name(){return this.name}get lc_id(){return[...this.lc_namespace,Rf(this.constructor)]}lc_kwargs;ignoreLLM=!1;ignoreChain=!1;ignoreAgent=!1;ignoreRetriever=!1;ignoreCustomEvent=!1;raiseError=!1;awaitHandlers=da("LANGCHAIN_CALLBACKS_BACKGROUND")==="false";constructor(e){super(),this.lc_kwargs=e||{},e&&(this.ignoreLLM=e.ignoreLLM??this.ignoreLLM,this.ignoreChain=e.ignoreChain??this.ignoreChain,this.ignoreAgent=e.ignoreAgent??this.ignoreAgent,this.ignoreRetriever=e.ignoreRetriever??this.ignoreRetriever,this.ignoreCustomEvent=e.ignoreCustomEvent??this.ignoreCustomEvent,this.raiseError=e.raiseError??this.raiseError,this.awaitHandlers=this.raiseError||(e._awaitHandler??this.awaitHandlers))}copy(){return new this.constructor(this)}toJSON(){return us.prototype.toJSON.call(this)}toJSONNotImplemented(){return us.prototype.toJSONNotImplemented.call(this)}static fromMethods(e){class t extends Ds{name=Yr();constructor(){super(),Object.assign(this,e)}}return new t}};const O_=e=>{const t=e;return t!==void 0&&typeof t.copy=="function"&&typeof t.name=="string"&&typeof t.awaitHandlers=="boolean"},uR=/^(?:[0-9a-f]{8}-[0-9a-f]{4}-[1-8][0-9a-f]{3}-[89ab][0-9a-f]{3}-[0-9a-f]{12}|00000000-0000-0000-0000-000000000000|ffffffff-ffff-ffff-ffff-ffffffffffff)$/i;function lR(e){return typeof e=="string"&&uR.test(e)}function dR(e){if(!lR(e))throw TypeError("Invalid UUID");var t,r=new Uint8Array(16);return r[0]=(t=parseInt(e.slice(0,8),16))>>>24,r[1]=t>>>16&255,r[2]=t>>>8&255,r[3]=t&255,r[4]=(t=parseInt(e.slice(9,13),16))>>>8,r[5]=t&255,r[6]=(t=parseInt(e.slice(14,18),16))>>>8,r[7]=t&255,r[8]=(t=parseInt(e.slice(19,23),16))>>>8,r[9]=t&255,r[10]=(t=parseInt(e.slice(24,36),16))/1099511627776&255,r[11]=t/4294967296&255,r[12]=t>>>24&255,r[13]=t>>>16&255,r[14]=t>>>8&255,r[15]=t&255,r}var Tt=[];for(var zu=0;zu<256;++zu)Tt.push((zu+256).toString(16).slice(1));function T_(e,t=0){return(Tt[e[t+0]]+Tt[e[t+1]]+Tt[e[t+2]]+Tt[e[t+3]]+"-"+Tt[e[t+4]]+Tt[e[t+5]]+"-"+Tt[e[t+6]]+Tt[e[t+7]]+"-"+Tt[e[t+8]]+Tt[e[t+9]]+"-"+Tt[e[t+10]]+Tt[e[t+11]]+Tt[e[t+12]]+Tt[e[t+13]]+Tt[e[t+14]]+Tt[e[t+15]]).toLowerCase()}var vo,fR=new Uint8Array(16);function hR(){if(!vo&&(vo=typeof crypto<"u"&&crypto.getRandomValues&&crypto.getRandomValues.bind(crypto),!vo))throw new Error("crypto.getRandomValues() not supported. See https://github.com/uuidjs/uuid#getrandomvalues-not-supported");return vo(fR)}function pR(e){e=unescape(encodeURIComponent(e));for(var t=[],r=0;r<e.length;++r)t.push(e.charCodeAt(r));return t}var mR="6ba7b810-9dad-11d1-80b4-00c04fd430c8",gR="6ba7b811-9dad-11d1-80b4-00c04fd430c8";function yR(e,t,r){function n(a,i,s,o){var c;if(typeof a=="string"&&(a=pR(a)),typeof i=="string"&&(i=dR(i)),((c=i)===null||c===void 0?void 0:c.length)!==16)throw TypeError("Namespace must be array-like (16 iterable integer values, 0-255)");var u=new Uint8Array(16+a.length);if(u.set(i),u.set(a,i.length),u=r(u),u[6]=u[6]&15|t,u[8]=u[8]&63|128,s){o=o||0;for(var d=0;d<16;++d)s[o+d]=u[d];return s}return T_(u)}try{n.name=e}catch{}return n.DNS=mR,n.URL=gR,n}var vR=typeof crypto<"u"&&crypto.randomUUID&&crypto.randomUUID.bind(crypto);const Zp={randomUUID:vR};function za(e,t,r){if(Zp.randomUUID&&!e)return Zp.randomUUID();e=e||{};var n=e.random||(e.rng||hR)();return n[6]=n[6]&15|64,n[8]=n[8]&63|128,T_(n)}function _R(e,t,r,n){switch(e){case 0:return t&r^~t&n;case 1:return t^r^n;case 2:return t&r^t&n^r&n;case 3:return t^r^n}}function qu(e,t){return e<<t|e>>>32-t}function wR(e){var t=[1518500249,1859775393,2400959708,3395469782],r=[1732584193,4023233417,2562383102,271733878,3285377520];if(typeof e=="string"){var n=unescape(encodeURIComponent(e));e=[];for(var a=0;a<n.length;++a)e.push(n.charCodeAt(a))}else Array.isArray(e)||(e=Array.prototype.slice.call(e));e.push(128);for(var i=e.length/4+2,s=Math.ceil(i/16),o=new Array(s),c=0;c<s;++c){for(var u=new Uint32Array(16),d=0;d<16;++d)u[d]=e[c*64+d*4]<<24|e[c*64+d*4+1]<<16|e[c*64+d*4+2]<<8|e[c*64+d*4+3];o[c]=u}o[s-1][14]=(e.length-1)*8/Math.pow(2,32),o[s-1][14]=Math.floor(o[s-1][14]),o[s-1][15]=(e.length-1)*8&4294967295;for(var h=0;h<s;++h){for(var p=new Uint32Array(80),y=0;y<16;++y)p[y]=o[h][y];for(var g=16;g<80;++g)p[g]=qu(p[g-3]^p[g-8]^p[g-14]^p[g-16],1);for(var w=r[0],b=r[1],x=r[2],O=r[3],T=r[4],B=0;B<80;++B){var U=Math.floor(B/20),K=qu(w,5)+_R(U,b,x,O)+T+t[U]+p[B]>>>0;T=O,O=x,x=qu(b,30)>>>0,b=w,w=K}r[0]=r[0]+w>>>0,r[1]=r[1]+b>>>0,r[2]=r[2]+x>>>0,r[3]=r[3]+O>>>0,r[4]=r[4]+T>>>0}return[r[0]>>24&255,r[0]>>16&255,r[0]>>8&255,r[0]&255,r[1]>>24&255,r[1]>>16&255,r[1]>>8&255,r[1]&255,r[2]>>24&255,r[2]>>16&255,r[2]>>8&255,r[2]&255,r[3]>>24&255,r[3]>>16&255,r[3]>>8&255,r[3]&255,r[4]>>24&255,r[4]>>16&255,r[4]>>8&255,r[4]&255]}var Jp=yR("v5",80,wR);const bR="gen_ai.operation.name",ER="gen_ai.system",Qp="gen_ai.request.model",xR="gen_ai.response.model",Yp="gen_ai.usage.input_tokens",Xp="gen_ai.usage.output_tokens",em="gen_ai.usage.total_tokens",SR="gen_ai.request.max_tokens",kR="gen_ai.request.temperature",IR="gen_ai.request.top_p",OR="gen_ai.request.frequency_penalty",TR="gen_ai.request.presence_penalty",RR="gen_ai.response.finish_reasons",$R="gen_ai.prompt",AR="gen_ai.completion",CR="gen_ai.request.extra_query",PR="gen_ai.request.extra_body",NR="gen_ai.serialized.name",DR="gen_ai.serialized.signature",LR="gen_ai.serialized.doc",MR="gen_ai.response.id",jR="gen_ai.response.service_tier",FR="gen_ai.response.system_fingerprint",BR="gen_ai.usage.input_token_details",UR="gen_ai.usage.output_token_details",zR="langsmith.trace.session_id",qR="langsmith.trace.session_name",HR="langsmith.span.kind",KR="langsmith.trace.name",GR="langsmith.metadata",tm="langsmith.span.tags",WR="langsmith.request.streaming",VR="langsmith.request.headers",ZR=(...e)=>fetch(...e),R_=Symbol.for("ls:fetch_implementation"),JR=()=>{const e=globalThis[R_];return e?typeof e=="function"&&"Headers"in e&&"Request"in e&&"Response"in e:!1},QR=e=>async(...t)=>{if(e||Kt("DEBUG")==="true"){const[n,a]=t;console.log(` ${a?.method||"GET"} ${n}`)}const r=await(globalThis[R_]??ZR)(...t);return(e||Kt("DEBUG")==="true")&&console.log(` ${r.status} ${r.statusText} ${r.url}`),r},$_=()=>Kt("PROJECT")??Hr("LANGCHAIN_SESSION")??"default",A_="0.3.79";var Od={};let Mr;const YR=()=>typeof window<"u"&&typeof window.document<"u",XR=()=>typeof globalThis=="object"&&globalThis.constructor&&globalThis.constructor.name==="DedicatedWorkerGlobalScope",e$=()=>typeof window<"u"&&window.name==="nodejs"||typeof navigator<"u"&&navigator.userAgent.includes("jsdom"),C_=()=>typeof Deno<"u",t$=()=>typeof process<"u"&&typeof process.versions<"u"&&typeof process.versions.node<"u"&&!C_(),P_=()=>Mr||(typeof Bun<"u"?Mr="bun":YR()?Mr="browser":t$()?Mr="node":XR()?Mr="webworker":e$()?Mr="jsdom":C_()?Mr="deno":Mr="other",Mr);let Hu;function N_(){if(Hu===void 0){const e=P_(),t=n$();Hu={library:"langsmith",runtime:e,sdk:"langsmith-js",sdk_version:A_,...t}}return Hu}function D_(){const e=r$(),t={},r=["LANGCHAIN_API_KEY","LANGCHAIN_ENDPOINT","LANGCHAIN_TRACING_V2","LANGCHAIN_PROJECT","LANGCHAIN_SESSION","LANGSMITH_API_KEY","LANGSMITH_ENDPOINT","LANGSMITH_TRACING_V2","LANGSMITH_PROJECT","LANGSMITH_SESSION"];for(const[n,a]of Object.entries(e))typeof a=="string"&&!r.includes(n)&&!n.toLowerCase().includes("key")&&!n.toLowerCase().includes("secret")&&!n.toLowerCase().includes("token")&&(n==="LANGCHAIN_REVISION_ID"?t.revision_id=a:t[n]=a);return t}function r$(){const e={};try{if(typeof process<"u"&&Od)for(const[t,r]of Object.entries(Od))(t.startsWith("LANGCHAIN_")||t.startsWith("LANGSMITH_"))&&r!=null&&((t.toLowerCase().includes("key")||t.toLowerCase().includes("secret")||t.toLowerCase().includes("token"))&&typeof r=="string"?e[t]=r.slice(0,2)+"*".repeat(r.length-4)+r.slice(-2):e[t]=r)}catch{}return e}function Hr(e){try{return typeof process<"u"?Od?.[e]:void 0}catch{return}}function Kt(e){return Hr(`LANGSMITH_${e}`)||Hr(`LANGCHAIN_${e}`)}let Ku;function n$(){if(Ku!==void 0)return Ku;const e=["VERCEL_GIT_COMMIT_SHA","NEXT_PUBLIC_VERCEL_GIT_COMMIT_SHA","COMMIT_REF","RENDER_GIT_COMMIT","CI_COMMIT_SHA","CIRCLE_SHA1","CF_PAGES_COMMIT_SHA","REACT_APP_GIT_SHA","SOURCE_VERSION","GITHUB_SHA","TRAVIS_COMMIT","GIT_COMMIT","BUILD_VCS_NUMBER","bamboo_planRepository_revision","Build.SourceVersion","BITBUCKET_COMMIT","DRONE_COMMIT_SHA","SEMAPHORE_GIT_SHA","BUILDKITE_COMMIT"],t={};for(const r of e){const n=Hr(r);n!==void 0&&(t[r]=n)}return Ku=t,t}function L_(){return Hr("OTEL_ENABLED")==="true"||Kt("OTEL_ENABLED")==="true"}class a${constructor(){Object.defineProperty(this,"hasWarned",{enumerable:!0,configurable:!0,writable:!0,value:!1})}startActiveSpan(t,...r){!this.hasWarned&&L_()&&(console.warn('You have enabled OTEL export via the `OTEL_ENABLED` or `LANGSMITH_OTEL_ENABLED` environment variable, but have not initialized the required OTEL instances. Please add:\n```\nimport { initializeOTEL } from "langsmith/experimental/otel/setup";\ninitializeOTEL();\n```\nat the beginning of your code.'),this.hasWarned=!0);let n;if(r.length===1&&typeof r[0]=="function"?n=r[0]:r.length===2&&typeof r[1]=="function"?n=r[1]:r.length===3&&typeof r[2]=="function"&&(n=r[2]),typeof n=="function")return n()}}class i${constructor(){Object.defineProperty(this,"mockTracer",{enumerable:!0,configurable:!0,writable:!0,value:new a$})}getTracer(t,r){return this.mockTracer}getActiveSpan(){}setSpan(t,r){return t}getSpan(t){}setSpanContext(t,r){return t}getTracerProvider(){}setGlobalTracerProvider(t){return!1}}class s${active(){return{}}with(t,r){return r()}}const Gu=Symbol.for("ls:otel_trace"),Wu=Symbol.for("ls:otel_context"),rm=Symbol.for("ls:otel_get_default_otlp_tracer_provider"),o$=new i$,c$=new s$;class u${getTraceInstance(){return globalThis[Gu]??o$}getContextInstance(){return globalThis[Wu]??c$}initializeGlobalInstances(t){globalThis[Gu]===void 0&&(globalThis[Gu]=t.trace),globalThis[Wu]===void 0&&(globalThis[Wu]=t.context)}setDefaultOTLPTracerComponents(t){globalThis[rm]=t}getDefaultOTLPTracerComponents(){return globalThis[rm]??void 0}}const Pf=new u$;function M_(){return Pf.getTraceInstance()}function l$(){return Pf.getContextInstance()}function d$(){return Pf.getDefaultOTLPTracerComponents()}const f$={llm:"chat",tool:"execute_tool",retriever:"embeddings",embedding:"embeddings",prompt:"chat"};function h$(e){return f$[e]||e}class p${constructor(){Object.defineProperty(this,"spans",{enumerable:!0,configurable:!0,writable:!0,value:new Map})}exportBatch(t,r){for(const n of t)try{if(!n.run)continue;if(n.operation==="post"){const a=this.createSpanForRun(n,n.run,r.get(n.id));a&&!n.run.end_time&&this.spans.set(n.id,a)}else this.updateSpanForRun(n,n.run)}catch(a){console.error(`Error processing operation ${n.id}:`,a)}}createSpanForRun(t,r,n){const a=n&&M_().getSpan(n);if(a)try{return this.finishSpanSetup(a,r,t)}catch(i){console.error(`Failed to create span for run ${t.id}:`,i);return}}finishSpanSetup(t,r,n){return this.setSpanAttributes(t,r,n),r.error?(t.setStatus({code:2}),t.recordException(new Error(r.error))):t.setStatus({code:1}),r.end_time&&t.end(new Date(r.end_time)),t}updateSpanForRun(t,r){try{const n=this.spans.get(t.id);if(!n){console.debug(`No span found for run ${t.id} during update`);return}this.setSpanAttributes(n,r,t),r.error?(n.setStatus({code:2}),n.recordException(new Error(r.error))):n.setStatus({code:1});const a=r.end_time;a&&(n.end(new Date(a)),this.spans.delete(t.id))}catch(n){console.error(`Failed to update span for run ${t.id}:`,n)}}extractModelName(t){if(t.extra?.metadata){const r=t.extra.metadata;if(r.ls_model_name)return r.ls_model_name;if(r.invocation_params){const n=r.invocation_params;if(n.model)return n.model;if(n.model_name)return n.model_name}}}setSpanAttributes(t,r,n){if("run_type"in r&&r.run_type){t.setAttribute(HR,r.run_type);const o=h$(r.run_type||"chain");t.setAttribute(bR,o)}"name"in r&&r.name&&t.setAttribute(KR,r.name),"session_id"in r&&r.session_id&&t.setAttribute(zR,r.session_id),"session_name"in r&&r.session_name&&t.setAttribute(qR,r.session_name),this.setGenAiSystem(t,r);const a=this.extractModelName(r);a&&t.setAttribute(Qp,a),"prompt_tokens"in r&&typeof r.prompt_tokens=="number"&&t.setAttribute(Yp,r.prompt_tokens),"completion_tokens"in r&&typeof r.completion_tokens=="number"&&t.setAttribute(Xp,r.completion_tokens),"total_tokens"in r&&typeof r.total_tokens=="number"&&t.setAttribute(em,r.total_tokens),this.setInvocationParameters(t,r);const i=r.extra?.metadata||{};for(const[o,c]of Object.entries(i))c!=null&&t.setAttribute(`${GR}.${o}`,String(c));const s=r.tags;if(s&&Array.isArray(s)?t.setAttribute(tm,s.join(", ")):s&&t.setAttribute(tm,String(s)),"serialized"in r&&typeof r.serialized=="object"){const o=r.serialized;o.name&&t.setAttribute(NR,String(o.name)),o.signature&&t.setAttribute(DR,String(o.signature)),o.doc&&t.setAttribute(LR,String(o.doc))}this.setIOAttributes(t,n)}setGenAiSystem(t,r){let n="langchain";const a=this.extractModelName(r);if(a){const i=a.toLowerCase();i.includes("anthropic")||i.startsWith("claude")?n="anthropic":i.includes("bedrock")?n="aws.bedrock":i.includes("azure")&&i.includes("openai")?n="az.ai.openai":i.includes("azure")&&i.includes("inference")?n="az.ai.inference":i.includes("cohere")?n="cohere":i.includes("deepseek")?n="deepseek":i.includes("gemini")?n="gemini":i.includes("groq")?n="groq":i.includes("watson")||i.includes("ibm")?n="ibm.watsonx.ai":i.includes("mistral")?n="mistral_ai":i.includes("gpt")||i.includes("openai")?n="openai":i.includes("perplexity")||i.includes("sonar")?n="perplexity":i.includes("vertex")?n="vertex_ai":(i.includes("xai")||i.includes("grok"))&&(n="xai")}t.setAttribute(ER,n)}setInvocationParameters(t,r){if(!r.extra?.metadata?.invocation_params)return;const n=r.extra.metadata.invocation_params;n.max_tokens!==void 0&&t.setAttribute(SR,n.max_tokens),n.temperature!==void 0&&t.setAttribute(kR,n.temperature),n.top_p!==void 0&&t.setAttribute(IR,n.top_p),n.frequency_penalty!==void 0&&t.setAttribute(OR,n.frequency_penalty),n.presence_penalty!==void 0&&t.setAttribute(TR,n.presence_penalty)}setIOAttributes(t,r){if(r.run.inputs)try{const n=r.run.inputs;typeof n=="object"&&n!==null&&(n.model&&Array.isArray(n.messages)&&t.setAttribute(Qp,n.model),n.stream!==void 0&&t.setAttribute(WR,n.stream),n.extra_headers&&t.setAttribute(VR,JSON.stringify(n.extra_headers)),n.extra_query&&t.setAttribute(CR,JSON.stringify(n.extra_query)),n.extra_body&&t.setAttribute(PR,JSON.stringify(n.extra_body))),t.setAttribute($R,JSON.stringify(n))}catch(n){console.debug(`Failed to process inputs for run ${r.id}`,n)}if(r.run.outputs)try{const n=r.run.outputs,a=this.getUnifiedRunTokens(n);if(a&&(t.setAttribute(Yp,a[0]),t.setAttribute(Xp,a[1]),t.setAttribute(em,a[0]+a[1])),n&&typeof n=="object"){if(n.model&&t.setAttribute(xR,String(n.model)),n.id&&t.setAttribute(MR,n.id),n.choices&&Array.isArray(n.choices)){const i=n.choices.map(s=>s.finish_reason).filter(s=>s).map(String);i.length>0&&t.setAttribute(RR,i.join(", "))}if(n.service_tier&&t.setAttribute(jR,n.service_tier),n.system_fingerprint&&t.setAttribute(FR,n.system_fingerprint),n.usage_metadata&&typeof n.usage_metadata=="object"){const i=n.usage_metadata;i.input_token_details&&t.setAttribute(BR,JSON.stringify(i.input_token_details)),i.output_token_details&&t.setAttribute(UR,JSON.stringify(i.output_token_details))}}t.setAttribute(AR,JSON.stringify(n))}catch(n){console.debug(`Failed to process outputs for run ${r.id}`,n)}}getUnifiedRunTokens(t){if(!t)return null;let r=this.extractUnifiedRunTokens(t.usage_metadata);if(r)return r;const n=Object.keys(t);for(const s of n){const o=t[s];if(!(!o||typeof o!="object")&&(r=this.extractUnifiedRunTokens(o.usage_metadata),r||o.lc===1&&o.kwargs&&typeof o.kwargs=="object"&&(r=this.extractUnifiedRunTokens(o.kwargs.usage_metadata),r)))return r}const a=t.generations||[];if(!Array.isArray(a))return null;const i=Array.isArray(a[0])?a.flat():a;for(const s of i)if(typeof s=="object"&&s.message&&typeof s.message=="object"&&s.message.kwargs&&typeof s.message.kwargs=="object"&&(r=this.extractUnifiedRunTokens(s.message.kwargs.usage_metadata),r))return r;return null}extractUnifiedRunTokens(t){return!t||typeof t!="object"||typeof t.input_tokens!="number"||typeof t.output_tokens!="number"?null:[t.input_tokens,t.output_tokens]}}var Ci={exports:{}},Vu={},Zu,nm;function m$(){if(nm)return Zu;nm=1;function e(t,r){typeof r=="boolean"&&(r={forever:r}),this._originalTimeouts=JSON.parse(JSON.stringify(t)),this._timeouts=t,this._options=r||{},this._maxRetryTime=r&&r.maxRetryTime||1/0,this._fn=null,this._errors=[],this._attempts=1,this._operationTimeout=null,this._operationTimeoutCb=null,this._timeout=null,this._operationStart=null,this._timer=null,this._options.forever&&(this._cachedTimeouts=this._timeouts.slice(0))}return Zu=e,e.prototype.reset=function(){this._attempts=1,this._timeouts=this._originalTimeouts.slice(0)},e.prototype.stop=function(){this._timeout&&clearTimeout(this._timeout),this._timer&&clearTimeout(this._timer),this._timeouts=[],this._cachedTimeouts=null},e.prototype.retry=function(t){if(this._timeout&&clearTimeout(this._timeout),!t)return!1;var r=new Date().getTime();if(t&&r-this._operationStart>=this._maxRetryTime)return this._errors.push(t),this._errors.unshift(new Error("RetryOperation timeout occurred")),!1;this._errors.push(t);var n=this._timeouts.shift();if(n===void 0)if(this._cachedTimeouts)this._errors.splice(0,this._errors.length-1),n=this._cachedTimeouts.slice(-1);else return!1;var a=this;return this._timer=setTimeout(function(){a._attempts++,a._operationTimeoutCb&&(a._timeout=setTimeout(function(){a._operationTimeoutCb(a._attempts)},a._operationTimeout),a._options.unref&&a._timeout.unref()),a._fn(a._attempts)},n),this._options.unref&&this._timer.unref(),!0},e.prototype.attempt=function(t,r){this._fn=t,r&&(r.timeout&&(this._operationTimeout=r.timeout),r.cb&&(this._operationTimeoutCb=r.cb));var n=this;this._operationTimeoutCb&&(this._timeout=setTimeout(function(){n._operationTimeoutCb()},n._operationTimeout)),this._operationStart=new Date().getTime(),this._fn(this._attempts)},e.prototype.try=function(t){console.log("Using RetryOperation.try() is deprecated"),this.attempt(t)},e.prototype.start=function(t){console.log("Using RetryOperation.start() is deprecated"),this.attempt(t)},e.prototype.start=e.prototype.try,e.prototype.errors=function(){return this._errors},e.prototype.attempts=function(){return this._attempts},e.prototype.mainError=function(){if(this._errors.length===0)return null;for(var t={},r=null,n=0,a=0;a<this._errors.length;a++){var i=this._errors[a],s=i.message,o=(t[s]||0)+1;t[s]=o,o>=n&&(r=i,n=o)}return r},Zu}var am;function g$(){return am||(am=1,(function(e){var t=m$();e.operation=function(r){var n=e.timeouts(r);return new t(n,{forever:r&&(r.forever||r.retries===1/0),unref:r&&r.unref,maxRetryTime:r&&r.maxRetryTime})},e.timeouts=function(r){if(r instanceof Array)return[].concat(r);var n={retries:10,factor:2,minTimeout:1*1e3,maxTimeout:1/0,randomize:!1};for(var a in r)n[a]=r[a];if(n.minTimeout>n.maxTimeout)throw new Error("minTimeout is greater than maxTimeout");for(var i=[],s=0;s<n.retries;s++)i.push(this.createTimeout(s,n));return r&&r.forever&&!i.length&&i.push(this.createTimeout(s,n)),i.sort(function(o,c){return o-c}),i},e.createTimeout=function(r,n){var a=n.randomize?Math.random()+1:1,i=Math.round(a*Math.max(n.minTimeout,1)*Math.pow(n.factor,r));return i=Math.min(i,n.maxTimeout),i},e.wrap=function(r,n,a){if(n instanceof Array&&(a=n,n=null),!a){a=[];for(var i in r)typeof r[i]=="function"&&a.push(i)}for(var s=0;s<a.length;s++){var o=a[s],c=r[o];r[o]=(function(d){var h=e.operation(n),p=Array.prototype.slice.call(arguments,1),y=p.pop();p.push(function(g){h.retry(g)||(g&&(arguments[0]=h.mainError()),y.apply(this,arguments))}),h.attempt(function(){d.apply(r,p)})}).bind(r,c),r[o].options=n}}})(Vu)),Vu}var Ju,im;function y$(){return im||(im=1,Ju=g$()),Ju}var sm;function v$(){if(sm)return Ci.exports;sm=1;const e=y$(),t=["Failed to fetch","NetworkError when attempting to fetch resource.","The Internet connection appears to be offline.","Network request failed"];class r extends Error{constructor(o){super(),o instanceof Error?(this.originalError=o,{message:o}=o):(this.originalError=new Error(o),this.originalError.stack=this.stack),this.name="AbortError",this.message=o}}const n=(s,o,c)=>{const u=c.retries-(o-1);return s.attemptNumber=o,s.retriesLeft=u,s},a=s=>t.includes(s),i=(s,o)=>new Promise((c,u)=>{o={onFailedAttempt:()=>{},retries:10,...o};const d=e.operation(o);d.attempt(async h=>{try{c(await s(h))}catch(p){if(!(p instanceof Error)){u(new TypeError(`Non-error was thrown: "${p}". You should only throw errors.`));return}if(p instanceof r)d.stop(),u(p.originalError);else if(p instanceof TypeError&&!a(p.message))d.stop(),u(p);else{n(p,h,o);try{await o.onFailedAttempt(p)}catch(y){u(y);return}d.retry(p)||u(d.mainError())}}})});return Ci.exports=i,Ci.exports.default=i,Ci.exports.AbortError=r,Ci.exports}var _$=v$();const rc=fi(_$);var _o={},Qu={exports:{}},om;function w$(){return om||(om=1,(function(e){var t=Object.prototype.hasOwnProperty,r="~";function n(){}Object.create&&(n.prototype=Object.create(null),new n().__proto__||(r=!1));function a(c,u,d){this.fn=c,this.context=u,this.once=d||!1}function i(c,u,d,h,p){if(typeof d!="function")throw new TypeError("The listener must be a function");var y=new a(d,h||c,p),g=r?r+u:u;return c._events[g]?c._events[g].fn?c._events[g]=[c._events[g],y]:c._events[g].push(y):(c._events[g]=y,c._eventsCount++),c}function s(c,u){--c._eventsCount===0?c._events=new n:delete c._events[u]}function o(){this._events=new n,this._eventsCount=0}o.prototype.eventNames=function(){var u=[],d,h;if(this._eventsCount===0)return u;for(h in d=this._events)t.call(d,h)&&u.push(r?h.slice(1):h);return Object.getOwnPropertySymbols?u.concat(Object.getOwnPropertySymbols(d)):u},o.prototype.listeners=function(u){var d=r?r+u:u,h=this._events[d];if(!h)return[];if(h.fn)return[h.fn];for(var p=0,y=h.length,g=new Array(y);p<y;p++)g[p]=h[p].fn;return g},o.prototype.listenerCount=function(u){var d=r?r+u:u,h=this._events[d];return h?h.fn?1:h.length:0},o.prototype.emit=function(u,d,h,p,y,g){var w=r?r+u:u;if(!this._events[w])return!1;var b=this._events[w],x=arguments.length,O,T;if(b.fn){switch(b.once&&this.removeListener(u,b.fn,void 0,!0),x){case 1:return b.fn.call(b.context),!0;case 2:return b.fn.call(b.context,d),!0;case 3:return b.fn.call(b.context,d,h),!0;case 4:return b.fn.call(b.context,d,h,p),!0;case 5:return b.fn.call(b.context,d,h,p,y),!0;case 6:return b.fn.call(b.context,d,h,p,y,g),!0}for(T=1,O=new Array(x-1);T<x;T++)O[T-1]=arguments[T];b.fn.apply(b.context,O)}else{var B=b.length,U;for(T=0;T<B;T++)switch(b[T].once&&this.removeListener(u,b[T].fn,void 0,!0),x){case 1:b[T].fn.call(b[T].context);break;case 2:b[T].fn.call(b[T].context,d);break;case 3:b[T].fn.call(b[T].context,d,h);break;case 4:b[T].fn.call(b[T].context,d,h,p);break;default:if(!O)for(U=1,O=new Array(x-1);U<x;U++)O[U-1]=arguments[U];b[T].fn.apply(b[T].context,O)}}return!0},o.prototype.on=function(u,d,h){return i(this,u,d,h,!1)},o.prototype.once=function(u,d,h){return i(this,u,d,h,!0)},o.prototype.removeListener=function(u,d,h,p){var y=r?r+u:u;if(!this._events[y])return this;if(!d)return s(this,y),this;var g=this._events[y];if(g.fn)g.fn===d&&(!p||g.once)&&(!h||g.context===h)&&s(this,y);else{for(var w=0,b=[],x=g.length;w<x;w++)(g[w].fn!==d||p&&!g[w].once||h&&g[w].context!==h)&&b.push(g[w]);b.length?this._events[y]=b.length===1?b[0]:b:s(this,y)}return this},o.prototype.removeAllListeners=function(u){var d;return u?(d=r?r+u:u,this._events[d]&&s(this,d)):(this._events=new n,this._eventsCount=0),this},o.prototype.off=o.prototype.removeListener,o.prototype.addListener=o.prototype.on,o.prefixed=r,o.EventEmitter=o,e.exports=o})(Qu)),Qu.exports}var Pi={exports:{}},Yu,cm;function b$(){return cm||(cm=1,Yu=(e,t)=>(t=t||(()=>{}),e.then(r=>new Promise(n=>{n(t())}).then(()=>r),r=>new Promise(n=>{n(t())}).then(()=>{throw r})))),Yu}var um;function E$(){if(um)return Pi.exports;um=1;const e=b$();class t extends Error{constructor(a){super(a),this.name="TimeoutError"}}const r=(n,a,i)=>new Promise((s,o)=>{if(typeof a!="number"||a<0)throw new TypeError("Expected `milliseconds` to be a positive number");if(a===1/0){s(n);return}const c=setTimeout(()=>{if(typeof i=="function"){try{s(i())}catch(h){o(h)}return}const u=typeof i=="string"?i:`Promise timed out after ${a} milliseconds`,d=i instanceof Error?i:new t(u);typeof n.cancel=="function"&&n.cancel(),o(d)},a);e(n.then(s,o),()=>{clearTimeout(c)})});return Pi.exports=r,Pi.exports.default=r,Pi.exports.TimeoutError=t,Pi.exports}var wo={},bo={},lm;function x$(){if(lm)return bo;lm=1,Object.defineProperty(bo,"__esModule",{value:!0});function e(t,r,n){let a=0,i=t.length;for(;i>0;){const s=i/2|0;let o=a+s;n(t[o],r)<=0?(a=++o,i-=s+1):i=s}return a}return bo.default=e,bo}var dm;function S$(){if(dm)return wo;dm=1,Object.defineProperty(wo,"__esModule",{value:!0});const e=x$();class t{constructor(){this._queue=[]}enqueue(n,a){a=Object.assign({priority:0},a);const i={priority:a.priority,run:n};if(this.size&&this._queue[this.size-1].priority>=a.priority){this._queue.push(i);return}const s=e.default(this._queue,i,(o,c)=>c.priority-o.priority);this._queue.splice(s,0,i)}dequeue(){const n=this._queue.shift();return n?.run}filter(n){return this._queue.filter(a=>a.priority===n.priority).map(a=>a.run)}get size(){return this._queue.length}}return wo.default=t,wo}var fm;function k$(){if(fm)return _o;fm=1,Object.defineProperty(_o,"__esModule",{value:!0});const e=w$(),t=E$(),r=S$(),n=()=>{},a=new t.TimeoutError;class i extends e{constructor(o){var c,u,d,h;if(super(),this._intervalCount=0,this._intervalEnd=0,this._pendingCount=0,this._resolveEmpty=n,this._resolveIdle=n,o=Object.assign({carryoverConcurrencyCount:!1,intervalCap:1/0,interval:0,concurrency:1/0,autoStart:!0,queueClass:r.default},o),!(typeof o.intervalCap=="number"&&o.intervalCap>=1))throw new TypeError(`Expected \`intervalCap\` to be a number from 1 and up, got \`${(u=(c=o.intervalCap)===null||c===void 0?void 0:c.toString())!==null&&u!==void 0?u:""}\` (${typeof o.intervalCap})`);if(o.interval===void 0||!(Number.isFinite(o.interval)&&o.interval>=0))throw new TypeError(`Expected \`interval\` to be a finite number >= 0, got \`${(h=(d=o.interval)===null||d===void 0?void 0:d.toString())!==null&&h!==void 0?h:""}\` (${typeof o.interval})`);this._carryoverConcurrencyCount=o.carryoverConcurrencyCount,this._isIntervalIgnored=o.intervalCap===1/0||o.interval===0,this._intervalCap=o.intervalCap,this._interval=o.interval,this._queue=new o.queueClass,this._queueClass=o.queueClass,this.concurrency=o.concurrency,this._timeout=o.timeout,this._throwOnTimeout=o.throwOnTimeout===!0,this._isPaused=o.autoStart===!1}get _doesIntervalAllowAnother(){return this._isIntervalIgnored||this._intervalCount<this._intervalCap}get _doesConcurrentAllowAnother(){return this._pendingCount<this._concurrency}_next(){this._pendingCount--,this._tryToStartAnother(),this.emit("next")}_resolvePromises(){this._resolveEmpty(),this._resolveEmpty=n,this._pendingCount===0&&(this._resolveIdle(),this._resolveIdle=n,this.emit("idle"))}_onResumeInterval(){this._onInterval(),this._initializeIntervalIfNeeded(),this._timeoutId=void 0}_isIntervalPaused(){const o=Date.now();if(this._intervalId===void 0){const c=this._intervalEnd-o;if(c<0)this._intervalCount=this._carryoverConcurrencyCount?this._pendingCount:0;else return this._timeoutId===void 0&&(this._timeoutId=setTimeout(()=>{this._onResumeInterval()},c)),!0}return!1}_tryToStartAnother(){if(this._queue.size===0)return this._intervalId&&clearInterval(this._intervalId),this._intervalId=void 0,this._resolvePromises(),!1;if(!this._isPaused){const o=!this._isIntervalPaused();if(this._doesIntervalAllowAnother&&this._doesConcurrentAllowAnother){const c=this._queue.dequeue();return c?(this.emit("active"),c(),o&&this._initializeIntervalIfNeeded(),!0):!1}}return!1}_initializeIntervalIfNeeded(){this._isIntervalIgnored||this._intervalId!==void 0||(this._intervalId=setInterval(()=>{this._onInterval()},this._interval),this._intervalEnd=Date.now()+this._interval)}_onInterval(){this._intervalCount===0&&this._pendingCount===0&&this._intervalId&&(clearInterval(this._intervalId),this._intervalId=void 0),this._intervalCount=this._carryoverConcurrencyCount?this._pendingCount:0,this._processQueue()}_processQueue(){for(;this._tryToStartAnother(););}get concurrency(){return this._concurrency}set concurrency(o){if(!(typeof o=="number"&&o>=1))throw new TypeError(`Expected \`concurrency\` to be a number from 1 and up, got \`${o}\` (${typeof o})`);this._concurrency=o,this._processQueue()}async add(o,c={}){return new Promise((u,d)=>{const h=async()=>{this._pendingCount++,this._intervalCount++;try{const p=this._timeout===void 0&&c.timeout===void 0?o():t.default(Promise.resolve(o()),c.timeout===void 0?this._timeout:c.timeout,()=>{(c.throwOnTimeout===void 0?this._throwOnTimeout:c.throwOnTimeout)&&d(a)});u(await p)}catch(p){d(p)}this._next()};this._queue.enqueue(h,c),this._tryToStartAnother(),this.emit("add")})}async addAll(o,c){return Promise.all(o.map(async u=>this.add(u,c)))}start(){return this._isPaused?(this._isPaused=!1,this._processQueue(),this):this}pause(){this._isPaused=!0}clear(){this._queue=new this._queueClass}async onEmpty(){if(this._queue.size!==0)return new Promise(o=>{const c=this._resolveEmpty;this._resolveEmpty=()=>{c(),o()}})}async onIdle(){if(!(this._pendingCount===0&&this._queue.size===0))return new Promise(o=>{const c=this._resolveIdle;this._resolveIdle=()=>{c(),o()}})}get size(){return this._queue.size}sizeBy(o){return this._queue.filter(o).length}get pending(){return this._pendingCount}get isPaused(){return this._isPaused}get timeout(){return this._timeout}set timeout(o){this._timeout=o}}return _o.default=i,_o}var I$=k$();const rn=fi(I$),O$=[429,500,502,503,504];let hm=class{constructor(t){Object.defineProperty(this,"maxConcurrency",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"maxRetries",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"queue",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"onFailedResponseHook",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.maxConcurrency=t.maxConcurrency??1/0,this.maxRetries=t.maxRetries??6,"default"in rn?this.queue=new rn.default({concurrency:this.maxConcurrency}):this.queue=new rn({concurrency:this.maxConcurrency}),this.onFailedResponseHook=t?.onFailedResponseHook}call(t,...r){const n=this.onFailedResponseHook;return this.queue.add(()=>rc(()=>t(...r).catch(a=>{throw a instanceof Error?a:new Error(a)}),{async onFailedAttempt(a){if(a.message.startsWith("Cancel")||a.message.startsWith("TimeoutError")||a.name==="TimeoutError"||a.message.startsWith("AbortError")||a?.code==="ECONNABORTED")throw a;const i=a?.response;if(n&&await n(i))return;const s=i?.status??a?.status;if(s&&!O$.includes(+s))throw a},retries:this.maxRetries,randomize:!0}),{throwOnTimeout:!0})}callWithOptions(t,r,...n){return t.signal?Promise.race([this.call(r,...n),new Promise((a,i)=>{t.signal?.addEventListener("abort",()=>{i(new Error("AbortError"))})})]):this.call(r,...n)}};function pm(e){return typeof e?._getType=="function"}function mm(e){const t={type:e._getType(),data:{content:e.content}};return e?.additional_kwargs&&Object.keys(e.additional_kwargs).length>0&&(t.data.additional_kwargs={...e.additional_kwargs}),t}const T$=/^[0-9a-f]{8}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{12}$/i;function De(e,t){if(!T$.test(e)){const r=t!==void 0?`Invalid UUID for ${t}: ${e}`:`Invalid UUID: ${e}`;throw new Error(r)}return e}const gm={};function Td(e){gm[e]||(console.warn(e),gm[e]=!0)}var Eo={exports:{}},Xu,ym;function Cc(){if(ym)return Xu;ym=1;const e="2.0.0",t=256,r=Number.MAX_SAFE_INTEGER||9007199254740991,n=16,a=t-6;return Xu={MAX_LENGTH:t,MAX_SAFE_COMPONENT_LENGTH:n,MAX_SAFE_BUILD_LENGTH:a,MAX_SAFE_INTEGER:r,RELEASE_TYPES:["major","premajor","minor","preminor","patch","prepatch","prerelease"],SEMVER_SPEC_VERSION:e,FLAG_INCLUDE_PRERELEASE:1,FLAG_LOOSE:2},Xu}var el,vm;function Pc(){if(vm)return el;vm=1;var e={};return el=typeof process=="object"&&e&&e.NODE_DEBUG&&/\bsemver\b/i.test(e.NODE_DEBUG)?(...r)=>console.error("SEMVER",...r):()=>{},el}var _m;function Ls(){return _m||(_m=1,(function(e,t){const{MAX_SAFE_COMPONENT_LENGTH:r,MAX_SAFE_BUILD_LENGTH:n,MAX_LENGTH:a}=Cc(),i=Pc();t=e.exports={};const s=t.re=[],o=t.safeRe=[],c=t.src=[],u=t.safeSrc=[],d=t.t={};let h=0;const p="[a-zA-Z0-9-]",y=[["\\s",1],["\\d",a],[p,n]],g=b=>{for(const[x,O]of y)b=b.split(`${x}*`).join(`${x}{0,${O}}`).split(`${x}+`).join(`${x}{1,${O}}`);return b},w=(b,x,O)=>{const T=g(x),B=h++;i(b,B,x),d[b]=B,c[B]=x,u[B]=T,s[B]=new RegExp(x,O?"g":void 0),o[B]=new RegExp(T,O?"g":void 0)};w("NUMERICIDENTIFIER","0|[1-9]\\d*"),w("NUMERICIDENTIFIERLOOSE","\\d+"),w("NONNUMERICIDENTIFIER",`\\d*[a-zA-Z-]${p}*`),w("MAINVERSION",`(${c[d.NUMERICIDENTIFIER]})\\.(${c[d.NUMERICIDENTIFIER]})\\.(${c[d.NUMERICIDENTIFIER]})`),w("MAINVERSIONLOOSE",`(${c[d.NUMERICIDENTIFIERLOOSE]})\\.(${c[d.NUMERICIDENTIFIERLOOSE]})\\.(${c[d.NUMERICIDENTIFIERLOOSE]})`),w("PRERELEASEIDENTIFIER",`(?:${c[d.NONNUMERICIDENTIFIER]}|${c[d.NUMERICIDENTIFIER]})`),w("PRERELEASEIDENTIFIERLOOSE",`(?:${c[d.NONNUMERICIDENTIFIER]}|${c[d.NUMERICIDENTIFIERLOOSE]})`),w("PRERELEASE",`(?:-(${c[d.PRERELEASEIDENTIFIER]}(?:\\.${c[d.PRERELEASEIDENTIFIER]})*))`),w("PRERELEASELOOSE",`(?:-?(${c[d.PRERELEASEIDENTIFIERLOOSE]}(?:\\.${c[d.PRERELEASEIDENTIFIERLOOSE]})*))`),w("BUILDIDENTIFIER",`${p}+`),w("BUILD",`(?:\\+(${c[d.BUILDIDENTIFIER]}(?:\\.${c[d.BUILDIDENTIFIER]})*))`),w("FULLPLAIN",`v?${c[d.MAINVERSION]}${c[d.PRERELEASE]}?${c[d.BUILD]}?`),w("FULL",`^${c[d.FULLPLAIN]}$`),w("LOOSEPLAIN",`[v=\\s]*${c[d.MAINVERSIONLOOSE]}${c[d.PRERELEASELOOSE]}?${c[d.BUILD]}?`),w("LOOSE",`^${c[d.LOOSEPLAIN]}$`),w("GTLT","((?:<|>)?=?)"),w("XRANGEIDENTIFIERLOOSE",`${c[d.NUMERICIDENTIFIERLOOSE]}|x|X|\\*`),w("XRANGEIDENTIFIER",`${c[d.NUMERICIDENTIFIER]}|x|X|\\*`),w("XRANGEPLAIN",`[v=\\s]*(${c[d.XRANGEIDENTIFIER]})(?:\\.(${c[d.XRANGEIDENTIFIER]})(?:\\.(${c[d.XRANGEIDENTIFIER]})(?:${c[d.PRERELEASE]})?${c[d.BUILD]}?)?)?`),w("XRANGEPLAINLOOSE",`[v=\\s]*(${c[d.XRANGEIDENTIFIERLOOSE]})(?:\\.(${c[d.XRANGEIDENTIFIERLOOSE]})(?:\\.(${c[d.XRANGEIDENTIFIERLOOSE]})(?:${c[d.PRERELEASELOOSE]})?${c[d.BUILD]}?)?)?`),w("XRANGE",`^${c[d.GTLT]}\\s*${c[d.XRANGEPLAIN]}$`),w("XRANGELOOSE",`^${c[d.GTLT]}\\s*${c[d.XRANGEPLAINLOOSE]}$`),w("COERCEPLAIN",`(^|[^\\d])(\\d{1,${r}})(?:\\.(\\d{1,${r}}))?(?:\\.(\\d{1,${r}}))?`),w("COERCE",`${c[d.COERCEPLAIN]}(?:$|[^\\d])`),w("COERCEFULL",c[d.COERCEPLAIN]+`(?:${c[d.PRERELEASE]})?(?:${c[d.BUILD]})?(?:$|[^\\d])`),w("COERCERTL",c[d.COERCE],!0),w("COERCERTLFULL",c[d.COERCEFULL],!0),w("LONETILDE","(?:~>?)"),w("TILDETRIM",`(\\s*)${c[d.LONETILDE]}\\s+`,!0),t.tildeTrimReplace="$1~",w("TILDE",`^${c[d.LONETILDE]}${c[d.XRANGEPLAIN]}$`),w("TILDELOOSE",`^${c[d.LONETILDE]}${c[d.XRANGEPLAINLOOSE]}$`),w("LONECARET","(?:\\^)"),w("CARETTRIM",`(\\s*)${c[d.LONECARET]}\\s+`,!0),t.caretTrimReplace="$1^",w("CARET",`^${c[d.LONECARET]}${c[d.XRANGEPLAIN]}$`),w("CARETLOOSE",`^${c[d.LONECARET]}${c[d.XRANGEPLAINLOOSE]}$`),w("COMPARATORLOOSE",`^${c[d.GTLT]}\\s*(${c[d.LOOSEPLAIN]})$|^$`),w("COMPARATOR",`^${c[d.GTLT]}\\s*(${c[d.FULLPLAIN]})$|^$`),w("COMPARATORTRIM",`(\\s*)${c[d.GTLT]}\\s*(${c[d.LOOSEPLAIN]}|${c[d.XRANGEPLAIN]})`,!0),t.comparatorTrimReplace="$1$2$3",w("HYPHENRANGE",`^\\s*(${c[d.XRANGEPLAIN]})\\s+-\\s+(${c[d.XRANGEPLAIN]})\\s*$`),w("HYPHENRANGELOOSE",`^\\s*(${c[d.XRANGEPLAINLOOSE]})\\s+-\\s+(${c[d.XRANGEPLAINLOOSE]})\\s*$`),w("STAR","(<|>)?=?\\s*\\*"),w("GTE0","^\\s*>=\\s*0\\.0\\.0\\s*$"),w("GTE0PRE","^\\s*>=\\s*0\\.0\\.0-0\\s*$")})(Eo,Eo.exports)),Eo.exports}var tl,wm;function Nf(){if(wm)return tl;wm=1;const e=Object.freeze({loose:!0}),t=Object.freeze({});return tl=n=>n?typeof n!="object"?e:n:t,tl}var rl,bm;function j_(){if(bm)return rl;bm=1;const e=/^[0-9]+$/,t=(n,a)=>{const i=e.test(n),s=e.test(a);return i&&s&&(n=+n,a=+a),n===a?0:i&&!s?-1:s&&!i?1:n<a?-1:1};return rl={compareIdentifiers:t,rcompareIdentifiers:(n,a)=>t(a,n)},rl}var nl,Em;function zt(){if(Em)return nl;Em=1;const e=Pc(),{MAX_LENGTH:t,MAX_SAFE_INTEGER:r}=Cc(),{safeRe:n,t:a}=Ls(),i=Nf(),{compareIdentifiers:s}=j_();class o{constructor(u,d){if(d=i(d),u instanceof o){if(u.loose===!!d.loose&&u.includePrerelease===!!d.includePrerelease)return u;u=u.version}else if(typeof u!="string")throw new TypeError(`Invalid version. Must be a string. Got type "${typeof u}".`);if(u.length>t)throw new TypeError(`version is longer than ${t} characters`);e("SemVer",u,d),this.options=d,this.loose=!!d.loose,this.includePrerelease=!!d.includePrerelease;const h=u.trim().match(d.loose?n[a.LOOSE]:n[a.FULL]);if(!h)throw new TypeError(`Invalid Version: ${u}`);if(this.raw=u,this.major=+h[1],this.minor=+h[2],this.patch=+h[3],this.major>r||this.major<0)throw new TypeError("Invalid major version");if(this.minor>r||this.minor<0)throw new TypeError("Invalid minor version");if(this.patch>r||this.patch<0)throw new TypeError("Invalid patch version");h[4]?this.prerelease=h[4].split(".").map(p=>{if(/^[0-9]+$/.test(p)){const y=+p;if(y>=0&&y<r)return y}return p}):this.prerelease=[],this.build=h[5]?h[5].split("."):[],this.format()}format(){return this.version=`${this.major}.${this.minor}.${this.patch}`,this.prerelease.length&&(this.version+=`-${this.prerelease.join(".")}`),this.version}toString(){return this.version}compare(u){if(e("SemVer.compare",this.version,this.options,u),!(u instanceof o)){if(typeof u=="string"&&u===this.version)return 0;u=new o(u,this.options)}return u.version===this.version?0:this.compareMain(u)||this.comparePre(u)}compareMain(u){return u instanceof o||(u=new o(u,this.options)),s(this.major,u.major)||s(this.minor,u.minor)||s(this.patch,u.patch)}comparePre(u){if(u instanceof o||(u=new o(u,this.options)),this.prerelease.length&&!u.prerelease.length)return-1;if(!this.prerelease.length&&u.prerelease.length)return 1;if(!this.prerelease.length&&!u.prerelease.length)return 0;let d=0;do{const h=this.prerelease[d],p=u.prerelease[d];if(e("prerelease compare",d,h,p),h===void 0&&p===void 0)return 0;if(p===void 0)return 1;if(h===void 0)return-1;if(h===p)continue;return s(h,p)}while(++d)}compareBuild(u){u instanceof o||(u=new o(u,this.options));let d=0;do{const h=this.build[d],p=u.build[d];if(e("build compare",d,h,p),h===void 0&&p===void 0)return 0;if(p===void 0)return 1;if(h===void 0)return-1;if(h===p)continue;return s(h,p)}while(++d)}inc(u,d,h){if(u.startsWith("pre")){if(!d&&h===!1)throw new Error("invalid increment argument: identifier is empty");if(d){const p=`-${d}`.match(this.options.loose?n[a.PRERELEASELOOSE]:n[a.PRERELEASE]);if(!p||p[1]!==d)throw new Error(`invalid identifier: ${d}`)}}switch(u){case"premajor":this.prerelease.length=0,this.patch=0,this.minor=0,this.major++,this.inc("pre",d,h);break;case"preminor":this.prerelease.length=0,this.patch=0,this.minor++,this.inc("pre",d,h);break;case"prepatch":this.prerelease.length=0,this.inc("patch",d,h),this.inc("pre",d,h);break;case"prerelease":this.prerelease.length===0&&this.inc("patch",d,h),this.inc("pre",d,h);break;case"release":if(this.prerelease.length===0)throw new Error(`version ${this.raw} is not a prerelease`);this.prerelease.length=0;break;case"major":(this.minor!==0||this.patch!==0||this.prerelease.length===0)&&this.major++,this.minor=0,this.patch=0,this.prerelease=[];break;case"minor":(this.patch!==0||this.prerelease.length===0)&&this.minor++,this.patch=0,this.prerelease=[];break;case"patch":this.prerelease.length===0&&this.patch++,this.prerelease=[];break;case"pre":{const p=Number(h)?1:0;if(this.prerelease.length===0)this.prerelease=[p];else{let y=this.prerelease.length;for(;--y>=0;)typeof this.prerelease[y]=="number"&&(this.prerelease[y]++,y=-2);if(y===-1){if(d===this.prerelease.join(".")&&h===!1)throw new Error("invalid increment argument: identifier already exists");this.prerelease.push(p)}}if(d){let y=[d,p];h===!1&&(y=[d]),s(this.prerelease[0],d)===0?isNaN(this.prerelease[1])&&(this.prerelease=y):this.prerelease=y}break}default:throw new Error(`invalid increment argument: ${u}`)}return this.raw=this.format(),this.build.length&&(this.raw+=`+${this.build.join(".")}`),this}}return nl=o,nl}var al,xm;function vi(){if(xm)return al;xm=1;const e=zt();return al=(r,n,a=!1)=>{if(r instanceof e)return r;try{return new e(r,n)}catch(i){if(!a)return null;throw i}},al}var il,Sm;function R$(){if(Sm)return il;Sm=1;const e=vi();return il=(r,n)=>{const a=e(r,n);return a?a.version:null},il}var sl,km;function $$(){if(km)return sl;km=1;const e=vi();return sl=(r,n)=>{const a=e(r.trim().replace(/^[=v]+/,""),n);return a?a.version:null},sl}var ol,Im;function A$(){if(Im)return ol;Im=1;const e=zt();return ol=(r,n,a,i,s)=>{typeof a=="string"&&(s=i,i=a,a=void 0);try{return new e(r instanceof e?r.version:r,a).inc(n,i,s).version}catch{return null}},ol}var cl,Om;function C$(){if(Om)return cl;Om=1;const e=vi();return cl=(r,n)=>{const a=e(r,null,!0),i=e(n,null,!0),s=a.compare(i);if(s===0)return null;const o=s>0,c=o?a:i,u=o?i:a,d=!!c.prerelease.length;if(!!u.prerelease.length&&!d){if(!u.patch&&!u.minor)return"major";if(u.compareMain(c)===0)return u.minor&&!u.patch?"minor":"patch"}const p=d?"pre":"";return a.major!==i.major?p+"major":a.minor!==i.minor?p+"minor":a.patch!==i.patch?p+"patch":"prerelease"},cl}var ul,Tm;function P$(){if(Tm)return ul;Tm=1;const e=zt();return ul=(r,n)=>new e(r,n).major,ul}var ll,Rm;function N$(){if(Rm)return ll;Rm=1;const e=zt();return ll=(r,n)=>new e(r,n).minor,ll}var dl,$m;function D$(){if($m)return dl;$m=1;const e=zt();return dl=(r,n)=>new e(r,n).patch,dl}var fl,Am;function L$(){if(Am)return fl;Am=1;const e=vi();return fl=(r,n)=>{const a=e(r,n);return a&&a.prerelease.length?a.prerelease:null},fl}var hl,Cm;function Ar(){if(Cm)return hl;Cm=1;const e=zt();return hl=(r,n,a)=>new e(r,a).compare(new e(n,a)),hl}var pl,Pm;function M$(){if(Pm)return pl;Pm=1;const e=Ar();return pl=(r,n,a)=>e(n,r,a),pl}var ml,Nm;function j$(){if(Nm)return ml;Nm=1;const e=Ar();return ml=(r,n)=>e(r,n,!0),ml}var gl,Dm;function Df(){if(Dm)return gl;Dm=1;const e=zt();return gl=(r,n,a)=>{const i=new e(r,a),s=new e(n,a);return i.compare(s)||i.compareBuild(s)},gl}var yl,Lm;function F$(){if(Lm)return yl;Lm=1;const e=Df();return yl=(r,n)=>r.sort((a,i)=>e(a,i,n)),yl}var vl,Mm;function B$(){if(Mm)return vl;Mm=1;const e=Df();return vl=(r,n)=>r.sort((a,i)=>e(i,a,n)),vl}var _l,jm;function Nc(){if(jm)return _l;jm=1;const e=Ar();return _l=(r,n,a)=>e(r,n,a)>0,_l}var wl,Fm;function Lf(){if(Fm)return wl;Fm=1;const e=Ar();return wl=(r,n,a)=>e(r,n,a)<0,wl}var bl,Bm;function F_(){if(Bm)return bl;Bm=1;const e=Ar();return bl=(r,n,a)=>e(r,n,a)===0,bl}var El,Um;function B_(){if(Um)return El;Um=1;const e=Ar();return El=(r,n,a)=>e(r,n,a)!==0,El}var xl,zm;function Mf(){if(zm)return xl;zm=1;const e=Ar();return xl=(r,n,a)=>e(r,n,a)>=0,xl}var Sl,qm;function jf(){if(qm)return Sl;qm=1;const e=Ar();return Sl=(r,n,a)=>e(r,n,a)<=0,Sl}var kl,Hm;function U_(){if(Hm)return kl;Hm=1;const e=F_(),t=B_(),r=Nc(),n=Mf(),a=Lf(),i=jf();return kl=(o,c,u,d)=>{switch(c){case"===":return typeof o=="object"&&(o=o.version),typeof u=="object"&&(u=u.version),o===u;case"!==":return typeof o=="object"&&(o=o.version),typeof u=="object"&&(u=u.version),o!==u;case"":case"=":case"==":return e(o,u,d);case"!=":return t(o,u,d);case">":return r(o,u,d);case">=":return n(o,u,d);case"<":return a(o,u,d);case"<=":return i(o,u,d);default:throw new TypeError(`Invalid operator: ${c}`)}},kl}var Il,Km;function U$(){if(Km)return Il;Km=1;const e=zt(),t=vi(),{safeRe:r,t:n}=Ls();return Il=(i,s)=>{if(i instanceof e)return i;if(typeof i=="number"&&(i=String(i)),typeof i!="string")return null;s=s||{};let o=null;if(!s.rtl)o=i.match(s.includePrerelease?r[n.COERCEFULL]:r[n.COERCE]);else{const y=s.includePrerelease?r[n.COERCERTLFULL]:r[n.COERCERTL];let g;for(;(g=y.exec(i))&&(!o||o.index+o[0].length!==i.length);)(!o||g.index+g[0].length!==o.index+o[0].length)&&(o=g),y.lastIndex=g.index+g[1].length+g[2].length;y.lastIndex=-1}if(o===null)return null;const c=o[2],u=o[3]||"0",d=o[4]||"0",h=s.includePrerelease&&o[5]?`-${o[5]}`:"",p=s.includePrerelease&&o[6]?`+${o[6]}`:"";return t(`${c}.${u}.${d}${h}${p}`,s)},Il}var Ol,Gm;function z$(){if(Gm)return Ol;Gm=1;class e{constructor(){this.max=1e3,this.map=new Map}get(r){const n=this.map.get(r);if(n!==void 0)return this.map.delete(r),this.map.set(r,n),n}delete(r){return this.map.delete(r)}set(r,n){if(!this.delete(r)&&n!==void 0){if(this.map.size>=this.max){const i=this.map.keys().next().value;this.delete(i)}this.map.set(r,n)}return this}}return Ol=e,Ol}var Tl,Wm;function Cr(){if(Wm)return Tl;Wm=1;const e=/\s+/g;class t{constructor(H,fe){if(fe=a(fe),H instanceof t)return H.loose===!!fe.loose&&H.includePrerelease===!!fe.includePrerelease?H:new t(H.raw,fe);if(H instanceof i)return this.raw=H.value,this.set=[[H]],this.formatted=void 0,this;if(this.options=fe,this.loose=!!fe.loose,this.includePrerelease=!!fe.includePrerelease,this.raw=H.trim().replace(e," "),this.set=this.raw.split("||").map(J=>this.parseRange(J.trim())).filter(J=>J.length),!this.set.length)throw new TypeError(`Invalid SemVer Range: ${this.raw}`);if(this.set.length>1){const J=this.set[0];if(this.set=this.set.filter(te=>!w(te[0])),this.set.length===0)this.set=[J];else if(this.set.length>1){for(const te of this.set)if(te.length===1&&b(te[0])){this.set=[te];break}}}this.formatted=void 0}get range(){if(this.formatted===void 0){this.formatted="";for(let H=0;H<this.set.length;H++){H>0&&(this.formatted+="||");const fe=this.set[H];for(let J=0;J<fe.length;J++)J>0&&(this.formatted+=" "),this.formatted+=fe[J].toString().trim()}}return this.formatted}format(){return this.range}toString(){return this.range}parseRange(H){const J=((this.options.includePrerelease&&y)|(this.options.loose&&g))+":"+H,te=n.get(J);if(te)return te;const Q=this.options.loose,re=Q?c[u.HYPHENRANGELOOSE]:c[u.HYPHENRANGE];H=H.replace(re,Ae(this.options.includePrerelease)),s("hyphen replace",H),H=H.replace(c[u.COMPARATORTRIM],d),s("comparator trim",H),H=H.replace(c[u.TILDETRIM],h),s("tilde trim",H),H=H.replace(c[u.CARETTRIM],p),s("caret trim",H);let xe=H.split(" ").map(je=>O(je,this.options)).join(" ").split(/\s+/).map(je=>qe(je,this.options));Q&&(xe=xe.filter(je=>(s("loose invalid filter",je,this.options),!!je.match(c[u.COMPARATORLOOSE])))),s("range list",xe);const Re=new Map,Te=xe.map(je=>new i(je,this.options));for(const je of Te){if(w(je))return[je];Re.set(je.value,je)}Re.size>1&&Re.has("")&&Re.delete("");const Ge=[...Re.values()];return n.set(J,Ge),Ge}intersects(H,fe){if(!(H instanceof t))throw new TypeError("a Range is required");return this.set.some(J=>x(J,fe)&&H.set.some(te=>x(te,fe)&&J.every(Q=>te.every(re=>Q.intersects(re,fe)))))}test(H){if(!H)return!1;if(typeof H=="string")try{H=new o(H,this.options)}catch{return!1}for(let fe=0;fe<this.set.length;fe++)if(Ve(this.set[fe],H,this.options))return!0;return!1}}Tl=t;const r=z$(),n=new r,a=Nf(),i=Dc(),s=Pc(),o=zt(),{safeRe:c,t:u,comparatorTrimReplace:d,tildeTrimReplace:h,caretTrimReplace:p}=Ls(),{FLAG_INCLUDE_PRERELEASE:y,FLAG_LOOSE:g}=Cc(),w=Y=>Y.value==="<0.0.0-0",b=Y=>Y.value==="",x=(Y,H)=>{let fe=!0;const J=Y.slice();let te=J.pop();for(;fe&&J.length;)fe=J.every(Q=>te.intersects(Q,H)),te=J.pop();return fe},O=(Y,H)=>(s("comp",Y,H),Y=K(Y,H),s("caret",Y),Y=B(Y,H),s("tildes",Y),Y=G(Y,H),s("xrange",Y),Y=Me(Y,H),s("stars",Y),Y),T=Y=>!Y||Y.toLowerCase()==="x"||Y==="*",B=(Y,H)=>Y.trim().split(/\s+/).map(fe=>U(fe,H)).join(" "),U=(Y,H)=>{const fe=H.loose?c[u.TILDELOOSE]:c[u.TILDE];return Y.replace(fe,(J,te,Q,re,xe)=>{s("tilde",Y,J,te,Q,re,xe);let Re;return T(te)?Re="":T(Q)?Re=`>=${te}.0.0 <${+te+1}.0.0-0`:T(re)?Re=`>=${te}.${Q}.0 <${te}.${+Q+1}.0-0`:xe?(s("replaceTilde pr",xe),Re=`>=${te}.${Q}.${re}-${xe} <${te}.${+Q+1}.0-0`):Re=`>=${te}.${Q}.${re} <${te}.${+Q+1}.0-0`,s("tilde return",Re),Re})},K=(Y,H)=>Y.trim().split(/\s+/).map(fe=>q(fe,H)).join(" "),q=(Y,H)=>{s("caret",Y,H);const fe=H.loose?c[u.CARETLOOSE]:c[u.CARET],J=H.includePrerelease?"-0":"";return Y.replace(fe,(te,Q,re,xe,Re)=>{s("caret",Y,te,Q,re,xe,Re);let Te;return T(Q)?Te="":T(re)?Te=`>=${Q}.0.0${J} <${+Q+1}.0.0-0`:T(xe)?Q==="0"?Te=`>=${Q}.${re}.0${J} <${Q}.${+re+1}.0-0`:Te=`>=${Q}.${re}.0${J} <${+Q+1}.0.0-0`:Re?(s("replaceCaret pr",Re),Q==="0"?re==="0"?Te=`>=${Q}.${re}.${xe}-${Re} <${Q}.${re}.${+xe+1}-0`:Te=`>=${Q}.${re}.${xe}-${Re} <${Q}.${+re+1}.0-0`:Te=`>=${Q}.${re}.${xe}-${Re} <${+Q+1}.0.0-0`):(s("no pr"),Q==="0"?re==="0"?Te=`>=${Q}.${re}.${xe}${J} <${Q}.${re}.${+xe+1}-0`:Te=`>=${Q}.${re}.${xe}${J} <${Q}.${+re+1}.0-0`:Te=`>=${Q}.${re}.${xe} <${+Q+1}.0.0-0`),s("caret return",Te),Te})},G=(Y,H)=>(s("replaceXRanges",Y,H),Y.split(/\s+/).map(fe=>Oe(fe,H)).join(" ")),Oe=(Y,H)=>{Y=Y.trim();const fe=H.loose?c[u.XRANGELOOSE]:c[u.XRANGE];return Y.replace(fe,(J,te,Q,re,xe,Re)=>{s("xRange",Y,J,te,Q,re,xe,Re);const Te=T(Q),Ge=Te||T(re),je=Ge||T(xe),_t=je;return te==="="&&_t&&(te=""),Re=H.includePrerelease?"-0":"",Te?te===">"||te==="<"?J="<0.0.0-0":J="*":te&&_t?(Ge&&(re=0),xe=0,te===">"?(te=">=",Ge?(Q=+Q+1,re=0,xe=0):(re=+re+1,xe=0)):te==="<="&&(te="<",Ge?Q=+Q+1:re=+re+1),te==="<"&&(Re="-0"),J=`${te+Q}.${re}.${xe}${Re}`):Ge?J=`>=${Q}.0.0${Re} <${+Q+1}.0.0-0`:je&&(J=`>=${Q}.${re}.0${Re} <${Q}.${+re+1}.0-0`),s("xRange return",J),J})},Me=(Y,H)=>(s("replaceStars",Y,H),Y.trim().replace(c[u.STAR],"")),qe=(Y,H)=>(s("replaceGTE0",Y,H),Y.trim().replace(c[H.includePrerelease?u.GTE0PRE:u.GTE0],"")),Ae=Y=>(H,fe,J,te,Q,re,xe,Re,Te,Ge,je,_t)=>(T(J)?fe="":T(te)?fe=`>=${J}.0.0${Y?"-0":""}`:T(Q)?fe=`>=${J}.${te}.0${Y?"-0":""}`:re?fe=`>=${fe}`:fe=`>=${fe}${Y?"-0":""}`,T(Te)?Re="":T(Ge)?Re=`<${+Te+1}.0.0-0`:T(je)?Re=`<${Te}.${+Ge+1}.0-0`:_t?Re=`<=${Te}.${Ge}.${je}-${_t}`:Y?Re=`<${Te}.${Ge}.${+je+1}-0`:Re=`<=${Re}`,`${fe} ${Re}`.trim()),Ve=(Y,H,fe)=>{for(let J=0;J<Y.length;J++)if(!Y[J].test(H))return!1;if(H.prerelease.length&&!fe.includePrerelease){for(let J=0;J<Y.length;J++)if(s(Y[J].semver),Y[J].semver!==i.ANY&&Y[J].semver.prerelease.length>0){const te=Y[J].semver;if(te.major===H.major&&te.minor===H.minor&&te.patch===H.patch)return!0}return!1}return!0};return Tl}var Rl,Vm;function Dc(){if(Vm)return Rl;Vm=1;const e=Symbol("SemVer ANY");class t{static get ANY(){return e}constructor(d,h){if(h=r(h),d instanceof t){if(d.loose===!!h.loose)return d;d=d.value}d=d.trim().split(/\s+/).join(" "),s("comparator",d,h),this.options=h,this.loose=!!h.loose,this.parse(d),this.semver===e?this.value="":this.value=this.operator+this.semver.version,s("comp",this)}parse(d){const h=this.options.loose?n[a.COMPARATORLOOSE]:n[a.COMPARATOR],p=d.match(h);if(!p)throw new TypeError(`Invalid comparator: ${d}`);this.operator=p[1]!==void 0?p[1]:"",this.operator==="="&&(this.operator=""),p[2]?this.semver=new o(p[2],this.options.loose):this.semver=e}toString(){return this.value}test(d){if(s("Comparator.test",d,this.options.loose),this.semver===e||d===e)return!0;if(typeof d=="string")try{d=new o(d,this.options)}catch{return!1}return i(d,this.operator,this.semver,this.options)}intersects(d,h){if(!(d instanceof t))throw new TypeError("a Comparator is required");return this.operator===""?this.value===""?!0:new c(d.value,h).test(this.value):d.operator===""?d.value===""?!0:new c(this.value,h).test(d.semver):(h=r(h),h.includePrerelease&&(this.value==="<0.0.0-0"||d.value==="<0.0.0-0")||!h.includePrerelease&&(this.value.startsWith("<0.0.0")||d.value.startsWith("<0.0.0"))?!1:!!(this.operator.startsWith(">")&&d.operator.startsWith(">")||this.operator.startsWith("<")&&d.operator.startsWith("<")||this.semver.version===d.semver.version&&this.operator.includes("=")&&d.operator.includes("=")||i(this.semver,"<",d.semver,h)&&this.operator.startsWith(">")&&d.operator.startsWith("<")||i(this.semver,">",d.semver,h)&&this.operator.startsWith("<")&&d.operator.startsWith(">")))}}Rl=t;const r=Nf(),{safeRe:n,t:a}=Ls(),i=U_(),s=Pc(),o=zt(),c=Cr();return Rl}var $l,Zm;function Lc(){if(Zm)return $l;Zm=1;const e=Cr();return $l=(r,n,a)=>{try{n=new e(n,a)}catch{return!1}return n.test(r)},$l}var Al,Jm;function q$(){if(Jm)return Al;Jm=1;const e=Cr();return Al=(r,n)=>new e(r,n).set.map(a=>a.map(i=>i.value).join(" ").trim().split(" ")),Al}var Cl,Qm;function H$(){if(Qm)return Cl;Qm=1;const e=zt(),t=Cr();return Cl=(n,a,i)=>{let s=null,o=null,c=null;try{c=new t(a,i)}catch{return null}return n.forEach(u=>{c.test(u)&&(!s||o.compare(u)===-1)&&(s=u,o=new e(s,i))}),s},Cl}var Pl,Ym;function K$(){if(Ym)return Pl;Ym=1;const e=zt(),t=Cr();return Pl=(n,a,i)=>{let s=null,o=null,c=null;try{c=new t(a,i)}catch{return null}return n.forEach(u=>{c.test(u)&&(!s||o.compare(u)===1)&&(s=u,o=new e(s,i))}),s},Pl}var Nl,Xm;function G$(){if(Xm)return Nl;Xm=1;const e=zt(),t=Cr(),r=Nc();return Nl=(a,i)=>{a=new t(a,i);let s=new e("0.0.0");if(a.test(s)||(s=new e("0.0.0-0"),a.test(s)))return s;s=null;for(let o=0;o<a.set.length;++o){const c=a.set[o];let u=null;c.forEach(d=>{const h=new e(d.semver.version);switch(d.operator){case">":h.prerelease.length===0?h.patch++:h.prerelease.push(0),h.raw=h.format();case"":case">=":(!u||r(h,u))&&(u=h);break;case"<":case"<=":break;default:throw new Error(`Unexpected operation: ${d.operator}`)}}),u&&(!s||r(s,u))&&(s=u)}return s&&a.test(s)?s:null},Nl}var Dl,eg;function W$(){if(eg)return Dl;eg=1;const e=Cr();return Dl=(r,n)=>{try{return new e(r,n).range||"*"}catch{return null}},Dl}var Ll,tg;function Ff(){if(tg)return Ll;tg=1;const e=zt(),t=Dc(),{ANY:r}=t,n=Cr(),a=Lc(),i=Nc(),s=Lf(),o=jf(),c=Mf();return Ll=(d,h,p,y)=>{d=new e(d,y),h=new n(h,y);let g,w,b,x,O;switch(p){case">":g=i,w=o,b=s,x=">",O=">=";break;case"<":g=s,w=c,b=i,x="<",O="<=";break;default:throw new TypeError('Must provide a hilo val of "<" or ">"')}if(a(d,h,y))return!1;for(let T=0;T<h.set.length;++T){const B=h.set[T];let U=null,K=null;if(B.forEach(q=>{q.semver===r&&(q=new t(">=0.0.0")),U=U||q,K=K||q,g(q.semver,U.semver,y)?U=q:b(q.semver,K.semver,y)&&(K=q)}),U.operator===x||U.operator===O||(!K.operator||K.operator===x)&&w(d,K.semver))return!1;if(K.operator===O&&b(d,K.semver))return!1}return!0},Ll}var Ml,rg;function V$(){if(rg)return Ml;rg=1;const e=Ff();return Ml=(r,n,a)=>e(r,n,">",a),Ml}var jl,ng;function Z$(){if(ng)return jl;ng=1;const e=Ff();return jl=(r,n,a)=>e(r,n,"<",a),jl}var Fl,ag;function J$(){if(ag)return Fl;ag=1;const e=Cr();return Fl=(r,n,a)=>(r=new e(r,a),n=new e(n,a),r.intersects(n,a)),Fl}var Bl,ig;function Q$(){if(ig)return Bl;ig=1;const e=Lc(),t=Ar();return Bl=(r,n,a)=>{const i=[];let s=null,o=null;const c=r.sort((p,y)=>t(p,y,a));for(const p of c)e(p,n,a)?(o=p,s||(s=p)):(o&&i.push([s,o]),o=null,s=null);s&&i.push([s,null]);const u=[];for(const[p,y]of i)p===y?u.push(p):!y&&p===c[0]?u.push("*"):y?p===c[0]?u.push(`<=${y}`):u.push(`${p} - ${y}`):u.push(`>=${p}`);const d=u.join(" || "),h=typeof n.raw=="string"?n.raw:String(n);return d.length<h.length?d:n},Bl}var Ul,sg;function Y$(){if(sg)return Ul;sg=1;const e=Cr(),t=Dc(),{ANY:r}=t,n=Lc(),a=Ar(),i=(h,p,y={})=>{if(h===p)return!0;h=new e(h,y),p=new e(p,y);let g=!1;e:for(const w of h.set){for(const b of p.set){const x=c(w,b,y);if(g=g||x!==null,x)continue e}if(g)return!1}return!0},s=[new t(">=0.0.0-0")],o=[new t(">=0.0.0")],c=(h,p,y)=>{if(h===p)return!0;if(h.length===1&&h[0].semver===r){if(p.length===1&&p[0].semver===r)return!0;y.includePrerelease?h=s:h=o}if(p.length===1&&p[0].semver===r){if(y.includePrerelease)return!0;p=o}const g=new Set;let w,b;for(const G of h)G.operator===">"||G.operator===">="?w=u(w,G,y):G.operator==="<"||G.operator==="<="?b=d(b,G,y):g.add(G.semver);if(g.size>1)return null;let x;if(w&&b){if(x=a(w.semver,b.semver,y),x>0)return null;if(x===0&&(w.operator!==">="||b.operator!=="<="))return null}for(const G of g){if(w&&!n(G,String(w),y)||b&&!n(G,String(b),y))return null;for(const Oe of p)if(!n(G,String(Oe),y))return!1;return!0}let O,T,B,U,K=b&&!y.includePrerelease&&b.semver.prerelease.length?b.semver:!1,q=w&&!y.includePrerelease&&w.semver.prerelease.length?w.semver:!1;K&&K.prerelease.length===1&&b.operator==="<"&&K.prerelease[0]===0&&(K=!1);for(const G of p){if(U=U||G.operator===">"||G.operator===">=",B=B||G.operator==="<"||G.operator==="<=",w){if(q&&G.semver.prerelease&&G.semver.prerelease.length&&G.semver.major===q.major&&G.semver.minor===q.minor&&G.semver.patch===q.patch&&(q=!1),G.operator===">"||G.operator===">="){if(O=u(w,G,y),O===G&&O!==w)return!1}else if(w.operator===">="&&!n(w.semver,String(G),y))return!1}if(b){if(K&&G.semver.prerelease&&G.semver.prerelease.length&&G.semver.major===K.major&&G.semver.minor===K.minor&&G.semver.patch===K.patch&&(K=!1),G.operator==="<"||G.operator==="<="){if(T=d(b,G,y),T===G&&T!==b)return!1}else if(b.operator==="<="&&!n(b.semver,String(G),y))return!1}if(!G.operator&&(b||w)&&x!==0)return!1}return!(w&&B&&!b&&x!==0||b&&U&&!w&&x!==0||q||K)},u=(h,p,y)=>{if(!h)return p;const g=a(h.semver,p.semver,y);return g>0?h:g<0||p.operator===">"&&h.operator===">="?p:h},d=(h,p,y)=>{if(!h)return p;const g=a(h.semver,p.semver,y);return g<0?h:g>0||p.operator==="<"&&h.operator==="<="?p:h};return Ul=i,Ul}var zl,og;function X$(){if(og)return zl;og=1;const e=Ls(),t=Cc(),r=zt(),n=j_(),a=vi(),i=R$(),s=$$(),o=A$(),c=C$(),u=P$(),d=N$(),h=D$(),p=L$(),y=Ar(),g=M$(),w=j$(),b=Df(),x=F$(),O=B$(),T=Nc(),B=Lf(),U=F_(),K=B_(),q=Mf(),G=jf(),Oe=U_(),Me=U$(),qe=Dc(),Ae=Cr(),Ve=Lc(),Y=q$(),H=H$(),fe=K$(),J=G$(),te=W$(),Q=Ff(),re=V$(),xe=Z$(),Re=J$(),Te=Q$(),Ge=Y$();return zl={parse:a,valid:i,clean:s,inc:o,diff:c,major:u,minor:d,patch:h,prerelease:p,compare:y,rcompare:g,compareLoose:w,compareBuild:b,sort:x,rsort:O,gt:T,lt:B,eq:U,neq:K,gte:q,lte:G,cmp:Oe,coerce:Me,Comparator:qe,Range:Ae,satisfies:Ve,toComparators:Y,maxSatisfying:H,minSatisfying:fe,minVersion:J,validRange:te,outside:Q,gtr:re,ltr:xe,intersects:Re,simplifyRange:Te,subset:Ge,SemVer:r,re:e.re,src:e.src,tokens:e.t,SEMVER_SPEC_VERSION:t.SEMVER_SPEC_VERSION,RELEASE_TYPES:t.RELEASE_TYPES,compareIdentifiers:n.compareIdentifiers,rcompareIdentifiers:n.rcompareIdentifiers},zl}X$();function Sn(e){if(!e||e.split("/").length>2||e.startsWith("/")||e.endsWith("/")||e.split(":").length>2)throw new Error(`Invalid identifier format: ${e}`);const[t,r]=e.split(":"),n=r||"latest";if(t.includes("/")){const[a,i]=t.split("/",2);if(!a||!i)throw new Error(`Invalid identifier format: ${e}`);return[a,i,n]}else{if(!t)throw new Error(`Invalid identifier format: ${e}`);return["-",t,n]}}class eA extends Error{constructor(t){super(t),Object.defineProperty(this,"status",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.name="LangSmithConflictError",this.status=409}}async function _e(e,t,r){let n;if(e.ok){r&&(n=await e.text());return}if(e.status===403)try{(await e.json())?.error==="org_scoped_key_requires_workspace"&&(n="This API key is org-scoped and requires workspace specification. Please provide 'workspaceId' parameter, or set LANGSMITH_WORKSPACE_ID environment variable.")}catch{const o=new Error(`${e.status} ${e.statusText}`);throw o.status=e?.status,o}if(n===void 0)try{n=await e.text()}catch{n=""}const a=`Failed to ${t}. Received status [${e.status}]: ${e.statusText}. Message: ${n}`;if(e.status===409)throw new eA(a);const i=new Error(a);throw i.status=e.status,i}const z_="ERR_CONFLICTING_ENDPOINTS";class tA extends Error{constructor(){super("You cannot provide both LANGSMITH_ENDPOINT / LANGCHAIN_ENDPOINT and LANGSMITH_RUNS_ENDPOINTS."),Object.defineProperty(this,"code",{enumerable:!0,configurable:!0,writable:!0,value:z_}),this.name="ConflictingEndpointsError"}}function rA(e){return typeof e=="object"&&e!==null&&e.code===z_}var cg="[...]",nA={result:"[Circular]"},nc=[],Ga=[];const aA=new TextEncoder;function iA(){return{depthLimit:Number.MAX_SAFE_INTEGER,edgesLimit:Number.MAX_SAFE_INTEGER}}function xo(e){return aA.encode(e)}function q_(e){if(e&&typeof e=="object"&&e!==null){if(e instanceof Map)return Object.fromEntries(e);if(e instanceof Set)return Array.from(e);if(e instanceof Date)return e.toISOString();if(e instanceof RegExp)return e.toString();if(e instanceof Error)return{name:e.name,message:e.message}}else if(typeof e=="bigint")return e.toString();return e}function sA(e){return function(t,r){return q_(r)}}function Xt(e,t,r,n,a){try{const i=JSON.stringify(e,sA(r),n);return xo(i)}catch(i){if(!i.message?.includes("Converting circular structure to JSON"))return console.warn(`[WARNING]: LangSmith received unserializable value.${t?`
Context: ${t}`:""}`),xo("[Unserializable]");Kt("SUPPRESS_CIRCULAR_JSON_WARNINGS")!=="true"&&console.warn(`[WARNING]: LangSmith received circular JSON. This will decrease tracer performance. ${t?`
Context: ${t}`:""}`),typeof a>"u"&&(a=iA()),Rd(e,"",0,[],void 0,0,a);let s;try{Ga.length===0?s=JSON.stringify(e,r,n):s=JSON.stringify(e,oA(r),n)}catch{return xo("[unable to serialize, circular reference is too complex to analyze]")}finally{for(;nc.length!==0;){const o=nc.pop();o.length===4?Object.defineProperty(o[0],o[1],o[3]):o[0][o[1]]=o[2]}}return xo(s)}}function ql(e,t,r,n){var a=Object.getOwnPropertyDescriptor(n,r);a.get!==void 0?a.configurable?(Object.defineProperty(n,r,{value:e}),nc.push([n,r,t,a])):Ga.push([t,r,e]):(n[r]=e,nc.push([n,r,t]))}function Rd(e,t,r,n,a,i,s){i+=1;var o;if(typeof e=="object"&&e!==null){for(o=0;o<n.length;o++)if(n[o]===e){ql(nA,e,t,a);return}if(typeof s.depthLimit<"u"&&i>s.depthLimit){ql(cg,e,t,a);return}if(typeof s.edgesLimit<"u"&&r+1>s.edgesLimit){ql(cg,e,t,a);return}if(n.push(e),Array.isArray(e))for(o=0;o<e.length;o++)Rd(e[o],o,o,n,e,i,s);else{e=q_(e);var c=Object.keys(e);for(o=0;o<c.length;o++){var u=c[o];Rd(e[u],u,o,n,e,i,s)}}n.pop()}}function oA(e){return e=typeof e<"u"?e:function(t,r){return r},function(t,r){if(Ga.length>0)for(var n=0;n<Ga.length;n++){var a=Ga[n];if(a[1]===t&&a[0]===r){r=a[2],Ga.splice(n,1);break}}return e.call(this,t,r)}}function ug(e,t){const r=N_(),n=t??D_(),a=e.extra??{},i=a.metadata;return e.extra={...a,runtime:{...r,...a?.runtime},metadata:{...n,...n.revision_id||"revision_id"in e&&e.revision_id?{revision_id:("revision_id"in e?e.revision_id:void 0)??n.revision_id}:{},...i}},e}const cA=e=>{const t=e?.toString()??Kt("TRACING_SAMPLING_RATE");if(t===void 0)return;const r=parseFloat(t);if(r<0||r>1)throw new Error(`LANGSMITH_TRACING_SAMPLING_RATE must be between 0 and 1 if set. Got: ${r}`);return r},uA=e=>{const r=e.replace("http://","").replace("https://","").split("/")[0].split(":")[0];return r==="localhost"||r==="127.0.0.1"||r==="::1"};async function lA(e){const t=[];for await(const r of e)t.push(r);return t}function So(e){if(e!==void 0)return e.trim().replace(/^"(.*)"$/,"$1").replace(/^'(.*)'$/,"$1")}const dA=async e=>{if(e?.status===429){const t=parseInt(e.headers.get("retry-after")??"10",10)*1e3;if(t>0)return await new Promise(r=>setTimeout(r,t)),!0}return!1};function lg(e){return typeof e=="number"?Number(e.toFixed(4)):e}class fA{constructor(){Object.defineProperty(this,"items",{enumerable:!0,configurable:!0,writable:!0,value:[]}),Object.defineProperty(this,"sizeBytes",{enumerable:!0,configurable:!0,writable:!0,value:0})}peek(){return this.items[0]}push(t){let r;const n=new Promise(i=>{r=i}),a=Xt(t.item,`Serializing run with id: ${t.item.id}`).length;return this.items.push({action:t.action,payload:t.item,otelContext:t.otelContext,apiKey:t.apiKey,apiUrl:t.apiUrl,itemPromiseResolve:r,itemPromise:n,size:a}),this.sizeBytes+=a,n}pop({upToSizeBytes:t,upToSize:r}){if(t<1)throw new Error("Number of bytes to pop off may not be less than 1.");const n=[];let a=0;for(;a+(this.peek()?.size??0)<t&&this.items.length>0&&n.length<r;){const i=this.items.shift();i&&(n.push(i),a+=i.size,this.sizeBytes-=i.size)}if(n.length===0&&this.items.length>0){const i=this.items.shift();n.push(i),a+=i.size,this.sizeBytes-=i.size}return[n.map(i=>({action:i.action,item:i.payload,otelContext:i.otelContext,apiKey:i.apiKey,apiUrl:i.apiUrl})),()=>n.forEach(i=>i.itemPromiseResolve())]}}const hA=24*1024*1024,pA=1e4,mA=100,dg="https://api.smith.langchain.com";class hs{get _fetch(){return this.fetchImplementation||QR(this.debug)}constructor(t={}){Object.defineProperty(this,"apiKey",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"apiUrl",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"webUrl",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"workspaceId",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"caller",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"batchIngestCaller",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"timeout_ms",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"_tenantId",{enumerable:!0,configurable:!0,writable:!0,value:null}),Object.defineProperty(this,"hideInputs",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"hideOutputs",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"tracingSampleRate",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"filteredPostUuids",{enumerable:!0,configurable:!0,writable:!0,value:new Set}),Object.defineProperty(this,"autoBatchTracing",{enumerable:!0,configurable:!0,writable:!0,value:!0}),Object.defineProperty(this,"autoBatchQueue",{enumerable:!0,configurable:!0,writable:!0,value:new fA}),Object.defineProperty(this,"autoBatchTimeout",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"autoBatchAggregationDelayMs",{enumerable:!0,configurable:!0,writable:!0,value:250}),Object.defineProperty(this,"batchSizeBytesLimit",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"batchSizeLimit",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"fetchOptions",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"settings",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"blockOnRootRunFinalization",{enumerable:!0,configurable:!0,writable:!0,value:Hr("LANGSMITH_TRACING_BACKGROUND")==="false"}),Object.defineProperty(this,"traceBatchConcurrency",{enumerable:!0,configurable:!0,writable:!0,value:5}),Object.defineProperty(this,"_serverInfo",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"_getServerInfoPromise",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"manualFlushMode",{enumerable:!0,configurable:!0,writable:!0,value:!1}),Object.defineProperty(this,"langSmithToOTELTranslator",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"fetchImplementation",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"cachedLSEnvVarsForMetadata",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"multipartStreamingDisabled",{enumerable:!0,configurable:!0,writable:!0,value:!1}),Object.defineProperty(this,"debug",{enumerable:!0,configurable:!0,writable:!0,value:Hr("LANGSMITH_DEBUG")==="true"});const r=hs.getDefaultClientConfig();if(this.tracingSampleRate=cA(t.tracingSamplingRate),this.apiUrl=So(t.apiUrl??r.apiUrl)??"",this.apiUrl.endsWith("/")&&(this.apiUrl=this.apiUrl.slice(0,-1)),this.apiKey=So(t.apiKey??r.apiKey),this.webUrl=So(t.webUrl??r.webUrl),this.webUrl?.endsWith("/")&&(this.webUrl=this.webUrl.slice(0,-1)),this.workspaceId=So(t.workspaceId??Kt("WORKSPACE_ID")),this.timeout_ms=t.timeout_ms??9e4,this.caller=new hm({...t.callerOptions??{},maxRetries:4,debug:t.debug??this.debug}),this.traceBatchConcurrency=t.traceBatchConcurrency??this.traceBatchConcurrency,this.traceBatchConcurrency<1)throw new Error("Trace batch concurrency must be positive.");this.debug=t.debug??this.debug,this.fetchImplementation=t.fetchImplementation,this.batchIngestCaller=new hm({maxRetries:2,maxConcurrency:this.traceBatchConcurrency,...t.callerOptions??{},onFailedResponseHook:dA,debug:t.debug??this.debug}),this.hideInputs=t.hideInputs??t.anonymizer??r.hideInputs,this.hideOutputs=t.hideOutputs??t.anonymizer??r.hideOutputs,this.autoBatchTracing=t.autoBatchTracing??this.autoBatchTracing,this.blockOnRootRunFinalization=t.blockOnRootRunFinalization??this.blockOnRootRunFinalization,this.batchSizeBytesLimit=t.batchSizeBytesLimit,this.batchSizeLimit=t.batchSizeLimit,this.fetchOptions=t.fetchOptions||{},this.manualFlushMode=t.manualFlushMode??this.manualFlushMode,L_()&&(this.langSmithToOTELTranslator=new p$),this.cachedLSEnvVarsForMetadata=D_()}static getDefaultClientConfig(){const t=Kt("API_KEY"),r=Kt("ENDPOINT")??dg,n=Kt("HIDE_INPUTS")==="true",a=Kt("HIDE_OUTPUTS")==="true";return{apiUrl:r,apiKey:t,webUrl:void 0,hideInputs:n,hideOutputs:a}}getHostUrl(){return this.webUrl?this.webUrl:uA(this.apiUrl)?(this.webUrl="http://localhost:3000",this.webUrl):this.apiUrl.endsWith("/api/v1")?(this.webUrl=this.apiUrl.replace("/api/v1",""),this.webUrl):this.apiUrl.includes("/api")&&!this.apiUrl.split(".",1)[0].endsWith("api")?(this.webUrl=this.apiUrl.replace("/api",""),this.webUrl):this.apiUrl.split(".",1)[0].includes("dev")?(this.webUrl="https://dev.smith.langchain.com",this.webUrl):this.apiUrl.split(".",1)[0].includes("eu")?(this.webUrl="https://eu.smith.langchain.com",this.webUrl):this.apiUrl.split(".",1)[0].includes("beta")?(this.webUrl="https://beta.smith.langchain.com",this.webUrl):(this.webUrl="https://smith.langchain.com",this.webUrl)}get headers(){const t={"User-Agent":`langsmith-js/${A_}`};return this.apiKey&&(t["x-api-key"]=`${this.apiKey}`),this.workspaceId&&(t["x-tenant-id"]=this.workspaceId),t}_getPlatformEndpointPath(t){return this.apiUrl.slice(-3)!=="/v1"&&this.apiUrl.slice(-4)!=="/v1/"?`/v1/platform/${t}`:`/platform/${t}`}async processInputs(t){return this.hideInputs===!1?t:this.hideInputs===!0?{}:typeof this.hideInputs=="function"?this.hideInputs(t):t}async processOutputs(t){return this.hideOutputs===!1?t:this.hideOutputs===!0?{}:typeof this.hideOutputs=="function"?this.hideOutputs(t):t}async prepareRunCreateOrUpdateInputs(t){const r={...t};return r.inputs!==void 0&&(r.inputs=await this.processInputs(r.inputs)),r.outputs!==void 0&&(r.outputs=await this.processOutputs(r.outputs)),r}async _getResponse(t,r){const n=r?.toString()??"",a=`${this.apiUrl}${t}?${n}`;return await this.caller.call(async()=>{const s=await this._fetch(a,{method:"GET",headers:this.headers,signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});return await _e(s,`fetch ${t}`),s})}async _get(t,r){return(await this._getResponse(t,r)).json()}async*_getPaginated(t,r=new URLSearchParams,n){let a=Number(r.get("offset"))||0;const i=Number(r.get("limit"))||100;for(;;){r.set("offset",String(a)),r.set("limit",String(i));const s=`${this.apiUrl}${t}?${r}`,o=await this.caller.call(async()=>{const u=await this._fetch(s,{method:"GET",headers:this.headers,signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});return await _e(u,`fetch ${t}`),u}),c=n?n(await o.json()):await o.json();if(c.length===0||(yield c,c.length<i))break;a+=c.length}}async*_getCursorPaginatedList(t,r=null,n="POST",a="runs"){const i=r?{...r}:{};for(;;){const s=JSON.stringify(i),c=await(await this.caller.call(async()=>{const d=await this._fetch(`${this.apiUrl}${t}`,{method:n,headers:{...this.headers,"Content-Type":"application/json"},signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions,body:s});return await _e(d,`fetch ${t}`),d})).json();if(!c||!c[a])break;yield c[a];const u=c.cursors;if(!u||!u.next)break;i.cursor=u.next}}_shouldSample(){return this.tracingSampleRate===void 0?!0:Math.random()<this.tracingSampleRate}_filterForSampling(t,r=!1){if(this.tracingSampleRate===void 0)return t;if(r){const n=[];for(const a of t)this.filteredPostUuids.has(a.trace_id)?a.id===a.trace_id&&this.filteredPostUuids.delete(a.trace_id):n.push(a);return n}else{const n=[];for(const a of t){const i=a.trace_id??a.id;this.filteredPostUuids.has(i)||(a.id===i?this._shouldSample()?n.push(a):this.filteredPostUuids.add(i):n.push(a))}return n}}async _getBatchSizeLimitBytes(){const t=await this._ensureServerInfo();return this.batchSizeBytesLimit??t.batch_ingest_config?.size_limit_bytes??hA}async _getBatchSizeLimit(){const t=await this._ensureServerInfo();return this.batchSizeLimit??t.batch_ingest_config?.size_limit??mA}async _getDatasetExamplesMultiPartSupport(){return(await this._ensureServerInfo()).instance_flags?.dataset_examples_multipart_enabled??!1}drainAutoBatchQueue({batchSizeLimitBytes:t,batchSizeLimit:r}){const n=[];for(;this.autoBatchQueue.items.length>0;){const[a,i]=this.autoBatchQueue.pop({upToSizeBytes:t,upToSize:r});if(!a.length){i();break}const s=a.reduce((u,d)=>{const h=d.apiUrl??this.apiUrl,p=d.apiKey??this.apiKey,g=d.apiKey===this.apiKey&&d.apiUrl===this.apiUrl?"default":`${h}|${p}`;return u[g]||(u[g]=[]),u[g].push(d),u},{}),o=[];for(const[u,d]of Object.entries(s)){const h=this._processBatch(d,{apiUrl:u==="default"?void 0:u.split("|")[0],apiKey:u==="default"?void 0:u.split("|")[1]});o.push(h)}const c=Promise.all(o).finally(i);n.push(c)}return Promise.all(n)}async _processBatch(t,r){if(t.length)try{if(this.langSmithToOTELTranslator!==void 0)this._sendBatchToOTELTranslator(t);else{const n={runCreates:t.filter(i=>i.action==="create").map(i=>i.item),runUpdates:t.filter(i=>i.action==="update").map(i=>i.item)},a=await this._ensureServerInfo();if(a?.batch_ingest_config?.use_multipart_endpoint){const i=a?.instance_flags?.gzip_body_enabled;await this.multipartIngestRuns(n,{...r,useGzip:i})}else await this.batchIngestRuns(n,r)}}catch(n){console.error("Error exporting batch:",n)}}_sendBatchToOTELTranslator(t){if(this.langSmithToOTELTranslator!==void 0){const r=new Map,n=[];for(const a of t)a.item.id&&a.otelContext&&(r.set(a.item.id,a.otelContext),a.action==="create"?n.push({operation:"post",id:a.item.id,trace_id:a.item.trace_id??a.item.id,run:a.item}):n.push({operation:"patch",id:a.item.id,trace_id:a.item.trace_id??a.item.id,run:a.item}));this.langSmithToOTELTranslator.exportBatch(n,r)}}async processRunOperation(t){clearTimeout(this.autoBatchTimeout),this.autoBatchTimeout=void 0,t.item=ug(t.item,this.cachedLSEnvVarsForMetadata);const r=this.autoBatchQueue.push(t);if(this.manualFlushMode)return r;const n=await this._getBatchSizeLimitBytes(),a=await this._getBatchSizeLimit();return(this.autoBatchQueue.sizeBytes>n||this.autoBatchQueue.items.length>a)&&this.drainAutoBatchQueue({batchSizeLimitBytes:n,batchSizeLimit:a}),this.autoBatchQueue.items.length>0&&(this.autoBatchTimeout=setTimeout(()=>{this.autoBatchTimeout=void 0,this.drainAutoBatchQueue({batchSizeLimitBytes:n,batchSizeLimit:a})},this.autoBatchAggregationDelayMs)),r}async _getServerInfo(){const r=await(await this.caller.call(async()=>{const n=await this._fetch(`${this.apiUrl}/info`,{method:"GET",headers:{Accept:"application/json"},signal:AbortSignal.timeout(pA),...this.fetchOptions});return await _e(n,"get server info"),n})).json();return this.debug&&console.log(`
=== LangSmith Server Configuration ===
`+JSON.stringify(r,null,2)+`
`),r}async _ensureServerInfo(){return this._getServerInfoPromise===void 0&&(this._getServerInfoPromise=(async()=>{if(this._serverInfo===void 0)try{this._serverInfo=await this._getServerInfo()}catch(t){console.warn(`[LANGSMITH]: Failed to fetch info on supported operations. Falling back to batch operations and default limits. Info: ${t.status??"Unspecified status code"} ${t.message}`)}return this._serverInfo??{}})()),this._getServerInfoPromise.then(t=>(this._serverInfo===void 0&&(this._getServerInfoPromise=void 0),t))}async _getSettings(){return this.settings||(this.settings=this._get("/settings")),await this.settings}async flush(){const t=await this._getBatchSizeLimitBytes(),r=await this._getBatchSizeLimit();await this.drainAutoBatchQueue({batchSizeLimitBytes:t,batchSizeLimit:r})}_cloneCurrentOTELContext(){const t=M_(),r=l$();if(this.langSmithToOTELTranslator!==void 0){const n=t.getActiveSpan();if(n)return t.setSpan(r.active(),n)}}async createRun(t,r){if(!this._filterForSampling([t]).length)return;const n={...this.headers,"Content-Type":"application/json"},a=t.project_name;delete t.project_name;const i=await this.prepareRunCreateOrUpdateInputs({session_name:a,...t,start_time:t.start_time??Date.now()});if(this.autoBatchTracing&&i.trace_id!==void 0&&i.dotted_order!==void 0){const c=this._cloneCurrentOTELContext();this.processRunOperation({action:"create",item:i,otelContext:c,apiKey:r?.apiKey,apiUrl:r?.apiUrl}).catch(console.error);return}const s=ug(i,this.cachedLSEnvVarsForMetadata);r?.apiKey!==void 0&&(n["x-api-key"]=r.apiKey),r?.workspaceId!==void 0&&(n["x-tenant-id"]=r.workspaceId);const o=Xt(s,`Creating run with id: ${s.id}`);await this.caller.call(async()=>{const c=await this._fetch(`${r?.apiUrl??this.apiUrl}/runs`,{method:"POST",headers:n,signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions,body:o});return await _e(c,"create run",!0),c})}async batchIngestRuns({runCreates:t,runUpdates:r},n){if(t===void 0&&r===void 0)return;let a=await Promise.all(t?.map(c=>this.prepareRunCreateOrUpdateInputs(c))??[]),i=await Promise.all(r?.map(c=>this.prepareRunCreateOrUpdateInputs(c))??[]);if(a.length>0&&i.length>0){const c=a.reduce((d,h)=>(h.id&&(d[h.id]=h),d),{}),u=[];for(const d of i)d.id!==void 0&&c[d.id]?c[d.id]={...c[d.id],...d}:u.push(d);a=Object.values(c),i=u}const s={post:a,patch:i};if(!s.post.length&&!s.patch.length)return;const o={post:[],patch:[]};for(const c of["post","patch"]){const u=c,d=s[u].reverse();let h=d.pop();for(;h!==void 0;)o[u].push(h),h=d.pop()}if(o.post.length>0||o.patch.length>0){const c=o.post.map(u=>u.id).concat(o.patch.map(u=>u.id)).join(",");await this._postBatchIngestRuns(Xt(o,`Ingesting runs with ids: ${c}`),n)}}async _postBatchIngestRuns(t,r){const n={...this.headers,"Content-Type":"application/json",Accept:"application/json"};r?.apiKey!==void 0&&(n["x-api-key"]=r.apiKey),await this.batchIngestCaller.call(async()=>{const a=await this._fetch(`${r?.apiUrl??this.apiUrl}/runs/batch`,{method:"POST",headers:n,signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions,body:t});return await _e(a,"batch create run",!0),a})}async multipartIngestRuns({runCreates:t,runUpdates:r},n){if(t===void 0&&r===void 0)return;const a={};let i=[];for(const h of t??[]){const p=await this.prepareRunCreateOrUpdateInputs(h);p.id!==void 0&&p.attachments!==void 0&&(a[p.id]=p.attachments),delete p.attachments,i.push(p)}let s=[];for(const h of r??[])s.push(await this.prepareRunCreateOrUpdateInputs(h));if(i.find(h=>h.trace_id===void 0||h.dotted_order===void 0)!==void 0)throw new Error('Multipart ingest requires "trace_id" and "dotted_order" to be set when creating a run');if(s.find(h=>h.trace_id===void 0||h.dotted_order===void 0)!==void 0)throw new Error('Multipart ingest requires "trace_id" and "dotted_order" to be set when updating a run');if(i.length>0&&s.length>0){const h=i.reduce((y,g)=>(g.id&&(y[g.id]=g),y),{}),p=[];for(const y of s)y.id!==void 0&&h[y.id]?h[y.id]={...h[y.id],...y}:p.push(y);i=Object.values(h),s=p}if(i.length===0&&s.length===0)return;const u=[],d=[];for(const[h,p]of[["post",i],["patch",s]])for(const y of p){const{inputs:g,outputs:w,events:b,extra:x,error:O,serialized:T,attachments:B,...U}=y,K={inputs:g,outputs:w,events:b,extra:x,error:O,serialized:T},q=Xt(U,`Serializing for multipart ingestion of run with id: ${U.id}`);d.push({name:`${h}.${U.id}`,payload:new Blob([q],{type:`application/json; length=${q.length}`})});for(const[G,Oe]of Object.entries(K)){if(Oe===void 0)continue;const Me=Xt(Oe,`Serializing ${G} for multipart ingestion of run with id: ${U.id}`);d.push({name:`${h}.${U.id}.${G}`,payload:new Blob([Me],{type:`application/json; length=${Me.length}`})})}if(U.id!==void 0){const G=a[U.id];if(G){delete a[U.id];for(const[Oe,Me]of Object.entries(G)){let qe,Ae;if(Array.isArray(Me)?[qe,Ae]=Me:(qe=Me.mimeType,Ae=Me.data),Oe.includes(".")){console.warn(`Skipping attachment '${Oe}' for run ${U.id}: Invalid attachment name. Attachment names must not contain periods ('.'). Please rename the attachment and try again.`);continue}d.push({name:`attachment.${U.id}.${Oe}`,payload:new Blob([Ae],{type:`${qe}; length=${Ae.byteLength}`})})}}}u.push(`trace=${U.trace_id},id=${U.id}`)}await this._sendMultipartRequest(d,u.join("; "),n)}async _createNodeFetchBody(t,r){const n=[];for(const s of t)n.push(new Blob([`--${r}\r
`])),n.push(new Blob([`Content-Disposition: form-data; name="${s.name}"\r
`,`Content-Type: ${s.payload.type}\r
\r
`])),n.push(s.payload),n.push(new Blob([`\r
`]));return n.push(new Blob([`--${r}--\r
`])),await new Blob(n).arrayBuffer()}async _createMultipartStream(t,r){const n=new TextEncoder;return new ReadableStream({async start(i){const s=async o=>{typeof o=="string"?i.enqueue(n.encode(o)):i.enqueue(o)};for(const o of t){await s(`--${r}\r
`),await s(`Content-Disposition: form-data; name="${o.name}"\r
`),await s(`Content-Type: ${o.payload.type}\r
\r
`);const u=o.payload.stream().getReader();try{let d;for(;!(d=await u.read()).done;)i.enqueue(d.value)}finally{u.releaseLock()}await s(`\r
`)}await s(`--${r}--\r
`),i.close()}})}async _sendMultipartRequest(t,r,n){const a="----LangSmithFormBoundary"+Math.random().toString(36).slice(2),i=JR(),s=()=>this._createNodeFetchBody(t,a),o=()=>this._createMultipartStream(t,a),c=async u=>this.batchIngestCaller.call(async()=>{const d=await u(),h={...this.headers,"Content-Type":`multipart/form-data; boundary=${a}`};n?.apiKey!==void 0&&(h["x-api-key"]=n.apiKey);let p=d;n?.useGzip&&typeof d=="object"&&"pipeThrough"in d&&(p=d.pipeThrough(new CompressionStream("gzip")),h["Content-Encoding"]="gzip");const y=await this._fetch(`${n?.apiUrl??this.apiUrl}/runs/multipart`,{method:"POST",headers:h,body:p,duplex:"half",signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});return await _e(y,"Failed to send multipart request",!0),y});try{let u,d=!1;!i&&!this.multipartStreamingDisabled&&P_()!=="bun"?(d=!0,u=await c(o)):u=await c(s),(!this.multipartStreamingDisabled||d)&&u.status===422&&(n?.apiUrl??this.apiUrl)!==dg&&(console.warn(`Streaming multipart upload to ${n?.apiUrl??this.apiUrl}/runs/multipart failed. This usually means the host does not support chunked uploads. Retrying with a buffered upload for operation "${r}".`),this.multipartStreamingDisabled=!0,u=await c(s))}catch(u){console.warn(`${u.message.trim()}

Context: ${r}`)}}async updateRun(t,r,n){De(t),r.inputs&&(r.inputs=await this.processInputs(r.inputs)),r.outputs&&(r.outputs=await this.processOutputs(r.outputs));const a={...r,id:t};if(!this._filterForSampling([a],!0).length)return;if(this.autoBatchTracing&&a.trace_id!==void 0&&a.dotted_order!==void 0){const o=this._cloneCurrentOTELContext();if(r.end_time!==void 0&&a.parent_run_id===void 0&&this.blockOnRootRunFinalization&&!this.manualFlushMode){await this.processRunOperation({action:"update",item:a,otelContext:o,apiKey:n?.apiKey,apiUrl:n?.apiUrl}).catch(console.error);return}else this.processRunOperation({action:"update",item:a,otelContext:o,apiKey:n?.apiKey,apiUrl:n?.apiUrl}).catch(console.error);return}const i={...this.headers,"Content-Type":"application/json"};n?.apiKey!==void 0&&(i["x-api-key"]=n.apiKey),n?.workspaceId!==void 0&&(i["x-tenant-id"]=n.workspaceId);const s=Xt(r,`Serializing payload to update run with id: ${t}`);await this.caller.call(async()=>{const o=await this._fetch(`${n?.apiUrl??this.apiUrl}/runs/${t}`,{method:"PATCH",headers:i,signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions,body:s});return await _e(o,"update run",!0),o})}async readRun(t,{loadChildRuns:r}={loadChildRuns:!1}){De(t);let n=await this._get(`/runs/${t}`);return r&&(n=await this._loadChildRuns(n)),n}async getRunUrl({runId:t,run:r,projectOpts:n}){if(r!==void 0){let a;r.session_id?a=r.session_id:n?.projectName?a=(await this.readProject({projectName:n?.projectName})).id:n?.projectId?a=n?.projectId:a=(await this.readProject({projectName:Kt("PROJECT")||"default"})).id;const i=await this._getTenantId();return`${this.getHostUrl()}/o/${i}/projects/p/${a}/r/${r.id}?poll=true`}else if(t!==void 0){const a=await this.readRun(t);if(!a.app_path)throw new Error(`Run ${t} has no app_path`);return`${this.getHostUrl()}${a.app_path}`}else throw new Error("Must provide either runId or run")}async _loadChildRuns(t){const r=await lA(this.listRuns({isRoot:!1,projectId:t.session_id,traceId:t.trace_id})),n={},a={};r.sort((i,s)=>(i?.dotted_order??"").localeCompare(s?.dotted_order??""));for(const i of r){if(i.parent_run_id===null||i.parent_run_id===void 0)throw new Error(`Child run ${i.id} has no parent`);i.dotted_order?.startsWith(t.dotted_order??"")&&i.id!==t.id&&(i.parent_run_id in n||(n[i.parent_run_id]=[]),n[i.parent_run_id].push(i),a[i.id]=i)}t.child_runs=n[t.id]||[];for(const i in n)i!==t.id&&(a[i].child_runs=n[i]);return t}async*listRuns(t){const{projectId:r,projectName:n,parentRunId:a,traceId:i,referenceExampleId:s,startTime:o,executionOrder:c,isRoot:u,runType:d,error:h,id:p,query:y,filter:g,traceFilter:w,treeFilter:b,limit:x,select:O,order:T}=t;let B=[];if(r&&(B=Array.isArray(r)?r:[r]),n){const G=Array.isArray(n)?n:[n],Oe=await Promise.all(G.map(Me=>this.readProject({projectName:Me}).then(qe=>qe.id)));B.push(...Oe)}const U=["app_path","completion_cost","completion_tokens","dotted_order","end_time","error","events","extra","feedback_stats","first_token_time","id","inputs","name","outputs","parent_run_id","parent_run_ids","prompt_cost","prompt_tokens","reference_example_id","run_type","session_id","start_time","status","tags","total_cost","total_tokens","trace_id"],K={session:B.length?B:null,run_type:d,reference_example:s,query:y,filter:g,trace_filter:w,tree_filter:b,execution_order:c,parent_run:a,start_time:o?o.toISOString():null,error:h,id:p,limit:x,trace:i,select:O||U,is_root:u,order:T};K.select.includes("child_run_ids")&&Td("Deprecated: 'child_run_ids' in the listRuns select parameter is deprecated and will be removed in a future version.");let q=0;for await(const G of this._getCursorPaginatedList("/runs/query",K))if(x){if(q>=x)break;if(G.length+q>x){yield*G.slice(0,x-q);break}q+=G.length,yield*G}else yield*G}async*listGroupRuns(t){const{projectId:r,projectName:n,groupBy:a,filter:i,startTime:s,endTime:o,limit:c,offset:u}=t,h={session_id:r||(await this.readProject({projectName:n})).id,group_by:a,filter:i,start_time:s?s.toISOString():null,end_time:o?o.toISOString():null,limit:Number(c)||100};let p=Number(u)||0;const y="/runs/group",g=`${this.apiUrl}${y}`;for(;;){const w={...h,offset:p},b=Object.fromEntries(Object.entries(w).filter(([K,q])=>q!==void 0)),x=JSON.stringify(b),T=await(await this.caller.call(async()=>{const K=await this._fetch(g,{method:"POST",headers:{...this.headers,"Content-Type":"application/json"},signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions,body:x});return await _e(K,`Failed to fetch ${y}`),K})).json(),{groups:B,total:U}=T;if(B.length===0)break;for(const K of B)yield K;if(p+=B.length,p>=U)break}}async getRunStats({id:t,trace:r,parentRun:n,runType:a,projectNames:i,projectIds:s,referenceExampleIds:o,startTime:c,endTime:u,error:d,query:h,filter:p,traceFilter:y,treeFilter:g,isRoot:w,dataSourceType:b}){let x=s||[];i&&(x=[...s||[],...await Promise.all(i.map(q=>this.readProject({projectName:q}).then(G=>G.id)))]);const T=Object.fromEntries(Object.entries({id:t,trace:r,parent_run:n,run_type:a,session:x,reference_example:o,start_time:c,end_time:u,error:d,query:h,filter:p,trace_filter:y,tree_filter:g,is_root:w,data_source_type:b}).filter(([q,G])=>G!==void 0)),B=JSON.stringify(T);return await(await this.caller.call(async()=>{const q=await this._fetch(`${this.apiUrl}/runs/stats`,{method:"POST",headers:{...this.headers,"Content-Type":"application/json"},signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions,body:B});return await _e(q,"get run stats"),q})).json()}async shareRun(t,{shareId:r}={}){const n={run_id:t,share_token:r||za()};De(t);const a=JSON.stringify(n),s=await(await this.caller.call(async()=>{const o=await this._fetch(`${this.apiUrl}/runs/${t}/share`,{method:"PUT",headers:this.headers,signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions,body:a});return await _e(o,"share run"),o})).json();if(s===null||!("share_token"in s))throw new Error("Invalid response from server");return`${this.getHostUrl()}/public/${s.share_token}/r`}async unshareRun(t){De(t),await this.caller.call(async()=>{const r=await this._fetch(`${this.apiUrl}/runs/${t}/share`,{method:"DELETE",headers:this.headers,signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});return await _e(r,"unshare run",!0),r})}async readRunSharedLink(t){De(t);const n=await(await this.caller.call(async()=>{const a=await this._fetch(`${this.apiUrl}/runs/${t}/share`,{method:"GET",headers:this.headers,signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});return await _e(a,"read run shared link"),a})).json();if(!(n===null||!("share_token"in n)))return`${this.getHostUrl()}/public/${n.share_token}/r`}async listSharedRuns(t,{runIds:r}={}){const n=new URLSearchParams({share_token:t});if(r!==void 0)for(const s of r)n.append("id",s);return De(t),await(await this.caller.call(async()=>{const s=await this._fetch(`${this.apiUrl}/public/${t}/runs${n}`,{method:"GET",headers:this.headers,signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});return await _e(s,"list shared runs"),s})).json()}async readDatasetSharedSchema(t,r){if(!t&&!r)throw new Error("Either datasetId or datasetName must be given");t||(t=(await this.readDataset({datasetName:r})).id),De(t);const a=await(await this.caller.call(async()=>{const i=await this._fetch(`${this.apiUrl}/datasets/${t}/share`,{method:"GET",headers:this.headers,signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});return await _e(i,"read dataset shared schema"),i})).json();return a.url=`${this.getHostUrl()}/public/${a.share_token}/d`,a}async shareDataset(t,r){if(!t&&!r)throw new Error("Either datasetId or datasetName must be given");t||(t=(await this.readDataset({datasetName:r})).id);const n={dataset_id:t};De(t);const a=JSON.stringify(n),s=await(await this.caller.call(async()=>{const o=await this._fetch(`${this.apiUrl}/datasets/${t}/share`,{method:"PUT",headers:this.headers,signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions,body:a});return await _e(o,"share dataset"),o})).json();return s.url=`${this.getHostUrl()}/public/${s.share_token}/d`,s}async unshareDataset(t){De(t),await this.caller.call(async()=>{const r=await this._fetch(`${this.apiUrl}/datasets/${t}/share`,{method:"DELETE",headers:this.headers,signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});return await _e(r,"unshare dataset",!0),r})}async readSharedDataset(t){return De(t),await(await this.caller.call(async()=>{const a=await this._fetch(`${this.apiUrl}/public/${t}/datasets`,{method:"GET",headers:this.headers,signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});return await _e(a,"read shared dataset"),a})).json()}async listSharedExamples(t,r){const n={};r?.exampleIds&&(n.id=r.exampleIds);const a=new URLSearchParams;Object.entries(n).forEach(([o,c])=>{Array.isArray(c)?c.forEach(u=>a.append(o,u)):a.append(o,c)});const i=await this.caller.call(async()=>{const o=await this._fetch(`${this.apiUrl}/public/${t}/examples?${a.toString()}`,{method:"GET",headers:this.headers,signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});return await _e(o,"list shared examples"),o}),s=await i.json();if(!i.ok)throw"detail"in s?new Error(`Failed to list shared examples.
Status: ${i.status}
Message: ${Array.isArray(s.detail)?s.detail.join(`
`):"Unspecified error"}`):new Error(`Failed to list shared examples: ${i.status} ${i.statusText}`);return s.map(o=>({...o,_hostUrl:this.getHostUrl()}))}async createProject({projectName:t,description:r=null,metadata:n=null,upsert:a=!1,projectExtra:i=null,referenceDatasetId:s=null}){const o=a?"?upsert=true":"",c=`${this.apiUrl}/sessions${o}`,u=i||{};n&&(u.metadata=n);const d={name:t,extra:u,description:r};s!==null&&(d.reference_dataset_id=s);const h=JSON.stringify(d);return await(await this.caller.call(async()=>{const g=await this._fetch(c,{method:"POST",headers:{...this.headers,"Content-Type":"application/json"},signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions,body:h});return await _e(g,"create project"),g})).json()}async updateProject(t,{name:r=null,description:n=null,metadata:a=null,projectExtra:i=null,endTime:s=null}){const o=`${this.apiUrl}/sessions/${t}`;let c=i;a&&(c={...c||{},metadata:a});const u=JSON.stringify({name:r,extra:c,description:n,end_time:s?new Date(s).toISOString():null});return await(await this.caller.call(async()=>{const p=await this._fetch(o,{method:"PATCH",headers:{...this.headers,"Content-Type":"application/json"},signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions,body:u});return await _e(p,"update project"),p})).json()}async hasProject({projectId:t,projectName:r}){let n="/sessions";const a=new URLSearchParams;if(t!==void 0&&r!==void 0)throw new Error("Must provide either projectName or projectId, not both");if(t!==void 0)De(t),n+=`/${t}`;else if(r!==void 0)a.append("name",r);else throw new Error("Must provide projectName or projectId");const i=await this.caller.call(async()=>{const s=await this._fetch(`${this.apiUrl}${n}?${a}`,{method:"GET",headers:this.headers,signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});return await _e(s,"has project"),s});try{const s=await i.json();return i.ok?Array.isArray(s)?s.length>0:!0:!1}catch{return!1}}async readProject({projectId:t,projectName:r,includeStats:n}){let a="/sessions";const i=new URLSearchParams;if(t!==void 0&&r!==void 0)throw new Error("Must provide either projectName or projectId, not both");if(t!==void 0)De(t),a+=`/${t}`;else if(r!==void 0)i.append("name",r);else throw new Error("Must provide projectName or projectId");n!==void 0&&i.append("include_stats",n.toString());const s=await this._get(a,i);let o;if(Array.isArray(s)){if(s.length===0)throw new Error(`Project[id=${t}, name=${r}] not found`);o=s[0]}else o=s;return o}async getProjectUrl({projectId:t,projectName:r}){if(t===void 0&&r===void 0)throw new Error("Must provide either projectName or projectId");const n=await this.readProject({projectId:t,projectName:r}),a=await this._getTenantId();return`${this.getHostUrl()}/o/${a}/projects/p/${n.id}`}async getDatasetUrl({datasetId:t,datasetName:r}){if(t===void 0&&r===void 0)throw new Error("Must provide either datasetName or datasetId");const n=await this.readDataset({datasetId:t,datasetName:r}),a=await this._getTenantId();return`${this.getHostUrl()}/o/${a}/datasets/${n.id}`}async _getTenantId(){if(this._tenantId!==null)return this._tenantId;const t=new URLSearchParams({limit:"1"});for await(const r of this._getPaginated("/sessions",t))return this._tenantId=r[0].tenant_id,r[0].tenant_id;throw new Error("No projects found to resolve tenant.")}async*listProjects({projectIds:t,name:r,nameContains:n,referenceDatasetId:a,referenceDatasetName:i,includeStats:s,datasetVersion:o,referenceFree:c,metadata:u}={}){const d=new URLSearchParams;if(t!==void 0)for(const h of t)d.append("id",h);if(r!==void 0&&d.append("name",r),n!==void 0&&d.append("name_contains",n),a!==void 0)d.append("reference_dataset",a);else if(i!==void 0){const h=await this.readDataset({datasetName:i});d.append("reference_dataset",h.id)}s!==void 0&&d.append("include_stats",s.toString()),o!==void 0&&d.append("dataset_version",o),c!==void 0&&d.append("reference_free",c.toString()),u!==void 0&&d.append("metadata",JSON.stringify(u));for await(const h of this._getPaginated("/sessions",d))yield*h}async deleteProject({projectId:t,projectName:r}){let n;if(t===void 0&&r===void 0)throw new Error("Must provide projectName or projectId");if(t!==void 0&&r!==void 0)throw new Error("Must provide either projectName or projectId, not both");t===void 0?n=(await this.readProject({projectName:r})).id:n=t,De(n),await this.caller.call(async()=>{const a=await this._fetch(`${this.apiUrl}/sessions/${n}`,{method:"DELETE",headers:this.headers,signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});return await _e(a,`delete session ${n} (${r})`,!0),a})}async uploadCsv({csvFile:t,fileName:r,inputKeys:n,outputKeys:a,description:i,dataType:s,name:o}){const c=`${this.apiUrl}/datasets/upload`,u=new FormData;return u.append("file",t,r),n.forEach(p=>{u.append("input_keys",p)}),a.forEach(p=>{u.append("output_keys",p)}),i&&u.append("description",i),s&&u.append("data_type",s),o&&u.append("name",o),await(await this.caller.call(async()=>{const p=await this._fetch(c,{method:"POST",headers:this.headers,signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions,body:u});return await _e(p,"upload CSV"),p})).json()}async createDataset(t,{description:r,dataType:n,inputsSchema:a,outputsSchema:i,metadata:s}={}){const o={name:t,description:r,extra:s?{metadata:s}:void 0};n&&(o.data_type=n),a&&(o.inputs_schema_definition=a),i&&(o.outputs_schema_definition=i);const c=JSON.stringify(o);return await(await this.caller.call(async()=>{const h=await this._fetch(`${this.apiUrl}/datasets`,{method:"POST",headers:{...this.headers,"Content-Type":"application/json"},signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions,body:c});return await _e(h,"create dataset"),h})).json()}async readDataset({datasetId:t,datasetName:r}){let n="/datasets";const a=new URLSearchParams({limit:"1"});if(t&&r)throw new Error("Must provide either datasetName or datasetId, not both");if(t)De(t),n+=`/${t}`;else if(r)a.append("name",r);else throw new Error("Must provide datasetName or datasetId");const i=await this._get(n,a);let s;if(Array.isArray(i)){if(i.length===0)throw new Error(`Dataset[id=${t}, name=${r}] not found`);s=i[0]}else s=i;return s}async hasDataset({datasetId:t,datasetName:r}){try{return await this.readDataset({datasetId:t,datasetName:r}),!0}catch(n){if(n instanceof Error&&n.message.toLocaleLowerCase().includes("not found"))return!1;throw n}}async diffDatasetVersions({datasetId:t,datasetName:r,fromVersion:n,toVersion:a}){let i=t;if(i===void 0&&r===void 0)throw new Error("Must provide either datasetName or datasetId");if(i!==void 0&&r!==void 0)throw new Error("Must provide either datasetName or datasetId, not both");i===void 0&&(i=(await this.readDataset({datasetName:r})).id);const s=new URLSearchParams({from_version:typeof n=="string"?n:n.toISOString(),to_version:typeof a=="string"?a:a.toISOString()});return await this._get(`/datasets/${i}/versions/diff`,s)}async readDatasetOpenaiFinetuning({datasetId:t,datasetName:r}){const n="/datasets";if(t===void 0)if(r!==void 0)t=(await this.readDataset({datasetName:r})).id;else throw new Error("Must provide either datasetName or datasetId");return(await(await this._getResponse(`${n}/${t}/openai_ft`)).text()).trim().split(`
`).map(o=>JSON.parse(o))}async*listDatasets({limit:t=100,offset:r=0,datasetIds:n,datasetName:a,datasetNameContains:i,metadata:s}={}){const o="/datasets",c=new URLSearchParams({limit:t.toString(),offset:r.toString()});if(n!==void 0)for(const u of n)c.append("id",u);a!==void 0&&c.append("name",a),i!==void 0&&c.append("name_contains",i),s!==void 0&&c.append("metadata",JSON.stringify(s));for await(const u of this._getPaginated(o,c))yield*u}async updateDataset(t){const{datasetId:r,datasetName:n,...a}=t;if(!r&&!n)throw new Error("Must provide either datasetName or datasetId");const i=r??(await this.readDataset({datasetName:n})).id;De(i);const s=JSON.stringify(a);return await(await this.caller.call(async()=>{const c=await this._fetch(`${this.apiUrl}/datasets/${i}`,{method:"PATCH",headers:{...this.headers,"Content-Type":"application/json"},signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions,body:s});return await _e(c,"update dataset"),c})).json()}async updateDatasetTag(t){const{datasetId:r,datasetName:n,asOf:a,tag:i}=t;if(!r&&!n)throw new Error("Must provide either datasetName or datasetId");const s=r??(await this.readDataset({datasetName:n})).id;De(s);const o=JSON.stringify({as_of:typeof a=="string"?a:a.toISOString(),tag:i});await this.caller.call(async()=>{const c=await this._fetch(`${this.apiUrl}/datasets/${s}/tags`,{method:"PUT",headers:{...this.headers,"Content-Type":"application/json"},signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions,body:o});return await _e(c,"update dataset tags",!0),c})}async deleteDataset({datasetId:t,datasetName:r}){let n="/datasets",a=t;if(t!==void 0&&r!==void 0)throw new Error("Must provide either datasetName or datasetId, not both");if(r!==void 0&&(a=(await this.readDataset({datasetName:r})).id),a!==void 0)De(a),n+=`/${a}`;else throw new Error("Must provide datasetName or datasetId");await this.caller.call(async()=>{const i=await this._fetch(this.apiUrl+n,{method:"DELETE",headers:this.headers,signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});return await _e(i,`delete ${n}`,!0),i})}async indexDataset({datasetId:t,datasetName:r,tag:n}){let a=t;if(!a&&!r)throw new Error("Must provide either datasetName or datasetId");if(a&&r)throw new Error("Must provide either datasetName or datasetId, not both");a||(a=(await this.readDataset({datasetName:r})).id),De(a);const s=JSON.stringify({tag:n});await(await this.caller.call(async()=>{const c=await this._fetch(`${this.apiUrl}/datasets/${a}/index`,{method:"POST",headers:{...this.headers,"Content-Type":"application/json"},signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions,body:s});return await _e(c,"index dataset"),c})).json()}async similarExamples(t,r,n,{filter:a}={}){const i={limit:n,inputs:t};a!==void 0&&(i.filter=a),De(r);const s=JSON.stringify(i);return(await(await this.caller.call(async()=>{const u=await this._fetch(`${this.apiUrl}/datasets/${r}/search`,{headers:{...this.headers,"Content-Type":"application/json"},signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions,method:"POST",body:s});return await _e(u,"fetch similar examples"),u})).json()).examples}async createExample(t,r,n){if(fg(t)&&(r!==void 0||n!==void 0))throw new Error("Cannot provide outputs or options when using ExampleCreate object");let a=r?n?.datasetId:t.dataset_id;const i=r?n?.datasetName:t.dataset_name;if(a===void 0&&i===void 0)throw new Error("Must provide either datasetName or datasetId");if(a!==void 0&&i!==void 0)throw new Error("Must provide either datasetName or datasetId, not both");a===void 0&&(a=(await this.readDataset({datasetName:i})).id);const s=(r?n?.createdAt:t.created_at)||new Date;let o;fg(t)?o=t:o={inputs:t,outputs:r,created_at:s?.toISOString(),id:n?.exampleId,metadata:n?.metadata,split:n?.split,source_run_id:n?.sourceRunId,use_source_run_io:n?.useSourceRunIO,use_source_run_attachments:n?.useSourceRunAttachments,attachments:n?.attachments};const c=await this._uploadExamplesMultipart(a,[o]);return await this.readExample(c.example_ids?.[0]??za())}async createExamples(t){if(Array.isArray(t)){if(t.length===0)return[];const O=t;let T=O[0].dataset_id;const B=O[0].dataset_name;if(T===void 0&&B===void 0)throw new Error("Must provide either datasetName or datasetId");if(T!==void 0&&B!==void 0)throw new Error("Must provide either datasetName or datasetId, not both");T===void 0&&(T=(await this.readDataset({datasetName:B})).id);const U=await this._uploadExamplesMultipart(T,O);return await Promise.all(U.example_ids.map(q=>this.readExample(q)))}const{inputs:r,outputs:n,metadata:a,splits:i,sourceRunIds:s,useSourceRunIOs:o,useSourceRunAttachments:c,attachments:u,exampleIds:d,datasetId:h,datasetName:p}=t;if(r===void 0)throw new Error("Must provide inputs when using legacy parameters");let y=h;const g=p;if(y===void 0&&g===void 0)throw new Error("Must provide either datasetName or datasetId");if(y!==void 0&&g!==void 0)throw new Error("Must provide either datasetName or datasetId, not both");y===void 0&&(y=(await this.readDataset({datasetName:g})).id);const w=r.map((O,T)=>({dataset_id:y,inputs:O,outputs:n?.[T],metadata:a?.[T],split:i?.[T],id:d?.[T],attachments:u?.[T],source_run_id:s?.[T],use_source_run_io:o?.[T],use_source_run_attachments:c?.[T]})),b=await this._uploadExamplesMultipart(y,w);return await Promise.all(b.example_ids.map(O=>this.readExample(O)))}async createLLMExample(t,r,n){return this.createExample({input:t},{output:r},n)}async createChatExample(t,r,n){const a=t.map(s=>pm(s)?mm(s):s),i=pm(r)?mm(r):r;return this.createExample({input:a},{output:i},n)}async readExample(t){De(t);const r=`/examples/${t}`,n=await this._get(r),{attachment_urls:a,...i}=n,s=i;return a&&(s.attachments=Object.entries(a).reduce((o,[c,u])=>(o[c.slice(11)]={presigned_url:u.presigned_url,mime_type:u.mime_type},o),{})),s}async*listExamples({datasetId:t,datasetName:r,exampleIds:n,asOf:a,splits:i,inlineS3Urls:s,metadata:o,limit:c,offset:u,filter:d,includeAttachments:h}={}){let p;if(t!==void 0&&r!==void 0)throw new Error("Must provide either datasetName or datasetId, not both");if(t!==void 0)p=t;else if(r!==void 0)p=(await this.readDataset({datasetName:r})).id;else throw new Error("Must provide a datasetName or datasetId");const y=new URLSearchParams({dataset:p}),g=a?typeof a=="string"?a:a?.toISOString():void 0;g&&y.append("as_of",g);const w=s??!0;if(y.append("inline_s3_urls",w.toString()),n!==void 0)for(const x of n)y.append("id",x);if(i!==void 0)for(const x of i)y.append("splits",x);if(o!==void 0){const x=JSON.stringify(o);y.append("metadata",x)}c!==void 0&&y.append("limit",c.toString()),u!==void 0&&y.append("offset",u.toString()),d!==void 0&&y.append("filter",d),h===!0&&["attachment_urls","outputs","metadata"].forEach(x=>y.append("select",x));let b=0;for await(const x of this._getPaginated("/examples",y)){for(const O of x){const{attachment_urls:T,...B}=O,U=B;T&&(U.attachments=Object.entries(T).reduce((K,[q,G])=>(K[q.slice(11)]={presigned_url:G.presigned_url,mime_type:G.mime_type||void 0},K),{})),yield U,b++}if(c!==void 0&&b>=c)break}}async deleteExample(t){De(t);const r=`/examples/${t}`;await this.caller.call(async()=>{const n=await this._fetch(this.apiUrl+r,{method:"DELETE",headers:this.headers,signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});return await _e(n,`delete ${r}`,!0),n})}async updateExample(t,r){let n;r?n=t:n=t.id,De(n);let a;r?a={id:n,...r}:a=t;let i;return a.dataset_id!==void 0?i=a.dataset_id:i=(await this.readExample(n)).dataset_id,this._updateExamplesMultipart(i,[a])}async updateExamples(t){let r;return t[0].dataset_id===void 0?r=(await this.readExample(t[0].id)).dataset_id:r=t[0].dataset_id,this._updateExamplesMultipart(r,t)}async readDatasetVersion({datasetId:t,datasetName:r,asOf:n,tag:a}){let i;if(t?i=t:i=(await this.readDataset({datasetName:r})).id,De(i),n&&a||!n&&!a)throw new Error("Exactly one of asOf and tag must be specified.");const s=new URLSearchParams;return n!==void 0&&s.append("as_of",typeof n=="string"?n:n.toISOString()),a!==void 0&&s.append("tag",a),await(await this.caller.call(async()=>{const c=await this._fetch(`${this.apiUrl}/datasets/${i}/version?${s.toString()}`,{method:"GET",headers:{...this.headers},signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});return await _e(c,"read dataset version"),c})).json()}async listDatasetSplits({datasetId:t,datasetName:r,asOf:n}){let a;if(t===void 0&&r===void 0)throw new Error("Must provide dataset name or ID");if(t!==void 0&&r!==void 0)throw new Error("Must provide either datasetName or datasetId, not both");t===void 0?a=(await this.readDataset({datasetName:r})).id:a=t,De(a);const i=new URLSearchParams,s=n?typeof n=="string"?n:n?.toISOString():void 0;return s&&i.append("as_of",s),await this._get(`/datasets/${a}/splits`,i)}async updateDatasetSplits({datasetId:t,datasetName:r,splitName:n,exampleIds:a,remove:i=!1}){let s;if(t===void 0&&r===void 0)throw new Error("Must provide dataset name or ID");if(t!==void 0&&r!==void 0)throw new Error("Must provide either datasetName or datasetId, not both");t===void 0?s=(await this.readDataset({datasetName:r})).id:s=t,De(s);const o={split_name:n,examples:a.map(u=>(De(u),u)),remove:i},c=JSON.stringify(o);await this.caller.call(async()=>{const u=await this._fetch(`${this.apiUrl}/datasets/${s}/splits`,{method:"PUT",headers:{...this.headers,"Content-Type":"application/json"},signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions,body:c});return await _e(u,"update dataset splits",!0),u})}async evaluateRun(t,r,{sourceInfo:n,loadChildRuns:a,referenceExample:i}={loadChildRuns:!1}){Td("This method is deprecated and will be removed in future LangSmith versions, use `evaluate` from `langsmith/evaluation` instead.");let s;if(typeof t=="string")s=await this.readRun(t,{loadChildRuns:a});else if(typeof t=="object"&&"id"in t)s=t;else throw new Error(`Invalid run type: ${typeof t}`);s.reference_example_id!==null&&s.reference_example_id!==void 0&&(i=await this.readExample(s.reference_example_id));const o=await r.evaluateRun(s,i),[c,u]=await this._logEvaluationFeedback(o,s,n);return u[0]}async createFeedback(t,r,{score:n,value:a,correction:i,comment:s,sourceInfo:o,feedbackSourceType:c="api",sourceRunId:u,feedbackId:d,feedbackConfig:h,projectId:p,comparativeExperimentId:y}){if(!t&&!p)throw new Error("One of runId or projectId must be provided");if(t&&p)throw new Error("Only one of runId or projectId can be provided");const g={type:c??"api",metadata:o??{}};u!==void 0&&g?.metadata!==void 0&&!g.metadata.__run&&(g.metadata.__run={run_id:u}),g?.metadata!==void 0&&g.metadata.__run?.run_id!==void 0&&De(g.metadata.__run.run_id);const w={id:d??za(),run_id:t,key:r,score:lg(n),value:a,correction:i,comment:s,feedback_source:g,comparative_experiment_id:y,feedbackConfig:h,session_id:p},b=JSON.stringify(w),x=`${this.apiUrl}/feedback`;return await this.caller.call(async()=>{const O=await this._fetch(x,{method:"POST",headers:{...this.headers,"Content-Type":"application/json"},signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions,body:b});return await _e(O,"create feedback",!0),O}),w}async updateFeedback(t,{score:r,value:n,correction:a,comment:i}){const s={};r!=null&&(s.score=lg(r)),n!=null&&(s.value=n),a!=null&&(s.correction=a),i!=null&&(s.comment=i),De(t);const o=JSON.stringify(s);await this.caller.call(async()=>{const c=await this._fetch(`${this.apiUrl}/feedback/${t}`,{method:"PATCH",headers:{...this.headers,"Content-Type":"application/json"},signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions,body:o});return await _e(c,"update feedback",!0),c})}async readFeedback(t){De(t);const r=`/feedback/${t}`;return await this._get(r)}async deleteFeedback(t){De(t);const r=`/feedback/${t}`;await this.caller.call(async()=>{const n=await this._fetch(this.apiUrl+r,{method:"DELETE",headers:this.headers,signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});return await _e(n,`delete ${r}`,!0),n})}async*listFeedback({runIds:t,feedbackKeys:r,feedbackSourceTypes:n}={}){const a=new URLSearchParams;if(t)for(const i of t)De(i),a.append("run",i);if(r)for(const i of r)a.append("key",i);if(n)for(const i of n)a.append("source",i);for await(const i of this._getPaginated("/feedback",a))yield*i}async createPresignedFeedbackToken(t,r,{expiration:n,feedbackConfig:a}={}){const i={run_id:t,feedback_key:r,feedback_config:a};n?typeof n=="string"?i.expires_at=n:(n?.hours||n?.minutes||n?.days)&&(i.expires_in=n):i.expires_in={hours:3};const s=JSON.stringify(i);return await(await this.caller.call(async()=>{const c=await this._fetch(`${this.apiUrl}/feedback/tokens`,{method:"POST",headers:{...this.headers,"Content-Type":"application/json"},signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions,body:s});return await _e(c,"create presigned feedback token"),c})).json()}async createComparativeExperiment({name:t,experimentIds:r,referenceDatasetId:n,createdAt:a,description:i,metadata:s,id:o}){if(r.length===0)throw new Error("At least one experiment is required");if(n||(n=(await this.readProject({projectId:r[0]})).reference_dataset_id),!n==null)throw new Error("A reference dataset is required");const c={id:o,name:t,experiment_ids:r,reference_dataset_id:n,description:i,created_at:(a??new Date)?.toISOString(),extra:{}};s&&(c.extra.metadata=s);const u=JSON.stringify(c);return(await this.caller.call(async()=>{const h=await this._fetch(`${this.apiUrl}/datasets/comparative`,{method:"POST",headers:{...this.headers,"Content-Type":"application/json"},signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions,body:u});return await _e(h,"create comparative experiment"),h})).json()}async*listPresignedFeedbackTokens(t){De(t);const r=new URLSearchParams({run_id:t});for await(const n of this._getPaginated("/feedback/tokens",r))yield*n}_selectEvalResults(t){let r;return"results"in t?r=t.results:Array.isArray(t)?r=t:r=[t],r}async _logEvaluationFeedback(t,r,n){const a=this._selectEvalResults(t),i=[];for(const s of a){let o=n||{};s.evaluatorInfo&&(o={...s.evaluatorInfo,...o});let c=null;s.targetRunId?c=s.targetRunId:r&&(c=r.id),i.push(await this.createFeedback(c,s.key,{score:s.score,value:s.value,comment:s.comment,correction:s.correction,sourceInfo:o,sourceRunId:s.sourceRunId,feedbackConfig:s.feedbackConfig,feedbackSourceType:"model"}))}return[a,i]}async logEvaluationFeedback(t,r,n){const[a]=await this._logEvaluationFeedback(t,r,n);return a}async*listAnnotationQueues(t={}){const{queueIds:r,name:n,nameContains:a,limit:i}=t,s=new URLSearchParams;r&&r.forEach((c,u)=>{De(c,`queueIds[${u}]`),s.append("ids",c)}),n&&s.append("name",n),a&&s.append("name_contains",a),s.append("limit",(i!==void 0?Math.min(i,100):100).toString());let o=0;for await(const c of this._getPaginated("/annotation-queues",s))if(yield*c,o++,i!==void 0&&o>=i)break}async createAnnotationQueue(t){const{name:r,description:n,queueId:a,rubricInstructions:i}=t,s={name:r,description:n,id:a||za(),rubric_instructions:i},o=JSON.stringify(Object.fromEntries(Object.entries(s).filter(([u,d])=>d!==void 0)));return(await this.caller.call(async()=>{const u=await this._fetch(`${this.apiUrl}/annotation-queues`,{method:"POST",headers:{...this.headers,"Content-Type":"application/json"},signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions,body:o});return await _e(u,"create annotation queue"),u})).json()}async readAnnotationQueue(t){return(await this.caller.call(async()=>{const n=await this._fetch(`${this.apiUrl}/annotation-queues/${De(t,"queueId")}`,{method:"GET",headers:this.headers,signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});return await _e(n,"read annotation queue"),n})).json()}async updateAnnotationQueue(t,r){const{name:n,description:a,rubricInstructions:i}=r,s=JSON.stringify({name:n,description:a,rubric_instructions:i});await this.caller.call(async()=>{const o=await this._fetch(`${this.apiUrl}/annotation-queues/${De(t,"queueId")}`,{method:"PATCH",headers:{...this.headers,"Content-Type":"application/json"},signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions,body:s});return await _e(o,"update annotation queue",!0),o})}async deleteAnnotationQueue(t){await this.caller.call(async()=>{const r=await this._fetch(`${this.apiUrl}/annotation-queues/${De(t,"queueId")}`,{method:"DELETE",headers:{...this.headers,Accept:"application/json"},signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});return await _e(r,"delete annotation queue",!0),r})}async addRunsToAnnotationQueue(t,r){const n=JSON.stringify(r.map((a,i)=>De(a,`runIds[${i}]`).toString()));await this.caller.call(async()=>{const a=await this._fetch(`${this.apiUrl}/annotation-queues/${De(t,"queueId")}/runs`,{method:"POST",headers:{...this.headers,"Content-Type":"application/json"},signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions,body:n});return await _e(a,"add runs to annotation queue",!0),a})}async getRunFromAnnotationQueue(t,r){const n=`/annotation-queues/${De(t,"queueId")}/run`;return(await this.caller.call(async()=>{const i=await this._fetch(`${this.apiUrl}${n}/${r}`,{method:"GET",headers:this.headers,signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});return await _e(i,"get run from annotation queue"),i})).json()}async deleteRunFromAnnotationQueue(t,r){await this.caller.call(async()=>{const n=await this._fetch(`${this.apiUrl}/annotation-queues/${De(t,"queueId")}/runs/${De(r,"queueRunId")}`,{method:"DELETE",headers:{...this.headers,Accept:"application/json"},signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});return await _e(n,"delete run from annotation queue",!0),n})}async getSizeFromAnnotationQueue(t){return(await this.caller.call(async()=>{const n=await this._fetch(`${this.apiUrl}/annotation-queues/${De(t,"queueId")}/size`,{method:"GET",headers:this.headers,signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});return await _e(n,"get size from annotation queue"),n})).json()}async _currentTenantIsOwner(t){const r=await this._getSettings();return t=="-"||r.tenant_handle===t}async _ownerConflictError(t,r){const n=await this._getSettings();return new Error(`Cannot ${t} for another tenant.

      Current tenant: ${n.tenant_handle}

      Requested tenant: ${r}`)}async _getLatestCommitHash(t){const n=await(await this.caller.call(async()=>{const a=await this._fetch(`${this.apiUrl}/commits/${t}/?limit=1&offset=0`,{method:"GET",headers:this.headers,signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});return await _e(a,"get latest commit hash"),a})).json();if(n.commits.length!==0)return n.commits[0].commit_hash}async _likeOrUnlikePrompt(t,r){const[n,a,i]=Sn(t),s=JSON.stringify({like:r});return(await this.caller.call(async()=>{const c=await this._fetch(`${this.apiUrl}/likes/${n}/${a}`,{method:"POST",headers:{...this.headers,"Content-Type":"application/json"},signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions,body:s});return await _e(c,`${r?"like":"unlike"} prompt`),c})).json()}async _getPromptUrl(t){const[r,n,a]=Sn(t);if(await this._currentTenantIsOwner(r)){const i=await this._getSettings();return a!=="latest"?`${this.getHostUrl()}/prompts/${n}/${a.substring(0,8)}?organizationId=${i.id}`:`${this.getHostUrl()}/prompts/${n}?organizationId=${i.id}`}else return a!=="latest"?`${this.getHostUrl()}/hub/${r}/${n}/${a.substring(0,8)}`:`${this.getHostUrl()}/hub/${r}/${n}`}async promptExists(t){return!!await this.getPrompt(t)}async likePrompt(t){return this._likeOrUnlikePrompt(t,!0)}async unlikePrompt(t){return this._likeOrUnlikePrompt(t,!1)}async*listCommits(t){for await(const r of this._getPaginated(`/commits/${t}/`,new URLSearchParams,n=>n.commits))yield*r}async*listPrompts(t){const r=new URLSearchParams;r.append("sort_field",t?.sortField??"updated_at"),r.append("sort_direction","desc"),r.append("is_archived",(!!t?.isArchived).toString()),t?.isPublic!==void 0&&r.append("is_public",t.isPublic.toString()),t?.query&&r.append("query",t.query);for await(const n of this._getPaginated("/repos",r,a=>a.repos))yield*n}async getPrompt(t){const[r,n,a]=Sn(t),s=await(await this.caller.call(async()=>{const o=await this._fetch(`${this.apiUrl}/repos/${r}/${n}`,{method:"GET",headers:this.headers,signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});return o?.status===404?null:(await _e(o,"get prompt"),o)}))?.json();return s?.repo?s.repo:null}async createPrompt(t,r){const n=await this._getSettings();if(r?.isPublic&&!n.tenant_handle)throw new Error(`Cannot create a public prompt without first

        creating a LangChain Hub handle.
        You can add a handle by creating a public prompt at:

        https://smith.langchain.com/prompts`);const[a,i,s]=Sn(t);if(!await this._currentTenantIsOwner(a))throw await this._ownerConflictError("create a prompt",a);const o={repo_handle:i,...r?.description&&{description:r.description},...r?.readme&&{readme:r.readme},...r?.tags&&{tags:r.tags},is_public:!!r?.isPublic},c=JSON.stringify(o),u=await this.caller.call(async()=>{const h=await this._fetch(`${this.apiUrl}/repos/`,{method:"POST",headers:{...this.headers,"Content-Type":"application/json"},signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions,body:c});return await _e(h,"create prompt"),h}),{repo:d}=await u.json();return d}async createCommit(t,r,n){if(!await this.promptExists(t))throw new Error("Prompt does not exist, you must create it first.");const[a,i,s]=Sn(t),o=n?.parentCommitHash==="latest"||!n?.parentCommitHash?await this._getLatestCommitHash(`${a}/${i}`):n?.parentCommitHash,c={manifest:JSON.parse(JSON.stringify(r)),parent_commit:o},u=JSON.stringify(c),h=await(await this.caller.call(async()=>{const p=await this._fetch(`${this.apiUrl}/commits/${a}/${i}`,{method:"POST",headers:{...this.headers,"Content-Type":"application/json"},signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions,body:u});return await _e(p,"create commit"),p})).json();return this._getPromptUrl(`${a}/${i}${h.commit_hash?`:${h.commit_hash}`:""}`)}async updateExamplesMultipart(t,r=[]){return this._updateExamplesMultipart(t,r)}async _updateExamplesMultipart(t,r=[]){if(!await this._getDatasetExamplesMultiPartSupport())throw new Error("Your LangSmith deployment does not allow using the multipart examples endpoint, please upgrade your deployment to the latest version.");const n=new FormData;for(const s of r){const o=s.id,c={...s.metadata&&{metadata:s.metadata},...s.split&&{split:s.split}},u=Xt(c,`Serializing body for example with id: ${o}`),d=new Blob([u],{type:"application/json"});if(n.append(o,d),s.inputs){const h=Xt(s.inputs,`Serializing inputs for example with id: ${o}`),p=new Blob([h],{type:"application/json"});n.append(`${o}.inputs`,p)}if(s.outputs){const h=Xt(s.outputs,`Serializing outputs whle updating example with id: ${o}`),p=new Blob([h],{type:"application/json"});n.append(`${o}.outputs`,p)}if(s.attachments)for(const[h,p]of Object.entries(s.attachments)){let y,g;Array.isArray(p)?[y,g]=p:(y=p.mimeType,g=p.data);const w=new Blob([g],{type:`${y}; length=${g.byteLength}`});n.append(`${o}.attachment.${h}`,w)}if(s.attachments_operations){const h=Xt(s.attachments_operations,`Serializing attachments while updating example with id: ${o}`),p=new Blob([h],{type:"application/json"});n.append(`${o}.attachments_operations`,p)}}const a=t??r[0]?.dataset_id;return(await this.caller.call(async()=>{const s=await this._fetch(`${this.apiUrl}${this._getPlatformEndpointPath(`datasets/${a}/examples`)}`,{method:"PATCH",headers:this.headers,signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions,body:n});return await _e(s,"update examples"),s})).json()}async uploadExamplesMultipart(t,r=[]){return this._uploadExamplesMultipart(t,r)}async _uploadExamplesMultipart(t,r=[]){if(!await this._getDatasetExamplesMultiPartSupport())throw new Error("Your LangSmith deployment does not allow using the multipart examples endpoint, please upgrade your deployment to the latest version.");const n=new FormData;for(const i of r){const s=(i.id??za()).toString(),o={created_at:i.created_at,...i.metadata&&{metadata:i.metadata},...i.split&&{split:i.split},...i.source_run_id&&{source_run_id:i.source_run_id},...i.use_source_run_io&&{use_source_run_io:i.use_source_run_io},...i.use_source_run_attachments&&{use_source_run_attachments:i.use_source_run_attachments}},c=Xt(o,`Serializing body for uploaded example with id: ${s}`),u=new Blob([c],{type:"application/json"});if(n.append(s,u),i.inputs){const d=Xt(i.inputs,`Serializing inputs for uploaded example with id: ${s}`),h=new Blob([d],{type:"application/json"});n.append(`${s}.inputs`,h)}if(i.outputs){const d=Xt(i.outputs,`Serializing outputs for uploaded example with id: ${s}`),h=new Blob([d],{type:"application/json"});n.append(`${s}.outputs`,h)}if(i.attachments)for(const[d,h]of Object.entries(i.attachments)){let p,y;Array.isArray(h)?[p,y]=h:(p=h.mimeType,y=h.data);const g=new Blob([y],{type:`${p}; length=${y.byteLength}`});n.append(`${s}.attachment.${d}`,g)}}return(await this.caller.call(async()=>{const i=await this._fetch(`${this.apiUrl}${this._getPlatformEndpointPath(`datasets/${t}/examples`)}`,{method:"POST",headers:this.headers,signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions,body:n});return await _e(i,"upload examples"),i})).json()}async updatePrompt(t,r){if(!await this.promptExists(t))throw new Error("Prompt does not exist, you must create it first.");const[n,a]=Sn(t);if(!await this._currentTenantIsOwner(n))throw await this._ownerConflictError("update a prompt",n);const i={};if(r?.description!==void 0&&(i.description=r.description),r?.readme!==void 0&&(i.readme=r.readme),r?.tags!==void 0&&(i.tags=r.tags),r?.isPublic!==void 0&&(i.is_public=r.isPublic),r?.isArchived!==void 0&&(i.is_archived=r.isArchived),Object.keys(i).length===0)throw new Error("No valid update options provided");const s=JSON.stringify(i);return(await this.caller.call(async()=>{const c=await this._fetch(`${this.apiUrl}/repos/${n}/${a}`,{method:"PATCH",headers:{...this.headers,"Content-Type":"application/json"},signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions,body:s});return await _e(c,"update prompt"),c})).json()}async deletePrompt(t){if(!await this.promptExists(t))throw new Error("Prompt does not exist, you must create it first.");const[r,n,a]=Sn(t);if(!await this._currentTenantIsOwner(r))throw await this._ownerConflictError("delete a prompt",r);return(await this.caller.call(async()=>{const s=await this._fetch(`${this.apiUrl}/repos/${r}/${n}`,{method:"DELETE",headers:this.headers,signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});return await _e(s,"delete prompt"),s})).json()}async pullPromptCommit(t,r){const[n,a,i]=Sn(t),o=await(await this.caller.call(async()=>{const c=await this._fetch(`${this.apiUrl}/commits/${n}/${a}/${i}${r?.includeModel?"?include_model=true":""}`,{method:"GET",headers:this.headers,signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});return await _e(c,"pull prompt commit"),c})).json();return{owner:n,repo:a,commit_hash:o.commit_hash,manifest:o.manifest,examples:o.examples}}async _pullPrompt(t,r){const n=await this.pullPromptCommit(t,{includeModel:r?.includeModel});return JSON.stringify(n.manifest)}async pushPrompt(t,r){return await this.promptExists(t)?r&&Object.keys(r).some(a=>a!=="object")&&await this.updatePrompt(t,{description:r?.description,readme:r?.readme,tags:r?.tags,isPublic:r?.isPublic}):await this.createPrompt(t,{description:r?.description,readme:r?.readme,tags:r?.tags,isPublic:r?.isPublic}),r?.object?await this.createCommit(t,r?.object,{parentCommitHash:r?.parentCommitHash}):await this._getPromptUrl(t)}async clonePublicDataset(t,r={}){const{sourceApiUrl:n=this.apiUrl,datasetName:a}=r,[i,s]=this.parseTokenOrUrl(t,n),o=new hs({apiUrl:i,apiKey:"placeholder"}),c=await o.readSharedDataset(s),u=a||c.name;try{if(await this.hasDataset({datasetId:u})){console.log(`Dataset ${u} already exists in your tenant. Skipping.`);return}}catch{}const d=await o.listSharedExamples(s),h=await this.createDataset(u,{description:c.description,dataType:c.data_type||"kv",inputsSchema:c.inputs_schema_definition??void 0,outputsSchema:c.outputs_schema_definition??void 0});try{await this.createExamples({inputs:d.map(p=>p.inputs),outputs:d.flatMap(p=>p.outputs?[p.outputs]:[]),datasetId:h.id})}catch(p){throw console.error(`An error occurred while creating dataset ${u}. You should delete it manually.`),p}}parseTokenOrUrl(t,r,n=2,a="dataset"){try{return De(t),[r,t]}catch{}try{const s=new URL(t).pathname.split("/").filter(o=>o!=="");if(s.length>=n){const o=s[s.length-n];return[r,o]}else throw new Error(`Invalid public ${a} URL: ${t}`)}catch{throw new Error(`Invalid public ${a} URL or token: ${t}`)}}async awaitPendingTraceBatches(){if(this.manualFlushMode)return console.warn("[WARNING]: When tracing in manual flush mode, you must call `await client.flush()` manually to submit trace batches."),Promise.resolve();await Promise.all([...this.autoBatchQueue.items.map(({itemPromise:t})=>t),this.batchIngestCaller.queue.onIdle()]),this.langSmithToOTELTranslator!==void 0&&await d$()?.DEFAULT_LANGSMITH_SPAN_PROCESSOR?.forceFlush()}}function fg(e){return"dataset_id"in e||"dataset_name"in e}const gA=e=>!!["TRACING_V2","TRACING"].find(r=>Kt(r)==="true"),Hl=Symbol.for("lc:context_variables");function yA(e){return e.replace(/[-:.]/g,"")}function H_(e,t,r=1){const n=r.toFixed(0).slice(0,3).padStart(3,"0"),a=`${new Date(e).toISOString().slice(0,-1)}${n}Z`;return{dottedOrder:yA(a)+t,microsecondPrecisionDatestring:a}}class ac{constructor(t,r,n,a){Object.defineProperty(this,"metadata",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"tags",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"project_name",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"replicas",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.metadata=t,this.tags=r,this.project_name=n,this.replicas=a}static fromHeader(t){const r=t.split(",");let n={},a=[],i,s;for(const o of r){const[c,u]=o.split("="),d=decodeURIComponent(u);c==="langsmith-metadata"?n=JSON.parse(d):c==="langsmith-tags"?a=d.split(","):c==="langsmith-project"?i=d:c==="langsmith-replicas"&&(s=JSON.parse(d))}return new ac(n,a,i,s)}toHeader(){const t=[];return this.metadata&&Object.keys(this.metadata).length>0&&t.push(`langsmith-metadata=${encodeURIComponent(JSON.stringify(this.metadata))}`),this.tags&&this.tags.length>0&&t.push(`langsmith-tags=${encodeURIComponent(this.tags.join(","))}`),this.project_name&&t.push(`langsmith-project=${encodeURIComponent(this.project_name)}`),t.join(",")}}class Ht{constructor(t){if(Object.defineProperty(this,"id",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"name",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"run_type",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"project_name",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"parent_run",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"parent_run_id",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"child_runs",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"start_time",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"end_time",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"extra",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"tags",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"error",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"serialized",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"inputs",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"outputs",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"reference_example_id",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"client",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"events",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"trace_id",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"dotted_order",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"tracingEnabled",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"execution_order",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"child_execution_order",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"attachments",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"replicas",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"_serialized_start_time",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),vA(t)){Object.assign(this,{...t});return}const r=Ht.getDefaultConfig(),{metadata:n,...a}=t,i=a.client??Ht.getSharedClient(),s={...n,...a?.extra?.metadata};if(a.extra={...a.extra,metadata:s},"id"in a&&a.id==null&&delete a.id,Object.assign(this,{...r,...a,client:i}),this.trace_id||(this.parent_run?this.trace_id=this.parent_run.trace_id??this.id:this.trace_id=this.id),this.replicas=xA(this.replicas),this.execution_order??=1,this.child_execution_order??=1,!this.dotted_order){const{dottedOrder:o,microsecondPrecisionDatestring:c}=H_(this.start_time,this.id,this.execution_order);this.parent_run?this.dotted_order=this.parent_run.dotted_order+"."+o:this.dotted_order=o,this._serialized_start_time=c}}set metadata(t){this.extra={...this.extra,metadata:{...this.extra?.metadata,...t}}}get metadata(){return this.extra?.metadata}static getDefaultConfig(){return{id:za(),run_type:"chain",project_name:$_(),child_runs:[],api_url:Hr("LANGCHAIN_ENDPOINT")??"http://localhost:1984",api_key:Hr("LANGCHAIN_API_KEY"),caller_options:{},start_time:Date.now(),serialized:{},inputs:{},extra:{}}}static getSharedClient(){return Ht.sharedClient||(Ht.sharedClient=new hs),Ht.sharedClient}createChild(t){const r=this.child_execution_order+1,n=new Ht({...t,parent_run:this,project_name:this.project_name,replicas:this.replicas,client:this.client,tracingEnabled:this.tracingEnabled,execution_order:r,child_execution_order:r});Hl in this&&(n[Hl]=this[Hl]);const a=Symbol.for("lc:child_config"),i=t.extra?.[a]??this.extra[a];if(wA(i)){const c={...i},u=_A(c.callbacks)?c.callbacks.copy?.():void 0;u&&(Object.assign(u,{_parentRunId:n.id}),u.handlers?.find(K_)?.updateFromRunTree?.(n),c.callbacks=u),n.extra[a]=c}const s=new Set;let o=this;for(;o!=null&&!s.has(o.id);)s.add(o.id),o.child_execution_order=Math.max(o.child_execution_order,r),o=o.parent_run;return this.child_runs.push(n),n}async end(t,r,n=Date.now(),a){this.outputs=this.outputs??t,this.error=this.error??r,this.end_time=this.end_time??n,a&&Object.keys(a).length>0&&(this.extra=this.extra?{...this.extra,metadata:{...this.extra.metadata,...a}}:{metadata:a})}_convertToCreate(t,r,n=!0){const a=t.extra??{};if(a?.runtime?.library===void 0&&(a.runtime||(a.runtime={}),r))for(const[o,c]of Object.entries(r))a.runtime[o]||(a.runtime[o]=c);let i,s;return n?(s=t.parent_run?.id??t.parent_run_id,i=[]):(i=t.child_runs.map(o=>this._convertToCreate(o,r,n)),s=void 0),{id:t.id,name:t.name,start_time:t._serialized_start_time??t.start_time,end_time:t.end_time,run_type:t.run_type,reference_example_id:t.reference_example_id,extra:a,serialized:t.serialized,error:t.error,inputs:t.inputs,outputs:t.outputs,session_name:t.project_name,child_runs:i,parent_run_id:s,trace_id:t.trace_id,dotted_order:t.dotted_order,tags:t.tags,attachments:t.attachments,events:t.events}}_remapForProject(t,r,n=!0){const a=this._convertToCreate(this,r,n);if(t===this.project_name)return a;const i=h=>Jp(`${h}:${t}`,Jp.DNS),s=i(a.id),o=a.trace_id?i(a.trace_id):void 0,c=a.parent_run_id?i(a.parent_run_id):void 0;let u;if(a.dotted_order){const h=bA(a.dotted_order),p=[];for(let g=0;g<h.length-1;g++){const[w,b]=h[g],x=i(b);p.push(w.toISOString().replace(/[-:]/g,"").replace(".","")+x)}const[y]=h[h.length-1];p.push(y.toISOString().replace(/[-:]/g,"").replace(".","")+s),u=p.join(".")}else u=void 0;return{...a,id:s,trace_id:o,parent_run_id:c,dotted_order:u,session_name:t}}async postRun(t=!0){try{const r=N_();if(this.replicas&&this.replicas.length>0)for(const{projectName:n,apiKey:a,apiUrl:i,workspaceId:s}of this.replicas){const o=this._remapForProject(n??this.project_name,r,!0);await this.client.createRun(o,{apiKey:a,apiUrl:i,workspaceId:s})}else{const n=this._convertToCreate(this,r,t);await this.client.createRun(n)}if(!t){Td("Posting with excludeChildRuns=false is deprecated and will be removed in a future version.");for(const n of this.child_runs)await n.postRun(!1)}}catch(r){console.error(`Error in postRun for run ${this.id}:`,r)}}async patchRun(t){if(this.replicas&&this.replicas.length>0)for(const{projectName:r,apiKey:n,apiUrl:a,workspaceId:i,updates:s}of this.replicas){const o=this._remapForProject(r??this.project_name),c={id:o.id,outputs:o.outputs,error:o.error,parent_run_id:o.parent_run_id,session_name:o.session_name,reference_example_id:o.reference_example_id,end_time:o.end_time,dotted_order:o.dotted_order,trace_id:o.trace_id,events:o.events,tags:o.tags,extra:o.extra,attachments:this.attachments,...s};t?.excludeInputs||(c.inputs=o.inputs),await this.client.updateRun(o.id,c,{apiKey:n,apiUrl:a,workspaceId:i})}else try{const r={end_time:this.end_time,error:this.error,outputs:this.outputs,parent_run_id:this.parent_run?.id??this.parent_run_id,reference_example_id:this.reference_example_id,extra:this.extra,events:this.events,dotted_order:this.dotted_order,trace_id:this.trace_id,tags:this.tags,attachments:this.attachments,session_name:this.project_name};t?.excludeInputs||(r.inputs=this.inputs),await this.client.updateRun(this.id,r)}catch(r){console.error(`Error in patchRun for run ${this.id}`,r)}}toJSON(){return this._convertToCreate(this,void 0,!1)}addEvent(t){this.events||(this.events=[]),typeof t=="string"?this.events.push({name:"event",time:new Date().toISOString(),message:t}):this.events.push({...t,time:t.time??new Date().toISOString()})}static fromRunnableConfig(t,r){const n=t?.callbacks;let a,i,s,o=gA();if(n){const u=n?.getParentRunId?.()??"",d=n?.handlers?.find(h=>h?.name=="langchain_tracer");a=d?.getRun?.(u),i=d?.projectName,s=d?.client,o=o||!!d}return a?new Ht({name:a.name,id:a.id,trace_id:a.trace_id,dotted_order:a.dotted_order,client:s,tracingEnabled:o,project_name:i,tags:[...new Set((a?.tags??[]).concat(t?.tags??[]))],extra:{metadata:{...a?.extra?.metadata,...t?.metadata}}}).createChild(r):new Ht({...r,client:s,tracingEnabled:o,project_name:i})}static fromDottedOrder(t){return this.fromHeaders({"langsmith-trace":t})}static fromHeaders(t,r){const n="get"in t&&typeof t.get=="function"?{"langsmith-trace":t.get("langsmith-trace"),baggage:t.get("baggage")}:t,a=n["langsmith-trace"];if(!a||typeof a!="string")return;const i=a.trim(),s=i.split(".").map(u=>{const[d,h]=u.split("Z");return{strTime:d,time:Date.parse(d+"Z"),uuid:h}}),o=s[0].uuid,c={...r,name:r?.name??"parent",run_type:r?.run_type??"chain",start_time:r?.start_time??Date.now(),id:s.at(-1)?.uuid,trace_id:o,dotted_order:i};if(n.baggage&&typeof n.baggage=="string"){const u=ac.fromHeader(n.baggage);c.metadata=u.metadata,c.tags=u.tags,c.project_name=u.project_name,c.replicas=u.replicas}return new Ht(c)}toHeaders(t){const r={"langsmith-trace":this.dotted_order,baggage:new ac(this.extra?.metadata,this.tags,this.project_name,this.replicas).toHeader()};if(t)for(const[n,a]of Object.entries(r))t.set(n,a);return r}}Object.defineProperty(Ht,"sharedClient",{enumerable:!0,configurable:!0,writable:!0,value:null});function vA(e){return e!=null&&typeof e.createChild=="function"&&typeof e.postRun=="function"}function K_(e){return typeof e=="object"&&e!=null&&typeof e.name=="string"&&e.name==="langchain_tracer"}function hg(e){return Array.isArray(e)&&e.some(t=>K_(t))}function _A(e){return typeof e=="object"&&e!=null&&Array.isArray(e.handlers)}function wA(e){return e!=null&&typeof e.callbacks=="object"&&(hg(e.callbacks?.handlers)||hg(e.callbacks))}function bA(e){return e.split(".").map(r=>{const n=r.slice(0,-36),a=r.slice(-36),i=parseInt(n.slice(0,4)),s=parseInt(n.slice(4,6))-1,o=parseInt(n.slice(6,8)),c=parseInt(n.slice(9,11)),u=parseInt(n.slice(11,13)),d=parseInt(n.slice(13,15)),h=parseInt(n.slice(15,21));return[new Date(i,s,o,c,u,d,h/1e3),a]})}function EA(){const e=Hr("LANGSMITH_RUNS_ENDPOINTS");if(!e)return[];try{const t=JSON.parse(e);if(Array.isArray(t)){const r=[];for(const n of t){if(typeof n!="object"||n===null){console.warn(`Invalid item type in LANGSMITH_RUNS_ENDPOINTS: expected object, got ${typeof n}`);continue}if(typeof n.api_url!="string"){console.warn(`Invalid api_url type in LANGSMITH_RUNS_ENDPOINTS: expected string, got ${typeof n.api_url}`);continue}if(typeof n.api_key!="string"){console.warn(`Invalid api_key type in LANGSMITH_RUNS_ENDPOINTS: expected string, got ${typeof n.api_key}`);continue}r.push({apiUrl:n.api_url.replace(/\/$/,""),apiKey:n.api_key})}return r}else if(typeof t=="object"&&t!==null){SA(t);const r=[];for(const[n,a]of Object.entries(t)){const i=n.replace(/\/$/,"");if(typeof a=="string")r.push({apiUrl:i,apiKey:a});else{console.warn(`Invalid value type in LANGSMITH_RUNS_ENDPOINTS for URL ${n}: expected string, got ${typeof a}`);continue}}return r}else return console.warn(`Invalid LANGSMITH_RUNS_ENDPOINTS  must be valid JSON array of objects with api_url and api_key properties, or object mapping url->apiKey, got ${typeof t}`),[]}catch(t){if(rA(t))throw t;return console.warn("Invalid LANGSMITH_RUNS_ENDPOINTS  must be valid JSON array of objects with api_url and api_key properties, or object mapping url->apiKey"),[]}}function xA(e){return e?e.map(t=>Array.isArray(t)?{projectName:t[0],updates:t[1]}:t):EA()}function SA(e){if(Object.keys(e).length>0&&Kt("ENDPOINT"))throw new tA}var kA={};Et(kA,{BaseTracer:()=>_i,isBaseTracer:()=>qa});const IA=e=>{if(e)return e.events=e.events??[],e.child_runs=e.child_runs??[],e};function $d(e,t){if(e)return new Ht({...e,start_time:e._serialized_start_time??e.start_time,parent_run:$d(t),child_runs:e.child_runs.map(r=>$d(r)).filter(r=>r!==void 0),extra:{...e.extra,runtime:I_()},tracingEnabled:!1})}function Kl(e,t){return e&&!Array.isArray(e)&&typeof e=="object"?e:{[t]:e}}function qa(e){return typeof e._addRunToRunMap=="function"}var _i=class extends Ds{runMap=new Map;runTreeMap=new Map;usesRunTreeMap=!1;constructor(e){super(...arguments)}copy(){return this}getRunById(e){if(e!==void 0)return this.usesRunTreeMap?IA(this.runTreeMap.get(e)):this.runMap.get(e)}stringifyError(e){return e instanceof Error?e.message+(e?.stack?`

${e.stack}`:""):typeof e=="string"?e:`${e}`}_addChildRun(e,t){e.child_runs.push(t)}_addRunToRunMap(e){const{dottedOrder:t,microsecondPrecisionDatestring:r}=H_(new Date(e.start_time).getTime(),e.id,e.execution_order),n={...e},a=this.getRunById(n.parent_run_id);if(n.parent_run_id!==void 0?a&&(this._addChildRun(a,n),a.child_execution_order=Math.max(a.child_execution_order,n.child_execution_order),n.trace_id=a.trace_id,a.dotted_order!==void 0&&(n.dotted_order=[a.dotted_order,t].join("."),n._serialized_start_time=r)):(n.trace_id=n.id,n.dotted_order=t,n._serialized_start_time=r),this.usesRunTreeMap){const i=$d(n,a);i!==void 0&&this.runTreeMap.set(n.id,i)}else this.runMap.set(n.id,n);return n}async _endTrace(e){const t=e.parent_run_id!==void 0&&this.getRunById(e.parent_run_id);t?t.child_execution_order=Math.max(t.child_execution_order,e.child_execution_order):await this.persistRun(e),await this.onRunUpdate?.(e),this.usesRunTreeMap?this.runTreeMap.delete(e.id):this.runMap.delete(e.id)}_getExecutionOrder(e){const t=e!==void 0&&this.getRunById(e);return t?t.child_execution_order+1:1}_createRunForLLMStart(e,t,r,n,a,i,s,o){const c=this._getExecutionOrder(n),u=Date.now(),d=s?{...a,metadata:s}:a,h={id:r,name:o??e.id[e.id.length-1],parent_run_id:n,start_time:u,serialized:e,events:[{name:"start",time:new Date(u).toISOString()}],inputs:{prompts:t},execution_order:c,child_runs:[],child_execution_order:c,run_type:"llm",extra:d??{},tags:i||[]};return this._addRunToRunMap(h)}async handleLLMStart(e,t,r,n,a,i,s,o){const c=this.getRunById(r)??this._createRunForLLMStart(e,t,r,n,a,i,s,o);return await this.onRunCreate?.(c),await this.onLLMStart?.(c),c}_createRunForChatModelStart(e,t,r,n,a,i,s,o){const c=this._getExecutionOrder(n),u=Date.now(),d=s?{...a,metadata:s}:a,h={id:r,name:o??e.id[e.id.length-1],parent_run_id:n,start_time:u,serialized:e,events:[{name:"start",time:new Date(u).toISOString()}],inputs:{messages:t},execution_order:c,child_runs:[],child_execution_order:c,run_type:"llm",extra:d??{},tags:i||[]};return this._addRunToRunMap(h)}async handleChatModelStart(e,t,r,n,a,i,s,o){const c=this.getRunById(r)??this._createRunForChatModelStart(e,t,r,n,a,i,s,o);return await this.onRunCreate?.(c),await this.onLLMStart?.(c),c}async handleLLMEnd(e,t,r,n,a){const i=this.getRunById(t);if(!i||i?.run_type!=="llm")throw new Error("No LLM run to end.");return i.end_time=Date.now(),i.outputs=e,i.events.push({name:"end",time:new Date(i.end_time).toISOString()}),i.extra={...i.extra,...a},await this.onLLMEnd?.(i),await this._endTrace(i),i}async handleLLMError(e,t,r,n,a){const i=this.getRunById(t);if(!i||i?.run_type!=="llm")throw new Error("No LLM run to end.");return i.end_time=Date.now(),i.error=this.stringifyError(e),i.events.push({name:"error",time:new Date(i.end_time).toISOString()}),i.extra={...i.extra,...a},await this.onLLMError?.(i),await this._endTrace(i),i}_createRunForChainStart(e,t,r,n,a,i,s,o){const c=this._getExecutionOrder(n),u=Date.now(),d={id:r,name:o??e.id[e.id.length-1],parent_run_id:n,start_time:u,serialized:e,events:[{name:"start",time:new Date(u).toISOString()}],inputs:t,execution_order:c,child_execution_order:c,run_type:s??"chain",child_runs:[],extra:i?{metadata:i}:{},tags:a||[]};return this._addRunToRunMap(d)}async handleChainStart(e,t,r,n,a,i,s,o){const c=this.getRunById(r)??this._createRunForChainStart(e,t,r,n,a,i,s,o);return await this.onRunCreate?.(c),await this.onChainStart?.(c),c}async handleChainEnd(e,t,r,n,a){const i=this.getRunById(t);if(!i)throw new Error("No chain run to end.");return i.end_time=Date.now(),i.outputs=Kl(e,"output"),i.events.push({name:"end",time:new Date(i.end_time).toISOString()}),a?.inputs!==void 0&&(i.inputs=Kl(a.inputs,"input")),await this.onChainEnd?.(i),await this._endTrace(i),i}async handleChainError(e,t,r,n,a){const i=this.getRunById(t);if(!i)throw new Error("No chain run to end.");return i.end_time=Date.now(),i.error=this.stringifyError(e),i.events.push({name:"error",time:new Date(i.end_time).toISOString()}),a?.inputs!==void 0&&(i.inputs=Kl(a.inputs,"input")),await this.onChainError?.(i),await this._endTrace(i),i}_createRunForToolStart(e,t,r,n,a,i,s){const o=this._getExecutionOrder(n),c=Date.now(),u={id:r,name:s??e.id[e.id.length-1],parent_run_id:n,start_time:c,serialized:e,events:[{name:"start",time:new Date(c).toISOString()}],inputs:{input:t},execution_order:o,child_execution_order:o,run_type:"tool",child_runs:[],extra:i?{metadata:i}:{},tags:a||[]};return this._addRunToRunMap(u)}async handleToolStart(e,t,r,n,a,i,s){const o=this.getRunById(r)??this._createRunForToolStart(e,t,r,n,a,i,s);return await this.onRunCreate?.(o),await this.onToolStart?.(o),o}async handleToolEnd(e,t){const r=this.getRunById(t);if(!r||r?.run_type!=="tool")throw new Error("No tool run to end");return r.end_time=Date.now(),r.outputs={output:e},r.events.push({name:"end",time:new Date(r.end_time).toISOString()}),await this.onToolEnd?.(r),await this._endTrace(r),r}async handleToolError(e,t){const r=this.getRunById(t);if(!r||r?.run_type!=="tool")throw new Error("No tool run to end");return r.end_time=Date.now(),r.error=this.stringifyError(e),r.events.push({name:"error",time:new Date(r.end_time).toISOString()}),await this.onToolError?.(r),await this._endTrace(r),r}async handleAgentAction(e,t){const r=this.getRunById(t);if(!r||r?.run_type!=="chain")return;const n=r;n.actions=n.actions||[],n.actions.push(e),n.events.push({name:"agent_action",time:new Date().toISOString(),kwargs:{action:e}}),await this.onAgentAction?.(r)}async handleAgentEnd(e,t){const r=this.getRunById(t);!r||r?.run_type!=="chain"||(r.events.push({name:"agent_end",time:new Date().toISOString(),kwargs:{action:e}}),await this.onAgentEnd?.(r))}_createRunForRetrieverStart(e,t,r,n,a,i,s){const o=this._getExecutionOrder(n),c=Date.now(),u={id:r,name:s??e.id[e.id.length-1],parent_run_id:n,start_time:c,serialized:e,events:[{name:"start",time:new Date(c).toISOString()}],inputs:{query:t},execution_order:o,child_execution_order:o,run_type:"retriever",child_runs:[],extra:i?{metadata:i}:{},tags:a||[]};return this._addRunToRunMap(u)}async handleRetrieverStart(e,t,r,n,a,i,s){const o=this.getRunById(r)??this._createRunForRetrieverStart(e,t,r,n,a,i,s);return await this.onRunCreate?.(o),await this.onRetrieverStart?.(o),o}async handleRetrieverEnd(e,t){const r=this.getRunById(t);if(!r||r?.run_type!=="retriever")throw new Error("No retriever run to end");return r.end_time=Date.now(),r.outputs={documents:e},r.events.push({name:"end",time:new Date(r.end_time).toISOString()}),await this.onRetrieverEnd?.(r),await this._endTrace(r),r}async handleRetrieverError(e,t){const r=this.getRunById(t);if(!r||r?.run_type!=="retriever")throw new Error("No retriever run to end");return r.end_time=Date.now(),r.error=this.stringifyError(e),r.events.push({name:"error",time:new Date(r.end_time).toISOString()}),await this.onRetrieverError?.(r),await this._endTrace(r),r}async handleText(e,t){const r=this.getRunById(t);!r||r?.run_type!=="chain"||(r.events.push({name:"text",time:new Date().toISOString(),kwargs:{text:e}}),await this.onText?.(r))}async handleLLMNewToken(e,t,r,n,a,i){const s=this.getRunById(r);if(!s||s?.run_type!=="llm")throw new Error('Invalid "runId" provided to "handleLLMNewToken" callback.');return s.events.push({name:"new_token",time:new Date().toISOString(),kwargs:{token:e,idx:t,chunk:i?.chunk}}),await this.onLLMNewToken?.(s,e,{chunk:i?.chunk}),s}},jo={exports:{}};jo.exports;var pg;function OA(){return pg||(pg=1,(function(e){const r=(i=0)=>s=>`\x1B[${38+i};5;${s}m`,n=(i=0)=>(s,o,c)=>`\x1B[${38+i};2;${s};${o};${c}m`;function a(){const i=new Map,s={modifier:{reset:[0,0],bold:[1,22],dim:[2,22],italic:[3,23],underline:[4,24],overline:[53,55],inverse:[7,27],hidden:[8,28],strikethrough:[9,29]},color:{black:[30,39],red:[31,39],green:[32,39],yellow:[33,39],blue:[34,39],magenta:[35,39],cyan:[36,39],white:[37,39],blackBright:[90,39],redBright:[91,39],greenBright:[92,39],yellowBright:[93,39],blueBright:[94,39],magentaBright:[95,39],cyanBright:[96,39],whiteBright:[97,39]},bgColor:{bgBlack:[40,49],bgRed:[41,49],bgGreen:[42,49],bgYellow:[43,49],bgBlue:[44,49],bgMagenta:[45,49],bgCyan:[46,49],bgWhite:[47,49],bgBlackBright:[100,49],bgRedBright:[101,49],bgGreenBright:[102,49],bgYellowBright:[103,49],bgBlueBright:[104,49],bgMagentaBright:[105,49],bgCyanBright:[106,49],bgWhiteBright:[107,49]}};s.color.gray=s.color.blackBright,s.bgColor.bgGray=s.bgColor.bgBlackBright,s.color.grey=s.color.blackBright,s.bgColor.bgGrey=s.bgColor.bgBlackBright;for(const[o,c]of Object.entries(s)){for(const[u,d]of Object.entries(c))s[u]={open:`\x1B[${d[0]}m`,close:`\x1B[${d[1]}m`},c[u]=s[u],i.set(d[0],d[1]);Object.defineProperty(s,o,{value:c,enumerable:!1})}return Object.defineProperty(s,"codes",{value:i,enumerable:!1}),s.color.close="\x1B[39m",s.bgColor.close="\x1B[49m",s.color.ansi256=r(),s.color.ansi16m=n(),s.bgColor.ansi256=r(10),s.bgColor.ansi16m=n(10),Object.defineProperties(s,{rgbToAnsi256:{value:(o,c,u)=>o===c&&c===u?o<8?16:o>248?231:Math.round((o-8)/247*24)+232:16+36*Math.round(o/255*5)+6*Math.round(c/255*5)+Math.round(u/255*5),enumerable:!1},hexToRgb:{value:o=>{const c=/(?<colorString>[a-f\d]{6}|[a-f\d]{3})/i.exec(o.toString(16));if(!c)return[0,0,0];let{colorString:u}=c.groups;u.length===3&&(u=u.split("").map(h=>h+h).join(""));const d=Number.parseInt(u,16);return[d>>16&255,d>>8&255,d&255]},enumerable:!1},hexToAnsi256:{value:o=>s.rgbToAnsi256(...s.hexToRgb(o)),enumerable:!1}}),s}Object.defineProperty(e,"exports",{enumerable:!0,get:a})})(jo)),jo.exports}var TA=OA();const G_=fi(TA);var RA={};Et(RA,{ConsoleCallbackHandler:()=>Ad});function jt(e,t){return`${e.open}${t}${e.close}`}function mr(e,t){try{return JSON.stringify(e,null,2)}catch{return t}}function mg(e){return typeof e=="string"?e.trim():e==null?e:mr(e,e.toString())}function kn(e){if(!e.end_time)return"";const t=e.end_time-e.start_time;return t<1e3?`${t}ms`:`${(t/1e3).toFixed(2)}s`}const{color:qt}=G_;var Ad=class extends _i{name="console_callback_handler";persistRun(e){return Promise.resolve()}getParents(e){const t=[];let r=e;for(;r.parent_run_id;){const n=this.runMap.get(r.parent_run_id);if(n)t.push(n),r=n;else break}return t}getBreadcrumbs(e){const r=[...this.getParents(e).reverse(),e].map((n,a,i)=>{const s=`${n.execution_order}:${n.run_type}:${n.name}`;return a===i.length-1?jt(G_.bold,s):s}).join(" > ");return jt(qt.grey,r)}onChainStart(e){const t=this.getBreadcrumbs(e);console.log(`${jt(qt.green,"[chain/start]")} [${t}] Entering Chain run with input: ${mr(e.inputs,"[inputs]")}`)}onChainEnd(e){const t=this.getBreadcrumbs(e);console.log(`${jt(qt.cyan,"[chain/end]")} [${t}] [${kn(e)}] Exiting Chain run with output: ${mr(e.outputs,"[outputs]")}`)}onChainError(e){const t=this.getBreadcrumbs(e);console.log(`${jt(qt.red,"[chain/error]")} [${t}] [${kn(e)}] Chain run errored with error: ${mr(e.error,"[error]")}`)}onLLMStart(e){const t=this.getBreadcrumbs(e),r="prompts"in e.inputs?{prompts:e.inputs.prompts.map(n=>n.trim())}:e.inputs;console.log(`${jt(qt.green,"[llm/start]")} [${t}] Entering LLM run with input: ${mr(r,"[inputs]")}`)}onLLMEnd(e){const t=this.getBreadcrumbs(e);console.log(`${jt(qt.cyan,"[llm/end]")} [${t}] [${kn(e)}] Exiting LLM run with output: ${mr(e.outputs,"[response]")}`)}onLLMError(e){const t=this.getBreadcrumbs(e);console.log(`${jt(qt.red,"[llm/error]")} [${t}] [${kn(e)}] LLM run errored with error: ${mr(e.error,"[error]")}`)}onToolStart(e){const t=this.getBreadcrumbs(e);console.log(`${jt(qt.green,"[tool/start]")} [${t}] Entering Tool run with input: "${mg(e.inputs.input)}"`)}onToolEnd(e){const t=this.getBreadcrumbs(e);console.log(`${jt(qt.cyan,"[tool/end]")} [${t}] [${kn(e)}] Exiting Tool run with output: "${mg(e.outputs?.output)}"`)}onToolError(e){const t=this.getBreadcrumbs(e);console.log(`${jt(qt.red,"[tool/error]")} [${t}] [${kn(e)}] Tool run errored with error: ${mr(e.error,"[error]")}`)}onRetrieverStart(e){const t=this.getBreadcrumbs(e);console.log(`${jt(qt.green,"[retriever/start]")} [${t}] Entering Retriever run with input: ${mr(e.inputs,"[inputs]")}`)}onRetrieverEnd(e){const t=this.getBreadcrumbs(e);console.log(`${jt(qt.cyan,"[retriever/end]")} [${t}] [${kn(e)}] Exiting Retriever run with output: ${mr(e.outputs,"[outputs]")}`)}onRetrieverError(e){const t=this.getBreadcrumbs(e);console.log(`${jt(qt.red,"[retriever/error]")} [${t}] [${kn(e)}] Retriever run errored with error: ${mr(e.error,"[error]")}`)}onAgentAction(e){const t=e,r=this.getBreadcrumbs(e);console.log(`${jt(qt.blue,"[agent/action]")} [${r}] Agent selected action: ${mr(t.actions[t.actions.length-1],"[action]")}`)}};let Gl;const W_=()=>{if(Gl===void 0){const e=da("LANGCHAIN_CALLBACKS_BACKGROUND")==="false"?{blockOnRootRunFinalization:!0}:{};Gl=new hs(e)}return Gl};let $A=class{getStore(){}run(t,r){return r()}};const Wl=Symbol.for("ls:tracing_async_local_storage"),AA=new $A;let CA=class{getInstance(){return globalThis[Wl]??AA}initializeGlobalInstance(t){globalThis[Wl]===void 0&&(globalThis[Wl]=t)}};const PA=new CA;function NA(e=!1){const t=PA.getInstance().getStore();if(!e&&t===void 0)throw new Error(`Could not get the current run tree.

Please make sure you are calling this method within a traceable function and that tracing is enabled.`);return t}function Bf(e){return typeof e=="function"&&"langsmith:traceable"in e}var DA={};Et(DA,{LangChainTracer:()=>Fo});var Fo=class V_ extends _i{name="langchain_tracer";projectName;exampleId;client;replicas;usesRunTreeMap=!0;constructor(t={}){super(t);const{exampleId:r,projectName:n,client:a,replicas:i}=t;this.projectName=n??$_(),this.replicas=i,this.exampleId=r,this.client=a??W_();const s=V_.getTraceableRunTree();s&&this.updateFromRunTree(s)}async persistRun(t){}async onRunCreate(t){await this.getRunTreeWithTracingConfig(t.id)?.postRun()}async onRunUpdate(t){await this.getRunTreeWithTracingConfig(t.id)?.patchRun()}getRun(t){return this.runTreeMap.get(t)}updateFromRunTree(t){this.runTreeMap.set(t.id,t);let r=t;const n=new Set;for(;r.parent_run&&!(n.has(r.id)||(n.add(r.id),!r.parent_run));)r=r.parent_run;n.clear();const a=[r];for(;a.length>0;){const i=a.shift();!i||n.has(i.id)||(n.add(i.id),this.runTreeMap.set(i.id,i),i.child_runs&&a.push(...i.child_runs))}this.client=t.client??this.client,this.replicas=t.replicas??this.replicas,this.projectName=t.project_name??this.projectName,this.exampleId=t.reference_example_id??this.exampleId}getRunTreeWithTracingConfig(t){const r=this.runTreeMap.get(t);if(r)return new Ht({...r,client:this.client,project_name:this.projectName,replicas:this.replicas,reference_example_id:this.exampleId,tracingEnabled:!0})}static getTraceableRunTree(){try{return NA(!0)}catch{return}}};let fa;function LA(){const e="default"in rn?rn.default:rn;return new e({autoStart:!0,concurrency:1})}function MA(){return typeof fa>"u"&&(fa=LA()),fa}async function mt(e,t){if(t===!0){const r=ls();r!==void 0?await r.run(void 0,async()=>e()):await e()}else fa=MA(),fa.add(async()=>{const r=ls();r!==void 0?await r.run(void 0,async()=>e()):await e()})}async function jA(){const e=W_();await Promise.allSettled([typeof fa<"u"?fa.onIdle():Promise.resolve(),e.awaitPendingTraceBatches()])}var FA={};Et(FA,{awaitAllCallbacks:()=>jA,consumeCallback:()=>mt});const BA=e=>!!["LANGSMITH_TRACING_V2","LANGCHAIN_TRACING_V2","LANGSMITH_TRACING","LANGCHAIN_TRACING"].find(r=>da(r)==="true");function Z_(e){const t=ls();return t===void 0?void 0:t.getStore()?.[Qi]?.[e]}const UA=Symbol("lc:configure_hooks"),zA=()=>Z_(UA)||[];var qA={};Et(qA,{BaseCallbackManager:()=>J_,BaseRunManager:()=>Ms,CallbackManager:()=>Oa,CallbackManagerForChainRun:()=>Y_,CallbackManagerForLLMRun:()=>Cd,CallbackManagerForRetrieverRun:()=>Q_,CallbackManagerForToolRun:()=>X_,ensureHandler:()=>ps,parseCallbackConfigArg:()=>HA});function HA(e){return e?Array.isArray(e)||"name"in e?{callbacks:e}:e:{}}var J_=class{setHandler(e){return this.setHandlers([e])}},Ms=class{constructor(e,t,r,n,a,i,s,o){this.runId=e,this.handlers=t,this.inheritableHandlers=r,this.tags=n,this.inheritableTags=a,this.metadata=i,this.inheritableMetadata=s,this._parentRunId=o}get parentRunId(){return this._parentRunId}async handleText(e){await Promise.all(this.handlers.map(t=>mt(async()=>{try{await t.handleText?.(e,this.runId,this._parentRunId,this.tags)}catch(r){if((t.raiseError?console.error:console.warn)(`Error in handler ${t.constructor.name}, handleText: ${r}`),t.raiseError)throw r}},t.awaitHandlers)))}async handleCustomEvent(e,t,r,n,a){await Promise.all(this.handlers.map(i=>mt(async()=>{try{await i.handleCustomEvent?.(e,t,this.runId,this.tags,this.metadata)}catch(s){if((i.raiseError?console.error:console.warn)(`Error in handler ${i.constructor.name}, handleCustomEvent: ${s}`),i.raiseError)throw s}},i.awaitHandlers)))}},Q_=class extends Ms{getChild(e){const t=new Oa(this.runId);return t.setHandlers(this.inheritableHandlers),t.addTags(this.inheritableTags),t.addMetadata(this.inheritableMetadata),e&&t.addTags([e],!1),t}async handleRetrieverEnd(e){await Promise.all(this.handlers.map(t=>mt(async()=>{if(!t.ignoreRetriever)try{await t.handleRetrieverEnd?.(e,this.runId,this._parentRunId,this.tags)}catch(r){if((t.raiseError?console.error:console.warn)(`Error in handler ${t.constructor.name}, handleRetriever`),t.raiseError)throw r}},t.awaitHandlers)))}async handleRetrieverError(e){await Promise.all(this.handlers.map(t=>mt(async()=>{if(!t.ignoreRetriever)try{await t.handleRetrieverError?.(e,this.runId,this._parentRunId,this.tags)}catch(r){if((t.raiseError?console.error:console.warn)(`Error in handler ${t.constructor.name}, handleRetrieverError: ${r}`),t.raiseError)throw e}},t.awaitHandlers)))}},Cd=class extends Ms{async handleLLMNewToken(e,t,r,n,a,i){await Promise.all(this.handlers.map(s=>mt(async()=>{if(!s.ignoreLLM)try{await s.handleLLMNewToken?.(e,t??{prompt:0,completion:0},this.runId,this._parentRunId,this.tags,i)}catch(o){if((s.raiseError?console.error:console.warn)(`Error in handler ${s.constructor.name}, handleLLMNewToken: ${o}`),s.raiseError)throw o}},s.awaitHandlers)))}async handleLLMError(e,t,r,n,a){await Promise.all(this.handlers.map(i=>mt(async()=>{if(!i.ignoreLLM)try{await i.handleLLMError?.(e,this.runId,this._parentRunId,this.tags,a)}catch(s){if((i.raiseError?console.error:console.warn)(`Error in handler ${i.constructor.name}, handleLLMError: ${s}`),i.raiseError)throw s}},i.awaitHandlers)))}async handleLLMEnd(e,t,r,n,a){await Promise.all(this.handlers.map(i=>mt(async()=>{if(!i.ignoreLLM)try{await i.handleLLMEnd?.(e,this.runId,this._parentRunId,this.tags,a)}catch(s){if((i.raiseError?console.error:console.warn)(`Error in handler ${i.constructor.name}, handleLLMEnd: ${s}`),i.raiseError)throw s}},i.awaitHandlers)))}},Y_=class extends Ms{getChild(e){const t=new Oa(this.runId);return t.setHandlers(this.inheritableHandlers),t.addTags(this.inheritableTags),t.addMetadata(this.inheritableMetadata),e&&t.addTags([e],!1),t}async handleChainError(e,t,r,n,a){await Promise.all(this.handlers.map(i=>mt(async()=>{if(!i.ignoreChain)try{await i.handleChainError?.(e,this.runId,this._parentRunId,this.tags,a)}catch(s){if((i.raiseError?console.error:console.warn)(`Error in handler ${i.constructor.name}, handleChainError: ${s}`),i.raiseError)throw s}},i.awaitHandlers)))}async handleChainEnd(e,t,r,n,a){await Promise.all(this.handlers.map(i=>mt(async()=>{if(!i.ignoreChain)try{await i.handleChainEnd?.(e,this.runId,this._parentRunId,this.tags,a)}catch(s){if((i.raiseError?console.error:console.warn)(`Error in handler ${i.constructor.name}, handleChainEnd: ${s}`),i.raiseError)throw s}},i.awaitHandlers)))}async handleAgentAction(e){await Promise.all(this.handlers.map(t=>mt(async()=>{if(!t.ignoreAgent)try{await t.handleAgentAction?.(e,this.runId,this._parentRunId,this.tags)}catch(r){if((t.raiseError?console.error:console.warn)(`Error in handler ${t.constructor.name}, handleAgentAction: ${r}`),t.raiseError)throw r}},t.awaitHandlers)))}async handleAgentEnd(e){await Promise.all(this.handlers.map(t=>mt(async()=>{if(!t.ignoreAgent)try{await t.handleAgentEnd?.(e,this.runId,this._parentRunId,this.tags)}catch(r){if((t.raiseError?console.error:console.warn)(`Error in handler ${t.constructor.name}, handleAgentEnd: ${r}`),t.raiseError)throw r}},t.awaitHandlers)))}},X_=class extends Ms{getChild(e){const t=new Oa(this.runId);return t.setHandlers(this.inheritableHandlers),t.addTags(this.inheritableTags),t.addMetadata(this.inheritableMetadata),e&&t.addTags([e],!1),t}async handleToolError(e){await Promise.all(this.handlers.map(t=>mt(async()=>{if(!t.ignoreAgent)try{await t.handleToolError?.(e,this.runId,this._parentRunId,this.tags)}catch(r){if((t.raiseError?console.error:console.warn)(`Error in handler ${t.constructor.name}, handleToolError: ${r}`),t.raiseError)throw r}},t.awaitHandlers)))}async handleToolEnd(e){await Promise.all(this.handlers.map(t=>mt(async()=>{if(!t.ignoreAgent)try{await t.handleToolEnd?.(e,this.runId,this._parentRunId,this.tags)}catch(r){if((t.raiseError?console.error:console.warn)(`Error in handler ${t.constructor.name}, handleToolEnd: ${r}`),t.raiseError)throw r}},t.awaitHandlers)))}},Oa=class Ui extends J_{handlers=[];inheritableHandlers=[];tags=[];inheritableTags=[];metadata={};inheritableMetadata={};name="callback_manager";_parentRunId;constructor(t,r){super(),this.handlers=r?.handlers??this.handlers,this.inheritableHandlers=r?.inheritableHandlers??this.inheritableHandlers,this.tags=r?.tags??this.tags,this.inheritableTags=r?.inheritableTags??this.inheritableTags,this.metadata=r?.metadata??this.metadata,this.inheritableMetadata=r?.inheritableMetadata??this.inheritableMetadata,this._parentRunId=t}getParentRunId(){return this._parentRunId}async handleLLMStart(t,r,n=void 0,a=void 0,i=void 0,s=void 0,o=void 0,c=void 0){return Promise.all(r.map(async(u,d)=>{const h=d===0&&n?n:Yr();return await Promise.all(this.handlers.map(p=>{if(!p.ignoreLLM)return qa(p)&&p._createRunForLLMStart(t,[u],h,this._parentRunId,i,this.tags,this.metadata,c),mt(async()=>{try{await p.handleLLMStart?.(t,[u],h,this._parentRunId,i,this.tags,this.metadata,c)}catch(y){if((p.raiseError?console.error:console.warn)(`Error in handler ${p.constructor.name}, handleLLMStart: ${y}`),p.raiseError)throw y}},p.awaitHandlers)})),new Cd(h,this.handlers,this.inheritableHandlers,this.tags,this.inheritableTags,this.metadata,this.inheritableMetadata,this._parentRunId)}))}async handleChatModelStart(t,r,n=void 0,a=void 0,i=void 0,s=void 0,o=void 0,c=void 0){return Promise.all(r.map(async(u,d)=>{const h=d===0&&n?n:Yr();return await Promise.all(this.handlers.map(p=>{if(!p.ignoreLLM)return qa(p)&&p._createRunForChatModelStart(t,[u],h,this._parentRunId,i,this.tags,this.metadata,c),mt(async()=>{try{if(p.handleChatModelStart)await p.handleChatModelStart?.(t,[u],h,this._parentRunId,i,this.tags,this.metadata,c);else if(p.handleLLMStart){const y=YT(u);await p.handleLLMStart?.(t,[y],h,this._parentRunId,i,this.tags,this.metadata,c)}}catch(y){if((p.raiseError?console.error:console.warn)(`Error in handler ${p.constructor.name}, handleLLMStart: ${y}`),p.raiseError)throw y}},p.awaitHandlers)})),new Cd(h,this.handlers,this.inheritableHandlers,this.tags,this.inheritableTags,this.metadata,this.inheritableMetadata,this._parentRunId)}))}async handleChainStart(t,r,n=Yr(),a=void 0,i=void 0,s=void 0,o=void 0){return await Promise.all(this.handlers.map(c=>{if(!c.ignoreChain)return qa(c)&&c._createRunForChainStart(t,r,n,this._parentRunId,this.tags,this.metadata,a,o),mt(async()=>{try{await c.handleChainStart?.(t,r,n,this._parentRunId,this.tags,this.metadata,a,o)}catch(u){if((c.raiseError?console.error:console.warn)(`Error in handler ${c.constructor.name}, handleChainStart: ${u}`),c.raiseError)throw u}},c.awaitHandlers)})),new Y_(n,this.handlers,this.inheritableHandlers,this.tags,this.inheritableTags,this.metadata,this.inheritableMetadata,this._parentRunId)}async handleToolStart(t,r,n=Yr(),a=void 0,i=void 0,s=void 0,o=void 0){return await Promise.all(this.handlers.map(c=>{if(!c.ignoreAgent)return qa(c)&&c._createRunForToolStart(t,r,n,this._parentRunId,this.tags,this.metadata,o),mt(async()=>{try{await c.handleToolStart?.(t,r,n,this._parentRunId,this.tags,this.metadata,o)}catch(u){if((c.raiseError?console.error:console.warn)(`Error in handler ${c.constructor.name}, handleToolStart: ${u}`),c.raiseError)throw u}},c.awaitHandlers)})),new X_(n,this.handlers,this.inheritableHandlers,this.tags,this.inheritableTags,this.metadata,this.inheritableMetadata,this._parentRunId)}async handleRetrieverStart(t,r,n=Yr(),a=void 0,i=void 0,s=void 0,o=void 0){return await Promise.all(this.handlers.map(c=>{if(!c.ignoreRetriever)return qa(c)&&c._createRunForRetrieverStart(t,r,n,this._parentRunId,this.tags,this.metadata,o),mt(async()=>{try{await c.handleRetrieverStart?.(t,r,n,this._parentRunId,this.tags,this.metadata,o)}catch(u){if((c.raiseError?console.error:console.warn)(`Error in handler ${c.constructor.name}, handleRetrieverStart: ${u}`),c.raiseError)throw u}},c.awaitHandlers)})),new Q_(n,this.handlers,this.inheritableHandlers,this.tags,this.inheritableTags,this.metadata,this.inheritableMetadata,this._parentRunId)}async handleCustomEvent(t,r,n,a,i){await Promise.all(this.handlers.map(s=>mt(async()=>{if(!s.ignoreCustomEvent)try{await s.handleCustomEvent?.(t,r,n,this.tags,this.metadata)}catch(o){if((s.raiseError?console.error:console.warn)(`Error in handler ${s.constructor.name}, handleCustomEvent: ${o}`),s.raiseError)throw o}},s.awaitHandlers)))}addHandler(t,r=!0){this.handlers.push(t),r&&this.inheritableHandlers.push(t)}removeHandler(t){this.handlers=this.handlers.filter(r=>r!==t),this.inheritableHandlers=this.inheritableHandlers.filter(r=>r!==t)}setHandlers(t,r=!0){this.handlers=[],this.inheritableHandlers=[];for(const n of t)this.addHandler(n,r)}addTags(t,r=!0){this.removeTags(t),this.tags.push(...t),r&&this.inheritableTags.push(...t)}removeTags(t){this.tags=this.tags.filter(r=>!t.includes(r)),this.inheritableTags=this.inheritableTags.filter(r=>!t.includes(r))}addMetadata(t,r=!0){this.metadata={...this.metadata,...t},r&&(this.inheritableMetadata={...this.inheritableMetadata,...t})}removeMetadata(t){for(const r of Object.keys(t))delete this.metadata[r],delete this.inheritableMetadata[r]}copy(t=[],r=!0){const n=new Ui(this._parentRunId);for(const a of this.handlers){const i=this.inheritableHandlers.includes(a);n.addHandler(a,i)}for(const a of this.tags){const i=this.inheritableTags.includes(a);n.addTags([a],i)}for(const a of Object.keys(this.metadata)){const i=Object.keys(this.inheritableMetadata).includes(a);n.addMetadata({[a]:this.metadata[a]},i)}for(const a of t)n.handlers.filter(i=>i.name==="console_callback_handler").some(i=>i.name===a.name)||n.addHandler(a,r);return n}static fromHandlers(t){class r extends Ds{name=Yr();constructor(){super(),Object.assign(this,t)}}const n=new this;return n.addHandler(new r),n}static configure(t,r,n,a,i,s,o){return this._configureSync(t,r,n,a,i,s,o)}static _configureSync(t,r,n,a,i,s,o){let c;(t||r)&&(Array.isArray(t)||!t?(c=new Ui,c.setHandlers(t?.map(ps)??[],!0)):c=t,c=c.copy(Array.isArray(r)?r.map(ps):r?.handlers,!1));const u=da("LANGCHAIN_VERBOSE")==="true"||o?.verbose,d=Fo.getTraceableRunTree()?.tracingEnabled||BA(),h=d||(da("LANGCHAIN_TRACING")??!1);if(u||h){if(c||(c=new Ui),u&&!c.handlers.some(p=>p.name===Ad.prototype.name)){const p=new Ad;c.addHandler(p,!0)}if(h&&!c.handlers.some(p=>p.name==="langchain_tracer")&&d){const p=new Fo;c.addHandler(p,!0)}if(d){const p=Fo.getTraceableRunTree();p&&c._parentRunId===void 0&&(c._parentRunId=p.id,c.handlers.find(g=>g.name==="langchain_tracer")?.updateFromRunTree(p))}}for(const{contextVar:p,inheritable:y=!0,handlerClass:g,envVar:w}of zA()){const b=w&&da(w)==="true"&&g;let x;const O=p!==void 0?Z_(p):void 0;O&&O_(O)?x=O:b&&(x=new g({})),x!==void 0&&(c||(c=new Ui),c.handlers.some(T=>T.name===x.name)||c.addHandler(x,y))}return(n||a)&&c&&(c.addTags(n??[]),c.addTags(a??[],!1)),(i||s)&&c&&(c.addMetadata(i??{}),c.addMetadata(s??{},!1)),c}};function ps(e){return"name"in e?e:Ds.fromMethods(e)}var ew=class{getStore(){}run(e,t){return t()}enterWith(e){}};const KA=new ew,gg=Symbol.for("lc:child_config");var GA=class{getInstance(){return ls()??KA}getRunnableConfig(){return this.getInstance().getStore()?.extra?.[gg]}runWithConfig(e,t,r){const n=Oa._configureSync(e?.callbacks,void 0,e?.tags,void 0,e?.metadata),a=this.getInstance(),i=a.getStore(),s=n?.getParentRunId(),o=n?.handlers?.find(u=>u?.name==="langchain_tracer");let c;return o&&s?c=o.getRunTreeWithTracingConfig(s):r||(c=new Ht({name:"<runnable_lambda>",tracingEnabled:!1})),c&&(c.extra={...c.extra,[gg]:e}),i!==void 0&&i[Qi]!==void 0&&(c===void 0&&(c={}),c[Qi]=i[Qi]),a.run(c,t)}initializeGlobalInstance(e){ls()===void 0&&lT(e)}};const fn=new GA;var WA={};Et(WA,{AsyncLocalStorageProviderSingleton:()=>fn,MockAsyncLocalStorage:()=>ew,_CONTEXT_VARIABLES_KEY:()=>Qi});const Vl=25;async function Tr(e){return Oa._configureSync(e?.callbacks,void 0,e?.tags,void 0,e?.metadata)}function yg(...e){const t={};for(const r of e.filter(n=>!!n))for(const n of Object.keys(r))if(n==="metadata")t[n]={...t[n],...r[n]};else if(n==="tags"){const a=t[n]??[];t[n]=[...new Set(a.concat(r[n]??[]))]}else if(n==="configurable")t[n]={...t[n],...r[n]};else if(n==="timeout")t.timeout===void 0?t.timeout=r.timeout:r.timeout!==void 0&&(t.timeout=Math.min(t.timeout,r.timeout));else if(n==="signal")t.signal===void 0?t.signal=r.signal:r.signal!==void 0&&("any"in AbortSignal?t.signal=AbortSignal.any([t.signal,r.signal]):t.signal=r.signal);else if(n==="callbacks"){const a=t.callbacks,i=r.callbacks;if(Array.isArray(i))if(!a)t.callbacks=i;else if(Array.isArray(a))t.callbacks=a.concat(i);else{const s=a.copy();for(const o of i)s.addHandler(ps(o),!0);t.callbacks=s}else if(i)if(!a)t.callbacks=i;else if(Array.isArray(a)){const s=i.copy();for(const o of a)s.addHandler(ps(o),!0);t.callbacks=s}else t.callbacks=new Oa(i._parentRunId,{handlers:a.handlers.concat(i.handlers),inheritableHandlers:a.inheritableHandlers.concat(i.inheritableHandlers),tags:Array.from(new Set(a.tags.concat(i.tags))),inheritableTags:Array.from(new Set(a.inheritableTags.concat(i.inheritableTags))),metadata:{...a.metadata,...i.metadata}})}else{const a=n;t[a]=r[a]??t[a]}return t}const VA=new Set(["string","number","boolean"]);function Xe(e){const t=fn.getRunnableConfig();let r={tags:[],metadata:{},recursionLimit:25,runId:void 0};if(t){const{runId:n,runName:a,...i}=t;r=Object.entries(i).reduce((s,[o,c])=>(c!==void 0&&(s[o]=c),s),r)}if(e&&(r=Object.entries(e).reduce((n,[a,i])=>(i!==void 0&&(n[a]=i),n),r)),r?.configurable)for(const n of Object.keys(r.configurable))VA.has(typeof r.configurable[n])&&!r.metadata?.[n]&&(r.metadata||(r.metadata={}),r.metadata[n]=r.configurable[n]);if(r.timeout!==void 0){if(r.timeout<=0)throw new Error("Timeout must be a positive number");const n=AbortSignal.timeout(r.timeout);r.signal!==void 0?"any"in AbortSignal&&(r.signal=AbortSignal.any([r.signal,n])):r.signal=n,delete r.timeout}return r}function Bt(e={},{callbacks:t,maxConcurrency:r,recursionLimit:n,runName:a,configurable:i,runId:s}={}){const o=Xe(e);return t!==void 0&&(delete o.runName,o.callbacks=t),n!==void 0&&(o.recursionLimit=n),r!==void 0&&(o.maxConcurrency=r),a!==void 0&&(o.runName=a),i!==void 0&&(o.configurable={...o.configurable,...i}),s!==void 0&&delete o.runId,o}function oi(e){return e?{configurable:e.configurable,recursionLimit:e.recursionLimit,callbacks:e.callbacks,tags:e.tags,metadata:e.metadata,maxConcurrency:e.maxConcurrency,timeout:e.timeout,signal:e.signal}:void 0}async function Mn(e,t){if(t===void 0)return e;let r;return Promise.race([e.catch(n=>{if(!t?.aborted)throw n}),new Promise((n,a)=>{r=()=>{a(ic(t))},t.addEventListener("abort",r),t.aborted&&a(ic(t))})]).finally(()=>t.removeEventListener("abort",r))}function ic(e){return e?.reason instanceof Error?e.reason:typeof e?.reason=="string"?new Error(e.reason):new Error("Aborted")}var ZA={};Et(ZA,{AsyncGeneratorWithSetup:()=>Ta,IterableReadableStream:()=>Rr,atee:()=>Uf,concat:()=>zf,pipeGeneratorWithSetup:()=>tw});var Rr=class Pd extends ReadableStream{reader;ensureReader(){this.reader||(this.reader=this.getReader())}async next(){this.ensureReader();try{const t=await this.reader.read();return t.done?(this.reader.releaseLock(),{done:!0,value:void 0}):{done:!1,value:t.value}}catch(t){throw this.reader.releaseLock(),t}}async return(){if(this.ensureReader(),this.locked){const t=this.reader.cancel();this.reader.releaseLock(),await t}return{done:!0,value:void 0}}async throw(t){if(this.ensureReader(),this.locked){const r=this.reader.cancel();this.reader.releaseLock(),await r}throw t}[Symbol.asyncIterator](){return this}async[Symbol.asyncDispose](){await this.return()}static fromReadableStream(t){const r=t.getReader();return new Pd({start(n){return a();function a(){return r.read().then(({done:i,value:s})=>{if(i){n.close();return}return n.enqueue(s),a()})}},cancel(){r.releaseLock()}})}static fromAsyncGenerator(t){return new Pd({async pull(r){const{value:n,done:a}=await t.next();a&&r.close(),r.enqueue(n)},async cancel(r){await t.return(r)}})}};function Uf(e,t=2){const r=Array.from({length:t},()=>[]);return r.map(async function*(a){for(;;)if(a.length===0){const i=await e.next();for(const s of r)s.push(i)}else{if(a[0].done)return;yield a.shift().value}})}function zf(e,t){if(Array.isArray(e)&&Array.isArray(t))return e.concat(t);if(typeof e=="string"&&typeof t=="string")return e+t;if(typeof e=="number"&&typeof t=="number")return e+t;if("concat"in e&&typeof e.concat=="function")return e.concat(t);if(typeof e=="object"&&typeof t=="object"){const r={...e};for(const[n,a]of Object.entries(t))n in r&&!Array.isArray(r[n])?r[n]=zf(r[n],a):r[n]=a;return r}else throw new Error(`Cannot concat ${typeof e} and ${typeof t}`)}var Ta=class{generator;setup;config;signal;firstResult;firstResultUsed=!1;constructor(e){this.generator=e.generator,this.config=e.config,this.signal=e.signal??this.config?.signal,this.setup=new Promise((t,r)=>{fn.runWithConfig(oi(e.config),async()=>{this.firstResult=e.generator.next(),e.startSetup?this.firstResult.then(e.startSetup).then(t,r):this.firstResult.then(n=>t(void 0),r)},!0)})}async next(...e){return this.signal?.throwIfAborted(),this.firstResultUsed?fn.runWithConfig(oi(this.config),this.signal?async()=>Mn(this.generator.next(...e),this.signal):async()=>this.generator.next(...e),!0):(this.firstResultUsed=!0,this.firstResult)}async return(e){return this.generator.return(e)}async throw(e){return this.generator.throw(e)}[Symbol.asyncIterator](){return this}async[Symbol.asyncDispose](){await this.return()}};async function tw(e,t,r,n,...a){const i=new Ta({generator:t,startSetup:r,signal:n}),s=await i.setup;return{output:e(i,s,...a),setup:s}}const JA=Object.prototype.hasOwnProperty;function QA(e,t){return JA.call(e,t)}function YA(e){if(Array.isArray(e)){const r=new Array(e.length);for(let n=0;n<r.length;n++)r[n]=""+n;return r}if(Object.keys)return Object.keys(e);let t=[];for(let r in e)QA(e,r)&&t.push(r);return t}function wa(e){switch(typeof e){case"object":return JSON.parse(JSON.stringify(e));case"undefined":return null;default:return e}}function Nd(e){let t=0;const r=e.length;let n;for(;t<r;){if(n=e.charCodeAt(t),n>=48&&n<=57){t++;continue}return!1}return!0}function XA(e){return e.replace(/~1/g,"/").replace(/~0/g,"~")}function Dd(e){if(e===void 0)return!0;if(e){if(Array.isArray(e)){for(let r=0,n=e.length;r<n;r++)if(Dd(e[r]))return!0}else if(typeof e=="object"){const r=YA(e),n=r.length;for(var t=0;t<n;t++)if(Dd(e[r[t]]))return!0}}return!1}function vg(e,t){const r=[e];for(const n in t){const a=typeof t[n]=="object"?JSON.stringify(t[n],null,2):t[n];typeof a<"u"&&r.push(`${n}: ${a}`)}return r.join(`
`)}var eC=class extends Error{constructor(e,t,r,n,a){super(vg(e,{name:t,index:r,operation:n,tree:a})),this.name=t,this.index=r,this.operation=n,this.tree=a,Object.setPrototypeOf(this,new.target.prototype),this.message=vg(e,{name:t,index:r,operation:n,tree:a})}},rw={};Et(rw,{JsonPatchError:()=>ut,_areEquals:()=>gs,applyOperation:()=>ha,applyPatch:()=>ms,applyReducer:()=>nC,deepClone:()=>tC,getValueByPointer:()=>sc,validate:()=>nw,validator:()=>oc});const ut=eC,tC=wa,Wa={add:function(e,t,r){return e[t]=this.value,{newDocument:r}},remove:function(e,t,r){var n=e[t];return delete e[t],{newDocument:r,removed:n}},replace:function(e,t,r){var n=e[t];return e[t]=this.value,{newDocument:r,removed:n}},move:function(e,t,r){let n=sc(r,this.path);n&&(n=wa(n));const a=ha(r,{op:"remove",path:this.from}).removed;return ha(r,{op:"add",path:this.path,value:a}),{newDocument:r,removed:n}},copy:function(e,t,r){const n=sc(r,this.from);return ha(r,{op:"add",path:this.path,value:wa(n)}),{newDocument:r}},test:function(e,t,r){return{newDocument:r,test:gs(e[t],this.value)}},_get:function(e,t,r){return this.value=e[t],{newDocument:r}}};var rC={add:function(e,t,r){return Nd(t)?e.splice(t,0,this.value):e[t]=this.value,{newDocument:r,index:t}},remove:function(e,t,r){var n=e.splice(t,1);return{newDocument:r,removed:n[0]}},replace:function(e,t,r){var n=e[t];return e[t]=this.value,{newDocument:r,removed:n}},move:Wa.move,copy:Wa.copy,test:Wa.test,_get:Wa._get};function sc(e,t){if(t=="")return e;var r={op:"_get",path:t};return ha(e,r),r.value}function ha(e,t,r=!1,n=!0,a=!0,i=0){if(r&&(typeof r=="function"?r(t,0,e,t.path):oc(t,0)),t.path===""){let s={newDocument:e};if(t.op==="add")return s.newDocument=t.value,s;if(t.op==="replace")return s.newDocument=t.value,s.removed=e,s;if(t.op==="move"||t.op==="copy")return s.newDocument=sc(e,t.from),t.op==="move"&&(s.removed=e),s;if(t.op==="test"){if(s.test=gs(e,t.value),s.test===!1)throw new ut("Test operation failed","TEST_OPERATION_FAILED",i,t,e);return s.newDocument=e,s}else{if(t.op==="remove")return s.removed=e,s.newDocument=null,s;if(t.op==="_get")return t.value=e,s;if(r)throw new ut("Operation `op` property is not one of operations defined in RFC-6902","OPERATION_OP_INVALID",i,t,e);return s}}else{n||(e=wa(e));const o=(t.path||"").split("/");let c=e,u=1,d=o.length,h,p,y;for(typeof r=="function"?y=r:y=oc;;){if(p=o[u],p&&p.indexOf("~")!=-1&&(p=XA(p)),a&&(p=="__proto__"||p=="prototype"&&u>0&&o[u-1]=="constructor"))throw new TypeError("JSON-Patch: modifying `__proto__` or `constructor/prototype` prop is banned for security reasons, if this was on purpose, please set `banPrototypeModifications` flag false and pass it to this function. More info in fast-json-patch README");if(r&&h===void 0&&(c[p]===void 0?h=o.slice(0,u).join("/"):u==d-1&&(h=t.path),h!==void 0&&y(t,0,e,h)),u++,Array.isArray(c)){if(p==="-")p=c.length;else{if(r&&!Nd(p))throw new ut("Expected an unsigned base-10 integer value, making the new referenced value the array element with the zero-based index","OPERATION_PATH_ILLEGAL_ARRAY_INDEX",i,t,e);Nd(p)&&(p=~~p)}if(u>=d){if(r&&t.op==="add"&&p>c.length)throw new ut("The specified index MUST NOT be greater than the number of elements in the array","OPERATION_VALUE_OUT_OF_BOUNDS",i,t,e);const g=rC[t.op].call(t,c,p,e);if(g.test===!1)throw new ut("Test operation failed","TEST_OPERATION_FAILED",i,t,e);return g}}else if(u>=d){const g=Wa[t.op].call(t,c,p,e);if(g.test===!1)throw new ut("Test operation failed","TEST_OPERATION_FAILED",i,t,e);return g}if(c=c[p],r&&u<d&&(!c||typeof c!="object"))throw new ut("Cannot perform operation at the desired path","OPERATION_PATH_UNRESOLVABLE",i,t,e)}}}function ms(e,t,r,n=!0,a=!0){if(r&&!Array.isArray(t))throw new ut("Patch sequence must be an array","SEQUENCE_NOT_AN_ARRAY");n||(e=wa(e));const i=new Array(t.length);for(let s=0,o=t.length;s<o;s++)i[s]=ha(e,t[s],r,!0,a,s),e=i[s].newDocument;return i.newDocument=e,i}function nC(e,t,r){const n=ha(e,t);if(n.test===!1)throw new ut("Test operation failed","TEST_OPERATION_FAILED",r,t,e);return n.newDocument}function oc(e,t,r,n){if(typeof e!="object"||e===null||Array.isArray(e))throw new ut("Operation is not an object","OPERATION_NOT_AN_OBJECT",t,e,r);if(Wa[e.op]){if(typeof e.path!="string")throw new ut("Operation `path` property is not a string","OPERATION_PATH_INVALID",t,e,r);if(e.path.indexOf("/")!==0&&e.path.length>0)throw new ut('Operation `path` property must start with "/"',"OPERATION_PATH_INVALID",t,e,r);if((e.op==="move"||e.op==="copy")&&typeof e.from!="string")throw new ut("Operation `from` property is not present (applicable in `move` and `copy` operations)","OPERATION_FROM_REQUIRED",t,e,r);if((e.op==="add"||e.op==="replace"||e.op==="test")&&e.value===void 0)throw new ut("Operation `value` property is not present (applicable in `add`, `replace` and `test` operations)","OPERATION_VALUE_REQUIRED",t,e,r);if((e.op==="add"||e.op==="replace"||e.op==="test")&&Dd(e.value))throw new ut("Operation `value` property is not present (applicable in `add`, `replace` and `test` operations)","OPERATION_VALUE_CANNOT_CONTAIN_UNDEFINED",t,e,r);if(r){if(e.op=="add"){var a=e.path.split("/").length,i=n.split("/").length;if(a!==i+1&&a!==i)throw new ut("Cannot perform an `add` operation at the desired path","OPERATION_PATH_CANNOT_ADD",t,e,r)}else if(e.op==="replace"||e.op==="remove"||e.op==="_get"){if(e.path!==n)throw new ut("Cannot perform the operation at a path that does not exist","OPERATION_PATH_UNRESOLVABLE",t,e,r)}else if(e.op==="move"||e.op==="copy"){var s={op:"_get",path:e.from,value:void 0},o=nw([s],r);if(o&&o.name==="OPERATION_PATH_UNRESOLVABLE")throw new ut("Cannot perform the operation from a path that does not exist","OPERATION_FROM_UNRESOLVABLE",t,e,r)}}}else throw new ut("Operation `op` property is not one of operations defined in RFC-6902","OPERATION_OP_INVALID",t,e,r)}function nw(e,t,r){try{if(!Array.isArray(e))throw new ut("Patch sequence must be an array","SEQUENCE_NOT_AN_ARRAY");if(t)ms(wa(t),wa(e),r||!0);else{r=r||oc;for(var n=0;n<e.length;n++)r(e[n],n,t,void 0)}}catch(a){if(a instanceof ut)return a;throw a}}function gs(e,t){if(e===t)return!0;if(e&&t&&typeof e=="object"&&typeof t=="object"){var r=Array.isArray(e),n=Array.isArray(t),a,i,s;if(r&&n){if(i=e.length,i!=t.length)return!1;for(a=i;a--!==0;)if(!gs(e[a],t[a]))return!1;return!0}if(r!=n)return!1;var o=Object.keys(e);if(i=o.length,i!==Object.keys(t).length)return!1;for(a=i;a--!==0;)if(!t.hasOwnProperty(o[a]))return!1;for(a=i;a--!==0;)if(s=o[a],!gs(e[s],t[s]))return!1;return!0}return e!==e&&t!==t}({...rw});var aC={};Et(aC,{LogStreamCallbackHandler:()=>Md,RunLog:()=>qf,RunLogPatch:()=>Xr,isLogStreamHandler:()=>aw});var Xr=class{ops;constructor(e){this.ops=e.ops??[]}concat(e){const t=this.ops.concat(e.ops),r=ms({},t);return new qf({ops:t,state:r[r.length-1].newDocument})}},qf=class Ld extends Xr{state;constructor(t){super(t),this.state=t.state}concat(t){const r=this.ops.concat(t.ops),n=ms(this.state,t.ops);return new Ld({ops:r,state:n[n.length-1].newDocument})}static fromRunLogPatch(t){const r=ms({},t.ops);return new Ld({ops:t.ops,state:r[r.length-1].newDocument})}};const aw=e=>e.name==="log_stream_tracer";async function _g(e,t){if(t==="original")throw new Error("Do not assign inputs with original schema drop the key for now. When inputs are added to streamLog they should be added with standardized schema for streaming events.");const{inputs:r}=e;if(["retriever","llm","prompt"].includes(e.run_type))return r;if(!(Object.keys(r).length===1&&r?.input===""))return r.input}async function wg(e,t){const{outputs:r}=e;return t==="original"||["retriever","llm","prompt"].includes(e.run_type)?r:r!==void 0&&Object.keys(r).length===1&&r?.output!==void 0?r.output:r}function iC(e){return e!==void 0&&e.message!==void 0}var Md=class extends _i{autoClose=!0;includeNames;includeTypes;includeTags;excludeNames;excludeTypes;excludeTags;_schemaFormat="original";rootId;keyMapByRunId={};counterMapByRunName={};transformStream;writer;receiveStream;name="log_stream_tracer";lc_prefer_streaming=!0;constructor(e){super({_awaitHandler:!0,...e}),this.autoClose=e?.autoClose??!0,this.includeNames=e?.includeNames,this.includeTypes=e?.includeTypes,this.includeTags=e?.includeTags,this.excludeNames=e?.excludeNames,this.excludeTypes=e?.excludeTypes,this.excludeTags=e?.excludeTags,this._schemaFormat=e?._schemaFormat??this._schemaFormat,this.transformStream=new TransformStream,this.writer=this.transformStream.writable.getWriter(),this.receiveStream=Rr.fromReadableStream(this.transformStream.readable)}[Symbol.asyncIterator](){return this.receiveStream}async persistRun(e){}_includeRun(e){if(e.id===this.rootId)return!1;const t=e.tags??[];let r=this.includeNames===void 0&&this.includeTags===void 0&&this.includeTypes===void 0;return this.includeNames!==void 0&&(r=r||this.includeNames.includes(e.name)),this.includeTypes!==void 0&&(r=r||this.includeTypes.includes(e.run_type)),this.includeTags!==void 0&&(r=r||t.find(n=>this.includeTags?.includes(n))!==void 0),this.excludeNames!==void 0&&(r=r&&!this.excludeNames.includes(e.name)),this.excludeTypes!==void 0&&(r=r&&!this.excludeTypes.includes(e.run_type)),this.excludeTags!==void 0&&(r=r&&t.every(n=>!this.excludeTags?.includes(n))),r}async*tapOutputIterable(e,t){for await(const r of t){if(e!==this.rootId){const n=this.keyMapByRunId[e];n&&await this.writer.write(new Xr({ops:[{op:"add",path:`/logs/${n}/streamed_output/-`,value:r}]}))}yield r}}async onRunCreate(e){if(this.rootId===void 0&&(this.rootId=e.id,await this.writer.write(new Xr({ops:[{op:"replace",path:"",value:{id:e.id,name:e.name,type:e.run_type,streamed_output:[],final_output:void 0,logs:{}}}]}))),!this._includeRun(e))return;this.counterMapByRunName[e.name]===void 0&&(this.counterMapByRunName[e.name]=0),this.counterMapByRunName[e.name]+=1;const t=this.counterMapByRunName[e.name];this.keyMapByRunId[e.id]=t===1?e.name:`${e.name}:${t}`;const r={id:e.id,name:e.name,type:e.run_type,tags:e.tags??[],metadata:e.extra?.metadata??{},start_time:new Date(e.start_time).toISOString(),streamed_output:[],streamed_output_str:[],final_output:void 0,end_time:void 0};this._schemaFormat==="streaming_events"&&(r.inputs=await _g(e,this._schemaFormat)),await this.writer.write(new Xr({ops:[{op:"add",path:`/logs/${this.keyMapByRunId[e.id]}`,value:r}]}))}async onRunUpdate(e){try{const t=this.keyMapByRunId[e.id];if(t===void 0)return;const r=[];this._schemaFormat==="streaming_events"&&r.push({op:"replace",path:`/logs/${t}/inputs`,value:await _g(e,this._schemaFormat)}),r.push({op:"add",path:`/logs/${t}/final_output`,value:await wg(e,this._schemaFormat)}),e.end_time!==void 0&&r.push({op:"add",path:`/logs/${t}/end_time`,value:new Date(e.end_time).toISOString()});const n=new Xr({ops:r});await this.writer.write(n)}finally{if(e.id===this.rootId){const t=new Xr({ops:[{op:"replace",path:"/final_output",value:await wg(e,this._schemaFormat)}]});await this.writer.write(t),this.autoClose&&await this.writer.close()}}}async onLLMNewToken(e,t,r){const n=this.keyMapByRunId[e.id];if(n===void 0)return;const a=e.inputs.messages!==void 0;let i;a?iC(r?.chunk)?i=r?.chunk:i=new w_({id:`run-${e.id}`,content:t}):i=t;const s=new Xr({ops:[{op:"add",path:`/logs/${n}/streamed_output_str/-`,value:t},{op:"add",path:`/logs/${n}/streamed_output/-`,value:i}]});await this.writer.write(s)}},sC={};Et(sC,{ChatGenerationChunk:()=>cC,GenerationChunk:()=>cc,RUN_KEY:()=>oC});const oC="__run";var cc=class iw{text;generationInfo;constructor(t){this.text=t.text,this.generationInfo=t.generationInfo}concat(t){return new iw({text:this.text+t.text,generationInfo:{...this.generationInfo,...t.generationInfo}})}},cC=class sw extends cc{message;constructor(t){super(t),this.message=t.message}concat(t){return new sw({text:this.text+t.text,generationInfo:{...this.generationInfo,...t.generationInfo},message:this.message.concat(t.message)})}};function ko({name:e,serialized:t}){return e!==void 0?e:t?.name!==void 0?t.name:t?.id!==void 0&&Array.isArray(t?.id)?t.id[t.id.length-1]:"Unnamed"}const uC=e=>e.name==="event_stream_tracer";var lC=class extends _i{autoClose=!0;includeNames;includeTypes;includeTags;excludeNames;excludeTypes;excludeTags;runInfoMap=new Map;tappedPromises=new Map;transformStream;writer;receiveStream;name="event_stream_tracer";lc_prefer_streaming=!0;constructor(e){super({_awaitHandler:!0,...e}),this.autoClose=e?.autoClose??!0,this.includeNames=e?.includeNames,this.includeTypes=e?.includeTypes,this.includeTags=e?.includeTags,this.excludeNames=e?.excludeNames,this.excludeTypes=e?.excludeTypes,this.excludeTags=e?.excludeTags,this.transformStream=new TransformStream,this.writer=this.transformStream.writable.getWriter(),this.receiveStream=Rr.fromReadableStream(this.transformStream.readable)}[Symbol.asyncIterator](){return this.receiveStream}async persistRun(e){}_includeRun(e){const t=e.tags??[];let r=this.includeNames===void 0&&this.includeTags===void 0&&this.includeTypes===void 0;return this.includeNames!==void 0&&(r=r||this.includeNames.includes(e.name)),this.includeTypes!==void 0&&(r=r||this.includeTypes.includes(e.runType)),this.includeTags!==void 0&&(r=r||t.find(n=>this.includeTags?.includes(n))!==void 0),this.excludeNames!==void 0&&(r=r&&!this.excludeNames.includes(e.name)),this.excludeTypes!==void 0&&(r=r&&!this.excludeTypes.includes(e.runType)),this.excludeTags!==void 0&&(r=r&&t.every(n=>!this.excludeTags?.includes(n))),r}async*tapOutputIterable(e,t){const r=await t.next();if(r.done)return;const n=this.runInfoMap.get(e);if(n===void 0){yield r.value;return}function a(s,o){return s==="llm"&&typeof o=="string"?new cc({text:o}):o}let i=this.tappedPromises.get(e);if(i===void 0){let s;i=new Promise(o=>{s=o}),this.tappedPromises.set(e,i);try{const o={event:`on_${n.runType}_stream`,run_id:e,name:n.name,tags:n.tags,metadata:n.metadata,data:{}};await this.send({...o,data:{chunk:a(n.runType,r.value)}},n),yield r.value;for await(const c of t)n.runType!=="tool"&&n.runType!=="retriever"&&await this.send({...o,data:{chunk:a(n.runType,c)}},n),yield c}finally{s?.()}}else{yield r.value;for await(const s of t)yield s}}async send(e,t){this._includeRun(t)&&await this.writer.write(e)}async sendEndEvent(e,t){const r=this.tappedPromises.get(e.run_id);r!==void 0?r.then(()=>{this.send(e,t)}):await this.send(e,t)}async onLLMStart(e){const t=ko(e),r=e.inputs.messages!==void 0?"chat_model":"llm",n={tags:e.tags??[],metadata:e.extra?.metadata??{},name:t,runType:r,inputs:e.inputs};this.runInfoMap.set(e.id,n);const a=`on_${r}_start`;await this.send({event:a,data:{input:e.inputs},name:t,tags:e.tags??[],run_id:e.id,metadata:e.extra?.metadata??{}},n)}async onLLMNewToken(e,t,r){const n=this.runInfoMap.get(e.id);let a,i;if(n===void 0)throw new Error(`onLLMNewToken: Run ID ${e.id} not found in run map.`);if(this.runInfoMap.size!==1){if(n.runType==="chat_model")i="on_chat_model_stream",r?.chunk===void 0?a=new w_({content:t,id:`run-${e.id}`}):a=r.chunk.message;else if(n.runType==="llm")i="on_llm_stream",r?.chunk===void 0?a=new cc({text:t}):a=r.chunk;else throw new Error(`Unexpected run type ${n.runType}`);await this.send({event:i,data:{chunk:a},run_id:e.id,name:n.name,tags:n.tags,metadata:n.metadata},n)}}async onLLMEnd(e){const t=this.runInfoMap.get(e.id);this.runInfoMap.delete(e.id);let r;if(t===void 0)throw new Error(`onLLMEnd: Run ID ${e.id} not found in run map.`);const n=e.outputs?.generations;let a;if(t.runType==="chat_model"){for(const i of n??[]){if(a!==void 0)break;a=i[0]?.message}r="on_chat_model_end"}else if(t.runType==="llm")a={generations:n?.map(i=>i.map(s=>({text:s.text,generationInfo:s.generationInfo}))),llmOutput:e.outputs?.llmOutput??{}},r="on_llm_end";else throw new Error(`onLLMEnd: Unexpected run type: ${t.runType}`);await this.sendEndEvent({event:r,data:{output:a,input:t.inputs},run_id:e.id,name:t.name,tags:t.tags,metadata:t.metadata},t)}async onChainStart(e){const t=ko(e),r=e.run_type??"chain",n={tags:e.tags??[],metadata:e.extra?.metadata??{},name:t,runType:e.run_type};let a={};e.inputs.input===""&&Object.keys(e.inputs).length===1?(a={},n.inputs={}):e.inputs.input!==void 0?(a.input=e.inputs.input,n.inputs=e.inputs.input):(a.input=e.inputs,n.inputs=e.inputs),this.runInfoMap.set(e.id,n),await this.send({event:`on_${r}_start`,data:a,name:t,tags:e.tags??[],run_id:e.id,metadata:e.extra?.metadata??{}},n)}async onChainEnd(e){const t=this.runInfoMap.get(e.id);if(this.runInfoMap.delete(e.id),t===void 0)throw new Error(`onChainEnd: Run ID ${e.id} not found in run map.`);const r=`on_${e.run_type}_end`,n=e.inputs??t.inputs??{},i={output:e.outputs?.output??e.outputs,input:n};n.input&&Object.keys(n).length===1&&(i.input=n.input,t.inputs=n.input),await this.sendEndEvent({event:r,data:i,run_id:e.id,name:t.name,tags:t.tags,metadata:t.metadata??{}},t)}async onToolStart(e){const t=ko(e),r={tags:e.tags??[],metadata:e.extra?.metadata??{},name:t,runType:"tool",inputs:e.inputs??{}};this.runInfoMap.set(e.id,r),await this.send({event:"on_tool_start",data:{input:e.inputs??{}},name:t,run_id:e.id,tags:e.tags??[],metadata:e.extra?.metadata??{}},r)}async onToolEnd(e){const t=this.runInfoMap.get(e.id);if(this.runInfoMap.delete(e.id),t===void 0)throw new Error(`onToolEnd: Run ID ${e.id} not found in run map.`);if(t.inputs===void 0)throw new Error(`onToolEnd: Run ID ${e.id} is a tool call, and is expected to have traced inputs.`);const r=e.outputs?.output===void 0?e.outputs:e.outputs.output;await this.sendEndEvent({event:"on_tool_end",data:{output:r,input:t.inputs},run_id:e.id,name:t.name,tags:t.tags,metadata:t.metadata},t)}async onRetrieverStart(e){const t=ko(e),n={tags:e.tags??[],metadata:e.extra?.metadata??{},name:t,runType:"retriever",inputs:{query:e.inputs.query}};this.runInfoMap.set(e.id,n),await this.send({event:"on_retriever_start",data:{input:{query:e.inputs.query}},name:t,tags:e.tags??[],run_id:e.id,metadata:e.extra?.metadata??{}},n)}async onRetrieverEnd(e){const t=this.runInfoMap.get(e.id);if(this.runInfoMap.delete(e.id),t===void 0)throw new Error(`onRetrieverEnd: Run ID ${e.id} not found in run map.`);await this.sendEndEvent({event:"on_retriever_end",data:{output:e.outputs?.documents??e.outputs,input:t.inputs},run_id:e.id,name:t.name,tags:t.tags,metadata:t.metadata},t)}async handleCustomEvent(e,t,r){const n=this.runInfoMap.get(r);if(n===void 0)throw new Error(`handleCustomEvent: Run ID ${r} not found in run map.`);await this.send({event:"on_custom_event",run_id:r,name:e,tags:n.tags,metadata:n.metadata,data:t},n)}async finish(){const e=[...this.tappedPromises.values()];Promise.all(e).finally(()=>{this.writer.close()})}},dC={};Et(dC,{AsyncCaller:()=>Hf});const fC=[400,401,402,403,404,405,406,407,409],hC=e=>{if(e.message.startsWith("Cancel")||e.message.startsWith("AbortError")||e.name==="AbortError"||e?.code==="ECONNABORTED")throw e;const t=e?.response?.status??e?.status;if(t&&fC.includes(+t))throw e;if(e?.error?.code==="insufficient_quota"){const r=new Error(e?.message);throw r.name="InsufficientQuotaError",r}};var Hf=class{maxConcurrency;maxRetries;onFailedAttempt;queue;constructor(e){this.maxConcurrency=e.maxConcurrency??1/0,this.maxRetries=e.maxRetries??6,this.onFailedAttempt=e.onFailedAttempt??hC;const t="default"in rn?rn.default:rn;this.queue=new t({concurrency:this.maxConcurrency})}call(e,...t){return this.queue.add(()=>rc(()=>e(...t).catch(r=>{throw r instanceof Error?r:new Error(r)}),{onFailedAttempt:this.onFailedAttempt,retries:this.maxRetries,randomize:!0}),{throwOnTimeout:!0})}callWithOptions(e,t,...r){if(e.signal){let n;return Promise.race([this.call(t,...r),new Promise((a,i)=>{n=()=>{i(ic(e.signal))},e.signal?.addEventListener("abort",n)})]).finally(()=>{e.signal&&n&&e.signal.removeEventListener("abort",n)})}return this.call(t,...r)}fetch(...e){return this.call(()=>fetch(...e).then(t=>t.ok?t:Promise.reject(t)))}},ow=class extends _i{name="RootListenersTracer";rootId;config;argOnStart;argOnEnd;argOnError;constructor({config:e,onStart:t,onEnd:r,onError:n}){super({_awaitHandler:!0}),this.config=e,this.argOnStart=t,this.argOnEnd=r,this.argOnError=n}persistRun(e){return Promise.resolve()}async onRunCreate(e){this.rootId||(this.rootId=e.id,this.argOnStart&&await this.argOnStart(e,this.config))}async onRunUpdate(e){e.id===this.rootId&&(e.error?this.argOnError&&await this.argOnError(e,this.config):this.argOnEnd&&await this.argOnEnd(e,this.config))}};function Kf(e){return e?e.lc_runnable:!1}var pC=class{includeNames;includeTypes;includeTags;excludeNames;excludeTypes;excludeTags;constructor(e){this.includeNames=e.includeNames,this.includeTypes=e.includeTypes,this.includeTags=e.includeTags,this.excludeNames=e.excludeNames,this.excludeTypes=e.excludeTypes,this.excludeTags=e.excludeTags}includeEvent(e,t){let r=this.includeNames===void 0&&this.includeTypes===void 0&&this.includeTags===void 0;const n=e.tags??[];return this.includeNames!==void 0&&(r=r||this.includeNames.includes(e.name)),this.includeTypes!==void 0&&(r=r||this.includeTypes.includes(t)),this.includeTags!==void 0&&(r=r||n.some(a=>this.includeTags?.includes(a))),this.excludeNames!==void 0&&(r=r&&!this.excludeNames.includes(e.name)),this.excludeTypes!==void 0&&(r=r&&!this.excludeTypes.includes(t)),this.excludeTags!==void 0&&(r=r&&n.every(a=>!this.excludeTags?.includes(a))),r}};function Mc(e,t,r){function n(o,c){var u;Object.defineProperty(o,"_zod",{value:o._zod??{},enumerable:!1}),(u=o._zod).traits??(u.traits=new Set),o._zod.traits.add(e),t(o,c);for(const d in s.prototype)d in o||Object.defineProperty(o,d,{value:s.prototype[d].bind(o)});o._zod.constr=s,o._zod.def=c}const a=r?.Parent??Object;class i extends a{}Object.defineProperty(i,"name",{value:e});function s(o){var c;const u=r?.Parent?new i:this;n(u,o),(c=u._zod).deferred??(c.deferred=[]);for(const d of u._zod.deferred)d();return u}return Object.defineProperty(s,"init",{value:n}),Object.defineProperty(s,Symbol.hasInstance,{value:o=>r?.Parent&&o instanceof r.Parent?!0:o?._zod?.traits?.has(e)}),Object.defineProperty(s,"name",{value:e}),s}class Bo extends Error{constructor(){super("Encountered Promise during synchronous parse. Use .parseAsync() instead.")}}const mC={};function Gf(e){return mC}function gC(e){const t=Object.values(e).filter(n=>typeof n=="number");return Object.entries(e).filter(([n,a])=>t.indexOf(+n)===-1).map(([n,a])=>a)}function yC(e,t){return typeof t=="bigint"?t.toString():t}const vC="captureStackTrace"in Error?Error.captureStackTrace:(...e)=>{};function uc(e,t,r){const n=new e._zod.constr(t??e._zod.def);return(!t||r?.parent)&&(n._zod.parent=e),n}function _C(e){return{}}function Io(e,t=0){if(e.aborted===!0)return!0;for(let r=t;r<e.issues.length;r++)if(e.issues[r]?.continue!==!0)return!0;return!1}function Oo(e){return typeof e=="string"?e:e?.message}function Wf(e,t,r){const n={...e,path:e.path??[]};if(!e.message){const a=Oo(e.inst?._zod.def?.error?.(e))??Oo(t?.error?.(e))??Oo(r.customError?.(e))??Oo(r.localeError?.(e))??"Invalid input";n.message=a}return delete n.inst,delete n.continue,t?.reportInput||delete n.input,n}const cw=(e,t)=>{e.name="$ZodError",Object.defineProperty(e,"_zod",{value:e._zod,enumerable:!1}),Object.defineProperty(e,"issues",{value:t,enumerable:!1}),e.message=JSON.stringify(t,yC,2),Object.defineProperty(e,"toString",{value:()=>e.message,enumerable:!1})},wC=Mc("$ZodError",cw),Vf=Mc("$ZodError",cw,{Parent:Error}),bC=e=>async(t,r,n,a)=>{const i=n?Object.assign(n,{async:!0}):{async:!0};let s=t._zod.run({value:r,issues:[]},i);if(s instanceof Promise&&(s=await s),s.issues.length){const o=new(a?.Err??e)(s.issues.map(c=>Wf(c,i,Gf())));throw vC(o,a?.callee),o}return s.value},EC=bC(Vf),xC=e=>(t,r,n)=>{const a=n?{...n,async:!1}:{async:!1},i=t._zod.run({value:r,issues:[]},a);if(i instanceof Promise)throw new Bo;return i.issues.length?{success:!1,error:new(e??wC)(i.issues.map(s=>Wf(s,a,Gf())))}:{success:!0,data:i.value}},SC=xC(Vf),kC=e=>async(t,r,n)=>{const a=n?Object.assign(n,{async:!0}):{async:!0};let i=t._zod.run({value:r,issues:[]},a);return i instanceof Promise&&(i=await i),i.issues.length?{success:!1,error:new e(i.issues.map(s=>Wf(s,a,Gf())))}:{success:!0,data:i.value}},IC=kC(Vf),OC={major:4,minor:1,patch:12},TC=Mc("$ZodType",(e,t)=>{var r;e??(e={}),e._zod.def=t,e._zod.bag=e._zod.bag||{},e._zod.version=OC;const n=[...e._zod.def.checks??[]];e._zod.traits.has("$ZodCheck")&&n.unshift(e);for(const a of n)for(const i of a._zod.onattach)i(e);if(n.length===0)(r=e._zod).deferred??(r.deferred=[]),e._zod.deferred?.push(()=>{e._zod.run=e._zod.parse});else{const a=(s,o,c)=>{let u=Io(s),d;for(const h of o){if(h._zod.def.when){if(!h._zod.def.when(s))continue}else if(u)continue;const p=s.issues.length,y=h._zod.check(s);if(y instanceof Promise&&c?.async===!1)throw new Bo;if(d||y instanceof Promise)d=(d??Promise.resolve()).then(async()=>{await y,s.issues.length!==p&&(u||(u=Io(s,p)))});else{if(s.issues.length===p)continue;u||(u=Io(s,p))}}return d?d.then(()=>s):s},i=(s,o,c)=>{if(Io(s))return s.aborted=!0,s;const u=a(o,n,c);if(u instanceof Promise){if(c.async===!1)throw new Bo;return u.then(d=>e._zod.parse(d,c))}return e._zod.parse(u,c)};e._zod.run=(s,o)=>{if(o.skipChecks)return e._zod.parse(s,o);if(o.direction==="backward"){const u=e._zod.parse({value:s.value,issues:[]},{...o,skipChecks:!0});return u instanceof Promise?u.then(d=>i(d,s,o)):i(u,s,o)}const c=e._zod.parse(s,o);if(c instanceof Promise){if(o.async===!1)throw new Bo;return c.then(u=>a(u,n,o))}return a(c,n,o)}}e["~standard"]={validate:a=>{try{const i=SC(e,a);return i.success?{value:i.data}:{issues:i.error?.issues}}catch{return IC(e,a).then(s=>s.success?{value:s.data}:{issues:s.error?.issues})}},vendor:"zod",version:1}}),RC=Mc("$ZodNever",(e,t)=>{TC.init(e,t),e._zod.parse=(r,n)=>(r.issues.push({expected:"never",code:"invalid_type",input:r.value,inst:e}),r)});class uw{constructor(){this._map=new WeakMap,this._idmap=new Map}add(t,...r){const n=r[0];if(this._map.set(t,n),n&&typeof n=="object"&&"id"in n){if(this._idmap.has(n.id))throw new Error(`ID ${n.id} already exists in the registry`);this._idmap.set(n.id,t)}return this}clear(){return this._map=new WeakMap,this._idmap=new Map,this}remove(t){const r=this._map.get(t);return r&&typeof r=="object"&&"id"in r&&this._idmap.delete(r.id),this._map.delete(t),this}get(t){const r=t._zod.parent;if(r){const n={...this.get(r)??{}};delete n.id;const a={...n,...this._map.get(t)};return Object.keys(a).length?a:void 0}return this._map.get(t)}has(t){return this._map.has(t)}}function $C(){return new uw}const Tn=$C();function AC(e,t){return new e({type:"never",..._C()})}class bg{constructor(t){this.counter=0,this.metadataRegistry=t?.metadata??Tn,this.target=t?.target??"draft-2020-12",this.unrepresentable=t?.unrepresentable??"throw",this.override=t?.override??(()=>{}),this.io=t?.io??"output",this.seen=new Map}process(t,r={path:[],schemaPath:[]}){var n;const a=t._zod.def,i={guid:"uuid",url:"uri",datetime:"date-time",json_string:"json-string",regex:""},s=this.seen.get(t);if(s)return s.count++,r.schemaPath.includes(t)&&(s.cycle=r.path),s.schema;const o={schema:{},count:1,cycle:void 0,path:r.path};this.seen.set(t,o);const c=t._zod.toJSONSchema?.();if(c)o.schema=c;else{const h={...r,schemaPath:[...r.schemaPath,t],path:r.path},p=t._zod.parent;if(p)o.ref=p,this.process(p,h),this.seen.get(p).isParent=!0;else{const y=o.schema;switch(a.type){case"string":{const g=y;g.type="string";const{minimum:w,maximum:b,format:x,patterns:O,contentEncoding:T}=t._zod.bag;if(typeof w=="number"&&(g.minLength=w),typeof b=="number"&&(g.maxLength=b),x&&(g.format=i[x]??x,g.format===""&&delete g.format),T&&(g.contentEncoding=T),O&&O.size>0){const B=[...O];B.length===1?g.pattern=B[0].source:B.length>1&&(o.schema.allOf=[...B.map(U=>({...this.target==="draft-7"||this.target==="draft-4"||this.target==="openapi-3.0"?{type:"string"}:{},pattern:U.source}))])}break}case"number":{const g=y,{minimum:w,maximum:b,format:x,multipleOf:O,exclusiveMaximum:T,exclusiveMinimum:B}=t._zod.bag;typeof x=="string"&&x.includes("int")?g.type="integer":g.type="number",typeof B=="number"&&(this.target==="draft-4"||this.target==="openapi-3.0"?(g.minimum=B,g.exclusiveMinimum=!0):g.exclusiveMinimum=B),typeof w=="number"&&(g.minimum=w,typeof B=="number"&&this.target!=="draft-4"&&(B>=w?delete g.minimum:delete g.exclusiveMinimum)),typeof T=="number"&&(this.target==="draft-4"||this.target==="openapi-3.0"?(g.maximum=T,g.exclusiveMaximum=!0):g.exclusiveMaximum=T),typeof b=="number"&&(g.maximum=b,typeof T=="number"&&this.target!=="draft-4"&&(T<=b?delete g.maximum:delete g.exclusiveMaximum)),typeof O=="number"&&(g.multipleOf=O);break}case"boolean":{const g=y;g.type="boolean";break}case"bigint":{if(this.unrepresentable==="throw")throw new Error("BigInt cannot be represented in JSON Schema");break}case"symbol":{if(this.unrepresentable==="throw")throw new Error("Symbols cannot be represented in JSON Schema");break}case"null":{this.target==="openapi-3.0"?(y.type="string",y.nullable=!0,y.enum=[null]):y.type="null";break}case"any":break;case"unknown":break;case"undefined":{if(this.unrepresentable==="throw")throw new Error("Undefined cannot be represented in JSON Schema");break}case"void":{if(this.unrepresentable==="throw")throw new Error("Void cannot be represented in JSON Schema");break}case"never":{y.not={};break}case"date":{if(this.unrepresentable==="throw")throw new Error("Date cannot be represented in JSON Schema");break}case"array":{const g=y,{minimum:w,maximum:b}=t._zod.bag;typeof w=="number"&&(g.minItems=w),typeof b=="number"&&(g.maxItems=b),g.type="array",g.items=this.process(a.element,{...h,path:[...h.path,"items"]});break}case"object":{const g=y;g.type="object",g.properties={};const w=a.shape;for(const O in w)g.properties[O]=this.process(w[O],{...h,path:[...h.path,"properties",O]});const b=new Set(Object.keys(w)),x=new Set([...b].filter(O=>{const T=a.shape[O]._zod;return this.io==="input"?T.optin===void 0:T.optout===void 0}));x.size>0&&(g.required=Array.from(x)),a.catchall?._zod.def.type==="never"?g.additionalProperties=!1:a.catchall?a.catchall&&(g.additionalProperties=this.process(a.catchall,{...h,path:[...h.path,"additionalProperties"]})):this.io==="output"&&(g.additionalProperties=!1);break}case"union":{const g=y,w=a.options.map((b,x)=>this.process(b,{...h,path:[...h.path,"anyOf",x]}));g.anyOf=w;break}case"intersection":{const g=y,w=this.process(a.left,{...h,path:[...h.path,"allOf",0]}),b=this.process(a.right,{...h,path:[...h.path,"allOf",1]}),x=T=>"allOf"in T&&Object.keys(T).length===1,O=[...x(w)?w.allOf:[w],...x(b)?b.allOf:[b]];g.allOf=O;break}case"tuple":{const g=y;g.type="array";const w=this.target==="draft-2020-12"?"prefixItems":"items",b=this.target==="draft-2020-12"||this.target==="openapi-3.0"?"items":"additionalItems",x=a.items.map((U,K)=>this.process(U,{...h,path:[...h.path,w,K]})),O=a.rest?this.process(a.rest,{...h,path:[...h.path,b,...this.target==="openapi-3.0"?[a.items.length]:[]]}):null;this.target==="draft-2020-12"?(g.prefixItems=x,O&&(g.items=O)):this.target==="openapi-3.0"?(g.items={anyOf:x},O&&g.items.anyOf.push(O),g.minItems=x.length,O||(g.maxItems=x.length)):(g.items=x,O&&(g.additionalItems=O));const{minimum:T,maximum:B}=t._zod.bag;typeof T=="number"&&(g.minItems=T),typeof B=="number"&&(g.maxItems=B);break}case"record":{const g=y;g.type="object",(this.target==="draft-7"||this.target==="draft-2020-12")&&(g.propertyNames=this.process(a.keyType,{...h,path:[...h.path,"propertyNames"]})),g.additionalProperties=this.process(a.valueType,{...h,path:[...h.path,"additionalProperties"]});break}case"map":{if(this.unrepresentable==="throw")throw new Error("Map cannot be represented in JSON Schema");break}case"set":{if(this.unrepresentable==="throw")throw new Error("Set cannot be represented in JSON Schema");break}case"enum":{const g=y,w=gC(a.entries);w.every(b=>typeof b=="number")&&(g.type="number"),w.every(b=>typeof b=="string")&&(g.type="string"),g.enum=w;break}case"literal":{const g=y,w=[];for(const b of a.values)if(b===void 0){if(this.unrepresentable==="throw")throw new Error("Literal `undefined` cannot be represented in JSON Schema")}else if(typeof b=="bigint"){if(this.unrepresentable==="throw")throw new Error("BigInt literals cannot be represented in JSON Schema");w.push(Number(b))}else w.push(b);if(w.length!==0)if(w.length===1){const b=w[0];g.type=b===null?"null":typeof b,this.target==="draft-4"||this.target==="openapi-3.0"?g.enum=[b]:g.const=b}else w.every(b=>typeof b=="number")&&(g.type="number"),w.every(b=>typeof b=="string")&&(g.type="string"),w.every(b=>typeof b=="boolean")&&(g.type="string"),w.every(b=>b===null)&&(g.type="null"),g.enum=w;break}case"file":{const g=y,w={type:"string",format:"binary",contentEncoding:"binary"},{minimum:b,maximum:x,mime:O}=t._zod.bag;b!==void 0&&(w.minLength=b),x!==void 0&&(w.maxLength=x),O?O.length===1?(w.contentMediaType=O[0],Object.assign(g,w)):g.anyOf=O.map(T=>({...w,contentMediaType:T})):Object.assign(g,w);break}case"transform":{if(this.unrepresentable==="throw")throw new Error("Transforms cannot be represented in JSON Schema");break}case"nullable":{const g=this.process(a.innerType,h);this.target==="openapi-3.0"?(o.ref=a.innerType,y.nullable=!0):y.anyOf=[g,{type:"null"}];break}case"nonoptional":{this.process(a.innerType,h),o.ref=a.innerType;break}case"success":{const g=y;g.type="boolean";break}case"default":{this.process(a.innerType,h),o.ref=a.innerType,y.default=JSON.parse(JSON.stringify(a.defaultValue));break}case"prefault":{this.process(a.innerType,h),o.ref=a.innerType,this.io==="input"&&(y._prefault=JSON.parse(JSON.stringify(a.defaultValue)));break}case"catch":{this.process(a.innerType,h),o.ref=a.innerType;let g;try{g=a.catchValue(void 0)}catch{throw new Error("Dynamic catch values are not supported in JSON Schema")}y.default=g;break}case"nan":{if(this.unrepresentable==="throw")throw new Error("NaN cannot be represented in JSON Schema");break}case"template_literal":{const g=y,w=t._zod.pattern;if(!w)throw new Error("Pattern not found in template literal");g.type="string",g.pattern=w.source;break}case"pipe":{const g=this.io==="input"?a.in._zod.def.type==="transform"?a.out:a.in:a.out;this.process(g,h),o.ref=g;break}case"readonly":{this.process(a.innerType,h),o.ref=a.innerType,y.readOnly=!0;break}case"promise":{this.process(a.innerType,h),o.ref=a.innerType;break}case"optional":{this.process(a.innerType,h),o.ref=a.innerType;break}case"lazy":{const g=t._zod.innerType;this.process(g,h),o.ref=g;break}case"custom":{if(this.unrepresentable==="throw")throw new Error("Custom types cannot be represented in JSON Schema");break}case"function":{if(this.unrepresentable==="throw")throw new Error("Function types cannot be represented in JSON Schema");break}}}}const u=this.metadataRegistry.get(t);return u&&Object.assign(o.schema,u),this.io==="input"&&wt(t)&&(delete o.schema.examples,delete o.schema.default),this.io==="input"&&o.schema._prefault&&((n=o.schema).default??(n.default=o.schema._prefault)),delete o.schema._prefault,this.seen.get(t).schema}emit(t,r){const n={cycles:r?.cycles??"ref",reused:r?.reused??"inline",external:r?.external??void 0},a=this.seen.get(t);if(!a)throw new Error("Unprocessed schema. This is a bug in Zod.");const i=d=>{const h=this.target==="draft-2020-12"?"$defs":"definitions";if(n.external){const w=n.external.registry.get(d[0])?.id,b=n.external.uri??(O=>O);if(w)return{ref:b(w)};const x=d[1].defId??d[1].schema.id??`schema${this.counter++}`;return d[1].defId=x,{defId:x,ref:`${b("__shared")}#/${h}/${x}`}}if(d[1]===a)return{ref:"#"};const y=`#/${h}/`,g=d[1].schema.id??`__schema${this.counter++}`;return{defId:g,ref:y+g}},s=d=>{if(d[1].schema.$ref)return;const h=d[1],{ref:p,defId:y}=i(d);h.def={...h.schema},y&&(h.defId=y);const g=h.schema;for(const w in g)delete g[w];g.$ref=p};if(n.cycles==="throw")for(const d of this.seen.entries()){const h=d[1];if(h.cycle)throw new Error(`Cycle detected: #/${h.cycle?.join("/")}/<root>

Set the \`cycles\` parameter to \`"ref"\` to resolve cyclical schemas with defs.`)}for(const d of this.seen.entries()){const h=d[1];if(t===d[0]){s(d);continue}if(n.external){const y=n.external.registry.get(d[0])?.id;if(t!==d[0]&&y){s(d);continue}}if(this.metadataRegistry.get(d[0])?.id){s(d);continue}if(h.cycle){s(d);continue}if(h.count>1&&n.reused==="ref"){s(d);continue}}const o=(d,h)=>{const p=this.seen.get(d),y=p.def??p.schema,g={...y};if(p.ref===null)return;const w=p.ref;if(p.ref=null,w){o(w,h);const b=this.seen.get(w).schema;b.$ref&&(h.target==="draft-7"||h.target==="draft-4"||h.target==="openapi-3.0")?(y.allOf=y.allOf??[],y.allOf.push(b)):(Object.assign(y,b),Object.assign(y,g))}p.isParent||this.override({zodSchema:d,jsonSchema:y,path:p.path??[]})};for(const d of[...this.seen.entries()].reverse())o(d[0],{target:this.target});const c={};if(this.target==="draft-2020-12"?c.$schema="https://json-schema.org/draft/2020-12/schema":this.target==="draft-7"?c.$schema="http://json-schema.org/draft-07/schema#":this.target==="draft-4"?c.$schema="http://json-schema.org/draft-04/schema#":this.target==="openapi-3.0"||console.warn(`Invalid target: ${this.target}`),n.external?.uri){const d=n.external.registry.get(t)?.id;if(!d)throw new Error("Schema is missing an `id` property");c.$id=n.external.uri(d)}Object.assign(c,a.def);const u=n.external?.defs??{};for(const d of this.seen.entries()){const h=d[1];h.def&&h.defId&&(u[h.defId]=h.def)}n.external||Object.keys(u).length>0&&(this.target==="draft-2020-12"?c.$defs=u:c.definitions=u);try{return JSON.parse(JSON.stringify(c))}catch{throw new Error("Error converting schema to JSON.")}}}function Eg(e,t){if(e instanceof uw){const n=new bg(t),a={};for(const o of e._idmap.entries()){const[c,u]=o;n.process(u)}const i={},s={registry:e,uri:t?.uri,defs:a};for(const o of e._idmap.entries()){const[c,u]=o;i[c]=n.emit(u,{...t,external:s})}if(Object.keys(a).length>0){const o=n.target==="draft-2020-12"?"$defs":"definitions";i.__shared={[o]:a}}return{schemas:i}}const r=new bg(t);return r.process(e),r.emit(e,t)}function wt(e,t){const r=t??{seen:new Set};if(r.seen.has(e))return!1;r.seen.add(e);const a=e._zod.def;switch(a.type){case"string":case"number":case"bigint":case"boolean":case"date":case"symbol":case"undefined":case"null":case"any":case"unknown":case"never":case"void":case"literal":case"enum":case"nan":case"file":case"template_literal":return!1;case"array":return wt(a.element,r);case"object":{for(const i in a.shape)if(wt(a.shape[i],r))return!0;return!1}case"union":{for(const i of a.options)if(wt(i,r))return!0;return!1}case"intersection":return wt(a.left,r)||wt(a.right,r);case"tuple":{for(const i of a.items)if(wt(i,r))return!0;return!!(a.rest&&wt(a.rest,r))}case"record":return wt(a.keyType,r)||wt(a.valueType,r);case"map":return wt(a.keyType,r)||wt(a.valueType,r);case"set":return wt(a.valueType,r);case"promise":case"optional":case"nonoptional":case"nullable":case"readonly":return wt(a.innerType,r);case"lazy":return wt(a.getter(),r);case"default":return wt(a.innerType,r);case"prefault":return wt(a.innerType,r);case"custom":return!1;case"transform":return!0;case"pipe":return wt(a.in,r)||wt(a.out,r);case"success":return!1;case"catch":return!1;case"function":return!1}throw new Error(`Unknown schema type: ${a.type}`)}function mn(e){if(typeof e!="object"||e===null)return!1;const t=e;if(!("_zod"in t))return!1;const r=t._zod;return typeof r=="object"&&r!==null&&"def"in r}function Un(e){if(typeof e!="object"||e===null)return!1;const t=e;if(!("_def"in t)||"_zod"in t)return!1;const r=t._def;return typeof r=="object"&&r!=null&&"typeName"in r}function CC(e){return!e||typeof e!="object"||Array.isArray(e)?!1:!!(mn(e)||Un(e))}async function PC(e,t){if(mn(e))return await EC(e,t);if(Un(e))return await e.parseAsync(t);throw new Error("Schema must be an instance of z3.ZodType or z4.$ZodType")}function NC(e){if(mn(e))return Tn.get(e)?.description;if(Un(e)||"description"in e&&typeof e.description=="string")return e.description}function DC(e){return CC(e)?Un(e)?e._def.typeName==="ZodString":mn(e)?e._zod.def.type==="string":!1:!1}function Yi(e){return mn(e)?typeof e=="object"&&e!==null&&"_zod"in e&&typeof e._zod=="object"&&e._zod!==null&&"def"in e._zod&&typeof e._zod.def=="object"&&e._zod.def!==null&&"type"in e._zod.def&&e._zod.def.type==="object":!1}function lw(e){return mn(e)?typeof e=="object"&&e!==null&&"_zod"in e&&typeof e._zod=="object"&&e._zod!==null&&"def"in e._zod&&typeof e._zod.def=="object"&&e._zod.def!==null&&"type"in e._zod.def&&e._zod.def.type==="array":!1}function jd(e,t=!1){if(Un(e))return e.strict();if(Yi(e)){const r=e._zod.def.shape;if(t)for(const[i,s]of Object.entries(e._zod.def.shape)){if(Yi(s)){const c=jd(s,t);r[i]=c}else if(lw(s)){let c=s._zod.def.element;Yi(c)&&(c=jd(c,t)),r[i]=uc(s,{...s._zod.def,element:c})}else r[i]=s;const o=Tn.get(s);o&&Tn.add(r[i],o)}const n=uc(e,{...e._zod.def,shape:r,catchall:AC(RC)}),a=Tn.get(e);return a&&Tn.add(n,a),n}throw new Error("Schema must be an instance of z3.ZodObject or z4.$ZodObject")}function LC(e){return Un(e)&&"typeName"in e._def&&e._def.typeName==="ZodEffects"}function MC(e){return mn(e)&&e._zod.def.type==="pipe"}function zi(e,t=!1){if(Un(e))return LC(e)?zi(e._def.schema,t):e;if(mn(e)){let r=e;if(MC(e)&&(r=zi(e._zod.def.in,t)),t){if(Yi(r)){const a=r._zod.def.shape;for(const[i,s]of Object.entries(r._zod.def.shape))a[i]=zi(s,t);r=uc(r,{...r._zod.def,shape:a})}else if(lw(r)){const a=zi(r._zod.def.element,t);r=uc(r,{...r._zod.def,element:a})}}const n=Tn.get(e);return n&&Tn.add(r,n),r}throw new Error("Schema must be an instance of z3.ZodType or z4.$ZodType")}function Zl(e){return e.replace(/[^a-zA-Z-_0-9]/g,"_")}const jC=["*","_","`"];function FC(e){let t="";for(const[r,n]of Object.entries(e))t+=`	classDef ${r} ${n};
`;return t}function BC(e,t,r){const{firstNode:n,lastNode:a,nodeColors:i,withStyles:s=!0,curveStyle:o="linear",wrapLabelNWords:c=9}=r??{};let u=s?`%%{init: {'flowchart': {'curve': '${o}'}}}%%
graph TD;
`:`graph TD;
`;if(s){const y="default",g={[y]:"{0}({1})"};n!==void 0&&(g[n]="{0}([{1}]):::first"),a!==void 0&&(g[a]="{0}([{1}]):::last");for(const[w,b]of Object.entries(e)){const x=b.name.split(":").pop()??"";let T=jC.some(U=>x.startsWith(U)&&x.endsWith(U))?`<p>${x}</p>`:x;Object.keys(b.metadata??{}).length&&(T+=`<hr/><small><em>${Object.entries(b.metadata??{}).map(([U,K])=>`${U} = ${K}`).join(`
`)}</em></small>`);const B=(g[w]??g[y]).replace("{0}",Zl(w)).replace("{1}",T);u+=`	${B}
`}}const d={};for(const y of t){const g=y.source.split(":"),w=y.target.split(":"),b=g.filter((x,O)=>x===w[O]).join(":");d[b]||(d[b]=[]),d[b].push(y)}const h=new Set;function p(y,g){const w=y.length===1&&y[0].source===y[0].target;if(g&&!w){const b=g.split(":").pop();if(h.has(b))throw new Error(`Found duplicate subgraph '${b}' -- this likely means that you're reusing a subgraph node with the same name. Please adjust your graph to have subgraph nodes with unique names.`);h.add(b),u+=`	subgraph ${b}
`}for(const b of y){const{source:x,target:O,data:T,conditional:B}=b;let U="";if(T!==void 0){let K=T;const q=K.split(" ");q.length>c&&(K=Array.from({length:Math.ceil(q.length/c)},(G,Oe)=>q.slice(Oe*c,(Oe+1)*c).join(" ")).join("&nbsp;<br>&nbsp;")),U=B?` -. &nbsp;${K}&nbsp; .-> `:` -- &nbsp;${K}&nbsp; --> `}else U=B?" -.-> ":" --> ";u+=`	${Zl(x)}${U}${Zl(O)};
`}for(const b in d)b.startsWith(`${g}:`)&&b!==g&&p(d[b],b);g&&!w&&(u+=`	end
`)}p(d[""]??[],"");for(const y in d)!y.includes(":")&&y!==""&&p(d[y],y);return s&&(u+=FC(i??{})),u}async function UC(e,t){let r=t?.backgroundColor??"white";const n=t?.imageType??"png",a=btoa(e);r!==void 0&&(/^#(?:[0-9a-fA-F]{3}){1,2}$/.test(r)||(r=`!${r}`));const i=`https://mermaid.ink/img/${a}?bgColor=${r}&type=${n}`,s=await fetch(i);if(!s.ok)throw new Error(["Failed to render the graph using the Mermaid.INK API.",`Status code: ${s.status}`,`Status text: ${s.statusText}`].join(`
`));return await s.blob()}const zC=Symbol("Let zodToJsonSchema decide on which parser to use"),qC={name:void 0,$refStrategy:"root",basePath:["#"],effectStrategy:"input",pipeStrategy:"all",dateStrategy:"format:date-time",mapStrategy:"entries",removeAdditionalStrategy:"passthrough",allowedAdditionalProperties:!0,rejectedAdditionalProperties:!1,definitionPath:"definitions",target:"jsonSchema7",strictUnions:!1,definitions:{},errorMessages:!1,markdownDescription:!1,patternStrategy:"escape",applyRegexFlags:!1,emailStrategy:"format:email",base64Strategy:"contentEncoding:base64",nameStrategy:"ref",openAiAnyTypeName:"OpenAiAnyType"},HC=e=>({...qC,...e}),KC=e=>{const t=HC(e),r=t.name!==void 0?[...t.basePath,t.definitionPath,t.name]:t.basePath;return{...t,flags:{hasReferencedOpenAiAnyType:!1},currentPath:r,propertyPath:void 0,seen:new Map(Object.entries(t.definitions).map(([n,a])=>[a._def,{def:a._def,path:[...t.basePath,t.definitionPath,n],jsonSchema:void 0}]))}},dw=(e,t)=>{let r=0;for(;r<e.length&&r<t.length&&e[r]===t[r];r++);return[(e.length-r).toString(),...t.slice(r)].join("/")};function Vt(e){if(e.target!=="openAi")return{};const t=[...e.basePath,e.definitionPath,e.openAiAnyTypeName];return e.flags.hasReferencedOpenAiAnyType=!0,{$ref:e.$refStrategy==="relative"?dw(t,e.currentPath):t.join("/")}}function fw(e,t,r,n){n?.errorMessages&&r&&(e.errorMessage={...e.errorMessage,[t]:r})}function Ye(e,t,r,n,a){e[t]=r,fw(e,t,n,a)}var Je;(function(e){e.assertEqual=a=>{};function t(a){}e.assertIs=t;function r(a){throw new Error}e.assertNever=r,e.arrayToEnum=a=>{const i={};for(const s of a)i[s]=s;return i},e.getValidEnumValues=a=>{const i=e.objectKeys(a).filter(o=>typeof a[a[o]]!="number"),s={};for(const o of i)s[o]=a[o];return e.objectValues(s)},e.objectValues=a=>e.objectKeys(a).map(function(i){return a[i]}),e.objectKeys=typeof Object.keys=="function"?a=>Object.keys(a):a=>{const i=[];for(const s in a)Object.prototype.hasOwnProperty.call(a,s)&&i.push(s);return i},e.find=(a,i)=>{for(const s of a)if(i(s))return s},e.isInteger=typeof Number.isInteger=="function"?a=>Number.isInteger(a):a=>typeof a=="number"&&Number.isFinite(a)&&Math.floor(a)===a;function n(a,i=" | "){return a.map(s=>typeof s=="string"?`'${s}'`:s).join(i)}e.joinValues=n,e.jsonStringifyReplacer=(a,i)=>typeof i=="bigint"?i.toString():i})(Je||(Je={}));var xg;(function(e){e.mergeShapes=(t,r)=>({...t,...r})})(xg||(xg={}));const pe=Je.arrayToEnum(["string","nan","number","integer","float","boolean","date","bigint","symbol","function","undefined","null","array","object","unknown","promise","void","never","map","set"]),On=e=>{switch(typeof e){case"undefined":return pe.undefined;case"string":return pe.string;case"number":return Number.isNaN(e)?pe.nan:pe.number;case"boolean":return pe.boolean;case"function":return pe.function;case"bigint":return pe.bigint;case"symbol":return pe.symbol;case"object":return Array.isArray(e)?pe.array:e===null?pe.null:e.then&&typeof e.then=="function"&&e.catch&&typeof e.catch=="function"?pe.promise:typeof Map<"u"&&e instanceof Map?pe.map:typeof Set<"u"&&e instanceof Set?pe.set:typeof Date<"u"&&e instanceof Date?pe.date:pe.object;default:return pe.unknown}},Z=Je.arrayToEnum(["invalid_type","invalid_literal","custom","invalid_union","invalid_union_discriminator","invalid_enum_value","unrecognized_keys","invalid_arguments","invalid_return_type","invalid_date","invalid_string","too_small","too_big","invalid_intersection_types","not_multiple_of","not_finite"]);class hn extends Error{get errors(){return this.issues}constructor(t){super(),this.issues=[],this.addIssue=n=>{this.issues=[...this.issues,n]},this.addIssues=(n=[])=>{this.issues=[...this.issues,...n]};const r=new.target.prototype;Object.setPrototypeOf?Object.setPrototypeOf(this,r):this.__proto__=r,this.name="ZodError",this.issues=t}format(t){const r=t||function(i){return i.message},n={_errors:[]},a=i=>{for(const s of i.issues)if(s.code==="invalid_union")s.unionErrors.map(a);else if(s.code==="invalid_return_type")a(s.returnTypeError);else if(s.code==="invalid_arguments")a(s.argumentsError);else if(s.path.length===0)n._errors.push(r(s));else{let o=n,c=0;for(;c<s.path.length;){const u=s.path[c];c===s.path.length-1?(o[u]=o[u]||{_errors:[]},o[u]._errors.push(r(s))):o[u]=o[u]||{_errors:[]},o=o[u],c++}}};return a(this),n}static assert(t){if(!(t instanceof hn))throw new Error(`Not a ZodError: ${t}`)}toString(){return this.message}get message(){return JSON.stringify(this.issues,Je.jsonStringifyReplacer,2)}get isEmpty(){return this.issues.length===0}flatten(t=r=>r.message){const r=Object.create(null),n=[];for(const a of this.issues)if(a.path.length>0){const i=a.path[0];r[i]=r[i]||[],r[i].push(t(a))}else n.push(t(a));return{formErrors:n,fieldErrors:r}}get formErrors(){return this.flatten()}}hn.create=e=>new hn(e);const Fd=(e,t)=>{let r;switch(e.code){case Z.invalid_type:e.received===pe.undefined?r="Required":r=`Expected ${e.expected}, received ${e.received}`;break;case Z.invalid_literal:r=`Invalid literal value, expected ${JSON.stringify(e.expected,Je.jsonStringifyReplacer)}`;break;case Z.unrecognized_keys:r=`Unrecognized key(s) in object: ${Je.joinValues(e.keys,", ")}`;break;case Z.invalid_union:r="Invalid input";break;case Z.invalid_union_discriminator:r=`Invalid discriminator value. Expected ${Je.joinValues(e.options)}`;break;case Z.invalid_enum_value:r=`Invalid enum value. Expected ${Je.joinValues(e.options)}, received '${e.received}'`;break;case Z.invalid_arguments:r="Invalid function arguments";break;case Z.invalid_return_type:r="Invalid function return type";break;case Z.invalid_date:r="Invalid date";break;case Z.invalid_string:typeof e.validation=="object"?"includes"in e.validation?(r=`Invalid input: must include "${e.validation.includes}"`,typeof e.validation.position=="number"&&(r=`${r} at one or more positions greater than or equal to ${e.validation.position}`)):"startsWith"in e.validation?r=`Invalid input: must start with "${e.validation.startsWith}"`:"endsWith"in e.validation?r=`Invalid input: must end with "${e.validation.endsWith}"`:Je.assertNever(e.validation):e.validation!=="regex"?r=`Invalid ${e.validation}`:r="Invalid";break;case Z.too_small:e.type==="array"?r=`Array must contain ${e.exact?"exactly":e.inclusive?"at least":"more than"} ${e.minimum} element(s)`:e.type==="string"?r=`String must contain ${e.exact?"exactly":e.inclusive?"at least":"over"} ${e.minimum} character(s)`:e.type==="number"?r=`Number must be ${e.exact?"exactly equal to ":e.inclusive?"greater than or equal to ":"greater than "}${e.minimum}`:e.type==="bigint"?r=`Number must be ${e.exact?"exactly equal to ":e.inclusive?"greater than or equal to ":"greater than "}${e.minimum}`:e.type==="date"?r=`Date must be ${e.exact?"exactly equal to ":e.inclusive?"greater than or equal to ":"greater than "}${new Date(Number(e.minimum))}`:r="Invalid input";break;case Z.too_big:e.type==="array"?r=`Array must contain ${e.exact?"exactly":e.inclusive?"at most":"less than"} ${e.maximum} element(s)`:e.type==="string"?r=`String must contain ${e.exact?"exactly":e.inclusive?"at most":"under"} ${e.maximum} character(s)`:e.type==="number"?r=`Number must be ${e.exact?"exactly":e.inclusive?"less than or equal to":"less than"} ${e.maximum}`:e.type==="bigint"?r=`BigInt must be ${e.exact?"exactly":e.inclusive?"less than or equal to":"less than"} ${e.maximum}`:e.type==="date"?r=`Date must be ${e.exact?"exactly":e.inclusive?"smaller than or equal to":"smaller than"} ${new Date(Number(e.maximum))}`:r="Invalid input";break;case Z.custom:r="Invalid input";break;case Z.invalid_intersection_types:r="Intersection results could not be merged";break;case Z.not_multiple_of:r=`Number must be a multiple of ${e.multipleOf}`;break;case Z.not_finite:r="Number must be finite";break;default:r=t.defaultError,Je.assertNever(e)}return{message:r}};let GC=Fd;function WC(){return GC}const VC=e=>{const{data:t,path:r,errorMaps:n,issueData:a}=e,i=[...r,...a.path||[]],s={...a,path:i};if(a.message!==void 0)return{...a,path:i,message:a.message};let o="";const c=n.filter(u=>!!u).slice().reverse();for(const u of c)o=u(s,{data:t,defaultError:o}).message;return{...a,path:i,message:o}};function le(e,t){const r=WC(),n=VC({issueData:t,data:e.data,path:e.path,errorMaps:[e.common.contextualErrorMap,e.schemaErrorMap,r,r===Fd?void 0:Fd].filter(a=>!!a)});e.common.issues.push(n)}class or{constructor(){this.value="valid"}dirty(){this.value==="valid"&&(this.value="dirty")}abort(){this.value!=="aborted"&&(this.value="aborted")}static mergeArray(t,r){const n=[];for(const a of r){if(a.status==="aborted")return Pe;a.status==="dirty"&&t.dirty(),n.push(a.value)}return{status:t.value,value:n}}static async mergeObjectAsync(t,r){const n=[];for(const a of r){const i=await a.key,s=await a.value;n.push({key:i,value:s})}return or.mergeObjectSync(t,n)}static mergeObjectSync(t,r){const n={};for(const a of r){const{key:i,value:s}=a;if(i.status==="aborted"||s.status==="aborted")return Pe;i.status==="dirty"&&t.dirty(),s.status==="dirty"&&t.dirty(),i.value!=="__proto__"&&(typeof s.value<"u"||a.alwaysSet)&&(n[i.value]=s.value)}return{status:t.value,value:n}}}const Pe=Object.freeze({status:"aborted"}),qi=e=>({status:"dirty",value:e}),_r=e=>({status:"valid",value:e}),Sg=e=>e.status==="aborted",kg=e=>e.status==="dirty",ci=e=>e.status==="valid",lc=e=>typeof Promise<"u"&&e instanceof Promise;var ge;(function(e){e.errToObj=t=>typeof t=="string"?{message:t}:t||{},e.toString=t=>typeof t=="string"?t:t?.message})(ge||(ge={}));class jn{constructor(t,r,n,a){this._cachedPath=[],this.parent=t,this.data=r,this._path=n,this._key=a}get path(){return this._cachedPath.length||(Array.isArray(this._key)?this._cachedPath.push(...this._path,...this._key):this._cachedPath.push(...this._path,this._key)),this._cachedPath}}const Ig=(e,t)=>{if(ci(t))return{success:!0,data:t.value};if(!e.common.issues.length)throw new Error("Validation failed but no issues detected.");return{success:!1,get error(){if(this._error)return this._error;const r=new hn(e.common.issues);return this._error=r,this._error}}};function ze(e){if(!e)return{};const{errorMap:t,invalid_type_error:r,required_error:n,description:a}=e;if(t&&(r||n))throw new Error(`Can't use "invalid_type_error" or "required_error" in conjunction with custom error map.`);return t?{errorMap:t,description:a}:{errorMap:(s,o)=>{const{message:c}=e;return s.code==="invalid_enum_value"?{message:c??o.defaultError}:typeof o.data>"u"?{message:c??n??o.defaultError}:s.code!=="invalid_type"?{message:o.defaultError}:{message:c??r??o.defaultError}},description:a}}class We{get description(){return this._def.description}_getType(t){return On(t.data)}_getOrReturnCtx(t,r){return r||{common:t.parent.common,data:t.data,parsedType:On(t.data),schemaErrorMap:this._def.errorMap,path:t.path,parent:t.parent}}_processInputParams(t){return{status:new or,ctx:{common:t.parent.common,data:t.data,parsedType:On(t.data),schemaErrorMap:this._def.errorMap,path:t.path,parent:t.parent}}}_parseSync(t){const r=this._parse(t);if(lc(r))throw new Error("Synchronous parse encountered promise.");return r}_parseAsync(t){const r=this._parse(t);return Promise.resolve(r)}parse(t,r){const n=this.safeParse(t,r);if(n.success)return n.data;throw n.error}safeParse(t,r){const n={common:{issues:[],async:r?.async??!1,contextualErrorMap:r?.errorMap},path:r?.path||[],schemaErrorMap:this._def.errorMap,parent:null,data:t,parsedType:On(t)},a=this._parseSync({data:t,path:n.path,parent:n});return Ig(n,a)}"~validate"(t){const r={common:{issues:[],async:!!this["~standard"].async},path:[],schemaErrorMap:this._def.errorMap,parent:null,data:t,parsedType:On(t)};if(!this["~standard"].async)try{const n=this._parseSync({data:t,path:[],parent:r});return ci(n)?{value:n.value}:{issues:r.common.issues}}catch(n){n?.message?.toLowerCase()?.includes("encountered")&&(this["~standard"].async=!0),r.common={issues:[],async:!0}}return this._parseAsync({data:t,path:[],parent:r}).then(n=>ci(n)?{value:n.value}:{issues:r.common.issues})}async parseAsync(t,r){const n=await this.safeParseAsync(t,r);if(n.success)return n.data;throw n.error}async safeParseAsync(t,r){const n={common:{issues:[],contextualErrorMap:r?.errorMap,async:!0},path:r?.path||[],schemaErrorMap:this._def.errorMap,parent:null,data:t,parsedType:On(t)},a=this._parse({data:t,path:n.path,parent:n}),i=await(lc(a)?a:Promise.resolve(a));return Ig(n,i)}refine(t,r){const n=a=>typeof r=="string"||typeof r>"u"?{message:r}:typeof r=="function"?r(a):r;return this._refinement((a,i)=>{const s=t(a),o=()=>i.addIssue({code:Z.custom,...n(a)});return typeof Promise<"u"&&s instanceof Promise?s.then(c=>c?!0:(o(),!1)):s?!0:(o(),!1)})}refinement(t,r){return this._refinement((n,a)=>t(n)?!0:(a.addIssue(typeof r=="function"?r(n,a):r),!1))}_refinement(t){return new li({schema:this,typeName:ee.ZodEffects,effect:{type:"refinement",refinement:t}})}superRefine(t){return this._refinement(t)}constructor(t){this.spa=this.safeParseAsync,this._def=t,this.parse=this.parse.bind(this),this.safeParse=this.safeParse.bind(this),this.parseAsync=this.parseAsync.bind(this),this.safeParseAsync=this.safeParseAsync.bind(this),this.spa=this.spa.bind(this),this.refine=this.refine.bind(this),this.refinement=this.refinement.bind(this),this.superRefine=this.superRefine.bind(this),this.optional=this.optional.bind(this),this.nullable=this.nullable.bind(this),this.nullish=this.nullish.bind(this),this.array=this.array.bind(this),this.promise=this.promise.bind(this),this.or=this.or.bind(this),this.and=this.and.bind(this),this.transform=this.transform.bind(this),this.brand=this.brand.bind(this),this.default=this.default.bind(this),this.catch=this.catch.bind(this),this.describe=this.describe.bind(this),this.pipe=this.pipe.bind(this),this.readonly=this.readonly.bind(this),this.isNullable=this.isNullable.bind(this),this.isOptional=this.isOptional.bind(this),this["~standard"]={version:1,vendor:"zod",validate:r=>this["~validate"](r)}}optional(){return Pn.create(this,this._def)}nullable(){return di.create(this,this._def)}nullish(){return this.nullable().optional()}array(){return zr.create(this)}promise(){return pc.create(this,this._def)}or(t){return fc.create([this,t],this._def)}and(t){return hc.create(this,t,this._def)}transform(t){return new li({...ze(this._def),schema:this,typeName:ee.ZodEffects,effect:{type:"transform",transform:t}})}default(t){const r=typeof t=="function"?t:()=>t;return new zd({...ze(this._def),innerType:this,defaultValue:r,typeName:ee.ZodDefault})}brand(){return new y1({typeName:ee.ZodBranded,type:this,...ze(this._def)})}catch(t){const r=typeof t=="function"?t:()=>t;return new qd({...ze(this._def),innerType:this,catchValue:r,typeName:ee.ZodCatch})}describe(t){const r=this.constructor;return new r({...this._def,description:t})}pipe(t){return Zf.create(this,t)}readonly(){return Hd.create(this)}isOptional(){return this.safeParse(void 0).success}isNullable(){return this.safeParse(null).success}}const ZC=/^c[^\s-]{8,}$/i,JC=/^[0-9a-z]+$/,QC=/^[0-9A-HJKMNP-TV-Z]{26}$/i,YC=/^[0-9a-fA-F]{8}\b-[0-9a-fA-F]{4}\b-[0-9a-fA-F]{4}\b-[0-9a-fA-F]{4}\b-[0-9a-fA-F]{12}$/i,XC=/^[a-z0-9_-]{21}$/i,e1=/^[A-Za-z0-9-_]+\.[A-Za-z0-9-_]+\.[A-Za-z0-9-_]*$/,t1=/^[-+]?P(?!$)(?:(?:[-+]?\d+Y)|(?:[-+]?\d+[.,]\d+Y$))?(?:(?:[-+]?\d+M)|(?:[-+]?\d+[.,]\d+M$))?(?:(?:[-+]?\d+W)|(?:[-+]?\d+[.,]\d+W$))?(?:(?:[-+]?\d+D)|(?:[-+]?\d+[.,]\d+D$))?(?:T(?=[\d+-])(?:(?:[-+]?\d+H)|(?:[-+]?\d+[.,]\d+H$))?(?:(?:[-+]?\d+M)|(?:[-+]?\d+[.,]\d+M$))?(?:[-+]?\d+(?:[.,]\d+)?S)?)??$/,r1=/^(?!\.)(?!.*\.\.)([A-Z0-9_'+\-\.]*)[A-Z0-9_+-]@([A-Z0-9][A-Z0-9\-]*\.)+[A-Z]{2,}$/i,n1="^(\\p{Extended_Pictographic}|\\p{Emoji_Component})+$";let Jl;const a1=/^(?:(?:25[0-5]|2[0-4][0-9]|1[0-9][0-9]|[1-9][0-9]|[0-9])\.){3}(?:25[0-5]|2[0-4][0-9]|1[0-9][0-9]|[1-9][0-9]|[0-9])$/,i1=/^(?:(?:25[0-5]|2[0-4][0-9]|1[0-9][0-9]|[1-9][0-9]|[0-9])\.){3}(?:25[0-5]|2[0-4][0-9]|1[0-9][0-9]|[1-9][0-9]|[0-9])\/(3[0-2]|[12]?[0-9])$/,s1=/^(([0-9a-fA-F]{1,4}:){7,7}[0-9a-fA-F]{1,4}|([0-9a-fA-F]{1,4}:){1,7}:|([0-9a-fA-F]{1,4}:){1,6}:[0-9a-fA-F]{1,4}|([0-9a-fA-F]{1,4}:){1,5}(:[0-9a-fA-F]{1,4}){1,2}|([0-9a-fA-F]{1,4}:){1,4}(:[0-9a-fA-F]{1,4}){1,3}|([0-9a-fA-F]{1,4}:){1,3}(:[0-9a-fA-F]{1,4}){1,4}|([0-9a-fA-F]{1,4}:){1,2}(:[0-9a-fA-F]{1,4}){1,5}|[0-9a-fA-F]{1,4}:((:[0-9a-fA-F]{1,4}){1,6})|:((:[0-9a-fA-F]{1,4}){1,7}|:)|fe80:(:[0-9a-fA-F]{0,4}){0,4}%[0-9a-zA-Z]{1,}|::(ffff(:0{1,4}){0,1}:){0,1}((25[0-5]|(2[0-4]|1{0,1}[0-9]){0,1}[0-9])\.){3,3}(25[0-5]|(2[0-4]|1{0,1}[0-9]){0,1}[0-9])|([0-9a-fA-F]{1,4}:){1,4}:((25[0-5]|(2[0-4]|1{0,1}[0-9]){0,1}[0-9])\.){3,3}(25[0-5]|(2[0-4]|1{0,1}[0-9]){0,1}[0-9]))$/,o1=/^(([0-9a-fA-F]{1,4}:){7,7}[0-9a-fA-F]{1,4}|([0-9a-fA-F]{1,4}:){1,7}:|([0-9a-fA-F]{1,4}:){1,6}:[0-9a-fA-F]{1,4}|([0-9a-fA-F]{1,4}:){1,5}(:[0-9a-fA-F]{1,4}){1,2}|([0-9a-fA-F]{1,4}:){1,4}(:[0-9a-fA-F]{1,4}){1,3}|([0-9a-fA-F]{1,4}:){1,3}(:[0-9a-fA-F]{1,4}){1,4}|([0-9a-fA-F]{1,4}:){1,2}(:[0-9a-fA-F]{1,4}){1,5}|[0-9a-fA-F]{1,4}:((:[0-9a-fA-F]{1,4}){1,6})|:((:[0-9a-fA-F]{1,4}){1,7}|:)|fe80:(:[0-9a-fA-F]{0,4}){0,4}%[0-9a-zA-Z]{1,}|::(ffff(:0{1,4}){0,1}:){0,1}((25[0-5]|(2[0-4]|1{0,1}[0-9]){0,1}[0-9])\.){3,3}(25[0-5]|(2[0-4]|1{0,1}[0-9]){0,1}[0-9])|([0-9a-fA-F]{1,4}:){1,4}:((25[0-5]|(2[0-4]|1{0,1}[0-9]){0,1}[0-9])\.){3,3}(25[0-5]|(2[0-4]|1{0,1}[0-9]){0,1}[0-9]))\/(12[0-8]|1[01][0-9]|[1-9]?[0-9])$/,c1=/^([0-9a-zA-Z+/]{4})*(([0-9a-zA-Z+/]{2}==)|([0-9a-zA-Z+/]{3}=))?$/,u1=/^([0-9a-zA-Z-_]{4})*(([0-9a-zA-Z-_]{2}(==)?)|([0-9a-zA-Z-_]{3}(=)?))?$/,hw="((\\d\\d[2468][048]|\\d\\d[13579][26]|\\d\\d0[48]|[02468][048]00|[13579][26]00)-02-29|\\d{4}-((0[13578]|1[02])-(0[1-9]|[12]\\d|3[01])|(0[469]|11)-(0[1-9]|[12]\\d|30)|(02)-(0[1-9]|1\\d|2[0-8])))",l1=new RegExp(`^${hw}$`);function pw(e){let t="[0-5]\\d";e.precision?t=`${t}\\.\\d{${e.precision}}`:e.precision==null&&(t=`${t}(\\.\\d+)?`);const r=e.precision?"+":"?";return`([01]\\d|2[0-3]):[0-5]\\d(:${t})${r}`}function d1(e){return new RegExp(`^${pw(e)}$`)}function f1(e){let t=`${hw}T${pw(e)}`;const r=[];return r.push(e.local?"Z?":"Z"),e.offset&&r.push("([+-]\\d{2}:?\\d{2})"),t=`${t}(${r.join("|")})`,new RegExp(`^${t}$`)}function h1(e,t){return!!((t==="v4"||!t)&&a1.test(e)||(t==="v6"||!t)&&s1.test(e))}function p1(e,t){if(!e1.test(e))return!1;try{const[r]=e.split(".");if(!r)return!1;const n=r.replace(/-/g,"+").replace(/_/g,"/").padEnd(r.length+(4-r.length%4)%4,"="),a=JSON.parse(atob(n));return!(typeof a!="object"||a===null||"typ"in a&&a?.typ!=="JWT"||!a.alg||t&&a.alg!==t)}catch{return!1}}function m1(e,t){return!!((t==="v4"||!t)&&i1.test(e)||(t==="v6"||!t)&&o1.test(e))}class Rn extends We{_parse(t){if(this._def.coerce&&(t.data=String(t.data)),this._getType(t)!==pe.string){const i=this._getOrReturnCtx(t);return le(i,{code:Z.invalid_type,expected:pe.string,received:i.parsedType}),Pe}const n=new or;let a;for(const i of this._def.checks)if(i.kind==="min")t.data.length<i.value&&(a=this._getOrReturnCtx(t,a),le(a,{code:Z.too_small,minimum:i.value,type:"string",inclusive:!0,exact:!1,message:i.message}),n.dirty());else if(i.kind==="max")t.data.length>i.value&&(a=this._getOrReturnCtx(t,a),le(a,{code:Z.too_big,maximum:i.value,type:"string",inclusive:!0,exact:!1,message:i.message}),n.dirty());else if(i.kind==="length"){const s=t.data.length>i.value,o=t.data.length<i.value;(s||o)&&(a=this._getOrReturnCtx(t,a),s?le(a,{code:Z.too_big,maximum:i.value,type:"string",inclusive:!0,exact:!0,message:i.message}):o&&le(a,{code:Z.too_small,minimum:i.value,type:"string",inclusive:!0,exact:!0,message:i.message}),n.dirty())}else if(i.kind==="email")r1.test(t.data)||(a=this._getOrReturnCtx(t,a),le(a,{validation:"email",code:Z.invalid_string,message:i.message}),n.dirty());else if(i.kind==="emoji")Jl||(Jl=new RegExp(n1,"u")),Jl.test(t.data)||(a=this._getOrReturnCtx(t,a),le(a,{validation:"emoji",code:Z.invalid_string,message:i.message}),n.dirty());else if(i.kind==="uuid")YC.test(t.data)||(a=this._getOrReturnCtx(t,a),le(a,{validation:"uuid",code:Z.invalid_string,message:i.message}),n.dirty());else if(i.kind==="nanoid")XC.test(t.data)||(a=this._getOrReturnCtx(t,a),le(a,{validation:"nanoid",code:Z.invalid_string,message:i.message}),n.dirty());else if(i.kind==="cuid")ZC.test(t.data)||(a=this._getOrReturnCtx(t,a),le(a,{validation:"cuid",code:Z.invalid_string,message:i.message}),n.dirty());else if(i.kind==="cuid2")JC.test(t.data)||(a=this._getOrReturnCtx(t,a),le(a,{validation:"cuid2",code:Z.invalid_string,message:i.message}),n.dirty());else if(i.kind==="ulid")QC.test(t.data)||(a=this._getOrReturnCtx(t,a),le(a,{validation:"ulid",code:Z.invalid_string,message:i.message}),n.dirty());else if(i.kind==="url")try{new URL(t.data)}catch{a=this._getOrReturnCtx(t,a),le(a,{validation:"url",code:Z.invalid_string,message:i.message}),n.dirty()}else i.kind==="regex"?(i.regex.lastIndex=0,i.regex.test(t.data)||(a=this._getOrReturnCtx(t,a),le(a,{validation:"regex",code:Z.invalid_string,message:i.message}),n.dirty())):i.kind==="trim"?t.data=t.data.trim():i.kind==="includes"?t.data.includes(i.value,i.position)||(a=this._getOrReturnCtx(t,a),le(a,{code:Z.invalid_string,validation:{includes:i.value,position:i.position},message:i.message}),n.dirty()):i.kind==="toLowerCase"?t.data=t.data.toLowerCase():i.kind==="toUpperCase"?t.data=t.data.toUpperCase():i.kind==="startsWith"?t.data.startsWith(i.value)||(a=this._getOrReturnCtx(t,a),le(a,{code:Z.invalid_string,validation:{startsWith:i.value},message:i.message}),n.dirty()):i.kind==="endsWith"?t.data.endsWith(i.value)||(a=this._getOrReturnCtx(t,a),le(a,{code:Z.invalid_string,validation:{endsWith:i.value},message:i.message}),n.dirty()):i.kind==="datetime"?f1(i).test(t.data)||(a=this._getOrReturnCtx(t,a),le(a,{code:Z.invalid_string,validation:"datetime",message:i.message}),n.dirty()):i.kind==="date"?l1.test(t.data)||(a=this._getOrReturnCtx(t,a),le(a,{code:Z.invalid_string,validation:"date",message:i.message}),n.dirty()):i.kind==="time"?d1(i).test(t.data)||(a=this._getOrReturnCtx(t,a),le(a,{code:Z.invalid_string,validation:"time",message:i.message}),n.dirty()):i.kind==="duration"?t1.test(t.data)||(a=this._getOrReturnCtx(t,a),le(a,{validation:"duration",code:Z.invalid_string,message:i.message}),n.dirty()):i.kind==="ip"?h1(t.data,i.version)||(a=this._getOrReturnCtx(t,a),le(a,{validation:"ip",code:Z.invalid_string,message:i.message}),n.dirty()):i.kind==="jwt"?p1(t.data,i.alg)||(a=this._getOrReturnCtx(t,a),le(a,{validation:"jwt",code:Z.invalid_string,message:i.message}),n.dirty()):i.kind==="cidr"?m1(t.data,i.version)||(a=this._getOrReturnCtx(t,a),le(a,{validation:"cidr",code:Z.invalid_string,message:i.message}),n.dirty()):i.kind==="base64"?c1.test(t.data)||(a=this._getOrReturnCtx(t,a),le(a,{validation:"base64",code:Z.invalid_string,message:i.message}),n.dirty()):i.kind==="base64url"?u1.test(t.data)||(a=this._getOrReturnCtx(t,a),le(a,{validation:"base64url",code:Z.invalid_string,message:i.message}),n.dirty()):Je.assertNever(i);return{status:n.value,value:t.data}}_regex(t,r,n){return this.refinement(a=>t.test(a),{validation:r,code:Z.invalid_string,...ge.errToObj(n)})}_addCheck(t){return new Rn({...this._def,checks:[...this._def.checks,t]})}email(t){return this._addCheck({kind:"email",...ge.errToObj(t)})}url(t){return this._addCheck({kind:"url",...ge.errToObj(t)})}emoji(t){return this._addCheck({kind:"emoji",...ge.errToObj(t)})}uuid(t){return this._addCheck({kind:"uuid",...ge.errToObj(t)})}nanoid(t){return this._addCheck({kind:"nanoid",...ge.errToObj(t)})}cuid(t){return this._addCheck({kind:"cuid",...ge.errToObj(t)})}cuid2(t){return this._addCheck({kind:"cuid2",...ge.errToObj(t)})}ulid(t){return this._addCheck({kind:"ulid",...ge.errToObj(t)})}base64(t){return this._addCheck({kind:"base64",...ge.errToObj(t)})}base64url(t){return this._addCheck({kind:"base64url",...ge.errToObj(t)})}jwt(t){return this._addCheck({kind:"jwt",...ge.errToObj(t)})}ip(t){return this._addCheck({kind:"ip",...ge.errToObj(t)})}cidr(t){return this._addCheck({kind:"cidr",...ge.errToObj(t)})}datetime(t){return typeof t=="string"?this._addCheck({kind:"datetime",precision:null,offset:!1,local:!1,message:t}):this._addCheck({kind:"datetime",precision:typeof t?.precision>"u"?null:t?.precision,offset:t?.offset??!1,local:t?.local??!1,...ge.errToObj(t?.message)})}date(t){return this._addCheck({kind:"date",message:t})}time(t){return typeof t=="string"?this._addCheck({kind:"time",precision:null,message:t}):this._addCheck({kind:"time",precision:typeof t?.precision>"u"?null:t?.precision,...ge.errToObj(t?.message)})}duration(t){return this._addCheck({kind:"duration",...ge.errToObj(t)})}regex(t,r){return this._addCheck({kind:"regex",regex:t,...ge.errToObj(r)})}includes(t,r){return this._addCheck({kind:"includes",value:t,position:r?.position,...ge.errToObj(r?.message)})}startsWith(t,r){return this._addCheck({kind:"startsWith",value:t,...ge.errToObj(r)})}endsWith(t,r){return this._addCheck({kind:"endsWith",value:t,...ge.errToObj(r)})}min(t,r){return this._addCheck({kind:"min",value:t,...ge.errToObj(r)})}max(t,r){return this._addCheck({kind:"max",value:t,...ge.errToObj(r)})}length(t,r){return this._addCheck({kind:"length",value:t,...ge.errToObj(r)})}nonempty(t){return this.min(1,ge.errToObj(t))}trim(){return new Rn({...this._def,checks:[...this._def.checks,{kind:"trim"}]})}toLowerCase(){return new Rn({...this._def,checks:[...this._def.checks,{kind:"toLowerCase"}]})}toUpperCase(){return new Rn({...this._def,checks:[...this._def.checks,{kind:"toUpperCase"}]})}get isDatetime(){return!!this._def.checks.find(t=>t.kind==="datetime")}get isDate(){return!!this._def.checks.find(t=>t.kind==="date")}get isTime(){return!!this._def.checks.find(t=>t.kind==="time")}get isDuration(){return!!this._def.checks.find(t=>t.kind==="duration")}get isEmail(){return!!this._def.checks.find(t=>t.kind==="email")}get isURL(){return!!this._def.checks.find(t=>t.kind==="url")}get isEmoji(){return!!this._def.checks.find(t=>t.kind==="emoji")}get isUUID(){return!!this._def.checks.find(t=>t.kind==="uuid")}get isNANOID(){return!!this._def.checks.find(t=>t.kind==="nanoid")}get isCUID(){return!!this._def.checks.find(t=>t.kind==="cuid")}get isCUID2(){return!!this._def.checks.find(t=>t.kind==="cuid2")}get isULID(){return!!this._def.checks.find(t=>t.kind==="ulid")}get isIP(){return!!this._def.checks.find(t=>t.kind==="ip")}get isCIDR(){return!!this._def.checks.find(t=>t.kind==="cidr")}get isBase64(){return!!this._def.checks.find(t=>t.kind==="base64")}get isBase64url(){return!!this._def.checks.find(t=>t.kind==="base64url")}get minLength(){let t=null;for(const r of this._def.checks)r.kind==="min"&&(t===null||r.value>t)&&(t=r.value);return t}get maxLength(){let t=null;for(const r of this._def.checks)r.kind==="max"&&(t===null||r.value<t)&&(t=r.value);return t}}Rn.create=e=>new Rn({checks:[],typeName:ee.ZodString,coerce:e?.coerce??!1,...ze(e)});function g1(e,t){const r=(e.toString().split(".")[1]||"").length,n=(t.toString().split(".")[1]||"").length,a=r>n?r:n,i=Number.parseInt(e.toFixed(a).replace(".","")),s=Number.parseInt(t.toFixed(a).replace(".",""));return i%s/10**a}class ys extends We{constructor(){super(...arguments),this.min=this.gte,this.max=this.lte,this.step=this.multipleOf}_parse(t){if(this._def.coerce&&(t.data=Number(t.data)),this._getType(t)!==pe.number){const i=this._getOrReturnCtx(t);return le(i,{code:Z.invalid_type,expected:pe.number,received:i.parsedType}),Pe}let n;const a=new or;for(const i of this._def.checks)i.kind==="int"?Je.isInteger(t.data)||(n=this._getOrReturnCtx(t,n),le(n,{code:Z.invalid_type,expected:"integer",received:"float",message:i.message}),a.dirty()):i.kind==="min"?(i.inclusive?t.data<i.value:t.data<=i.value)&&(n=this._getOrReturnCtx(t,n),le(n,{code:Z.too_small,minimum:i.value,type:"number",inclusive:i.inclusive,exact:!1,message:i.message}),a.dirty()):i.kind==="max"?(i.inclusive?t.data>i.value:t.data>=i.value)&&(n=this._getOrReturnCtx(t,n),le(n,{code:Z.too_big,maximum:i.value,type:"number",inclusive:i.inclusive,exact:!1,message:i.message}),a.dirty()):i.kind==="multipleOf"?g1(t.data,i.value)!==0&&(n=this._getOrReturnCtx(t,n),le(n,{code:Z.not_multiple_of,multipleOf:i.value,message:i.message}),a.dirty()):i.kind==="finite"?Number.isFinite(t.data)||(n=this._getOrReturnCtx(t,n),le(n,{code:Z.not_finite,message:i.message}),a.dirty()):Je.assertNever(i);return{status:a.value,value:t.data}}gte(t,r){return this.setLimit("min",t,!0,ge.toString(r))}gt(t,r){return this.setLimit("min",t,!1,ge.toString(r))}lte(t,r){return this.setLimit("max",t,!0,ge.toString(r))}lt(t,r){return this.setLimit("max",t,!1,ge.toString(r))}setLimit(t,r,n,a){return new ys({...this._def,checks:[...this._def.checks,{kind:t,value:r,inclusive:n,message:ge.toString(a)}]})}_addCheck(t){return new ys({...this._def,checks:[...this._def.checks,t]})}int(t){return this._addCheck({kind:"int",message:ge.toString(t)})}positive(t){return this._addCheck({kind:"min",value:0,inclusive:!1,message:ge.toString(t)})}negative(t){return this._addCheck({kind:"max",value:0,inclusive:!1,message:ge.toString(t)})}nonpositive(t){return this._addCheck({kind:"max",value:0,inclusive:!0,message:ge.toString(t)})}nonnegative(t){return this._addCheck({kind:"min",value:0,inclusive:!0,message:ge.toString(t)})}multipleOf(t,r){return this._addCheck({kind:"multipleOf",value:t,message:ge.toString(r)})}finite(t){return this._addCheck({kind:"finite",message:ge.toString(t)})}safe(t){return this._addCheck({kind:"min",inclusive:!0,value:Number.MIN_SAFE_INTEGER,message:ge.toString(t)})._addCheck({kind:"max",inclusive:!0,value:Number.MAX_SAFE_INTEGER,message:ge.toString(t)})}get minValue(){let t=null;for(const r of this._def.checks)r.kind==="min"&&(t===null||r.value>t)&&(t=r.value);return t}get maxValue(){let t=null;for(const r of this._def.checks)r.kind==="max"&&(t===null||r.value<t)&&(t=r.value);return t}get isInt(){return!!this._def.checks.find(t=>t.kind==="int"||t.kind==="multipleOf"&&Je.isInteger(t.value))}get isFinite(){let t=null,r=null;for(const n of this._def.checks){if(n.kind==="finite"||n.kind==="int"||n.kind==="multipleOf")return!0;n.kind==="min"?(r===null||n.value>r)&&(r=n.value):n.kind==="max"&&(t===null||n.value<t)&&(t=n.value)}return Number.isFinite(r)&&Number.isFinite(t)}}ys.create=e=>new ys({checks:[],typeName:ee.ZodNumber,coerce:e?.coerce||!1,...ze(e)});class vs extends We{constructor(){super(...arguments),this.min=this.gte,this.max=this.lte}_parse(t){if(this._def.coerce)try{t.data=BigInt(t.data)}catch{return this._getInvalidInput(t)}if(this._getType(t)!==pe.bigint)return this._getInvalidInput(t);let n;const a=new or;for(const i of this._def.checks)i.kind==="min"?(i.inclusive?t.data<i.value:t.data<=i.value)&&(n=this._getOrReturnCtx(t,n),le(n,{code:Z.too_small,type:"bigint",minimum:i.value,inclusive:i.inclusive,message:i.message}),a.dirty()):i.kind==="max"?(i.inclusive?t.data>i.value:t.data>=i.value)&&(n=this._getOrReturnCtx(t,n),le(n,{code:Z.too_big,type:"bigint",maximum:i.value,inclusive:i.inclusive,message:i.message}),a.dirty()):i.kind==="multipleOf"?t.data%i.value!==BigInt(0)&&(n=this._getOrReturnCtx(t,n),le(n,{code:Z.not_multiple_of,multipleOf:i.value,message:i.message}),a.dirty()):Je.assertNever(i);return{status:a.value,value:t.data}}_getInvalidInput(t){const r=this._getOrReturnCtx(t);return le(r,{code:Z.invalid_type,expected:pe.bigint,received:r.parsedType}),Pe}gte(t,r){return this.setLimit("min",t,!0,ge.toString(r))}gt(t,r){return this.setLimit("min",t,!1,ge.toString(r))}lte(t,r){return this.setLimit("max",t,!0,ge.toString(r))}lt(t,r){return this.setLimit("max",t,!1,ge.toString(r))}setLimit(t,r,n,a){return new vs({...this._def,checks:[...this._def.checks,{kind:t,value:r,inclusive:n,message:ge.toString(a)}]})}_addCheck(t){return new vs({...this._def,checks:[...this._def.checks,t]})}positive(t){return this._addCheck({kind:"min",value:BigInt(0),inclusive:!1,message:ge.toString(t)})}negative(t){return this._addCheck({kind:"max",value:BigInt(0),inclusive:!1,message:ge.toString(t)})}nonpositive(t){return this._addCheck({kind:"max",value:BigInt(0),inclusive:!0,message:ge.toString(t)})}nonnegative(t){return this._addCheck({kind:"min",value:BigInt(0),inclusive:!0,message:ge.toString(t)})}multipleOf(t,r){return this._addCheck({kind:"multipleOf",value:t,message:ge.toString(r)})}get minValue(){let t=null;for(const r of this._def.checks)r.kind==="min"&&(t===null||r.value>t)&&(t=r.value);return t}get maxValue(){let t=null;for(const r of this._def.checks)r.kind==="max"&&(t===null||r.value<t)&&(t=r.value);return t}}vs.create=e=>new vs({checks:[],typeName:ee.ZodBigInt,coerce:e?.coerce??!1,...ze(e)});class Og extends We{_parse(t){if(this._def.coerce&&(t.data=!!t.data),this._getType(t)!==pe.boolean){const n=this._getOrReturnCtx(t);return le(n,{code:Z.invalid_type,expected:pe.boolean,received:n.parsedType}),Pe}return _r(t.data)}}Og.create=e=>new Og({typeName:ee.ZodBoolean,coerce:e?.coerce||!1,...ze(e)});class dc extends We{_parse(t){if(this._def.coerce&&(t.data=new Date(t.data)),this._getType(t)!==pe.date){const i=this._getOrReturnCtx(t);return le(i,{code:Z.invalid_type,expected:pe.date,received:i.parsedType}),Pe}if(Number.isNaN(t.data.getTime())){const i=this._getOrReturnCtx(t);return le(i,{code:Z.invalid_date}),Pe}const n=new or;let a;for(const i of this._def.checks)i.kind==="min"?t.data.getTime()<i.value&&(a=this._getOrReturnCtx(t,a),le(a,{code:Z.too_small,message:i.message,inclusive:!0,exact:!1,minimum:i.value,type:"date"}),n.dirty()):i.kind==="max"?t.data.getTime()>i.value&&(a=this._getOrReturnCtx(t,a),le(a,{code:Z.too_big,message:i.message,inclusive:!0,exact:!1,maximum:i.value,type:"date"}),n.dirty()):Je.assertNever(i);return{status:n.value,value:new Date(t.data.getTime())}}_addCheck(t){return new dc({...this._def,checks:[...this._def.checks,t]})}min(t,r){return this._addCheck({kind:"min",value:t.getTime(),message:ge.toString(r)})}max(t,r){return this._addCheck({kind:"max",value:t.getTime(),message:ge.toString(r)})}get minDate(){let t=null;for(const r of this._def.checks)r.kind==="min"&&(t===null||r.value>t)&&(t=r.value);return t!=null?new Date(t):null}get maxDate(){let t=null;for(const r of this._def.checks)r.kind==="max"&&(t===null||r.value<t)&&(t=r.value);return t!=null?new Date(t):null}}dc.create=e=>new dc({checks:[],coerce:e?.coerce||!1,typeName:ee.ZodDate,...ze(e)});class Tg extends We{_parse(t){if(this._getType(t)!==pe.symbol){const n=this._getOrReturnCtx(t);return le(n,{code:Z.invalid_type,expected:pe.symbol,received:n.parsedType}),Pe}return _r(t.data)}}Tg.create=e=>new Tg({typeName:ee.ZodSymbol,...ze(e)});class Rg extends We{_parse(t){if(this._getType(t)!==pe.undefined){const n=this._getOrReturnCtx(t);return le(n,{code:Z.invalid_type,expected:pe.undefined,received:n.parsedType}),Pe}return _r(t.data)}}Rg.create=e=>new Rg({typeName:ee.ZodUndefined,...ze(e)});class $g extends We{_parse(t){if(this._getType(t)!==pe.null){const n=this._getOrReturnCtx(t);return le(n,{code:Z.invalid_type,expected:pe.null,received:n.parsedType}),Pe}return _r(t.data)}}$g.create=e=>new $g({typeName:ee.ZodNull,...ze(e)});class Bd extends We{constructor(){super(...arguments),this._any=!0}_parse(t){return _r(t.data)}}Bd.create=e=>new Bd({typeName:ee.ZodAny,...ze(e)});class Ag extends We{constructor(){super(...arguments),this._unknown=!0}_parse(t){return _r(t.data)}}Ag.create=e=>new Ag({typeName:ee.ZodUnknown,...ze(e)});class Fn extends We{_parse(t){const r=this._getOrReturnCtx(t);return le(r,{code:Z.invalid_type,expected:pe.never,received:r.parsedType}),Pe}}Fn.create=e=>new Fn({typeName:ee.ZodNever,...ze(e)});class Cg extends We{_parse(t){if(this._getType(t)!==pe.undefined){const n=this._getOrReturnCtx(t);return le(n,{code:Z.invalid_type,expected:pe.void,received:n.parsedType}),Pe}return _r(t.data)}}Cg.create=e=>new Cg({typeName:ee.ZodVoid,...ze(e)});class zr extends We{_parse(t){const{ctx:r,status:n}=this._processInputParams(t),a=this._def;if(r.parsedType!==pe.array)return le(r,{code:Z.invalid_type,expected:pe.array,received:r.parsedType}),Pe;if(a.exactLength!==null){const s=r.data.length>a.exactLength.value,o=r.data.length<a.exactLength.value;(s||o)&&(le(r,{code:s?Z.too_big:Z.too_small,minimum:o?a.exactLength.value:void 0,maximum:s?a.exactLength.value:void 0,type:"array",inclusive:!0,exact:!0,message:a.exactLength.message}),n.dirty())}if(a.minLength!==null&&r.data.length<a.minLength.value&&(le(r,{code:Z.too_small,minimum:a.minLength.value,type:"array",inclusive:!0,exact:!1,message:a.minLength.message}),n.dirty()),a.maxLength!==null&&r.data.length>a.maxLength.value&&(le(r,{code:Z.too_big,maximum:a.maxLength.value,type:"array",inclusive:!0,exact:!1,message:a.maxLength.message}),n.dirty()),r.common.async)return Promise.all([...r.data].map((s,o)=>a.type._parseAsync(new jn(r,s,r.path,o)))).then(s=>or.mergeArray(n,s));const i=[...r.data].map((s,o)=>a.type._parseSync(new jn(r,s,r.path,o)));return or.mergeArray(n,i)}get element(){return this._def.type}min(t,r){return new zr({...this._def,minLength:{value:t,message:ge.toString(r)}})}max(t,r){return new zr({...this._def,maxLength:{value:t,message:ge.toString(r)}})}length(t,r){return new zr({...this._def,exactLength:{value:t,message:ge.toString(r)}})}nonempty(t){return this.min(1,t)}}zr.create=(e,t)=>new zr({type:e,minLength:null,maxLength:null,exactLength:null,typeName:ee.ZodArray,...ze(t)});function Ha(e){if(e instanceof pt){const t={};for(const r in e.shape){const n=e.shape[r];t[r]=Pn.create(Ha(n))}return new pt({...e._def,shape:()=>t})}else return e instanceof zr?new zr({...e._def,type:Ha(e.element)}):e instanceof Pn?Pn.create(Ha(e.unwrap())):e instanceof di?di.create(Ha(e.unwrap())):e instanceof ba?ba.create(e.items.map(t=>Ha(t))):e}class pt extends We{constructor(){super(...arguments),this._cached=null,this.nonstrict=this.passthrough,this.augment=this.extend}_getCached(){if(this._cached!==null)return this._cached;const t=this._def.shape(),r=Je.objectKeys(t);return this._cached={shape:t,keys:r},this._cached}_parse(t){if(this._getType(t)!==pe.object){const u=this._getOrReturnCtx(t);return le(u,{code:Z.invalid_type,expected:pe.object,received:u.parsedType}),Pe}const{status:n,ctx:a}=this._processInputParams(t),{shape:i,keys:s}=this._getCached(),o=[];if(!(this._def.catchall instanceof Fn&&this._def.unknownKeys==="strip"))for(const u in a.data)s.includes(u)||o.push(u);const c=[];for(const u of s){const d=i[u],h=a.data[u];c.push({key:{status:"valid",value:u},value:d._parse(new jn(a,h,a.path,u)),alwaysSet:u in a.data})}if(this._def.catchall instanceof Fn){const u=this._def.unknownKeys;if(u==="passthrough")for(const d of o)c.push({key:{status:"valid",value:d},value:{status:"valid",value:a.data[d]}});else if(u==="strict")o.length>0&&(le(a,{code:Z.unrecognized_keys,keys:o}),n.dirty());else if(u!=="strip")throw new Error("Internal ZodObject error: invalid unknownKeys value.")}else{const u=this._def.catchall;for(const d of o){const h=a.data[d];c.push({key:{status:"valid",value:d},value:u._parse(new jn(a,h,a.path,d)),alwaysSet:d in a.data})}}return a.common.async?Promise.resolve().then(async()=>{const u=[];for(const d of c){const h=await d.key,p=await d.value;u.push({key:h,value:p,alwaysSet:d.alwaysSet})}return u}).then(u=>or.mergeObjectSync(n,u)):or.mergeObjectSync(n,c)}get shape(){return this._def.shape()}strict(t){return ge.errToObj,new pt({...this._def,unknownKeys:"strict",...t!==void 0?{errorMap:(r,n)=>{const a=this._def.errorMap?.(r,n).message??n.defaultError;return r.code==="unrecognized_keys"?{message:ge.errToObj(t).message??a}:{message:a}}}:{}})}strip(){return new pt({...this._def,unknownKeys:"strip"})}passthrough(){return new pt({...this._def,unknownKeys:"passthrough"})}extend(t){return new pt({...this._def,shape:()=>({...this._def.shape(),...t})})}merge(t){return new pt({unknownKeys:t._def.unknownKeys,catchall:t._def.catchall,shape:()=>({...this._def.shape(),...t._def.shape()}),typeName:ee.ZodObject})}setKey(t,r){return this.augment({[t]:r})}catchall(t){return new pt({...this._def,catchall:t})}pick(t){const r={};for(const n of Je.objectKeys(t))t[n]&&this.shape[n]&&(r[n]=this.shape[n]);return new pt({...this._def,shape:()=>r})}omit(t){const r={};for(const n of Je.objectKeys(this.shape))t[n]||(r[n]=this.shape[n]);return new pt({...this._def,shape:()=>r})}deepPartial(){return Ha(this)}partial(t){const r={};for(const n of Je.objectKeys(this.shape)){const a=this.shape[n];t&&!t[n]?r[n]=a:r[n]=a.optional()}return new pt({...this._def,shape:()=>r})}required(t){const r={};for(const n of Je.objectKeys(this.shape))if(t&&!t[n])r[n]=this.shape[n];else{let i=this.shape[n];for(;i instanceof Pn;)i=i._def.innerType;r[n]=i}return new pt({...this._def,shape:()=>r})}keyof(){return mw(Je.objectKeys(this.shape))}}pt.create=(e,t)=>new pt({shape:()=>e,unknownKeys:"strip",catchall:Fn.create(),typeName:ee.ZodObject,...ze(t)});pt.strictCreate=(e,t)=>new pt({shape:()=>e,unknownKeys:"strict",catchall:Fn.create(),typeName:ee.ZodObject,...ze(t)});pt.lazycreate=(e,t)=>new pt({shape:e,unknownKeys:"strip",catchall:Fn.create(),typeName:ee.ZodObject,...ze(t)});class fc extends We{_parse(t){const{ctx:r}=this._processInputParams(t),n=this._def.options;function a(i){for(const o of i)if(o.result.status==="valid")return o.result;for(const o of i)if(o.result.status==="dirty")return r.common.issues.push(...o.ctx.common.issues),o.result;const s=i.map(o=>new hn(o.ctx.common.issues));return le(r,{code:Z.invalid_union,unionErrors:s}),Pe}if(r.common.async)return Promise.all(n.map(async i=>{const s={...r,common:{...r.common,issues:[]},parent:null};return{result:await i._parseAsync({data:r.data,path:r.path,parent:s}),ctx:s}})).then(a);{let i;const s=[];for(const c of n){const u={...r,common:{...r.common,issues:[]},parent:null},d=c._parseSync({data:r.data,path:r.path,parent:u});if(d.status==="valid")return d;d.status==="dirty"&&!i&&(i={result:d,ctx:u}),u.common.issues.length&&s.push(u.common.issues)}if(i)return r.common.issues.push(...i.ctx.common.issues),i.result;const o=s.map(c=>new hn(c));return le(r,{code:Z.invalid_union,unionErrors:o}),Pe}}get options(){return this._def.options}}fc.create=(e,t)=>new fc({options:e,typeName:ee.ZodUnion,...ze(t)});function Ud(e,t){const r=On(e),n=On(t);if(e===t)return{valid:!0,data:e};if(r===pe.object&&n===pe.object){const a=Je.objectKeys(t),i=Je.objectKeys(e).filter(o=>a.indexOf(o)!==-1),s={...e,...t};for(const o of i){const c=Ud(e[o],t[o]);if(!c.valid)return{valid:!1};s[o]=c.data}return{valid:!0,data:s}}else if(r===pe.array&&n===pe.array){if(e.length!==t.length)return{valid:!1};const a=[];for(let i=0;i<e.length;i++){const s=e[i],o=t[i],c=Ud(s,o);if(!c.valid)return{valid:!1};a.push(c.data)}return{valid:!0,data:a}}else return r===pe.date&&n===pe.date&&+e==+t?{valid:!0,data:e}:{valid:!1}}class hc extends We{_parse(t){const{status:r,ctx:n}=this._processInputParams(t),a=(i,s)=>{if(Sg(i)||Sg(s))return Pe;const o=Ud(i.value,s.value);return o.valid?((kg(i)||kg(s))&&r.dirty(),{status:r.value,value:o.data}):(le(n,{code:Z.invalid_intersection_types}),Pe)};return n.common.async?Promise.all([this._def.left._parseAsync({data:n.data,path:n.path,parent:n}),this._def.right._parseAsync({data:n.data,path:n.path,parent:n})]).then(([i,s])=>a(i,s)):a(this._def.left._parseSync({data:n.data,path:n.path,parent:n}),this._def.right._parseSync({data:n.data,path:n.path,parent:n}))}}hc.create=(e,t,r)=>new hc({left:e,right:t,typeName:ee.ZodIntersection,...ze(r)});class ba extends We{_parse(t){const{status:r,ctx:n}=this._processInputParams(t);if(n.parsedType!==pe.array)return le(n,{code:Z.invalid_type,expected:pe.array,received:n.parsedType}),Pe;if(n.data.length<this._def.items.length)return le(n,{code:Z.too_small,minimum:this._def.items.length,inclusive:!0,exact:!1,type:"array"}),Pe;!this._def.rest&&n.data.length>this._def.items.length&&(le(n,{code:Z.too_big,maximum:this._def.items.length,inclusive:!0,exact:!1,type:"array"}),r.dirty());const i=[...n.data].map((s,o)=>{const c=this._def.items[o]||this._def.rest;return c?c._parse(new jn(n,s,n.path,o)):null}).filter(s=>!!s);return n.common.async?Promise.all(i).then(s=>or.mergeArray(r,s)):or.mergeArray(r,i)}get items(){return this._def.items}rest(t){return new ba({...this._def,rest:t})}}ba.create=(e,t)=>{if(!Array.isArray(e))throw new Error("You must pass an array of schemas to z.tuple([ ... ])");return new ba({items:e,typeName:ee.ZodTuple,rest:null,...ze(t)})};class Pg extends We{get keySchema(){return this._def.keyType}get valueSchema(){return this._def.valueType}_parse(t){const{status:r,ctx:n}=this._processInputParams(t);if(n.parsedType!==pe.map)return le(n,{code:Z.invalid_type,expected:pe.map,received:n.parsedType}),Pe;const a=this._def.keyType,i=this._def.valueType,s=[...n.data.entries()].map(([o,c],u)=>({key:a._parse(new jn(n,o,n.path,[u,"key"])),value:i._parse(new jn(n,c,n.path,[u,"value"]))}));if(n.common.async){const o=new Map;return Promise.resolve().then(async()=>{for(const c of s){const u=await c.key,d=await c.value;if(u.status==="aborted"||d.status==="aborted")return Pe;(u.status==="dirty"||d.status==="dirty")&&r.dirty(),o.set(u.value,d.value)}return{status:r.value,value:o}})}else{const o=new Map;for(const c of s){const u=c.key,d=c.value;if(u.status==="aborted"||d.status==="aborted")return Pe;(u.status==="dirty"||d.status==="dirty")&&r.dirty(),o.set(u.value,d.value)}return{status:r.value,value:o}}}}Pg.create=(e,t,r)=>new Pg({valueType:t,keyType:e,typeName:ee.ZodMap,...ze(r)});class _s extends We{_parse(t){const{status:r,ctx:n}=this._processInputParams(t);if(n.parsedType!==pe.set)return le(n,{code:Z.invalid_type,expected:pe.set,received:n.parsedType}),Pe;const a=this._def;a.minSize!==null&&n.data.size<a.minSize.value&&(le(n,{code:Z.too_small,minimum:a.minSize.value,type:"set",inclusive:!0,exact:!1,message:a.minSize.message}),r.dirty()),a.maxSize!==null&&n.data.size>a.maxSize.value&&(le(n,{code:Z.too_big,maximum:a.maxSize.value,type:"set",inclusive:!0,exact:!1,message:a.maxSize.message}),r.dirty());const i=this._def.valueType;function s(c){const u=new Set;for(const d of c){if(d.status==="aborted")return Pe;d.status==="dirty"&&r.dirty(),u.add(d.value)}return{status:r.value,value:u}}const o=[...n.data.values()].map((c,u)=>i._parse(new jn(n,c,n.path,u)));return n.common.async?Promise.all(o).then(c=>s(c)):s(o)}min(t,r){return new _s({...this._def,minSize:{value:t,message:ge.toString(r)}})}max(t,r){return new _s({...this._def,maxSize:{value:t,message:ge.toString(r)}})}size(t,r){return this.min(t,r).max(t,r)}nonempty(t){return this.min(1,t)}}_s.create=(e,t)=>new _s({valueType:e,minSize:null,maxSize:null,typeName:ee.ZodSet,...ze(t)});class Ng extends We{get schema(){return this._def.getter()}_parse(t){const{ctx:r}=this._processInputParams(t);return this._def.getter()._parse({data:r.data,path:r.path,parent:r})}}Ng.create=(e,t)=>new Ng({getter:e,typeName:ee.ZodLazy,...ze(t)});class Dg extends We{_parse(t){if(t.data!==this._def.value){const r=this._getOrReturnCtx(t);return le(r,{received:r.data,code:Z.invalid_literal,expected:this._def.value}),Pe}return{status:"valid",value:t.data}}get value(){return this._def.value}}Dg.create=(e,t)=>new Dg({value:e,typeName:ee.ZodLiteral,...ze(t)});function mw(e,t){return new ui({values:e,typeName:ee.ZodEnum,...ze(t)})}class ui extends We{_parse(t){if(typeof t.data!="string"){const r=this._getOrReturnCtx(t),n=this._def.values;return le(r,{expected:Je.joinValues(n),received:r.parsedType,code:Z.invalid_type}),Pe}if(this._cache||(this._cache=new Set(this._def.values)),!this._cache.has(t.data)){const r=this._getOrReturnCtx(t),n=this._def.values;return le(r,{received:r.data,code:Z.invalid_enum_value,options:n}),Pe}return _r(t.data)}get options(){return this._def.values}get enum(){const t={};for(const r of this._def.values)t[r]=r;return t}get Values(){const t={};for(const r of this._def.values)t[r]=r;return t}get Enum(){const t={};for(const r of this._def.values)t[r]=r;return t}extract(t,r=this._def){return ui.create(t,{...this._def,...r})}exclude(t,r=this._def){return ui.create(this.options.filter(n=>!t.includes(n)),{...this._def,...r})}}ui.create=mw;class Lg extends We{_parse(t){const r=Je.getValidEnumValues(this._def.values),n=this._getOrReturnCtx(t);if(n.parsedType!==pe.string&&n.parsedType!==pe.number){const a=Je.objectValues(r);return le(n,{expected:Je.joinValues(a),received:n.parsedType,code:Z.invalid_type}),Pe}if(this._cache||(this._cache=new Set(Je.getValidEnumValues(this._def.values))),!this._cache.has(t.data)){const a=Je.objectValues(r);return le(n,{received:n.data,code:Z.invalid_enum_value,options:a}),Pe}return _r(t.data)}get enum(){return this._def.values}}Lg.create=(e,t)=>new Lg({values:e,typeName:ee.ZodNativeEnum,...ze(t)});class pc extends We{unwrap(){return this._def.type}_parse(t){const{ctx:r}=this._processInputParams(t);if(r.parsedType!==pe.promise&&r.common.async===!1)return le(r,{code:Z.invalid_type,expected:pe.promise,received:r.parsedType}),Pe;const n=r.parsedType===pe.promise?r.data:Promise.resolve(r.data);return _r(n.then(a=>this._def.type.parseAsync(a,{path:r.path,errorMap:r.common.contextualErrorMap})))}}pc.create=(e,t)=>new pc({type:e,typeName:ee.ZodPromise,...ze(t)});class li extends We{innerType(){return this._def.schema}sourceType(){return this._def.schema._def.typeName===ee.ZodEffects?this._def.schema.sourceType():this._def.schema}_parse(t){const{status:r,ctx:n}=this._processInputParams(t),a=this._def.effect||null,i={addIssue:s=>{le(n,s),s.fatal?r.abort():r.dirty()},get path(){return n.path}};if(i.addIssue=i.addIssue.bind(i),a.type==="preprocess"){const s=a.transform(n.data,i);if(n.common.async)return Promise.resolve(s).then(async o=>{if(r.value==="aborted")return Pe;const c=await this._def.schema._parseAsync({data:o,path:n.path,parent:n});return c.status==="aborted"?Pe:c.status==="dirty"||r.value==="dirty"?qi(c.value):c});{if(r.value==="aborted")return Pe;const o=this._def.schema._parseSync({data:s,path:n.path,parent:n});return o.status==="aborted"?Pe:o.status==="dirty"||r.value==="dirty"?qi(o.value):o}}if(a.type==="refinement"){const s=o=>{const c=a.refinement(o,i);if(n.common.async)return Promise.resolve(c);if(c instanceof Promise)throw new Error("Async refinement encountered during synchronous parse operation. Use .parseAsync instead.");return o};if(n.common.async===!1){const o=this._def.schema._parseSync({data:n.data,path:n.path,parent:n});return o.status==="aborted"?Pe:(o.status==="dirty"&&r.dirty(),s(o.value),{status:r.value,value:o.value})}else return this._def.schema._parseAsync({data:n.data,path:n.path,parent:n}).then(o=>o.status==="aborted"?Pe:(o.status==="dirty"&&r.dirty(),s(o.value).then(()=>({status:r.value,value:o.value}))))}if(a.type==="transform")if(n.common.async===!1){const s=this._def.schema._parseSync({data:n.data,path:n.path,parent:n});if(!ci(s))return Pe;const o=a.transform(s.value,i);if(o instanceof Promise)throw new Error("Asynchronous transform encountered during synchronous parse operation. Use .parseAsync instead.");return{status:r.value,value:o}}else return this._def.schema._parseAsync({data:n.data,path:n.path,parent:n}).then(s=>ci(s)?Promise.resolve(a.transform(s.value,i)).then(o=>({status:r.value,value:o})):Pe);Je.assertNever(a)}}li.create=(e,t,r)=>new li({schema:e,typeName:ee.ZodEffects,effect:t,...ze(r)});li.createWithPreprocess=(e,t,r)=>new li({schema:t,effect:{type:"preprocess",transform:e},typeName:ee.ZodEffects,...ze(r)});class Pn extends We{_parse(t){return this._getType(t)===pe.undefined?_r(void 0):this._def.innerType._parse(t)}unwrap(){return this._def.innerType}}Pn.create=(e,t)=>new Pn({innerType:e,typeName:ee.ZodOptional,...ze(t)});class di extends We{_parse(t){return this._getType(t)===pe.null?_r(null):this._def.innerType._parse(t)}unwrap(){return this._def.innerType}}di.create=(e,t)=>new di({innerType:e,typeName:ee.ZodNullable,...ze(t)});class zd extends We{_parse(t){const{ctx:r}=this._processInputParams(t);let n=r.data;return r.parsedType===pe.undefined&&(n=this._def.defaultValue()),this._def.innerType._parse({data:n,path:r.path,parent:r})}removeDefault(){return this._def.innerType}}zd.create=(e,t)=>new zd({innerType:e,typeName:ee.ZodDefault,defaultValue:typeof t.default=="function"?t.default:()=>t.default,...ze(t)});class qd extends We{_parse(t){const{ctx:r}=this._processInputParams(t),n={...r,common:{...r.common,issues:[]}},a=this._def.innerType._parse({data:n.data,path:n.path,parent:{...n}});return lc(a)?a.then(i=>({status:"valid",value:i.status==="valid"?i.value:this._def.catchValue({get error(){return new hn(n.common.issues)},input:n.data})})):{status:"valid",value:a.status==="valid"?a.value:this._def.catchValue({get error(){return new hn(n.common.issues)},input:n.data})}}removeCatch(){return this._def.innerType}}qd.create=(e,t)=>new qd({innerType:e,typeName:ee.ZodCatch,catchValue:typeof t.catch=="function"?t.catch:()=>t.catch,...ze(t)});class Mg extends We{_parse(t){if(this._getType(t)!==pe.nan){const n=this._getOrReturnCtx(t);return le(n,{code:Z.invalid_type,expected:pe.nan,received:n.parsedType}),Pe}return{status:"valid",value:t.data}}}Mg.create=e=>new Mg({typeName:ee.ZodNaN,...ze(e)});class y1 extends We{_parse(t){const{ctx:r}=this._processInputParams(t),n=r.data;return this._def.type._parse({data:n,path:r.path,parent:r})}unwrap(){return this._def.type}}class Zf extends We{_parse(t){const{status:r,ctx:n}=this._processInputParams(t);if(n.common.async)return(async()=>{const i=await this._def.in._parseAsync({data:n.data,path:n.path,parent:n});return i.status==="aborted"?Pe:i.status==="dirty"?(r.dirty(),qi(i.value)):this._def.out._parseAsync({data:i.value,path:n.path,parent:n})})();{const a=this._def.in._parseSync({data:n.data,path:n.path,parent:n});return a.status==="aborted"?Pe:a.status==="dirty"?(r.dirty(),{status:"dirty",value:a.value}):this._def.out._parseSync({data:a.value,path:n.path,parent:n})}}static create(t,r){return new Zf({in:t,out:r,typeName:ee.ZodPipeline})}}class Hd extends We{_parse(t){const r=this._def.innerType._parse(t),n=a=>(ci(a)&&(a.value=Object.freeze(a.value)),a);return lc(r)?r.then(a=>n(a)):n(r)}unwrap(){return this._def.innerType}}Hd.create=(e,t)=>new Hd({innerType:e,typeName:ee.ZodReadonly,...ze(t)});var ee;(function(e){e.ZodString="ZodString",e.ZodNumber="ZodNumber",e.ZodNaN="ZodNaN",e.ZodBigInt="ZodBigInt",e.ZodBoolean="ZodBoolean",e.ZodDate="ZodDate",e.ZodSymbol="ZodSymbol",e.ZodUndefined="ZodUndefined",e.ZodNull="ZodNull",e.ZodAny="ZodAny",e.ZodUnknown="ZodUnknown",e.ZodNever="ZodNever",e.ZodVoid="ZodVoid",e.ZodArray="ZodArray",e.ZodObject="ZodObject",e.ZodUnion="ZodUnion",e.ZodDiscriminatedUnion="ZodDiscriminatedUnion",e.ZodIntersection="ZodIntersection",e.ZodTuple="ZodTuple",e.ZodRecord="ZodRecord",e.ZodMap="ZodMap",e.ZodSet="ZodSet",e.ZodFunction="ZodFunction",e.ZodLazy="ZodLazy",e.ZodLiteral="ZodLiteral",e.ZodEnum="ZodEnum",e.ZodEffects="ZodEffects",e.ZodNativeEnum="ZodNativeEnum",e.ZodOptional="ZodOptional",e.ZodNullable="ZodNullable",e.ZodDefault="ZodDefault",e.ZodCatch="ZodCatch",e.ZodPromise="ZodPromise",e.ZodBranded="ZodBranded",e.ZodPipeline="ZodPipeline",e.ZodReadonly="ZodReadonly"})(ee||(ee={}));const v1=Rn.create,jg=Bd.create;Fn.create;zr.create;const _1=pt.create;fc.create;hc.create;ba.create;ui.create;pc.create;Pn.create;di.create;function w1(e,t){const r={type:"array"};return e.type?._def&&e.type?._def?.typeName!==ee.ZodAny&&(r.items=Qe(e.type._def,{...t,currentPath:[...t.currentPath,"items"]})),e.minLength&&Ye(r,"minItems",e.minLength.value,e.minLength.message,t),e.maxLength&&Ye(r,"maxItems",e.maxLength.value,e.maxLength.message,t),e.exactLength&&(Ye(r,"minItems",e.exactLength.value,e.exactLength.message,t),Ye(r,"maxItems",e.exactLength.value,e.exactLength.message,t)),r}function b1(e,t){const r={type:"integer",format:"int64"};if(!e.checks)return r;for(const n of e.checks)switch(n.kind){case"min":t.target==="jsonSchema7"?n.inclusive?Ye(r,"minimum",n.value,n.message,t):Ye(r,"exclusiveMinimum",n.value,n.message,t):(n.inclusive||(r.exclusiveMinimum=!0),Ye(r,"minimum",n.value,n.message,t));break;case"max":t.target==="jsonSchema7"?n.inclusive?Ye(r,"maximum",n.value,n.message,t):Ye(r,"exclusiveMaximum",n.value,n.message,t):(n.inclusive||(r.exclusiveMaximum=!0),Ye(r,"maximum",n.value,n.message,t));break;case"multipleOf":Ye(r,"multipleOf",n.value,n.message,t);break}return r}function E1(){return{type:"boolean"}}function gw(e,t){return Qe(e.type._def,t)}const x1=(e,t)=>Qe(e.innerType._def,t);function yw(e,t,r){const n=r??t.dateStrategy;if(Array.isArray(n))return{anyOf:n.map(a=>yw(e,t,a))};switch(n){case"string":case"format:date-time":return{type:"string",format:"date-time"};case"format:date":return{type:"string",format:"date"};case"integer":return S1(e,t)}}const S1=(e,t)=>{const r={type:"integer",format:"unix-time"};if(t.target==="openApi3")return r;for(const n of e.checks)switch(n.kind){case"min":Ye(r,"minimum",n.value,n.message,t);break;case"max":Ye(r,"maximum",n.value,n.message,t);break}return r};function k1(e,t){return{...Qe(e.innerType._def,t),default:e.defaultValue()}}function I1(e,t){return t.effectStrategy==="input"?Qe(e.schema._def,t):Vt(t)}function O1(e){return{type:"string",enum:Array.from(e.values)}}const T1=e=>"type"in e&&e.type==="string"?!1:"allOf"in e;function R1(e,t){const r=[Qe(e.left._def,{...t,currentPath:[...t.currentPath,"allOf","0"]}),Qe(e.right._def,{...t,currentPath:[...t.currentPath,"allOf","1"]})].filter(i=>!!i);let n=t.target==="jsonSchema2019-09"?{unevaluatedProperties:!1}:void 0;const a=[];return r.forEach(i=>{if(T1(i))a.push(...i.allOf),i.unevaluatedProperties===void 0&&(n=void 0);else{let s=i;if("additionalProperties"in i&&i.additionalProperties===!1){const{additionalProperties:o,...c}=i;s=c}else n=void 0;a.push(s)}}),a.length?{allOf:a,...n}:void 0}function $1(e,t){const r=typeof e.value;return r!=="bigint"&&r!=="number"&&r!=="boolean"&&r!=="string"?{type:Array.isArray(e.value)?"array":"object"}:t.target==="openApi3"?{type:r==="bigint"?"integer":r,enum:[e.value]}:{type:r==="bigint"?"integer":r,const:e.value}}let Ql;const Er={cuid:/^[cC][^\s-]{8,}$/,cuid2:/^[0-9a-z]+$/,ulid:/^[0-9A-HJKMNP-TV-Z]{26}$/,email:/^(?!\.)(?!.*\.\.)([a-zA-Z0-9_'+\-\.]*)[a-zA-Z0-9_+-]@([a-zA-Z0-9][a-zA-Z0-9\-]*\.)+[a-zA-Z]{2,}$/,emoji:()=>(Ql===void 0&&(Ql=RegExp("^(\\p{Extended_Pictographic}|\\p{Emoji_Component})+$","u")),Ql),uuid:/^[0-9a-fA-F]{8}\b-[0-9a-fA-F]{4}\b-[0-9a-fA-F]{4}\b-[0-9a-fA-F]{4}\b-[0-9a-fA-F]{12}$/,ipv4:/^(?:(?:25[0-5]|2[0-4][0-9]|1[0-9][0-9]|[1-9][0-9]|[0-9])\.){3}(?:25[0-5]|2[0-4][0-9]|1[0-9][0-9]|[1-9][0-9]|[0-9])$/,ipv4Cidr:/^(?:(?:25[0-5]|2[0-4][0-9]|1[0-9][0-9]|[1-9][0-9]|[0-9])\.){3}(?:25[0-5]|2[0-4][0-9]|1[0-9][0-9]|[1-9][0-9]|[0-9])\/(3[0-2]|[12]?[0-9])$/,ipv6:/^(([a-f0-9]{1,4}:){7}|::([a-f0-9]{1,4}:){0,6}|([a-f0-9]{1,4}:){1}:([a-f0-9]{1,4}:){0,5}|([a-f0-9]{1,4}:){2}:([a-f0-9]{1,4}:){0,4}|([a-f0-9]{1,4}:){3}:([a-f0-9]{1,4}:){0,3}|([a-f0-9]{1,4}:){4}:([a-f0-9]{1,4}:){0,2}|([a-f0-9]{1,4}:){5}:([a-f0-9]{1,4}:){0,1})([a-f0-9]{1,4}|(((25[0-5])|(2[0-4][0-9])|(1[0-9]{2})|([0-9]{1,2}))\.){3}((25[0-5])|(2[0-4][0-9])|(1[0-9]{2})|([0-9]{1,2})))$/,ipv6Cidr:/^(([0-9a-fA-F]{1,4}:){7,7}[0-9a-fA-F]{1,4}|([0-9a-fA-F]{1,4}:){1,7}:|([0-9a-fA-F]{1,4}:){1,6}:[0-9a-fA-F]{1,4}|([0-9a-fA-F]{1,4}:){1,5}(:[0-9a-fA-F]{1,4}){1,2}|([0-9a-fA-F]{1,4}:){1,4}(:[0-9a-fA-F]{1,4}){1,3}|([0-9a-fA-F]{1,4}:){1,3}(:[0-9a-fA-F]{1,4}){1,4}|([0-9a-fA-F]{1,4}:){1,2}(:[0-9a-fA-F]{1,4}){1,5}|[0-9a-fA-F]{1,4}:((:[0-9a-fA-F]{1,4}){1,6})|:((:[0-9a-fA-F]{1,4}){1,7}|:)|fe80:(:[0-9a-fA-F]{0,4}){0,4}%[0-9a-zA-Z]{1,}|::(ffff(:0{1,4}){0,1}:){0,1}((25[0-5]|(2[0-4]|1{0,1}[0-9]){0,1}[0-9])\.){3,3}(25[0-5]|(2[0-4]|1{0,1}[0-9]){0,1}[0-9])|([0-9a-fA-F]{1,4}:){1,4}:((25[0-5]|(2[0-4]|1{0,1}[0-9]){0,1}[0-9])\.){3,3}(25[0-5]|(2[0-4]|1{0,1}[0-9]){0,1}[0-9]))\/(12[0-8]|1[01][0-9]|[1-9]?[0-9])$/,base64:/^([0-9a-zA-Z+/]{4})*(([0-9a-zA-Z+/]{2}==)|([0-9a-zA-Z+/]{3}=))?$/,base64url:/^([0-9a-zA-Z-_]{4})*(([0-9a-zA-Z-_]{2}(==)?)|([0-9a-zA-Z-_]{3}(=)?))?$/,nanoid:/^[a-zA-Z0-9_-]{21}$/,jwt:/^[A-Za-z0-9-_]+\.[A-Za-z0-9-_]+\.[A-Za-z0-9-_]*$/};function vw(e,t){const r={type:"string"};if(e.checks)for(const n of e.checks)switch(n.kind){case"min":Ye(r,"minLength",typeof r.minLength=="number"?Math.max(r.minLength,n.value):n.value,n.message,t);break;case"max":Ye(r,"maxLength",typeof r.maxLength=="number"?Math.min(r.maxLength,n.value):n.value,n.message,t);break;case"email":switch(t.emailStrategy){case"format:email":xr(r,"email",n.message,t);break;case"format:idn-email":xr(r,"idn-email",n.message,t);break;case"pattern:zod":Ft(r,Er.email,n.message,t);break}break;case"url":xr(r,"uri",n.message,t);break;case"uuid":xr(r,"uuid",n.message,t);break;case"regex":Ft(r,n.regex,n.message,t);break;case"cuid":Ft(r,Er.cuid,n.message,t);break;case"cuid2":Ft(r,Er.cuid2,n.message,t);break;case"startsWith":Ft(r,RegExp(`^${Yl(n.value,t)}`),n.message,t);break;case"endsWith":Ft(r,RegExp(`${Yl(n.value,t)}$`),n.message,t);break;case"datetime":xr(r,"date-time",n.message,t);break;case"date":xr(r,"date",n.message,t);break;case"time":xr(r,"time",n.message,t);break;case"duration":xr(r,"duration",n.message,t);break;case"length":Ye(r,"minLength",typeof r.minLength=="number"?Math.max(r.minLength,n.value):n.value,n.message,t),Ye(r,"maxLength",typeof r.maxLength=="number"?Math.min(r.maxLength,n.value):n.value,n.message,t);break;case"includes":Ft(r,RegExp(Yl(n.value,t)),n.message,t);break;case"ip":n.version!=="v6"&&xr(r,"ipv4",n.message,t),n.version!=="v4"&&xr(r,"ipv6",n.message,t);break;case"base64url":Ft(r,Er.base64url,n.message,t);break;case"jwt":Ft(r,Er.jwt,n.message,t);break;case"cidr":n.version!=="v6"&&Ft(r,Er.ipv4Cidr,n.message,t),n.version!=="v4"&&Ft(r,Er.ipv6Cidr,n.message,t);break;case"emoji":Ft(r,Er.emoji(),n.message,t);break;case"ulid":Ft(r,Er.ulid,n.message,t);break;case"base64":switch(t.base64Strategy){case"format:binary":xr(r,"binary",n.message,t);break;case"contentEncoding:base64":Ye(r,"contentEncoding","base64",n.message,t);break;case"pattern:zod":Ft(r,Er.base64,n.message,t);break}break;case"nanoid":Ft(r,Er.nanoid,n.message,t);break}return r}function Yl(e,t){return t.patternStrategy==="escape"?C1(e):e}const A1=new Set("ABCDEFGHIJKLMNOPQRSTUVXYZabcdefghijklmnopqrstuvxyz0123456789");function C1(e){let t="";for(let r=0;r<e.length;r++)A1.has(e[r])||(t+="\\"),t+=e[r];return t}function xr(e,t,r,n){e.format||e.anyOf?.some(a=>a.format)?(e.anyOf||(e.anyOf=[]),e.format&&(e.anyOf.push({format:e.format,...e.errorMessage&&n.errorMessages&&{errorMessage:{format:e.errorMessage.format}}}),delete e.format,e.errorMessage&&(delete e.errorMessage.format,Object.keys(e.errorMessage).length===0&&delete e.errorMessage)),e.anyOf.push({format:t,...r&&n.errorMessages&&{errorMessage:{format:r}}})):Ye(e,"format",t,r,n)}function Ft(e,t,r,n){e.pattern||e.allOf?.some(a=>a.pattern)?(e.allOf||(e.allOf=[]),e.pattern&&(e.allOf.push({pattern:e.pattern,...e.errorMessage&&n.errorMessages&&{errorMessage:{pattern:e.errorMessage.pattern}}}),delete e.pattern,e.errorMessage&&(delete e.errorMessage.pattern,Object.keys(e.errorMessage).length===0&&delete e.errorMessage)),e.allOf.push({pattern:Fg(t,n),...r&&n.errorMessages&&{errorMessage:{pattern:r}}})):Ye(e,"pattern",Fg(t,n),r,n)}function Fg(e,t){if(!t.applyRegexFlags||!e.flags)return e.source;const r={i:e.flags.includes("i"),m:e.flags.includes("m"),s:e.flags.includes("s")},n=r.i?e.source.toLowerCase():e.source;let a="",i=!1,s=!1,o=!1;for(let c=0;c<n.length;c++){if(i){a+=n[c],i=!1;continue}if(r.i){if(s){if(n[c].match(/[a-z]/)){o?(a+=n[c],a+=`${n[c-2]}-${n[c]}`.toUpperCase(),o=!1):n[c+1]==="-"&&n[c+2]?.match(/[a-z]/)?(a+=n[c],o=!0):a+=`${n[c]}${n[c].toUpperCase()}`;continue}}else if(n[c].match(/[a-z]/)){a+=`[${n[c]}${n[c].toUpperCase()}]`;continue}}if(r.m){if(n[c]==="^"){a+=`(^|(?<=[\r
]))`;continue}else if(n[c]==="$"){a+=`($|(?=[\r
]))`;continue}}if(r.s&&n[c]==="."){a+=s?`${n[c]}\r
`:`[${n[c]}\r
]`;continue}a+=n[c],n[c]==="\\"?i=!0:s&&n[c]==="]"?s=!1:!s&&n[c]==="["&&(s=!0)}try{new RegExp(a)}catch{return console.warn(`Could not convert regex pattern at ${t.currentPath.join("/")} to a flag-independent form! Falling back to the flag-ignorant source`),e.source}return a}function _w(e,t){if(t.target==="openAi"&&console.warn("Warning: OpenAI may not support records in schemas! Try an array of key-value pairs instead."),t.target==="openApi3"&&e.keyType?._def.typeName===ee.ZodEnum)return{type:"object",required:e.keyType._def.values,properties:e.keyType._def.values.reduce((n,a)=>({...n,[a]:Qe(e.valueType._def,{...t,currentPath:[...t.currentPath,"properties",a]})??Vt(t)}),{}),additionalProperties:t.rejectedAdditionalProperties};const r={type:"object",additionalProperties:Qe(e.valueType._def,{...t,currentPath:[...t.currentPath,"additionalProperties"]})??t.allowedAdditionalProperties};if(t.target==="openApi3")return r;if(e.keyType?._def.typeName===ee.ZodString&&e.keyType._def.checks?.length){const{type:n,...a}=vw(e.keyType._def,t);return{...r,propertyNames:a}}else{if(e.keyType?._def.typeName===ee.ZodEnum)return{...r,propertyNames:{enum:e.keyType._def.values}};if(e.keyType?._def.typeName===ee.ZodBranded&&e.keyType._def.type._def.typeName===ee.ZodString&&e.keyType._def.type._def.checks?.length){const{type:n,...a}=gw(e.keyType._def,t);return{...r,propertyNames:a}}}return r}function P1(e,t){if(t.mapStrategy==="record")return _w(e,t);const r=Qe(e.keyType._def,{...t,currentPath:[...t.currentPath,"items","items","0"]})||Vt(t),n=Qe(e.valueType._def,{...t,currentPath:[...t.currentPath,"items","items","1"]})||Vt(t);return{type:"array",maxItems:125,items:{type:"array",items:[r,n],minItems:2,maxItems:2}}}function N1(e){const t=e.values,n=Object.keys(e.values).filter(i=>typeof t[t[i]]!="number").map(i=>t[i]),a=Array.from(new Set(n.map(i=>typeof i)));return{type:a.length===1?a[0]==="string"?"string":"number":["string","number"],enum:n}}function D1(e){return e.target==="openAi"?void 0:{not:Vt({...e,currentPath:[...e.currentPath,"not"]})}}function L1(e){return e.target==="openApi3"?{enum:["null"],nullable:!0}:{type:"null"}}const mc={ZodString:"string",ZodNumber:"number",ZodBigInt:"integer",ZodBoolean:"boolean",ZodNull:"null"};function M1(e,t){if(t.target==="openApi3")return Bg(e,t);const r=e.options instanceof Map?Array.from(e.options.values()):e.options;if(r.every(n=>n._def.typeName in mc&&(!n._def.checks||!n._def.checks.length))){const n=r.reduce((a,i)=>{const s=mc[i._def.typeName];return s&&!a.includes(s)?[...a,s]:a},[]);return{type:n.length>1?n:n[0]}}else if(r.every(n=>n._def.typeName==="ZodLiteral"&&!n.description)){const n=r.reduce((a,i)=>{const s=typeof i._def.value;switch(s){case"string":case"number":case"boolean":return[...a,s];case"bigint":return[...a,"integer"];case"object":return i._def.value===null?[...a,"null"]:a;case"symbol":case"undefined":case"function":default:return a}},[]);if(n.length===r.length){const a=n.filter((i,s,o)=>o.indexOf(i)===s);return{type:a.length>1?a:a[0],enum:r.reduce((i,s)=>i.includes(s._def.value)?i:[...i,s._def.value],[])}}}else if(r.every(n=>n._def.typeName==="ZodEnum"))return{type:"string",enum:r.reduce((n,a)=>[...n,...a._def.values.filter(i=>!n.includes(i))],[])};return Bg(e,t)}const Bg=(e,t)=>{const r=(e.options instanceof Map?Array.from(e.options.values()):e.options).map((n,a)=>Qe(n._def,{...t,currentPath:[...t.currentPath,"anyOf",`${a}`]})).filter(n=>!!n&&(!t.strictUnions||typeof n=="object"&&Object.keys(n).length>0));return r.length?{anyOf:r}:void 0};function j1(e,t){if(["ZodString","ZodNumber","ZodBigInt","ZodBoolean","ZodNull"].includes(e.innerType._def.typeName)&&(!e.innerType._def.checks||!e.innerType._def.checks.length))return t.target==="openApi3"?{type:mc[e.innerType._def.typeName],nullable:!0}:{type:[mc[e.innerType._def.typeName],"null"]};if(t.target==="openApi3"){const n=Qe(e.innerType._def,{...t,currentPath:[...t.currentPath]});return n&&"$ref"in n?{allOf:[n],nullable:!0}:n&&{...n,nullable:!0}}const r=Qe(e.innerType._def,{...t,currentPath:[...t.currentPath,"anyOf","0"]});return r&&{anyOf:[r,{type:"null"}]}}function F1(e,t){const r={type:"number"};if(!e.checks)return r;for(const n of e.checks)switch(n.kind){case"int":r.type="integer",fw(r,"type",n.message,t);break;case"min":t.target==="jsonSchema7"?n.inclusive?Ye(r,"minimum",n.value,n.message,t):Ye(r,"exclusiveMinimum",n.value,n.message,t):(n.inclusive||(r.exclusiveMinimum=!0),Ye(r,"minimum",n.value,n.message,t));break;case"max":t.target==="jsonSchema7"?n.inclusive?Ye(r,"maximum",n.value,n.message,t):Ye(r,"exclusiveMaximum",n.value,n.message,t):(n.inclusive||(r.exclusiveMaximum=!0),Ye(r,"maximum",n.value,n.message,t));break;case"multipleOf":Ye(r,"multipleOf",n.value,n.message,t);break}return r}function B1(e,t){const r=t.target==="openAi",n={type:"object",properties:{}},a=[],i=e.shape();for(const o in i){let c=i[o];if(c===void 0||c._def===void 0)continue;let u=z1(c);u&&r&&(c._def.typeName==="ZodOptional"&&(c=c._def.innerType),c.isNullable()||(c=c.nullable()),u=!1);const d=Qe(c._def,{...t,currentPath:[...t.currentPath,"properties",o],propertyPath:[...t.currentPath,"properties",o]});d!==void 0&&(n.properties[o]=d,u||a.push(o))}a.length&&(n.required=a);const s=U1(e,t);return s!==void 0&&(n.additionalProperties=s),n}function U1(e,t){if(e.catchall._def.typeName!=="ZodNever")return Qe(e.catchall._def,{...t,currentPath:[...t.currentPath,"additionalProperties"]});switch(e.unknownKeys){case"passthrough":return t.allowedAdditionalProperties;case"strict":return t.rejectedAdditionalProperties;case"strip":return t.removeAdditionalStrategy==="strict"?t.allowedAdditionalProperties:t.rejectedAdditionalProperties}}function z1(e){try{return e.isOptional()}catch{return!0}}const q1=(e,t)=>{if(t.currentPath.toString()===t.propertyPath?.toString())return Qe(e.innerType._def,t);const r=Qe(e.innerType._def,{...t,currentPath:[...t.currentPath,"anyOf","1"]});return r?{anyOf:[{not:Vt(t)},r]}:Vt(t)},H1=(e,t)=>{if(t.pipeStrategy==="input")return Qe(e.in._def,t);if(t.pipeStrategy==="output")return Qe(e.out._def,t);const r=Qe(e.in._def,{...t,currentPath:[...t.currentPath,"allOf","0"]}),n=Qe(e.out._def,{...t,currentPath:[...t.currentPath,"allOf",r?"1":"0"]});return{allOf:[r,n].filter(a=>a!==void 0)}};function K1(e,t){return Qe(e.type._def,t)}function G1(e,t){const n={type:"array",uniqueItems:!0,items:Qe(e.valueType._def,{...t,currentPath:[...t.currentPath,"items"]})};return e.minSize&&Ye(n,"minItems",e.minSize.value,e.minSize.message,t),e.maxSize&&Ye(n,"maxItems",e.maxSize.value,e.maxSize.message,t),n}function W1(e,t){return e.rest?{type:"array",minItems:e.items.length,items:e.items.map((r,n)=>Qe(r._def,{...t,currentPath:[...t.currentPath,"items",`${n}`]})).reduce((r,n)=>n===void 0?r:[...r,n],[]),additionalItems:Qe(e.rest._def,{...t,currentPath:[...t.currentPath,"additionalItems"]})}:{type:"array",minItems:e.items.length,maxItems:e.items.length,items:e.items.map((r,n)=>Qe(r._def,{...t,currentPath:[...t.currentPath,"items",`${n}`]})).reduce((r,n)=>n===void 0?r:[...r,n],[])}}function V1(e){return{not:Vt(e)}}function Z1(e){return Vt(e)}const J1=(e,t)=>Qe(e.innerType._def,t),Q1=(e,t,r)=>{switch(t){case ee.ZodString:return vw(e,r);case ee.ZodNumber:return F1(e,r);case ee.ZodObject:return B1(e,r);case ee.ZodBigInt:return b1(e,r);case ee.ZodBoolean:return E1();case ee.ZodDate:return yw(e,r);case ee.ZodUndefined:return V1(r);case ee.ZodNull:return L1(r);case ee.ZodArray:return w1(e,r);case ee.ZodUnion:case ee.ZodDiscriminatedUnion:return M1(e,r);case ee.ZodIntersection:return R1(e,r);case ee.ZodTuple:return W1(e,r);case ee.ZodRecord:return _w(e,r);case ee.ZodLiteral:return $1(e,r);case ee.ZodEnum:return O1(e);case ee.ZodNativeEnum:return N1(e);case ee.ZodNullable:return j1(e,r);case ee.ZodOptional:return q1(e,r);case ee.ZodMap:return P1(e,r);case ee.ZodSet:return G1(e,r);case ee.ZodLazy:return()=>e.getter()._def;case ee.ZodPromise:return K1(e,r);case ee.ZodNaN:case ee.ZodNever:return D1(r);case ee.ZodEffects:return I1(e,r);case ee.ZodAny:return Vt(r);case ee.ZodUnknown:return Z1(r);case ee.ZodDefault:return k1(e,r);case ee.ZodBranded:return gw(e,r);case ee.ZodReadonly:return J1(e,r);case ee.ZodCatch:return x1(e,r);case ee.ZodPipeline:return H1(e,r);case ee.ZodFunction:case ee.ZodVoid:case ee.ZodSymbol:return;default:return(n=>{})()}};function Qe(e,t,r=!1){const n=t.seen.get(e);if(t.override){const o=t.override?.(e,t,n,r);if(o!==zC)return o}if(n&&!r){const o=Y1(n,t);if(o!==void 0)return o}const a={def:e,path:t.currentPath,jsonSchema:void 0};t.seen.set(e,a);const i=Q1(e,e.typeName,t),s=typeof i=="function"?Qe(i(),t):i;if(s&&X1(e,t,s),t.postProcess){const o=t.postProcess(s,e,t);return a.jsonSchema=s,o}return a.jsonSchema=s,s}const Y1=(e,t)=>{switch(t.$refStrategy){case"root":return{$ref:e.path.join("/")};case"relative":return{$ref:dw(t.currentPath,e.path)};case"none":case"seen":return e.path.length<t.currentPath.length&&e.path.every((r,n)=>t.currentPath[n]===r)?(console.warn(`Recursive reference detected at ${t.currentPath.join("/")}! Defaulting to any`),Vt(t)):t.$refStrategy==="seen"?Vt(t):void 0}},X1=(e,t,r)=>(e.description&&(r.description=e.description,t.markdownDescription&&(r.markdownDescription=e.description)),r),eP=(e,t)=>{const r=KC(t);let n=typeof t=="object"&&t.definitions?Object.entries(t.definitions).reduce((o,[c,u])=>({...o,[c]:Qe(u._def,{...r,currentPath:[...r.basePath,r.definitionPath,c]},!0)??Vt(r)}),{}):void 0;const a=typeof t=="string"?t:t?.name,i=Qe(e._def,r,!1)??Vt(r);r.flags.hasReferencedOpenAiAnyType&&(n||(n={}),n[r.openAiAnyTypeName]||(n[r.openAiAnyTypeName]={type:["string","number","integer","boolean","array","null"],items:{$ref:r.$refStrategy==="relative"?"1":[...r.basePath,r.definitionPath,r.openAiAnyTypeName].join("/")}}));const s=a===void 0?n?{...i,[r.definitionPath]:n}:i:{$ref:[...r.$refStrategy==="relative"?[]:r.basePath,r.definitionPath,a].join("/"),[r.definitionPath]:{...n,[a]:i}};return r.target==="jsonSchema7"?s.$schema="http://json-schema.org/draft-07/schema#":(r.target==="jsonSchema2019-09"||r.target==="openAi")&&(s.$schema="https://json-schema.org/draft/2019-09/schema#"),r.target==="openAi"&&("anyOf"in s||"oneOf"in s||"allOf"in s||"type"in s&&Array.isArray(s.type))&&console.warn("Warning: OpenAI may not support schemas with unions as roots! Try wrapping it in an object property."),s};function Ya(e,t){const r=typeof e;if(r!==typeof t)return!1;if(Array.isArray(e)){if(!Array.isArray(t))return!1;const n=e.length;if(n!==t.length)return!1;for(let a=0;a<n;a++)if(!Ya(e[a],t[a]))return!1;return!0}if(r==="object"){if(!e||!t)return e===t;const n=Object.keys(e),a=Object.keys(t);if(n.length!==a.length)return!1;for(const s of n)if(!Ya(e[s],t[s]))return!1;return!0}return e===t}function Sr(e){return encodeURI(tP(e))}function tP(e){return e.replace(/~/g,"~0").replace(/\//g,"~1")}const rP={prefixItems:!0,items:!0,allOf:!0,anyOf:!0,oneOf:!0},nP={$defs:!0,definitions:!0,properties:!0,patternProperties:!0,dependentSchemas:!0},aP={id:!0,$id:!0,$ref:!0,$schema:!0,$anchor:!0,$vocabulary:!0,$comment:!0,default:!0,enum:!0,const:!0,required:!0,type:!0,maximum:!0,minimum:!0,exclusiveMaximum:!0,exclusiveMinimum:!0,multipleOf:!0,maxLength:!0,minLength:!0,pattern:!0,format:!0,maxItems:!0,minItems:!0,uniqueItems:!0,maxProperties:!0,minProperties:!0};let iP=typeof self<"u"&&self.location&&self.location.origin!=="null"?new URL(self.location.origin+self.location.pathname+location.search):new URL("https://github.com/cfworker");function $n(e,t=Object.create(null),r=iP,n=""){if(e&&typeof e=="object"&&!Array.isArray(e)){const i=e.$id||e.id;if(i){const s=new URL(i,r.href);s.hash.length>1?t[s.href]=e:(s.hash="",n===""?r=s:$n(e,t,r))}}else if(e!==!0&&e!==!1)return t;const a=r.href+(n?"#"+n:"");if(t[a]!==void 0)throw new Error(`Duplicate schema URI "${a}".`);if(t[a]=e,e===!0||e===!1)return t;if(e.__absolute_uri__===void 0&&Object.defineProperty(e,"__absolute_uri__",{enumerable:!1,value:a}),e.$ref&&e.__absolute_ref__===void 0){const i=new URL(e.$ref,r.href);i.hash=i.hash,Object.defineProperty(e,"__absolute_ref__",{enumerable:!1,value:i.href})}if(e.$recursiveRef&&e.__absolute_recursive_ref__===void 0){const i=new URL(e.$recursiveRef,r.href);i.hash=i.hash,Object.defineProperty(e,"__absolute_recursive_ref__",{enumerable:!1,value:i.href})}if(e.$anchor){const i=new URL("#"+e.$anchor,r.href);t[i.href]=e}for(let i in e){if(aP[i])continue;const s=`${n}/${Sr(i)}`,o=e[i];if(Array.isArray(o)){if(rP[i]){const c=o.length;for(let u=0;u<c;u++)$n(o[u],t,r,`${s}/${u}`)}}else if(nP[i])for(let c in o)$n(o[c],t,r,`${s}/${Sr(c)}`);else $n(o,t,r,s)}return t}const sP=/^(\d\d\d\d)-(\d\d)-(\d\d)$/,oP=[0,31,28,31,30,31,30,31,31,30,31,30,31],cP=/^(\d\d):(\d\d):(\d\d)(\.\d+)?(z|[+-]\d\d(?::?\d\d)?)?$/i,uP=/^(?=.{1,253}\.?$)[a-z0-9](?:[a-z0-9-]{0,61}[a-z0-9])?(?:\.[a-z0-9](?:[-0-9a-z]{0,61}[0-9a-z])?)*\.?$/i,lP=/^(?:[a-z][a-z0-9+\-.]*:)?(?:\/?\/(?:(?:[a-z0-9\-._~!$&'()*+,;=:]|%[0-9a-f]{2})*@)?(?:\[(?:(?:(?:(?:[0-9a-f]{1,4}:){6}|::(?:[0-9a-f]{1,4}:){5}|(?:[0-9a-f]{1,4})?::(?:[0-9a-f]{1,4}:){4}|(?:(?:[0-9a-f]{1,4}:){0,1}[0-9a-f]{1,4})?::(?:[0-9a-f]{1,4}:){3}|(?:(?:[0-9a-f]{1,4}:){0,2}[0-9a-f]{1,4})?::(?:[0-9a-f]{1,4}:){2}|(?:(?:[0-9a-f]{1,4}:){0,3}[0-9a-f]{1,4})?::[0-9a-f]{1,4}:|(?:(?:[0-9a-f]{1,4}:){0,4}[0-9a-f]{1,4})?::)(?:[0-9a-f]{1,4}:[0-9a-f]{1,4}|(?:(?:25[0-5]|2[0-4]\d|[01]?\d\d?)\.){3}(?:25[0-5]|2[0-4]\d|[01]?\d\d?))|(?:(?:[0-9a-f]{1,4}:){0,5}[0-9a-f]{1,4})?::[0-9a-f]{1,4}|(?:(?:[0-9a-f]{1,4}:){0,6}[0-9a-f]{1,4})?::)|[Vv][0-9a-f]+\.[a-z0-9\-._~!$&'()*+,;=:]+)\]|(?:(?:25[0-5]|2[0-4]\d|[01]?\d\d?)\.){3}(?:25[0-5]|2[0-4]\d|[01]?\d\d?)|(?:[a-z0-9\-._~!$&'"()*+,;=]|%[0-9a-f]{2})*)(?::\d*)?(?:\/(?:[a-z0-9\-._~!$&'"()*+,;=:@]|%[0-9a-f]{2})*)*|\/(?:(?:[a-z0-9\-._~!$&'"()*+,;=:@]|%[0-9a-f]{2})+(?:\/(?:[a-z0-9\-._~!$&'"()*+,;=:@]|%[0-9a-f]{2})*)*)?|(?:[a-z0-9\-._~!$&'"()*+,;=:@]|%[0-9a-f]{2})+(?:\/(?:[a-z0-9\-._~!$&'"()*+,;=:@]|%[0-9a-f]{2})*)*)?(?:\?(?:[a-z0-9\-._~!$&'"()*+,;=:@/?]|%[0-9a-f]{2})*)?(?:#(?:[a-z0-9\-._~!$&'"()*+,;=:@/?]|%[0-9a-f]{2})*)?$/i,dP=/^(?:(?:[^\x00-\x20"'<>%\\^`{|}]|%[0-9a-f]{2})|\{[+#./;?&=,!@|]?(?:[a-z0-9_]|%[0-9a-f]{2})+(?::[1-9][0-9]{0,3}|\*)?(?:,(?:[a-z0-9_]|%[0-9a-f]{2})+(?::[1-9][0-9]{0,3}|\*)?)*\})*$/i,fP=/^(?:(?:https?|ftp):\/\/)(?:\S+(?::\S*)?@)?(?:(?!10(?:\.\d{1,3}){3})(?!127(?:\.\d{1,3}){3})(?!169\.254(?:\.\d{1,3}){2})(?!192\.168(?:\.\d{1,3}){2})(?!172\.(?:1[6-9]|2\d|3[0-1])(?:\.\d{1,3}){2})(?:[1-9]\d?|1\d\d|2[01]\d|22[0-3])(?:\.(?:1?\d{1,2}|2[0-4]\d|25[0-5])){2}(?:\.(?:[1-9]\d?|1\d\d|2[0-4]\d|25[0-4]))|(?:(?:[a-z\u{00a1}-\u{ffff}0-9]+-?)*[a-z\u{00a1}-\u{ffff}0-9]+)(?:\.(?:[a-z\u{00a1}-\u{ffff}0-9]+-?)*[a-z\u{00a1}-\u{ffff}0-9]+)*(?:\.(?:[a-z\u{00a1}-\u{ffff}]{2,})))(?::\d{2,5})?(?:\/[^\s]*)?$/iu,hP=/^(?:urn:uuid:)?[0-9a-f]{8}-(?:[0-9a-f]{4}-){3}[0-9a-f]{12}$/i,pP=/^(?:\/(?:[^~/]|~0|~1)*)*$/,mP=/^#(?:\/(?:[a-z0-9_\-.!$&'()*+,;:=@]|%[0-9a-f]{2}|~0|~1)*)*$/i,gP=/^(?:0|[1-9][0-9]*)(?:#|(?:\/(?:[^~/]|~0|~1)*)*)$/,yP=e=>{if(e[0]==='"')return!1;const[t,r,...n]=e.split("@");return!t||!r||n.length!==0||t.length>64||r.length>253||t[0]==="."||t.endsWith(".")||t.includes("..")||!/^[a-z0-9.-]+$/i.test(r)||!/^[a-z0-9.!#$%&'*+/=?^_`{|}~-]+$/i.test(t)?!1:r.split(".").every(a=>/^[a-z0-9]([a-z0-9-]{0,61}[a-z0-9])?$/i.test(a))},vP=/^(?:(?:25[0-5]|2[0-4]\d|[01]?\d\d?)\.){3}(?:25[0-5]|2[0-4]\d|[01]?\d\d?)$/,_P=/^((([0-9a-f]{1,4}:){7}([0-9a-f]{1,4}|:))|(([0-9a-f]{1,4}:){6}(:[0-9a-f]{1,4}|((25[0-5]|2[0-4]\d|1\d\d|[1-9]?\d)(\.(25[0-5]|2[0-4]\d|1\d\d|[1-9]?\d)){3})|:))|(([0-9a-f]{1,4}:){5}(((:[0-9a-f]{1,4}){1,2})|:((25[0-5]|2[0-4]\d|1\d\d|[1-9]?\d)(\.(25[0-5]|2[0-4]\d|1\d\d|[1-9]?\d)){3})|:))|(([0-9a-f]{1,4}:){4}(((:[0-9a-f]{1,4}){1,3})|((:[0-9a-f]{1,4})?:((25[0-5]|2[0-4]\d|1\d\d|[1-9]?\d)(\.(25[0-5]|2[0-4]\d|1\d\d|[1-9]?\d)){3}))|:))|(([0-9a-f]{1,4}:){3}(((:[0-9a-f]{1,4}){1,4})|((:[0-9a-f]{1,4}){0,2}:((25[0-5]|2[0-4]\d|1\d\d|[1-9]?\d)(\.(25[0-5]|2[0-4]\d|1\d\d|[1-9]?\d)){3}))|:))|(([0-9a-f]{1,4}:){2}(((:[0-9a-f]{1,4}){1,5})|((:[0-9a-f]{1,4}){0,3}:((25[0-5]|2[0-4]\d|1\d\d|[1-9]?\d)(\.(25[0-5]|2[0-4]\d|1\d\d|[1-9]?\d)){3}))|:))|(([0-9a-f]{1,4}:){1}(((:[0-9a-f]{1,4}){1,6})|((:[0-9a-f]{1,4}){0,4}:((25[0-5]|2[0-4]\d|1\d\d|[1-9]?\d)(\.(25[0-5]|2[0-4]\d|1\d\d|[1-9]?\d)){3}))|:))|(:(((:[0-9a-f]{1,4}){1,7})|((:[0-9a-f]{1,4}){0,5}:((25[0-5]|2[0-4]\d|1\d\d|[1-9]?\d)(\.(25[0-5]|2[0-4]\d|1\d\d|[1-9]?\d)){3}))|:)))$/i,wP=e=>e.length>1&&e.length<80&&(/^P\d+([.,]\d+)?W$/.test(e)||/^P[\dYMDTHS]*(\d[.,]\d+)?[YMDHS]$/.test(e)&&/^P([.,\d]+Y)?([.,\d]+M)?([.,\d]+D)?(T([.,\d]+H)?([.,\d]+M)?([.,\d]+S)?)?$/.test(e));function jr(e){return e.test.bind(e)}const Ug={date:ww,time:bw.bind(void 0,!1),"date-time":xP,duration:wP,uri:IP,"uri-reference":jr(lP),"uri-template":jr(dP),url:jr(fP),email:yP,hostname:jr(uP),ipv4:jr(vP),ipv6:jr(_P),regex:TP,uuid:jr(hP),"json-pointer":jr(pP),"json-pointer-uri-fragment":jr(mP),"relative-json-pointer":jr(gP)};function bP(e){return e%4===0&&(e%100!==0||e%400===0)}function ww(e){const t=e.match(sP);if(!t)return!1;const r=+t[1],n=+t[2],a=+t[3];return n>=1&&n<=12&&a>=1&&a<=(n==2&&bP(r)?29:oP[n])}function bw(e,t){const r=t.match(cP);if(!r)return!1;const n=+r[1],a=+r[2],i=+r[3],s=!!r[5];return(n<=23&&a<=59&&i<=59||n==23&&a==59&&i==60)&&(!e||s)}const EP=/t|\s/i;function xP(e){const t=e.split(EP);return t.length==2&&ww(t[0])&&bw(!0,t[1])}const SP=/\/|:/,kP=/^(?:[a-z][a-z0-9+\-.]*:)(?:\/?\/(?:(?:[a-z0-9\-._~!$&'()*+,;=:]|%[0-9a-f]{2})*@)?(?:\[(?:(?:(?:(?:[0-9a-f]{1,4}:){6}|::(?:[0-9a-f]{1,4}:){5}|(?:[0-9a-f]{1,4})?::(?:[0-9a-f]{1,4}:){4}|(?:(?:[0-9a-f]{1,4}:){0,1}[0-9a-f]{1,4})?::(?:[0-9a-f]{1,4}:){3}|(?:(?:[0-9a-f]{1,4}:){0,2}[0-9a-f]{1,4})?::(?:[0-9a-f]{1,4}:){2}|(?:(?:[0-9a-f]{1,4}:){0,3}[0-9a-f]{1,4})?::[0-9a-f]{1,4}:|(?:(?:[0-9a-f]{1,4}:){0,4}[0-9a-f]{1,4})?::)(?:[0-9a-f]{1,4}:[0-9a-f]{1,4}|(?:(?:25[0-5]|2[0-4]\d|[01]?\d\d?)\.){3}(?:25[0-5]|2[0-4]\d|[01]?\d\d?))|(?:(?:[0-9a-f]{1,4}:){0,5}[0-9a-f]{1,4})?::[0-9a-f]{1,4}|(?:(?:[0-9a-f]{1,4}:){0,6}[0-9a-f]{1,4})?::)|[Vv][0-9a-f]+\.[a-z0-9\-._~!$&'()*+,;=:]+)\]|(?:(?:25[0-5]|2[0-4]\d|[01]?\d\d?)\.){3}(?:25[0-5]|2[0-4]\d|[01]?\d\d?)|(?:[a-z0-9\-._~!$&'()*+,;=]|%[0-9a-f]{2})*)(?::\d*)?(?:\/(?:[a-z0-9\-._~!$&'()*+,;=:@]|%[0-9a-f]{2})*)*|\/(?:(?:[a-z0-9\-._~!$&'()*+,;=:@]|%[0-9a-f]{2})+(?:\/(?:[a-z0-9\-._~!$&'()*+,;=:@]|%[0-9a-f]{2})*)*)?|(?:[a-z0-9\-._~!$&'()*+,;=:@]|%[0-9a-f]{2})+(?:\/(?:[a-z0-9\-._~!$&'()*+,;=:@]|%[0-9a-f]{2})*)*)(?:\?(?:[a-z0-9\-._~!$&'()*+,;=:@/?]|%[0-9a-f]{2})*)?(?:#(?:[a-z0-9\-._~!$&'()*+,;=:@/?]|%[0-9a-f]{2})*)?$/i;function IP(e){return SP.test(e)&&kP.test(e)}const OP=/[^\\]\\Z/;function TP(e){if(OP.test(e))return!1;try{return new RegExp(e,"u"),!0}catch{return!1}}function RP(e){let t=0,r=e.length,n=0,a;for(;n<r;)t++,a=e.charCodeAt(n++),a>=55296&&a<=56319&&n<r&&(a=e.charCodeAt(n),(a&64512)==56320&&n++);return t}function ot(e,t,r="2019-09",n=$n(t),a=!0,i=null,s="#",o="#",c=Object.create(null)){if(t===!0)return{valid:!0,errors:[]};if(t===!1)return{valid:!1,errors:[{instanceLocation:s,keyword:"false",keywordLocation:s,error:"False boolean schema."}]};const u=typeof e;let d;switch(u){case"boolean":case"number":case"string":d=u;break;case"object":e===null?d="null":Array.isArray(e)?d="array":d="object";break;default:throw new Error(`Instances of "${u}" type are not supported.`)}const{$ref:h,$recursiveRef:p,$recursiveAnchor:y,type:g,const:w,enum:b,required:x,not:O,anyOf:T,allOf:B,oneOf:U,if:K,then:q,else:G,format:Oe,properties:Me,patternProperties:qe,additionalProperties:Ae,unevaluatedProperties:Ve,minProperties:Y,maxProperties:H,propertyNames:fe,dependentRequired:J,dependentSchemas:te,dependencies:Q,prefixItems:re,items:xe,additionalItems:Re,unevaluatedItems:Te,contains:Ge,minContains:je,maxContains:_t,minItems:zn,maxItems:wi,uniqueItems:we,minimum:Pr,maximum:dr,exclusiveMinimum:Ke,exclusiveMaximum:br,multipleOf:Ra,minLength:fr,maxLength:$a,pattern:js,__absolute_ref__:Aa,__absolute_recursive_ref__:jc}=t,ce=[];if(y===!0&&i===null&&(i=t),p==="#"){const ke=i===null?n[jc]:i,me=`${o}/$recursiveRef`,$e=ot(e,i===null?t:i,r,n,a,ke,s,me,c);$e.valid||ce.push({instanceLocation:s,keyword:"$recursiveRef",keywordLocation:me,error:"A subschema had errors."},...$e.errors)}if(h!==void 0){const me=n[Aa||h];if(me===void 0){let ae=`Unresolved $ref "${h}".`;throw Aa&&Aa!==h&&(ae+=`  Absolute URI "${Aa}".`),ae+=`
Known schemas:
- ${Object.keys(n).join(`
- `)}`,new Error(ae)}const $e=`${o}/$ref`,ue=ot(e,me,r,n,a,i,s,$e,c);if(ue.valid||ce.push({instanceLocation:s,keyword:"$ref",keywordLocation:$e,error:"A subschema had errors."},...ue.errors),r==="4"||r==="7")return{valid:ce.length===0,errors:ce}}if(Array.isArray(g)){let ke=g.length,me=!1;for(let $e=0;$e<ke;$e++)if(d===g[$e]||g[$e]==="integer"&&d==="number"&&e%1===0&&e===e){me=!0;break}me||ce.push({instanceLocation:s,keyword:"type",keywordLocation:`${o}/type`,error:`Instance type "${d}" is invalid. Expected "${g.join('", "')}".`})}else g==="integer"?(d!=="number"||e%1||e!==e)&&ce.push({instanceLocation:s,keyword:"type",keywordLocation:`${o}/type`,error:`Instance type "${d}" is invalid. Expected "${g}".`}):g!==void 0&&d!==g&&ce.push({instanceLocation:s,keyword:"type",keywordLocation:`${o}/type`,error:`Instance type "${d}" is invalid. Expected "${g}".`});if(w!==void 0&&(d==="object"||d==="array"?Ya(e,w)||ce.push({instanceLocation:s,keyword:"const",keywordLocation:`${o}/const`,error:`Instance does not match ${JSON.stringify(w)}.`}):e!==w&&ce.push({instanceLocation:s,keyword:"const",keywordLocation:`${o}/const`,error:`Instance does not match ${JSON.stringify(w)}.`})),b!==void 0&&(d==="object"||d==="array"?b.some(ke=>Ya(e,ke))||ce.push({instanceLocation:s,keyword:"enum",keywordLocation:`${o}/enum`,error:`Instance does not match any of ${JSON.stringify(b)}.`}):b.some(ke=>e===ke)||ce.push({instanceLocation:s,keyword:"enum",keywordLocation:`${o}/enum`,error:`Instance does not match any of ${JSON.stringify(b)}.`})),O!==void 0){const ke=`${o}/not`;ot(e,O,r,n,a,i,s,ke).valid&&ce.push({instanceLocation:s,keyword:"not",keywordLocation:ke,error:'Instance matched "not" schema.'})}let Lt=[];if(T!==void 0){const ke=`${o}/anyOf`,me=ce.length;let $e=!1;for(let ue=0;ue<T.length;ue++){const ae=T[ue],Ie=Object.create(c),Se=ot(e,ae,r,n,a,y===!0?i:null,s,`${ke}/${ue}`,Ie);ce.push(...Se.errors),$e=$e||Se.valid,Se.valid&&Lt.push(Ie)}$e?ce.length=me:ce.splice(me,0,{instanceLocation:s,keyword:"anyOf",keywordLocation:ke,error:"Instance does not match any subschemas."})}if(B!==void 0){const ke=`${o}/allOf`,me=ce.length;let $e=!0;for(let ue=0;ue<B.length;ue++){const ae=B[ue],Ie=Object.create(c),Se=ot(e,ae,r,n,a,y===!0?i:null,s,`${ke}/${ue}`,Ie);ce.push(...Se.errors),$e=$e&&Se.valid,Se.valid&&Lt.push(Ie)}$e?ce.length=me:ce.splice(me,0,{instanceLocation:s,keyword:"allOf",keywordLocation:ke,error:"Instance does not match every subschema."})}if(U!==void 0){const ke=`${o}/oneOf`,me=ce.length,$e=U.filter((ue,ae)=>{const Ie=Object.create(c),Se=ot(e,ue,r,n,a,y===!0?i:null,s,`${ke}/${ae}`,Ie);return ce.push(...Se.errors),Se.valid&&Lt.push(Ie),Se.valid}).length;$e===1?ce.length=me:ce.splice(me,0,{instanceLocation:s,keyword:"oneOf",keywordLocation:ke,error:`Instance does not match exactly one subschema (${$e} matches).`})}if((d==="object"||d==="array")&&Object.assign(c,...Lt),K!==void 0){const ke=`${o}/if`;if(ot(e,K,r,n,a,i,s,ke,c).valid){if(q!==void 0){const $e=ot(e,q,r,n,a,i,s,`${o}/then`,c);$e.valid||ce.push({instanceLocation:s,keyword:"if",keywordLocation:ke,error:'Instance does not match "then" schema.'},...$e.errors)}}else if(G!==void 0){const $e=ot(e,G,r,n,a,i,s,`${o}/else`,c);$e.valid||ce.push({instanceLocation:s,keyword:"if",keywordLocation:ke,error:'Instance does not match "else" schema.'},...$e.errors)}}if(d==="object"){if(x!==void 0)for(const ue of x)ue in e||ce.push({instanceLocation:s,keyword:"required",keywordLocation:`${o}/required`,error:`Instance does not have required property "${ue}".`});const ke=Object.keys(e);if(Y!==void 0&&ke.length<Y&&ce.push({instanceLocation:s,keyword:"minProperties",keywordLocation:`${o}/minProperties`,error:`Instance does not have at least ${Y} properties.`}),H!==void 0&&ke.length>H&&ce.push({instanceLocation:s,keyword:"maxProperties",keywordLocation:`${o}/maxProperties`,error:`Instance does not have at least ${H} properties.`}),fe!==void 0){const ue=`${o}/propertyNames`;for(const ae in e){const Ie=`${s}/${Sr(ae)}`,Se=ot(ae,fe,r,n,a,i,Ie,ue);Se.valid||ce.push({instanceLocation:s,keyword:"propertyNames",keywordLocation:ue,error:`Property name "${ae}" does not match schema.`},...Se.errors)}}if(J!==void 0){const ue=`${o}/dependantRequired`;for(const ae in J)if(ae in e){const Ie=J[ae];for(const Se of Ie)Se in e||ce.push({instanceLocation:s,keyword:"dependentRequired",keywordLocation:ue,error:`Instance has "${ae}" but does not have "${Se}".`})}}if(te!==void 0)for(const ue in te){const ae=`${o}/dependentSchemas`;if(ue in e){const Ie=ot(e,te[ue],r,n,a,i,s,`${ae}/${Sr(ue)}`,c);Ie.valid||ce.push({instanceLocation:s,keyword:"dependentSchemas",keywordLocation:ae,error:`Instance has "${ue}" but does not match dependant schema.`},...Ie.errors)}}if(Q!==void 0){const ue=`${o}/dependencies`;for(const ae in Q)if(ae in e){const Ie=Q[ae];if(Array.isArray(Ie))for(const Se of Ie)Se in e||ce.push({instanceLocation:s,keyword:"dependencies",keywordLocation:ue,error:`Instance has "${ae}" but does not have "${Se}".`});else{const Se=ot(e,Ie,r,n,a,i,s,`${ue}/${Sr(ae)}`);Se.valid||ce.push({instanceLocation:s,keyword:"dependencies",keywordLocation:ue,error:`Instance has "${ae}" but does not match dependant schema.`},...Se.errors)}}}const me=Object.create(null);let $e=!1;if(Me!==void 0){const ue=`${o}/properties`;for(const ae in Me){if(!(ae in e))continue;const Ie=`${s}/${Sr(ae)}`,Se=ot(e[ae],Me[ae],r,n,a,i,Ie,`${ue}/${Sr(ae)}`);if(Se.valid)c[ae]=me[ae]=!0;else if($e=a,ce.push({instanceLocation:s,keyword:"properties",keywordLocation:ue,error:`Property "${ae}" does not match schema.`},...Se.errors),$e)break}}if(!$e&&qe!==void 0){const ue=`${o}/patternProperties`;for(const ae in qe){const Ie=new RegExp(ae,"u"),Se=qe[ae];for(const xt in e){if(!Ie.test(xt))continue;const qn=`${s}/${Sr(xt)}`,Nr=ot(e[xt],Se,r,n,a,i,qn,`${ue}/${Sr(ae)}`);Nr.valid?c[xt]=me[xt]=!0:($e=a,ce.push({instanceLocation:s,keyword:"patternProperties",keywordLocation:ue,error:`Property "${xt}" matches pattern "${ae}" but does not match associated schema.`},...Nr.errors))}}}if(!$e&&Ae!==void 0){const ue=`${o}/additionalProperties`;for(const ae in e){if(me[ae])continue;const Ie=`${s}/${Sr(ae)}`,Se=ot(e[ae],Ae,r,n,a,i,Ie,ue);Se.valid?c[ae]=!0:($e=a,ce.push({instanceLocation:s,keyword:"additionalProperties",keywordLocation:ue,error:`Property "${ae}" does not match additional properties schema.`},...Se.errors))}}else if(!$e&&Ve!==void 0){const ue=`${o}/unevaluatedProperties`;for(const ae in e)if(!c[ae]){const Ie=`${s}/${Sr(ae)}`,Se=ot(e[ae],Ve,r,n,a,i,Ie,ue);Se.valid?c[ae]=!0:ce.push({instanceLocation:s,keyword:"unevaluatedProperties",keywordLocation:ue,error:`Property "${ae}" does not match unevaluated properties schema.`},...Se.errors)}}}else if(d==="array"){wi!==void 0&&e.length>wi&&ce.push({instanceLocation:s,keyword:"maxItems",keywordLocation:`${o}/maxItems`,error:`Array has too many items (${e.length} > ${wi}).`}),zn!==void 0&&e.length<zn&&ce.push({instanceLocation:s,keyword:"minItems",keywordLocation:`${o}/minItems`,error:`Array has too few items (${e.length} < ${zn}).`});const ke=e.length;let me=0,$e=!1;if(re!==void 0){const ue=`${o}/prefixItems`,ae=Math.min(re.length,ke);for(;me<ae;me++){const Ie=ot(e[me],re[me],r,n,a,i,`${s}/${me}`,`${ue}/${me}`);if(c[me]=!0,!Ie.valid&&($e=a,ce.push({instanceLocation:s,keyword:"prefixItems",keywordLocation:ue,error:"Items did not match schema."},...Ie.errors),$e))break}}if(xe!==void 0){const ue=`${o}/items`;if(Array.isArray(xe)){const ae=Math.min(xe.length,ke);for(;me<ae;me++){const Ie=ot(e[me],xe[me],r,n,a,i,`${s}/${me}`,`${ue}/${me}`);if(c[me]=!0,!Ie.valid&&($e=a,ce.push({instanceLocation:s,keyword:"items",keywordLocation:ue,error:"Items did not match schema."},...Ie.errors),$e))break}}else for(;me<ke;me++){const ae=ot(e[me],xe,r,n,a,i,`${s}/${me}`,ue);if(c[me]=!0,!ae.valid&&($e=a,ce.push({instanceLocation:s,keyword:"items",keywordLocation:ue,error:"Items did not match schema."},...ae.errors),$e))break}if(!$e&&Re!==void 0){const ae=`${o}/additionalItems`;for(;me<ke;me++){const Ie=ot(e[me],Re,r,n,a,i,`${s}/${me}`,ae);c[me]=!0,Ie.valid||($e=a,ce.push({instanceLocation:s,keyword:"additionalItems",keywordLocation:ae,error:"Items did not match additional items schema."},...Ie.errors))}}}if(Ge!==void 0)if(ke===0&&je===void 0)ce.push({instanceLocation:s,keyword:"contains",keywordLocation:`${o}/contains`,error:"Array is empty. It must contain at least one item matching the schema."});else if(je!==void 0&&ke<je)ce.push({instanceLocation:s,keyword:"minContains",keywordLocation:`${o}/minContains`,error:`Array has less items (${ke}) than minContains (${je}).`});else{const ue=`${o}/contains`,ae=ce.length;let Ie=0;for(let Se=0;Se<ke;Se++){const xt=ot(e[Se],Ge,r,n,a,i,`${s}/${Se}`,ue);xt.valid?(c[Se]=!0,Ie++):ce.push(...xt.errors)}Ie>=(je||0)&&(ce.length=ae),je===void 0&&_t===void 0&&Ie===0?ce.splice(ae,0,{instanceLocation:s,keyword:"contains",keywordLocation:ue,error:"Array does not contain item matching schema."}):je!==void 0&&Ie<je?ce.push({instanceLocation:s,keyword:"minContains",keywordLocation:`${o}/minContains`,error:`Array must contain at least ${je} items matching schema. Only ${Ie} items were found.`}):_t!==void 0&&Ie>_t&&ce.push({instanceLocation:s,keyword:"maxContains",keywordLocation:`${o}/maxContains`,error:`Array may contain at most ${_t} items matching schema. ${Ie} items were found.`})}if(!$e&&Te!==void 0){const ue=`${o}/unevaluatedItems`;for(me;me<ke;me++){if(c[me])continue;const ae=ot(e[me],Te,r,n,a,i,`${s}/${me}`,ue);c[me]=!0,ae.valid||ce.push({instanceLocation:s,keyword:"unevaluatedItems",keywordLocation:ue,error:"Items did not match unevaluated items schema."},...ae.errors)}}if(we)for(let ue=0;ue<ke;ue++){const ae=e[ue],Ie=typeof ae=="object"&&ae!==null;for(let Se=0;Se<ke;Se++){if(ue===Se)continue;const xt=e[Se];(ae===xt||Ie&&(typeof xt=="object"&&xt!==null)&&Ya(ae,xt))&&(ce.push({instanceLocation:s,keyword:"uniqueItems",keywordLocation:`${o}/uniqueItems`,error:`Duplicate items at indexes ${ue} and ${Se}.`}),ue=Number.MAX_SAFE_INTEGER,Se=Number.MAX_SAFE_INTEGER)}}}else if(d==="number"){if(r==="4"?(Pr!==void 0&&(Ke===!0&&e<=Pr||e<Pr)&&ce.push({instanceLocation:s,keyword:"minimum",keywordLocation:`${o}/minimum`,error:`${e} is less than ${Ke?"or equal to ":""} ${Pr}.`}),dr!==void 0&&(br===!0&&e>=dr||e>dr)&&ce.push({instanceLocation:s,keyword:"maximum",keywordLocation:`${o}/maximum`,error:`${e} is greater than ${br?"or equal to ":""} ${dr}.`})):(Pr!==void 0&&e<Pr&&ce.push({instanceLocation:s,keyword:"minimum",keywordLocation:`${o}/minimum`,error:`${e} is less than ${Pr}.`}),dr!==void 0&&e>dr&&ce.push({instanceLocation:s,keyword:"maximum",keywordLocation:`${o}/maximum`,error:`${e} is greater than ${dr}.`}),Ke!==void 0&&e<=Ke&&ce.push({instanceLocation:s,keyword:"exclusiveMinimum",keywordLocation:`${o}/exclusiveMinimum`,error:`${e} is less than ${Ke}.`}),br!==void 0&&e>=br&&ce.push({instanceLocation:s,keyword:"exclusiveMaximum",keywordLocation:`${o}/exclusiveMaximum`,error:`${e} is greater than or equal to ${br}.`})),Ra!==void 0){const ke=e%Ra;Math.abs(0-ke)>=11920929e-14&&Math.abs(Ra-ke)>=11920929e-14&&ce.push({instanceLocation:s,keyword:"multipleOf",keywordLocation:`${o}/multipleOf`,error:`${e} is not a multiple of ${Ra}.`})}}else if(d==="string"){const ke=fr===void 0&&$a===void 0?0:RP(e);fr!==void 0&&ke<fr&&ce.push({instanceLocation:s,keyword:"minLength",keywordLocation:`${o}/minLength`,error:`String is too short (${ke} < ${fr}).`}),$a!==void 0&&ke>$a&&ce.push({instanceLocation:s,keyword:"maxLength",keywordLocation:`${o}/maxLength`,error:`String is too long (${ke} > ${$a}).`}),js!==void 0&&!new RegExp(js,"u").test(e)&&ce.push({instanceLocation:s,keyword:"pattern",keywordLocation:`${o}/pattern`,error:"String does not match pattern."}),Oe!==void 0&&Ug[Oe]&&!Ug[Oe](e)&&ce.push({instanceLocation:s,keyword:"format",keywordLocation:`${o}/format`,error:`String does not match format "${Oe}".`})}return{valid:ce.length===0,errors:ce}}class $P{schema;draft;shortCircuit;lookup;constructor(t,r="2019-09",n=!0){this.schema=t,this.draft=r,this.shortCircuit=n,this.lookup=$n(t)}validate(t){return ot(t,this.schema,this.draft,this.lookup,this.shortCircuit)}addSchema(t,r){r&&(t={...t,$id:r}),$n(t,this.lookup)}}var AP={};Et(AP,{Validator:()=>$P,deepCompareStrict:()=>Ya,toJsonSchema:()=>Ew,validatesOnlyStrings:()=>Uo});function Ew(e){if(mn(e)){const t=zi(e,!0);if(Yi(t)){const r=jd(t,!0);return Eg(r)}else return Eg(e)}return Un(e)?eP(e):e}function Uo(e){if(!e||typeof e!="object"||Object.keys(e).length===0||Array.isArray(e))return!1;if("type"in e)return typeof e.type=="string"?e.type==="string":Array.isArray(e.type)?e.type.every(t=>t==="string"):!1;if("enum"in e)return Array.isArray(e.enum)&&e.enum.length>0&&e.enum.every(t=>typeof t=="string");if("const"in e)return typeof e.const=="string";if("allOf"in e&&Array.isArray(e.allOf))return e.allOf.some(t=>Uo(t));if("anyOf"in e&&Array.isArray(e.anyOf)||"oneOf"in e&&Array.isArray(e.oneOf)){const t="anyOf"in e?e.anyOf:e.oneOf;return t.length>0&&t.every(r=>Uo(r))}if("not"in e)return!1;if("$ref"in e&&typeof e.$ref=="string"){const t=e.$ref,r=$n(e);return r[t]?Uo(r[t]):!1}return!1}var CP={};Et(CP,{Graph:()=>Jf});function PP(e,t){if(e!==void 0&&!Mo(e))return e;if(Kf(t))try{let r=t.getName();return r=r.startsWith("Runnable")?r.slice(8):r,r}catch{return t.getName()}else return t.name??"UnknownSchema"}function NP(e){return Kf(e.data)?{type:"runnable",data:{id:e.data.lc_id,name:e.data.getName()}}:{type:"schema",data:{...Ew(e.data.schema),title:e.data.name}}}var Jf=class xw{nodes={};edges=[];constructor(t){this.nodes=t?.nodes??this.nodes,this.edges=t?.edges??this.edges}toJSON(){const t={};return Object.values(this.nodes).forEach((r,n)=>{t[r.id]=Mo(r.id)?n:r.id}),{nodes:Object.values(this.nodes).map(r=>({id:t[r.id],...NP(r)})),edges:this.edges.map(r=>{const n={source:t[r.source],target:t[r.target]};return typeof r.data<"u"&&(n.data=r.data),typeof r.conditional<"u"&&(n.conditional=r.conditional),n})}}addNode(t,r,n){if(r!==void 0&&this.nodes[r]!==void 0)throw new Error(`Node with id ${r} already exists`);const a=r??Yr(),i={id:a,data:t,name:PP(r,t),metadata:n};return this.nodes[a]=i,i}removeNode(t){delete this.nodes[t.id],this.edges=this.edges.filter(r=>r.source!==t.id&&r.target!==t.id)}addEdge(t,r,n,a){if(this.nodes[t.id]===void 0)throw new Error(`Source node ${t.id} not in graph`);if(this.nodes[r.id]===void 0)throw new Error(`Target node ${r.id} not in graph`);const i={source:t.id,target:r.id,data:n,conditional:a};return this.edges.push(i),i}firstNode(){return zg(this)}lastNode(){return qg(this)}extend(t,r=""){let n=r;Object.values(t.nodes).map(u=>u.id).every(Mo)&&(n="");const i=u=>n?`${n}:${u}`:u;Object.entries(t.nodes).forEach(([u,d])=>{this.nodes[i(u)]={...d,id:i(u)}});const s=t.edges.map(u=>({...u,source:i(u.source),target:i(u.target)}));this.edges=[...this.edges,...s];const o=t.firstNode(),c=t.lastNode();return[o?{id:i(o.id),data:o.data}:void 0,c?{id:i(c.id),data:c.data}:void 0]}trimFirstNode(){const t=this.firstNode();t&&zg(this,[t.id])&&this.removeNode(t)}trimLastNode(){const t=this.lastNode();t&&qg(this,[t.id])&&this.removeNode(t)}reid(){const t=Object.fromEntries(Object.values(this.nodes).map(a=>[a.id,a.name])),r=new Map;Object.values(t).forEach(a=>{r.set(a,(r.get(a)||0)+1)});const n=a=>{const i=t[a];return Mo(a)&&r.get(i)===1?i:a};return new xw({nodes:Object.fromEntries(Object.entries(this.nodes).map(([a,i])=>[n(a),{...i,id:n(a)}])),edges:this.edges.map(a=>({...a,source:n(a.source),target:n(a.target)}))})}drawMermaid(t){const{withStyles:r,curveStyle:n,nodeColors:a={default:"fill:#f2f0ff,line-height:1.2",first:"fill-opacity:0",last:"fill:#bfb6fc"},wrapLabelNWords:i}=t??{},s=this.reid(),o=s.firstNode(),c=s.lastNode();return BC(s.nodes,s.edges,{firstNode:o?.id,lastNode:c?.id,withStyles:r,curveStyle:n,nodeColors:a,wrapLabelNWords:i})}async drawMermaidPng(t){const r=this.drawMermaid(t);return UC(r,{backgroundColor:t?.backgroundColor})}};function zg(e,t=[]){const r=new Set(e.edges.filter(a=>!t.includes(a.source)).map(a=>a.target)),n=[];for(const a of Object.values(e.nodes))!t.includes(a.id)&&!r.has(a.id)&&n.push(a);return n.length===1?n[0]:void 0}function qg(e,t=[]){const r=new Set(e.edges.filter(a=>!t.includes(a.target)).map(a=>a.source)),n=[];for(const a of Object.values(e.nodes))!t.includes(a.id)&&!r.has(a.id)&&n.push(a);return n.length===1?n[0]:void 0}function DP(e){const t=new TextEncoder,r=new ReadableStream({async start(n){for await(const a of e)n.enqueue(t.encode(`event: data
data: ${JSON.stringify(a)}

`));n.enqueue(t.encode(`event: end

`)),n.close()}});return Rr.fromReadableStream(r)}function Hg(e){return typeof e=="object"&&e!==null&&typeof e[Symbol.iterator]=="function"&&typeof e.next=="function"}const LP=e=>e!=null&&typeof e=="object"&&"next"in e&&typeof e.next=="function";function Kd(e){return typeof e=="object"&&e!==null&&typeof e[Symbol.asyncIterator]=="function"}function*Kg(e,t){for(;;){const{value:r,done:n}=fn.runWithConfig(oi(e),t.next.bind(t),!0);if(n)break;yield r}}async function*Gd(e,t){const r=t[Symbol.asyncIterator]();for(;;){const{value:n,done:a}=await fn.runWithConfig(oi(e),r.next.bind(t),!0);if(a)break;yield n}}function It(e,t){return e&&!Array.isArray(e)&&!(e instanceof Date)&&typeof e=="object"?e:{[t]:e}}var Gt=class extends us{lc_runnable=!0;name;getName(e){const t=this.name??this.constructor.lc_name()??this.constructor.name;return e?`${t}${e}`:t}withRetry(e){return new kw({bound:this,kwargs:{},config:{},maxAttemptNumber:e?.stopAfterAttempt,...e})}withConfig(e){return new gc({bound:this,config:e,kwargs:{}})}withFallbacks(e){const t=Array.isArray(e)?e:e.fallbacks;return new FP({runnable:this,fallbacks:t})}_getOptionsList(e,t=0){if(Array.isArray(e)&&e.length!==t)throw new Error(`Passed "options" must be an array with the same length as the inputs, but got ${e.length} options for ${t} inputs`);if(Array.isArray(e))return e.map(Xe);if(t>1&&!Array.isArray(e)&&e.runId){console.warn("Provided runId will be used only for the first element of the batch.");const r=Object.fromEntries(Object.entries(e).filter(([n])=>n!=="runId"));return Array.from({length:t},(n,a)=>Xe(a===0?e:r))}return Array.from({length:t},()=>Xe(e))}async batch(e,t,r){const n=this._getOptionsList(t??{},e.length),a=n[0]?.maxConcurrency??r?.maxConcurrency,i=new Hf({maxConcurrency:a,onFailedAttempt:o=>{throw o}}),s=e.map((o,c)=>i.call(async()=>{try{return await this.invoke(o,n[c])}catch(u){if(r?.returnExceptions)return u;throw u}}));return Promise.all(s)}async*_streamIterator(e,t){yield this.invoke(e,t)}async stream(e,t){const r=Xe(t),n=new Ta({generator:this._streamIterator(e,r),config:r});return await n.setup,Rr.fromAsyncGenerator(n)}_separateRunnableConfigFromCallOptions(e){let t;e===void 0?t=Xe(e):t=Xe({callbacks:e.callbacks,tags:e.tags,metadata:e.metadata,runName:e.runName,configurable:e.configurable,recursionLimit:e.recursionLimit,maxConcurrency:e.maxConcurrency,runId:e.runId,timeout:e.timeout,signal:e.signal});const r={...e};return delete r.callbacks,delete r.tags,delete r.metadata,delete r.runName,delete r.configurable,delete r.recursionLimit,delete r.maxConcurrency,delete r.runId,delete r.timeout,delete r.signal,[t,r]}async _callWithConfig(e,t,r){const n=Xe(r),i=await(await Tr(n))?.handleChainStart(this.toJSON(),It(t,"input"),n.runId,n?.runType,void 0,void 0,n?.runName??this.getName());delete n.runId;let s;try{const o=e.call(this,t,n,i);s=await Mn(o,r?.signal)}catch(o){throw await i?.handleChainError(o),o}return await i?.handleChainEnd(It(s,"output")),s}async _batchWithConfig(e,t,r,n){const a=this._getOptionsList(r??{},t.length),i=await Promise.all(a.map(Tr)),s=await Promise.all(i.map(async(c,u)=>{const d=await c?.handleChainStart(this.toJSON(),It(t[u],"input"),a[u].runId,a[u].runType,void 0,void 0,a[u].runName??this.getName());return delete a[u].runId,d}));let o;try{const c=e.call(this,t,a,s,n);o=await Mn(c,a?.[0]?.signal)}catch(c){throw await Promise.all(s.map(u=>u?.handleChainError(c))),c}return await Promise.all(s.map(c=>c?.handleChainEnd(It(o,"output")))),o}_concatOutputChunks(e,t){return zf(e,t)}async*_transformStreamWithConfig(e,t,r){let n,a=!0,i,s=!0;const o=Xe(r),c=await Tr(o),u=this;async function*d(){for await(const p of e){if(a)if(n===void 0)n=p;else try{n=u._concatOutputChunks(n,p)}catch{n=void 0,a=!1}yield p}}let h;try{const p=await tw(t.bind(this),d(),async()=>c?.handleChainStart(this.toJSON(),{input:""},o.runId,o.runType,void 0,void 0,o.runName??this.getName()),r?.signal,o);delete o.runId,h=p.setup;const y=h?.handlers.find(uC);let g=p.output;y!==void 0&&h!==void 0&&(g=y.tapOutputIterable(h.runId,g));const w=h?.handlers.find(aw);w!==void 0&&h!==void 0&&(g=w.tapOutputIterable(h.runId,g));for await(const b of g)if(yield b,s)if(i===void 0)i=b;else try{i=this._concatOutputChunks(i,b)}catch{i=void 0,s=!1}}catch(p){throw await h?.handleChainError(p,void 0,void 0,void 0,{inputs:It(n,"input")}),p}await h?.handleChainEnd(i??{},void 0,void 0,void 0,{inputs:It(n,"input")})}getGraph(e){const t=new Jf,r=t.addNode({name:`${this.getName()}Input`,schema:jg()}),n=t.addNode(this),a=t.addNode({name:`${this.getName()}Output`,schema:jg()});return t.addEdge(r,n),t.addEdge(n,a),t}pipe(e){return new Iw({first:this,last:ia(e)})}pick(e){return this.pipe(new UP(e))}assign(e){return this.pipe(new BP(new Qf({steps:e})))}async*transform(e,t){let r;for await(const n of e)r===void 0?r=n:r=this._concatOutputChunks(r,n);yield*this._streamIterator(r,Xe(t))}async*streamLog(e,t,r){const n=new Md({...r,autoClose:!1,_schemaFormat:"original"}),a=Xe(t);yield*this._streamLog(e,n,a)}async*_streamLog(e,t,r){const{callbacks:n}=r;if(n===void 0)r.callbacks=[t];else if(Array.isArray(n))r.callbacks=n.concat([t]);else{const o=n.copy();o.addHandler(t,!0),r.callbacks=o}const a=this.stream(e,r);async function i(){try{const o=await a;for await(const c of o){const u=new Xr({ops:[{op:"add",path:"/streamed_output/-",value:c}]});await t.writer.write(u)}}finally{await t.writer.close()}}const s=i();try{for await(const o of t)yield o}finally{await s}}streamEvents(e,t,r){let n;if(t.version==="v1")n=this._streamEventsV1(e,t,r);else if(t.version==="v2")n=this._streamEventsV2(e,t,r);else throw new Error('Only versions "v1" and "v2" of the schema are currently supported.');return t.encoding==="text/event-stream"?DP(n):Rr.fromAsyncGenerator(n)}async*_streamEventsV2(e,t,r){const n=new lC({...r,autoClose:!1}),a=Xe(t),i=a.runId??Yr();a.runId=i;const s=a.callbacks;if(s===void 0)a.callbacks=[n];else if(Array.isArray(s))a.callbacks=s.concat(n);else{const y=s.copy();y.addHandler(n,!0),a.callbacks=y}const o=new AbortController,c=this;async function u(){let y,g=null;try{t?.signal?"any"in AbortSignal?y=AbortSignal.any([o.signal,t.signal]):(y=t.signal,g=()=>{o.abort()},t.signal.addEventListener("abort",g,{once:!0})):y=o.signal;const w=await c.stream(e,{...a,signal:y}),b=n.tapOutputIterable(i,w);for await(const x of b)if(o.signal.aborted)break}finally{await n.finish(),y&&g&&y.removeEventListener("abort",g)}}const d=u();let h=!1,p;try{for await(const y of n){if(!h){y.data.input=e,h=!0,p=y.run_id,yield y;continue}y.run_id===p&&y.event.endsWith("_end")&&y.data?.input&&delete y.data.input,yield y}}finally{o.abort(),await d}}async*_streamEventsV1(e,t,r){let n,a=!1;const i=Xe(t),s=i.tags??[],o=i.metadata??{},c=i.runName??this.getName(),u=new Md({...r,autoClose:!1,_schemaFormat:"streaming_events"}),d=new pC({...r}),h=this._streamLog(e,u,i);for await(const y of h){if(n?n=n.concat(y):n=qf.fromRunLogPatch(y),n.state===void 0)throw new Error('Internal error: "streamEvents" state is missing. Please open a bug report.');if(!a){a=!0;const x={...n.state},O={run_id:x.id,event:`on_${x.type}_start`,name:c,tags:s,metadata:o,data:{input:e}};d.includeEvent(O,x.type)&&(yield O)}const g=y.ops.filter(x=>x.path.startsWith("/logs/")).map(x=>x.path.split("/")[2]),w=[...new Set(g)];for(const x of w){let O,T={};const B=n.state.logs[x];if(B.end_time===void 0?B.streamed_output.length>0?O="stream":O="start":O="end",O==="start")B.inputs!==void 0&&(T.input=B.inputs);else if(O==="end")B.inputs!==void 0&&(T.input=B.inputs),T.output=B.final_output;else if(O==="stream"){const U=B.streamed_output.length;if(U!==1)throw new Error(`Expected exactly one chunk of streamed output, got ${U} instead. Encountered in: "${B.name}"`);T={chunk:B.streamed_output[0]},B.streamed_output=[]}yield{event:`on_${B.type}_${O}`,name:B.name,run_id:B.id,tags:B.tags,metadata:B.metadata,data:T}}const{state:b}=n;if(b.streamed_output.length>0){const x=b.streamed_output.length;if(x!==1)throw new Error(`Expected exactly one chunk of streamed output, got ${x} instead. Encountered in: "${b.name}"`);const O={chunk:b.streamed_output[0]};b.streamed_output=[];const T={event:`on_${b.type}_stream`,run_id:b.id,tags:s,metadata:o,name:c,data:O};d.includeEvent(T,b.type)&&(yield T)}}const p=n?.state;if(p!==void 0){const y={event:`on_${p.type}_end`,name:c,run_id:p.id,tags:s,metadata:o,data:{output:p.final_output}};d.includeEvent(y,p.type)&&(yield y)}}static isRunnable(e){return Kf(e)}withListeners({onStart:e,onEnd:t,onError:r}){return new gc({bound:this,config:{},configFactories:[n=>({callbacks:[new ow({config:n,onStart:e,onEnd:t,onError:r})]})]})}asTool(e){return zP(this,e)}},gc=class Sw extends Gt{static lc_name(){return"RunnableBinding"}lc_namespace=["langchain_core","runnables"];lc_serializable=!0;bound;config;kwargs;configFactories;constructor(t){super(t),this.bound=t.bound,this.kwargs=t.kwargs,this.config=t.config,this.configFactories=t.configFactories}getName(t){return this.bound.getName(t)}async _mergeConfig(...t){const r=yg(this.config,...t);return yg(r,...this.configFactories?await Promise.all(this.configFactories.map(async n=>await n(r))):[])}withConfig(t){return new this.constructor({bound:this.bound,kwargs:this.kwargs,config:{...this.config,...t}})}withRetry(t){return new kw({bound:this.bound,kwargs:this.kwargs,config:this.config,maxAttemptNumber:t?.stopAfterAttempt,...t})}async invoke(t,r){return this.bound.invoke(t,await this._mergeConfig(r,this.kwargs))}async batch(t,r,n){const a=Array.isArray(r)?await Promise.all(r.map(async i=>this._mergeConfig(Xe(i),this.kwargs))):await this._mergeConfig(Xe(r),this.kwargs);return this.bound.batch(t,a,n)}_concatOutputChunks(t,r){return this.bound._concatOutputChunks(t,r)}async*_streamIterator(t,r){yield*this.bound._streamIterator(t,await this._mergeConfig(Xe(r),this.kwargs))}async stream(t,r){return this.bound.stream(t,await this._mergeConfig(Xe(r),this.kwargs))}async*transform(t,r){yield*this.bound.transform(t,await this._mergeConfig(Xe(r),this.kwargs))}streamEvents(t,r,n){const a=this,i=async function*(){yield*a.bound.streamEvents(t,{...await a._mergeConfig(Xe(r),a.kwargs),version:r.version},n)};return Rr.fromAsyncGenerator(i())}static isRunnableBinding(t){return t.bound&&Gt.isRunnable(t.bound)}withListeners({onStart:t,onEnd:r,onError:n}){return new Sw({bound:this.bound,kwargs:this.kwargs,config:this.config,configFactories:[a=>({callbacks:[new ow({config:a,onStart:t,onEnd:r,onError:n})]})]})}},kw=class extends gc{static lc_name(){return"RunnableRetry"}lc_namespace=["langchain_core","runnables"];maxAttemptNumber=3;onFailedAttempt=()=>{};constructor(e){super(e),this.maxAttemptNumber=e.maxAttemptNumber??this.maxAttemptNumber,this.onFailedAttempt=e.onFailedAttempt??this.onFailedAttempt}_patchConfigForRetry(e,t,r){const n=e>1?`retry:attempt:${e}`:void 0;return Bt(t,{callbacks:r?.getChild(n)})}async _invoke(e,t,r){return rc(n=>super.invoke(e,this._patchConfigForRetry(n,t,r)),{onFailedAttempt:n=>this.onFailedAttempt(n,e),retries:Math.max(this.maxAttemptNumber-1,0),randomize:!0})}async invoke(e,t){return this._callWithConfig(this._invoke.bind(this),e,t)}async _batch(e,t,r,n){const a={};try{await rc(async i=>{const s=e.map((h,p)=>p).filter(h=>a[h.toString()]===void 0||a[h.toString()]instanceof Error),o=s.map(h=>e[h]),c=s.map(h=>this._patchConfigForRetry(i,t?.[h],r?.[h])),u=await super.batch(o,c,{...n,returnExceptions:!0});let d;for(let h=0;h<u.length;h+=1){const p=u[h],y=s[h];p instanceof Error&&d===void 0&&(d=p,d.input=o[h]),a[y.toString()]=p}if(d)throw d;return u},{onFailedAttempt:i=>this.onFailedAttempt(i,i.input),retries:Math.max(this.maxAttemptNumber-1,0),randomize:!0})}catch(i){if(n?.returnExceptions!==!0)throw i}return Object.keys(a).sort((i,s)=>parseInt(i,10)-parseInt(s,10)).map(i=>a[parseInt(i,10)])}async batch(e,t,r){return this._batchWithConfig(this._batch.bind(this),e,t,r)}},Iw=class Hi extends Gt{static lc_name(){return"RunnableSequence"}first;middle=[];last;omitSequenceTags=!1;lc_serializable=!0;lc_namespace=["langchain_core","runnables"];constructor(t){super(t),this.first=t.first,this.middle=t.middle??this.middle,this.last=t.last,this.name=t.name,this.omitSequenceTags=t.omitSequenceTags??this.omitSequenceTags}get steps(){return[this.first,...this.middle,this.last]}async invoke(t,r){const n=Xe(r),i=await(await Tr(n))?.handleChainStart(this.toJSON(),It(t,"input"),n.runId,void 0,void 0,void 0,n?.runName);delete n.runId;let s=t,o;try{const c=[this.first,...this.middle];for(let u=0;u<c.length;u+=1){const h=c[u].invoke(s,Bt(n,{callbacks:i?.getChild(this.omitSequenceTags?void 0:`seq:step:${u+1}`)}));s=await Mn(h,r?.signal)}if(r?.signal?.aborted)throw ic(r.signal);o=await this.last.invoke(s,Bt(n,{callbacks:i?.getChild(this.omitSequenceTags?void 0:`seq:step:${this.steps.length}`)}))}catch(c){throw await i?.handleChainError(c),c}return await i?.handleChainEnd(It(o,"output")),o}async batch(t,r,n){const a=this._getOptionsList(r??{},t.length),i=await Promise.all(a.map(Tr)),s=await Promise.all(i.map(async(c,u)=>{const d=await c?.handleChainStart(this.toJSON(),It(t[u],"input"),a[u].runId,void 0,void 0,void 0,a[u].runName);return delete a[u].runId,d}));let o=t;try{for(let c=0;c<this.steps.length;c+=1){const d=this.steps[c].batch(o,s.map((h,p)=>{const y=h?.getChild(this.omitSequenceTags?void 0:`seq:step:${c+1}`);return Bt(a[p],{callbacks:y})}),n);o=await Mn(d,a[0]?.signal)}}catch(c){throw await Promise.all(s.map(u=>u?.handleChainError(c))),c}return await Promise.all(s.map(c=>c?.handleChainEnd(It(o,"output")))),o}_concatOutputChunks(t,r){return this.last._concatOutputChunks(t,r)}async*_streamIterator(t,r){const n=await Tr(r),{runId:a,...i}=r??{},s=await n?.handleChainStart(this.toJSON(),It(t,"input"),a,void 0,void 0,void 0,i?.runName),o=[this.first,...this.middle,this.last];let c=!0,u;async function*d(){yield t}try{let h=o[0].transform(d(),Bt(i,{callbacks:s?.getChild(this.omitSequenceTags?void 0:"seq:step:1")}));for(let p=1;p<o.length;p+=1)h=await o[p].transform(h,Bt(i,{callbacks:s?.getChild(this.omitSequenceTags?void 0:`seq:step:${p+1}`)}));for await(const p of h)if(r?.signal?.throwIfAborted(),yield p,c)if(u===void 0)u=p;else try{u=this._concatOutputChunks(u,p)}catch{u=void 0,c=!1}}catch(h){throw await s?.handleChainError(h),h}await s?.handleChainEnd(It(u,"output"))}getGraph(t){const r=new Jf;let n=null;return this.steps.forEach((a,i)=>{const s=a.getGraph(t);i!==0&&s.trimFirstNode(),i!==this.steps.length-1&&s.trimLastNode(),r.extend(s);const o=s.firstNode();if(!o)throw new Error(`Runnable ${a} has no first node`);n&&r.addEdge(n,o),n=s.lastNode()}),r}pipe(t){return Hi.isRunnableSequence(t)?new Hi({first:this.first,middle:this.middle.concat([this.last,t.first,...t.middle]),last:t.last,name:this.name??t.name}):new Hi({first:this.first,middle:[...this.middle,this.last],last:ia(t),name:this.name})}static isRunnableSequence(t){return Array.isArray(t.middle)&&Gt.isRunnable(t)}static from([t,...r],n){let a={};return typeof n=="string"?a.name=n:n!==void 0&&(a=n),new Hi({...a,first:ia(t),middle:r.slice(0,-1).map(ia),last:ia(r[r.length-1])})}},Qf=class Ow extends Gt{static lc_name(){return"RunnableMap"}lc_namespace=["langchain_core","runnables"];lc_serializable=!0;steps;getStepsKeys(){return Object.keys(this.steps)}constructor(t){super(t),this.steps={};for(const[r,n]of Object.entries(t.steps))this.steps[r]=ia(n)}static from(t){return new Ow({steps:t})}async invoke(t,r){const n=Xe(r),i=await(await Tr(n))?.handleChainStart(this.toJSON(),{input:t},n.runId,void 0,void 0,void 0,n?.runName);delete n.runId;const s={};try{const o=Object.entries(this.steps).map(async([c,u])=>{s[c]=await u.invoke(t,Bt(n,{callbacks:i?.getChild(`map:key:${c}`)}))});await Mn(Promise.all(o),r?.signal)}catch(o){throw await i?.handleChainError(o),o}return await i?.handleChainEnd(s),s}async*_transform(t,r,n){const a={...this.steps},i=Uf(t,Object.keys(a).length),s=new Map(Object.entries(a).map(([o,c],u)=>{const d=c.transform(i[u],Bt(n,{callbacks:r?.getChild(`map:key:${o}`)}));return[o,d.next().then(h=>({key:o,gen:d,result:h}))]}));for(;s.size;){const o=Promise.race(s.values()),{key:c,result:u,gen:d}=await Mn(o,n?.signal);s.delete(c),u.done||(yield{[c]:u.value},s.set(c,d.next().then(h=>({key:c,gen:d,result:h}))))}}transform(t,r){return this._transformStreamWithConfig(t,this._transform.bind(this),r)}async stream(t,r){async function*n(){yield t}const a=Xe(r),i=new Ta({generator:this.transform(n(),a),config:a});return await i.setup,Rr.fromAsyncGenerator(i)}},MP=class Tw extends Gt{lc_serializable=!1;lc_namespace=["langchain_core","runnables"];func;constructor(t){if(super(t),!Bf(t.func))throw new Error("RunnableTraceable requires a function that is wrapped in traceable higher-order function");this.func=t.func}async invoke(t,r){const[n]=this._getOptionsList(r??{},1),a=await Tr(n),i=this.func(Bt(n,{callbacks:a}),t);return Mn(i,n?.signal)}async*_streamIterator(t,r){const[n]=this._getOptionsList(r??{},1),a=await this.invoke(t,r);if(Kd(a)){for await(const i of a)n?.signal?.throwIfAborted(),yield i;return}if(LP(a)){for(;;){n?.signal?.throwIfAborted();const i=a.next();if(i.done)break;yield i.value}return}yield a}static from(t){return new Tw({func:t})}};function jP(e){if(Bf(e))throw new Error("RunnableLambda requires a function that is not wrapped in traceable higher-order function. This shouldn't happen.")}var Rw=class $w extends Gt{static lc_name(){return"RunnableLambda"}lc_namespace=["langchain_core","runnables"];func;constructor(t){if(Bf(t.func))return MP.from(t.func);super(t),jP(t.func),this.func=t.func}static from(t){return new $w({func:t})}async _invoke(t,r,n){return new Promise((a,i)=>{const s=Bt(r,{callbacks:n?.getChild(),recursionLimit:(r?.recursionLimit??Vl)-1});fn.runWithConfig(oi(s),async()=>{try{let o=await this.func(t,{...s});if(o&&Gt.isRunnable(o)){if(r?.recursionLimit===0)throw new Error("Recursion limit reached.");o=await o.invoke(t,{...s,recursionLimit:(s.recursionLimit??Vl)-1})}else if(Kd(o)){let c;for await(const u of Gd(s,o))if(r?.signal?.throwIfAborted(),c===void 0)c=u;else try{c=this._concatOutputChunks(c,u)}catch{c=u}o=c}else if(Hg(o)){let c;for(const u of Kg(s,o))if(r?.signal?.throwIfAborted(),c===void 0)c=u;else try{c=this._concatOutputChunks(c,u)}catch{c=u}o=c}a(o)}catch(o){i(o)}})})}async invoke(t,r){return this._callWithConfig(this._invoke.bind(this),t,r)}async*_transform(t,r,n){let a;for await(const o of t)if(a===void 0)a=o;else try{a=this._concatOutputChunks(a,o)}catch{a=o}const i=Bt(n,{callbacks:r?.getChild(),recursionLimit:(n?.recursionLimit??Vl)-1}),s=await new Promise((o,c)=>{fn.runWithConfig(oi(i),async()=>{try{const u=await this.func(a,{...i,config:i});o(u)}catch(u){c(u)}})});if(s&&Gt.isRunnable(s)){if(n?.recursionLimit===0)throw new Error("Recursion limit reached.");const o=await s.stream(a,i);for await(const c of o)yield c}else if(Kd(s))for await(const o of Gd(i,s))n?.signal?.throwIfAborted(),yield o;else if(Hg(s))for(const o of Kg(i,s))n?.signal?.throwIfAborted(),yield o;else yield s}transform(t,r){return this._transformStreamWithConfig(t,this._transform.bind(this),r)}async stream(t,r){async function*n(){yield t}const a=Xe(r),i=new Ta({generator:this.transform(n(),a),config:a});return await i.setup,Rr.fromAsyncGenerator(i)}},FP=class extends Gt{static lc_name(){return"RunnableWithFallbacks"}lc_namespace=["langchain_core","runnables"];lc_serializable=!0;runnable;fallbacks;constructor(e){super(e),this.runnable=e.runnable,this.fallbacks=e.fallbacks}*runnables(){yield this.runnable;for(const e of this.fallbacks)yield e}async invoke(e,t){const r=Xe(t),n=await Tr(r),{runId:a,...i}=r,s=await n?.handleChainStart(this.toJSON(),It(e,"input"),a,void 0,void 0,void 0,i?.runName),o=Bt(i,{callbacks:s?.getChild()});return await fn.runWithConfig(o,async()=>{let u;for(const d of this.runnables()){r?.signal?.throwIfAborted();try{const h=await d.invoke(e,o);return await s?.handleChainEnd(It(h,"output")),h}catch(h){u===void 0&&(u=h)}}throw u===void 0?new Error("No error stored at end of fallback."):(await s?.handleChainError(u),u)})}async*_streamIterator(e,t){const r=Xe(t),n=await Tr(r),{runId:a,...i}=r,s=await n?.handleChainStart(this.toJSON(),It(e,"input"),a,void 0,void 0,void 0,i?.runName);let o,c;for(const d of this.runnables()){r?.signal?.throwIfAborted();const h=Bt(i,{callbacks:s?.getChild()});try{const p=await d.stream(e,h);c=Gd(h,p);break}catch(p){o===void 0&&(o=p)}}if(c===void 0){const d=o??new Error("No error stored at end of fallback.");throw await s?.handleChainError(d),d}let u;try{for await(const d of c){yield d;try{u=u===void 0?u:this._concatOutputChunks(u,d)}catch{u=void 0}}}catch(d){throw await s?.handleChainError(d),d}await s?.handleChainEnd(It(u,"output"))}async batch(e,t,r){if(r?.returnExceptions)throw new Error("Not implemented.");const n=this._getOptionsList(t??{},e.length),a=await Promise.all(n.map(o=>Tr(o))),i=await Promise.all(a.map(async(o,c)=>{const u=await o?.handleChainStart(this.toJSON(),It(e[c],"input"),n[c].runId,void 0,void 0,void 0,n[c].runName);return delete n[c].runId,u}));let s;for(const o of this.runnables()){n[0].signal?.throwIfAborted();try{const c=await o.batch(e,i.map((u,d)=>Bt(n[d],{callbacks:u?.getChild()})),r);return await Promise.all(i.map((u,d)=>u?.handleChainEnd(It(c[d],"output")))),c}catch(c){s===void 0&&(s=c)}}throw s?(await Promise.all(i.map(o=>o?.handleChainError(s))),s):new Error("No error stored at end of fallbacks.")}};function ia(e){if(typeof e=="function")return new Rw({func:e});if(Gt.isRunnable(e))return e;if(!Array.isArray(e)&&typeof e=="object"){const t={};for(const[r,n]of Object.entries(e))t[r]=ia(n);return new Qf({steps:t})}else throw new Error(`Expected a Runnable, function or object.
Instead got an unsupported type.`)}var BP=class extends Gt{static lc_name(){return"RunnableAssign"}lc_namespace=["langchain_core","runnables"];lc_serializable=!0;mapper;constructor(e){e instanceof Qf&&(e={mapper:e}),super(e),this.mapper=e.mapper}async invoke(e,t){const r=await this.mapper.invoke(e,t);return{...e,...r}}async*_transform(e,t,r){const n=this.mapper.getStepsKeys(),[a,i]=Uf(e),s=this.mapper.transform(i,Bt(r,{callbacks:t?.getChild()})),o=s.next();for await(const c of a){if(typeof c!="object"||Array.isArray(c))throw new Error(`RunnableAssign can only be used with objects as input, got ${typeof c}`);const u=Object.fromEntries(Object.entries(c).filter(([d])=>!n.includes(d)));Object.keys(u).length>0&&(yield u)}yield(await o).value;for await(const c of s)yield c}transform(e,t){return this._transformStreamWithConfig(e,this._transform.bind(this),t)}async stream(e,t){async function*r(){yield e}const n=Xe(t),a=new Ta({generator:this.transform(r(),n),config:n});return await a.setup,Rr.fromAsyncGenerator(a)}},UP=class extends Gt{static lc_name(){return"RunnablePick"}lc_namespace=["langchain_core","runnables"];lc_serializable=!0;keys;constructor(e){(typeof e=="string"||Array.isArray(e))&&(e={keys:e}),super(e),this.keys=e.keys}async _pick(e){if(typeof this.keys=="string")return e[this.keys];{const t=this.keys.map(r=>[r,e[r]]).filter(r=>r[1]!==void 0);return t.length===0?void 0:Object.fromEntries(t)}}async invoke(e,t){return this._callWithConfig(this._pick.bind(this),e,t)}async*_transform(e){for await(const t of e){const r=await this._pick(t);r!==void 0&&(yield r)}}transform(e,t){return this._transformStreamWithConfig(e,this._transform.bind(this),t)}async stream(e,t){async function*r(){yield e}const n=Xe(t),a=new Ta({generator:this.transform(r(),n),config:n});return await a.setup,Rr.fromAsyncGenerator(a)}},Gg=class extends gc{name;description;schema;constructor(e){const t=Iw.from([Rw.from(async r=>{let n;if(cT(r))try{n=await PC(this.schema,r.args)}catch{throw new uT("Received tool input did not match expected schema",JSON.stringify(r.args))}else n=r;return n}).withConfig({runName:`${e.name}:parse_input`}),e.bound]).withConfig({runName:e.name});super({bound:t,config:e.config??{}}),this.name=e.name,this.description=e.description,this.schema=e.schema}static lc_name(){return"RunnableToolLike"}};function zP(e,t){const r=t.name??e.getName(),n=t.description??NC(t.schema);return DC(t.schema)?new Gg({name:r,description:n,schema:_1({input:v1()}).transform(a=>a.input),bound:e}):new Gg({name:r,description:n,schema:t.schema,bound:e})}var Yf=class extends Gt{lc_namespace=["langchain_core","documents","transformers"];invoke(e,t){return this.transformDocuments(e)}},qP=class extends Yf{async transformDocuments(e){const t=[];for(const r of e){const n=await this._transformDocument(r);t.push(n)}return t}},HP={};Et(HP,{BaseDocumentTransformer:()=>Yf,Document:()=>d_,MappingDocumentTransformer:()=>qP});var Ni={},Wg;function KP(){if(Wg)return Ni;Wg=1,Ni.byteLength=o,Ni.toByteArray=u,Ni.fromByteArray=p;for(var e=[],t=[],r=typeof Uint8Array<"u"?Uint8Array:Array,n="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/",a=0,i=n.length;a<i;++a)e[a]=n[a],t[n.charCodeAt(a)]=a;t[45]=62,t[95]=63;function s(y){var g=y.length;if(g%4>0)throw new Error("Invalid string. Length must be a multiple of 4");var w=y.indexOf("=");w===-1&&(w=g);var b=w===g?0:4-w%4;return[w,b]}function o(y){var g=s(y),w=g[0],b=g[1];return(w+b)*3/4-b}function c(y,g,w){return(g+w)*3/4-w}function u(y){var g,w=s(y),b=w[0],x=w[1],O=new r(c(y,b,x)),T=0,B=x>0?b-4:b,U;for(U=0;U<B;U+=4)g=t[y.charCodeAt(U)]<<18|t[y.charCodeAt(U+1)]<<12|t[y.charCodeAt(U+2)]<<6|t[y.charCodeAt(U+3)],O[T++]=g>>16&255,O[T++]=g>>8&255,O[T++]=g&255;return x===2&&(g=t[y.charCodeAt(U)]<<2|t[y.charCodeAt(U+1)]>>4,O[T++]=g&255),x===1&&(g=t[y.charCodeAt(U)]<<10|t[y.charCodeAt(U+1)]<<4|t[y.charCodeAt(U+2)]>>2,O[T++]=g>>8&255,O[T++]=g&255),O}function d(y){return e[y>>18&63]+e[y>>12&63]+e[y>>6&63]+e[y&63]}function h(y,g,w){for(var b,x=[],O=g;O<w;O+=3)b=(y[O]<<16&16711680)+(y[O+1]<<8&65280)+(y[O+2]&255),x.push(d(b));return x.join("")}function p(y){for(var g,w=y.length,b=w%3,x=[],O=16383,T=0,B=w-b;T<B;T+=O)x.push(h(y,T,T+O>B?B:T+O));return b===1?(g=y[w-1],x.push(e[g>>2]+e[g<<4&63]+"==")):b===2&&(g=(y[w-2]<<8)+y[w-1],x.push(e[g>>10]+e[g>>4&63]+e[g<<2&63]+"=")),x.join("")}return Ni}var GP=KP();const WP=fi(GP);var VP=Object.defineProperty,ZP=(e,t,r)=>t in e?VP(e,t,{enumerable:!0,configurable:!0,writable:!0,value:r}):e[t]=r,JP=(e,t,r)=>(ZP(e,t+"",r),r);function QP(e,t){let r=Array.from({length:e.length},(n,a)=>({start:a,end:a+1}));for(;r.length>1;){let n=null;for(let a=0;a<r.length-1;a++){const i=e.slice(r[a].start,r[a+1].end),s=t.get(i.join(","));s!=null&&(n==null||s<n[0])&&(n=[s,a])}if(n!=null){const a=n[1];r[a]={start:r[a].start,end:r[a+1].end},r.splice(a+1,1)}else break}return r}function YP(e,t){return e.length===1?[t.get(e.join(","))]:QP(e,t).map(r=>t.get(e.slice(r.start,r.end).join(","))).filter(r=>r!=null)}function XP(e){return e.replace(/[\\^$*+?.()|[\]{}]/g,"\\$&")}var Wd=class{specialTokens;inverseSpecialTokens;patStr;textEncoder=new TextEncoder;textDecoder=new TextDecoder("utf-8");rankMap=new Map;textMap=new Map;constructor(e,t){this.patStr=e.pat_str;const r=e.bpe_ranks.split(`
`).filter(Boolean).reduce((n,a)=>{const[i,s,...o]=a.split(" "),c=Number.parseInt(s,10);return o.forEach((u,d)=>n[u]=c+d),n},{});for(const[n,a]of Object.entries(r)){const i=WP.toByteArray(n);this.rankMap.set(i.join(","),a),this.textMap.set(a,i)}this.specialTokens={...e.special_tokens,...t},this.inverseSpecialTokens=Object.entries(this.specialTokens).reduce((n,[a,i])=>(n[i]=this.textEncoder.encode(a),n),{})}encode(e,t=[],r="all"){const n=new RegExp(this.patStr,"ug"),a=Wd.specialTokenRegex(Object.keys(this.specialTokens)),i=[],s=new Set(t==="all"?Object.keys(this.specialTokens):t),o=new Set(r==="all"?Object.keys(this.specialTokens).filter(u=>!s.has(u)):r);if(o.size>0){const u=Wd.specialTokenRegex([...o]),d=e.match(u);if(d!=null)throw new Error(`The text contains a special token that is not allowed: ${d[0]}`)}let c=0;for(;;){let u=null,d=c;for(;a.lastIndex=d,u=a.exec(e),!(u==null||s.has(u[0]));)d=u.index+1;const h=u?.index??e.length;for(const y of e.substring(c,h).matchAll(n)){const g=this.textEncoder.encode(y[0]),w=this.rankMap.get(g.join(","));if(w!=null){i.push(w);continue}i.push(...YP(g,this.rankMap))}if(u==null)break;let p=this.specialTokens[u[0]];i.push(p),c=u.index+u[0].length}return i}decode(e){const t=[];let r=0;for(let i=0;i<e.length;++i){const s=e[i],o=this.textMap.get(s)??this.inverseSpecialTokens[s];o!=null&&(t.push(o),r+=o.length)}const n=new Uint8Array(r);let a=0;for(const i of t)n.set(i,a),a+=i.length;return this.textDecoder.decode(n)}},Aw=Wd;JP(Aw,"specialTokenRegex",e=>new RegExp(e.map(t=>XP(t)).join("|"),"g"));function eN(e){switch(e){case"gpt2":return"gpt2";case"code-cushman-001":case"code-cushman-002":case"code-davinci-001":case"code-davinci-002":case"cushman-codex":case"davinci-codex":case"davinci-002":case"text-davinci-002":case"text-davinci-003":return"p50k_base";case"code-davinci-edit-001":case"text-davinci-edit-001":return"p50k_edit";case"ada":case"babbage":case"babbage-002":case"code-search-ada-code-001":case"code-search-babbage-code-001":case"curie":case"davinci":case"text-ada-001":case"text-babbage-001":case"text-curie-001":case"text-davinci-001":case"text-search-ada-doc-001":case"text-search-babbage-doc-001":case"text-search-curie-doc-001":case"text-search-davinci-doc-001":case"text-similarity-ada-001":case"text-similarity-babbage-001":case"text-similarity-curie-001":case"text-similarity-davinci-001":return"r50k_base";case"gpt-3.5-turbo-instruct-0914":case"gpt-3.5-turbo-instruct":case"gpt-3.5-turbo-16k-0613":case"gpt-3.5-turbo-16k":case"gpt-3.5-turbo-0613":case"gpt-3.5-turbo-0301":case"gpt-3.5-turbo":case"gpt-4-32k-0613":case"gpt-4-32k-0314":case"gpt-4-32k":case"gpt-4-0613":case"gpt-4-0314":case"gpt-4":case"gpt-3.5-turbo-1106":case"gpt-35-turbo":case"gpt-4-1106-preview":case"gpt-4-vision-preview":case"gpt-3.5-turbo-0125":case"gpt-4-turbo":case"gpt-4-turbo-2024-04-09":case"gpt-4-turbo-preview":case"gpt-4-0125-preview":case"text-embedding-ada-002":case"text-embedding-3-small":case"text-embedding-3-large":return"cl100k_base";case"gpt-4o":case"gpt-4o-2024-05-13":case"gpt-4o-2024-08-06":case"gpt-4o-2024-11-20":case"gpt-4o-mini-2024-07-18":case"gpt-4o-mini":case"gpt-4o-search-preview":case"gpt-4o-search-preview-2025-03-11":case"gpt-4o-mini-search-preview":case"gpt-4o-mini-search-preview-2025-03-11":case"gpt-4o-audio-preview":case"gpt-4o-audio-preview-2024-12-17":case"gpt-4o-audio-preview-2024-10-01":case"gpt-4o-mini-audio-preview":case"gpt-4o-mini-audio-preview-2024-12-17":case"o1":case"o1-2024-12-17":case"o1-mini":case"o1-mini-2024-09-12":case"o1-preview":case"o1-preview-2024-09-12":case"o1-pro":case"o1-pro-2025-03-19":case"o3":case"o3-2025-04-16":case"o3-mini":case"o3-mini-2025-01-31":case"o4-mini":case"o4-mini-2025-04-16":case"chatgpt-4o-latest":case"gpt-4o-realtime":case"gpt-4o-realtime-preview-2024-10-01":case"gpt-4o-realtime-preview-2024-12-17":case"gpt-4o-mini-realtime-preview":case"gpt-4o-mini-realtime-preview-2024-12-17":case"gpt-4.1":case"gpt-4.1-2025-04-14":case"gpt-4.1-mini":case"gpt-4.1-mini-2025-04-14":case"gpt-4.1-nano":case"gpt-4.1-nano-2025-04-14":case"gpt-4.5-preview":case"gpt-4.5-preview-2025-02-27":case"gpt-5":case"gpt-5-2025-08-07":case"gpt-5-nano":case"gpt-5-nano-2025-08-07":case"gpt-5-mini":case"gpt-5-mini-2025-08-07":case"gpt-5-chat-latest":return"o200k_base";default:throw new Error("Unknown model")}}var tN={};Et(tN,{encodingForModel:()=>nN,getEncoding:()=>Cw});const To={},rN=new Hf({});async function Cw(e){return e in To||(To[e]=rN.fetch(`https://tiktoken.pages.dev/js/${e}.json`).then(t=>t.json()).then(t=>new Aw(t)).catch(t=>{throw delete To[e],t})),await To[e]}async function nN(e){return Cw(eN(e))}var aN=class extends Yf{lc_namespace=["langchain","document_transformers","text_splitters"];chunkSize=1e3;chunkOverlap=200;keepSeparator=!1;lengthFunction;constructor(e){if(super(e),this.chunkSize=e?.chunkSize??this.chunkSize,this.chunkOverlap=e?.chunkOverlap??this.chunkOverlap,this.keepSeparator=e?.keepSeparator??this.keepSeparator,this.lengthFunction=e?.lengthFunction??(t=>t.length),this.chunkOverlap>=this.chunkSize)throw new Error("Cannot have chunkOverlap >= chunkSize")}async transformDocuments(e,t={}){return this.splitDocuments(e,t)}splitOnSeparator(e,t){let r;if(t)if(this.keepSeparator){const n=t.replace(/[/\-\\^$*+?.()|[\]{}]/g,"\\$&");r=e.split(new RegExp(`(?=${n})`))}else r=e.split(t);else r=e.split("");return r.filter(n=>n!=="")}async createDocuments(e,t=[],r={}){const n=t.length>0?t:[...Array(e.length)].map(()=>({})),{chunkHeader:a="",chunkOverlapHeader:i="(cont'd) ",appendChunkOverlapHeader:s=!1}=r,o=new Array;for(let c=0;c<e.length;c+=1){const u=e[c];let d=1,h=null,p=-1;for(const y of await this.splitText(u)){let g=a;const w=u.indexOf(y,p+1);if(h===null){const T=this.numberOfNewLines(u,0,w);d+=T}else{const T=p+await this.lengthFunction(h);if(T<w){const B=this.numberOfNewLines(u,T,w);d+=B}else if(T>w){const B=this.numberOfNewLines(u,w,T);d-=B}s&&(g+=i)}const b=this.numberOfNewLines(y),x=n[c].loc&&typeof n[c].loc=="object"?{...n[c].loc}:{};x.lines={from:d,to:d+b};const O={...n[c],loc:x};g+=y,o.push(new d_({pageContent:g,metadata:O})),d+=b,h=y,p=w}}return o}numberOfNewLines(e,t,r){return(e.slice(t,r).match(/\n/g)||[]).length}async splitDocuments(e,t={}){const r=e.filter(i=>i.pageContent!==void 0),n=r.map(i=>i.pageContent),a=r.map(i=>i.metadata);return this.createDocuments(n,a,t)}joinDocs(e,t){const r=e.join(t).trim();return r===""?null:r}async mergeSplits(e,t){const r=[],n=[];let a=0;for(const s of e){const o=await this.lengthFunction(s);if(a+o+n.length*t.length>this.chunkSize&&(a>this.chunkSize&&console.warn(`Created a chunk of size ${a}, +
which is longer than the specified ${this.chunkSize}`),n.length>0)){const c=this.joinDocs(n,t);for(c!==null&&r.push(c);a>this.chunkOverlap||a+o+n.length*t.length>this.chunkSize&&a>0;)a-=await this.lengthFunction(n[0]),n.shift()}n.push(s),a+=o}const i=this.joinDocs(n,t);return i!==null&&r.push(i),r}},iN=class Vd extends aN{static lc_name(){return"RecursiveCharacterTextSplitter"}separators=[`

`,`
`," ",""];constructor(t){super(t),this.separators=t?.separators??this.separators,this.keepSeparator=t?.keepSeparator??!0}async _splitText(t,r){const n=[];let a=r[r.length-1],i;for(let u=0;u<r.length;u+=1){const d=r[u];if(d===""){a=d;break}if(t.includes(d)){a=d,i=r.slice(u+1);break}}const s=this.splitOnSeparator(t,a);let o=[];const c=this.keepSeparator?"":a;for(const u of s)if(await this.lengthFunction(u)<this.chunkSize)o.push(u);else{if(o.length){const d=await this.mergeSplits(o,c);n.push(...d),o=[]}if(!i)n.push(u);else{const d=await this._splitText(u,i);n.push(...d)}}if(o.length){const u=await this.mergeSplits(o,c);n.push(...u)}return n}async splitText(t){return this._splitText(t,this.separators)}static fromLanguage(t,r){return new Vd({...r,separators:Vd.getSeparatorsForLanguage(t)})}static getSeparatorsForLanguage(t){if(t==="cpp")return[`
class `,`
void `,`
int `,`
float `,`
double `,`
if `,`
for `,`
while `,`
switch `,`
case `,`

`,`
`," ",""];if(t==="go")return[`
func `,`
var `,`
const `,`
type `,`
if `,`
for `,`
switch `,`
case `,`

`,`
`," ",""];if(t==="java")return[`
class `,`
public `,`
protected `,`
private `,`
static `,`
if `,`
for `,`
while `,`
switch `,`
case `,`

`,`
`," ",""];if(t==="js")return[`
function `,`
const `,`
let `,`
var `,`
class `,`
if `,`
for `,`
while `,`
switch `,`
case `,`
default `,`

`,`
`," ",""];if(t==="php")return[`
function `,`
class `,`
if `,`
foreach `,`
while `,`
do `,`
switch `,`
case `,`

`,`
`," ",""];if(t==="proto")return[`
message `,`
service `,`
enum `,`
option `,`
import `,`
syntax `,`

`,`
`," ",""];if(t==="python")return[`
class `,`
def `,`
	def `,`

`,`
`," ",""];if(t==="rst")return[`
===
`,`
---
`,`
***
`,`
.. `,`

`,`
`," ",""];if(t==="ruby")return[`
def `,`
class `,`
if `,`
unless `,`
while `,`
for `,`
do `,`
begin `,`
rescue `,`

`,`
`," ",""];if(t==="rust")return[`
fn `,`
const `,`
let `,`
if `,`
while `,`
for `,`
loop `,`
match `,`
const `,`

`,`
`," ",""];if(t==="scala")return[`
class `,`
object `,`
def `,`
val `,`
var `,`
if `,`
for `,`
while `,`
match `,`
case `,`

`,`
`," ",""];if(t==="swift")return[`
func `,`
class `,`
struct `,`
enum `,`
if `,`
for `,`
while `,`
do `,`
switch `,`
case `,`

`,`
`," ",""];if(t==="markdown")return[`
## `,`
### `,`
#### `,`
##### `,`
###### `,"```\n\n",`

***

`,`

---

`,`

___

`,`

`,`
`," ",""];if(t==="latex")return[`
\\chapter{`,`
\\section{`,`
\\subsection{`,`
\\subsubsection{`,`
\\begin{enumerate}`,`
\\begin{itemize}`,`
\\begin{description}`,`
\\begin{list}`,`
\\begin{quote}`,`
\\begin{quotation}`,`
\\begin{verse}`,`
\\begin{verbatim}`,`
\\begin{align}`,"$$","$",`

`,`
`," ",""];if(t==="html")return["<body>","<div>","<p>","<br>","<li>","<h1>","<h2>","<h3>","<h4>","<h5>","<h6>","<span>","<table>","<tr>","<td>","<th>","<ul>","<ol>","<header>","<footer>","<nav>","<head>","<style>","<script>","<meta>","<title>"," ",""];if(t==="sol")return[`
pragma `,`
using `,`
contract `,`
interface `,`
library `,`
constructor `,`
type `,`
function `,`
event `,`
modifier `,`
error `,`
struct `,`
enum `,`
if `,`
for `,`
while `,`
do while `,`
assembly `,`

`,`
`," ",""];throw new Error(`Language ${t} is not supported.`)}};const Xl=$r("LangChainChunker"),sN=500,oN=75;function cN(e){return!e||e.trim().length===0?0:e.trim().split(/\s+/).filter(t=>t.length>0).length}class uN{constructor(t={}){this.chunkSize=t.chunkSize??sN,this.chunkOverlap=t.chunkOverlap??oN,this.textSplitter=new iN({chunkSize:this.chunkSize,chunkOverlap:this.chunkOverlap,lengthFunction:cN,separators:[`

`,`
`,". ","! ","? "," "],keepSeparator:!1})}async chunkDocument(t,r,n){try{const a=await this.textSplitter.splitText(r),i=[];let s=0;for(let o=0;o<a.length;o++){const c=a[o];let u;if(o===0){const p=r.indexOf(c);u=p!==-1?p:0,s=u}else{const p=i[o-1],y=Math.max(this.chunkOverlap*10,c.length),g=Math.max(0,p.endOffset-y),w=Math.min(r.length,p.endOffset+c.length),x=r.substring(g,w).indexOf(c);if(x!==-1){const O=g+x;O>=p.startOffset&&O<p.endOffset+c.length?u=O:u=p.endOffset}else u=p.endOffset;s=u}const d=Math.min(u+c.length,r.length),h=o===0?`${n} ${c}`:c;i.push({id:`${t}:chunk:${o}`,documentId:t,chunkIndex:o,text:h,startOffset:u,endOffset:d})}return this.validateNoWordSplitting(i,r,t),Xl.debug(`Document ${t} split into ${i.length} chunks using LangChain`),i}catch(a){throw Xl.warn(`LangChain chunking failed for ${t}, falling back to simple chunking: ${a}`),a}}validateNoWordSplitting(t,r,n){for(let a=0;a<t.length-1;a++){const i=t[a],s=t[a+1];if(i.endOffset<r.length&&s.startOffset>i.endOffset){const o=r.substring(i.endOffset,s.startOffset);if(o.trim().length>0&&!/^\s+$/.test(o)){const u=r[i.endOffset-1],d=r[s.startOffset];u&&d&&/[a-zA-Z0-9]/.test(u)&&/[a-zA-Z0-9]/.test(d)&&Xl.warn(`Potential word split detected in document ${n} between chunks ${a} and ${a+1}`)}}}}getChunkContext(t,r){const n=t.chunkIndex>0?r[t.chunkIndex-1]:null,a=t.chunkIndex<r.length-1?r[t.chunkIndex+1]:null;let i="";return n&&(i+=`[Previous: ${n.text.substring(Math.max(0,n.text.length-Ln.CONTEXT))}]

`),i+=t.text,a&&(i+=`

[Next: ${a.text.substring(0,Ln.CONTEXT)}]`),i}}const ed=$r("DocumentChunker");class Pw{constructor(t={}){try{this.chunker=new uN(t),ed.debug("Using LangChain chunker")}catch(r){ed.warn(`Failed to initialize LangChain chunker, using fallback: ${r}`),this.chunker=new jp(t)}}async chunkDocument(t,r,n){try{const a=this.chunker.chunkDocument(t,r,n);return await Promise.resolve(a)}catch(a){return ed.warn(`Primary chunker failed, falling back: ${a}`),new jp().chunkDocument(t,r,n)}}getChunkContext(t,r){return this.chunker.getChunkContext(t,r)}}new Pw;const Vg=$r("PDFJSExtractor");class Zg{canExtract(t){return t.toLowerCase()==="pdf"}async extractText(t,r={}){try{const n=await ty(()=>import("./pdf-UA8D4yGl.js"),[]);n.GlobalWorkerOptions.workerSrc||(n.GlobalWorkerOptions.workerSrc=`https://unpkg.com/pdfjs-dist@${n.version}/build/pdf.worker.min.mjs`);const i=await(await t.getContents({blob:!0})).arrayBuffer(),o=await n.getDocument({data:i,useSystemFonts:!0}).promise,c=o.numPages,u=[],d=r.includePageNumbers!==!1,h=r.pageSeparator||`

`;for(let y=1;y<=c;y++){const b=(await(await o.getPage(y)).getTextContent()).items.map(x=>x.str).join(" ");b.trim()&&(d?u.push(`[Page ${y}]
${b}`):u.push(b))}const p=u.join(h);if(!p||p.trim().length===0)throw new Error("PDF appears to contain no extractable text (may be image-based or scanned)");return Vg.debug(`Extracted ${c} pages from PDF: ${t.getName()}`),p}catch(n){throw Vg.warn(`Failed to extract text from PDF ${t.getName()}: ${n}`),new Error(`PDF text extraction failed: ${n}`)}}}const Jg=$r("LLMOCRExtractor");class Qg{canExtract(t){return["pdf","png","jpg","jpeg","tiff","tif"].includes(t.toLowerCase())}async extractText(t,r={}){const n=t.getName(),a=r?.fileType||n.split(".").pop()?.toLowerCase()||"pdf",s=(await hb.getProviders()).find(o=>o.ocrApiEndpoint&&o.name.toLowerCase().includes("mistral"));if(!s||!s.ocrApiEndpoint)throw new Error("Mistral OCR provider not configured. Please configure a provider with OCR endpoint in AI settings.");try{const o=await t.getContents({blob:!0}),c=await this.blobToBase64(o),u=this.getMimeType(a),d=await fetch(s.ocrApiEndpoint,{method:"POST",headers:{Authorization:`Bearer ${s.apiKey}`,"Content-Type":"application/json"},body:JSON.stringify({model:s.model||"mistral-ocr-latest",document:{type:"document_url",document_url:`data:${u};base64,${c}`},include_image_base64:!1})});if(!d.ok){const b=await d.text().catch(()=>"Unknown error");throw new Error(`OCR request failed: HTTP ${d.status}: ${b}`)}const h=await d.json();if(!h.pages||!Array.isArray(h.pages))throw new Error("Invalid OCR response format: missing pages array");const p=r.includePageNumbers!==!1,y=r.pageSeparator||`

`,g=h.pages.map((b,x)=>{const O=b?.markdown||b?.text||"";return O.trim()?p?`[Page ${x+1}]
${O}`:O:null}).filter(b=>b!==null);if(g.length===0)throw new Error("No text content found in OCR response");const w=g.join(y);return Jg.debug(`Extracted ${h.pages.length} pages from ${a} file: ${n}`),w}catch(o){throw Jg.warn(`Failed to extract text using OCR from ${n}: ${o}`),new Error(`OCR text extraction failed: ${o}`)}}async blobToBase64(t){return new Promise((r,n)=>{const a=new FileReader;a.onloadend=()=>{const s=a.result.split(",")[1];r(s)},a.onerror=n,a.readAsDataURL(t)})}getMimeType(t){return{pdf:"application/pdf",png:"image/png",jpg:"image/jpeg",jpeg:"image/jpeg",tiff:"image/tiff",tif:"image/tiff"}[t.toLowerCase()]||"application/octet-stream"}}const Di=$r("DocumentExtractor");class lN{constructor(){this.extractors=[new Qg,new Zg]}canExtract(t){return this.extractors.some(r=>r.canExtract(t))}async extractText(t,r){const n=t.getName(),a=r?.fileType||n.split(".").pop()?.toLowerCase()||"txt",i=this.extractors.filter(o=>o.canExtract(a));if(i.length===0)throw new Error(`No extractor available for file type: ${a}`);let s=null;for(const o of i)try{return Di.debug(`Using ${o.constructor.name} for file type: ${a}`),await o.extractText(t,{...r,fileType:a})}catch(c){if(s=c instanceof Error?c:new Error(String(c)),Di.warn(`${o.constructor.name} failed for ${n}: ${s.message}`),o instanceof Qg&&i.length>1){const u=i.find(d=>d instanceof Zg);if(u){const d=`Mistral OCR extraction failed, falling back to PDF.js extractor for ${n}`;Di.warn(d),pb(d);try{return Di.debug(`Using ${u.constructor.name} as fallback for file type: ${a}`),await u.extractText(t,{...r,fileType:a})}catch(h){s=h instanceof Error?h:new Error(String(h)),Di.warn(`Fallback extraction also failed for ${n}: ${s.message}`)}}}}throw s||new Error(`All extractors failed for file type: ${a}`)}}kc(aO);kc(_O);kc(qO);const be=$r("DocumentIndexService");class dN{constructor(){this.sampleVectors=[],this.isInitialized=!1,this.DEFAULT_MAX_FILE_SIZE=5*1024*1024,this.chunker=new Pw,this.documentExtractor=new lN,this.DEFAULT_INDEXABLE_TYPES=["md","txt","ts","tsx","js","jsx","json","geojson","kml","gpx","py","html","css","sql","xml","yaml","yml","pdf"]}async initialize(){if(!this.isInitialized){be.info("Initializing document index service with RxDB...");try{this.db=await bk({name:"document-index-db",storage:YI(),ignoreDuplicate:!0});const n={documents:{schema:{version:0,primaryKey:"id",type:"object",properties:{id:{type:"string",maxLength:500},workspacePath:{type:"string"},filePath:{type:"string"},fileName:{type:"string"},fileType:{type:"string"},content:{type:"string"},contentHash:{type:"string"},metadata:{type:"object",properties:{size:{type:"number"},lastModified:{type:"number"},language:{type:"string"},tags:{type:"array",items:{type:"string"}}}},indexedAt:{type:"number"},updatedAt:{type:"number"}},required:["id","workspacePath","filePath","content","contentHash"],indexes:["workspacePath","filePath","fileType"]}},vectors:{schema:{version:1,primaryKey:"id",type:"object",properties:{id:{type:"string",maxLength:500},documentId:{type:"string",maxLength:500},embedding:{type:"array",items:{type:"number"}},idx0:{type:"number"},idx1:{type:"number"},idx2:{type:"number"},idx3:{type:"number"},idx4:{type:"number"},chunkIndex:{type:"number"},chunkStartOffset:{type:"number"},chunkEndOffset:{type:"number"}},required:["id","documentId","embedding","idx0","idx1","idx2","idx3","idx4"],indexes:["documentId","chunkIndex","idx0","idx1","idx2","idx3","idx4"]}}};try{await this.db.addCollections(n)}catch(s){if(s?.code==="DB8"||s?.message?.includes("already exists"))be.debug("Collections already exist, using existing collections");else throw s}this.documentsCollection=this.db.documents,this.vectorsCollection=this.db.vectors,await this.initializeSampleVectors(),await this.handleSchemaMigration(),this.isInitialized=!0;const a=await this.documentsCollection.count().exec(),i=await this.vectorsCollection.count().exec();be.info(`Document index service initialized with ${a} documents and ${i} embeddings`),Ah(mb,s=>{s&&this.handleWorkspaceChange(s).catch(o=>{be.error(`Failed to handle workspace connection: ${o}`)})}),Ah(gb,s=>{s&&this.handleWorkspaceChange(s).catch(o=>{be.error(`Failed to handle workspace change: ${o}`)})}),be.info("Document index service initialized")}catch(t){throw be.error(`Failed to initialize document index service: ${t}`),t}}}ensureInitialized(){if(!this.isInitialized||!this.documentsCollection||!this.vectorsCollection)throw new Error("Document index service not initialized. Call initialize() first.")}async initializeSampleVectors(){if(this.sampleVectors.length>0)return;const t=await this.vectorsCollection.find().limit(1e3).exec(),r=t.map(n=>n.embedding);this.sampleVectors=VO(KO.SAMPLE_VECTOR_COUNT,Ai.getEmbeddingDimension(),r.length>0?r:void 0),be.info(`Sample vectors initialized for index range method: ${this.sampleVectors.length} vectors, ${t.length} existing embeddings`)}generateDocumentId(t,r){return`${t}:${r}`}async computeContentHash(t){const n=new TextEncoder().encode(t),a=await crypto.subtle.digest("SHA-256",n);return Array.from(new Uint8Array(a)).map(s=>s.toString(16).padStart(2,"0")).join("")}isIndexableFile(t,r){const n=t.getName().toLowerCase(),a=r?.fileTypes||this.DEFAULT_INDEXABLE_TYPES,i=n.split(".").pop();if(!i||!a.includes(i))return!1;if(r?.excludePatterns){for(const s of r.excludePatterns)if(n.includes(s)||t.getWorkspacePath().includes(s))return!1}return!0}detectLanguage(t){const r=t.split(".").pop()?.toLowerCase();return{ts:"typescript",tsx:"typescript",js:"javascript",jsx:"javascript",py:"python",md:"markdown",json:"json",geojson:"geojson",kml:"xml",gpx:"xml",html:"html",css:"css",sql:"sql",xml:"xml",yaml:"yaml",yml:"yaml",pdf:"pdf"}[r||""]||"text"}async indexDocument(t,r={}){this.isInitialized||await this.initialize(),this.ensureInitialized();const a=t.getWorkspace().getName(),i=t.getWorkspacePath(),s=t.getName(),o=this.generateDocumentId(a,i);if(!this.isIndexableFile(t,r))throw new Error(`File type not indexable: ${s}`);try{let c;const u=s.split(".").pop()?.toLowerCase()||"txt";if(this.documentExtractor.canExtract(u))c=await this.documentExtractor.extractText(t,{fileType:u});else{const q=await t.getContents({contentType:yb.TEXT});if(typeof q!="string")throw new Error(`File content is not text: ${s}`);c=q}if(!c||c.trim().length===0)throw new Error(`File appears to be empty or text extraction failed: ${s}`);const d=r.maxFileSize||this.DEFAULT_MAX_FILE_SIZE;if(c.length>d)throw new Error(`File too large to index: ${s} (${c.length} bytes)`);const h=await this.computeContentHash(c),p=Date.now(),y=await this.documentsCollection.findOne(o).exec(),g=y?y.toJSON():null,w=g?.metadata.tags||[],b=r.tags||[],x=[...new Set([...w,...b])],O=x.length!==w.length||b.some(q=>!w.includes(q));if(g&&g.contentHash===h&&!O)return be.debug(`Document already indexed and unchanged: ${o}`),g;const T=this.detectLanguage(s);let B=p;try{const q=t.getHandle?.();q&&(B=(await q.getFile()).lastModified)}catch(q){be.debug(`Could not get file modification time: ${q}`)}const U=!g||g.contentHash!==h,K={id:o,workspacePath:a,filePath:i,fileName:s,fileType:u,content:r.includeContent!==!1?c:"",contentHash:h,metadata:{size:c.length,lastModified:B,language:T,tags:x},indexedAt:g?.indexedAt||p,updatedAt:p};return await this.documentsCollection.upsert(K),U?await this.generateAndStoreEmbedding(K):be.debug(`Document content unchanged, skipping embedding regeneration: ${o}`),be.debug(`Indexed document: ${o}`),K}catch(c){throw be.error(`Failed to index document ${o}: ${c}`),c}}async getDocument(t){this.isInitialized||await this.initialize(),this.ensureInitialized();const r=await this.documentsCollection.findOne(t).exec();return r?r.toJSON():null}async getDocumentByPath(t,r){const n=this.generateDocumentId(t,r);return this.getDocument(n)}async listDocuments(t){this.isInitialized||await this.initialize(),this.ensureInitialized();let r=this.documentsCollection.find();return t&&(r=r.where("workspacePath").eq(t)),(await r.exec()).map(a=>a.toJSON())}async deleteDocument(t){this.isInitialized||await this.initialize(),this.ensureInitialized();const r=await this.documentsCollection.findOne(t).exec();if(r){await r.remove();const n=await this.vectorsCollection.find().where("documentId").eq(t).exec();for(const a of n)await a.remove();return be.debug(`Deleted document ${t} and ${n.length} associated embeddings`),!0}return!1}async deleteDocumentByPath(t,r){const n=this.generateDocumentId(t,r);return this.deleteDocument(n)}async handleSchemaMigration(){if(!(!this.vectorsCollection||!this.documentsCollection))try{const r=(await this.vectorsCollection.find().exec()).filter(a=>{const i=a.toJSON();return i.chunkIndex===void 0&&i.chunkStartOffset===void 0&&i.chunkEndOffset===void 0});if(r.length===0){be.debug("No vectors need migration - all have chunk information");return}be.info(`Detected ${r.length} vectors without chunk information. Invalidating and reindexing...`);const n=new Set;for(const a of r){const i=a.toJSON();n.add(i.documentId),await a.remove()}be.info(`Removed ${r.length} old vectors. Reindexing ${n.size} documents...`);for(const a of n){const i=await this.documentsCollection.findOne(a).exec();if(i){const s=i.toJSON();be.debug(`Reindexing document: ${s.fileName}`),await this.generateAndStoreEmbedding(s)}}be.info(`Schema migration completed. Reindexed ${n.size} documents.`)}catch(t){throw be.error(`Error during schema migration: ${t}`),t}}async deleteWorkspace(t){this.isInitialized||await this.initialize(),this.ensureInitialized();const r=await this.documentsCollection.find().where("workspacePath").eq(t).exec(),n=r.length;for(const a of r)await a.remove();return n>0&&be.info(`Deleted ${n} documents for workspace: ${t}`),n}async updateDocumentMetadata(t,r){this.isInitialized||await this.initialize(),this.ensureInitialized();const n=await this.documentsCollection.findOne(t).exec();if(!n)return null;const a=n.toJSON(),i={...a,metadata:{...a.metadata,...r.metadata},updatedAt:Date.now()};return await n.update({$set:i}),be.debug(`Updated document metadata: ${t}`),i}async indexWorkspace(t,r={}){this.isInitialized||await this.initialize();const n=t.getName();be.info(`Starting workspace indexing: ${n}`);const a=await this.collectFiles(t,r);be.info(`Found ${a.length} files to index`);let i=0,s=0;const o=[];for(const c of a)try{await this.indexDocument(c,r),i++}catch(u){s++;const d=`Failed to index ${c.getName()}: ${u}`;o.push(d),be.warn(d)}return be.info(`Workspace indexing complete: ${i} indexed, ${s} failed`),{indexed:i,failed:s,errors:o}}async collectFiles(t,r,n=[]){try{const a=await t.listChildren(!1);for(const i of a)i instanceof Ir?this.isIndexableFile(i,r)&&n.push(i):i instanceof vb&&await this.collectFiles(i,r,n)}catch(a){be.warn(`Failed to collect files from ${t.getName()}: ${a}`)}return n}async reindexDocument(t,r={}){const a=t.getWorkspace().getName(),i=t.getWorkspacePath(),s=this.generateDocumentId(a,i),c=(await this.getDocument(s))?.metadata.tags||[],u=r.tags||[],d=[...new Set([...c,...u])];return await this.deleteDocument(s),this.indexDocument(t,{...r,tags:d})}async reindexAllDocuments(t={}){this.isInitialized||await this.initialize(),this.ensureInitialized();const r=await this.listDocuments();let n=0,a=0;for(const i of r)try{const s=await Va.getWorkspace();if(!s||s.getName()!==i.workspacePath){be.warn(`Workspace not found: ${i.workspacePath}`),a++;continue}const o=await s.getResource(i.filePath);if(!o||!(o instanceof Ir)){be.warn(`File not found: ${i.filePath}`),a++;continue}await this.reindexDocument(o,t),n++}catch(s){be.error(`Failed to reindex document ${i.id}: ${s}`),a++}return{total:r.length,succeeded:n,failed:a}}async getStats(){this.isInitialized||await this.initialize(),this.ensureInitialized();const t=await this.documentsCollection.count().exec(),r=await this.documentsCollection.find().exec(),n={};for(const a of r){const s=a.toJSON().workspacePath;n[s]=(n[s]||0)+1}return{totalDocuments:t,byWorkspace:n}}async handleWorkspaceChange(t){be.debug("Workspace changed, checking for document updates...")}async generateAndStoreEmbedding(t){try{if(!this.vectorsCollection){be.warn(`Vectors collection not initialized, cannot generate embedding for ${t.id}`);return}if(await Ai.initialize(),this.sampleVectors.length===0&&await this.initializeSampleVectors(),this.sampleVectors.length===0){be.warn(`Sample vectors not initialized, cannot generate embedding for ${t.id}`);return}const r=await this.chunker.chunkDocument(t.id,t.content,t.fileName);be.debug(`Document ${t.id} split into ${r.length} chunks`);for(const n of r){const a=await Ai.generateEmbedding(n.text),i=Mp(a,this.sampleVectors),s={id:n.id,documentId:t.id,chunkIndex:n.chunkIndex,chunkStartOffset:n.startOffset,chunkEndOffset:n.endOffset,embedding:a,...i};await this.vectorsCollection.upsert(s)}be.debug(`Generated and stored ${r.length} embeddings for document: ${t.id}`)}catch(r){be.warn(`Failed to generate embedding for document ${t.id}: ${r}`)}}async searchSimilar(t,r={}){this.isInitialized||await this.initialize(),this.ensureInitialized();const n=r.limit||10,a=r.indexDistance||2,i=r.docsPerIndexSide||100;if(!this.vectorsCollection||this.sampleVectors.length===0)throw be.warn("Vector search not available: vectors collection or sample vectors not initialized"),new Error("Vector search not available");const s=await this.vectorsCollection.find().exec();be.debug(`Starting vector search with indexDistance=${a}, limit=${n}, sampleVectors=${this.sampleVectors.length}, totalIndexedVectors=${s.length}`);try{await Ai.initialize()}catch(g){throw be.error(`Failed to initialize embedding service for vector search: ${g}`),new Error(`Embedding service initialization failed: ${g}`)}let o;try{o=await Ai.generateEmbedding(t)}catch(g){throw be.error(`Failed to generate query embedding: ${g}`),new Error(`Query embedding generation failed: ${g}`)}if(this.sampleVectors.length===0)throw be.warn("Sample vectors not initialized, cannot perform vector search"),new Error("Sample vectors not initialized");const c=Mp(o,this.sampleVectors);be.debug(`Query index values: ${JSON.stringify(c)}`);const u=new Set;try{for(const g of Bi){const w=c[g],b=w-a,x=w+a;be.debug(`Querying index ${g}: range [${b}, ${x}]`);const O=await this.vectorsCollection.find().where(g).gte(b).lte(x).limit(i).exec();be.debug(`Found ${O.length} candidates in index ${g}`);for(const T of O)u.add(T.documentId)}}catch(g){throw be.error(`Failed to query vector index: ${g}`),new Error(`Vector index query failed: ${g}`)}be.debug(`Total unique candidate IDs: ${u.size} (out of ${s.length} indexed vectors)`);const d=[];try{for(const g of u){const w=await this.vectorsCollection.find().where("documentId").eq(g).exec();for(const b of w){const x=b.toJSON();x&&x.embedding?d.push(x):be.warn(`Invalid vector data for document ${g}`)}}}catch(g){throw be.error(`Failed to fetch candidate vectors: ${g}`),new Error(`Failed to fetch candidate vectors: ${g}`)}be.debug(`Fetched ${d.length} candidate vectors`);const h=[];for(const g of d){const b=(ZO(o,g.embedding)+1)/2;h.push({documentId:g.documentId,similarity:b,chunkIndex:g.chunkIndex,chunkStartOffset:g.chunkStartOffset,chunkEndOffset:g.chunkEndOffset})}h.sort((g,w)=>w.similarity-g.similarity),be.debug(`Computed similarities for ${h.length} candidates, top similarity: ${h[0]?.similarity||"N/A"}`);const p=h.slice(0,n),y=[];for(const g of p){const w=await this.documentsCollection.findOne(g.documentId).exec();if(w){const b=w.toJSON();if(r.workspacePath&&b.workspacePath!==r.workspacePath||r.fileType&&b.fileType!==r.fileType)continue;y.push({document:b,similarity:g.similarity,chunkIndex:g.chunkIndex,chunkStartOffset:g.chunkStartOffset,chunkEndOffset:g.chunkEndOffset})}}return y}async indexFileInContext(t,r,n={}){this.isInitialized||await this.initialize(),this.ensureInitialized();const i=t.getWorkspace().getName(),s=t.getWorkspacePath(),o=this.generateDocumentId(i,s),c=await this.documentsCollection.findOne(o).exec(),u=c?c.toJSON():null,d=r.tags||[],h=[...n.tags||[],...d];if(u){const p=u.metadata.tags||[],y=[...new Set([...p,...h])];return y.length!==p.length||h.some(w=>!p.includes(w))?(await this.updateDocumentMetadata(u.id,{metadata:{...u.metadata,tags:y}}),be.debug(`Added tags to existing document: ${o}`),{...u,metadata:{...u.metadata,tags:y}}):(be.debug(`Document already has all tags: ${o}`),u)}return this.indexDocument(t,{...n,tags:h})}async indexFilesInContext(t,r,n={}){let a=0,i=0;const s=r.tags||[];for(const o of t)try{await this.indexDocument(o,{...n,tags:[...n.tags||[],...s]}),a++,be.debug(`Indexed file with context tags: ${o.getWorkspacePath()}`)}catch(c){be.error(`Failed to index file ${o.getWorkspacePath()}: ${c}`),i++}return{succeeded:a,failed:i}}async reindexFileInContext(t,r,n={}){const a=r.tags||[];return this.reindexDocument(t,{...n,tags:[...n.tags||[],...a]})}async removeFileFromContext(t,r){this.isInitialized||await this.initialize(),this.ensureInitialized();const n=await this.getDocumentByPath(t.getWorkspace().getName(),t.getWorkspacePath());if(n&&r.tags&&r.tags.length>0){const a=new Set(r.tags),i=(n.metadata.tags||[]).filter(s=>!a.has(s));i.length!==n.metadata.tags?.length&&await this.updateDocumentMetadata(n.id,{metadata:{...n.metadata,tags:i}})}}async clearContext(t){if(!t.tags||t.tags.length===0)return;const r=new Set(t.tags),n=await this.listDocuments();for(const a of n)if(a.metadata.tags?.some(s=>r.has(s))){const s=a.metadata.tags.filter(o=>!r.has(o));try{const o=await Va.getWorkspace();if(o&&o.getName()===a.workspacePath){const c=await o.getResource(a.filePath);c instanceof Ir&&await this.indexDocument(c,{tags:s})}}catch(o){be.warn(`Failed to clear context tags from ${a.filePath}: ${o}`)}}}async getFilePathsInContext(t){if(!t.tags||t.tags.length===0)return[];const r=new Set(t.tags);return(await this.listDocuments()).filter(a=>a.metadata.tags?.some(i=>r.has(i))).map(a=>a.filePath)}}const ht=new dN;_b.put("documentIndexService",ht);const Yg=$r("WorkspaceUtils");async function ws(e){const t=await Va.getWorkspace();if(!t)return Yg.warn("No workspace connected"),null;const r=e||t.getName();return r?{workspace:t,workspacePath:r}:(Yg.warn("No workspace path available"),null)}const fN=2;function Ki(e,t={}){if(!e||!e.trim())return[];const r=t.minTermLength??fN;return(t.caseSensitive?e:e.toLowerCase()).split(/\s+/).filter(a=>a.length>=r)}function Nw(e){return e.toLowerCase().trim()}const hN=10,pN=400,mN=400;class Xf{constructor(t={}){this.maxSnippets=t.maxSnippets??hN,this.snippetLength=t.snippetLength??pN,this.minGap=t.minGap??mN}extractSnippets(t,r,n){const a=n??this.maxSnippets;if(r.length===0)return[];const i=t.toLowerCase(),s=[],o=new Set;for(const c of r){let u=i.indexOf(c);for(;u!==-1;){const d=Math.max(0,u-this.snippetLength/2),h=Math.min(t.length,u+c.length+this.snippetLength/2),p=t.substring(d,h).trim(),y=`${d}-${h}`;if(p&&!o.has(y)){o.add(y);const g=this.calculateSnippetScore(p,r);s.push({snippet:p,score:g,start:d})}u=i.indexOf(c,u+1)}}if(s.length===0&&r.length>0){const c=r[0],u=i.indexOf(c);if(u!==-1){const d=Math.max(0,u-this.snippetLength),h=Math.min(t.length,u+c.length+this.snippetLength),p=t.substring(d,h).trim();p&&s.push({snippet:p,score:10,start:d})}}return s.sort((c,u)=>u.score!==c.score?u.score-c.score:c.start-u.start),this.selectNonOverlappingSnippets(s,a)}calculateSnippetScore(t,r){const n=t.toLowerCase();let a=0;for(const c of r){const u=(n.match(new RegExp(c.replace(/[.*+?^${}()|[\]\\]/g,"\\$&"),"gi"))||[]).length;a+=u*10}const i=r.join(" ");n.includes(i)&&(a+=50);const s=r.filter(c=>n.includes(c)).length;a+=s*20;const o=s/r.length;return a+=o*30,a}selectNonOverlappingSnippets(t,r){const n=[],a=[];for(const i of t){if(n.length>=r)break;const s=i.start,o=i.start+i.snippet.length;a.some(u=>!(o<u.start-this.minGap||s>u.end+this.minGap))||(n.push(i.snippet),a.push({start:s,end:o}))}return n}extractSimpleSnippet(t,r=500){return t.substring(0,r)+(t.length>r?"...":"")}extractContextSnippets(t,r,n=150){const a=r.toLowerCase(),i=t.toLowerCase(),s=[];let o=i.indexOf(a);for(;o!==-1;)s.push(o),o=i.indexOf(a,o+1);if(s.length===0)return[];const c=[];for(const u of s){const d=Math.max(0,u-n),h=Math.min(t.length,u+r.length+n);c.push({start:d,end:h,matchIndex:u})}return c}}new Xf;class gN{calculateRelevance(t,r){const n=Nw(r),a=Ki(r);let i=0;const s=t.fileName.toLowerCase(),o=t.filePath.toLowerCase(),c=t.content.toLowerCase(),u=a.filter(b=>s.includes(b)).length,d=a.filter(b=>o.includes(b)).length,h=a.filter(b=>c.includes(b)).length;i+=u*ea.FILE_NAME_MATCH,i+=d*ea.FILE_PATH_MATCH,i+=h*ea.CONTENT_MATCH,s.includes(n)&&(i+=ea.FILE_NAME_EXACT),o.includes(n)&&(i+=ea.FILE_PATH_EXACT);const p=(c.match(new RegExp(n.replace(/[.*+?^${}()|[\]\\]/g,"\\$&"),"g"))||[]).length;i+=p*ea.EXACT_PHRASE;const y=a.length,g=a.filter(b=>c.includes(b)).length,w=y>0?g/y:0;return i+=w*ea.TERM_COVERAGE,i}calculateFileNameRelevance(t,r){const n=t.fileName.toLowerCase(),a=r.toLowerCase();return n===a?100:n.includes(a)?80:0}}const Xg=new gN;class yN{constructor(t){this.snippetExtractor=t}formatRAGContext(t){return t.length===0?"":`Here are relevant documents from the workspace that might help answer the question:

${t.map((n,a)=>{const i=n.document,s=n.matchedSnippets.map((o,c)=>`  [Snippet ${c+1}]
  ${o}`).join(`

`);return`[Document ${a+1}: ${i.fileName} (${i.filePath})]
Relevance: ${n.relevance.toFixed(2)}
${s.length>0?`Relevant snippets:
${s}`:`Content preview: ${this.snippetExtractor.extractSimpleSnippet(i.content,Ln.PREVIEW)}`}
---`}).join(`

`)}

Use the information from these documents to provide a helpful answer. Pay special attention to numbers, percentages, dates, and specific values mentioned in the snippets. If the documents don't contain relevant information, you can still answer based on your general knowledge.`}formatSearchResults(t){return t.map(r=>({file:r.document.fileName,path:r.document.filePath,relevance:r.relevance.toFixed(2),language:r.document.metadata.language,size:r.document.metadata.size,snippets:r.matchedSnippets,preview:this.snippetExtractor.extractSimpleSnippet(r.document.content,200)+"..."}))}formatCommandResults(t){return t.map(r=>({file:r.document.fileName,path:r.document.filePath,relevance:r.relevance,snippets:r.matchedSnippets}))}}const Jr=$r("RAGService"),Fr=new Xf,vN=new yN(Fr);class _N{async searchDocuments(t,r={}){const n=Math.min(r.limit||mo.DEFAULT_LIMIT,mo.MAX_LIMIT),a=await ws(r.workspacePath);if(!a)return Jr.warn("No workspace connected, cannot search documents"),[];const{workspacePath:i}=a;if(r.filePath){const s=await ht.getDocumentByPath(i,r.filePath);if(s){const o=Ki(t),c=o.length>0?Fr.extractSnippets(s.content,o,3):[Fr.extractSimpleSnippet(s.content,Ln.PREVIEW)];return[{document:s,relevance:100,matchedSnippets:c}]}return Jr.warn(`Document not found: ${r.filePath}`),[]}if(r.fileName){const s=await ht.listDocuments(i),o=r.fileName.toLowerCase(),c=s.filter(u=>{const d=u.fileName.toLowerCase();return d===o||d.includes(o)});if(c.length>0){const u=[],d=Ki(t);for(const h of c.slice(0,n)){const p=d.length>0?Fr.extractSnippets(h.content,d,3):[Fr.extractSimpleSnippet(h.content,Ln.PREVIEW)];u.push({document:h,relevance:Xg.calculateFileNameRelevance(h,r.fileName),matchedSnippets:p})}return u}return Jr.warn(`No documents found with name: ${r.fileName}`),[]}if(!t||!t.trim())return Jr.warn("No query provided and no filePath/fileName specified"),[];try{const s=await ht.searchSimilar(t,{limit:n*2,workspacePath:i,fileType:r.fileType}),o=[];for(const{document:c,similarity:u,chunkStartOffset:d,chunkEndOffset:h}of s){if(!this.matchesContextScope(c,r.documentSearchScope))continue;const p=u*100;if(r.minRelevance&&p<r.minRelevance)continue;const y=Nw(t),g=Ki(t);let w;if(d!==void 0&&h!==void 0){const b=c.content.substring(Math.max(0,d),Math.min(c.content.length,h));b.trim().length>0?w=[b.trim()]:w=Fr.extractSnippets(c.content,g,15)}else w=Fr.extractSnippets(c.content,g,15);if(w.length===0&&y.length>0)if(d!==void 0&&h!==void 0){const b=c.content.substring(Math.max(0,d),Math.min(c.content.length,h));b.trim().length>0?w=[b.trim()]:w=Fr.extractSnippets(c.content,[y],10)}else w=Fr.extractSnippets(c.content,[y],10);if(o.push({document:c,relevance:p,matchedSnippets:w}),o.length>=n)break}return o.length===0?(Jr.debug("Vector search returned no results, falling back to text search"),this.fallbackTextSearch(t,r)):o}catch(s){return Jr.warn(`Vector search failed, falling back to text search: ${s}`),Jr.debug(`Vector search error details: ${s}`),this.fallbackTextSearch(t,r)}}async fallbackTextSearch(t,r={}){const n=Math.min(r.limit||mo.DEFAULT_LIMIT,mo.MAX_LIMIT),a=await ws(r.workspacePath);if(!a)return Jr.warn("No workspace connected, cannot perform text search"),[];const{workspacePath:i}=a,s=await ht.listDocuments(i),o=Ki(t),c=[];for(const u of s){if(r.fileType&&u.fileType!==r.fileType||!this.matchesContextScope(u,r.documentSearchScope))continue;const d=Xg.calculateRelevance(u,t);if(r.minRelevance&&d<r.minRelevance)continue;const h=Fr.extractSnippets(u.content,o,3);c.push({document:u,relevance:d,matchedSnippets:h})}return c.sort((u,d)=>d.relevance-u.relevance),c.slice(0,n)}formatRAGContext(t){return vN.formatRAGContext(t)}matchesContextScope(t,r){if(!r)return!0;if(r.includePaths&&r.includePaths.length>0&&!r.includePaths.some(a=>a.includes("*")||a.includes("?")?new RegExp("^"+a.replace(/\*/g,".*").replace(/\?/g,".")+"$").test(t.filePath):t.filePath.startsWith(a)||t.filePath===a)||r.excludePaths&&r.excludePaths.length>0&&r.excludePaths.some(a=>a.includes("*")||a.includes("?")?new RegExp("^"+a.replace(/\*/g,".*").replace(/\?/g,".")+"$").test(t.filePath):t.filePath.startsWith(a)||t.filePath===a)||r.pathPattern&&!(r.pathPattern instanceof RegExp?r.pathPattern:new RegExp(r.pathPattern)).test(t.filePath))return!1;if(r.tags&&r.tags.length>0){const n=t.metadata.tags||[];if(!r.tags.every(i=>n.includes(i)))return!1}return!(r.metadataFilter&&!r.metadataFilter(t))}}const wN=new _N;async function bN(e,t={}){const r=await ws(t.workspacePath);return r?wN.searchDocuments(e,{...t,workspacePath:r.workspacePath}):(Jr.warn("No workspace connected, cannot search documents"),[])}var EN=Object.defineProperty,xN=Object.getOwnPropertyDescriptor,wr=(e,t,r,n)=>{for(var a=n>1?void 0:n?xN(t,r):t,i=e.length-1,s;i>=0;i--)(s=e[i])&&(a=(n?s(t,r,a):s(a))||a);return n&&a&&EN(t,r,a),a};const Li=$r("RAGSystemManager"),ey=new Xf;let Zt=class extends wb{constructor(){super(...arguments),this.documents=[],this.stats={totalDocuments:0,byWorkspace:{}},this.loading=!1,this.selectedDocument=null,this.searchQuery="",this.filterWorkspace=null,this.filterByActiveWorkspace=!0,this.filteredDocuments=[],this.searchResults=new Map,this.reindexing=!1,this.treeRef=ub(),this.searchInputValue=""}async doInitUI(){try{await ht.initialize(),await Promise.all([this.loadDocuments(),this.loadStats()])}catch(e){Li.error(`Failed to initialize document index manager: ${e}`),ft(`Failed to initialize: ${e}`)}}async loadDocuments(){this.loading=!0,this.requestUpdate();try{let e;this.filterByActiveWorkspace&&(e=(await ws())?.workspacePath),this.documents=await ht.listDocuments(e),await this.updateFilteredDocuments()}catch(e){Li.error(`Failed to load documents: ${e}`),ft(`Failed to load documents: ${e}`)}finally{this.loading=!1}}async updateFilteredDocuments(){this.filteredDocuments=await this.getFilteredDocuments(),this.requestUpdate()}async loadStats(){try{this.stats=await ht.getStats(),this.requestUpdate()}catch(e){Li.error(`Failed to load stats: ${e}`)}}handleTreeSelection(e){let t=e.detail?.selection||[];if(t.length===0&&this.treeRef.value&&(t=this.treeRef.value.selectedItems||[]),t.length>0){const r=t[0];r?.model?this.selectedDocument=r.model:this.selectedDocument=null}else this.selectedDocument=null}async getFilteredDocuments(){if(!this.documents||this.documents.length===0)return[];if(this.searchQuery.trim())try{const t=await bN(this.searchQuery,{limit:50,workspacePath:this.filterWorkspace||void 0});this.searchResults.clear();const r=new Map,n=new Map;for(const i of t){const s=i.document.id;r.set(s,i.document);const o=n.get(s);if(!o)n.set(s,{document:i.document,relevance:i.relevance,matchedSnippets:[...i.matchedSnippets]});else{i.relevance>o.relevance&&(o.relevance=i.relevance);const c=new Set(o.matchedSnippets);for(const u of i.matchedSnippets)c.has(u)||(o.matchedSnippets.push(u),c.add(u))}}for(const[i,s]of n)this.searchResults.set(i,s);const a=Array.from(r.values());return this.filterWorkspace?a.filter(i=>i.workspacePath===this.filterWorkspace):a}catch(t){return Li.debug(`RAG search failed in document manager: ${t}`),this.searchResults.clear(),[]}else this.searchResults.clear();let e=[...this.documents];return this.filterWorkspace&&(e=e.filter(t=>t.workspacePath===this.filterWorkspace)),e}highlightMatches(e,t){if(!t||!t.trim())return ct`${e}`;const r=t.toLowerCase(),n=e.toLowerCase(),a=[];let i=0,s=n.indexOf(r,i);for(;s!==-1;)s>i&&a.push(e.substring(i,s)),a.push(ct`<mark class="search-match">${e.substring(s,s+t.length)}</mark>`),i=s+t.length,s=n.indexOf(r,i);return i<e.length&&a.push(e.substring(i)),ct`${a}`}getContentPreview(e){const t=this.searchResults.get(e.id);if(t&&t.matchedSnippets.length>0)return ct`
                <table class="snippets-table">
                    <thead>
                        <tr>
                            <th class="snippet-number-col">#</th>
                            <th class="snippet-content-col">Content</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${t.matchedSnippets.map((n,a)=>ct`
                            <tr>
                                <td class="snippet-number">${a+1}</td>
                                <td class="snippet-content">${this.highlightMatches(n,this.searchQuery)}</td>
                            </tr>
                        `)}
                    </tbody>
                </table>
            `;if(this.searchQuery&&this.searchQuery.trim()){const n=ey.extractContextSnippets(e.content,this.searchQuery,Ln.CONTEXT);if(n.length>0)return ct`
                    <table class="snippets-table">
                        <thead>
                            <tr>
                                <th class="snippet-number-col">#</th>
                                <th class="snippet-content-col">Content</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${n.map((a,i)=>ct`
                                <tr>
                                    <td class="snippet-number">${i+1}</td>
                                    <td class="snippet-content">${this.highlightMatches(e.content.substring(a.start,a.end),this.searchQuery)}</td>
                                </tr>
                            `)}
                        </tbody>
                    </table>
                `}const r=ey.extractSimpleSnippet(e.content,GO.LONG);return ct`
            <div class="snippet-preview">${r}</div>
        `}async deleteDocument(e){try{await ht.deleteDocument(e.id),er(`Deleted: ${e.fileName}`),await this.loadDocuments(),await this.loadStats(),this.selectedDocument?.id===e.id&&(this.selectedDocument=null)}catch(t){ft(`Failed to delete document: ${t}`)}}async reindexDocument(e){try{const t=await ws();if(!t){ft("No workspace connected");return}const r=await t.workspace.getResource(e.filePath);if(!r){ft(`File not found: ${e.filePath}`);return}if(!(r instanceof Ir)){ft(`Resource is not a file: ${e.filePath}`);return}const n=r;await Qr.runAsync("Reindexing document",async a=>{a.message=`Reindexing ${e.fileName}...`,await ht.reindexDocument(n),a.progress=100}),er(`Reindexed: ${e.fileName}`),await this.loadDocuments(),this.selectedDocument?.id===e.id&&(this.selectedDocument=await ht.getDocument(e.id))}catch(t){ft(`Failed to reindex document: ${t}`)}}async reindexAllDocuments(){if(this.reindexing)return;const e=await ht.getStats();if(e.totalDocuments===0){er("No documents to reindex");return}this.reindexing=!0,this.requestUpdate();try{const t=await Qr.runAsync("Reindexing all documents",async r=>{r.message="Starting reindexing...";const n=e.totalDocuments,a=await ht.reindexAllDocuments(),i=a.succeeded+a.failed;return r.progress=n>0?i/n*100:100,r.message=`Reindexed ${a.succeeded}/${n} documents${a.failed>0?` (${a.failed} failed)`:""}`,a});await this.loadDocuments(),await this.loadStats(),er(`Reindexing completed: ${t.succeeded} succeeded, ${t.failed} failed`)}catch(t){Li.error(`Failed to reindex all documents: ${t}`),ft(`Failed to reindex all documents: ${t}`)}finally{this.reindexing=!1,this.requestUpdate()}}formatFileSize(e){return e<1024?`${e} B`:e<1024*1024?`${(e/1024).toFixed(1)} KB`:`${(e/(1024*1024)).toFixed(1)} MB`}formatDate(e){return new Date(e).toLocaleString()}getFileIcon(e){return td.getFileIcon(e)}renderToolbar(){const e=Object.keys(this.stats?.byWorkspace||{});return ct`
            <wa-input
                type="search"
                placeholder="Search documents..."
                .value=${this.searchInputValue}
                @input=${t=>{this.searchInputValue=t.target.value,this.searchDebounceTimer&&clearTimeout(this.searchDebounceTimer),this.searchDebounceTimer=window.setTimeout(async()=>{this.searchQuery=this.searchInputValue,await this.updateFilteredDocuments()},200)}}
                @wa-clear=${async()=>{this.searchDebounceTimer&&clearTimeout(this.searchDebounceTimer),this.searchInputValue="",this.searchQuery="",await this.updateFilteredDocuments()}}
                size="small"
                with-clear
                autocomplete="off"
                style="flex: 1; max-width: 400px;">
                <wa-icon name="magnifying-glass" slot="start"></wa-icon>
            </wa-input>
            
            <wa-switch
                .checked=${this.filterByActiveWorkspace}
                @change=${async t=>{this.filterByActiveWorkspace=t.target.checked,await this.loadDocuments()}}
                size="small">
                Active workspace only
            </wa-switch>
            
            ${e.length>1?ct`
                <wa-select 
                    .value=${this.filterWorkspace||""}
                    @change=${async t=>{this.filterWorkspace=t.target.value||null,await this.updateFilteredDocuments()}}
                    size="small"
                    style="width: 200px;">
                    <wa-option value="">All Workspaces</wa-option>
                    ${e.map(t=>ct`
                        <wa-option value="${t}">${t} (${this.stats.byWorkspace[t]})</wa-option>
                    `)}
                </wa-select>
            `:lo}
            
            <k-command 
                size="small" 
                icon="arrow-rotate-right"
                title="Refresh document list"
                .action=${()=>this.loadDocuments()}
                ?disabled=${this.reindexing}>
                Refresh
            </k-command>
            
            <k-command 
                size="small" 
                icon="database"
                title="Re-index all documents"
                .action=${()=>this.reindexAllDocuments()}
                ?disabled=${this.reindexing||this.loading}>
                ${this.reindexing?"Reindexing...":"Re-index All"}
            </k-command>
        `}render(){this.stats||(this.stats={totalDocuments:0,byWorkspace:{}});const e=this.filteredDocuments,t=Object.keys(this.stats.byWorkspace||{});return ct`
            <div class="rag-system-manager">
                <div class="header">
                    <div class="header-content">
                        <div class="stats">
                            <span>Total: ${this.stats.totalDocuments} documents</span>
                            ${t.length>0?ct`
                                <span>Workspaces: ${t.length}</span>
                            `:lo}
                        </div>
                    </div>
                </div>

                <wa-split-panel position="40" style="height: 100%;">
                    <div class="document-list" slot="start">
                        ${this.loading?ct`
                            <div class="loading">
                                <wa-spinner></wa-spinner>
                                <span>Loading documents...</span>
                            </div>
                        `:e.length===0?ct`
                            <div class="empty">
                                <wa-icon name="inbox" style="font-size: 3rem; opacity: 0.3;"></wa-icon>
                                <p>${this.searchQuery||this.filterWorkspace?"No documents match your filters":"No documents indexed yet"}</p>
                            </div>
                        `:ct`
                            <wa-tree 
                                ${lb(this.treeRef)}
                                selection="leaf"
                                style="--indent-guide-width: 1px;"
                                @wa-selection-change=${r=>{this.handleTreeSelection(r)}}>
                                ${e.map(r=>ct`
                                    <wa-tree-item 
                                        .model=${r}
                                        ?selected=${this.selectedDocument?.id===r.id}>
                                        <wa-icon name="${this.getFileIcon(r.fileType)}"></wa-icon>
                                            <div class="tree-item-info">
                                                <strong class="tree-item-path">${r.filePath}</strong>
                                                <div class="tree-item-meta">
                                                    <small class="meta-size">${this.formatFileSize(r.metadata.size)}</small>
                                                    <small class="meta-date">${this.formatDate(r.indexedAt)}</small>
                                                </div>
                                            </div>
                                            <div class="tree-item-actions" @click=${n=>n.stopPropagation()}>
                                                <wa-button
                                                    variant="neutral"
                                                    appearance="plain"
                                                    size="small"
                                                    title="Reindex"
                                                    @click=${()=>this.reindexDocument(r)}>
                                                    <wa-icon name="arrow-rotate-right"></wa-icon>
                                                </wa-button>
                                                <wa-button
                                                    variant="danger"
                                                    appearance="plain"
                                                    size="small"
                                                    title="Delete"
                                                    @click=${()=>this.deleteDocument(r)}>
                                                    <wa-icon name="trash"></wa-icon>
                                                </wa-button>
                                            </div>
                                    </wa-tree-item>
                                `)}
                            </wa-tree>
                        `}
                    </div>

                    <div slot="end">
                        ${this.selectedDocument?ct`
                            <div class="document-details">
                                <div class="details-content">
                                    <div class="metadata-grid">
                                        <wa-input
                                            label="File Path"
                                            .value=${this.selectedDocument.filePath}
                                            readonly
                                            size="small">
                                            <wa-copy-button
                                                slot="end"
                                                .value=${this.selectedDocument.filePath}
                                                size="small"
                                                label="Copy file path">
                                            </wa-copy-button>
                                        </wa-input>
                                        
                                        <wa-input
                                            label="Workspace"
                                            .value=${this.selectedDocument.workspacePath}
                                            readonly
                                            size="small">
                                            <wa-copy-button
                                                slot="end"
                                                .value=${this.selectedDocument.workspacePath}
                                                size="small"
                                                label="Copy workspace">
                                            </wa-copy-button>
                                        </wa-input>
                                        
                                        <wa-input
                                            label="File Type"
                                            .value=${this.selectedDocument.fileType}
                                            readonly
                                            size="small">
                                            <wa-copy-button
                                                slot="end"
                                                .value=${this.selectedDocument.fileType}
                                                size="small"
                                                label="Copy file type">
                                            </wa-copy-button>
                                        </wa-input>
                                        
                                        <wa-input
                                            label="Size"
                                            .value=${this.formatFileSize(this.selectedDocument.metadata.size)}
                                            readonly
                                            size="small">
                                            <wa-copy-button
                                                slot="end"
                                                .value=${this.formatFileSize(this.selectedDocument.metadata.size)}
                                                size="small"
                                                label="Copy size">
                                            </wa-copy-button>
                                        </wa-input>
                                        
                                        <wa-input
                                            label="Indexed At"
                                            .value=${this.formatDate(this.selectedDocument.indexedAt)}
                                            readonly
                                            size="small">
                                            <wa-copy-button
                                                slot="end"
                                                .value=${this.formatDate(this.selectedDocument.indexedAt)}
                                                size="small"
                                                label="Copy indexed date">
                                            </wa-copy-button>
                                        </wa-input>
                                        
                                        <wa-input
                                            label="Last Updated"
                                            .value=${this.formatDate(this.selectedDocument.updatedAt)}
                                            readonly
                                            size="small">
                                            <wa-copy-button
                                                slot="end"
                                                .value=${this.formatDate(this.selectedDocument.updatedAt)}
                                                size="small"
                                                label="Copy updated date">
                                            </wa-copy-button>
                                        </wa-input>
                                    </div>
                                    
                                    ${this.selectedDocument.metadata.tags&&this.selectedDocument.metadata.tags.length>0?ct`
                                        <div class="tags-section">
                                            <wa-input
                                                label="Tags"
                                                .value=${this.selectedDocument.metadata.tags.join(", ")}
                                                readonly
                                                size="small">
                                                <wa-copy-button
                                                    slot="end"
                                                    .value=${this.selectedDocument.metadata.tags.join(", ")}
                                                    size="small"
                                                    label="Copy tags">
                                                </wa-copy-button>
                                            </wa-input>
                                        </div>
                                    `:lo}
                                
                                    <div class="detail-section">
                                        <label>Content Preview${this.searchQuery?ct` <span class="search-hint">(showing matches for "${this.searchQuery}")</span>`:lo}</label>
                                        <wa-scroller class="content-preview" orientation="vertical">
                                            <div class="content-preview-inner">
                                                ${this.getContentPreview(this.selectedDocument)}
                                            </div>
                                        </wa-scroller>
                                    </div>
                                </div>
                            </div>
                    `:ct`
                            <div class="document-details empty">
                                <wa-icon name="file-lines" style="font-size: 3rem; opacity: 0.3;"></wa-icon>
                                <p>Select a document to view details</p>
                            </div>
                        `}
                    </div>
                </wa-split-panel>
            </div>
        `}};Zt.styles=ob`
        :host {
            display: flex;
            flex-direction: column;
            height: 100%;
            overflow: hidden;
            min-height: 0;
        }

        .rag-system-manager {
            display: flex;
            flex-direction: column;
            height: 100%;
            min-height: 0;
            overflow: hidden;
        }

        wa-split-panel {
            flex: 1;
            min-height: 0;
            overflow: hidden;
        }

        .document-list {
            height: 100%;
            overflow-y: auto;
        }

        .tree-item-info {
            flex: 1;
            min-width: 0;
        }

        .tree-item-path {
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        .tree-item-meta {
            display: flex;
            align-items: center;
            gap: var(--wa-space-xs);
            flex-wrap: wrap;
            margin-top: var(--wa-space-xs);
        }

        .tree-item-actions {
            opacity: 0;
        }

        wa-tree-item:hover .tree-item-actions {
            opacity: 1;
        }

        .document-details {
            height: 100%;
            display: flex;
            flex-direction: column;
            min-height: 0;
            overflow: hidden;
        }

        .details-content {
            flex: 1;
            display: flex;
            flex-direction: column;
            padding: var(--wa-space-s);
            min-height: 0;
            overflow: hidden;
        }

        .metadata-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: var(--wa-space-s);
            flex-shrink: 0;
        }

        .tags-section {
            margin-top: var(--wa-space-s);
            flex-shrink: 0;
            margin-bottom: var(--wa-space-s);
        }

        .detail-section {
            flex: 1;
            display: flex;
            flex-direction: column;
            min-height: 0;
            position: relative;
        }

        .detail-section label {
            flex-shrink: 0;
            margin-bottom: var(--wa-space-xs);
        }

        .content-preview {
            position: absolute;
            top: 0;
            right: 0;
            left: 0;
            bottom: 0;
        }

        .content-preview-inner {
            width: 100%;
        }

        .snippets-table {
            width: 100%;
            border-collapse: collapse;
            background-color: var(--wa-color-surface-raised);
        }

        .snippets-table thead {
            background-color: var(--wa-color-neutral-fill-quiet);
        }

        .snippets-table th {
            padding: var(--wa-space-xs) var(--wa-space-s);
            text-align: left;
            font-size: 0.75rem;
            font-weight: 600;
            color: var(--wa-color-text-quiet);
            border-bottom: 1px solid var(--wa-color-surface-border);
        }

        .snippets-table td {
            padding: var(--wa-space-s);
            border-bottom: 1px solid var(--wa-color-surface-border);
            vertical-align: top;
        }

        .snippets-table tbody tr:last-child td {
            border-bottom: none;
        }

        .snippets-table tbody tr:hover {
            background-color: var(--wa-color-neutral-fill-quiet);
        }

        .snippet-number-col {
            width: 3rem;
            text-align: center;
        }

        .snippet-content-col {
            width: auto;
        }

        .snippet-number {
            font-size: 0.75rem;
            font-weight: 600;
            color: var(--wa-color-text-quiet);
            text-align: center;
        }

        .snippet-content {
            white-space: pre-wrap;
            word-wrap: break-word;
            overflow-wrap: break-word;
            font-family: monospace;
            font-size: 0.875rem;
            line-height: 1.5;
            color: var(--wa-color-text-normal);
        }

        .snippet-preview {
            white-space: pre-wrap;
            word-wrap: break-word;
            overflow-wrap: break-word;
            font-family: monospace;
            font-size: 0.875rem;
            line-height: 1.5;
            color: var(--wa-color-text-normal);
            padding: var(--wa-space-s);
            background-color: var(--wa-color-surface-raised);
            border-radius: var(--wa-border-radius-medium);
        }

        .snippet-content mark.search-match {
            background: var(--wa-color-warning-fill-loud);
            color: var(--wa-color-warning-text-loud);
            padding: 0 2px;
            border-radius: 2px;
            font-weight: 600;
        }
    `;wr([cb({attribute:!1})],Zt.prototype,"input",2);wr([Kr()],Zt.prototype,"documents",2);wr([Kr()],Zt.prototype,"stats",2);wr([Kr()],Zt.prototype,"loading",2);wr([Kr()],Zt.prototype,"selectedDocument",2);wr([Kr()],Zt.prototype,"searchQuery",2);wr([Kr()],Zt.prototype,"filterWorkspace",2);wr([Kr()],Zt.prototype,"filterByActiveWorkspace",2);wr([Kr()],Zt.prototype,"filteredDocuments",2);wr([Kr()],Zt.prototype,"searchResults",2);wr([Kr()],Zt.prototype,"reindexing",2);Zt=wr([db("k-rag-system-manager")],Zt);const ta=$r("RAGSystemExtension");function SN(e){ht.initialize().catch(t=>{ta.error(`Failed to initialize document index service: ${t}`)}),xn({command:{id:"rag-system.index-file",name:"Index Document",description:"Index the currently selected file for search and retrieval",parameters:[{name:"includeContent",description:"Whether to include full content in index (default: true)",required:!1}]},handler:{canExecute:t=>Qn.get()instanceof Ir,execute:async t=>{const r=Qn.get();if(!(r instanceof Ir)){ft("Please select a file to index");return}const n=t.params?.includeContent!==!1;await Qr.runAsync("Indexing document",async a=>{a.message=`Indexing ${r.getName()}...`;try{const i=await ht.indexDocument(r,{includeContent:n});a.progress=100,er(`Document indexed: ${i.fileName}`)}catch(i){throw ft(`Failed to index document: ${i}`),i}})}}}),xn({command:{id:"rag-system.index-workspace",name:"Index Workspace",description:"Index all indexable files in the current workspace",parameters:[{name:"includeContent",description:"Whether to include full content in index (default: true)",required:!1},{name:"maxFileSize",description:"Maximum file size in bytes to index (default: 5MB)",required:!1}]},handler:{canExecute:t=>!0,execute:async t=>{const r=await Va.getWorkspace();if(!r){ft("No workspace selected");return}const n=t.params?.includeContent!==!1,a=t.params?.maxFileSize?parseInt(t.params.maxFileSize):void 0;await Qr.runAsync("Indexing workspace",async i=>{i.message="Collecting files...",i.progress=0;try{const s=await ht.indexWorkspace(r,{includeContent:n,maxFileSize:a});i.progress=100,s.failed>0?ft(`Indexing complete: ${s.indexed} indexed, ${s.failed} failed. Check console for details.`):er(`Workspace indexed: ${s.indexed} documents`)}catch(s){throw ft(`Failed to index workspace: ${s}`),s}})}}}),xn({command:{id:"rag-system.list-documents",name:"List Indexed Documents",description:"List all indexed documents in the current workspace",parameters:[]},handler:{canExecute:t=>!0,execute:async t=>{const n=(await Va.getWorkspace())?.getName();await Qr.runAsync("Loading indexed documents",async a=>{try{const i=await ht.listDocuments(n);a.progress=100,i.length===0?er("No documents indexed in this workspace"):(ta.info(`Found ${i.length} indexed documents`),er(`Found ${i.length} indexed documents (check console for details)`))}catch(i){throw ft(`Failed to list documents: ${i}`),i}})}}}),xn({command:{id:"rag-system.delete-document",name:"Delete Document from Index",description:"Remove the selected file from the document index",parameters:[]},handler:{canExecute:t=>Qn.get()instanceof Ir,execute:async t=>{const r=Qn.get();if(!(r instanceof Ir)){ft("Please select a file to remove from index");return}const a=r.getWorkspace().getName(),i=r.getWorkspacePath();await Qr.runAsync("Deleting document from index",async s=>{try{const o=await ht.deleteDocumentByPath(a,i);s.progress=100,o?er(`Document removed from index: ${r.getName()}`):er(`Document not found in index: ${r.getName()}`)}catch(o){throw ft(`Failed to delete document from index: ${o}`),o}})}}}),xn({command:{id:"rag-system.clear-workspace",name:"Clear Workspace Index",description:"Remove all indexed documents from the current workspace",parameters:[]},handler:{canExecute:t=>!0,execute:async t=>{const r=await Va.getWorkspace();if(!r){ft("No workspace selected");return}const n=r.getName();await Qr.runAsync("Clearing workspace index",async a=>{try{const i=await ht.deleteWorkspace(n);a.progress=100,er(`Removed ${i} documents from index`)}catch(i){throw ft(`Failed to clear workspace index: ${i}`),i}})}}}),xn({command:{id:"rag-system.get-stats",name:"Document Index Statistics",description:"Get statistics about the document index",parameters:[]},handler:{canExecute:t=>!0,execute:async t=>{await Qr.runAsync("Loading statistics",async r=>{try{const n=await ht.getStats();r.progress=100,ta.info(`Document index statistics: ${JSON.stringify(n)}`),er(`Index statistics: ${n.totalDocuments} total documents. Check console for details.`)}catch(n){throw ft(`Failed to get statistics: ${n}`),n}})}}}),xn({command:{id:"rag-system.reindex-file",name:"Reindex Document",description:"Reindex the selected file (useful after file changes)",parameters:[]},handler:{canExecute:t=>Qn.get()instanceof Ir,execute:async t=>{const r=Qn.get();if(!(r instanceof Ir)){ft("Please select a file to reindex");return}await Qr.runAsync("Reindexing document",async n=>{n.message=`Reindexing ${r.getName()}...`;try{const a=await ht.reindexDocument(r);n.progress=100,er(`Document reindexed: ${a.fileName}`)}catch(a){throw ft(`Failed to reindex document: ${a}`),a}})}}}),ta.info("RAG system extension loaded"),td.registerEditorInputHandler({ranking:1e3,canHandle:t=>t.key===".system.rag-system",handle:async t=>(t.editorId="rag-system-manager",t.widgetFactory=()=>ct`
                <k-rag-system-manager .input=${t}></k-rag-system-manager>
            `,t)}),xn({command:{id:"open-rag-system-manager",name:"Open RAG System Manager",description:"Opens the RAG system manager to view and manage indexed documents",parameters:[]},handler:{execute:t=>{const r={title:"RAG System Manager",data:{},key:".system.rag-system",icon:"database",state:{}};td.loadEditor(r).catch(n=>{ta.error(`Failed to open document index manager: ${n}`)})}},contribution:{target:Eb,icon:"database",label:"RAG System"}}),bb.registerContribution("contextmenu:filebrowser",{command:"rag-system.index-file",icon:"database",label:"Index Document",disabled:()=>!(Qn.get()instanceof Ir)}),ty(()=>import("./rag-integration-OPE_9al8.js"),__vite__mapDeps([0,1,2,3,4])).then(t=>{t.integrateRAGWithAI(),ta.info("RAG integration enabled")}).catch(t=>{ta.warn(`Failed to load RAG integration: ${t}`)})}const zN=Object.freeze(Object.defineProperty({__proto__:null,default:SN},Symbol.toStringTag,{value:"Module"}));export{yN as R,mo as S,Xf as a,zN as b,ht as d,ws as g,wN as r,bN as s};
