import{N as F,O as k,P as O,V as w,Q as C,R as h,S as I,U as V,W as A,X as v,Y as U,z as _,Z as R,$ as x,a0 as P,a1 as j,a2 as N,a3 as q,a4 as z,a5 as D,a6 as H,a7 as Y,J as E,a8 as S,a9 as Z,u as $}from"./index-CSVE5gI6.js";const G=async i=>{var o;const e={interactions:k({keyboard:!1}),controls:F((o=i.mapOptions)==null?void 0:o.controls)},t=i.modules?async a=>i.modules[a]:void 0,r=await O(i.gsMap,e,i.env,t),s=typeof i.containerSelector=="string"?document.querySelector(i.containerSelector):i.containerSelector;return r.setTarget(s),r};function K(i){const e=i.getGeometry();return E({geometry:E({type:e.getType(),coordinates:[]}),state:i.get(S)})}class J{constructor(e,t){this.isDestroyed=!1,this.styleCache=new Map,this.gsMap=e,this.env=t}async reattached(){}async render(e){try{this.olMap=await G({containerSelector:e,gsMap:this.gsMap,env:this.env,mapOptions:{controls:{zoom:!1,attribution:!1}}}),this.operations=new Q(this.olMap,this),this.applyStylesToLayers(),this.olMap.once("rendercomplete",()=>{this.setupEventListeners()})}catch(t){throw console.error("Failed to render map:",t),t}}applyStylesToLayers(){if(!this.olMap)return;this.olMap.getLayers().getArray().forEach(t=>{t instanceof w&&this.applyStyleToVectorLayer(t)})}applyStyleToVectorLayer(e){const t=e.get(C),r=s=>{if(!(s instanceof V))return;const o=K(s),a=this.gsMap.styleRules,c=this.gsMap.styles;if(a&&c){const n=A(o,a,c,t);if(n&&n.id){let l=this.styleCache.get(n.id);return l||(l=v(n),this.styleCache.set(n.id,l)),l}else if(n)return v(n)}};e.setStyle(r)}clearStyleCache(){this.styleCache.clear()}async modelToUI(e){if(!this.olMap)throw new Error("Map not initialized");e&&(this.gsMap=e),this.clearStyleCache();const t=this.olMap.getTarget();if(!t||typeof t=="string")throw new Error("Map container not found or invalid");this.destroy(),t.innerHTML="",this.isDestroyed=!1,await this.render(t)}getOperations(){if(!this.operations)throw new Error("Operations not available - map not rendered yet");return this.operations}getViewExtent(){if(!this.olMap)throw new Error("OpenLayers map not available for extent calculation");return this.olMap.getView().calculateExtent()}setOnDirty(e){this.onDirtyCallback=e}setOnSync(e){this.onSyncCallback=e}triggerDirty(){this.isDestroyed||!this.onDirtyCallback||this.onDirtyCallback()}triggerSync(e){this.isDestroyed||!this.onSyncCallback||this.onSyncCallback(e)}syncViewToModel(){if(!this.olMap)return;const e=this.olMap.getView(),t=e.getCenter(),r=e.getZoom(),s=e.getRotation();t&&r!==void 0&&this.triggerSync({type:"viewChanged",view:{center:t,zoom:r,rotation:s}})}syncLayerFeaturesToModel(e){if(!this.olMap)return;const t=this.olMap.getLayers();let r;for(let c=0;c<t.getLength();c++){const n=t.item(c);if(n.get(h)===e){r=n;break}}if(!r||!(r instanceof w))return;const s=r.getSource();if(!s)return;const a=s.getFeatures().map(c=>I(c));this.triggerSync({type:"featuresChanged",layerUuid:e,features:a})}setupEventListeners(){this.olMap&&(this.olMap.getView().on("change:center",()=>{this.syncViewToModel(),this.triggerDirty()}),this.olMap.getView().on("change:resolution",()=>{this.syncViewToModel(),this.triggerDirty()}),this.olMap.getView().on("change:rotation",()=>{this.syncViewToModel(),this.triggerDirty()}),this.olMap.getLayers().on("add",()=>this.triggerDirty()),this.olMap.getLayers().on("remove",()=>this.triggerDirty()),this.olMap.getControls().on("add",()=>this.triggerDirty()),this.olMap.getControls().on("remove",()=>this.triggerDirty()),this.olMap.getOverlays().on("add",()=>this.triggerDirty()),this.olMap.getOverlays().on("remove",()=>this.triggerDirty()))}destroy(){var e;if(this.isDestroyed=!0,this.clearStyleCache(),this.operations){const t=this.operations;t.cleanup&&t.cleanup()}(e=this.olMap)==null||e.dispose(),this.olMap=void 0}}class Q{constructor(e,t){if(this.olMap=e,this.renderer=t,!e)throw new Error("OpenLayers map is required for operations");this.keyDownListener=s=>{var o;s.key==="Escape"&&(this.drawInteraction&&(this.disableDrawing(),(o=this.renderer)==null||o.triggerSync({type:"drawingDisabled"})),this.selectInteraction&&this.disableSelection())};const r=this.olMap.getTargetElement();r&&r instanceof HTMLElement&&(r.setAttribute("tabindex","-1"),r.addEventListener("keydown",this.keyDownListener))}async setZoom(e){this.olMap.getView().setZoom(e)}async setCenter(e){this.olMap.getView().setCenter(e)}async switchColorMode(e){const t=this.olMap;let r=t.get("darkmode")??!1;e==="dark"?r=!0:e==="light"?r=!1:r=!r,t.set("darkmode",r),document.querySelectorAll("canvas").forEach(o=>{o.style.filter=r?"invert(100%)":""}),t.render()}async addLayer(e,t){const r=U(e);t?this.olMap.getLayers().insertAt(0,r):this.olMap.getLayers().push(r)}async deleteLayer(e){const t=this.olMap.getLayers();for(let r=0;r<t.getLength();r++)if(t.item(r).get(h)===e){t.removeAt(r);return}}async renameLayer(e,t){const r=this.olMap.getLayers();for(let s=0;s<r.getLength();s++){const o=r.item(s);if(o.get(h)===e){o.set(C,t);return}}}async moveLayer(e,t){const r=this.olMap.getLayers();let s=-1,o=-1;for(let a=0;a<r.getLength();a++){const c=r.item(a);c.get(h)===e&&(s=a),t&&c.get(h)===t&&(o=a)}if(!(s<0)){if(t){if(o<0||s===o)return}else o=s>0?s-1:s+1;if(o>=0&&o<r.getLength()&&s!==o){const a=r.item(s);r.removeAt(s),r.insertAt(o,a)}}}async setLayerVisible(e,t){const r=this.olMap.getLayers();for(let s=0;s<r.getLength();s++){const o=r.item(s);if(o.get(h)===e){o.setVisible(t);return}}}async addControlFromModule(e){}async removeControl(e){}async addOverlayFromModule(e,t){}async removeOverlay(e){}setCursor(e){const t=this.olMap.getViewport();t&&(t.style.cursor=e)}async enableDrawing(e,t){this.disableSelection(),this.drawInteraction&&this.olMap.removeInteraction(this.drawInteraction),this.activeDrawingLayerUuid=t,this.setCursor("crosshair");const r=this.olMap.getLayers();let s;for(let n=0;n<r.getLength();n++){const l=r.item(n);if(l.get(h)===t){s=l;break}}if(!s||!(s instanceof w))throw new Error("Drawing only supported on vector layers");const o=s.getSource();if(!o)throw new Error("Layer has no source");const a=s.get("sourceType");if(a&&a!==_.Features)throw new Error("Drawing only supported on layers with in-memory features, not URL-loaded data");this.drawInteraction=new R({source:o,type:e});const c=n=>{var g;const l=n.feature;if(l&&!l.get(h)){const f=Z();l.set(h,f);const u=l.get(S)||{};u.uuid=f,l.set(S,u)}this.renderer&&this.activeDrawingLayerUuid&&this.renderer.syncLayerFeaturesToModel(this.activeDrawingLayerUuid),(g=this.renderer)==null||g.triggerDirty()};o.on("addfeature",c),this.drawInteraction._featureAddedListener=c,this.drawInteraction._sourceRef=o,this.olMap.addInteraction(this.drawInteraction)}async disableDrawing(){if(this.drawInteraction){const e=this.drawInteraction._featureAddedListener,t=this.drawInteraction._sourceRef;e&&t&&t.un("addfeature",e),this.olMap.removeInteraction(this.drawInteraction),this.drawInteraction=void 0,this.setCursor("")}}cleanup(){if(this.keyDownListener){const e=this.olMap.getTargetElement();e&&e instanceof HTMLElement&&e.removeEventListener("keydown",this.keyDownListener),this.keyDownListener=void 0}}async enableFeatureSelection(){var a,c;this.disableDrawing(),this.disableSelection();const e=this.olMap.getLayers(),t=e.getArray().filter(n=>n instanceof w);if(t.length===0)throw new Error("No vector layers available for selection");const r=(a=this.renderer)==null?void 0:a.gsMap,s=(c=r==null?void 0:r.styles)==null?void 0:c.selection,o={condition:z,layers:t,hitTolerance:5,style:s?v(s):n=>{const l=new x({color:"rgba(255, 255, 0, 1)",width:3}),g=new P({color:"rgba(255, 255, 0, 0.3)"});return new j({image:new N({radius:7,fill:g,stroke:l}),stroke:l,fill:g})}};this.selectInteraction=new q(o),this.selectInteraction.on("select",n=>{var l;if(n.selected.length>0){const g=n.selected[0];let f;if(e.getArray().forEach(u=>{if(u instanceof w){const d=u.getSource();if(d&&d.hasFeature(g)){const p=u.get(h);p&&(f=p)}}}),f&&this.renderer){const u=I(g),d=g.getGeometry(),p={};if(d){const M=d.getType();try{if(M==="LineString"||M==="MultiLineString")p.length=D(d,{projection:this.olMap.getView().getProjection()});else if(M==="Polygon"||M==="MultiPolygon"){p.area=H(d,{projection:this.olMap.getView().getProjection()});const m=M==="Polygon"?d.getCoordinates()[0]:d.getCoordinates()[0][0];if(m&&m.length>0){const b=new Y(m);p.length=D(b,{projection:this.olMap.getView().getProjection()})}}}catch(m){console.warn("Error calculating feature metrics:",m)}}this.renderer.triggerSync({type:"featureSelected",layerUuid:f,feature:u,metrics:p})}}else n.deselected.length>0&&((l=this.renderer)==null||l.triggerSync({type:"featureDeselected"}))}),this.olMap.addInteraction(this.selectInteraction),this.setCursor("pointer")}async deleteSelectedFeatures(){var s;if(!this.selectInteraction)throw new Error("No selection interaction active");const e=this.selectInteraction.getFeatures();if(e.getLength()===0)throw new Error("No features selected");const t=new Set,r=this.olMap.getLayers();e.forEach(o=>{for(let a=0;a<r.getLength();a++){const c=r.item(a);if(c instanceof w){const n=c.getSource();if(n&&n.hasFeature(o)){n.removeFeature(o);const l=c.get(h);l&&t.add(l);break}}}}),e.clear(),this.renderer&&t.size>0&&t.forEach(o=>{this.renderer.syncLayerFeaturesToModel(o)}),(s=this.renderer)==null||s.triggerDirty()}async disableSelection(){var e;this.selectInteraction&&(this.olMap.removeInteraction(this.selectInteraction),this.selectInteraction=void 0,this.setCursor(""),(e=this.renderer)==null||e.triggerSync({type:"featureDeselected"}))}}$.resolveUrl=async i=>{try{return await T(i)}catch(e){return console.warn("Failed to resolve asset via host:",e),i}};let y;const L=new Map;let W=0;window.addEventListener("message",i=>{const{id:e,success:t,assetUrl:r,error:s}=i.data;if(L.has(e)){const{resolve:o,reject:a,timeout:c}=L.get(e);clearTimeout(c),L.delete(e),t?o(r):a(new Error(s))}});async function T(i){return new Promise((e,t)=>{const r=`asset_${++W}`,s=setTimeout(()=>{L.delete(r),t(new Error("Asset resolution timeout"))},5e3);L.set(r,{resolve:e,reject:t,timeout:s}),window.parent.postMessage({type:"resolveAsset",id:r,path:i},"*")})}async function X(i,e){switch(i){case"render":return y=new J(e.gsMap,e.env),y.setOnDirty(()=>{window.parent.postMessage({type:"dirty"},"*")}),y.setOnSync(t=>{window.parent.postMessage({type:"sync",event:t},"*")}),await y.render("#map-container"),{success:!0};case"modelToUI":return y&&await y.modelToUI(e),{success:!0};case"getViewExtent":return y?{extent:y.getViewExtent()}:{extent:[0,0,0,0]};case"resolveAsset":try{return{success:!0,assetUrl:await T(e.path)}}catch(t){return{success:!1,error:t.message}}default:if(y&&y.getOperations){const t=y.getOperations();if(t[i]&&typeof t[i]=="function")return await t[i](...Object.values(e||{})),{success:!0}}throw new Error(`Unknown method: ${i}`)}}window.addEventListener("message",async i=>{const{id:e,method:t,params:r}=i.data;let s;try{s=await X(t,r)}catch(o){s={error:o.message}}i.source.postMessage({id:e,...s},i.origin)});document.addEventListener("click",()=>{window.parent.postMessage({type:"iframeClicked"},"*")},!0);window.parent.postMessage({type:"rendererReady"},"*");
