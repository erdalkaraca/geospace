const __vite__mapDeps=(i,m=__vite__mapDeps,d=(m.f||(m.f=["assets/rag-integration-r3lrVB-9-DF5BZhW1.js","assets/index-Bz1SaEj3.js","assets/preload-helper-WQhrSmCl.js","assets/chunk.LTSJC6DR-BCCP1Gxs.js","assets/index-aP6FMjSZ.css"])))=>i.map(i=>d[i]);
import{c as pb,g as fa,_ as ay}from"./preload-helper-WQhrSmCl.js";import{U as $r,at as Ch,aR as mb,aD as gb,a7 as yb,u as Or,aB as vb,w as Vi,aS as _b,aT as wb,ao as bb,aU as Jd,az as Eb,a6 as Sn,s as td,x as ct,q as xb,a5 as Yn,Z as Sb,$ as kb,a1 as Gr,P as ft,ad as Yr,T as er,ai as Ib,z as Ob,A as Tb,aV as fo,X as Rb,a0 as Ab}from"./index-Bz1SaEj3.js";function es(e){"@babel/helpers - typeof";return es=typeof Symbol=="function"&&typeof Symbol.iterator=="symbol"?function(t){return typeof t}:function(t){return t&&typeof Symbol=="function"&&t.constructor===Symbol&&t!==Symbol.prototype?"symbol":typeof t},es(e)}function $b(e,t){if(es(e)!="object"||!e)return e;var r=e[Symbol.toPrimitive];if(r!==void 0){var n=r.call(e,t);if(es(n)!="object")return n;throw new TypeError("@@toPrimitive must return a primitive value.")}return String(e)}function Cb(e){var t=$b(e,"string");return es(t)=="symbol"?t:t+""}function Pb(e,t){for(var r=0;r<t.length;r++){var n=t[r];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,Cb(n.key),n)}}function zn(e,t,r){return t&&Pb(e.prototype,t),Object.defineProperty(e,"prototype",{writable:!1}),e}function Nb(e){return e[e.length-1]}function Qd(e){return Array.isArray(e)?e.slice(0):[e]}function Db(e,t){e=e.slice(0);for(var r=[];e.length;){var n=e.splice(0,t);r.push(n)}return r}function Yd(e){return Array.isArray(e)}function Mb(e){return e!=null}function _u(e,t){var r=0,n=-1;for(var i of e){n=n+1;var a=t(i,n);if(a)r=r+1;else break}return r}function mi(e,t){var r=t.length;if(r!==0){var n=e.length;e.length=n+t.length;for(var i=0;i<r;++i)e[n+i]=t[i]}}function Lb(e){return e.filter(function(t,r,n){return n.indexOf(t)===r})}function Dn(e){for(var t="",r=0;r<e.length;r++){var n=e[r];if(n==="-")return parseInt(t,10);t+=n}throw new Error("malformatted revision: "+e)}function an(e,t){var r=t?Dn(t._rev)+1:1;return r+"-"+e}function jb(e){var t=e.split("."),r=t.length;return r===1?n=>n[e]:n=>{for(var i=n,a=0;a<r;++a){var s=t[a];if(i=i[s],typeof i>"u")return i}return i}}function it(e){return Object.assign({},e)}function Fb(e){return Object.keys(e)[0]}function Ho(e,t=!1){if(!e)return e;if(!t&&Array.isArray(e))return e.sort((n,i)=>typeof n=="string"&&typeof i=="string"?n.localeCompare(i):typeof n=="object"?1:-1).map(n=>Ho(n,t));if(typeof e=="object"&&!Array.isArray(e)){var r={};return Object.keys(e).sort((n,i)=>n.localeCompare(i)).forEach(n=>{r[n]=Ho(e[n],t)}),r}return e}function rd(e){if(!e||e===null||typeof e!="object")return e;if(Array.isArray(e)){for(var t=new Array(e.length),r=t.length;r--;)t[r]=rd(e[r]);return t}var n={};for(var i in e)n[i]=rd(e[i]);return n}var zt=rd;function tn(e,t,r){return Object.defineProperty(e,t,{get:function(){return r}}),r}var Xd=1;function xi(){return{lwt:Xd}}function yr(){return""}function Bb(e){return Object.assign({},e,{_meta:void 0,_deleted:void 0,_rev:void 0})}function zb(e,t,r){if(t.length!==r.length)return!1;for(var n=0,i=t.length;n<i;){var a=t[n],s=r[n];if(n++,a._rev!==s._rev||a[e]!==s[e])return!1}return!0}var Ub=Object.defineProperty,qb=(e,t,r)=>t in e?Ub(e,t,{enumerable:!0,configurable:!0,writable:!0,value:r}):e[t]=r,Ki=(e,t,r)=>(qb(e,typeof t!="symbol"?t+"":t,r),r);class Cn{constructor(t,r){Ki(this,"words"),Ki(this,"sigBytes"),t=this.words=t||[],this.sigBytes=r===void 0?t.length*4:r}toString(t){return(t||Hb).stringify(this)}concat(t){if(this.clamp(),this.sigBytes%4)for(let r=0;r<t.sigBytes;r++){const n=t.words[r>>>2]>>>24-r%4*8&255;this.words[this.sigBytes+r>>>2]|=n<<24-(this.sigBytes+r)%4*8}else for(let r=0;r<t.sigBytes;r+=4)this.words[this.sigBytes+r>>>2]=t.words[r>>>2];return this.sigBytes+=t.sigBytes,this}clamp(){this.words[this.sigBytes>>>2]&=4294967295<<32-this.sigBytes%4*8,this.words.length=Math.ceil(this.sigBytes/4)}clone(){return new Cn([...this.words])}}const Hb={stringify(e){const t=[];for(let r=0;r<e.sigBytes;r++){const n=e.words[r>>>2]>>>24-r%4*8&255;t.push((n>>>4).toString(16),(n&15).toString(16))}return t.join("")}},Kb={parse(e){const t=e.length,r=[];for(let n=0;n<t;n++)r[n>>>2]|=(e.charCodeAt(n)&255)<<24-n%4*8;return new Cn(r,t)}},Gb={parse(e){return Kb.parse(unescape(encodeURIComponent(e)))}};class Wb{constructor(){Ki(this,"_data",new Cn),Ki(this,"_nDataBytes",0),Ki(this,"_minBufferSize",0),Ki(this,"blockSize",512/32)}reset(){this._data=new Cn,this._nDataBytes=0}_append(t){typeof t=="string"&&(t=Gb.parse(t)),this._data.concat(t),this._nDataBytes+=t.sigBytes}_doProcessBlock(t,r){}_process(t){let r,n=this._data.sigBytes/(this.blockSize*4);t?n=Math.ceil(n):n=Math.max((n|0)-this._minBufferSize,0);const i=n*this.blockSize,a=Math.min(i*4,this._data.sigBytes);if(i){for(let s=0;s<i;s+=this.blockSize)this._doProcessBlock(this._data.words,s);r=this._data.words.splice(0,i),this._data.sigBytes-=a}return new Cn(r,a)}}class Vb extends Wb{update(t){return this._append(t),this._process(),this}finalize(t){t&&this._append(t)}}var Zb=Object.defineProperty,Jb=(e,t,r)=>t in e?Zb(e,t,{enumerable:!0,configurable:!0,writable:!0,value:r}):e[t]=r,Qb=(e,t,r)=>(Jb(e,t+"",r),r);const Ph=[1779033703,-1150833019,1013904242,-1521486534,1359893119,-1694144372,528734635,1541459225],Yb=[1116352408,1899447441,-1245643825,-373957723,961987163,1508970993,-1841331548,-1424204075,-670586216,310598401,607225278,1426881987,1925078388,-2132889090,-1680079193,-1046744716,-459576895,-272742522,264347078,604807628,770255983,1249150122,1555081692,1996064986,-1740746414,-1473132947,-1341970488,-1084653625,-958395405,-710438585,113926993,338241895,666307205,773529912,1294757372,1396182291,1695183700,1986661051,-2117940946,-1838011259,-1564481375,-1474664885,-1035236496,-949202525,-778901479,-694614492,-200395387,275423344,430227734,506948616,659060556,883997877,958139571,1322822218,1537002063,1747873779,1955562222,2024104815,-2067236844,-1933114872,-1866530822,-1538233109,-1090935817,-965641998],Xn=[];class Xb extends Vb{constructor(){super(...arguments),Qb(this,"_hash",new Cn([...Ph]))}reset(){super.reset(),this._hash=new Cn([...Ph])}_doProcessBlock(t,r){const n=this._hash.words;let i=n[0],a=n[1],s=n[2],o=n[3],c=n[4],u=n[5],d=n[6],h=n[7];for(let p=0;p<64;p++){if(p<16)Xn[p]=t[r+p]|0;else{const T=Xn[p-15],z=(T<<25|T>>>7)^(T<<14|T>>>18)^T>>>3,B=Xn[p-2],G=(B<<15|B>>>17)^(B<<13|B>>>19)^B>>>10;Xn[p]=z+Xn[p-7]+G+Xn[p-16]}const y=c&u^~c&d,g=i&a^i&s^a&s,w=(i<<30|i>>>2)^(i<<19|i>>>13)^(i<<10|i>>>22),b=(c<<26|c>>>6)^(c<<21|c>>>11)^(c<<7|c>>>25),S=h+b+y+Yb[p]+Xn[p],O=w+g;h=d,d=u,u=c,c=o+S|0,o=s,s=a,a=i,i=S+O|0}n[0]=n[0]+i|0,n[1]=n[1]+a|0,n[2]=n[2]+s|0,n[3]=n[3]+o|0,n[4]=n[4]+c|0,n[5]=n[5]+u|0,n[6]=n[6]+d|0,n[7]=n[7]+h|0}finalize(t){super.finalize(t);const r=this._nDataBytes*8,n=this._data.sigBytes*8;return this._data.words[n>>>5]|=128<<24-n%32,this._data.words[(n+64>>>9<<4)+14]=Math.floor(r/4294967296),this._data.words[(n+64>>>9<<4)+15]=r,this._data.sigBytes=this._data.words.length*4,this._process(),this._hash}}function e0(e){return new Xb().finalize(e).toString()}function t0(e){return Promise.resolve(e0(e))}async function r0(e){var t=new TextEncoder().encode(e),r=await crypto.subtle.digest("SHA-256",t),n=Array.prototype.map.call(new Uint8Array(r),i=>("00"+i.toString(16)).slice(-2)).join("");return n}var n0=typeof crypto<"u"&&typeof crypto.subtle<"u"&&typeof crypto.subtle.digest=="function",sy=n0?r0:t0;function i0(){return new Promise(e=>setTimeout(e,0))}function a0(e=0){return new Promise(t=>setTimeout(t,e))}function s0(e){return e&&typeof e.then=="function"?e:Promise.resolve(e)}var o0=Promise.resolve(!0),Tr=Promise.resolve(!1),ef=Promise.resolve(null),gr=Promise.resolve();function vc(e=1e4){return typeof requestIdleCallback=="function"?new Promise(t=>{requestIdleCallback(()=>t(),{timeout:e})}):a0(0)}var wu=gr;function c0(e=void 0){return wu=wu.then(()=>vc(e)),wu}function u0(e,t){return e.reduce((r,n)=>r.then(n),Promise.resolve(t))}var l0=/\./g,Nh="abcdefghijklmnopqrstuvwxyz";function Es(e=10){for(var t="",r=0;r<e;r++)t+=Nh.charAt(Math.floor(Math.random()*Nh.length));return t}function oy(e){e+="";var t=e.charAt(0).toUpperCase();return t+e.substr(1)}function ja(e){for(;e.charAt(0)===".";)e=e.substr(1);for(;e.slice(-1)===".";)e=e.slice(0,-1);return e}function ts(e,t){if(e===t)return!0;if(e&&t&&typeof e=="object"&&typeof t=="object"){if(e.constructor!==t.constructor)return!1;var r,n;if(Array.isArray(e)){if(r=e.length,r!==t.length)return!1;for(n=r;n--!==0;)if(!ts(e[n],t[n]))return!1;return!0}if(e.constructor===RegExp)return e.source===t.source&&e.flags===t.flags;if(e.valueOf!==Object.prototype.valueOf)return e.valueOf()===t.valueOf();if(e.toString!==Object.prototype.toString)return e.toString()===t.toString();var i=Object.keys(e);if(r=i.length,r!==Object.keys(t).length)return!1;for(n=r;n--!==0;)if(!Object.prototype.hasOwnProperty.call(t,i[n]))return!1;for(n=r;n--!==0;){var a=i[n];if(!ts(e[a],t[a]))return!1}return!0}return e!==e&&t!==t}var nd=e=>{var t=typeof e;return e!==null&&(t==="object"||t==="function")},bu=new Set(["__proto__","prototype","constructor"]),d0=new Set("0123456789");function cy(e){var t=[],r="",n="start",i=!1;for(var a of e)switch(a){case"\\":{if(n==="index")throw new Error("Invalid character in an index");if(n==="indexEnd")throw new Error("Invalid character after an index");i&&(r+=a),n="property",i=!i;break}case".":{if(n==="index")throw new Error("Invalid character in an index");if(n==="indexEnd"){n="property";break}if(i){i=!1,r+=a;break}if(bu.has(r))return[];t.push(r),r="",n="property";break}case"[":{if(n==="index")throw new Error("Invalid character in an index");if(n==="indexEnd"){n="index";break}if(i){i=!1,r+=a;break}if(n==="property"){if(bu.has(r))return[];t.push(r),r=""}n="index";break}case"]":{if(n==="index"){t.push(Number.parseInt(r,10)),r="",n="indexEnd";break}if(n==="indexEnd")throw new Error("Invalid character after an index")}default:{if(n==="index"&&!d0.has(a))throw new Error("Invalid character in an index");if(n==="indexEnd")throw new Error("Invalid character after an index");n==="start"&&(n="property"),i&&(i=!1,r+="\\"),r+=a}}switch(i&&(r+="\\"),n){case"property":{if(bu.has(r))return[];t.push(r);break}case"index":throw new Error("Index was not closed");case"start":{t.push("");break}}return t}function uy(e,t){if(typeof t!="number"&&Array.isArray(e)){var r=Number.parseInt(t,10);return Number.isInteger(r)&&e[r]===e[t]}return!1}function f0(e,t){if(uy(e,t))throw new Error("Cannot use string index")}function Mn(e,t,r){if(Array.isArray(t)&&(t=t.join(".")),!t.includes(".")&&!t.includes("["))return e[t];if(!nd(e)||typeof t!="string")return r===void 0?e:r;var n=cy(t);if(n.length===0)return r;for(var i=0;i<n.length;i++){var a=n[i];if(uy(e,a)?e=i===n.length-1?void 0:null:e=e[a],e==null){if(i!==n.length-1)return r;break}}return e===void 0?r:e}function ly(e,t,r){if(Array.isArray(t)&&(t=t.join(".")),!nd(e)||typeof t!="string")return e;for(var n=e,i=cy(t),a=0;a<i.length;a++){var s=i[a];f0(e,s),a===i.length-1?e[s]=r:nd(e[s])||(e[s]=typeof i[a+1]=="number"?[]:{}),e=e[s]}return n}function gi(e,t){var r=e.get(t);if(typeof r>"u")throw new Error("missing value from map "+t);return r}function sn(e,t,r,n){var i=e.get(t);return typeof i>"u"&&(i=r(),e.set(t,i)),i}function et(e){var t=e.split("-"),r="RxDB";return t.forEach(n=>{r+=oy(n)}),r+="Plugin",new Error(`You are using a function which must be overwritten by a plugin.
        You should either prevent the usage of this function or add the plugin via:
            import { `+r+" } from 'rxdb/plugins/"+e+`';
            addRxPlugin(`+r+`);
        `)}function h0(e){var t={name:e.name,message:e.message,rxdb:e.rxdb,parameters:e.parameters,extensions:e.extensions,code:e.code,url:e.url,stack:e.stack?e.stack.replace(/\n/g,` 
 `):void 0};return t}var Eu=0;function Tt(){var e=Date.now();e=e+.01,e<=Eu&&(e=Eu+.01);var t=parseFloat(e.toFixed(2));return Eu=t,t}function ze(e,t){if(!e)throw t||(t=""),new Error("ensureNotFalsy() is falsy: "+t);return e}var xs={bufferSize:1,refCount:!0},dy="15.39.0",xu={},p0="6da4936d1425ff3a5c44c02342c6daf791d266be3ae8479b8ec59e261df41b93";function rs(e,t){return rs=Object.setPrototypeOf?Object.setPrototypeOf.bind():function(r,n){return r.__proto__=n,r},rs(e,t)}function tf(e,t){e.prototype=Object.create(t.prototype),e.prototype.constructor=e,rs(e,t)}function id(e){return id=Object.setPrototypeOf?Object.getPrototypeOf.bind():function(t){return t.__proto__||Object.getPrototypeOf(t)},id(e)}function m0(e){try{return Function.toString.call(e).indexOf("[native code]")!==-1}catch{return typeof e=="function"}}function fy(){try{var e=!Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],function(){}))}catch{}return(fy=function(){return!!e})()}function g0(e,t,r){if(fy())return Reflect.construct.apply(null,arguments);var n=[null];n.push.apply(n,t);var i=new(e.bind.apply(e,n));return r&&rs(i,r.prototype),i}function Ko(e){var t=typeof Map=="function"?new Map:void 0;return Ko=function(n){if(n===null||!m0(n))return n;if(typeof n!="function")throw new TypeError("Super expression must either be null or a function");if(t!==void 0){if(t.has(n))return t.get(n);t.set(n,i)}function i(){return g0(n,arguments,id(this).constructor)}return i.prototype=Object.create(n.prototype,{constructor:{value:i,enumerable:!1,writable:!0,configurable:!0}}),rs(i,n)},Ko(e)}var rt={isDevMode(){return!1},deepFreezeWhenDevMode(e){return e},tunnelErrorMessage(e){return"RxDB Error-Code "+e+`.
        Error messages are not included in RxDB core to reduce build size.
        `}};function y0(e){var t="";return Object.keys(e).length===0||(t+=`Given parameters: {
`,t+=Object.keys(e).map(r=>{var n="[object Object]";try{r==="errors"?n=e[r].map(i=>JSON.stringify(i,Object.getOwnPropertyNames(i))):n=JSON.stringify(e[r],function(i,a){return a===void 0?null:a},2)}catch{}return r+":"+n}).join(`
`),t+="}"),t}function hy(e,t,r){return"RxError ("+t+`):
`+e+`
`+y0(r)}var v0=(function(e){function t(n,i,a={}){var s,o=hy(i,n,a);return s=e.call(this,o)||this,s.code=n,s.message=o,s.url=rf(n),s.parameters=a,s.rxdb=!0,s}tf(t,e);var r=t.prototype;return r.toString=function(){return this.message},zn(t,[{key:"name",get:function(){return"RxError ("+this.code+")"}},{key:"typeError",get:function(){return!1}}])})(Ko(Error)),_0=(function(e){function t(n,i,a={}){var s,o=hy(i,n,a);return s=e.call(this,o)||this,s.code=n,s.message=o,s.url=rf(n),s.parameters=a,s.rxdb=!0,s}tf(t,e);var r=t.prototype;return r.toString=function(){return this.message},zn(t,[{key:"name",get:function(){return"RxTypeError ("+this.code+")"}},{key:"typeError",get:function(){return!0}}])})(Ko(TypeError));function rf(e){return"https://rxdb.info/errors.html?console=errors#"+e}function py(e){return`
 You can find out more about this error here: `+rf(e)+" "}function ye(e,t){return new v0(e,rt.tunnelErrorMessage(e)+py(e),t)}function tr(e,t){return new _0(e,rt.tunnelErrorMessage(e)+py(e),t)}function _c(e){return e&&e.status===409?e:!1}var w0={409:"document write conflict",422:"schema validation error",510:"attachment data missing"};function b0(e){return ye("COL20",{name:w0[e.status],document:e.documentId,writeError:e})}var ns={preAddRxPlugin:[],preCreateRxDatabase:[],createRxDatabase:[],preCreateRxCollection:[],createRxCollection:[],createRxState:[],postDestroyRxCollection:[],postRemoveRxCollection:[],preCreateRxSchema:[],createRxSchema:[],preCreateRxQuery:[],prePrepareQuery:[],createRxDocument:[],postCreateRxDocument:[],preCreateRxStorageInstance:[],preStorageWrite:[],preMigrateDocument:[],postMigrateDocument:[],preDestroyRxDatabase:[],postRemoveRxDatabase:[],postCleanup:[],preReplicationMasterWrite:[],preReplicationMasterWriteDocumentsHandle:[]};function vr(e,t){ns[e].length>0&&ns[e].forEach(r=>r(t))}function Ss(e,t){return Promise.all(ns[e].map(r=>r(t)))}function Xi(e,t){var r=t;r=r.replace(l0,".properties."),r="properties."+r,r=ja(r);var n=Mn(e,r);return n}function E0(e,t,r){if(typeof t.primaryKey=="string")return r;var n=Si(t,r),i=r[e];if(i&&i!==n)throw ye("DOC19",{args:{documentData:r,existingPrimary:i,newPrimary:n},schema:t});return r[e]=n,r}function cr(e){return typeof e=="string"?e:e.key}function x0(e){var t=cr(e.primaryKey),r=Xi(e,t);return ze(r.maxLength)}function Si(e,t){if(typeof e.primaryKey=="string")return t[e.primaryKey];var r=e.primaryKey;return r.fields.map(n=>{var i=Mn(t,n);if(typeof i>"u")throw ye("DOC18",{args:{field:n,documentData:t}});return i}).join(r.separator)}function S0(e){var t=Ho(e,!0);return t}function k0(e){return["_deleted",e]}function wc(e){e=it(e);var t=cr(e.primaryKey);e.properties=it(e.properties),e.additionalProperties=!1,Object.prototype.hasOwnProperty.call(e,"keyCompression")||(e.keyCompression=!1),e.indexes=e.indexes?e.indexes.slice(0):[],e.required=e.required?e.required.slice(0):[],e.encrypted=e.encrypted?e.encrypted.slice(0):[],e.properties._rev={type:"string",minLength:1},e.properties._attachments={type:"object"},e.properties._deleted={type:"boolean"},e.properties._meta=I0,e.required=e.required?e.required.slice(0):[],e.required.push("_deleted"),e.required.push("_rev"),e.required.push("_meta"),e.required.push("_attachments");var r=my(e);mi(e.required,r),e.required=e.required.filter(a=>!a.includes(".")).filter((a,s,o)=>o.indexOf(a)===s),e.version=e.version||0;var n=e.indexes.map(a=>{var s=Yd(a)?a.slice(0):[a];return s.includes(t)||s.push(t),s[0]!=="_deleted"&&s.unshift("_deleted"),s});n.length===0&&n.push(k0(t)),n.push(["_meta.lwt",t]),e.internalIndexes&&e.internalIndexes.map(a=>{n.push(a)});var i=new Set;return n.filter(a=>{var s=a.join(",");return i.has(s)?!1:(i.add(s),!0)}),e.indexes=n,e}var I0={type:"object",properties:{lwt:{type:"number",minimum:Xd,maximum:1e15,multipleOf:.01}},additionalProperties:!0,required:["lwt"]};function my(e){var t=Object.keys(e.properties).filter(n=>e.properties[n].final),r=cr(e.primaryKey);return t.push(r),typeof e.primaryKey!="string"&&e.primaryKey.fields.forEach(n=>t.push(n)),t}function O0(e,t){for(var r=Object.keys(e.defaultValues),n=0;n<r.length;++n){var i=r[n];(!Object.prototype.hasOwnProperty.call(t,i)||typeof t[i]>"u")&&(t[i]=e.defaultValues[i])}return t}var gy=(function(){function e(r,n){this.jsonSchema=r,this.hashFunction=n,this.indexes=T0(this.jsonSchema),this.primaryPath=cr(this.jsonSchema.primaryKey),this.finalFields=my(this.jsonSchema)}var t=e.prototype;return t.validateChange=function(n,i){this.finalFields.forEach(a=>{if(!ts(n[a],i[a]))throw ye("DOC9",{dataBefore:n,dataAfter:i,fieldName:a,schema:this.jsonSchema})})},t.getDocumentPrototype=function(){var n={},i=Xi(this.jsonSchema,"");return Object.keys(i).forEach(a=>{var s=a;n.__defineGetter__(a,function(){if(!(!this.get||typeof this.get!="function")){var o=this.get(s);return o}}),Object.defineProperty(n,a+"$",{get:function(){return this.get$(s)},enumerable:!1,configurable:!1}),Object.defineProperty(n,a+"$$",{get:function(){return this.get$$(s)},enumerable:!1,configurable:!1}),Object.defineProperty(n,a+"_",{get:function(){return this.populate(s)},enumerable:!1,configurable:!1})}),tn(this,"getDocumentPrototype",()=>n),n},t.getPrimaryOfDocumentData=function(n){return Si(this.jsonSchema,n)},zn(e,[{key:"version",get:function(){return this.jsonSchema.version}},{key:"defaultValues",get:function(){var r={};return Object.entries(this.jsonSchema.properties).filter(([,n])=>Object.prototype.hasOwnProperty.call(n,"default")).forEach(([n,i])=>r[n]=i.default),tn(this,"defaultValues",r)}},{key:"hash",get:function(){return tn(this,"hash",this.hashFunction(JSON.stringify(this.jsonSchema)))}}])})();function T0(e){return(e.indexes||[]).map(t=>Yd(t)?t:[t])}function R0(e){var t=e.version?e.version:0,r=0;return new Array(t).fill(0).map(()=>r++)}function A0(e,t,r=!0){r&&vr("preCreateRxSchema",e);var n=wc(e);n=S0(n),rt.deepFreezeWhenDevMode(n);var i=new gy(n,t);return vr("createRxSchema",i),i}function gt(e){return typeof e=="function"}function $0(e){return gt(e?.lift)}function Wr(e){return function(t){if($0(t))return t.lift(function(r){try{return e(r,this)}catch(n){this.error(n)}});throw new TypeError("Unable to lift unknown Observable type")}}var ad=function(e,t){return ad=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(r,n){r.__proto__=n}||function(r,n){for(var i in n)Object.prototype.hasOwnProperty.call(n,i)&&(r[i]=n[i])},ad(e,t)};function ki(e,t){if(typeof t!="function"&&t!==null)throw new TypeError("Class extends value "+String(t)+" is not a constructor or null");ad(e,t);function r(){this.constructor=e}e.prototype=t===null?Object.create(t):(r.prototype=t.prototype,new r)}function C0(e,t,r,n){function i(a){return a instanceof r?a:new r(function(s){s(a)})}return new(r||(r=Promise))(function(a,s){function o(d){try{u(n.next(d))}catch(h){s(h)}}function c(d){try{u(n.throw(d))}catch(h){s(h)}}function u(d){d.done?a(d.value):i(d.value).then(o,c)}u((n=n.apply(e,t||[])).next())})}function yy(e,t){var r={label:0,sent:function(){if(a[0]&1)throw a[1];return a[1]},trys:[],ops:[]},n,i,a,s=Object.create((typeof Iterator=="function"?Iterator:Object).prototype);return s.next=o(0),s.throw=o(1),s.return=o(2),typeof Symbol=="function"&&(s[Symbol.iterator]=function(){return this}),s;function o(u){return function(d){return c([u,d])}}function c(u){if(n)throw new TypeError("Generator is already executing.");for(;s&&(s=0,u[0]&&(r=0)),r;)try{if(n=1,i&&(a=u[0]&2?i.return:u[0]?i.throw||((a=i.return)&&a.call(i),0):i.next)&&!(a=a.call(i,u[1])).done)return a;switch(i=0,a&&(u=[u[0]&2,a.value]),u[0]){case 0:case 1:a=u;break;case 4:return r.label++,{value:u[1],done:!1};case 5:r.label++,i=u[1],u=[0];continue;case 7:u=r.ops.pop(),r.trys.pop();continue;default:if(a=r.trys,!(a=a.length>0&&a[a.length-1])&&(u[0]===6||u[0]===2)){r=0;continue}if(u[0]===3&&(!a||u[1]>a[0]&&u[1]<a[3])){r.label=u[1];break}if(u[0]===6&&r.label<a[1]){r.label=a[1],a=u;break}if(a&&r.label<a[2]){r.label=a[2],r.ops.push(u);break}a[2]&&r.ops.pop(),r.trys.pop();continue}u=t.call(e,r)}catch(d){u=[6,d],i=0}finally{n=a=0}if(u[0]&5)throw u[1];return{value:u[0]?u[1]:void 0,done:!0}}}function ea(e){var t=typeof Symbol=="function"&&Symbol.iterator,r=t&&e[t],n=0;if(r)return r.call(e);if(e&&typeof e.length=="number")return{next:function(){return e&&n>=e.length&&(e=void 0),{value:e&&e[n++],done:!e}}};throw new TypeError(t?"Object is not iterable.":"Symbol.iterator is not defined.")}function yi(e,t){var r=typeof Symbol=="function"&&e[Symbol.iterator];if(!r)return e;var n=r.call(e),i,a=[],s;try{for(;(t===void 0||t-- >0)&&!(i=n.next()).done;)a.push(i.value)}catch(o){s={error:o}}finally{try{i&&!i.done&&(r=n.return)&&r.call(n)}finally{if(s)throw s.error}}return a}function vi(e,t,r){if(r||arguments.length===2)for(var n=0,i=t.length,a;n<i;n++)(a||!(n in t))&&(a||(a=Array.prototype.slice.call(t,0,n)),a[n]=t[n]);return e.concat(a||Array.prototype.slice.call(t))}function Zi(e){return this instanceof Zi?(this.v=e,this):new Zi(e)}function P0(e,t,r){if(!Symbol.asyncIterator)throw new TypeError("Symbol.asyncIterator is not defined.");var n=r.apply(e,t||[]),i,a=[];return i=Object.create((typeof AsyncIterator=="function"?AsyncIterator:Object).prototype),o("next"),o("throw"),o("return",s),i[Symbol.asyncIterator]=function(){return this},i;function s(y){return function(g){return Promise.resolve(g).then(y,h)}}function o(y,g){n[y]&&(i[y]=function(w){return new Promise(function(b,S){a.push([y,w,b,S])>1||c(y,w)})},g&&(i[y]=g(i[y])))}function c(y,g){try{u(n[y](g))}catch(w){p(a[0][3],w)}}function u(y){y.value instanceof Zi?Promise.resolve(y.value.v).then(d,h):p(a[0][2],y)}function d(y){c("next",y)}function h(y){c("throw",y)}function p(y,g){y(g),a.shift(),a.length&&c(a[0][0],a[0][1])}}function N0(e){if(!Symbol.asyncIterator)throw new TypeError("Symbol.asyncIterator is not defined.");var t=e[Symbol.asyncIterator],r;return t?t.call(e):(e=typeof ea=="function"?ea(e):e[Symbol.iterator](),r={},n("next"),n("throw"),n("return"),r[Symbol.asyncIterator]=function(){return this},r);function n(a){r[a]=e[a]&&function(s){return new Promise(function(o,c){s=e[a](s),i(o,c,s.done,s.value)})}}function i(a,s,o,c){Promise.resolve(c).then(function(u){a({value:u,done:o})},s)}}var vy=(function(e){return e&&typeof e.length=="number"&&typeof e!="function"});function _y(e){return gt(e?.then)}function nf(e){var t=function(n){Error.call(n),n.stack=new Error().stack},r=e(t);return r.prototype=Object.create(Error.prototype),r.prototype.constructor=r,r}var Su=nf(function(e){return function(r){e(this),this.message=r?r.length+` errors occurred during unsubscription:
`+r.map(function(n,i){return i+1+") "+n.toString()}).join(`
  `):"",this.name="UnsubscriptionError",this.errors=r}});function sd(e,t){if(e){var r=e.indexOf(t);0<=r&&e.splice(r,1)}}var bc=(function(){function e(t){this.initialTeardown=t,this.closed=!1,this._parentage=null,this._finalizers=null}return e.prototype.unsubscribe=function(){var t,r,n,i,a;if(!this.closed){this.closed=!0;var s=this._parentage;if(s)if(this._parentage=null,Array.isArray(s))try{for(var o=ea(s),c=o.next();!c.done;c=o.next()){var u=c.value;u.remove(this)}}catch(w){t={error:w}}finally{try{c&&!c.done&&(r=o.return)&&r.call(o)}finally{if(t)throw t.error}}else s.remove(this);var d=this.initialTeardown;if(gt(d))try{d()}catch(w){a=w instanceof Su?w.errors:[w]}var h=this._finalizers;if(h){this._finalizers=null;try{for(var p=ea(h),y=p.next();!y.done;y=p.next()){var g=y.value;try{Dh(g)}catch(w){a=a??[],w instanceof Su?a=vi(vi([],yi(a)),yi(w.errors)):a.push(w)}}}catch(w){n={error:w}}finally{try{y&&!y.done&&(i=p.return)&&i.call(p)}finally{if(n)throw n.error}}}if(a)throw new Su(a)}},e.prototype.add=function(t){var r;if(t&&t!==this)if(this.closed)Dh(t);else{if(t instanceof e){if(t.closed||t._hasParent(this))return;t._addParent(this)}(this._finalizers=(r=this._finalizers)!==null&&r!==void 0?r:[]).push(t)}},e.prototype._hasParent=function(t){var r=this._parentage;return r===t||Array.isArray(r)&&r.includes(t)},e.prototype._addParent=function(t){var r=this._parentage;this._parentage=Array.isArray(r)?(r.push(t),r):r?[r,t]:t},e.prototype._removeParent=function(t){var r=this._parentage;r===t?this._parentage=null:Array.isArray(r)&&sd(r,t)},e.prototype.remove=function(t){var r=this._finalizers;r&&sd(r,t),t instanceof e&&t._removeParent(this)},e.EMPTY=(function(){var t=new e;return t.closed=!0,t})(),e})(),wy=bc.EMPTY;function by(e){return e instanceof bc||e&&"closed"in e&&gt(e.remove)&&gt(e.add)&&gt(e.unsubscribe)}function Dh(e){gt(e)?e():e.unsubscribe()}var D0={Promise:void 0},M0={setTimeout:function(e,t){for(var r=[],n=2;n<arguments.length;n++)r[n-2]=arguments[n];return setTimeout.apply(void 0,vi([e,t],yi(r)))},clearTimeout:function(e){return clearTimeout(e)},delegate:void 0};function Ey(e){M0.setTimeout(function(){throw e})}function Mh(){}function $o(e){e()}var af=(function(e){ki(t,e);function t(r){var n=e.call(this)||this;return n.isStopped=!1,r?(n.destination=r,by(r)&&r.add(n)):n.destination=F0,n}return t.create=function(r,n,i){return new ta(r,n,i)},t.prototype.next=function(r){this.isStopped||this._next(r)},t.prototype.error=function(r){this.isStopped||(this.isStopped=!0,this._error(r))},t.prototype.complete=function(){this.isStopped||(this.isStopped=!0,this._complete())},t.prototype.unsubscribe=function(){this.closed||(this.isStopped=!0,e.prototype.unsubscribe.call(this),this.destination=null)},t.prototype._next=function(r){this.destination.next(r)},t.prototype._error=function(r){try{this.destination.error(r)}finally{this.unsubscribe()}},t.prototype._complete=function(){try{this.destination.complete()}finally{this.unsubscribe()}},t})(bc),L0=(function(){function e(t){this.partialObserver=t}return e.prototype.next=function(t){var r=this.partialObserver;if(r.next)try{r.next(t)}catch(n){ho(n)}},e.prototype.error=function(t){var r=this.partialObserver;if(r.error)try{r.error(t)}catch(n){ho(n)}else ho(t)},e.prototype.complete=function(){var t=this.partialObserver;if(t.complete)try{t.complete()}catch(r){ho(r)}},e})(),ta=(function(e){ki(t,e);function t(r,n,i){var a=e.call(this)||this,s;return gt(r)||!r?s={next:r??void 0,error:n??void 0,complete:i??void 0}:s=r,a.destination=new L0(s),a}return t})(af);function ho(e){Ey(e)}function j0(e){throw e}var F0={closed:!0,next:Mh,error:j0,complete:Mh},sf=(function(){return typeof Symbol=="function"&&Symbol.observable||"@@observable"})();function ks(e){return e}function B0(e){return e.length===0?ks:e.length===1?e[0]:function(r){return e.reduce(function(n,i){return i(n)},r)}}var ar=(function(){function e(t){t&&(this._subscribe=t)}return e.prototype.lift=function(t){var r=new e;return r.source=this,r.operator=t,r},e.prototype.subscribe=function(t,r,n){var i=this,a=U0(t)?t:new ta(t,r,n);return $o(function(){var s=i,o=s.operator,c=s.source;a.add(o?o.call(a,c):c?i._subscribe(a):i._trySubscribe(a))}),a},e.prototype._trySubscribe=function(t){try{return this._subscribe(t)}catch(r){t.error(r)}},e.prototype.forEach=function(t,r){var n=this;return r=Lh(r),new r(function(i,a){var s=new ta({next:function(o){try{t(o)}catch(c){a(c),s.unsubscribe()}},error:a,complete:i});n.subscribe(s)})},e.prototype._subscribe=function(t){var r;return(r=this.source)===null||r===void 0?void 0:r.subscribe(t)},e.prototype[sf]=function(){return this},e.prototype.pipe=function(){for(var t=[],r=0;r<arguments.length;r++)t[r]=arguments[r];return B0(t)(this)},e.prototype.toPromise=function(t){var r=this;return t=Lh(t),new t(function(n,i){var a;r.subscribe(function(s){return a=s},function(s){return i(s)},function(){return n(a)})})},e.create=function(t){return new e(t)},e})();function Lh(e){var t;return(t=e??D0.Promise)!==null&&t!==void 0?t:Promise}function z0(e){return e&&gt(e.next)&&gt(e.error)&&gt(e.complete)}function U0(e){return e&&e instanceof af||z0(e)&&by(e)}function xy(e){return gt(e[sf])}function Sy(e){return Symbol.asyncIterator&&gt(e?.[Symbol.asyncIterator])}function ky(e){return new TypeError("You provided "+(e!==null&&typeof e=="object"?"an invalid object":"'"+e+"'")+" where a stream was expected. You can provide an Observable, Promise, ReadableStream, Array, AsyncIterable, or Iterable.")}function q0(){return typeof Symbol!="function"||!Symbol.iterator?"@@iterator":Symbol.iterator}var Iy=q0();function Oy(e){return gt(e?.[Iy])}function Ty(e){return P0(this,arguments,function(){var r,n,i,a;return yy(this,function(s){switch(s.label){case 0:r=e.getReader(),s.label=1;case 1:s.trys.push([1,,9,10]),s.label=2;case 2:return[4,Zi(r.read())];case 3:return n=s.sent(),i=n.value,a=n.done,a?[4,Zi(void 0)]:[3,5];case 4:return[2,s.sent()];case 5:return[4,Zi(i)];case 6:return[4,s.sent()];case 7:return s.sent(),[3,2];case 8:return[3,10];case 9:return r.releaseLock(),[7];case 10:return[2]}})})}function Ry(e){return gt(e?.getReader)}function mn(e){if(e instanceof ar)return e;if(e!=null){if(xy(e))return H0(e);if(vy(e))return K0(e);if(_y(e))return G0(e);if(Sy(e))return Ay(e);if(Oy(e))return W0(e);if(Ry(e))return V0(e)}throw ky(e)}function H0(e){return new ar(function(t){var r=e[sf]();if(gt(r.subscribe))return r.subscribe(t);throw new TypeError("Provided object does not correctly implement Symbol.observable")})}function K0(e){return new ar(function(t){for(var r=0;r<e.length&&!t.closed;r++)t.next(e[r]);t.complete()})}function G0(e){return new ar(function(t){e.then(function(r){t.closed||(t.next(r),t.complete())},function(r){return t.error(r)}).then(null,Ey)})}function W0(e){return new ar(function(t){var r,n;try{for(var i=ea(e),a=i.next();!a.done;a=i.next()){var s=a.value;if(t.next(s),t.closed)return}}catch(o){r={error:o}}finally{try{a&&!a.done&&(n=i.return)&&n.call(i)}finally{if(r)throw r.error}}t.complete()})}function Ay(e){return new ar(function(t){Z0(e,t).catch(function(r){return t.error(r)})})}function V0(e){return Ay(Ty(e))}function Z0(e,t){var r,n,i,a;return C0(this,void 0,void 0,function(){var s,o;return yy(this,function(c){switch(c.label){case 0:c.trys.push([0,5,6,11]),r=N0(e),c.label=1;case 1:return[4,r.next()];case 2:if(n=c.sent(),!!n.done)return[3,4];if(s=n.value,t.next(s),t.closed)return[2];c.label=3;case 3:return[3,1];case 4:return[3,11];case 5:return o=c.sent(),i={error:o},[3,11];case 6:return c.trys.push([6,,9,10]),n&&!n.done&&(a=r.return)?[4,a.call(r)]:[3,8];case 7:c.sent(),c.label=8;case 8:return[3,10];case 9:if(i)throw i.error;return[7];case 10:return[7];case 11:return t.complete(),[2]}})})}function on(e,t,r,n,i){return new J0(e,t,r,n,i)}var J0=(function(e){ki(t,e);function t(r,n,i,a,s,o){var c=e.call(this,r)||this;return c.onFinalize=s,c.shouldUnsubscribe=o,c._next=n?function(u){try{n(u)}catch(d){r.error(d)}}:e.prototype._next,c._error=a?function(u){try{a(u)}catch(d){r.error(d)}finally{this.unsubscribe()}}:e.prototype._error,c._complete=i?function(){try{i()}catch(u){r.error(u)}finally{this.unsubscribe()}}:e.prototype._complete,c}return t.prototype.unsubscribe=function(){var r;if(!this.shouldUnsubscribe||this.shouldUnsubscribe()){var n=this.closed;e.prototype.unsubscribe.call(this),!n&&((r=this.onFinalize)===null||r===void 0||r.call(this))}},t})(af),$y={now:function(){return($y.delegate||Date).now()},delegate:void 0};function Q0(e){return e&&gt(e.schedule)}function of(e){return e[e.length-1]}function Y0(e){return gt(of(e))?e.pop():void 0}function Is(e){return Q0(of(e))?e.pop():void 0}function Cy(e,t){return typeof of(e)=="number"?e.pop():t}function Pn(e,t,r,n,i){n===void 0&&(n=0),i===void 0&&(i=!1);var a=t.schedule(function(){r(),i?e.add(this.schedule(null,n)):this.unsubscribe()},n);if(e.add(a),!i)return a}var X0=Array.isArray,eE=Object.getPrototypeOf,tE=Object.prototype,rE=Object.keys;function nE(e){if(e.length===1){var t=e[0];if(X0(t))return{args:t,keys:null};if(iE(t)){var r=rE(t);return{args:r.map(function(n){return t[n]}),keys:r}}}return{args:e,keys:null}}function iE(e){return e&&typeof e=="object"&&eE(e)===tE}function Py(e,t){return t===void 0&&(t=0),Wr(function(r,n){r.subscribe(on(n,function(i){return Pn(n,e,function(){return n.next(i)},t)},function(){return Pn(n,e,function(){return n.complete()},t)},function(i){return Pn(n,e,function(){return n.error(i)},t)}))})}function Ny(e,t){return t===void 0&&(t=0),Wr(function(r,n){n.add(e.schedule(function(){return r.subscribe(n)},t))})}function aE(e,t){return mn(e).pipe(Ny(t),Py(t))}function sE(e,t){return mn(e).pipe(Ny(t),Py(t))}function oE(e,t){return new ar(function(r){var n=0;return t.schedule(function(){n===e.length?r.complete():(r.next(e[n++]),r.closed||this.schedule())})})}function cE(e,t){return new ar(function(r){var n;return Pn(r,t,function(){n=e[Iy](),Pn(r,t,function(){var i,a,s;try{i=n.next(),a=i.value,s=i.done}catch(o){r.error(o);return}s?r.complete():r.next(a)},0,!0)}),function(){return gt(n?.return)&&n.return()}})}function Dy(e,t){if(!e)throw new Error("Iterable cannot be null");return new ar(function(r){Pn(r,t,function(){var n=e[Symbol.asyncIterator]();Pn(r,t,function(){n.next().then(function(i){i.done?r.complete():r.next(i.value)})},0,!0)})})}function uE(e,t){return Dy(Ty(e),t)}function lE(e,t){if(e!=null){if(xy(e))return aE(e,t);if(vy(e))return oE(e,t);if(_y(e))return sE(e,t);if(Sy(e))return Dy(e,t);if(Oy(e))return cE(e,t);if(Ry(e))return uE(e,t)}throw ky(e)}function Os(e,t){return t?lE(e,t):mn(e)}function wt(e,t){return Wr(function(r,n){var i=0;r.subscribe(on(n,function(a){n.next(e.call(t,a,i++))}))})}var dE=Array.isArray;function fE(e,t){return dE(t)?e.apply(void 0,vi([],yi(t))):e(t)}function hE(e){return wt(function(t){return fE(e,t)})}function pE(e,t){return e.reduce(function(r,n,i){return r[n]=t[i],r},{})}function mE(){for(var e=[],t=0;t<arguments.length;t++)e[t]=arguments[t];var r=Is(e),n=Y0(e),i=nE(e),a=i.args,s=i.keys;if(a.length===0)return Os([],r);var o=new ar(gE(a,r,s?function(c){return pE(s,c)}:ks));return n?o.pipe(hE(n)):o}function gE(e,t,r){return r===void 0&&(r=ks),function(n){jh(t,function(){for(var i=e.length,a=new Array(i),s=i,o=i,c=function(d){jh(t,function(){var h=Os(e[d],t),p=!1;h.subscribe(on(n,function(y){a[d]=y,p||(p=!0,o--),o||n.next(r(a.slice()))},function(){--s||n.complete()}))},n)},u=0;u<i;u++)c(u)},n)}}function jh(e,t,r){e?Pn(r,e,t):t()}function yE(e,t,r,n,i,a,s,o){var c=[],u=0,d=0,h=!1,p=function(){h&&!c.length&&!u&&t.complete()},y=function(w){return u<n?g(w):c.push(w)},g=function(w){u++;var b=!1;mn(r(w,d++)).subscribe(on(t,function(S){t.next(S)},function(){b=!0},void 0,function(){if(b)try{u--;for(var S=function(){var O=c.shift();s||g(O)};c.length&&u<n;)S();p()}catch(O){t.error(O)}}))};return e.subscribe(on(t,y,function(){h=!0,p()})),function(){}}function cn(e,t,r){return r===void 0&&(r=1/0),gt(t)?cn(function(n,i){return wt(function(a,s){return t(n,a,i,s)})(mn(e(n,i)))},r):(typeof t=="number"&&(r=t),Wr(function(n,i){return yE(n,i,e,r)}))}function cf(e){return e===void 0&&(e=1/0),cn(ks,e)}function vE(){return cf(1)}var _E=nf(function(e){return function(){e(this),this.name="ObjectUnsubscribedError",this.message="object unsubscribed"}}),nr=(function(e){ki(t,e);function t(){var r=e.call(this)||this;return r.closed=!1,r.currentObservers=null,r.observers=[],r.isStopped=!1,r.hasError=!1,r.thrownError=null,r}return t.prototype.lift=function(r){var n=new Fh(this,this);return n.operator=r,n},t.prototype._throwIfClosed=function(){if(this.closed)throw new _E},t.prototype.next=function(r){var n=this;$o(function(){var i,a;if(n._throwIfClosed(),!n.isStopped){n.currentObservers||(n.currentObservers=Array.from(n.observers));try{for(var s=ea(n.currentObservers),o=s.next();!o.done;o=s.next()){var c=o.value;c.next(r)}}catch(u){i={error:u}}finally{try{o&&!o.done&&(a=s.return)&&a.call(s)}finally{if(i)throw i.error}}}})},t.prototype.error=function(r){var n=this;$o(function(){if(n._throwIfClosed(),!n.isStopped){n.hasError=n.isStopped=!0,n.thrownError=r;for(var i=n.observers;i.length;)i.shift().error(r)}})},t.prototype.complete=function(){var r=this;$o(function(){if(r._throwIfClosed(),!r.isStopped){r.isStopped=!0;for(var n=r.observers;n.length;)n.shift().complete()}})},t.prototype.unsubscribe=function(){this.isStopped=this.closed=!0,this.observers=this.currentObservers=null},Object.defineProperty(t.prototype,"observed",{get:function(){var r;return((r=this.observers)===null||r===void 0?void 0:r.length)>0},enumerable:!1,configurable:!0}),t.prototype._trySubscribe=function(r){return this._throwIfClosed(),e.prototype._trySubscribe.call(this,r)},t.prototype._subscribe=function(r){return this._throwIfClosed(),this._checkFinalizedStatuses(r),this._innerSubscribe(r)},t.prototype._innerSubscribe=function(r){var n=this,i=this,a=i.hasError,s=i.isStopped,o=i.observers;return a||s?wy:(this.currentObservers=null,o.push(r),new bc(function(){n.currentObservers=null,sd(o,r)}))},t.prototype._checkFinalizedStatuses=function(r){var n=this,i=n.hasError,a=n.thrownError,s=n.isStopped;i?r.error(a):s&&r.complete()},t.prototype.asObservable=function(){var r=new ar;return r.source=this,r},t.create=function(r,n){return new Fh(r,n)},t})(ar),Fh=(function(e){ki(t,e);function t(r,n){var i=e.call(this)||this;return i.destination=r,i.source=n,i}return t.prototype.next=function(r){var n,i;(i=(n=this.destination)===null||n===void 0?void 0:n.next)===null||i===void 0||i.call(n,r)},t.prototype.error=function(r){var n,i;(i=(n=this.destination)===null||n===void 0?void 0:n.error)===null||i===void 0||i.call(n,r)},t.prototype.complete=function(){var r,n;(n=(r=this.destination)===null||r===void 0?void 0:r.complete)===null||n===void 0||n.call(r)},t.prototype._subscribe=function(r){var n,i;return(i=(n=this.source)===null||n===void 0?void 0:n.subscribe(r))!==null&&i!==void 0?i:wy},t})(nr);function Bh(){for(var e=[],t=0;t<arguments.length;t++)e[t]=arguments[t];return vE()(Os(e,Is(e)))}var wE=new ar(function(e){return e.complete()});function is(e,t){return t===void 0&&(t=ks),e=e??bE,Wr(function(r,n){var i,a=!0;r.subscribe(on(n,function(s){var o=t(s);(a||!e(i,o))&&(a=!1,i=o,n.next(s))}))})}function bE(e,t){return e===t}function tt(e,t){return Wr(function(r,n){var i=0;r.subscribe(on(n,function(a){return e.call(t,a,i++)&&n.next(a)}))})}var EE=nf(function(e){return function(){e(this),this.name="EmptyError",this.message="no elements in sequence"}});function xE(){for(var e=[],t=0;t<arguments.length;t++)e[t]=arguments[t];var r=Is(e),n=Cy(e,1/0);return Wr(function(i,a){cf(n)(Os(vi([i],yi(e)),r)).subscribe(a)})}function SE(){for(var e=[],t=0;t<arguments.length;t++)e[t]=arguments[t];return xE.apply(void 0,vi([],yi(e)))}var ii=(function(e){ki(t,e);function t(r){var n=e.call(this)||this;return n._value=r,n}return Object.defineProperty(t.prototype,"value",{get:function(){return this.getValue()},enumerable:!1,configurable:!0}),t.prototype._subscribe=function(r){var n=e.prototype._subscribe.call(this,r);return!n.closed&&r.next(this._value),n},t.prototype.getValue=function(){var r=this,n=r.hasError,i=r.thrownError,a=r._value;if(n)throw i;return this._throwIfClosed(),a},t.prototype.next=function(r){e.prototype.next.call(this,this._value=r)},t})(nr),kE=(function(e){ki(t,e);function t(r,n,i){r===void 0&&(r=1/0),n===void 0&&(n=1/0),i===void 0&&(i=$y);var a=e.call(this)||this;return a._bufferSize=r,a._windowTime=n,a._timestampProvider=i,a._buffer=[],a._infiniteTimeWindow=!0,a._infiniteTimeWindow=n===1/0,a._bufferSize=Math.max(1,r),a._windowTime=Math.max(1,n),a}return t.prototype.next=function(r){var n=this,i=n.isStopped,a=n._buffer,s=n._infiniteTimeWindow,o=n._timestampProvider,c=n._windowTime;i||(a.push(r),!s&&a.push(o.now()+c)),this._trimBuffer(),e.prototype.next.call(this,r)},t.prototype._subscribe=function(r){this._throwIfClosed(),this._trimBuffer();for(var n=this._innerSubscribe(r),i=this,a=i._infiniteTimeWindow,s=i._buffer,o=s.slice(),c=0;c<o.length&&!r.closed;c+=a?1:2)r.next(o[c]);return this._checkFinalizedStatuses(r),n},t.prototype._trimBuffer=function(){var r=this,n=r._bufferSize,i=r._timestampProvider,a=r._buffer,s=r._infiniteTimeWindow,o=(s?1:2)*n;if(n<1/0&&o<a.length&&a.splice(0,a.length-o),!s){for(var c=i.now(),u=0,d=1;d<a.length&&a[d]<=c;d+=2)u=d;u&&a.splice(0,u+1)}},t})(nr);function IE(e){e===void 0&&(e={});var t=e.connector,r=t===void 0?function(){return new nr}:t,n=e.resetOnError,i=n===void 0?!0:n,a=e.resetOnComplete,s=a===void 0?!0:a,o=e.resetOnRefCountZero,c=o===void 0?!0:o;return function(u){var d,h,p,y=0,g=!1,w=!1,b=function(){h?.unsubscribe(),h=void 0},S=function(){b(),d=p=void 0,g=w=!1},O=function(){var T=d;S(),T?.unsubscribe()};return Wr(function(T,z){y++,!w&&!g&&b();var B=p=p??r();z.add(function(){y--,y===0&&!w&&!g&&(h=ku(O,c))}),B.subscribe(z),!d&&y>0&&(d=new ta({next:function(G){return B.next(G)},error:function(G){w=!0,b(),h=ku(S,i,G),B.error(G)},complete:function(){g=!0,b(),h=ku(S,s),B.complete()}}),mn(T).subscribe(d))})(u)}}function ku(e,t){for(var r=[],n=2;n<arguments.length;n++)r[n-2]=arguments[n];if(t===!0){e();return}if(t!==!1){var i=new ta({next:function(){i.unsubscribe(),e()}});return mn(t.apply(void 0,vi([],yi(r)))).subscribe(i)}}function Ts(e,t,r){var n,i,a,s,o=!1;return e&&typeof e=="object"?(n=e.bufferSize,s=n===void 0?1/0:n,i=e.windowTime,t=i===void 0?1/0:i,a=e.refCount,o=a===void 0?!1:a,r=e.scheduler):s=e??1/0,IE({connector:function(){return new kE(s,t,r)},resetOnError:!0,resetOnComplete:!1,resetOnRefCountZero:o})}function Rs(){for(var e=[],t=0;t<arguments.length;t++)e[t]=arguments[t];var r=Is(e);return Wr(function(n,i){(r?Bh(e,n,r):Bh(e,n)).subscribe(i)})}function OE(e,t){return Wr(function(r,n){var i=null,a=0,s=!1,o=function(){return s&&!i&&n.complete()};r.subscribe(on(n,function(c){i?.unsubscribe();var u=0,d=a++;mn(e(c,d)).subscribe(i=on(n,function(h){return n.next(t?t(c,h,d,u++):h)},function(){i=null,o()}))},function(){s=!0,o()}))})}function My(e){return e.documentData?e.documentData:e.previousDocumentData}function TE(e){switch(e.operation){case"INSERT":return{operation:e.operation,id:e.documentId,doc:e.documentData,previous:null};case"UPDATE":return{operation:e.operation,id:e.documentId,doc:rt.deepFreezeWhenDevMode(e.documentData),previous:e.previousDocumentData?e.previousDocumentData:"UNKNOWN"};case"DELETE":return{operation:e.operation,id:e.documentId,doc:null,previous:e.previousDocumentData}}}function oi(e,t){return new Promise(function(r,n){var i=new ta({next:function(a){r(a),i.unsubscribe()},error:n,complete:function(){n(new EE)}});e.subscribe(i)})}function RE(){for(var e=[],t=0;t<arguments.length;t++)e[t]=arguments[t];var r=Is(e),n=Cy(e,1/0),i=e;return i.length?i.length===1?mn(i[0]):cf(n)(Os(i,r)):wE}function uf(e){return e[e.length-1]}function AE(e){const t=typeof e;return e!==null&&(t==="object"||t==="function")}function zh(e,t,r){if(Array.isArray(t)&&(t=t.join(".")),!AE(e)||typeof t!="string")return e;const n=t.split(".");if(n.length===0)return r;for(let i=0;i<n.length;i++){const a=n[i];if($E(e,a)?e=i===n.length-1?void 0:null:e=e[a],e==null){if(i!==n.length-1)return r;break}}return e===void 0?r:e}function $E(e,t){if(typeof t!="number"&&Array.isArray(e)){const r=Number.parseInt(t,10);return Number.isInteger(r)&&e[r]===e[t]}return!1}const Ly=e=>!!e.queryParams.limit,CE=e=>e.queryParams.limit===1,PE=e=>!!(e.queryParams.skip&&e.queryParams.skip>0),NE=e=>e.changeEvent.operation==="DELETE",DE=e=>e.changeEvent.operation==="INSERT",ME=e=>e.changeEvent.operation==="UPDATE",LE=e=>Ly(e)&&e.previousResults.length>=e.queryParams.limit,jE=e=>{const t=e.queryParams.sortFields,r=e.changeEvent.previous,n=e.changeEvent.doc;if(!n)return!1;if(!r)return!0;for(let i=0;i<t.length;i++){const a=t[i],s=zh(r,a),o=zh(n,a);if(s!==o)return!0}return!1},FE=e=>{const t=e.changeEvent.id;if(e.keyDocumentMap)return e.keyDocumentMap.has(t);{const r=e.queryParams.primaryKey,n=e.previousResults;for(let i=0;i<n.length;i++)if(n[i][r]===t)return!0;return!1}},BE=e=>{const t=e.previousResults[0];return!!(t&&t[e.queryParams.primaryKey]===e.changeEvent.id)},zE=e=>{const t=uf(e.previousResults);return!!(t&&t[e.queryParams.primaryKey]===e.changeEvent.id)},UE=e=>{const t=e.changeEvent.previous;if(!t)return!1;const r=e.previousResults[0];return r?r[e.queryParams.primaryKey]===e.changeEvent.id?!0:e.queryParams.sortComparator(t,r)<0:!1},qE=e=>{const t=e.changeEvent.previous;if(!t)return!1;const r=uf(e.previousResults);return r?r[e.queryParams.primaryKey]===e.changeEvent.id?!0:e.queryParams.sortComparator(t,r)>0:!1},HE=e=>{const t=e.changeEvent.doc;if(!t)return!1;const r=e.previousResults[0];return r?r[e.queryParams.primaryKey]===e.changeEvent.id?!0:e.queryParams.sortComparator(t,r)<0:!1},KE=e=>{const t=e.changeEvent.doc;if(!t)return!1;const r=uf(e.previousResults);return r?r[e.queryParams.primaryKey]===e.changeEvent.id?!0:e.queryParams.sortComparator(t,r)>0:!1},GE=e=>{const t=e.changeEvent.previous;return t?e.queryParams.queryMatcher(t):!1},WE=e=>{const t=e.changeEvent.doc;return t?e.queryParams.queryMatcher(t):!1},VE=e=>e.previousResults.length===0,ZE={0:DE,1:ME,2:NE,3:Ly,4:CE,5:PE,6:VE,7:LE,8:BE,9:zE,10:jE,11:FE,12:UE,13:qE,14:HE,15:KE,16:GE,17:WE};function JE(e,t,r,n){var i=e.length,a=i-1,s=0;if(i===0)return e.push(t),0;for(var o;n<=a;)s=n+(a-n>>1),o=e[s],r(o,t)<=0?n=s+1:a=s-1;return r(o,t)<=0&&s++,e.splice(s,0,t),s}const QE=e=>{},lf=e=>{e.previousResults.unshift(e.changeEvent.doc),e.keyDocumentMap&&e.keyDocumentMap.set(e.changeEvent.id,e.changeEvent.doc)},df=e=>{e.previousResults.push(e.changeEvent.doc),e.keyDocumentMap&&e.keyDocumentMap.set(e.changeEvent.id,e.changeEvent.doc)},ff=e=>{const t=e.previousResults.shift();e.keyDocumentMap&&t&&e.keyDocumentMap.delete(t[e.queryParams.primaryKey])},hf=e=>{const t=e.previousResults.pop();e.keyDocumentMap&&t&&e.keyDocumentMap.delete(t[e.queryParams.primaryKey])},YE=e=>{ff(e),df(e)},XE=e=>{hf(e),lf(e)},ex=e=>{ff(e),lf(e)},tx=e=>{hf(e),df(e)},jy=e=>{e.keyDocumentMap&&e.keyDocumentMap.delete(e.changeEvent.id);const t=e.queryParams.primaryKey,r=e.previousResults;for(let n=0;n<r.length;n++)if(r[n][t]===e.changeEvent.id){r.splice(n,1);break}},rx=e=>{const t=e.changeEvent.doc,r=e.queryParams.primaryKey,n=e.previousResults;for(let i=0;i<n.length;i++)if(n[i][r]===e.changeEvent.id){n[i]=t,e.keyDocumentMap&&e.keyDocumentMap.set(e.changeEvent.id,t);break}},nx=e=>{const t={_id:"wrongHuman"+new Date().getTime()};e.previousResults.length=0,e.previousResults.push(t),e.keyDocumentMap&&(e.keyDocumentMap.clear(),e.keyDocumentMap.set(t._id,t))},Fy=e=>{const t=e.changeEvent.id,r=e.changeEvent.doc;if(e.keyDocumentMap){if(e.keyDocumentMap.has(t))return;e.keyDocumentMap.set(t,r)}else if(e.previousResults.find(i=>i[e.queryParams.primaryKey]===t))return;JE(e.previousResults,r,e.queryParams.sortComparator,0)},ix=e=>{jy(e),Fy(e)},ax=e=>{throw new Error("Action runFullQueryAgain must be implemented by yourself")},sx=e=>{throw new Error("Action unknownAction should never be called")},ox=["doNothing","insertFirst","insertLast","removeFirstItem","removeLastItem","removeFirstInsertLast","removeLastInsertFirst","removeFirstInsertFirst","removeLastInsertLast","removeExisting","replaceExisting","alwaysWrong","insertAtSortPosition","removeExistingAndInsertAtSortPosition","runFullQueryAgain","unknownAction"],cx={doNothing:QE,insertFirst:lf,insertLast:df,removeFirstItem:ff,removeLastItem:hf,removeFirstInsertLast:YE,removeLastInsertFirst:XE,removeFirstInsertFirst:ex,removeLastInsertLast:tx,removeExisting:jy,replaceExisting:rx,alwaysWrong:nx,insertAtSortPosition:Fy,removeExistingAndInsertAtSortPosition:ix,runFullQueryAgain:ax,unknownAction:sx},ux=40;function Iu(e){return e.charCodeAt(0)-ux}function lx(e){return e?"1":"0"}function Uh(e,t){const r=[];for(let n=0,i=e.length;n<i;n+=t)r.push(e.substring(n,n+t));return r}function dx(e){const t=new Map,n=2+parseInt(e.charAt(0)+e.charAt(1),10)*2,i=e.substring(2,n),a=Uh(i,2);for(let w=0;w<a.length;w++){const b=a[w],S=b.charAt(0),O=Iu(b.charAt(1));t.set(S,O)}const s=e.substring(n,e.length-3),o=Uh(s,4);for(let w=0;w<o.length;w++){const b=o[w],S=b.charAt(0),O=b.charAt(1),T=b.charAt(2),z=Iu(b.charAt(3));if(!t.has(O))throw new Error("missing node with id "+O);if(!t.has(T))throw new Error("missing node with id "+T);const B=t.get(O),G=t.get(T),q={l:z,0:B,1:G};t.set(S,q)}const c=e.slice(-3),u=c.charAt(0),d=c.charAt(1),h=Iu(c.charAt(2)),p=t.get(u),y=t.get(d);return{l:h,0:p,1:y}}function fx(e,t,r){let n=e,i=e.l;for(;;){const a=t[i](r),s=lx(a);if(n=n[s],typeof n=="number"||typeof n=="string")return n;i=n.l}}const hx="14a1b,c+d2e5f0g/h.i4j*k-l)m(n6oeh6pnm6qen6ril6snh6tin6ubo9vce9wmh9xns9yne9zmi9{cm9|ad9}cp9~aq9ae9bf9bq9cg9ck9cn9nd9np9nq9nf9ng9nm9nk9mr9ms9mt9mj9mk9ml9mn9mc8{8}888mn88m8m4z4w4z44444m4v7yn77~777n777m77m7m7m5m5m55m555m55m5m552|2u2222x222|222222n2n222n2/an/bn/cn///////////,cn,,,,,,,ac0bc00000000000m-m-----------3333(((++++11*m*.";let Ou;function px(){return Ou||(Ou=dx(hx)),Ou}const mx=e=>fx(px(),ZE,e);function gx(e){const t=mx(e);return ox[t]}function yx(e,t,r,n,i){const a=cx[e];return a({queryParams:t,changeEvent:r,previousResults:n,keyDocumentMap:i}),n}var Ji="",Qi=Number.MIN_SAFE_INTEGER;function vx(e,t){var r=t.selector,n=e.indexes?e.indexes.slice(0):[];t.index&&(n=[t.index]);var i=!!t.sort.find(d=>Object.values(d)[0]==="desc"),a=new Set;Object.keys(r).forEach(d=>{var h=Xi(e,d);h&&h.type==="boolean"&&Object.prototype.hasOwnProperty.call(r[d],"$eq")&&a.add(d)});var s=t.sort.map(d=>Object.keys(d)[0]),o=s.filter(d=>!a.has(d)).join(","),c=-1,u;if(n.forEach(d=>{var h=!0,p=!0,y=d.map(O=>{var T=r[O],z=T?Object.keys(T):[],B={};if(!T||!z.length){var G=p?Qi:Ji;B={startKey:G,endKey:h?Ji:Qi,inclusiveStart:!0,inclusiveEnd:!0}}else z.forEach(q=>{if(pf.has(q)){var K=T[q],Oe=Ex(q,K);B=Object.assign(B,Oe)}});return typeof B.startKey>"u"&&(B.startKey=Qi),typeof B.endKey>"u"&&(B.endKey=Ji),typeof B.inclusiveStart>"u"&&(B.inclusiveStart=!0),typeof B.inclusiveEnd>"u"&&(B.inclusiveEnd=!0),p&&!B.inclusiveStart&&(p=!1),h&&!B.inclusiveEnd&&(h=!1),B}),g=y.map(O=>O.startKey),w=y.map(O=>O.endKey),b={index:d,startKeys:g,endKeys:w,inclusiveEnd:h,inclusiveStart:p,sortSatisfiedByIndex:!i&&o===d.filter(O=>!a.has(O)).join(","),selectorSatisfiedByIndex:bx(d,t.selector,g,w)},S=xx(e,t,b);(S>=c||t.index)&&(c=S,u=b)}),!u)throw ye("SNH",{query:t});return u}var pf=new Set(["$eq","$gt","$gte","$lt","$lte"]),_x=new Set(["$eq","$gt","$gte"]),wx=new Set(["$eq","$lt","$lte"]);function bx(e,t,r,n){var i=Object.entries(t),a=i.find(([q,K])=>{if(!e.includes(q))return!0;var Oe=Object.entries(K).find(([Le,qe])=>!pf.has(Le));return Oe});if(a||t.$and||t.$or)return!1;var s=[],o=new Set;for(var[c,u]of Object.entries(t)){if(!e.includes(c))return!1;var d=Object.keys(u).filter(q=>_x.has(q));if(d.length>1)return!1;var h=d[0];if(h&&o.add(c),h!=="$eq"){if(s.length>0)return!1;s.push(h)}}var p=[],y=new Set;for(var[g,w]of Object.entries(t)){if(!e.includes(g))return!1;var b=Object.keys(w).filter(q=>wx.has(q));if(b.length>1)return!1;var S=b[0];if(S&&y.add(g),S!=="$eq"){if(p.length>0)return!1;p.push(S)}}var O=0;for(var T of e){for(var z of[o,y]){if(!z.has(T)&&z.size>0)return!1;z.delete(T)}var B=r[O],G=n[O];if(B!==G&&o.size>0&&y.size>0)return!1;O++}return!0}function Ex(e,t){switch(e){case"$eq":return{startKey:t,endKey:t,inclusiveEnd:!0,inclusiveStart:!0};case"$lte":return{endKey:t,inclusiveEnd:!0};case"$gte":return{startKey:t,inclusiveStart:!0};case"$lt":return{endKey:t,inclusiveEnd:!1};case"$gt":return{startKey:t,inclusiveStart:!1};default:throw new Error("SNH")}}function xx(e,t,r){var n=0,i=d=>{d>0&&(n=n+d)},a=10,s=_u(r.startKeys,d=>d!==Qi&&d!==Ji);i(s*a);var o=_u(r.startKeys,d=>d!==Ji&&d!==Qi);i(o*a);var c=_u(r.startKeys,(d,h)=>d===r.endKeys[h]);i(c*a*1.5);var u=r.sortSatisfiedByIndex?5:0;return i(u),n}class Ii extends Error{}const Sx=2147483647,kx=-2147483648,Ix=Number.MAX_SAFE_INTEGER,Ox=Number.MIN_SAFE_INTEGER,un=Symbol("missing"),By=Object.freeze(new Error("mingo: cycle detected while processing object/array")),Tx="[object Object]",Rx=/^\[object ([a-zA-Z0-9]+)\]$/,As=e=>{const t=Dx(e);let r=0,n=t.length;for(;n;)r=(r<<5)-r^t.charCodeAt(--n);return r>>>0},zy=new Set(["null","undefined","boolean","number","string","date","regexp"]),Ax={null:0,undefined:0,number:1,string:2,object:3,array:4,boolean:5,date:6,regexp:7,function:8},Wt=(e,t)=>{e===un&&(e=void 0),t===un&&(t=void 0);const[r,n]=[e,t].map(i=>Ax[as(i).toLowerCase()]);return r!==n?r-n:r===1||r===2||r===6?e<t?-1:e>t?1:0:Hr(e,t)?0:e<t?-1:e>t?1:0};function yt(e,t){if(!e)throw new Ii(t)}const as=e=>Rx.exec(Object.prototype.toString.call(e))[1],Tu=e=>typeof e=="boolean",ln=e=>typeof e=="string",rr=e=>!isNaN(e)&&typeof e=="number",vt=Array.isArray,st=e=>{if(!e)return!1;const t=Object.getPrototypeOf(e);return(t===Object.prototype||t===null)&&Tx===Object.prototype.toString.call(e)},Ec=e=>e===Object(e),Go=e=>e instanceof Date,Wa=e=>e instanceof RegExp,mf=e=>typeof e=="function",Rt=e=>e==null,ra=(e,t)=>e.includes(t),Uy=(e,t)=>!ra(e,t),na=(e,t=!0)=>!!e||t&&e==="",ha=e=>Rt(e)||ln(e)&&!e||e instanceof Array&&e.length===0||st(e)&&Object.keys(e).length===0,qh=e=>e===un,pa=e=>e instanceof Array?e:[e],ir=(e,t)=>!!e&&Object.prototype.hasOwnProperty.call(e,t),gf=e=>typeof ArrayBuffer<"u"&&ArrayBuffer.isView(e),$x=[Go,Wa,gf],od=(e,t)=>{if(Rt(e))return e;if(t.has(e))throw By;const r=e.constructor;if($x.some(n=>n(e)))return new r(e);try{if(t.add(e),vt(e))return e.map(n=>od(n,t));if(st(e)){const n={};for(const i in e)n[i]=od(e[i],t);return n}}finally{t.delete(e)}return e},cd=e=>od(e,new Set),Cx=(e,t)=>st(e)&&st(t)||vt(e)&&vt(t);function ud(e,t,r){if(r=r||{flatten:!1},qh(e)||Rt(e))return t;if(qh(t)||Rt(t))return e;if(!Cx(e,t)){if(r.skipValidation)return t||e;throw Error("mismatched types. must both be array or object")}if(r.skipValidation=!0,vt(e)){const n=e,i=t;if(r.flatten){let a=0,s=0;for(;a<n.length&&s<i.length;)n[a]=ud(n[a++],i[s++],r);for(;s<i.length;)n.push(t[s++])}else $s(n,i)}else for(const n in t)e[n]=ud(e[n],t[n],r);return e}function ld(e,t=As){const r=new Map;return e.forEach((n,i)=>{const a=Hy(n,t);r.has(a)?r.get(a).some(s=>Hr(e[s],n))||r.get(a).push(i):r.set(a,[i])}),r}function yf(e,t=As){if(e.some(o=>o.length==0))return[];if(e.length===1)return Array.from(e);const r=Mx(e.map((o,c)=>[c,o.length]),o=>o[1]),n=e[r[0][0]],i=ld(n,t),a=new Map,s=new Array;return i.forEach((o,c)=>{const u=o.map(y=>n[y]),d=u.map(y=>0),h=u.map(y=>[r[0][0],0]);let p=!1;for(let y=1;y<e.length;y++){const[g,w]=r[y],b=e[g];if(a.has(y)||a.set(y,ld(b)),a.get(y).has(c)){const S=a.get(y).get(c).map(O=>b[O]);p=u.map((O,T)=>S.some((z,B)=>{const G=d[T];return Hr(O,z)&&(d[T]++,g<h[T][0]&&(h[T]=[g,a.get(y).get(c)[B]])),G<d[T]})).some(Boolean)}if(!p)return}p&&$s(s,d.map((y,g)=>y===e.length-1?[u[g],h[g]]:un).filter(y=>y!==un))}),s.sort((o,c)=>{const[u,[d,h]]=o,[p,[y,g]]=c,w=Wt(d,y);return w!==0?w:Wt(h,g)}).map(o=>o[0])}function qy(e,t=0){const r=new Array;function n(i,a){for(let s=0,o=i.length;s<o;s++)vt(i[s])&&(a>0||a<0)?n(i[s],Math.max(-1,a-1)):r.push(i[s])}return n(e,t),r}const Px=e=>{let[t,r]=[Object.getPrototypeOf(e),Object.getOwnPropertyNames(e)],n=t;for(;!r.length&&t!==Object.prototype&&t!==Array.prototype;)n=t,r=Object.getOwnPropertyNames(t),t=Object.getPrototypeOf(t);const i={};return r.forEach(a=>i[a]=e[a]),[i,n]};function Hr(e,t){if(e===t||Object.is(e,t))return!0;const r=!!e&&e.constructor||e;if(e===null||t===null||e===void 0||t===void 0||r!==t.constructor||r===Function)return!1;if(r===Array||r===Object){const a=Object.keys(e),s=Object.keys(t);if(a.length!==s.length||new Set([...a,...s]).size!=a.length)return!1;for(const o of a)if(!Hr(e[o],t[o]))return!1;return!0}const n=Object.getPrototypeOf(e);return(gf(e)||n!==Object.prototype&&n!==Array.prototype&&Object.prototype.hasOwnProperty.call(n,"toString"))&&e.toString()===t.toString()}function Nx(e,t=As){const r=e.map(n=>un);return ld(e,t).forEach((n,i)=>{n.forEach(a=>r[a]=e[a])}),r.filter(n=>n!==un)}const Co=(e,t)=>{if(e===null)return"null";if(e===void 0)return"undefined";const r=e.constructor;switch(r){case RegExp:case Number:case Boolean:case Function:case Symbol:return e.toString();case String:return JSON.stringify(e);case Date:return e.toISOString()}if(gf(e))return r.name+"["+e.toString()+"]";if(t.has(e))throw By;try{if(t.add(e),vt(e))return"["+e.map(s=>Co(s,t)).join(",")+"]";if(r===Object)return"{"+Object.keys(e).sort().map(s=>s+":"+Co(e[s],t)).join(",")+"}";const n=Object.getPrototypeOf(e);if(n!==Object.prototype&&n!==Array.prototype&&Object.prototype.hasOwnProperty.call(n,"toString"))return r.name+"("+JSON.stringify(e.toString())+")";const[i,a]=Px(e);return r.name+Co(i,t)}finally{t.delete(e)}},Dx=e=>Co(e,new Set);function Hy(e,t){return t=t||As,Rt(e)?null:t(e).toString()}function Mx(e,t,r=Wt){if(ha(e))return e;const n=new Array,i=new Array;for(let a=0;a<e.length;a++){const s=e[a],o=t(s,a);Rt(o)?i.push(s):n.push([o,s])}return n.sort((a,s)=>r(a[0],s[0])),$s(i,n.map(a=>a[1]))}function Lx(e,t,r=As){if(e.length<1)return new Map;const n=new Map,i=new Map;for(let a=0;a<e.length;a++){const s=e[a],o=t(s,a),c=Hy(o,r);if(c===null)i.has(null)?i.get(null).push(s):i.set(null,[s]);else{const u=n.has(c)?n.get(c).find(d=>Hr(d,o)):null;Rt(u)?(i.set(o,[s]),n.has(c)?n.get(c).push(o):n.set(c,[o])):i.get(u).push(s)}}return i}const Ru=5e4;function $s(e,...t){return e instanceof Array?t.reduce((r,n)=>{let i=Math.ceil(n.length/Ru),a=0;for(;i-- >0;)Array.prototype.push.apply(r,n.slice(a,a+Ru)),a+=Ru;return r},e):t.filter(Ec).reduce((r,n)=>(Object.assign(r,n),r),e)}function dd(e,t){return Ec(e)?e[t]:void 0}function jx(e,t){if(t<1)return e;for(;t--&&e.length===1;)e=e[0];return e}function ma(e,t,r){let n=0;function i(s,o){let c=s;for(let u=0;u<o.length;u++){const d=o[u];if(/^\d+$/.exec(d)===null&&c instanceof Array){if(u===0&&n>0)break;n+=1;const p=o.slice(u);c=c.reduce((y,g)=>{const w=i(g,p);return w!==void 0&&y.push(w),y},[]);break}else c=dd(c,d);if(c===void 0)break}return c}const a=zy.has(as(e).toLowerCase())?e:i(e,t.split("."));return a instanceof Array&&r?.unwrapArray?jx(a,n):a}function Po(e,t,r){const n=t.split("."),i=n[0],a=n.slice(1).join("."),s=/^\d+$/.exec(i)!==null,o=n.length>1;let c,u;if(e instanceof Array)if(s)c=dd(e,Number(i)),o&&(c=Po(c,a,r)),c=[c];else{c=[];for(const d of e)u=Po(d,t,r),r?.preserveMissing?(u===void 0&&(u=un),c.push(u)):u!==void 0&&c.push(u)}else{if(u=dd(e,i),o&&(u=Po(u,a,r)),u===void 0)return;c=r?.preserveKeys?{...e}:{},c[i]=u}return c}function fd(e){if(e instanceof Array)for(let t=e.length-1;t>=0;t--)e[t]===un?e.splice(t,1):fd(e[t]);else if(st(e))for(const t in e)ir(e,t)&&fd(e[t])}const Hh=/^\d+$/;function ss(e,t,r,n){const i=t.split("."),a=i[0],s=i.slice(1).join(".");if(i.length===1)(st(e)||vt(e)&&Hh.test(a))&&r(e,a);else{n?.buildGraph&&Rt(e[a])&&(e[a]={});const o=e[a];if(!o)return;const c=!!(i.length>1&&Hh.test(i[1]));o instanceof Array&&n?.descendArray&&!c?o.forEach(u=>ss(u,s,r,n)):ss(o,s,r,n)}}function Fx(e,t,r){ss(e,t,(n,i)=>{n[i]=mf(r)?r(n[i]):r},{buildGraph:!0})}function Kh(e,t,r){ss(e,t,(n,i)=>{if(n instanceof Array){if(/^\d+$/.test(i))n.splice(parseInt(i),1);else if(r&&r.descendArray)for(const a of n)st(a)&&delete a[i]}else st(n)&&delete n[i]},r)}const Bx=/^\$[a-zA-Z0-9_]+$/;function Oi(e){return Bx.test(e)}function Ky(e){if(zy.has(as(e).toLowerCase()))return Wa(e)?{$regex:e}:{$eq:e};if(Ec(e)){if(!Object.keys(e).some(Oi))return{$eq:e};if(ir(e,"$regex")){const r={...e};return r.$regex=new RegExp(e.$regex,e.$options),delete r.$options,r}}return e}var Fa=(e=>(e.CLONE_ALL="CLONE_ALL",e.CLONE_INPUT="CLONE_INPUT",e.CLONE_OUTPUT="CLONE_OUTPUT",e.CLONE_OFF="CLONE_OFF",e))(Fa||{});class ci{constructor(t,r,n,i=Date.now()){this._opts=t,this._root=r,this._local=n,this.timestamp=i,this.update(r,n)}static init(t,r,n){return t instanceof ci?new ci(t._opts,Rt(t.root)?r:t.root,Object.assign({},t.local,n)):new ci(t,r,n)}update(t,r){return this._root=t,this._local=r&&Object.assign({},r,{variables:Object.assign({},this._local?.variables,r?.variables)}),this}getOptions(){return Object.freeze({...this._opts,context:_i.from(this._opts.context)})}get root(){return this._root}get local(){return this._local}get idKey(){return this._opts.idKey}get collation(){return this._opts?.collation}get processingMode(){return this._opts?.processingMode||"CLONE_OFF"}get useStrictMode(){return this._opts?.useStrictMode}get scriptEnabled(){return this._opts?.scriptEnabled}get useGlobalContext(){return this._opts?.useGlobalContext}get hashFunction(){return this._opts?.hashFunction}get collectionResolver(){return this._opts?.collectionResolver}get jsonSchemaValidator(){return this._opts?.jsonSchemaValidator}get variables(){return this._opts?.variables}get context(){return this._opts?.context}}function Wo(e){return e instanceof ci?e.getOptions():Object.freeze({idKey:"_id",scriptEnabled:!0,useStrictMode:!0,useGlobalContext:!0,processingMode:"CLONE_OFF",...e,context:e?.context?_i.from(e?.context):_i.init({})})}var ia=(e=>(e.ACCUMULATOR="accumulator",e.EXPRESSION="expression",e.PIPELINE="pipeline",e.PROJECTION="projection",e.QUERY="query",e.WINDOW="window",e))(ia||{});class _i{constructor(t){this.operators={accumulator:{},expression:{},pipeline:{},projection:{},query:{},window:{}};for(const[r,n]of Object.entries(t))this.addOperators(r,n)}static init(t={}){return new _i(t)}static from(t){return new _i(t.operators)}addOperators(t,r){for(const[n,i]of Object.entries(r))this.getOperator(t,n)||(this.operators[t][n]=i);return this}addAccumulatorOps(t){return this.addOperators("accumulator",t)}addExpressionOps(t){return this.addOperators("expression",t)}addQueryOps(t){return this.addOperators("query",t)}addPipelineOps(t){return this.addOperators("pipeline",t)}addProjectionOps(t){return this.addOperators("projection",t)}addWindowOps(t){return this.addOperators("window",t)}getOperator(t,r){return t in this.operators&&this.operators[t][r]||null}}const ni=_i.init();function Gh(e,t){for(const[r,n]of Object.entries(t)){yt(mf(n)&&Oi(r),`'${r}' is not a valid operator`);const i=ui(e,r,null);yt(!i||n===i,`${r} already exists for '${e}' operators. Cannot change operator function once registered.`)}switch(e){case"accumulator":ni.addAccumulatorOps(t);break;case"expression":ni.addExpressionOps(t);break;case"pipeline":ni.addPipelineOps(t);break;case"projection":ni.addProjectionOps(t);break;case"query":ni.addQueryOps(t);break;case"window":ni.addWindowOps(t);break}}function ui(e,t,r){const{context:n,useGlobalContext:i}=r||{},a=n?n.getOperator(e,t):null;return!a&&i?ni.getOperator(e,t):a}const Wh={$$ROOT(e,t,r){return r.root},$$CURRENT(e,t,r){return e},$$REMOVE(e,t,r){},$$NOW(e,t,r){return new Date(r.timestamp)}},hd={$$KEEP(e,t,r){return e},$$PRUNE(e,t,r){},$$DESCEND(e,t,r){if(!ir(t,"$cond"))return e;let n;for(const[i,a]of Object.entries(e))if(Ec(a)){if(a instanceof Array){const s=[];for(let o of a)st(o)&&(o=Vh(o,t,r.update(o))),Rt(o)||s.push(o);n=s}else n=Vh(a,t,r.update(a));Rt(n)?delete e[i]:e[i]=n}return e}};function Pt(e,t,r,n){const i=ci.init(n,e);if(r=r||"",Oi(r)){const a=ui("expression",r,n);if(a)return a(e,t,i);const s=ui("accumulator",r,n);if(s)return e instanceof Array||(e=Pt(e,t,null,i),t=null),yt(e instanceof Array,`'${r}' target must be an array.`),s(e,t,i.update(null,i.local));throw new Ii(`operator '${r}' is not registered`)}if(ln(t)&&t.length>0&&t[0]==="$"){if(ir(hd,t))return t;let a=i.root;const s=t.split(".");if(ir(Wh,s[0]))a=Wh[s[0]](e,null,i),t=t.slice(s[0].length+1);else if(s[0].slice(0,2)==="$$"){a=Object.assign({},i.variables,{this:e},i.local?.variables);const o=s[0].slice(2);yt(ir(a,o),`Use of undefined variable: ${o}`),t=t.slice(2)}else t=t.slice(1);return t===""?a:ma(a,t)}if(vt(t))return t.map(a=>Pt(e,a,null,i));if(st(t)){const a={};for(const[s,o]of Object.entries(t))if(a[s]=Pt(e,o,s,i),["expression","accumulator"].some(c=>!!ui(c,s,n)))return yt(Object.keys(t).length===1,"Invalid aggregation expression '"+JSON.stringify(t)+"'"),a[s];return a}return t}function Vh(e,t,r){const n=Pt(e,t,null,r);return ir(hd,n)?hd[n](e,t,r):n}function aa(e){return e instanceof Zh?e:new Zh(e)}function zx(...e){let t=0;return aa(()=>{for(;t<e.length;){const r=e[t].next();if(!r.done)return r;t++}return{done:!0}})}function Ux(e){return!!e&&typeof e=="object"&&e?.next instanceof Function}function qx(e,t){const r=e.slice(t+1);e.splice(t),Array.prototype.push.apply(e,r)}const pd=new Error;function Hx(e,t,r){let n=!1,i=-1,a=0;return function(s){try{e:for(;!n;){let o=e();i++;let c=-1;const u=t.length;let d=!1;for(;++c<u;){const h=t[c];switch(h.action){case 0:o=h.func(o,i);break;case 1:if(!h.func(o,i))continue e;break;case 2:--h.count,h.count||(d=!0);break;case 3:--h.count,h.count||qx(t,c);continue e;default:break e}}if(n=d,s)r[a++]=o;else return{value:o,done:!1}}}catch(o){if(o!==pd)throw o}return n=!0,{done:n}}}let Zh=class{constructor(t){this.iteratees=[],this.yieldedValues=[],this.isDone=!1;let r;if(t instanceof Function&&(t={next:t}),Ux(t)){const n=t;r=()=>{const i=n.next();if(i.done)throw pd;return i.value}}else if(t instanceof Array){const n=t,i=n.length;let a=0;r=()=>{if(a<i)return n[a++];throw pd}}else if(!(t instanceof Function))throw new Ii("Lazy must be initialized with an array, generator, or function.");this.getNext=Hx(r,this.iteratees,this.yieldedValues)}push(t,r){return typeof r=="function"?this.iteratees.push({action:t,func:r}):typeof r=="number"&&this.iteratees.push({action:t,count:r}),this}next(){return this.getNext()}map(t){return this.push(0,t)}filter(t){return this.push(1,t)}take(t){return t>0?this.push(2,t):this}drop(t){return t>0?this.push(3,t):this}transform(t){const r=this;let n;return aa(()=>(n||(n=aa(t(r.value()))),n.next()))}value(){return this.isDone||(this.isDone=this.getNext(!0).done),this.yieldedValues}each(t){for(;;){const r=this.next();if(r.done)break;if(t(r.value)===!1)return!1}return!0}reduce(t,r){let n=this.next();for(r===void 0&&!n.done&&(r=n.value,n=this.next());!n.done;)r=t(r,n.value),n=this.next();return r}size(){return this.reduce((t,r)=>++t,0)}[Symbol.iterator](){return this}};class Kx{constructor(t,r){this.pipeline=t,this.options=Wo(r)}stream(t){let r=aa(t);const n=this.options.processingMode;(n==Fa.CLONE_ALL||n==Fa.CLONE_INPUT)&&r.map(cd);const i=new Array;if(!ha(this.pipeline))for(const a of this.pipeline){const s=Object.keys(a),o=s[0],c=ui(ia.PIPELINE,o,this.options);yt(s.length===1&&!!c,`invalid pipeline operator ${o}`),i.push(o),r=c(r,a[o],this.options)}return(n==Fa.CLONE_OUTPUT||n==Fa.CLONE_ALL&&yf([["$group","$unwind"],i]).length)&&r.map(cd),r}run(t){return this.stream(t).value()}}class Gx{constructor(t,r,n,i){this.source=t,this.predicate=r,this.projection=n,this.options=i,this.operators=[],this.result=null,this.buffer=[]}fetch(){return this.result?this.result:(st(this.projection)&&this.operators.push({$project:this.projection}),this.result=aa(this.source).filter(this.predicate),this.operators.length>0&&(this.result=new Kx(this.operators,this.options).stream(this.result)),this.result)}fetchAll(){const t=aa([...this.buffer]);return this.buffer=[],zx(t,this.fetch())}all(){return this.fetchAll().value()}count(){return this.all().length}skip(t){return this.operators.push({$skip:t}),this}limit(t){return this.operators.push({$limit:t}),this}sort(t){return this.operators.push({$sort:t}),this}collation(t){return this.options={...this.options,collation:t},this}next(){if(this.buffer.length>0)return this.buffer.pop();const t=this.fetch().next();if(!t.done)return t.value}hasNext(){if(this.buffer.length>0)return!0;const t=this.fetch().next();return t.done?!1:(this.buffer.push(t.value),!0)}map(t){return this.all().map(t)}forEach(t){this.all().forEach(t)}[Symbol.iterator](){return this.fetchAll()}}class dn{constructor(t,r){this.condition=t,this.options=Wo(r),this.compiled=[],this.compile()}compile(){yt(st(this.condition),`query criteria must be an object: ${JSON.stringify(this.condition)}`);const t={};for(const[r,n]of Object.entries(this.condition)){if(r==="$where")Object.assign(t,{field:r,expr:n});else if(ra(["$and","$or","$nor","$expr","$jsonSchema"],r))this.processOperator(r,r,n);else{yt(!Oi(r),`unknown top level operator: ${r}`);for(const[i,a]of Object.entries(Ky(n)))this.processOperator(r,i,a)}t.field&&this.processOperator(t.field,t.field,t.expr)}}processOperator(t,r,n){const i=ui(ia.QUERY,r,this.options);if(!i)throw new Ii(`unknown query operator ${r}`);const a=i(t,n,this.options);this.compiled.push(a)}test(t){for(let r=0,n=this.compiled.length;r<n;r++)if(!this.compiled[r](t))return!1;return!0}find(t,r){return new Gx(t,n=>this.test(n),r||{},this.options)}remove(t){return t.reduce((r,n)=>(this.test(n)||r.push(n),r),[])}}const Wx=(e,t,r)=>{if(ha(t)||!st(t))return e;let n=Wt;const i=r.collation;return st(i)&&ln(i.locale)&&(n=Zx(i)),e.transform(a=>{const s=Object.keys(t);for(const o of s.reverse()){const c=Lx(a,d=>ma(d,o),r.hashFunction),u=Array.from(c.keys()).sort(n);t[o]===-1&&u.reverse(),a=[],u.reduce((d,h)=>$s(d,c.get(h)),a)}return a})},Vx={1:"base",2:"accent",3:"variant"};function Zx(e){const t={sensitivity:Vx[e.strength||3],caseFirst:e.caseFirst==="off"?"false":e.caseFirst||"false",numeric:e.numericOrdering||!1,ignorePunctuation:e.alternate==="shifted"};(e.caseLevel||!1)===!0&&(t.sensitivity==="base"&&(t.sensitivity="case"),t.sensitivity==="accent"&&(t.sensitivity="variant"));const r=new Intl.Collator(e.locale,t);return(n,i)=>{if(!ln(n)||!ln(i))return Wt(n,i);const a=r.compare(n,i);return a<0?-1:a>0?1:0}}function Nt(e){const t=(r,n,i)=>{const a={unwrapArray:!0},s=Math.max(1,r.split(".").length-1);return o=>{const c=ma(o,r,a);return e(c,n,{...i,depth:s})}};return t.op="query",t}function ga(e){return(t,r,n)=>{const i=Pt(t,r,null,n);return e(...i)}}function vf(e,t,r){if(Hr(e,t)||Rt(e)&&Rt(t))return!0;if(e instanceof Array){const n=Hr.bind(null,t);return e.some(n)||qy(e,r?.depth).some(n)}return!1}function Gy(e,t,r){return!vf(e,t,r)}function Wy(e,t,r){return Rt(e)?t.some(n=>n===null):yf([pa(e),t],r?.hashFunction).length>0}function Jx(e,t,r){return!Wy(e,t,r)}function Vy(e,t,r){return xc(e,t,(n,i)=>Wt(n,i)<0)}function Zy(e,t,r){return xc(e,t,(n,i)=>Wt(n,i)<=0)}function Jy(e,t,r){return xc(e,t,(n,i)=>Wt(n,i)>0)}function Qy(e,t,r){return xc(e,t,(n,i)=>Wt(n,i)>=0)}function Qx(e,t,r){return pa(e).some(n=>t.length===2&&n%t[0]===t[1])}function Yx(e,t,r){const n=pa(e),i=a=>ln(a)&&na(t.exec(a),r?.useStrictMode);return n.some(i)||qy(n,1).some(i)}function Xx(e,t,r){return(t===!1||t===0)&&e===void 0||(t===!0||t===1)&&e!==void 0}function eS(e,t,r){if(!vt(e)||!vt(t)||!e.length||!t.length)return!1;let n=!0;for(const i of t){if(!n)break;st(i)&&ra(Object.keys(i),"$elemMatch")?n=Yy(e,i.$elemMatch,r):i instanceof RegExp?n=e.some(a=>typeof a=="string"&&i.test(a)):n=e.some(a=>Hr(i,a))}return n}function tS(e,t,r){return Array.isArray(e)&&e.length===t}function rS(e){return Oi(e)&&["$and","$or","$nor"].indexOf(e)===-1}function Yy(e,t,r){if(vt(e)&&!ha(e)){let n=s=>s,i=t;Object.keys(t).every(rS)&&(i={temp:t},n=s=>({temp:s}));const a=new dn(i,r);for(let s=0,o=e.length;s<o;s++)if(a.test(n(e[s])))return!0}return!1}const Jh=e=>e===null,Qh=e=>rr(e)&&e>=kx&&e<=Sx&&e.toString().indexOf(".")===-1,Yh=e=>rr(e)&&e>=Ox&&e<=Ix&&e.toString().indexOf(".")===-1,nS={array:vt,bool:Tu,boolean:Tu,date:Go,decimal:rr,double:rr,int:Qh,long:Yh,number:rr,null:Jh,object:st,regex:Wa,regexp:Wa,string:ln,undefined:Rt,function:e=>{throw new Ii("unsupported type key `function`.")},1:rr,2:ln,3:st,4:vt,6:Rt,8:Tu,9:Go,10:Jh,11:Wa,16:Qh,18:Yh,19:rr};function Xh(e,t,r){const n=nS[t];return n?n(e):!1}function iS(e,t,r){return Array.isArray(t)?t.findIndex(n=>Xh(e,n))>=0:Xh(e,t)}function xc(e,t,r){return pa(e).some(n=>as(n)===as(t)&&r(n,t))}const aS=(e,t,r)=>{const n=Pt(e,t,null,r);return na(n,r.useStrictMode)&&n.every(i=>na(i,r.useStrictMode))},sS=(e,t,r)=>{const n=pa(t);if(n.length==0)return!1;if(n.length==1)return!Pt(e,n[0],null,r);throw"Expression $not takes exactly 1 argument"},oS=(e,t,r)=>{const n=Pt(e,t,null,r),i=r.useStrictMode;return na(n,i)&&n.some(a=>na(a,i))},cS=Object.freeze(Object.defineProperty({__proto__:null,$and:aS,$not:sS,$or:oS},Symbol.toStringTag,{value:"Module"})),uS=(e,t,r)=>{const n=Pt(e,t,null,r);return n[0]>n[1]?1:n[0]<n[1]?-1:0},lS=ga(vf),dS=ga(Jy),fS=ga(Qy),hS=ga(Vy),pS=ga(Zy),mS=ga(Gy),gS=Object.freeze(Object.defineProperty({__proto__:null,$cmp:uS,$eq:lS,$gt:dS,$gte:fS,$lt:hS,$lte:pS,$ne:mS},Symbol.toStringTag,{value:"Module"})),ep=(e,t)=>{const r={};return e.split("").forEach((n,i)=>r[n]=t*(i+1)),r};({...ep("ABCDEFGHIKLM",1),...ep("NOPQRSTUVWXY",-1)});const tp={undefined:null,null:null,NaN:NaN,Infinity:new Error,"-Infinity":new Error};function ur(e,t=tp){const r=Object.assign({},tp,t),n=new Set(Object.keys(r));return(i,a,s)=>{const o=Pt(i,a,null,s);if(n.has(`${o}`)){const c=r[`${o}`];if(c instanceof Error)throw new Ii(`cannot apply $${e.name} to -inf, value must in (-inf,inf)`);return c}return e(o)}}ur(Math.acos,{Infinity:1/0,0:new Error});ur(Math.acosh,{Infinity:1/0,0:new Error});ur(Math.asin);ur(Math.asinh,{Infinity:1/0,"-Infinity":-1/0});ur(Math.atan);ur(Math.atanh,{1:1/0,"-1":-1/0});ur(Math.cos);ur(Math.cosh,{"-Infinity":1/0,Infinity:1/0});const yS=Math.PI/180;ur(e=>e*yS,{Infinity:1/0,"-Infinity":1/0});const vS=180/Math.PI;ur(e=>e*vS,{Infinity:1/0,"-Infinity":-1/0});ur(Math.sin);ur(Math.sinh,{"-Infinity":-1/0,Infinity:1/0});ur(Math.tan);const _S=(e,t,r)=>{if(ha(t))return e;let n=Object.keys(t),i=!1;Xy(t,r);const a=r.idKey;if(ra(n,a)){const o=t[a];(o===0||o===!1)&&(n=n.filter(Uy.bind(null,[a])),i=n.length==0)}else n.push(a);const s=ci.init(r);return e.map(o=>md(o,t,s.update(o),n,i))};function md(e,t,r,n,i){let a={},s=!1,o=!1;const c=[];i&&c.push(r.idKey);for(const u of n){let d;const h=t[u];if(u!==r.idKey&&ra([0,!1],h)&&(o=!0),u===r.idKey&&ha(h))d=e[u];else if(ln(h))d=Pt(e,h,u,r);else if(!ra([1,!0],h))if(h instanceof Array)d=h.map(y=>{const g=Pt(e,y,null,r);return Rt(g)?null:g});else if(st(h)){const y=h,g=Object.keys(h),w=g.length==1?g[0]:"",b=ui(ia.PROJECTION,w,r);if(b)w==="$slice"?pa(y[w]).every(rr)?(d=b(e,y[w],u,r),s=!0):d=Pt(e,y,u,r):d=b(e,y[w],u,r);else if(Oi(w))d=Pt(e,y[w],w,r);else if(ir(e,u)){Xy(y,r);let S=e[u];S instanceof Array?d=S.map(O=>md(O,y,r,g,!1)):(S=st(S)?S:e,d=md(S,y,r,g,!1))}else d=Pt(e,h,null,r)}else{c.push(u);continue}const p=Po(e,u,{preserveMissing:!0});p!==void 0&&ud(a,p,{flatten:!0}),Uy([0,1,!1,!0],h)&&(d===void 0?Kh(a,u,{descendArray:!0}):Fx(a,u,d))}if(fd(a),(s||o||i)&&(a=$s({},e,a),c.length>0))for(const u of c)Kh(a,u,{descendArray:!0});return a}function Xy(e,t){const r=[!1,!1];for(const[n,i]of Object.entries(e)){if(n===t?.idKey)return;i===0||i===!1?r[0]=!0:(i===1||i===!0)&&(r[1]=!0),yt(!(r[0]&&r[1]),"Projection cannot have a mix of inclusion and exclusion.")}}const ev=(e,t,r)=>{yt(vt(t),"Invalid expression: $and expects value to be an Array.");const n=t.map(i=>new dn(i,r));return i=>n.every(a=>a.test(i))},_f=(e,t,r)=>{yt(vt(t),"Invalid expression. $or expects value to be an Array");const n=t.map(i=>new dn(i,r));return i=>n.some(a=>a.test(i))},tv=(e,t,r)=>{yt(vt(t),"Invalid expression. $nor expects value to be an array.");const n=_f("$or",t,r);return i=>!n(i)},rv=(e,t,r)=>{const n={};n[e]=Ky(t);const i=new dn(n,r);return a=>!i.test(a)},nv=Nt(vf),iv=Nt(Jy),av=Nt(Qy),sv=Nt(Wy),ov=Nt(Vy),cv=Nt(Zy),uv=Nt(Gy),lv=Nt(Jx);function wS(e,t,r){return n=>Pt(n,t,null,r)}function bS(e,t,r){if(!r?.jsonSchemaValidator)throw new Ii("Missing option 'jsonSchemaValidator'. Configure to use '$jsonSchema' operator.");const n=r?.jsonSchemaValidator(t);return i=>n(i)}const dv=Nt(Qx),fv=Nt(Yx);function ES(e,t,r){yt(r.scriptEnabled,"$where operator requires 'scriptEnabled' option to be true");const n=t;return yt(mf(n),"$where only accepts a Function object"),i=>na(n.call(i),r?.useStrictMode)}const xS=Nt(eS),hv=Nt(Yy),pv=Nt(tS),mv=Nt(Xx),gv=Nt(iS);var rp=!1;function SS(e){return rp||(Gh(ia.PIPELINE,{$sort:Wx,$project:_S}),Gh(ia.QUERY,{$and:ev,$eq:nv,$elemMatch:hv,$exists:mv,$gt:iv,$gte:av,$in:sv,$lt:ov,$lte:cv,$ne:uv,$nin:lv,$mod:dv,$nor:tv,$not:rv,$or:_f,$regex:fv,$size:pv,$type:gv}),rp=!0),new dn(e)}function os(e,t){var r=cr(e.primaryKey);t=it(t);var n=zt(t);if(typeof n.skip!="number"&&(n.skip=0),n.selector?(n.selector=n.selector,Object.entries(n.selector).forEach(([u,d])=>{(typeof d!="object"||d===null)&&(n.selector[u]={$eq:d})})):n.selector={},n.index){var i=Qd(n.index);i.includes(r)||i.push(r),n.index=i}if(n.sort){var c=n.sort.find(u=>Fb(u)===r);c||(n.sort=n.sort.slice(0),n.sort.push({[r]:"asc"}))}else if(n.index)n.sort=n.index.map(u=>({[u]:"asc"}));else{if(e.indexes){var a=new Set;Object.entries(n.selector).forEach(([u,d])=>{var h=!1;typeof d=="object"&&d!==null?h=!!Object.keys(d).find(p=>pf.has(p)):h=!0,h&&a.add(u)});var s=-1,o;e.indexes.forEach(u=>{var d=Yd(u)?u:[u],h=d.findIndex(p=>!a.has(p));h>0&&h>s&&(s=h,o=d)}),o&&(n.sort=o.map(u=>({[u]:"asc"})))}n.sort||(n.sort=[{[r]:"asc"}])}return n}function yv(e,t){if(!t.sort)throw ye("SNH",{query:t});var r=[];t.sort.forEach(i=>{var a=Object.keys(i)[0],s=Object.values(i)[0];r.push({key:a,direction:s,getValueFn:jb(a)})});var n=(i,a)=>{for(var s=0;s<r.length;++s){var o=r[s],c=o.getValueFn(i),u=o.getValueFn(a);if(c!==u){var d=o.direction==="asc"?Wt(c,u):Wt(u,c);return d}}};return n}function wf(e,t){if(!t.sort)throw ye("SNH",{query:t});var r=SS(t.selector),n=i=>r.test(i);return n}async function zi(e,t){var r=await e.exec();if(!r)return null;if(Array.isArray(r))return Promise.all(r.map(i=>t(i)));if(r instanceof Map)return Promise.all([...r.values()].map(i=>t(i)));var n=await t(r);return n}function kS(e,t){return!t.sort||t.sort.length===0?[e]:t.sort.map(r=>Object.keys(r)[0])}var IS=new WeakMap;function OS(e){return sn(IS,e,()=>{var t=e.collection,r=os(t.storageInstance.schema,zt(e.mangoQuery)),n=t.schema.primaryPath,i=yv(t.schema.jsonSchema,r),a=(u,d)=>{var h={docA:u,docB:d};return i(h.docA,h.docB)},s=wf(t.schema.jsonSchema,r),o=u=>{var d={doc:u};return s(d.doc)},c={primaryKey:e.collection.schema.primaryPath,skip:r.skip,limit:r.limit,sortFields:kS(n,r),sortComparator:a,queryMatcher:o};return c})}function TS(e,t){if(!e.collection.database.eventReduce)return{runFullQueryAgain:!0};var r=OS(e),n=ze(e._result).docsData.slice(0),i=ze(e._result).docsDataMap,a=!1,s=t.map(c=>TE(c)).filter(Mb),o=s.find(c=>{var u={queryParams:r,changeEvent:c,previousResults:n,keyDocumentMap:i},d=gx(u);if(d==="runFullQueryAgain")return!0;if(d!=="doNothing")return a=!0,yx(d,r,c,n,i),!1});return o?{runFullQueryAgain:!0}:{runFullQueryAgain:!1,changed:a,newResults:n}}var RS=(function(){function e(){this._map=new Map}var t=e.prototype;return t.getByQuery=function(n){var i=n.toString();return sn(this._map,i,()=>n)},e})();function AS(){return new RS}function np(e,t){t.uncached=!0;var r=t.toString();e._map.delete(r)}function $S(e){return e.refCount$.observers.length}var CS=100,PS=30*1e3,NS=(e,t)=>(r,n)=>{if(!(n._map.size<e)){var i=Tt()-t,a=[],s=Array.from(n._map.values());for(var o of s)if(!($S(o)>0)){if(o._lastEnsureEqual===0&&o._creationTime<i){np(n,o);continue}a.push(o)}var c=a.length-e;if(!(c<=0)){var u=a.sort((h,p)=>h._lastEnsureEqual-p._lastEnsureEqual),d=u.slice(0,c);d.forEach(h=>np(n,h))}}},vv=NS(CS,PS),Au=new WeakSet;function DS(e){Au.has(e)||(Au.add(e),i0().then(()=>c0(200)).then(()=>{e.destroyed||e.cacheReplacementPolicy(e,e._queryCache),Au.delete(e)}))}var _v=(function(){function e(r,n,i){this.cacheItemByDocId=new Map,this.tasks=new Set,this.registry=typeof FinalizationRegistry=="function"?new FinalizationRegistry(a=>{var s=a.docId,o=this.cacheItemByDocId.get(s);o&&(o[0].delete(a.revisionHeight),o[0].size===0&&this.cacheItemByDocId.delete(s))}):void 0,this.primaryPath=r,this.changes$=n,this.documentCreator=i,n.subscribe(a=>{this.tasks.add(()=>{for(var s=this.cacheItemByDocId,o=0;o<a.length;o++){var c=a[o],u=s.get(c.documentId);if(u){var d=c.documentData;d||(d=c.previousDocumentData),u[1]=d}}}),this.tasks.size<=1&&vc().then(()=>{this.processTasks()})})}var t=e.prototype;return t.processTasks=function(){if(this.tasks.size!==0){var n=Array.from(this.tasks);n.forEach(i=>i()),this.tasks.clear()}},t.getLatestDocumentData=function(n){this.processTasks();var i=gi(this.cacheItemByDocId,n);return i[1]},t.getLatestDocumentDataIfExists=function(n){this.processTasks();var i=this.cacheItemByDocId.get(n);if(i)return i[1]},zn(e,[{key:"getCachedRxDocuments",get:function(){var r=ip(this);return tn(this,"getCachedRxDocuments",r)}},{key:"getCachedRxDocument",get:function(){var r=ip(this);return tn(this,"getCachedRxDocument",n=>r([n])[0])}}])})();function ip(e){var t=e.primaryPath,r=e.cacheItemByDocId,n=e.registry,i=rt.deepFreezeWhenDevMode,a=e.documentCreator,s=o=>{for(var c=new Array(o.length),u=[],d=0;d<o.length;d++){var h=o[d],p=h[t],y=Dn(h._rev),g=void 0,w=void 0,b=r.get(p);b?(g=b[0],w=g.get(y)):(g=new Map,b=[g,h],r.set(p,b));var S=w?w.deref():void 0;S||(h=i(h),S=a(h),g.set(y,LS(S)),n&&u.push(S)),c[d]=S}return u.length>0&&n&&(e.tasks.add(()=>{for(var O=0;O<u.length;O++){var T=u[O];n.register(T,{docId:T.primary,revisionHeight:Dn(T.revision)})}}),e.tasks.size<=1&&vc().then(()=>{e.processTasks()})),c};return s}function wv(e,t){var r=e.getCachedRxDocuments;return r(t)}var MS=typeof WeakRef=="function",LS=MS?jS:FS;function jS(e){return new WeakRef(e)}function FS(e){return{deref(){return e}}}var ap=(function(){function e(r,n,i){this.time=Tt(),this.query=r,this.count=i,this.documents=wv(this.query.collection._docCache,n)}var t=e.prototype;return t.getValue=function(n){var i=this.query.op;if(i==="count")return this.count;if(i==="findOne"){var a=this.documents.length===0?null:this.documents[0];if(!a&&n)throw ye("QU10",{collection:this.query.collection.name,query:this.query.mangoQuery,op:i});return a}else return i==="findByIds"?this.docsMap:this.documents.slice(0)},zn(e,[{key:"docsData",get:function(){return tn(this,"docsData",this.documents.map(r=>r._data))}},{key:"docsDataMap",get:function(){var r=new Map;return this.documents.forEach(n=>{r.set(n.primary,n._data)}),tn(this,"docsDataMap",r)}},{key:"docsMap",get:function(){for(var r=new Map,n=this.documents,i=0;i<n.length;i++){var a=n[i];r.set(a.primary,a)}return tn(this,"docsMap",r)}}])})(),BS=0,zS=function(){return++BS},bv=(function(){function e(r,n,i,a={}){this.id=zS(),this._execOverDatabaseCount=0,this._creationTime=Tt(),this._lastEnsureEqual=0,this.uncached=!1,this.refCount$=new ii(null),this._result=null,this._latestChangeEvent=-1,this._lastExecStart=0,this._lastExecEnd=0,this._ensureEqualQueue=Tr,this.op=r,this.mangoQuery=n,this.collection=i,this.other=a,n||(this.mangoQuery=No()),this.isFindOneByIdQuery=KS(this.collection.schema.primaryPath,n)}var t=e.prototype;return t._setResultData=function(n){if(typeof n>"u")throw ye("QU18",{database:this.collection.database.name,collection:this.collection.name});if(typeof n=="number"){this._result=new ap(this,[],n);return}else n instanceof Map&&(n=Array.from(n.values()));var i=new ap(this,n,n.length);this._result=i},t._execOverDatabase=async function(){if(this._execOverDatabaseCount=this._execOverDatabaseCount+1,this._lastExecStart=Tt(),this.op==="count"){var n=this.getPreparedQuery(),i=await this.collection.storageInstance.count(n);if(i.mode==="slow"&&!this.collection.database.allowSlowCount)throw ye("QU14",{collection:this.collection,queryObj:this.mangoQuery});return i.count}if(this.op==="findByIds"){var a=ze(this.mangoQuery.selector)[this.collection.schema.primaryPath].$in,s=new Map,o=[];if(a.forEach(d=>{var h=this.collection._docCache.getLatestDocumentDataIfExists(d);if(h){if(!h._deleted){var p=this.collection._docCache.getCachedRxDocument(h);s.set(d,p)}}else o.push(d)}),o.length>0){var c=await this.collection.storageInstance.findDocumentsById(o,!1);c.forEach(d=>{var h=this.collection._docCache.getCachedRxDocument(d);s.set(h.primary,h)})}return s}var u=HS(this);return u.then(d=>(this._lastExecEnd=Tt(),d))},t.exec=async function(n){if(n&&this.op!=="findOne")throw ye("QU9",{collection:this.collection.name,query:this.mangoQuery,op:this.op});await sp(this);var i=ze(this._result);return i.getValue(n)},t.toString=function(){var n=Ho({op:this.op,query:this.mangoQuery,other:this.other},!0),i=JSON.stringify(n);return this.toString=()=>i,i},t.getPreparedQuery=function(){var n={rxQuery:this,mangoQuery:os(this.collection.schema.jsonSchema,this.mangoQuery)};n.mangoQuery.selector._deleted={$eq:!1},n.mangoQuery.index&&n.mangoQuery.index.unshift("_deleted"),vr("prePrepareQuery",n);var i=Sc(this.collection.schema.jsonSchema,n.mangoQuery);return this.getPreparedQuery=()=>i,i},t.doesDocumentDataMatch=function(n){return n._deleted?!1:this.queryMatcher(n)},t.remove=function(){return this.exec().then(n=>Array.isArray(n)?Promise.all(n.map(i=>i.remove())):n.remove())},t.incrementalRemove=function(){return zi(this.asRxQuery,n=>n.incrementalRemove())},t.update=function(n){throw et("update")},t.patch=function(n){return zi(this.asRxQuery,i=>i.patch(n))},t.incrementalPatch=function(n){return zi(this.asRxQuery,i=>i.incrementalPatch(n))},t.modify=function(n){return zi(this.asRxQuery,i=>i.modify(n))},t.incrementalModify=function(n){return zi(this.asRxQuery,i=>i.incrementalModify(n))},t.where=function(n){throw et("query-builder")},t.sort=function(n){throw et("query-builder")},t.skip=function(n){throw et("query-builder")},t.limit=function(n){throw et("query-builder")},zn(e,[{key:"$",get:function(){if(!this._$){var r=this.collection.$.pipe(tt(n=>!n.isLocal),Rs(null),cn(()=>sp(this)),wt(()=>this._result),Ts(xs),is((n,i)=>!!(n&&n.time===ze(i).time)),tt(n=>!!n),wt(n=>ze(n).getValue()));this._$=RE(r,this.refCount$.pipe(tt(()=>!1)))}return this._$}},{key:"$$",get:function(){var r=this.collection.database.getReactivityFactory();return r.fromObservable(this.$,void 0,this.collection.database)}},{key:"queryMatcher",get:function(){var r=this.collection.schema.jsonSchema,n=os(this.collection.schema.jsonSchema,this.mangoQuery);return tn(this,"queryMatcher",wf(r,n))}},{key:"asRxQuery",get:function(){return this}}])})();function No(){return{selector:{}}}function US(e){return e.collection._queryCache.getByQuery(e)}function Ui(e,t,r,n){vr("preCreateRxQuery",{op:e,queryObj:t,collection:r,other:n});var i=new bv(e,t,r,n);return i=US(i),DS(r),i}function Ev(e){var t=e.asRxQuery.collection._changeEventBuffer.getCounter();return e._latestChangeEvent>=t}async function sp(e){return e.collection.awaitBeforeReads.size>0&&await Promise.all(Array.from(e.collection.awaitBeforeReads).map(t=>t())),e.collection.database.destroyed||Ev(e)?!1:(e._ensureEqualQueue=e._ensureEqualQueue.then(()=>qS(e)),e._ensureEqualQueue)}function qS(e){if(e._lastEnsureEqual=Tt(),e.collection.database.destroyed||Ev(e))return Tr;var t=!1,r=!1;if(e._latestChangeEvent===-1&&(r=!0),!r){var n=e.asRxQuery.collection._changeEventBuffer.getFrom(e._latestChangeEvent+1);if(n===null)r=!0;else{e._latestChangeEvent=e.asRxQuery.collection._changeEventBuffer.getCounter();var i=e.asRxQuery.collection._changeEventBuffer.reduceByLastOfDoc(n);if(e.op==="count"){var a=ze(e._result).count,s=a;i.forEach(c=>{var u=c.previousDocumentData&&e.doesDocumentDataMatch(c.previousDocumentData),d=e.doesDocumentDataMatch(c.documentData);!u&&d&&s++,u&&!d&&s--}),s!==a&&(t=!0,e._setResultData(s))}else{var o=TS(e,i);o.runFullQueryAgain?r=!0:o.changed&&(t=!0,e._setResultData(o.newResults))}}}return r?e._execOverDatabase().then(c=>(e._latestChangeEvent=e.collection._changeEventBuffer.getCounter(),typeof c=="number"?((!e._result||c!==e._result.count)&&(t=!0,e._setResultData(c)),t):((!e._result||!zb(e.collection.schema.primaryPath,c,e._result.docsData))&&(t=!0,e._setResultData(c)),t))):Promise.resolve(t)}function Sc(e,t){if(!t.sort)throw ye("SNH",{query:t});var r=vx(e,t);return{query:t,queryPlan:r}}async function HS(e){var t=[],r=e.collection;if(e.isFindOneByIdQuery)if(Array.isArray(e.isFindOneByIdQuery)){var n=e.isFindOneByIdQuery;if(n=n.filter(d=>{var h=e.collection._docCache.getLatestDocumentDataIfExists(d);return h?(h._deleted||t.push(h),!1):!0}),n.length>0){var i=await r.storageInstance.findDocumentsById(n,!1);mi(t,i)}}else{var a=e.isFindOneByIdQuery,s=e.collection._docCache.getLatestDocumentDataIfExists(a);if(!s){var o=await r.storageInstance.findDocumentsById([a],!1);o[0]&&(s=o[0])}s&&!s._deleted&&t.push(s)}else{var c=e.getPreparedQuery(),u=await r.storageInstance.query(c);t=u.documents}return t}function KS(e,t){if(!t.skip&&t.selector&&Object.keys(t.selector).length===1&&t.selector[e]){var r=t.selector[e];if(typeof r=="string")return r;if(Object.keys(r).length===1&&typeof r.$eq=="string"||Object.keys(r).length===1&&Array.isArray(r.$eq)&&!r.$eq.find(n=>typeof n!="string"))return r.$eq}return!1}var GS="_rxdb_internal";async function Cs(e,t){var r=await e.findDocumentsById([t],!1),n=r[0];if(n)return n}async function cs(e,t,r){var n=await e.bulkWrite([t],r);if(n.error.length>0){var i=n.error[0];throw i}else{var a=cr(e.schema.primaryKey),s=sr(a,[t],n),o=s[0];return o}}function WS(e,t){var r=Cs(e,t),n=e.changeStream().pipe(wt(i=>i.events.find(a=>a.documentId===t)),tt(i=>!!i),wt(i=>Promise.resolve(ze(i).documentData)),Rs(r),OE(i=>i),tt(i=>!!i));return n}function us(e){return Object.assign({},...e)}function Vo(e,t,r,n){if(n)throw n.status===409?ye("CONFLICT",{collection:e.name,id:t,writeError:n,data:r}):n.status===422?ye("VD2",{collection:e.name,id:t,writeError:n,data:r}):n}function VS(e,t,r,n,i,a,s){for(var o=!!e.schema.attachments,c=[],u=[],d=[],h=Es(10),p={id:h,events:[],checkpoint:null,context:i,startTime:Tt(),endTime:0},y=p.events,g=[],w=[],b=[],S=r.size>0,O,T=n.length,z=function(){var G=n[B],q=G.document,K=G.previous,Oe=q[t],Le=q._deleted,qe=K&&K._deleted,$e=void 0;S&&($e=r.get(Oe));var Ve;if($e){var fe=$e._rev;if(!K||K&&fe!==K._rev){var Q={isError:!0,status:409,documentId:Oe,writeRow:G,documentInDb:$e};return d.push(Q),1}var te=o?$u(G):G;o&&(Le?K&&Object.keys(K._attachments).forEach(Te=>{w.push({documentId:Oe,attachmentId:Te,digest:ze(K)._attachments[Te].digest})}):(Object.entries(q._attachments).find(([Te,Ge])=>{var je=K?K._attachments[Te]:void 0;return!je&&!Ge.data&&(Ve={documentId:Oe,documentInDb:$e,isError:!0,status:510,writeRow:G,attachmentId:Te}),!0}),Ve||Object.entries(q._attachments).forEach(([Te,Ge])=>{var je=K?K._attachments[Te]:void 0;if(!je)g.push({documentId:Oe,attachmentId:Te,attachmentData:Ge,digest:Ge.digest});else{var _t=te.document._attachments[Te].digest;Ge.data&&je.digest!==_t&&b.push({documentId:Oe,attachmentId:Te,attachmentData:Ge,digest:Ge.digest})}}))),Ve?d.push(Ve):(o?u.push($u(te)):u.push(te),O=te);var Y=null,re=null,xe=null;if(qe&&!Le)xe="INSERT",Y=o?zr(q):q;else if(K&&!qe&&!Le)xe="UPDATE",Y=o?zr(q):q,re=K;else if(Le)xe="DELETE",Y=ze(q),re=K;else throw ye("SNH",{args:{writeRow:G}});var Re={documentId:Oe,documentData:Y,previousDocumentData:re,operation:xe};y.push(Re)}else{var Z=!!Le;if(o&&Object.entries(q._attachments).forEach(([Te,Ge])=>{Ge.data?g.push({documentId:Oe,attachmentId:Te,attachmentData:Ge,digest:Ge.digest}):(Ve={documentId:Oe,isError:!0,status:510,writeRow:G,attachmentId:Te},d.push(Ve))}),Ve||(o?c.push($u(G)):c.push(G),O=G),!Z){var H={documentId:Oe,operation:"INSERT",documentData:o?zr(q):q,previousDocumentData:o&&K?zr(K):K};y.push(H)}}},B=0;B<T;B++)z();return{bulkInsertDocs:c,bulkUpdateDocs:u,newestRow:O,errors:d,eventBulk:p,attachmentsAdd:g,attachmentsRemove:w,attachmentsUpdate:b}}function $u(e){return{previous:e.previous,document:zr(e.document)}}function ZS(e){return atob(e).length}function JS(e){var t=e.data;if(!t)return e;var r={length:ZS(t),digest:e.digest,type:e.type};return r}function zr(e){if(!e._attachments||Object.keys(e._attachments).length===0)return e;var t=it(e);return t._attachments={},Object.entries(e._attachments).forEach(([r,n])=>{t._attachments[r]=JS(n)}),t}function Ps(e){return Object.assign({},e,{_meta:it(e._meta)})}var xv=new WeakMap;function bf(e,t,r){rt.deepFreezeWhenDevMode(r);var n=cr(t.schema.primaryKey),i={originalStorageInstance:t,schema:t.schema,internals:t.internals,collectionName:t.collectionName,databaseName:t.databaseName,options:t.options,bulkWrite(a,s){for(var o=e.token,c=new Array(a.length),u=Tt(),d=0;d<a.length;d++){var h=a[d],p=Ps(h.document);p._meta.lwt=u;var y=h.previous;p._rev=an(o,y),c[d]={document:p,previous:y}}return vr("preStorageWrite",{storageInstance:this.originalStorageInstance,rows:c}),e.lockedRun(()=>t.bulkWrite(c,s)).then(g=>{var w={error:[]},b=sr(n,c,g);xv.set(w,b);var S=g.error.length===0?[]:g.error.filter(T=>T.status===409&&!T.writeRow.previous&&!T.writeRow.document._deleted&&ze(T.documentInDb)._deleted?!0:(w.error.push(T),!1));if(S.length>0){var O=S.map(T=>({previous:T.documentInDb,document:Object.assign({},T.writeRow.document,{_rev:an(e.token,T.documentInDb)})}));return e.lockedRun(()=>t.bulkWrite(O,s)).then(T=>{mi(w.error,T.error);var z=sr(n,O,T);return mi(b,z),w})}return w})},query(a){return e.lockedRun(()=>t.query(a))},count(a){return e.lockedRun(()=>t.count(a))},findDocumentsById(a,s){return e.lockedRun(()=>t.findDocumentsById(a,s))},getAttachmentData(a,s,o){return e.lockedRun(()=>t.getAttachmentData(a,s,o))},getChangedDocumentsSince:t.getChangedDocumentsSince?(a,s)=>e.lockedRun(()=>t.getChangedDocumentsSince(ze(a),s)):void 0,cleanup(a){return e.lockedRun(()=>t.cleanup(a))},remove(){return e.storageInstances.delete(i),e.lockedRun(()=>t.remove())},close(){return e.storageInstances.delete(i),e.lockedRun(()=>t.close())},changeStream(){return t.changeStream()},conflictResultionTasks(){return t.conflictResultionTasks()},resolveConflictResultionTask(a){if(a.output.isEqual)return t.resolveConflictResultionTask(a);var s=Object.assign({},a.output.documentData,{_meta:xi(),_rev:yr(),_attachments:{}}),o=it(s);return delete o._meta,delete o._rev,delete o._attachments,t.resolveConflictResultionTask({id:a.id,output:{isEqual:!1,documentData:o}})}};return e.storageInstances.add(i),i}function QS(e){if(e.schema.keyCompression)throw ye("UT5",{args:{params:e}});if(gd(e.schema))throw ye("UT6",{args:{params:e}});if(e.schema.attachments&&e.schema.attachments.compression)throw ye("UT7",{args:{params:e}})}function gd(e){return!!(e.encrypted&&e.encrypted.length>0||e.attachments&&e.attachments.encrypted)}function YS(e,t,r){var n=cr(e.schema.primaryKey),i=r?r.lwt:Xd,a=r?r.id:"";return os(e.schema,{selector:{$or:[{"_meta.lwt":{$gt:i}},{"_meta.lwt":{$eq:i},[n]:{$gt:r?a:""}}],"_meta.lwt":{$gte:i}},sort:[{"_meta.lwt":"asc"},{[n]:"asc"}],skip:0,limit:t})}async function Sv(e,t,r){if(e.getChangedDocumentsSince)return e.getChangedDocumentsSince(t,r);var n=cr(e.schema.primaryKey),i=Sc(e.schema,YS(e,t,r)),a=await e.query(i),s=a.documents,o=Nb(s);return{documents:s,checkpoint:o?{id:o[n],lwt:o._meta.lwt}:r||{id:"",lwt:0}}}function sr(e,t,r){var n=xv.get(r);if(n)return n;var i=[];if(r.error.length>0){for(var a=new Set,s=0;s<r.error.length;s++){var o=r.error[s];a.add(o.documentId)}for(var c=0;c<t.length;c++){var u=t[c].document;a.has(u[e])||i.push(zr(u))}}else{i.length=t.length-r.error.length;for(var d=0;d<t.length;d++){var h=t[d].document;i[d]=zr(h)}}return i}var kv=(function(){function e(r,n,i,a){this.queueByDocId=new Map,this.isRunning=!1,this.storageInstance=r,this.primaryPath=n,this.preWrite=i,this.postWrite=a}var t=e.prototype;return t.addWrite=function(n,i){var a=n[this.primaryPath],s=sn(this.queueByDocId,a,()=>[]),o=new Promise((c,u)=>{var d={lastKnownDocumentState:n,modifier:i,resolve:c,reject:u};ze(s).push(d),this.triggerRun()});return o},t.triggerRun=async function(){if(!(this.isRunning===!0||this.queueByDocId.size===0)){this.isRunning=!0;var n=[],i=this.queueByDocId;this.queueByDocId=new Map,await Promise.all(Array.from(i.entries()).map(async([s,o])=>{var c=XS(o.map(h=>h.lastKnownDocumentState)),u=c;for(var d of o)try{u=await d.modifier(zt(u))}catch(h){d.reject(h),d.reject=()=>{},d.resolve=()=>{}}try{await this.preWrite(u,c)}catch(h){o.forEach(p=>p.reject(h));return}n.push({previous:c,document:u})}));var a=n.length>0?await this.storageInstance.bulkWrite(n,"incremental-write"):{error:[]};return await Promise.all(sr(this.primaryPath,n,a).map(s=>{var o=s[this.primaryPath];this.postWrite(s);var c=gi(i,o);c.forEach(u=>u.resolve(s))})),a.error.forEach(s=>{var o=s.documentId,c=gi(i,o),u=_c(s);if(u){var d=sn(this.queueByDocId,o,()=>[]);c.reverse().forEach(p=>{p.lastKnownDocumentState=ze(u.documentInDb),ze(d).unshift(p)})}else{var h=b0(s);c.forEach(p=>p.reject(h))}}),this.isRunning=!1,this.triggerRun()}},e})();function op(e){var t=async r=>{var n=Bb(r);n._deleted=r._deleted;var i=await e(n),a=Object.assign({},i,{_meta:r._meta,_attachments:r._attachments,_rev:r._rev,_deleted:typeof i._deleted<"u"?i._deleted:r._deleted});return typeof a._deleted>"u"&&(a._deleted=!1),a};return t}function XS(e){var t=e[0],r=Dn(t._rev);return e.forEach(n=>{var i=Dn(n._rev);i>r&&(t=n,r=i)}),t}var kc={get primaryPath(){var e=this;if(e.isInstanceOfRxDocument)return e.collection.schema.primaryPath},get primary(){var e=this;if(e.isInstanceOfRxDocument)return e._data[e.primaryPath]},get revision(){var e=this;if(e.isInstanceOfRxDocument)return e._data._rev},get deleted$(){var e=this;if(e.isInstanceOfRxDocument)return e.$.pipe(wt(t=>t._data._deleted))},get deleted$$(){var e=this,t=e.collection.database.getReactivityFactory();return t.fromObservable(e.deleted$,e.getLatest().deleted,e.collection.database)},get deleted(){var e=this;if(e.isInstanceOfRxDocument)return e._data._deleted},getLatest(){var e=this.collection._docCache.getLatestDocumentData(this.primary);return this.collection._docCache.getCachedRxDocument(e)},get $(){var e=this;return e.collection.$.pipe(tt(t=>!t.isLocal),tt(t=>t.documentId===this.primary),wt(t=>My(t)),Rs(e.collection._docCache.getLatestDocumentData(this.primary)),is((t,r)=>t._rev===r._rev),wt(t=>this.collection._docCache.getCachedRxDocument(t)),Ts(xs))},get $$(){var e=this,t=e.collection.database.getReactivityFactory();return t.fromObservable(e.$,e.getLatest()._data,e.collection.database)},get$(e){if(rt.isDevMode()){if(e.includes(".item."))throw ye("DOC1",{path:e});if(e===this.primaryPath)throw ye("DOC2");if(this.collection.schema.finalFields.includes(e))throw ye("DOC3",{path:e});var t=Xi(this.collection.schema.jsonSchema,e);if(!t)throw ye("DOC4",{path:e})}return this.$.pipe(wt(r=>Mn(r,e)),is())},get$$(e){var t=this.get$(e),r=this.collection.database.getReactivityFactory();return r.fromObservable(t,this.getLatest().get(e),this.collection.database)},populate(e){var t=Xi(this.collection.schema.jsonSchema,e),r=this.get(e);if(!r)return ef;if(!t)throw ye("DOC5",{path:e});if(!t.ref)throw ye("DOC6",{path:e,schemaObj:t});var n=this.collection.database.collections[t.ref];if(!n)throw ye("DOC7",{ref:t.ref,path:e,schemaObj:t});return t.type==="array"?n.findByIds(r).exec().then(i=>{var a=i.values();return Array.from(a)}):n.findOne(r).exec()},get(e){return Tv(this,e)},toJSON(e=!1){if(e)return rt.deepFreezeWhenDevMode(this._data);var t=it(this._data);return delete t._rev,delete t._attachments,delete t._deleted,delete t._meta,rt.deepFreezeWhenDevMode(t)},toMutableJSON(e=!1){return zt(this.toJSON(e))},update(e){throw et("update")},incrementalUpdate(e){throw et("update")},updateCRDT(e){throw et("crdt")},putAttachment(){throw et("attachments")},getAttachment(){throw et("attachments")},allAttachments(){throw et("attachments")},get allAttachments$(){throw et("attachments")},async modify(e,t){var r=this._data,n=await op(e)(r);return this._saveData(n,r)},incrementalModify(e,t){return this.collection.incrementalWriteQueue.addWrite(this._data,op(e)).then(r=>this.collection._docCache.getCachedRxDocument(r))},patch(e){var t=this._data,r=zt(t);return Object.entries(e).forEach(([n,i])=>{r[n]=i}),this._saveData(r,t)},incrementalPatch(e){return this.incrementalModify(t=>(Object.entries(e).forEach(([r,n])=>{t[r]=n}),t))},async _saveData(e,t){if(e=it(e),this._data._deleted)throw ye("DOC11",{id:this.primary,document:this});await Ov(this.collection,e,t);var r=[{previous:t,document:e}],n=await this.collection.storageInstance.bulkWrite(r,"rx-document-save-data"),i=n.error[0];return Vo(this.collection,this.primary,e,i),await this.collection._runHooks("post","save",e,this),this.collection._docCache.getCachedRxDocument(sr(this.collection.schema.primaryPath,r,n)[0])},remove(){var e=this.collection;if(this.deleted)return Promise.reject(ye("DOC13",{document:this,id:this.primary}));var t=it(this._data),r;return e._runHooks("pre","remove",t,this).then(async()=>{t._deleted=!0;var n=[{previous:this._data,document:t}],i=await e.storageInstance.bulkWrite(n,"rx-document-remove"),a=i.error[0];return Vo(e,this.primary,t,a),sr(this.collection.schema.primaryPath,n,i)[0]}).then(n=>(r=n,this.collection._runHooks("post","remove",t,this))).then(()=>this.collection._docCache.getCachedRxDocument(r))},incrementalRemove(){return this.incrementalModify(async e=>(await this.collection._runHooks("pre","remove",e,this),e._deleted=!0,e)).then(async e=>(await this.collection._runHooks("post","remove",e._data,e),e))},destroy(){throw ye("DOC14")}};function Iv(e=kc){var t=function(n,i){this.collection=n,this._data=i,this._propertyCache=new Map,this.isInstanceOfRxDocument=!0};return t.prototype=e,t}function ek(e,t,r){var n=new e(t,r);return vr("createRxDocument",n),n}function Ov(e,t,r){return t._meta=Object.assign({},r._meta,t._meta),rt.isDevMode()&&e.schema.validateChange(r,t),e._runHooks("pre","save",t,r)}function Tv(e,t){return sn(e._propertyCache,t,()=>{var r=Mn(e._data,t);if(typeof r!="object"||r===null||Array.isArray(r))return rt.deepFreezeWhenDevMode(r);var n=new Proxy(it(r),{get(i,a){if(typeof a!="string")return i[a];var s=a.charAt(a.length-1);if(s==="$")if(a.endsWith("$$")){var o=a.slice(0,-2);return e.get$$(ja(t+"."+o))}else{var c=a.slice(0,-1);return e.get$(ja(t+"."+c))}else if(s==="_"){var u=a.slice(0,-1);return e.populate(ja(t+"."+u))}else{var d=i[a];return typeof d=="number"||typeof d=="string"||typeof d=="boolean"?d:Tv(e,ja(t+"."+a))}}});return n})}var li="collection",Ef="storage-token",Do="rx-migration-status",tk="RxInternalDocument",xf=wc({version:0,title:tk,primaryKey:{key:"id",fields:["context","key"],separator:"|"},type:"object",properties:{id:{type:"string",maxLength:200},key:{type:"string"},context:{type:"string",enum:[li,Ef,Do,"OTHER"]},data:{type:"object",additionalProperties:!0}},indexes:[],required:["key","context","data"],additionalProperties:!1,sharding:{shards:1,mode:"collection"}});function sa(e,t){return Si(xf,{key:e,context:t})}async function Rv(e){var t=Sc(e.schema,{selector:{context:li,_deleted:{$eq:!1}},sort:[{id:"asc"}],skip:0}),r=await e.query(t),n=r.documents;return n}var Av="storageToken",rk=sa(Av,Ef);async function nk(e){var t=Es(10),r=e.password?await e.hashFunction(JSON.stringify(e.password)):void 0,n={id:rk,context:Ef,key:Av,data:{rxdbVersion:e.rxdbVersion,token:t,instanceToken:e.token,passwordHash:r},_deleted:!1,_meta:xi(),_rev:yr(),_attachments:{}},i=[{document:n}],a=await e.internalStore.bulkWrite(i,"internal-add-storage-token");if(!a.error[0])return sr("id",i,a)[0];var s=ze(a.error[0]);if(s.isError&&_c(s)){var o=s;if(!ik(o.documentInDb.data.rxdbVersion,e.rxdbVersion))throw ye("DM5",{args:{database:e.name,databaseStateVersion:o.documentInDb.data.rxdbVersion,codeVersion:e.rxdbVersion}});if(r&&r!==o.documentInDb.data.passwordHash)throw ye("DB1",{passwordHash:r,existingPasswordHash:o.documentInDb.data.passwordHash});var c=o.documentInDb;return ze(c)}throw s}function ik(e,t){if(!e||t.includes("beta")&&t!==e)return!1;var r=e.split(".")[0],n=t.split(".")[0];return r===n}async function ak(e,t,r){if(e.schema.version!==r.version)throw ye("SNH",{schema:r,version:e.schema.version,name:e.name,collection:e,args:{storageCollectionName:t}});for(var n=yd(e.name,e.schema.jsonSchema),i=sa(n,li);;){var a=await Cs(e.database.internalStore,i),s=zt(ze(a)),o=s.data.connectedStorages.find(c=>c.collectionName===t&&c.schema.version===r.version);if(o)return;s.data.connectedStorages.push({collectionName:t,schema:r});try{await cs(e.database.internalStore,{previous:ze(a),document:s},"add-connected-storage-to-collection")}catch(c){if(!_c(c))throw c}}}function yd(e,t){return e+"-"+t.version}function po(e,t){return t=it(t),t=O0(e,t),typeof e.jsonSchema.primaryKey!="string"&&(t=E0(e.primaryPath,e.jsonSchema,t)),t._meta=xi(),Object.prototype.hasOwnProperty.call(t,"_deleted")||(t._deleted=!1),Object.prototype.hasOwnProperty.call(t,"_attachments")||(t._attachments={}),Object.prototype.hasOwnProperty.call(t,"_rev")||(t._rev=yr()),t}async function sk(e,t){t.multiInstance=e.multiInstance;var r=await e.storage.createStorageInstance(t);return r}async function $v(e,t,r,n,i,a,s){var o=await Rv(t),c=o.filter(p=>p.data.name===i),u=[];c.forEach(p=>{u.push({collectionName:p.data.name,schema:p.data.schema,isCollection:!0}),p.data.connectedStorages.forEach(y=>u.push({collectionName:y.collectionName,isCollection:!1,schema:y.schema}))});var d=new Set;if(u=u.filter(p=>{var y=p.collectionName+"||"+p.schema.version;return d.has(y)?!1:(d.add(y),!0)}),await Promise.all(u.map(async p=>{var y=await e.createStorageInstance({collectionName:p.collectionName,databaseInstanceToken:r,databaseName:n,multiInstance:!1,options:{},schema:p.schema,password:a,devMode:rt.isDevMode()});await y.remove(),p.isCollection&&await Ss("postRemoveRxCollection",{storage:e,databaseName:n,collectionName:i})})),s){var h=c.map(p=>{var y=Ps(p);return y._deleted=!0,y._meta.lwt=Tt(),y._rev=an(r,p),{previous:p,document:y}});await t.bulkWrite(h,"rx-database-remove-collection-all")}}function pr(e){if(e.destroyed)throw ye("COL21",{collection:e.name,version:e.schema.version})}var ok=(function(){function e(r){this.subs=[],this.counter=0,this.eventCounterMap=new WeakMap,this.buffer=[],this.limit=100,this.tasks=new Set,this.collection=r,this.subs.push(this.collection.database.eventBulks$.pipe(tt(n=>n.collectionName===this.collection.name),tt(n=>{var i=n.events[0];return!i.isLocal})).subscribe(n=>{this.tasks.add(()=>this._handleChangeEvents(n.events)),this.tasks.size<=1&&vc().then(()=>{this.processTasks()})}))}var t=e.prototype;return t.processTasks=function(){if(this.tasks.size!==0){var n=Array.from(this.tasks);n.forEach(i=>i()),this.tasks.clear()}},t._handleChangeEvents=function(n){var i=this.counter;this.counter=this.counter+n.length,n.length>this.limit?this.buffer=n.slice(n.length*-1):(mi(this.buffer,n),this.buffer=this.buffer.slice(this.limit*-1));for(var a=i+1,s=this.eventCounterMap,o=0;o<n.length;o++){var c=n[o];s.set(c,a+o)}},t.getCounter=function(){return this.processTasks(),this.counter},t.getBuffer=function(){return this.processTasks(),this.buffer},t.getArrayIndexByPointer=function(n){this.processTasks();var i=this.buffer[0],a=this.eventCounterMap.get(i);if(n<a)return null;var s=n-a;return s},t.getFrom=function(n){this.processTasks();var i=[],a=this.getArrayIndexByPointer(n);if(a===null)return null;for(;;){var s=this.buffer[a];if(a++,s)i.push(s);else return i}},t.runFrom=function(n,i){this.processTasks();var a=this.getFrom(n);if(a===null)throw new Error("out of bounds");a.forEach(s=>i(s))},t.reduceByLastOfDoc=function(n){return this.processTasks(),n.slice(0)},t.destroy=function(){this.tasks.clear(),this.subs.forEach(n=>n.unsubscribe())},e})();function ck(e){return new ok(e)}var uk=new WeakMap;function lk(e){var t=e.schema.getDocumentPrototype(),r=hk(e),n=kc,i={};return[t,r,n].forEach(a=>{var s=Object.getOwnPropertyNames(a);s.forEach(o=>{var c=Object.getOwnPropertyDescriptor(a,o),u=!0;(o.startsWith("_")||o.endsWith("_")||o.startsWith("$")||o.endsWith("$"))&&(u=!1),typeof c.value=="function"?Object.defineProperty(i,o,{get(){return c.value.bind(this)},enumerable:u,configurable:!1}):(c.enumerable=u,c.configurable=!1,c.writable&&(c.writable=!1),Object.defineProperty(i,o,c))})}),i}function dk(e){return sn(uk,e,()=>Iv(lk(e)))}function fk(e,t,r){var n=ek(t,e,rt.deepFreezeWhenDevMode(r));return e._runHooksSync("post","create",r,n),vr("postCreateRxDocument",n),n}function hk(e){var t={};return Object.entries(e.methods).forEach(([r,n])=>{t[r]=n}),t}async function Zo(e,t){var r=Si(e.input.metaInstance.schema,{isCheckpoint:"1",itemId:t}),n=await e.input.metaInstance.findDocumentsById([r],!1),i=n[0];if(e.lastCheckpointDoc[t]=i,i)return i.checkpointData}async function Jo(e,t,r){e.checkpointQueue=e.checkpointQueue.then(async()=>{var n=e.lastCheckpointDoc[t];if(r&&!e.events.canceled.getValue()&&(!n||JSON.stringify(n.checkpointData)!==JSON.stringify(r))){var i={id:"",isCheckpoint:"1",itemId:t,_deleted:!1,_attachments:{},checkpointData:r,_meta:xi(),_rev:yr()};for(i.id=Si(e.input.metaInstance.schema,i);!e.events.canceled.getValue();){if(n&&(i.checkpointData=us([n.checkpointData,i.checkpointData])),i._meta.lwt=Tt(),i._rev=an(await e.checkpointKey,n),e.events.canceled.getValue())return;var a=[{previous:n,document:i}],s=await e.input.metaInstance.bulkWrite(a,"replication-set-checkpoint"),o=sr(e.primaryPath,a,s)[0];if(o){e.lastCheckpointDoc[t]=o;return}else{var c=s.error[0];if(c.status!==409)throw c;n=ze(c.documentInDb),i._rev=an(await e.checkpointKey,n)}}}}),await e.checkpointQueue}async function pk(e){var t=await e.hashFunction([e.identifier,e.forkInstance.databaseName,e.forkInstance.collectionName].join("||"));return"rx_storage_replication_"+t}function cp(e,t,r,n,i){var a=Object.assign({},n,{_attachments:t&&n._attachments?n._attachments:{},_meta:r?n._meta:Object.assign({},i?i._meta:{},{lwt:Tt()}),_rev:r?n._rev:yr()});return a._rev||(a._rev=an(e,i)),a}function On(e,t,r){var n=it(e);return t||delete n._attachments,r||(delete n._meta,delete n._rev),n}function vd(e,t){return e.hasAttachments?t.map(r=>{var n=zt(r.document);return n.docData=zr(n.docData),{document:n,previous:r.previous}}):t}function _d(e){for(;;)if(e.underlyingPersistentStorage)e=e.underlyingPersistentStorage;else return e}var Mo="RxReplicationProtocolMetaData";function up(e,t){var r=x0(e),n={title:Mo,primaryKey:{key:"id",fields:["itemId","isCheckpoint"],separator:"|"},type:"object",version:e.version,additionalProperties:!1,properties:{id:{type:"string",minLength:1,maxLength:r+2},isCheckpoint:{type:"string",enum:["0","1"],minLength:1,maxLength:1},itemId:{type:"string",maxLength:r>4?r:4},checkpointData:{type:"object",additionalProperties:!0},docData:{type:"object",properties:e.properties},isResolvedConflict:{type:"string"}},keyCompression:e.keyCompression,required:["id","isCheckpoint","itemId"]};t&&(n.encrypted=["docData"]);var i=wc(n);return i}function Cv(e,t){return e.input.metaInstance.findDocumentsById(t.map(r=>{var n=Si(e.input.metaInstance.schema,{itemId:r,isCheckpoint:"0"});return n}),!0).then(r=>{var n={};return Object.values(r).forEach(i=>{n[i.itemId]={docData:i.docData,metaDocument:i}}),n})}async function Qo(e,t,r,n){var i=t[e.primaryPath],a=r?Ps(r):{id:"",isCheckpoint:"0",itemId:i,docData:t,_attachments:{},_deleted:!1,_rev:yr(),_meta:{lwt:0}};a.docData=t,n&&(a.isResolvedConflict=n),a._meta.lwt=Tt(),a.id=Si(e.input.metaInstance.schema,a),a._rev=an(await e.checkpointKey,r);var s={previous:r,document:a};return s}async function mk(e){if(e.input.initialCheckpoint&&e.input.initialCheckpoint.downstream){var t=await Zo(e,"down");t||await Jo(e,"down",e.input.initialCheckpoint.downstream)}var r=await e.input.hashFunction(e.input.identifier),n=e.input.replicationHandler,i=0,a=[];function s(g){e.stats.down.addNewTask=e.stats.down.addNewTask+1;var w={time:i++,task:g};a.push(w),e.streamQueue.down=e.streamQueue.down.then(()=>{for(var b=[];a.length>0;){e.events.active.down.next(!0);var S=ze(a.shift());if(!(S.time<c)){if(S.task==="RESYNC")if(b.length===0){b.push(S.task);break}else break;b.push(S.task)}}if(b.length!==0)return b[0]==="RESYNC"?u():d(b)}).then(()=>{e.events.active.down.next(!1),!e.firstSyncDone.down.getValue()&&!e.events.canceled.getValue()&&e.firstSyncDone.down.next(!0)})}if(s("RESYNC"),!e.events.canceled.getValue()){var o=n.masterChangeStream$.pipe(cn(async g=>(await oi(e.events.active.up.pipe(tt(w=>!w))),g))).subscribe(g=>{e.stats.down.masterChangeStreamEmit=e.stats.down.masterChangeStreamEmit+1,s(g)});oi(e.events.canceled.pipe(tt(g=>!!g))).then(()=>o.unsubscribe())}var c=-1;async function u(){if(e.stats.down.downstreamResyncOnce=e.stats.down.downstreamResyncOnce+1,!e.events.canceled.getValue()){e.checkpointQueue=e.checkpointQueue.then(()=>Zo(e,"down"));for(var g=await e.checkpointQueue,w=[];!e.events.canceled.getValue();){c=i++;var b=await n.masterChangesSince(g,e.input.pullBatchSize);if(b.documents.length===0||(g=us([g,b.checkpoint]),w.push(y(b.documents,g)),b.documents.length<e.input.pullBatchSize))break}await Promise.all(w)}}function d(g){e.stats.down.downstreamProcessChanges=e.stats.down.downstreamProcessChanges+1;var w=[],b=null;return g.forEach(S=>{if(S==="RESYNC")throw new Error("SNH");mi(w,S.documents),b=us([b,S.checkpoint])}),y(w,ze(b))}var h=gr,p={docs:{}};function y(g,w){var b=e.primaryPath;return e.stats.down.persistFromMaster=e.stats.down.persistFromMaster+1,g.forEach(S=>{var O=S[b];p.docs[O]=S}),p.checkpoint=w,h=h.then(()=>{var S=p.docs;p.docs={};var O=p.checkpoint,T=Object.keys(S);if(e.events.canceled.getValue()||T.length===0)return gr;var z=[],B={},G={},q=[];return Promise.all([e.input.forkInstance.findDocumentsById(T,!0),Cv(e,T)]).then(([K,Oe])=>{var Le=new Map;return K.forEach(qe=>Le.set(qe[b],qe)),Promise.all(T.map(async qe=>{var $e=Le.get(qe),Ve=$e?On($e,e.hasAttachments,!1):void 0,Z=S[qe],H=Oe[qe];H&&$e&&H.metaDocument.isResolvedConflict===$e._rev&&await e.streamQueue.up;var fe=!H||!Ve?!1:await e.input.conflictHandler({realMasterState:H.docData,newDocumentState:Ve},"downstream-check-if-equal-0").then(xe=>xe.isEqual);if(!fe&&H&&H.docData._rev&&$e&&$e._meta[e.input.identifier]&&Dn($e._rev)===$e._meta[e.input.identifier]&&(fe=!0),$e&&H&&fe===!1||$e&&!H)return gr;var Q=Ve?await e.input.conflictHandler({realMasterState:Z,newDocumentState:Ve},"downstream-check-if-equal-1").then(xe=>xe.isEqual):!1;if(Ve&&Q)return(!H||fe===!1)&&q.push(await Qo(e,Ve,H?H.metaDocument:void 0)),gr;var te=Object.assign({},Z,$e?{_meta:it($e._meta),_attachments:e.hasAttachments&&Z._attachments?Z._attachments:{},_rev:yr()}:{_meta:{lwt:Tt()},_rev:yr(),_attachments:e.hasAttachments&&Z._attachments?Z._attachments:{}});if(Z._rev){var Y=$e?Dn($e._rev)+1:1;te._meta[e.input.identifier]=Y,e.input.keepMeta&&(te._rev=Z._rev)}e.input.keepMeta&&Z._meta&&(te._meta=Z._meta);var re={previous:$e,document:te};re.document._rev=re.document._rev?re.document._rev:an(r,re.previous),z.push(re),B[qe]=re,G[qe]=await Qo(e,Z,H?H.metaDocument:void 0)}))}).then(async()=>{if(z.length>0)return e.input.forkInstance.bulkWrite(z,await e.downstreamBulkWriteFlag).then(K=>{var Oe=sr(e.primaryPath,z,K);Oe.forEach(Le=>{var qe=Le[b];e.events.processed.down.next(B[qe]),q.push(G[qe])}),K.error.forEach(Le=>{Le.status!==409&&e.events.error.next(ye("RC_PULL",{writeError:Le}))})})}).then(()=>{if(q.length>0)return e.input.metaInstance.bulkWrite(vd(e,q),"replication-down-write-meta").then(K=>{K.error.forEach(Oe=>{e.events.error.next(ye("RC_PULL",{id:Oe.documentId,writeError:Oe}))})})}).then(()=>{Jo(e,"down",O)})}).catch(S=>e.events.error.next(S)),h}}var Yo=function(e,t){var r=zr(e.newDocumentState),n=zr(e.realMasterState);return ts(r,n)?Promise.resolve({isEqual:!0}):Promise.resolve({isEqual:!1,documentData:e.realMasterState})};async function gk(e,t,r){var n=e.input.conflictHandler,i=await n(t,"replication-resolve-conflict");if(!i.isEqual){var a=Object.assign({},i.documentData,{_meta:it(r._meta),_rev:yr(),_attachments:it(r._attachments)});return a._meta.lwt=Tt(),a._rev=an(await e.checkpointKey,r),{resolvedDoc:a,output:i}}}async function wd(e,t,r,n){if(!r._attachments||n&&!n._attachments)throw new Error("_attachments missing");var i=r[e],a=new Set(n&&n._attachments?Object.keys(n._attachments):[]);return await Promise.all(Object.entries(r._attachments).map(async([s,o])=>{if((!a.has(s)||n&&ze(n._attachments)[s].digest!==o.digest)&&!o.data){var c=await t.getAttachmentData(i,s,o.digest);o.data=c}})),r}async function yk(e){if(e.input.initialCheckpoint&&e.input.initialCheckpoint.upstream){var t=await Zo(e,"up");t||await Jo(e,"up",e.input.initialCheckpoint.upstream)}var r=e.input.replicationHandler;e.streamQueue.up=e.streamQueue.up.then(()=>u().then(()=>{d()}));var n=0,i=-1,a=[],s=Tr,o={docs:{}},c=e.input.forkInstance.changeStream().subscribe(async p=>{if(p.context!==await e.downstreamBulkWriteFlag)return e.stats.up.forkChangeStreamEmit=e.stats.up.forkChangeStreamEmit+1,a.push({task:p,time:n++}),e.events.active.up.getValue()||e.events.active.up.next(!0),e.input.waitBeforePersist?e.input.waitBeforePersist().then(()=>d()):d()});oi(e.events.canceled.pipe(tt(p=>!!p))).then(()=>c.unsubscribe());async function u(){if(e.stats.up.upstreamInitialSync=e.stats.up.upstreamInitialSync+1,!e.events.canceled.getValue()){e.checkpointQueue=e.checkpointQueue.then(()=>Zo(e,"up"));for(var p=await e.checkpointQueue,y=new Set,g=async function(){i=n++,y.size>3&&await Promise.race(Array.from(y));var S=await Sv(e.input.forkInstance,e.input.pushBatchSize,p);if(S.documents.length===0)return 1;p=us([p,S.checkpoint]);var O=h(S.documents,ze(p));y.add(O),O.catch().then(()=>y.delete(O))};!e.events.canceled.getValue()&&!await g(););var w=await Promise.all(y),b=w.find(S=>!!S);b?await u():!e.firstSyncDone.up.getValue()&&!e.events.canceled.getValue()&&e.firstSyncDone.up.next(!0)}}function d(){if(e.events.canceled.getValue()||a.length===0){e.events.active.up.next(!1);return}e.stats.up.processTasks=e.stats.up.processTasks+1,e.events.active.up.next(!0),e.streamQueue.up=e.streamQueue.up.then(()=>{for(var p=[],y={};a.length>0;){var g=ze(a.shift());g.time<i||(mi(p,g.task.events.map(b=>b.documentData)),y=us([y,g.task.checkpoint]))}var w=p.length===0?Tr:h(p,y);return w.then(()=>{a.length===0?e.events.active.up.next(!1):d()})})}function h(p,y){return e.stats.up.persistToMaster=e.stats.up.persistToMaster+1,p.forEach(g=>{var w=g[e.primaryPath];o.docs[w]=g}),o.checkpoint=y,s=s.then(async()=>{if(e.events.canceled.getValue())return!1;var g=o.docs;o.docs={};var w=o.checkpoint,b=Object.keys(g);if(b.length===0)return!1;var S=await Cv(e,b),O={},T=[],z={},B={};if(await Promise.all(b.map(async Q=>{var te=g[Q];B[Q]=te;var Y=On(te,e.hasAttachments,!!e.input.keepMeta),re=S[Q];re&&re.metaDocument.isResolvedConflict!==te._rev&&(await e.input.conflictHandler({realMasterState:re.docData,newDocumentState:Y},"upstream-check-if-equal")).isEqual||re&&re.docData._rev&&Dn(te._rev)===te._meta[e.input.identifier]||(T.push(Q),O[Q]={assumedMasterState:re?re.docData:void 0,newDocumentState:Y},z[Q]=await Qo(e,Y,re?re.metaDocument:void 0))})),T.length===0)return!1;var G=Object.values(O),q=new Set,K={},Oe=Db(G,e.input.pushBatchSize);await Promise.all(Oe.map(async Q=>{e.hasAttachments&&await Promise.all(Q.map(async Y=>{Y.newDocumentState=await wd(e.primaryPath,e.input.forkInstance,zt(Y.newDocumentState),Y.assumedMasterState)}));var te=await r.masterWrite(Q);te.forEach(Y=>{var re=Y[e.primaryPath];q.add(re),K[re]=Y})}));var Le=[];if(T.forEach(Q=>{q.has(Q)||(e.events.processed.up.next(O[Q]),Le.push(z[Q]))}),e.events.canceled.getValue())return!1;Le.length>0&&await e.input.metaInstance.bulkWrite(vd(e,Le),"replication-up-write-meta");var qe=!1;if(q.size>0){e.stats.up.persistToMasterHadConflicts=e.stats.up.persistToMasterHadConflicts+1;var $e=[],Ve={};if(await Promise.all(Object.entries(K).map(([Q,te])=>{var Y=O[Q],re={newDocumentState:Y.newDocumentState,assumedMasterState:Y.assumedMasterState,realMasterState:te};return gk(e,re,B[Q]).then(async xe=>{if(xe){e.events.resolvedConflicts.next({input:re,output:xe.output}),$e.push({previous:B[Q],document:xe.resolvedDoc});var Re=S[Q];Ve[Q]=await Qo(e,ze(te),Re?Re.metaDocument:void 0,xe.resolvedDoc._rev)}})})),$e.length>0){qe=!0,e.stats.up.persistToMasterConflictWrites=e.stats.up.persistToMasterConflictWrites+1;var Z=await e.input.forkInstance.bulkWrite($e,"replication-up-write-conflict"),H=[],fe=sr(e.primaryPath,$e,Z);fe.forEach(Q=>{var te=Q[e.primaryPath];H.push(Ve[te])}),H.length>0&&await e.input.metaInstance.bulkWrite(vd(e,H),"replication-up-write-conflict-meta")}}return Jo(e,"up",w),qe}).catch(g=>(e.events.error.next(g),!1)),s}}function vk(e){e=it(e),e.forkInstance=_d(e.forkInstance),e.metaInstance=_d(e.metaInstance);var t=pk(e),r={primaryPath:cr(e.forkInstance.schema.primaryKey),hasAttachments:!!e.forkInstance.schema.attachments,input:e,checkpointKey:t,downstreamBulkWriteFlag:t.then(n=>"replication-downstream-"+n),events:{canceled:new ii(!1),active:{down:new ii(!0),up:new ii(!0)},processed:{down:new nr,up:new nr},resolvedConflicts:new nr,error:new nr},stats:{down:{addNewTask:0,downstreamProcessChanges:0,downstreamResyncOnce:0,masterChangeStreamEmit:0,persistFromMaster:0},up:{forkChangeStreamEmit:0,persistToMaster:0,persistToMasterConflictWrites:0,persistToMasterHadConflicts:0,processTasks:0,upstreamInitialSync:0}},firstSyncDone:{down:new ii(!1),up:new ii(!1)},streamQueue:{down:gr,up:gr},checkpointQueue:gr,lastCheckpointDoc:{}};return mk(r),yk(r),r}function _k(e){return oi(mE([e.firstSyncDone.down.pipe(tt(t=>!!t)),e.firstSyncDone.up.pipe(tt(t=>!!t))])).then(()=>{})}function wk(e,t,r,n=!1){e=_d(e);var i=!!e.schema.attachments,a=cr(e.schema.primaryKey),s={masterChangeStream$:e.changeStream().pipe(cn(async o=>{var c={checkpoint:o.checkpoint,documents:await Promise.all(o.events.map(async u=>{var d=On(u.documentData,i,n);return i&&(d=await wd(a,e,zt(d),void 0)),d}))};return c})),masterChangesSince(o,c){return Sv(e,c,o).then(async u=>({checkpoint:u.documents.length>0?u.checkpoint:o,documents:await Promise.all(u.documents.map(async d=>{var h=On(d,i,n);return i&&(h=await wd(a,e,zt(h),void 0)),h}))}))},async masterWrite(o){var c={};o.forEach(w=>{var b=w.newDocumentState[a];c[b]=w});var u=Object.keys(c),d=await e.findDocumentsById(u,!0),h=new Map;d.forEach(w=>h.set(w[a],w));var p=[],y=[];if(await Promise.all(Object.entries(c).map(async([w,b])=>{var S=h.get(w);S?S&&!b.assumedMasterState?p.push(On(S,i,n)):(await t({realMasterState:On(S,i,n),newDocumentState:ze(b.assumedMasterState)},"rxStorageInstanceToReplicationHandler-masterWrite")).isEqual===!0?y.push({previous:S,document:cp(r,i,n,b.newDocumentState,S)}):p.push(On(S,i,n)):y.push({document:cp(r,i,n,b.newDocumentState)})})),y.length>0){var g=await e.bulkWrite(y,"replication-master-write");g.error.forEach(w=>{if(w.status!==409)throw new Error("non conflict error");p.push(On(ze(w.documentInDb),i,n))})}return p}};return s}async function bk(e){e.events.canceled.next(!0),e.events.active.up.complete(),e.events.active.down.complete(),e.events.processed.up.complete(),e.events.processed.down.complete(),e.events.resolvedConflicts.complete(),e.events.canceled.complete(),await e.checkpointQueue}var Pv=["pre","post"],Nv=["insert","save","remove","create"],lp=!1,Dv=(function(){function e(r,n,i,a,s={},o={},c={},u={},d={},h=vv,p={},y=Yo){this.storageInstance={},this.timeouts=new Set,this.incrementalWriteQueue={},this.awaitBeforeReads=new Set,this._incrementalUpsertQueues=new Map,this.synced=!1,this.hooks={},this._subs=[],this._docCache={},this._queryCache=AS(),this.$={},this.checkpoint$={},this._changeEventBuffer={},this.onDestroy=[],this.destroyed=!1,this.onRemove=[],this.database=r,this.name=n,this.schema=i,this.internalStorageInstance=a,this.instanceCreationOptions=s,this.migrationStrategies=o,this.methods=c,this.attachments=u,this.options=d,this.cacheReplacementPolicy=h,this.statics=p,this.conflictHandler=y,Ek(this.asRxCollection)}var t=e.prototype;return t.prepare=async function(){this.storageInstance=bf(this.database,this.internalStorageInstance,this.schema.jsonSchema),this.incrementalWriteQueue=new kv(this.storageInstance,this.schema.primaryPath,(c,u)=>Ov(this,c,u),c=>this._runHooks("post","save",c));var n=this.database.eventBulks$.pipe(tt(c=>c.collectionName===this.name));this.$=n.pipe(cn(c=>c.events)),this.checkpoint$=n.pipe(wt(c=>c.checkpoint)),this._changeEventBuffer=ck(this.asRxCollection);var i;this._docCache=new _v(this.schema.primaryPath,this.database.eventBulks$.pipe(tt(c=>c.collectionName===this.name&&!c.events[0].isLocal),wt(c=>c.events)),c=>(i||(i=dk(this.asRxCollection)),fk(this.asRxCollection,i,c)));var a=this.database.internalStore.changeStream().pipe(tt(c=>{var u=this.name+"-"+this.schema.version,d=c.events.find(h=>h.documentData.context==="collection"&&h.documentData.key===u&&h.operation==="DELETE");return!!d})).subscribe(async()=>{await this.destroy(),await Promise.all(this.onRemove.map(c=>c()))});this._subs.push(a);var s=await this.database.storageToken,o=this.storageInstance.changeStream().subscribe(c=>{for(var u=new Array(c.events.length),d=c.events,h=this.name,p=rt.deepFreezeWhenDevMode,y=0;y<d.length;y++){var g=d[y];u[y]={documentId:g.documentId,collectionName:h,isLocal:!1,operation:g.operation,documentData:p(g.documentData),previousDocumentData:p(g.previousDocumentData)}}var w={id:c.id,internal:!1,collectionName:this.name,storageToken:s,events:u,databaseToken:this.database.token,checkpoint:c.checkpoint,context:c.context,endTime:c.endTime,startTime:c.startTime};this.database.$emit(w)});return this._subs.push(o),this._subs.push(this.storageInstance.conflictResultionTasks().subscribe(c=>{this.conflictHandler(c.input,c.context).then(u=>{this.storageInstance.resolveConflictResultionTask({id:c.id,output:u})})})),gr},t.cleanup=function(n){throw pr(this),et("cleanup")},t.migrationNeeded=function(){throw et("migration-schema")},t.getMigrationState=function(){throw et("migration-schema")},t.startMigration=function(n=10){return pr(this),this.getMigrationState().startMigration(n)},t.migratePromise=function(n=10){return this.getMigrationState().migratePromise(n)},t.insert=async function(n){pr(this);var i=await this.bulkInsert([n]),a=i.error[0];Vo(this,n[this.schema.primaryPath],n,a);var s=ze(i.success[0]);return s},t.bulkInsert=async function(n){if(pr(this),n.length===0)return{success:[],error:[]};var i=this.schema.primaryPath,a=new Set,s;if(this.hasHooks("pre","insert"))s=await Promise.all(n.map(b=>{var S=po(this.schema,b);return this._runHooks("pre","insert",S).then(()=>(a.add(S[i]),{document:S}))}));else{s=new Array(n.length);for(var o=this.schema,c=0;c<n.length;c++){var u=n[c],d=po(o,u);a.add(d[i]),s[c]={document:d}}}if(a.size!==n.length)throw ye("COL22",{collection:this.name,args:{documents:n}});var h=await this.storageInstance.bulkWrite(s,"rx-collection-bulk-insert"),p,y=this,g={get success(){if(!p){var b=sr(y.schema.primaryPath,s,h);p=wv(y._docCache,b)}return p},error:h.error};if(this.hasHooks("post","insert")){var w=new Map;s.forEach(b=>{var S=b.document;w.set(S[i],S)}),await Promise.all(g.success.map(b=>this._runHooks("post","insert",w.get(b.primary),b)))}return g},t.bulkRemove=async function(n){pr(this);var i=this.schema.primaryPath;if(n.length===0)return{success:[],error:[]};var a=await this.findByIds(n).exec(),s=[],o=new Map;Array.from(a.values()).forEach(y=>{var g=y.toMutableJSON(!0);s.push(g),o.set(y.primary,g)}),await Promise.all(s.map(y=>{var g=y[this.schema.primaryPath];return this._runHooks("pre","remove",y,a.get(g))}));var c=s.map(y=>{var g=it(y);return g._deleted=!0,{previous:y,document:g}}),u=await this.storageInstance.bulkWrite(c,"rx-collection-bulk-remove"),d=sr(this.schema.primaryPath,c,u),h=d.map(y=>y[i]);await Promise.all(h.map(y=>this._runHooks("post","remove",o.get(y),a.get(y))));var p=h.map(y=>gi(a,y));return{success:p,error:u.error}},t.bulkUpsert=async function(n){pr(this);var i=[],a=new Map;n.forEach(u=>{var d=po(this.schema,u),h=d[this.schema.primaryPath];if(!h)throw ye("COL3",{primaryPath:this.schema.primaryPath,data:d,schema:this.schema.jsonSchema});a.set(h,d),i.push(d)});var s=await this.bulkInsert(i),o=s.success.slice(0),c=[];return await Promise.all(s.error.map(async u=>{if(u.status!==409)c.push(u);else{var d=u.documentId,h=gi(a,d),p=ze(u.documentInDb),y=this._docCache.getCachedRxDocuments([p])[0],g=await y.incrementalModify(()=>h);o.push(g)}})),{error:c,success:o}},t.upsert=async function(n){pr(this);var i=await this.bulkUpsert([n]);return Vo(this.asRxCollection,n[this.schema.primaryPath],n,i.error[0]),i.success[0]},t.incrementalUpsert=function(n){pr(this);var i=po(this.schema,n),a=i[this.schema.primaryPath];if(!a)throw ye("COL4",{data:n});var s=this._incrementalUpsertQueues.get(a);return s||(s=gr),s=s.then(()=>Sk(this,a,i)).then(o=>o.inserted?o.doc:xk(o.doc,i)),this._incrementalUpsertQueues.set(a,s),s},t.find=function(n){if(pr(this),typeof n=="string")throw ye("COL5",{queryObj:n});n||(n=No());var i=Ui("find",n,this);return i},t.findOne=function(n){if(pr(this),typeof n=="number"||Array.isArray(n))throw tr("COL6",{queryObj:n});var i;if(typeof n=="string")i=Ui("findOne",{selector:{[this.schema.primaryPath]:n},limit:1},this);else{if(n||(n=No()),n.limit)throw ye("QU6");n=it(n),n.limit=1,i=Ui("findOne",n,this)}return i},t.count=function(n){pr(this),n||(n=No());var i=Ui("count",n,this);return i},t.findByIds=function(n){pr(this);var i={selector:{[this.schema.primaryPath]:{$in:n.slice(0)}}},a=Ui("findByIds",i,this);return a},t.exportJSON=function(){throw et("json-dump")},t.importJSON=function(n){throw et("json-dump")},t.insertCRDT=function(n){throw et("crdt")},t.addPipeline=function(n){throw et("pipeline")},t.addHook=function(n,i,a,s=!1){if(typeof a!="function")throw tr("COL7",{key:i,when:n});if(!Pv.includes(n))throw tr("COL8",{key:i,when:n});if(!Nv.includes(i))throw ye("COL9",{key:i});if(n==="post"&&i==="create"&&s===!0)throw ye("COL10",{when:n,key:i,parallel:s});var o=a.bind(this),c=s?"parallel":"series";this.hooks[i]=this.hooks[i]||{},this.hooks[i][n]=this.hooks[i][n]||{series:[],parallel:[]},this.hooks[i][n][c].push(o)},t.getHooks=function(n,i){return!this.hooks[i]||!this.hooks[i][n]?{series:[],parallel:[]}:this.hooks[i][n]},t.hasHooks=function(n,i){if(!this.hooks[i]||!this.hooks[i][n])return!1;var a=this.getHooks(n,i);return a?a.series.length>0||a.parallel.length>0:!1},t._runHooks=function(n,i,a,s){var o=this.getHooks(n,i);if(!o)return gr;var c=o.series.map(u=>()=>u(a,s));return u0(c).then(()=>Promise.all(o.parallel.map(u=>u(a,s))))},t._runHooksSync=function(n,i,a,s){if(this.hasHooks(n,i)){var o=this.getHooks(n,i);o&&o.series.forEach(c=>c(a,s))}},t.promiseWait=function(n){var i=new Promise(a=>{var s=setTimeout(()=>{this.timeouts.delete(s),a()},n);this.timeouts.add(s)});return i},t.destroy=async function(){return this.destroyed?Tr:(await Promise.all(this.onDestroy.map(n=>n())),this.destroyed=!0,Array.from(this.timeouts).forEach(n=>clearTimeout(n)),this._changeEventBuffer&&this._changeEventBuffer.destroy(),this.database.requestIdlePromise().then(()=>this.storageInstance.close()).then(()=>(this._subs.forEach(n=>n.unsubscribe()),delete this.database.collections[this.name],Ss("postDestroyRxCollection",this).then(()=>!0))))},t.remove=async function(){await this.destroy(),await Promise.all(this.onRemove.map(n=>n())),await $v(this.database.storage,this.database.internalStore,this.database.token,this.database.name,this.name,this.database.password,this.database.hashFunction)},zn(e,[{key:"insert$",get:function(){return this.$.pipe(tt(r=>r.operation==="INSERT"))}},{key:"update$",get:function(){return this.$.pipe(tt(r=>r.operation==="UPDATE"))}},{key:"remove$",get:function(){return this.$.pipe(tt(r=>r.operation==="DELETE"))}},{key:"asRxCollection",get:function(){return this}}])})();function Ek(e){if(!lp){lp=!0;var t=Object.getPrototypeOf(e);Nv.forEach(r=>{Pv.map(n=>{var i=n+oy(r);t[i]=function(a,s){return this.addHook(n,r,a,s)}})})}}function xk(e,t){return e.incrementalModify(r=>t)}function Sk(e,t,r){var n=e._docCache.getLatestDocumentDataIfExists(t);return n?Promise.resolve({doc:e._docCache.getCachedRxDocuments([n])[0],inserted:!1}):e.findOne(t).exec().then(i=>i?{doc:i,inserted:!1}:e.insert(r).then(a=>({doc:a,inserted:!0})))}function kk({database:e,name:t,schema:r,instanceCreationOptions:n={},migrationStrategies:i={},autoMigrate:a=!0,statics:s={},methods:o={},attachments:c={},options:u={},localDocuments:d=!1,cacheReplacementPolicy:h=vv,conflictHandler:p=Yo}){var y={databaseInstanceToken:e.token,databaseName:e.name,collectionName:t,schema:r.jsonSchema,options:n,multiInstance:e.multiInstance,password:e.password,devMode:rt.isDevMode()};return vr("preCreateRxStorageInstance",y),sk(e,y).then(g=>{var w=new Dv(e,t,r,g,n,i,o,c,u,h,s,p);return w.prepare().then(()=>{Object.entries(s).forEach(([S,O])=>{Object.defineProperty(w,S,{get:()=>O.bind(w)})});var b=gr;return a&&w.schema.version!==0&&(b=w.migratePromise()),b}).then(()=>(vr("createRxCollection",{collection:w,creator:{name:t,schema:r,storageInstance:g,instanceCreationOptions:n,migrationStrategies:i,methods:o,attachments:c,options:u,cacheReplacementPolicy:h,localDocuments:d,statics:s}}),w)).catch(b=>g.close().then(()=>Promise.reject(b)))})}var Mv=function(){var t=arguments.length>0&&arguments[0]!==void 0?arguments[0]:1;this._parallels=t||1,this._qC=0,this._iC=new Set,this._lHN=0,this._hPM=new Map,this._pHM=new Map};Mv.prototype={isIdle:function(){return this._qC<this._parallels},lock:function(){this._qC++},unlock:function(){this._qC--,bd(this)},wrapCall:function(t){var r=this;this.lock();var n;try{n=t()}catch(i){throw this.unlock(),i}return!n.then||typeof n.then!="function"?(this.unlock(),n):n.then(function(i){return r.unlock(),i}).catch(function(i){throw r.unlock(),i})},requestIdlePromise:function(t){var r=this;t=t||{};var n,i=new Promise(function(o){return n=o}),a=function(){Cu(r,i),n()};if(i._manRes=a,t.timeout){var s=setTimeout(function(){i._manRes()},t.timeout);i._timeoutObj=s}return this._iC.add(i),bd(this),i},cancelIdlePromise:function(t){Cu(this,t)},requestIdleCallback:function(t,r){var n=this._lHN++,i=this.requestIdlePromise(r);return this._hPM.set(n,i),this._pHM.set(i,n),i.then(function(){return t()}),n},cancelIdleCallback:function(t){var r=this._hPM.get(t);this.cancelIdlePromise(r)},clear:function(){var t=this;this._iC.forEach(function(r){return Cu(t,r)}),this._qC=0,this._iC.clear(),this._hPM=new Map,this._pHM=new Map}};function Ik(e){if(e._iC.size!==0){var t=e._iC.values(),r=t.next().value;r._manRes(),setTimeout(function(){return bd(e)},0)}}function Cu(e,t){if(t){if(t._timeoutObj&&clearTimeout(t._timeoutObj),e._pHM.has(t)){var r=e._pHM.get(t);e._hPM.delete(r),e._pHM.delete(t)}e._iC.delete(t)}}function bd(e){e._tryIR||e._iC.size===0||(e._tryIR=!0,setTimeout(function(){if(!e.isIdle()){e._tryIR=!1;return}setTimeout(function(){if(!e.isIdle()){e._tryIR=!1;return}Ik(e),e._tryIR=!1},0)},0))}class Sf{ttl;map=new Map;_to=!1;constructor(t){this.ttl=t}has(t){return this.map.has(t)}add(t){this.map.set(t,Lv()),this._to||(this._to=!0,setTimeout(()=>{this._to=!1,Ok(this)},0))}clear(){this.map.clear()}}function Ok(e){const t=Lv()-e.ttl,r=e.map[Symbol.iterator]();for(;;){const n=r.next().value;if(!n)return;const i=n[0];if(n[1]<t)e.map.delete(i);else return}}function Lv(){return Date.now()}var Xo=new Set,kf=(function(){function e(r,n,i,a,s,o,c=!1,u={},d,h,p,y,g){this.idleQueue=new Mv,this.rxdbVersion=dy,this.storageInstances=new Set,this._subs=[],this.startupErrors=[],this.onDestroy=[],this.destroyed=!1,this.collections={},this.states={},this.eventBulks$=new nr,this.observable$=this.eventBulks$.pipe(cn(w=>w.events)),this.storageToken=Tr,this.storageTokenDocument=Tr,this.emittedEventBulkIds=new Sf(60*1e3),this.name=r,this.token=n,this.storage=i,this.instanceCreationOptions=a,this.password=s,this.multiInstance=o,this.eventReduce=c,this.options=u,this.internalStore=d,this.hashFunction=h,this.cleanupPolicy=p,this.allowSlowCount=y,this.reactivity=g,this.name!=="pseudoInstance"&&(this.internalStore=bf(this.asRxDatabase,d,xf),this.storageTokenDocument=nk(this.asRxDatabase).catch(w=>this.startupErrors.push(w)),this.storageToken=this.storageTokenDocument.then(w=>w.data.token).catch(w=>this.startupErrors.push(w)))}var t=e.prototype;return t.getReactivityFactory=function(){if(!this.reactivity)throw ye("DB14",{database:this.name});return this.reactivity},t.$emit=function(n){this.emittedEventBulkIds.has(n.id)||(this.emittedEventBulkIds.add(n.id),this.eventBulks$.next(n))},t.removeCollectionDoc=async function(n,i){var a=await Cs(this.internalStore,sa(yd(n,i),li));if(!a)throw ye("SNH",{name:n,schema:i});var s=Ps(a);s._deleted=!0,await this.internalStore.bulkWrite([{document:s,previous:a}],"rx-database-remove-collection")},t.addCollections=async function(n){var i={},a={},s=[],o={};await Promise.all(Object.entries(n).map(async([d,h])=>{var p=d,y=h.schema;i[p]=y;var g=A0(y,this.hashFunction);if(a[p]=g,this.collections[d])throw ye("DB3",{name:d});var w=yd(d,y),b={id:sa(w,li),key:w,context:li,data:{name:p,schemaHash:await g.hash,schema:g.jsonSchema,version:g.version,connectedStorages:[]},_deleted:!1,_meta:xi(),_rev:yr(),_attachments:{}};s.push({document:b});var S=Object.assign({},h,{name:p,schema:g,database:this}),O=it(h);O.database=this,O.name=d,vr("preCreateRxCollection",O),S.conflictHandler=O.conflictHandler,o[p]=S}));var c=await this.internalStore.bulkWrite(s,"rx-database-add-collection");await Ck(this),await Promise.all(c.error.map(async d=>{if(d.status!==409)throw ye("DB12",{database:this.name,writeError:d});var h=ze(d.documentInDb),p=h.data.name,y=a[p];if(h.data.schemaHash!==await y.hash)throw ye("DB6",{database:this.name,collection:p,previousSchemaHash:h.data.schemaHash,schemaHash:await y.hash,previousSchema:h.data.schema,schema:ze(i[p])})}));var u={};return await Promise.all(Object.keys(n).map(async d=>{var h=o[d],p=await kk(h);u[d]=p,this.collections[d]=p,this[d]||Object.defineProperty(this,d,{get:()=>this.collections[d]})})),u},t.lockedRun=function(n){return this.idleQueue.wrapCall(n)},t.requestIdlePromise=function(){return this.idleQueue.requestIdlePromise()},t.exportJSON=function(n){throw et("json-dump")},t.addState=function(n){throw et("state")},t.importJSON=function(n){throw et("json-dump")},t.backup=function(n){throw et("backup")},t.leaderElector=function(){throw et("leader-election")},t.isLeader=function(){throw et("leader-election")},t.waitForLeadership=function(){throw et("leader-election")},t.migrationStates=function(){throw et("migration-schema")},t.destroy=async function(){return this.destroyed||(this.destroyed=!0,await Ss("preDestroyRxDatabase",this),this.eventBulks$.complete(),this._subs.map(n=>n.unsubscribe()),this.name==="pseudoInstance")?Tr:this.requestIdlePromise().then(()=>Promise.all(this.onDestroy.map(n=>n()))).then(()=>Promise.all(Object.keys(this.collections).map(n=>this.collections[n]).map(n=>n.destroy()))).then(()=>this.internalStore.close()).then(()=>Xo.delete(this.storage.name+"|"+this.name)).then(()=>!0)},t.remove=function(){return this.destroy().then(()=>Ak(this.name,this.storage,this.password))},zn(e,[{key:"$",get:function(){return this.observable$}},{key:"asRxDatabase",get:function(){return this}}])})();function Tk(e,t){var r=t.name+"|"+e;if(Xo.has(r))throw ye("DB8",{name:e,storage:t.name,link:"https://rxdb.info/rx-database.html#ignoreduplicate"})}async function jv(e,t,r,n,i,a){var s=await t.createStorageInstance({databaseInstanceToken:e,databaseName:r,collectionName:GS,schema:xf,options:n,multiInstance:i,password:a,devMode:rt.isDevMode()});return s}function Rk({storage:e,instanceCreationOptions:t,name:r,password:n,multiInstance:i=!0,eventReduce:a=!0,ignoreDuplicate:s=!1,options:o={},cleanupPolicy:c,allowSlowCount:u=!1,localDocuments:d=!1,hashFunction:h=sy,reactivity:p}){vr("preCreateRxDatabase",{storage:e,instanceCreationOptions:t,name:r,password:n,multiInstance:i,eventReduce:a,ignoreDuplicate:s,options:o,localDocuments:d}),s||Tk(r,e),Xo.add(e.name+"|"+r);var y=Es(10);return jv(y,e,r,t,i,n).catch(g=>{throw Xo.delete(e.name+"|"+r),g}).then(g=>{var w=new kf(r,y,e,t,n,i,a,o,g,h,c,u,p);return Ss("createRxDatabase",{database:w,creator:{storage:e,instanceCreationOptions:t,name:r,password:n,multiInstance:i,eventReduce:a,ignoreDuplicate:s,options:o,localDocuments:d}}).then(()=>w)})}async function Ak(e,t,r){var n=Es(10),i=await jv(n,t,e,{},!1,r),a=await Rv(i),s=new Set;a.forEach(c=>s.add(c.data.name));var o=Array.from(s);return await Promise.all(o.map(c=>$v(t,i,n,e,c,r))),await Ss("postRemoveRxDatabase",{databaseName:e,storage:t}),await i.remove(),o}function $k(e){return e instanceof kf}async function Ck(e){if(await e.storageToken,e.startupErrors[0])throw e.startupErrors[0]}var Pk={RxSchema:gy.prototype,RxDocument:kc,RxQuery:bv.prototype,RxCollection:Dv.prototype,RxDatabase:kf.prototype},Pu=new Set,dp=new Set;function Ic(e){if(vr("preAddRxPlugin",{plugin:e,plugins:Pu}),!Pu.has(e)){{if(dp.has(e.name))throw ye("PL3",{name:e.name,plugin:e});Pu.add(e),dp.add(e.name)}if(!e.rxdb)throw tr("PL1",{plugin:e});e.init&&e.init(),e.prototypes&&Object.entries(e.prototypes).forEach(([t,r])=>r(Pk[t])),e.overwritable&&Object.assign(rt,e.overwritable),e.hooks&&Object.entries(e.hooks).forEach(([t,r])=>{r.after&&ns[t].push(r.after),r.before&&ns[t].unshift(r.before)})}}function Nk(e){return e&&typeof e.then=="function"}Promise.resolve(!1);var Dk=Promise.resolve(!0),rn=Promise.resolve();function ai(e,t){return e||(e=0),new Promise(function(r){return setTimeout(function(){return r(t)},e)})}function Mk(e,t){return Math.floor(Math.random()*(t-e+1)+e)}function Ns(){return Math.random().toString(36).substring(2)}var Nu=0;function Ds(){var e=Date.now()*1e3;return e<=Nu&&(e=Nu+1),Nu=e,e}function Lk(){return typeof navigator<"u"&&typeof navigator.locks<"u"&&typeof navigator.locks.request=="function"}var jk=Ds,Fk="native";function Bk(e){var t={time:Ds(),messagesCallback:null,bc:new BroadcastChannel(e),subFns:[]};return t.bc.onmessage=function(r){t.messagesCallback&&t.messagesCallback(r.data)},t}function zk(e){e.bc.close(),e.subFns=[]}function Uk(e,t){try{return e.bc.postMessage(t,!1),rn}catch(r){return Promise.reject(r)}}function qk(e,t){e.messagesCallback=t}function Hk(){if(typeof globalThis<"u"&&globalThis.Deno&&globalThis.Deno.args)return!0;if((typeof window<"u"||typeof self<"u")&&typeof BroadcastChannel=="function"){if(BroadcastChannel._pubkey)throw new Error("BroadcastChannel: Do not overwrite window.BroadcastChannel with this module, this is not a polyfill");return!0}else return!1}function Kk(){return 150}var Gk={create:Bk,close:zk,onMessage:qk,postMessage:Uk,canBeUsed:Hk,type:Fk,averageResponseTime:Kk,microSeconds:jk};function If(){var e=arguments.length>0&&arguments[0]!==void 0?arguments[0]:{},t=JSON.parse(JSON.stringify(e));return typeof t.webWorkerSupport>"u"&&(t.webWorkerSupport=!0),t.idb||(t.idb={}),t.idb.ttl||(t.idb.ttl=1e3*45),t.idb.fallbackInterval||(t.idb.fallbackInterval=150),e.idb&&typeof e.idb.onclose=="function"&&(t.idb.onclose=e.idb.onclose),t.localstorage||(t.localstorage={}),t.localstorage.removeTimeout||(t.localstorage.removeTimeout=1e3*60),e.methods&&(t.methods=e.methods),t.node||(t.node={}),t.node.ttl||(t.node.ttl=1e3*60*2),t.node.maxParallelWrites||(t.node.maxParallelWrites=2048),typeof t.node.useFastPath>"u"&&(t.node.useFastPath=!0),t}var Wk=Ds,Vk="pubkey.broadcast-channel-0-",fn="messages",Oc={durability:"relaxed"},Zk="idb";function Fv(){if(typeof indexedDB<"u")return indexedDB;if(typeof window<"u"){if(typeof window.mozIndexedDB<"u")return window.mozIndexedDB;if(typeof window.webkitIndexedDB<"u")return window.webkitIndexedDB;if(typeof window.msIndexedDB<"u")return window.msIndexedDB}return!1}function Of(e){e.commit&&e.commit()}function Jk(e){var t=Fv(),r=Vk+e,n=t.open(r);return n.onupgradeneeded=function(i){var a=i.target.result;a.createObjectStore(fn,{keyPath:"id",autoIncrement:!0})},new Promise(function(i,a){n.onerror=function(s){return a(s)},n.onsuccess=function(){i(n.result)}})}function Qk(e,t,r){var n=Date.now(),i={uuid:t,time:n,data:r},a=e.transaction([fn],"readwrite",Oc);return new Promise(function(s,o){a.oncomplete=function(){return s()},a.onerror=function(u){return o(u)};var c=a.objectStore(fn);c.add(i),Of(a)})}function Yk(e,t){var r=e.transaction(fn,"readonly",Oc),n=r.objectStore(fn),i=[],a=IDBKeyRange.bound(t+1,1/0);if(n.getAll){var s=n.getAll(a);return new Promise(function(c,u){s.onerror=function(d){return u(d)},s.onsuccess=function(d){c(d.target.result)}})}function o(){try{return a=IDBKeyRange.bound(t+1,1/0),n.openCursor(a)}catch{return n.openCursor()}}return new Promise(function(c,u){var d=o();d.onerror=function(h){return u(h)},d.onsuccess=function(h){var p=h.target.result;p?p.value.id<t+1?p.continue(t+1):(i.push(p.value),p.continue()):(Of(r),c(i))}})}function Xk(e,t){if(e.closed)return Promise.resolve([]);var r=e.db.transaction(fn,"readwrite",Oc),n=r.objectStore(fn);return Promise.all(t.map(function(i){var a=n.delete(i);return new Promise(function(s){a.onsuccess=function(){return s()}})}))}function eI(e,t){var r=Date.now()-t,n=e.transaction(fn,"readonly",Oc),i=n.objectStore(fn),a=[];return new Promise(function(s){i.openCursor().onsuccess=function(o){var c=o.target.result;if(c){var u=c.value;u.time<r?(a.push(u),c.continue()):(Of(n),s(a))}else s(a)}})}function tI(e){return eI(e.db,e.options.idb.ttl).then(function(t){return Xk(e,t.map(function(r){return r.id}))})}function rI(e,t){return t=If(t),Jk(e).then(function(r){var n={closed:!1,lastCursorId:0,channelName:e,options:t,uuid:Ns(),eMIs:new Sf(t.idb.ttl*2),writeBlockPromise:rn,messagesCallback:null,readQueuePromises:[],db:r};return r.onclose=function(){n.closed=!0,t.idb.onclose&&t.idb.onclose()},Bv(n),n})}function Bv(e){e.closed||zv(e).then(function(){return ai(e.options.idb.fallbackInterval)}).then(function(){return Bv(e)})}function nI(e,t){return!(e.uuid===t.uuid||t.eMIs.has(e.id)||e.data.time<t.messagesCallbackTime)}function zv(e){return e.closed||!e.messagesCallback?rn:Yk(e.db,e.lastCursorId).then(function(t){var r=t.filter(function(n){return!!n}).map(function(n){return n.id>e.lastCursorId&&(e.lastCursorId=n.id),n}).filter(function(n){return nI(n,e)}).sort(function(n,i){return n.time-i.time});return r.forEach(function(n){e.messagesCallback&&(e.eMIs.add(n.id),e.messagesCallback(n.data))}),rn})}function iI(e){e.closed=!0,e.db.close()}function aI(e,t){return e.writeBlockPromise=e.writeBlockPromise.then(function(){return Qk(e.db,e.uuid,t)}).then(function(){Mk(0,10)===0&&tI(e)}),e.writeBlockPromise}function sI(e,t,r){e.messagesCallbackTime=r,e.messagesCallback=t,zv(e)}function oI(){return!!Fv()}function cI(e){return e.idb.fallbackInterval*2}var uI={create:rI,close:iI,onMessage:sI,postMessage:aI,canBeUsed:oI,type:Zk,averageResponseTime:cI,microSeconds:Wk},lI=Ds,dI="pubkey.broadcastChannel-",fI="localstorage";function Uv(){var e;if(typeof window>"u")return null;try{e=window.localStorage,e=window["ie8-eventlistener/storage"]||window.localStorage}catch{}return e}function qv(e){return dI+e}function hI(e,t){return new Promise(function(r){ai().then(function(){var n=qv(e.channelName),i={token:Ns(),time:Date.now(),data:t,uuid:e.uuid},a=JSON.stringify(i);Uv().setItem(n,a);var s=document.createEvent("Event");s.initEvent("storage",!0,!0),s.key=n,s.newValue=a,window.dispatchEvent(s),r()})})}function pI(e,t){var r=qv(e),n=function(a){a.key===r&&t(JSON.parse(a.newValue))};return window.addEventListener("storage",n),n}function mI(e){window.removeEventListener("storage",e)}function gI(e,t){if(t=If(t),!Hv())throw new Error("BroadcastChannel: localstorage cannot be used");var r=Ns(),n=new Sf(t.localstorage.removeTimeout),i={channelName:e,uuid:r,eMIs:n};return i.listener=pI(e,function(a){i.messagesCallback&&a.uuid!==r&&(!a.token||n.has(a.token)||a.data.time&&a.data.time<i.messagesCallbackTime||(n.add(a.token),i.messagesCallback(a.data)))}),i}function yI(e){mI(e.listener)}function vI(e,t,r){e.messagesCallbackTime=r,e.messagesCallback=t}function Hv(){var e=Uv();if(!e)return!1;try{var t="__broadcastchannel_check";e.setItem(t,"works"),e.removeItem(t)}catch{return!1}return!0}function _I(){var e=120,t=navigator.userAgent.toLowerCase();return t.includes("safari")&&!t.includes("chrome")?e*2:e}var wI={create:gI,close:yI,onMessage:vI,postMessage:hI,canBeUsed:Hv,type:fI,averageResponseTime:_I,microSeconds:lI},Kv=Ds,bI="simulate",Tf=new Set;function EI(e){var t={time:Kv(),name:e,messagesCallback:null};return Tf.add(t),t}function xI(e){Tf.delete(e)}var Gv=5;function SI(e,t){return new Promise(function(r){return setTimeout(function(){var n=Array.from(Tf);n.forEach(function(i){i.name===e.name&&i!==e&&i.messagesCallback&&i.time<t.time&&i.messagesCallback(t)}),r()},Gv)})}function kI(e,t){e.messagesCallback=t}function II(){return!0}function OI(){return Gv}var TI={create:EI,close:xI,onMessage:kI,postMessage:SI,canBeUsed:II,type:bI,averageResponseTime:OI,microSeconds:Kv},fp=[Gk,uI,wI];function RI(e){var t=[].concat(e.methods,fp).filter(Boolean);if(e.type){if(e.type==="simulate")return TI;var r=t.find(function(i){return i.type===e.type});if(r)return r;throw new Error("method-type "+e.type+" not found")}e.webWorkerSupport||(t=t.filter(function(i){return i.type!=="idb"}));var n=t.find(function(i){return i.canBeUsed()});if(n)return n;throw new Error("No usable method found in "+JSON.stringify(fp.map(function(i){return i.type})))}var Wv=new Set,AI=0,Tc=function(t,r){this.id=AI++,Wv.add(this),this.name=t,this.options=If(r),this.method=RI(this.options),this._iL=!1,this._onML=null,this._addEL={message:[],internal:[]},this._uMP=new Set,this._befC=[],this._prepP=null,$I(this)};Tc._pubkey=!0;Tc.prototype={postMessage:function(t){if(this.closed)throw new Error("BroadcastChannel.postMessage(): Cannot post message after channel has closed "+JSON.stringify(t));return hp(this,"message",t)},postInternal:function(t){return hp(this,"internal",t)},set onmessage(e){var t=this.method.microSeconds(),r={time:t,fn:e};mp(this,"message",this._onML),e&&typeof e=="function"?(this._onML=r,pp(this,"message",r)):this._onML=null},addEventListener:function(t,r){var n=this.method.microSeconds(),i={time:n,fn:r};pp(this,t,i)},removeEventListener:function(t,r){var n=this._addEL[t].find(function(i){return i.fn===r});mp(this,t,n)},close:function(){var t=this;if(!this.closed){Wv.delete(this),this.closed=!0;var r=this._prepP?this._prepP:rn;return this._onML=null,this._addEL.message=[],r.then(function(){return Promise.all(Array.from(t._uMP))}).then(function(){return Promise.all(t._befC.map(function(n){return n()}))}).then(function(){return t.method.close(t._state)})}},get type(){return this.method.type},get isClosed(){return this.closed}};function hp(e,t,r){var n=e.method.microSeconds(),i={time:n,type:t,data:r},a=e._prepP?e._prepP:rn;return a.then(function(){var s=e.method.postMessage(e._state,i);return e._uMP.add(s),s.catch().then(function(){return e._uMP.delete(s)}),s})}function $I(e){var t=e.method.create(e.name,e.options);Nk(t)?(e._prepP=t,t.then(function(r){e._state=r})):e._state=t}function Vv(e){return e._addEL.message.length>0||e._addEL.internal.length>0}function pp(e,t,r){e._addEL[t].push(r),CI(e)}function mp(e,t,r){e._addEL[t]=e._addEL[t].filter(function(n){return n!==r}),PI(e)}function CI(e){if(!e._iL&&Vv(e)){var t=function(i){e._addEL[i.type].forEach(function(a){i.time>=a.time&&a.fn(i.data)})},r=e.method.microSeconds();e._prepP?e._prepP.then(function(){e._iL=!0,e.method.onMessage(e._state,t,r)}):(e._iL=!0,e.method.onMessage(e._state,t,r))}}function PI(e){if(e._iL&&!Vv(e)){e._iL=!1;var t=e.method.microSeconds();e.method.onMessage(e._state,null,t)}}function NI(e){if(typeof WorkerGlobalScope=="function"&&self instanceof WorkerGlobalScope){var t=self.close.bind(self);self.close=function(){return e(),t()}}else{if(typeof window.addEventListener!="function")return;window.addEventListener("beforeunload",function(){e()},!0),window.addEventListener("unload",function(){e()},!0)}}function DI(e){process.on("exit",function(){return e()}),process.on("beforeExit",function(){return e().then(function(){return process.exit()})}),process.on("SIGINT",function(){return e().then(function(){return process.exit()})}),process.on("uncaughtException",function(t){return e().then(function(){console.trace(t),process.exit(101)})})}var MI=Object.prototype.toString.call(typeof process<"u"?process:0)==="[object process]",LI=MI?DI:NI,Va=new Set,gp=!1;function jI(){gp||(gp=!0,LI(BI))}function FI(e){if(jI(),typeof e!="function")throw new Error("Listener is no function");Va.add(e);var t={remove:function(){return Va.delete(e)},run:function(){return Va.delete(e),e()}};return t}function BI(){var e=[];return Va.forEach(function(t){e.push(t()),Va.delete(t)}),Promise.all(e)}function di(e,t){var r={context:"leader",action:t,token:e.token};return e.broadcastChannel.postInternal(r)}function Zv(e){e.isLeader=!0,e._hasLeader=!0;var t=FI(function(){return e.die()});e._unl.push(t);var r=function(i){i.context==="leader"&&i.action==="apply"&&di(e,"tell"),i.context==="leader"&&i.action==="tell"&&!e._dpLC&&(e._dpLC=!0,e._dpL(),di(e,"tell"))};return e.broadcastChannel.addEventListener("internal",r),e._lstns.push(r),di(e,"tell")}var Jv=function(t,r){var n=this;this.broadcastChannel=t,t._befC.push(function(){return n.die()}),this._options=r,this.isLeader=!1,this.isDead=!1,this.token=Ns(),this._lstns=[],this._unl=[],this._dpL=function(){},this._dpLC=!1,this._wKMC={},this.lN="pubkey-bc||"+t.method.type+"||"+t.name};Jv.prototype={hasLeader:function(){var t=this;return navigator.locks.query().then(function(r){var n=r.held?r.held.filter(function(i){return i.name===t.lN}):[];return!!(n&&n.length>0)})},awaitLeadership:function(){var t=this;if(!this._wLMP){this._wKMC.c=new AbortController;var r=new Promise(function(n,i){t._wKMC.res=n,t._wKMC.rej=i});this._wLMP=new Promise(function(n){navigator.locks.request(t.lN,{signal:t._wKMC.c.signal},function(){return t._wKMC.c=void 0,Zv(t),n(),r}).catch(function(){})})}return this._wLMP},set onduplicate(e){},die:function(){var t=this;return this._lstns.forEach(function(r){return t.broadcastChannel.removeEventListener("internal",r)}),this._lstns=[],this._unl.forEach(function(r){return r.remove()}),this._unl=[],this.isLeader&&(this.isLeader=!1),this.isDead=!0,this._wKMC.res&&this._wKMC.res(),this._wKMC.c&&this._wKMC.c.abort("LeaderElectionWebLock.die() called"),di(this,"death")}};var Qv=function(t,r){var n=this;this.broadcastChannel=t,this._options=r,this.isLeader=!1,this._hasLeader=!1,this.isDead=!1,this.token=Ns(),this._aplQ=rn,this._aplQC=0,this._unl=[],this._lstns=[],this._dpL=function(){},this._dpLC=!1;var i=function(s){s.context==="leader"&&(s.action==="death"&&(n._hasLeader=!1),s.action==="tell"&&(n._hasLeader=!0))};this.broadcastChannel.addEventListener("internal",i),this._lstns.push(i)};Qv.prototype={hasLeader:function(){return Promise.resolve(this._hasLeader)},applyOnce:function(t){var r=this;if(this.isLeader)return ai(0,!0);if(this.isDead)return ai(0,!1);if(this._aplQC>1)return this._aplQ;var n=function(){if(r.isLeader)return Dk;var a=!1,s,o=new Promise(function(d){s=function(){a=!0,d()}}),c=function(h){h.context==="leader"&&h.token!=r.token&&(h.action==="apply"&&h.token>r.token&&s(),h.action==="tell"&&(s(),r._hasLeader=!0))};r.broadcastChannel.addEventListener("internal",c);var u=t?r._options.responseTime*4:r._options.responseTime;return di(r,"apply").then(function(){return Promise.race([ai(u),o.then(function(){return Promise.reject(new Error)})])}).then(function(){return di(r,"apply")}).then(function(){return Promise.race([ai(u),o.then(function(){return Promise.reject(new Error)})])}).catch(function(){}).then(function(){return r.broadcastChannel.removeEventListener("internal",c),a?!1:Zv(r).then(function(){return!0})})};return this._aplQC=this._aplQC+1,this._aplQ=this._aplQ.then(function(){return n()}).then(function(){r._aplQC=r._aplQC-1}),this._aplQ.then(function(){return r.isLeader})},awaitLeadership:function(){return this._aLP||(this._aLP=zI(this)),this._aLP},set onduplicate(e){this._dpL=e},die:function(){var t=this;return this._lstns.forEach(function(r){return t.broadcastChannel.removeEventListener("internal",r)}),this._lstns=[],this._unl.forEach(function(r){return r.remove()}),this._unl=[],this.isLeader&&(this._hasLeader=!1,this.isLeader=!1),this.isDead=!0,di(this,"death")}};function zI(e){return e.isLeader?rn:new Promise(function(t){var r=!1;function n(){r||(r=!0,e.broadcastChannel.removeEventListener("internal",a),t(!0))}e.applyOnce().then(function(){e.isLeader&&n()});var i=function s(){return ai(e._options.fallbackInterval).then(function(){if(!(e.isDead||r))if(e.isLeader)n();else return e.applyOnce(!0).then(function(){e.isLeader?n():s()})})};i();var a=function(o){o.context==="leader"&&o.action==="death"&&(e._hasLeader=!1,e.applyOnce().then(function(){e.isLeader&&n()}))};e.broadcastChannel.addEventListener("internal",a),e._lstns.push(a)})}function UI(e,t){return e||(e={}),e=JSON.parse(JSON.stringify(e)),e.fallbackInterval||(e.fallbackInterval=3e3),e.responseTime||(e.responseTime=t.method.averageResponseTime(t.options)),e}function qI(e,t){if(e._leaderElector)throw new Error("BroadcastChannel already has a leader-elector");t=UI(t,e);var r=Lk()?new Jv(e,t):new Qv(e,t);return e._befC.push(function(){return r.die()}),e._leaderElector=r,r}var ec=new Map;function HI(e,t,r,n){var i=ec.get(t);return i||(i={bc:new Tc(["RxDB:",e,r].join("|")),refs:new Set},ec.set(t,i)),i.refs.add(n),i.bc}function yp(e,t){var r=ec.get(e);if(r&&(r.refs.delete(t),r.refs.size===0))return ec.delete(e),r.bc.close()}function KI(e,t,r,n){if(t.multiInstance){var i=HI(e,t.databaseInstanceToken,r.databaseName,r),a=new nr,s=p=>{p.storageName===e&&p.databaseName===t.databaseName&&p.collectionName===t.collectionName&&p.version===t.schema.version&&a.next(p.eventBulk)};i.addEventListener("message",s);var o=r.changeStream(),c=!1,u=o.subscribe(p=>{c||i.postMessage({storageName:e,databaseName:t.databaseName,collectionName:t.collectionName,version:t.schema.version,eventBulk:p})});r.changeStream=function(){return a.asObservable().pipe(SE(o))};var d=r.close.bind(r);r.close=async function(){return c=!0,u.unsubscribe(),i.removeEventListener("message",s),await yp(t.databaseInstanceToken,r),d()};var h=r.remove.bind(r);r.remove=async function(){return c=!0,u.unsubscribe(),i.removeEventListener("message",s),await yp(t.databaseInstanceToken,r),h()}}}var Lo={exports:{}},GI=Lo.exports,vp;function WI(){return vp||(vp=1,(function(e,t){(function(r,n){e.exports=n()})(GI,function(){var r=function(l,f){return(r=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(m,v){m.__proto__=v}||function(m,v){for(var _ in v)Object.prototype.hasOwnProperty.call(v,_)&&(m[_]=v[_])})(l,f)},n=function(){return(n=Object.assign||function(l){for(var f,m=1,v=arguments.length;m<v;m++)for(var _ in f=arguments[m])Object.prototype.hasOwnProperty.call(f,_)&&(l[_]=f[_]);return l}).apply(this,arguments)};function i(l,f,m){for(var v,_=0,E=f.length;_<E;_++)!v&&_ in f||((v=v||Array.prototype.slice.call(f,0,_))[_]=f[_]);return l.concat(v||Array.prototype.slice.call(f))}var a=typeof globalThis<"u"?globalThis:typeof self<"u"?self:typeof window<"u"?window:pb,s=Object.keys,o=Array.isArray;function c(l,f){return typeof f!="object"||s(f).forEach(function(m){l[m]=f[m]}),l}typeof Promise>"u"||a.Promise||(a.Promise=Promise);var u=Object.getPrototypeOf,d={}.hasOwnProperty;function h(l,f){return d.call(l,f)}function p(l,f){typeof f=="function"&&(f=f(u(l))),(typeof Reflect>"u"?s:Reflect.ownKeys)(f).forEach(function(m){g(l,m,f[m])})}var y=Object.defineProperty;function g(l,f,m,v){y(l,f,c(m&&h(m,"get")&&typeof m.get=="function"?{get:m.get,set:m.set,configurable:!0}:{value:m,configurable:!0,writable:!0},v))}function w(l){return{from:function(f){return l.prototype=Object.create(f.prototype),g(l.prototype,"constructor",l),{extend:p.bind(null,l.prototype)}}}}var b=Object.getOwnPropertyDescriptor,S=[].slice;function O(l,f,m){return S.call(l,f,m)}function T(l,f){return f(l)}function z(l){if(!l)throw new Error("Assertion Failed")}function B(l){a.setImmediate?setImmediate(l):setTimeout(l,0)}function G(l,f){if(typeof f=="string"&&h(l,f))return l[f];if(!f)return l;if(typeof f!="string"){for(var m=[],v=0,_=f.length;v<_;++v){var E=G(l,f[v]);m.push(E)}return m}var x=f.indexOf(".");if(x!==-1){var k=l[f.substr(0,x)];return k==null?void 0:G(k,f.substr(x+1))}}function q(l,f,m){if(l&&f!==void 0&&!("isFrozen"in Object&&Object.isFrozen(l)))if(typeof f!="string"&&"length"in f){z(typeof m!="string"&&"length"in m);for(var v=0,_=f.length;v<_;++v)q(l,f[v],m[v])}else{var E,x,k=f.indexOf(".");k!==-1?(E=f.substr(0,k),(x=f.substr(k+1))===""?m===void 0?o(l)&&!isNaN(parseInt(E))?l.splice(E,1):delete l[E]:l[E]=m:q(k=!(k=l[E])||!h(l,E)?l[E]={}:k,x,m)):m===void 0?o(l)&&!isNaN(parseInt(f))?l.splice(f,1):delete l[f]:l[f]=m}}function K(l){var f,m={};for(f in l)h(l,f)&&(m[f]=l[f]);return m}var Oe=[].concat;function Le(l){return Oe.apply([],l)}var Zr="BigUint64Array,BigInt64Array,Array,Boolean,String,Date,RegExp,Blob,File,FileList,FileSystemFileHandle,FileSystemDirectoryHandle,ArrayBuffer,DataView,Uint8ClampedArray,ImageBitmap,ImageData,Map,Set,CryptoKey".split(",").concat(Le([8,16,32,64].map(function(l){return["Int","Uint","Float"].map(function(f){return f+l+"Array"})}))).filter(function(l){return a[l]}),qe=new Set(Zr.map(function(l){return a[l]})),$e=null;function Ve(l){return $e=new WeakMap,l=(function f(m){if(!m||typeof m!="object")return m;var v=$e.get(m);if(v)return v;if(o(m)){v=[],$e.set(m,v);for(var _=0,E=m.length;_<E;++_)v.push(f(m[_]))}else if(qe.has(m.constructor))v=m;else{var x,k=u(m);for(x in v=k===Object.prototype?{}:Object.create(k),$e.set(m,v),m)h(m,x)&&(v[x]=f(m[x]))}return v})(l),$e=null,l}var Z={}.toString;function H(l){return Z.call(l).slice(8,-1)}var fe=typeof Symbol<"u"?Symbol.iterator:"@@iterator",Q=typeof fe=="symbol"?function(l){var f;return l!=null&&(f=l[fe])&&f.apply(l)}:function(){return null};function te(l,f){return f=l.indexOf(f),0<=f&&l.splice(f,1),0<=f}var Y={};function re(l){var f,m,v,_;if(arguments.length===1){if(o(l))return l.slice();if(this===Y&&typeof l=="string")return[l];if(_=Q(l)){for(m=[];!(v=_.next()).done;)m.push(v.value);return m}if(l==null)return[l];if(typeof(f=l.length)!="number")return[l];for(m=new Array(f);f--;)m[f]=l[f];return m}for(f=arguments.length,m=new Array(f);f--;)m[f]=arguments[f];return m}var xe=typeof Symbol<"u"?function(l){return l[Symbol.toStringTag]==="AsyncFunction"}:function(){return!1},ue=["Unknown","Constraint","Data","TransactionInactive","ReadOnly","Version","NotFound","InvalidState","InvalidAccess","Abort","Timeout","QuotaExceeded","Syntax","DataClone"],hr=["Modify","Bulk","OpenFailed","VersionChange","Schema","Upgrade","InvalidTable","MissingAPI","NoSuchDatabase","InvalidArgument","SubTransaction","Unsupported","Internal","DatabaseClosed","PrematureCommit","ForeignAwait"].concat(ue),Re={VersionChanged:"Database version changed by other database connection",DatabaseClosed:"Database has been closed",Abort:"Transaction aborted",TransactionInactive:"Transaction has already completed or failed",MissingAPI:"IndexedDB API missing. Please visit https://tinyurl.com/y2uuvskb"};function Te(l,f){this.name=l,this.message=f}function Ge(l,f){return l+". Errors: "+Object.keys(f).map(function(m){return f[m].toString()}).filter(function(m,v,_){return _.indexOf(m)===v}).join(`
`)}function je(l,f,m,v){this.failures=f,this.failedKeys=v,this.successCount=m,this.message=Ge(l,f)}function _t(l,f){this.name="BulkError",this.failures=Object.keys(f).map(function(m){return f[m]}),this.failuresByPos=f,this.message=Ge(l,this.failures)}w(Te).from(Error).extend({toString:function(){return this.name+": "+this.message}}),w(je).from(Te),w(_t).from(Te);var qn=hr.reduce(function(l,f){return l[f]=f+"Error",l},{}),wa=Te,we=hr.reduce(function(l,f){var m=f+"Error";function v(_,E){this.name=m,_?typeof _=="string"?(this.message="".concat(_).concat(E?`
 `+E:""),this.inner=E||null):typeof _=="object"&&(this.message="".concat(_.name," ").concat(_.message),this.inner=_):(this.message=Re[f]||m,this.inner=null)}return w(v).from(wa),l[f]=v,l},{});we.Syntax=SyntaxError,we.Type=TypeError,we.Range=RangeError;var Nr=ue.reduce(function(l,f){return l[f+"Error"]=we[f],l},{}),dr=hr.reduce(function(l,f){return["Syntax","Type","Range"].indexOf(f)===-1&&(l[f+"Error"]=we[f]),l},{});function Ke(){}function br(l){return l}function Ai(l,f){return l==null||l===br?f:function(m){return f(l(m))}}function fr(l,f){return function(){l.apply(this,arguments),f.apply(this,arguments)}}function $i(l,f){return l===Ke?f:function(){var m=l.apply(this,arguments);m!==void 0&&(arguments[0]=m);var v=this.onsuccess,_=this.onerror;this.onsuccess=null,this.onerror=null;var E=f.apply(this,arguments);return v&&(this.onsuccess=this.onsuccess?fr(v,this.onsuccess):v),_&&(this.onerror=this.onerror?fr(_,this.onerror):_),E!==void 0?E:m}}function Fs(l,f){return l===Ke?f:function(){l.apply(this,arguments);var m=this.onsuccess,v=this.onerror;this.onsuccess=this.onerror=null,f.apply(this,arguments),m&&(this.onsuccess=this.onsuccess?fr(m,this.onsuccess):m),v&&(this.onerror=this.onerror?fr(v,this.onerror):v)}}function Ci(l,f){return l===Ke?f:function(m){var v=l.apply(this,arguments);c(m,v);var _=this.onsuccess,E=this.onerror;return this.onsuccess=null,this.onerror=null,m=f.apply(this,arguments),_&&(this.onsuccess=this.onsuccess?fr(_,this.onsuccess):_),E&&(this.onerror=this.onerror?fr(E,this.onerror):E),v===void 0?m===void 0?void 0:m:c(v,m)}}function Fc(l,f){return l===Ke?f:function(){return f.apply(this,arguments)!==!1&&l.apply(this,arguments)}}function ce(l,f){return l===Ke?f:function(){var m=l.apply(this,arguments);if(m&&typeof m.then=="function"){for(var v=this,_=arguments.length,E=new Array(_);_--;)E[_]=arguments[_];return m.then(function(){return f.apply(v,E)})}return f.apply(this,arguments)}}dr.ModifyError=je,dr.DexieError=Te,dr.BulkError=_t;var Dt=typeof location<"u"&&/^(http|https):\/\/(localhost|127\.0\.0\.1)/.test(location.href);function ke(l){Dt=l}var me={},Ae=100,Zr=typeof Promise>"u"?[]:(function(){var l=Promise.resolve();if(typeof crypto>"u"||!crypto.subtle)return[l,u(l),l];var f=crypto.subtle.digest("SHA-512",new Uint8Array([0]));return[f,u(f),l]})(),ue=Zr[0],hr=Zr[1],Zr=Zr[2],hr=hr&&hr.then,ie=ue&&ue.constructor,Ie=!!Zr,Se=function(l,f){ba.push([l,f]),Hn&&(queueMicrotask(Hw),Hn=!1)},Et=!0,Hn=!0,Dr=[],Bs=[],Bc=br,yn={id:"global",global:!0,ref:0,unhandleds:[],onunhandled:Ke,pgp:!1,env:{},finalize:Ke},ve=yn,ba=[],Kn=0,zs=[];function oe(l){if(typeof this!="object")throw new TypeError("Promises must be constructed via new");this._listeners=[],this._lib=!1;var f=this._PSD=ve;if(typeof l!="function"){if(l!==me)throw new TypeError("Not a function");return this._state=arguments[1],this._value=arguments[2],void(this._state===!1&&Uc(this,this._value))}this._state=null,this._value=null,++f.ref,(function m(v,_){try{_(function(E){if(v._state===null){if(E===v)throw new TypeError("A promise cannot be resolved with itself.");var x=v._lib&&Pi();E&&typeof E.then=="function"?m(v,function(k,R){E instanceof oe?E._then(k,R):E.then(k,R)}):(v._state=!0,v._value=E,rh(v)),x&&Ni()}},Uc.bind(null,v))}catch(E){Uc(v,E)}})(this,l)}var zc={get:function(){var l=ve,f=Ks;function m(v,_){var E=this,x=!l.global&&(l!==ve||f!==Ks),k=x&&!_n(),R=new oe(function($,N){qc(E,new th(ih(v,l,x,k),ih(_,l,x,k),$,N,l))});return this._consoleTask&&(R._consoleTask=this._consoleTask),R}return m.prototype=me,m},set:function(l){g(this,"then",l&&l.prototype===me?zc:{get:function(){return l},set:zc.set})}};function th(l,f,m,v,_){this.onFulfilled=typeof l=="function"?l:null,this.onRejected=typeof f=="function"?f:null,this.resolve=m,this.reject=v,this.psd=_}function Uc(l,f){var m,v;Bs.push(f),l._state===null&&(m=l._lib&&Pi(),f=Bc(f),l._state=!1,l._value=f,v=l,Dr.some(function(_){return _._value===v._value})||Dr.push(v),rh(l),m&&Ni())}function rh(l){var f=l._listeners;l._listeners=[];for(var m=0,v=f.length;m<v;++m)qc(l,f[m]);var _=l._PSD;--_.ref||_.finalize(),Kn===0&&(++Kn,Se(function(){--Kn==0&&Hc()},[]))}function qc(l,f){if(l._state!==null){var m=l._state?f.onFulfilled:f.onRejected;if(m===null)return(l._state?f.resolve:f.reject)(l._value);++f.psd.ref,++Kn,Se(qw,[m,l,f])}else l._listeners.push(f)}function qw(l,f,m){try{var v,_=f._value;!f._state&&Bs.length&&(Bs=[]),v=Dt&&f._consoleTask?f._consoleTask.run(function(){return l(_)}):l(_),f._state||Bs.indexOf(_)!==-1||(function(E){for(var x=Dr.length;x;)if(Dr[--x]._value===E._value)return Dr.splice(x,1)})(f),m.resolve(v)}catch(E){m.reject(E)}finally{--Kn==0&&Hc(),--m.psd.ref||m.psd.finalize()}}function Hw(){Gn(yn,function(){Pi()&&Ni()})}function Pi(){var l=Et;return Hn=Et=!1,l}function Ni(){var l,f,m;do for(;0<ba.length;)for(l=ba,ba=[],m=l.length,f=0;f<m;++f){var v=l[f];v[0].apply(null,v[1])}while(0<ba.length);Hn=Et=!0}function Hc(){var l=Dr;Dr=[],l.forEach(function(v){v._PSD.onunhandled.call(null,v._value,v)});for(var f=zs.slice(0),m=f.length;m;)f[--m]()}function Us(l){return new oe(me,!1,l)}function at(l,f){var m=ve;return function(){var v=Pi(),_=ve;try{return wn(m,!0),l.apply(this,arguments)}catch(E){f&&f(E)}finally{wn(_,!1),v&&Ni()}}}p(oe.prototype,{then:zc,_then:function(l,f){qc(this,new th(null,null,l,f,ve))},catch:function(l){if(arguments.length===1)return this.then(null,l);var f=l,m=arguments[1];return typeof f=="function"?this.then(null,function(v){return(v instanceof f?m:Us)(v)}):this.then(null,function(v){return(v&&v.name===f?m:Us)(v)})},finally:function(l){return this.then(function(f){return oe.resolve(l()).then(function(){return f})},function(f){return oe.resolve(l()).then(function(){return Us(f)})})},timeout:function(l,f){var m=this;return l<1/0?new oe(function(v,_){var E=setTimeout(function(){return _(new we.Timeout(f))},l);m.then(v,_).finally(clearTimeout.bind(null,E))}):this}}),typeof Symbol<"u"&&Symbol.toStringTag&&g(oe.prototype,Symbol.toStringTag,"Dexie.Promise"),yn.env=nh(),p(oe,{all:function(){var l=re.apply(null,arguments).map(Gs);return new oe(function(f,m){l.length===0&&f([]);var v=l.length;l.forEach(function(_,E){return oe.resolve(_).then(function(x){l[E]=x,--v||f(l)},m)})})},resolve:function(l){return l instanceof oe?l:l&&typeof l.then=="function"?new oe(function(f,m){l.then(f,m)}):new oe(me,!0,l)},reject:Us,race:function(){var l=re.apply(null,arguments).map(Gs);return new oe(function(f,m){l.map(function(v){return oe.resolve(v).then(f,m)})})},PSD:{get:function(){return ve},set:function(l){return ve=l}},totalEchoes:{get:function(){return Ks}},newPSD:vn,usePSD:Gn,scheduler:{get:function(){return Se},set:function(l){Se=l}},rejectionMapper:{get:function(){return Bc},set:function(l){Bc=l}},follow:function(l,f){return new oe(function(m,v){return vn(function(_,E){var x=ve;x.unhandleds=[],x.onunhandled=E,x.finalize=fr(function(){var k,R=this;k=function(){R.unhandleds.length===0?_():E(R.unhandleds[0])},zs.push(function $(){k(),zs.splice(zs.indexOf($),1)}),++Kn,Se(function(){--Kn==0&&Hc()},[])},x.finalize),l()},f,m,v)})}}),ie&&(ie.allSettled&&g(oe,"allSettled",function(){var l=re.apply(null,arguments).map(Gs);return new oe(function(f){l.length===0&&f([]);var m=l.length,v=new Array(m);l.forEach(function(_,E){return oe.resolve(_).then(function(x){return v[E]={status:"fulfilled",value:x}},function(x){return v[E]={status:"rejected",reason:x}}).then(function(){return--m||f(v)})})})}),ie.any&&typeof AggregateError<"u"&&g(oe,"any",function(){var l=re.apply(null,arguments).map(Gs);return new oe(function(f,m){l.length===0&&m(new AggregateError([]));var v=l.length,_=new Array(v);l.forEach(function(E,x){return oe.resolve(E).then(function(k){return f(k)},function(k){_[x]=k,--v||m(new AggregateError(_))})})})}),ie.withResolvers&&(oe.withResolvers=ie.withResolvers));var xt={awaits:0,echoes:0,id:0},Kw=0,qs=[],Hs=0,Ks=0,Gw=0;function vn(l,f,m,v){var _=ve,E=Object.create(_);return E.parent=_,E.ref=0,E.global=!1,E.id=++Gw,yn.env,E.env=Ie?{Promise:oe,PromiseProp:{value:oe,configurable:!0,writable:!0},all:oe.all,race:oe.race,allSettled:oe.allSettled,any:oe.any,resolve:oe.resolve,reject:oe.reject}:{},f&&c(E,f),++_.ref,E.finalize=function(){--this.parent.ref||this.parent.finalize()},v=Gn(E,l,m,v),E.ref===0&&E.finalize(),v}function Di(){return xt.id||(xt.id=++Kw),++xt.awaits,xt.echoes+=Ae,xt.id}function _n(){return!!xt.awaits&&(--xt.awaits==0&&(xt.id=0),xt.echoes=xt.awaits*Ae,!0)}function Gs(l){return xt.echoes&&l&&l.constructor===ie?(Di(),l.then(function(f){return _n(),f},function(f){return _n(),lt(f)})):l}function Ww(){var l=qs[qs.length-1];qs.pop(),wn(l,!1)}function wn(l,f){var m,v=ve;(f?!xt.echoes||Hs++&&l===ve:!Hs||--Hs&&l===ve)||queueMicrotask(f?(function(_){++Ks,xt.echoes&&--xt.echoes!=0||(xt.echoes=xt.awaits=xt.id=0),qs.push(ve),wn(_,!0)}).bind(null,l):Ww),l!==ve&&(ve=l,v===yn&&(yn.env=nh()),Ie&&(m=yn.env.Promise,f=l.env,(v.global||l.global)&&(Object.defineProperty(a,"Promise",f.PromiseProp),m.all=f.all,m.race=f.race,m.resolve=f.resolve,m.reject=f.reject,f.allSettled&&(m.allSettled=f.allSettled),f.any&&(m.any=f.any))))}function nh(){var l=a.Promise;return Ie?{Promise:l,PromiseProp:Object.getOwnPropertyDescriptor(a,"Promise"),all:l.all,race:l.race,allSettled:l.allSettled,any:l.any,resolve:l.resolve,reject:l.reject}:{}}function Gn(l,f,m,v,_){var E=ve;try{return wn(l,!0),f(m,v,_)}finally{wn(E,!1)}}function ih(l,f,m,v){return typeof l!="function"?l:function(){var _=ve;m&&Di(),wn(f,!0);try{return l.apply(this,arguments)}finally{wn(_,!1),v&&queueMicrotask(_n)}}}function Kc(l){Promise===ie&&xt.echoes===0?Hs===0?l():enqueueNativeMicroTask(l):setTimeout(l,0)}(""+hr).indexOf("[native code]")===-1&&(Di=_n=Ke);var lt=oe.reject,Wn="",Vr="Invalid key provided. Keys must be of type string, number, Date or Array<string | number | Date>.",ah="String expected.",Mi=[],Ws="__dbnames",Gc="readonly",Wc="readwrite";function Vn(l,f){return l?f?function(){return l.apply(this,arguments)&&f.apply(this,arguments)}:l:f}var sh={type:3,lower:-1/0,lowerOpen:!1,upper:[[]],upperOpen:!1};function Vs(l){return typeof l!="string"||/\./.test(l)?function(f){return f}:function(f){return f[l]===void 0&&l in f&&delete(f=Ve(f))[l],f}}function oh(){throw we.Type()}function He(l,f){try{var m=ch(l),v=ch(f);if(m!==v)return m==="Array"?1:v==="Array"?-1:m==="binary"?1:v==="binary"?-1:m==="string"?1:v==="string"?-1:m==="Date"?1:v!=="Date"?NaN:-1;switch(m){case"number":case"Date":case"string":return f<l?1:l<f?-1:0;case"binary":return(function(_,E){for(var x=_.length,k=E.length,R=x<k?x:k,$=0;$<R;++$)if(_[$]!==E[$])return _[$]<E[$]?-1:1;return x===k?0:x<k?-1:1})(uh(l),uh(f));case"Array":return(function(_,E){for(var x=_.length,k=E.length,R=x<k?x:k,$=0;$<R;++$){var N=He(_[$],E[$]);if(N!==0)return N}return x===k?0:x<k?-1:1})(l,f)}}catch{}return NaN}function ch(l){var f=typeof l;return f!="object"?f:ArrayBuffer.isView(l)?"binary":(l=H(l),l==="ArrayBuffer"?"binary":l)}function uh(l){return l instanceof Uint8Array?l:ArrayBuffer.isView(l)?new Uint8Array(l.buffer,l.byteOffset,l.byteLength):new Uint8Array(l)}var lh=(nt.prototype._trans=function(l,f,m){var v=this._tx||ve.trans,_=this.name,E=Dt&&typeof console<"u"&&console.createTask&&console.createTask("Dexie: ".concat(l==="readonly"?"read":"write"," ").concat(this.name));function x($,N,I){if(!I.schema[_])throw new we.NotFound("Table "+_+" not part of transaction");return f(I.idbtrans,I)}var k=Pi();try{var R=v&&v.db._novip===this.db._novip?v===ve.trans?v._promise(l,x,m):vn(function(){return v._promise(l,x,m)},{trans:v,transless:ve.transless||ve}):(function $(N,I,M,A){if(N.idbdb&&(N._state.openComplete||ve.letThrough||N._vip)){var P=N._createTransaction(I,M,N._dbSchema);try{P.create(),N._state.PR1398_maxLoop=3}catch(D){return D.name===qn.InvalidState&&N.isOpen()&&0<--N._state.PR1398_maxLoop?(console.warn("Dexie: Need to reopen db"),N.close({disableAutoOpen:!1}),N.open().then(function(){return $(N,I,M,A)})):lt(D)}return P._promise(I,function(D,C){return vn(function(){return ve.trans=P,A(D,C,P)})}).then(function(D){if(I==="readwrite")try{P.idbtrans.commit()}catch{}return I==="readonly"?D:P._completion.then(function(){return D})})}if(N._state.openComplete)return lt(new we.DatabaseClosed(N._state.dbOpenError));if(!N._state.isBeingOpened){if(!N._state.autoOpen)return lt(new we.DatabaseClosed);N.open().catch(Ke)}return N._state.dbReadyPromise.then(function(){return $(N,I,M,A)})})(this.db,l,[this.name],x);return E&&(R._consoleTask=E,R=R.catch(function($){return console.trace($),lt($)})),R}finally{k&&Ni()}},nt.prototype.get=function(l,f){var m=this;return l&&l.constructor===Object?this.where(l).first(f):l==null?lt(new we.Type("Invalid argument to Table.get()")):this._trans("readonly",function(v){return m.core.get({trans:v,key:l}).then(function(_){return m.hook.reading.fire(_)})}).then(f)},nt.prototype.where=function(l){if(typeof l=="string")return new this.db.WhereClause(this,l);if(o(l))return new this.db.WhereClause(this,"[".concat(l.join("+"),"]"));var f=s(l);if(f.length===1)return this.where(f[0]).equals(l[f[0]]);var m=this.schema.indexes.concat(this.schema.primKey).filter(function(k){if(k.compound&&f.every(function($){return 0<=k.keyPath.indexOf($)})){for(var R=0;R<f.length;++R)if(f.indexOf(k.keyPath[R])===-1)return!1;return!0}return!1}).sort(function(k,R){return k.keyPath.length-R.keyPath.length})[0];if(m&&this.db._maxKey!==Wn){var E=m.keyPath.slice(0,f.length);return this.where(E).equals(E.map(function(R){return l[R]}))}!m&&Dt&&console.warn("The query ".concat(JSON.stringify(l)," on ").concat(this.name," would benefit from a ")+"compound index [".concat(f.join("+"),"]"));var v=this.schema.idxByName;function _(k,R){return He(k,R)===0}var x=f.reduce(function(I,R){var $=I[0],N=I[1],I=v[R],M=l[R];return[$||I,$||!I?Vn(N,I&&I.multi?function(A){return A=G(A,R),o(A)&&A.some(function(P){return _(M,P)})}:function(A){return _(M,G(A,R))}):N]},[null,null]),E=x[0],x=x[1];return E?this.where(E.name).equals(l[E.keyPath]).filter(x):m?this.filter(x):this.where(f).equals("")},nt.prototype.filter=function(l){return this.toCollection().and(l)},nt.prototype.count=function(l){return this.toCollection().count(l)},nt.prototype.offset=function(l){return this.toCollection().offset(l)},nt.prototype.limit=function(l){return this.toCollection().limit(l)},nt.prototype.each=function(l){return this.toCollection().each(l)},nt.prototype.toArray=function(l){return this.toCollection().toArray(l)},nt.prototype.toCollection=function(){return new this.db.Collection(new this.db.WhereClause(this))},nt.prototype.orderBy=function(l){return new this.db.Collection(new this.db.WhereClause(this,o(l)?"[".concat(l.join("+"),"]"):l))},nt.prototype.reverse=function(){return this.toCollection().reverse()},nt.prototype.mapToClass=function(l){var f,m=this.db,v=this.name;function _(){return f!==null&&f.apply(this,arguments)||this}(this.schema.mappedClass=l).prototype instanceof oh&&((function(R,$){if(typeof $!="function"&&$!==null)throw new TypeError("Class extends value "+String($)+" is not a constructor or null");function N(){this.constructor=R}r(R,$),R.prototype=$===null?Object.create($):(N.prototype=$.prototype,new N)})(_,f=l),Object.defineProperty(_.prototype,"db",{get:function(){return m},enumerable:!1,configurable:!0}),_.prototype.table=function(){return v},l=_);for(var E=new Set,x=l.prototype;x;x=u(x))Object.getOwnPropertyNames(x).forEach(function(R){return E.add(R)});function k(R){if(!R)return R;var $,N=Object.create(l.prototype);for($ in R)if(!E.has($))try{N[$]=R[$]}catch{}return N}return this.schema.readHook&&this.hook.reading.unsubscribe(this.schema.readHook),this.schema.readHook=k,this.hook("reading",k),l},nt.prototype.defineClass=function(){return this.mapToClass(function(l){c(this,l)})},nt.prototype.add=function(l,f){var m=this,v=this.schema.primKey,_=v.auto,E=v.keyPath,x=l;return E&&_&&(x=Vs(E)(l)),this._trans("readwrite",function(k){return m.core.mutate({trans:k,type:"add",keys:f!=null?[f]:null,values:[x]})}).then(function(k){return k.numFailures?oe.reject(k.failures[0]):k.lastResult}).then(function(k){if(E)try{q(l,E,k)}catch{}return k})},nt.prototype.update=function(l,f){return typeof l!="object"||o(l)?this.where(":id").equals(l).modify(f):(l=G(l,this.schema.primKey.keyPath),l===void 0?lt(new we.InvalidArgument("Given object does not contain its primary key")):this.where(":id").equals(l).modify(f))},nt.prototype.put=function(l,f){var m=this,v=this.schema.primKey,_=v.auto,E=v.keyPath,x=l;return E&&_&&(x=Vs(E)(l)),this._trans("readwrite",function(k){return m.core.mutate({trans:k,type:"put",values:[x],keys:f!=null?[f]:null})}).then(function(k){return k.numFailures?oe.reject(k.failures[0]):k.lastResult}).then(function(k){if(E)try{q(l,E,k)}catch{}return k})},nt.prototype.delete=function(l){var f=this;return this._trans("readwrite",function(m){return f.core.mutate({trans:m,type:"delete",keys:[l]})}).then(function(m){return m.numFailures?oe.reject(m.failures[0]):void 0})},nt.prototype.clear=function(){var l=this;return this._trans("readwrite",function(f){return l.core.mutate({trans:f,type:"deleteRange",range:sh})}).then(function(f){return f.numFailures?oe.reject(f.failures[0]):void 0})},nt.prototype.bulkGet=function(l){var f=this;return this._trans("readonly",function(m){return f.core.getMany({keys:l,trans:m}).then(function(v){return v.map(function(_){return f.hook.reading.fire(_)})})})},nt.prototype.bulkAdd=function(l,f,m){var v=this,_=Array.isArray(f)?f:void 0,E=(m=m||(_?void 0:f))?m.allKeys:void 0;return this._trans("readwrite",function(x){var $=v.schema.primKey,k=$.auto,$=$.keyPath;if($&&_)throw new we.InvalidArgument("bulkAdd(): keys argument invalid on tables with inbound keys");if(_&&_.length!==l.length)throw new we.InvalidArgument("Arguments objects and keys must have the same length");var R=l.length,$=$&&k?l.map(Vs($)):l;return v.core.mutate({trans:x,type:"add",keys:_,values:$,wantResults:E}).then(function(P){var I=P.numFailures,M=P.results,A=P.lastResult,P=P.failures;if(I===0)return E?M:A;throw new _t("".concat(v.name,".bulkAdd(): ").concat(I," of ").concat(R," operations failed"),P)})})},nt.prototype.bulkPut=function(l,f,m){var v=this,_=Array.isArray(f)?f:void 0,E=(m=m||(_?void 0:f))?m.allKeys:void 0;return this._trans("readwrite",function(x){var $=v.schema.primKey,k=$.auto,$=$.keyPath;if($&&_)throw new we.InvalidArgument("bulkPut(): keys argument invalid on tables with inbound keys");if(_&&_.length!==l.length)throw new we.InvalidArgument("Arguments objects and keys must have the same length");var R=l.length,$=$&&k?l.map(Vs($)):l;return v.core.mutate({trans:x,type:"put",keys:_,values:$,wantResults:E}).then(function(P){var I=P.numFailures,M=P.results,A=P.lastResult,P=P.failures;if(I===0)return E?M:A;throw new _t("".concat(v.name,".bulkPut(): ").concat(I," of ").concat(R," operations failed"),P)})})},nt.prototype.bulkUpdate=function(l){var f=this,m=this.core,v=l.map(function(x){return x.key}),_=l.map(function(x){return x.changes}),E=[];return this._trans("readwrite",function(x){return m.getMany({trans:x,keys:v,cache:"clone"}).then(function(k){var R=[],$=[];l.forEach(function(I,M){var A=I.key,P=I.changes,D=k[M];if(D){for(var C=0,L=Object.keys(P);C<L.length;C++){var j=L[C],F=P[j];if(j===f.schema.primKey.keyPath){if(He(F,A)!==0)throw new we.Constraint("Cannot update primary key in bulkUpdate()")}else q(D,j,F)}E.push(M),R.push(A),$.push(D)}});var N=R.length;return m.mutate({trans:x,type:"put",keys:R,values:$,updates:{keys:v,changeSpecs:_}}).then(function(I){var M=I.numFailures,A=I.failures;if(M===0)return N;for(var P=0,D=Object.keys(A);P<D.length;P++){var C,L=D[P],j=E[Number(L)];j!=null&&(C=A[L],delete A[L],A[j]=C)}throw new _t("".concat(f.name,".bulkUpdate(): ").concat(M," of ").concat(N," operations failed"),A)})})})},nt.prototype.bulkDelete=function(l){var f=this,m=l.length;return this._trans("readwrite",function(v){return f.core.mutate({trans:v,type:"delete",keys:l})}).then(function(x){var _=x.numFailures,E=x.lastResult,x=x.failures;if(_===0)return E;throw new _t("".concat(f.name,".bulkDelete(): ").concat(_," of ").concat(m," operations failed"),x)})},nt);function nt(){}function Ea(l){function f(x,k){if(k){for(var R=arguments.length,$=new Array(R-1);--R;)$[R-1]=arguments[R];return m[x].subscribe.apply(null,$),l}if(typeof x=="string")return m[x]}var m={};f.addEventType=E;for(var v=1,_=arguments.length;v<_;++v)E(arguments[v]);return f;function E(x,k,R){if(typeof x!="object"){var $;k=k||Fc;var N={subscribers:[],fire:R=R||Ke,subscribe:function(I){N.subscribers.indexOf(I)===-1&&(N.subscribers.push(I),N.fire=k(N.fire,I))},unsubscribe:function(I){N.subscribers=N.subscribers.filter(function(M){return M!==I}),N.fire=N.subscribers.reduce(k,R)}};return m[x]=f[x]=N}s($=x).forEach(function(I){var M=$[I];if(o(M))E(I,$[I][0],$[I][1]);else{if(M!=="asap")throw new we.InvalidArgument("Invalid event config");var A=E(I,br,function(){for(var P=arguments.length,D=new Array(P);P--;)D[P]=arguments[P];A.subscribers.forEach(function(C){B(function(){C.apply(null,D)})})})}})}}function xa(l,f){return w(f).from({prototype:l}),f}function Li(l,f){return!(l.filter||l.algorithm||l.or)&&(f?l.justLimit:!l.replayFilter)}function Vc(l,f){l.filter=Vn(l.filter,f)}function Zc(l,f,m){var v=l.replayFilter;l.replayFilter=v?function(){return Vn(v(),f())}:f,l.justLimit=m&&!v}function Zs(l,f){if(l.isPrimKey)return f.primaryKey;var m=f.getIndexByKeyPath(l.index);if(!m)throw new we.Schema("KeyPath "+l.index+" on object store "+f.name+" is not indexed");return m}function dh(l,f,m){var v=Zs(l,f.schema);return f.openCursor({trans:m,values:!l.keysOnly,reverse:l.dir==="prev",unique:!!l.unique,query:{index:v,range:l.range}})}function Js(l,f,m,v){var _=l.replayFilter?Vn(l.filter,l.replayFilter()):l.filter;if(l.or){var E={},x=function(k,R,$){var N,I;_&&!_(R,$,function(M){return R.stop(M)},function(M){return R.fail(M)})||((I=""+(N=R.primaryKey))=="[object ArrayBuffer]"&&(I=""+new Uint8Array(N)),h(E,I)||(E[I]=!0,f(k,R,$)))};return Promise.all([l.or._iterate(x,m),fh(dh(l,v,m),l.algorithm,x,!l.keysOnly&&l.valueMapper)])}return fh(dh(l,v,m),Vn(l.algorithm,_),f,!l.keysOnly&&l.valueMapper)}function fh(l,f,m,v){var _=at(v?function(E,x,k){return m(v(E),x,k)}:m);return l.then(function(E){if(E)return E.start(function(){var x=function(){return E.continue()};f&&!f(E,function(k){return x=k},function(k){E.stop(k),x=Ke},function(k){E.fail(k),x=Ke})||_(E.value,E,function(k){return x=k}),x()})})}var Zr=Symbol(),Sa=(hh.prototype.execute=function(l){if(this.add!==void 0){var f=this.add;if(o(f))return i(i([],o(l)?l:[],!0),f).sort();if(typeof f=="number")return(Number(l)||0)+f;if(typeof f=="bigint")try{return BigInt(l)+f}catch{return BigInt(0)+f}throw new TypeError("Invalid term ".concat(f))}if(this.remove!==void 0){var m=this.remove;if(o(m))return o(l)?l.filter(function(v){return!m.includes(v)}).sort():[];if(typeof m=="number")return Number(l)-m;if(typeof m=="bigint")try{return BigInt(l)-m}catch{return BigInt(0)-m}throw new TypeError("Invalid subtrahend ".concat(m))}return f=(f=this.replacePrefix)===null||f===void 0?void 0:f[0],f&&typeof l=="string"&&l.startsWith(f)?this.replacePrefix[1]+l.substring(f.length):l},hh);function hh(l){Object.assign(this,l)}var Vw=(Ze.prototype._read=function(l,f){var m=this._ctx;return m.error?m.table._trans(null,lt.bind(null,m.error)):m.table._trans("readonly",l).then(f)},Ze.prototype._write=function(l){var f=this._ctx;return f.error?f.table._trans(null,lt.bind(null,f.error)):f.table._trans("readwrite",l,"locked")},Ze.prototype._addAlgorithm=function(l){var f=this._ctx;f.algorithm=Vn(f.algorithm,l)},Ze.prototype._iterate=function(l,f){return Js(this._ctx,l,f,this._ctx.table.core)},Ze.prototype.clone=function(l){var f=Object.create(this.constructor.prototype),m=Object.create(this._ctx);return l&&c(m,l),f._ctx=m,f},Ze.prototype.raw=function(){return this._ctx.valueMapper=null,this},Ze.prototype.each=function(l){var f=this._ctx;return this._read(function(m){return Js(f,l,m,f.table.core)})},Ze.prototype.count=function(l){var f=this;return this._read(function(m){var v=f._ctx,_=v.table.core;if(Li(v,!0))return _.count({trans:m,query:{index:Zs(v,_.schema),range:v.range}}).then(function(x){return Math.min(x,v.limit)});var E=0;return Js(v,function(){return++E,!1},m,_).then(function(){return E})}).then(l)},Ze.prototype.sortBy=function(l,f){var m=l.split(".").reverse(),v=m[0],_=m.length-1;function E(R,$){return $?E(R[m[$]],$-1):R[v]}var x=this._ctx.dir==="next"?1:-1;function k(R,$){return He(E(R,_),E($,_))*x}return this.toArray(function(R){return R.sort(k)}).then(f)},Ze.prototype.toArray=function(l){var f=this;return this._read(function(m){var v=f._ctx;if(v.dir==="next"&&Li(v,!0)&&0<v.limit){var _=v.valueMapper,E=Zs(v,v.table.core.schema);return v.table.core.query({trans:m,limit:v.limit,values:!0,query:{index:E,range:v.range}}).then(function(k){return k=k.result,_?k.map(_):k})}var x=[];return Js(v,function(k){return x.push(k)},m,v.table.core).then(function(){return x})},l)},Ze.prototype.offset=function(l){var f=this._ctx;return l<=0||(f.offset+=l,Li(f)?Zc(f,function(){var m=l;return function(v,_){return m===0||(m===1?--m:_(function(){v.advance(m),m=0}),!1)}}):Zc(f,function(){var m=l;return function(){return--m<0}})),this},Ze.prototype.limit=function(l){return this._ctx.limit=Math.min(this._ctx.limit,l),Zc(this._ctx,function(){var f=l;return function(m,v,_){return--f<=0&&v(_),0<=f}},!0),this},Ze.prototype.until=function(l,f){return Vc(this._ctx,function(m,v,_){return!l(m.value)||(v(_),f)}),this},Ze.prototype.first=function(l){return this.limit(1).toArray(function(f){return f[0]}).then(l)},Ze.prototype.last=function(l){return this.reverse().first(l)},Ze.prototype.filter=function(l){var f;return Vc(this._ctx,function(m){return l(m.value)}),(f=this._ctx).isMatch=Vn(f.isMatch,l),this},Ze.prototype.and=function(l){return this.filter(l)},Ze.prototype.or=function(l){return new this.db.WhereClause(this._ctx.table,l,this)},Ze.prototype.reverse=function(){return this._ctx.dir=this._ctx.dir==="prev"?"next":"prev",this._ondirectionchange&&this._ondirectionchange(this._ctx.dir),this},Ze.prototype.desc=function(){return this.reverse()},Ze.prototype.eachKey=function(l){var f=this._ctx;return f.keysOnly=!f.isMatch,this.each(function(m,v){l(v.key,v)})},Ze.prototype.eachUniqueKey=function(l){return this._ctx.unique="unique",this.eachKey(l)},Ze.prototype.eachPrimaryKey=function(l){var f=this._ctx;return f.keysOnly=!f.isMatch,this.each(function(m,v){l(v.primaryKey,v)})},Ze.prototype.keys=function(l){var f=this._ctx;f.keysOnly=!f.isMatch;var m=[];return this.each(function(v,_){m.push(_.key)}).then(function(){return m}).then(l)},Ze.prototype.primaryKeys=function(l){var f=this._ctx;if(f.dir==="next"&&Li(f,!0)&&0<f.limit)return this._read(function(v){var _=Zs(f,f.table.core.schema);return f.table.core.query({trans:v,values:!1,limit:f.limit,query:{index:_,range:f.range}})}).then(function(v){return v.result}).then(l);f.keysOnly=!f.isMatch;var m=[];return this.each(function(v,_){m.push(_.primaryKey)}).then(function(){return m}).then(l)},Ze.prototype.uniqueKeys=function(l){return this._ctx.unique="unique",this.keys(l)},Ze.prototype.firstKey=function(l){return this.limit(1).keys(function(f){return f[0]}).then(l)},Ze.prototype.lastKey=function(l){return this.reverse().firstKey(l)},Ze.prototype.distinct=function(){var l=this._ctx,l=l.index&&l.table.schema.idxByName[l.index];if(!l||!l.multi)return this;var f={};return Vc(this._ctx,function(_){var v=_.primaryKey.toString(),_=h(f,v);return f[v]=!0,!_}),this},Ze.prototype.modify=function(l){var f=this,m=this._ctx;return this._write(function(v){var _,E,x;x=typeof l=="function"?l:(_=s(l),E=_.length,function(C){for(var L=!1,j=0;j<E;++j){var F=_[j],U=l[F],W=G(C,F);U instanceof Sa?(q(C,F,U.execute(W)),L=!0):W!==U&&(q(C,F,U),L=!0)}return L});var k=m.table.core,I=k.schema.primaryKey,R=I.outbound,$=I.extractKey,N=200,I=f.db._options.modifyChunkSize;I&&(N=typeof I=="object"?I[k.name]||I["*"]||200:I);function M(C,F){var j=F.failures,F=F.numFailures;P+=C-F;for(var U=0,W=s(j);U<W.length;U++){var ae=W[U];A.push(j[ae])}}var A=[],P=0,D=[];return f.clone().primaryKeys().then(function(C){function L(F){var U=Math.min(N,C.length-F);return k.getMany({trans:v,keys:C.slice(F,F+U),cache:"immutable"}).then(function(W){for(var ae=[],V=[],X=R?[]:null,se=[],ne=0;ne<U;++ne){var de=W[ne],Me={value:Ve(de),primKey:C[F+ne]};x.call(Me,Me.value,Me)!==!1&&(Me.value==null?se.push(C[F+ne]):R||He($(de),$(Me.value))===0?(V.push(Me.value),R&&X.push(C[F+ne])):(se.push(C[F+ne]),ae.push(Me.value)))}return Promise.resolve(0<ae.length&&k.mutate({trans:v,type:"add",values:ae}).then(function(Fe){for(var Be in Fe.failures)se.splice(parseInt(Be),1);M(ae.length,Fe)})).then(function(){return(0<V.length||j&&typeof l=="object")&&k.mutate({trans:v,type:"put",keys:X,values:V,criteria:j,changeSpec:typeof l!="function"&&l,isAdditionalChunk:0<F}).then(function(Fe){return M(V.length,Fe)})}).then(function(){return(0<se.length||j&&l===Jc)&&k.mutate({trans:v,type:"delete",keys:se,criteria:j,isAdditionalChunk:0<F}).then(function(Fe){return M(se.length,Fe)})}).then(function(){return C.length>F+U&&L(F+N)})})}var j=Li(m)&&m.limit===1/0&&(typeof l!="function"||l===Jc)&&{index:m.index,range:m.range};return L(0).then(function(){if(0<A.length)throw new je("Error modifying one or more objects",A,P,D);return C.length})})})},Ze.prototype.delete=function(){var l=this._ctx,f=l.range;return Li(l)&&(l.isPrimKey||f.type===3)?this._write(function(m){var v=l.table.core.schema.primaryKey,_=f;return l.table.core.count({trans:m,query:{index:v,range:_}}).then(function(E){return l.table.core.mutate({trans:m,type:"deleteRange",range:_}).then(function(x){var k=x.failures;if(x.lastResult,x.results,x=x.numFailures,x)throw new je("Could not delete some values",Object.keys(k).map(function(R){return k[R]}),E-x);return E-x})})}):this.modify(Jc)},Ze);function Ze(){}var Jc=function(l,f){return f.value=null};function Zw(l,f){return l<f?-1:l===f?0:1}function Jw(l,f){return f<l?-1:l===f?0:1}function Qt(l,f,m){return l=l instanceof mh?new l.Collection(l):l,l._ctx.error=new(m||TypeError)(f),l}function ji(l){return new l.Collection(l,function(){return ph("")}).limit(0)}function Qs(l,f,m,v){var _,E,x,k,R,$,N,I=m.length;if(!m.every(function(P){return typeof P=="string"}))return Qt(l,ah);function M(P){_=P==="next"?function(C){return C.toUpperCase()}:function(C){return C.toLowerCase()},E=P==="next"?function(C){return C.toLowerCase()}:function(C){return C.toUpperCase()},x=P==="next"?Zw:Jw;var D=m.map(function(C){return{lower:E(C),upper:_(C)}}).sort(function(C,L){return x(C.lower,L.lower)});k=D.map(function(C){return C.upper}),R=D.map(function(C){return C.lower}),N=($=P)==="next"?"":v}M("next"),l=new l.Collection(l,function(){return bn(k[0],R[I-1]+v)}),l._ondirectionchange=function(P){M(P)};var A=0;return l._addAlgorithm(function(P,D,C){var L=P.key;if(typeof L!="string")return!1;var j=E(L);if(f(j,R,A))return!0;for(var F=null,U=A;U<I;++U){var W=(function(ae,V,X,se,ne,de){for(var Me=Math.min(ae.length,se.length),Fe=-1,Be=0;Be<Me;++Be){var Yt=V[Be];if(Yt!==se[Be])return ne(ae[Be],X[Be])<0?ae.substr(0,Be)+X[Be]+X.substr(Be+1):ne(ae[Be],se[Be])<0?ae.substr(0,Be)+se[Be]+X.substr(Be+1):0<=Fe?ae.substr(0,Fe)+V[Fe]+X.substr(Fe+1):null;ne(ae[Be],Yt)<0&&(Fe=Be)}return Me<se.length&&de==="next"?ae+X.substr(ae.length):Me<ae.length&&de==="prev"?ae.substr(0,X.length):Fe<0?null:ae.substr(0,Fe)+se[Fe]+X.substr(Fe+1)})(L,j,k[U],R[U],x,$);W===null&&F===null?A=U+1:(F===null||0<x(F,W))&&(F=W)}return D(F!==null?function(){P.continue(F+N)}:C),!1}),l}function bn(l,f,m,v){return{type:2,lower:l,upper:f,lowerOpen:m,upperOpen:v}}function ph(l){return{type:1,lower:l,upper:l}}var mh=(Object.defineProperty(St.prototype,"Collection",{get:function(){return this._ctx.table.db.Collection},enumerable:!1,configurable:!0}),St.prototype.between=function(l,f,m,v){m=m!==!1,v=v===!0;try{return 0<this._cmp(l,f)||this._cmp(l,f)===0&&(m||v)&&(!m||!v)?ji(this):new this.Collection(this,function(){return bn(l,f,!m,!v)})}catch{return Qt(this,Vr)}},St.prototype.equals=function(l){return l==null?Qt(this,Vr):new this.Collection(this,function(){return ph(l)})},St.prototype.above=function(l){return l==null?Qt(this,Vr):new this.Collection(this,function(){return bn(l,void 0,!0)})},St.prototype.aboveOrEqual=function(l){return l==null?Qt(this,Vr):new this.Collection(this,function(){return bn(l,void 0,!1)})},St.prototype.below=function(l){return l==null?Qt(this,Vr):new this.Collection(this,function(){return bn(void 0,l,!1,!0)})},St.prototype.belowOrEqual=function(l){return l==null?Qt(this,Vr):new this.Collection(this,function(){return bn(void 0,l)})},St.prototype.startsWith=function(l){return typeof l!="string"?Qt(this,ah):this.between(l,l+Wn,!0,!0)},St.prototype.startsWithIgnoreCase=function(l){return l===""?this.startsWith(l):Qs(this,function(f,m){return f.indexOf(m[0])===0},[l],Wn)},St.prototype.equalsIgnoreCase=function(l){return Qs(this,function(f,m){return f===m[0]},[l],"")},St.prototype.anyOfIgnoreCase=function(){var l=re.apply(Y,arguments);return l.length===0?ji(this):Qs(this,function(f,m){return m.indexOf(f)!==-1},l,"")},St.prototype.startsWithAnyOfIgnoreCase=function(){var l=re.apply(Y,arguments);return l.length===0?ji(this):Qs(this,function(f,m){return m.some(function(v){return f.indexOf(v)===0})},l,Wn)},St.prototype.anyOf=function(){var l=this,f=re.apply(Y,arguments),m=this._cmp;try{f.sort(m)}catch{return Qt(this,Vr)}if(f.length===0)return ji(this);var v=new this.Collection(this,function(){return bn(f[0],f[f.length-1])});v._ondirectionchange=function(E){m=E==="next"?l._ascending:l._descending,f.sort(m)};var _=0;return v._addAlgorithm(function(E,x,k){for(var R=E.key;0<m(R,f[_]);)if(++_===f.length)return x(k),!1;return m(R,f[_])===0||(x(function(){E.continue(f[_])}),!1)}),v},St.prototype.notEqual=function(l){return this.inAnyRange([[-1/0,l],[l,this.db._maxKey]],{includeLowers:!1,includeUppers:!1})},St.prototype.noneOf=function(){var l=re.apply(Y,arguments);if(l.length===0)return new this.Collection(this);try{l.sort(this._ascending)}catch{return Qt(this,Vr)}var f=l.reduce(function(m,v){return m?m.concat([[m[m.length-1][1],v]]):[[-1/0,v]]},null);return f.push([l[l.length-1],this.db._maxKey]),this.inAnyRange(f,{includeLowers:!1,includeUppers:!1})},St.prototype.inAnyRange=function(L,f){var m=this,v=this._cmp,_=this._ascending,E=this._descending,x=this._min,k=this._max;if(L.length===0)return ji(this);if(!L.every(function(j){return j[0]!==void 0&&j[1]!==void 0&&_(j[0],j[1])<=0}))return Qt(this,"First argument to inAnyRange() must be an Array of two-value Arrays [lower,upper] where upper must not be lower than lower",we.InvalidArgument);var R=!f||f.includeLowers!==!1,$=f&&f.includeUppers===!0,N,I=_;function M(j,F){return I(j[0],F[0])}try{(N=L.reduce(function(j,F){for(var U=0,W=j.length;U<W;++U){var ae=j[U];if(v(F[0],ae[1])<0&&0<v(F[1],ae[0])){ae[0]=x(ae[0],F[0]),ae[1]=k(ae[1],F[1]);break}}return U===W&&j.push(F),j},[])).sort(M)}catch{return Qt(this,Vr)}var A=0,P=$?function(j){return 0<_(j,N[A][1])}:function(j){return 0<=_(j,N[A][1])},D=R?function(j){return 0<E(j,N[A][0])}:function(j){return 0<=E(j,N[A][0])},C=P,L=new this.Collection(this,function(){return bn(N[0][0],N[N.length-1][1],!R,!$)});return L._ondirectionchange=function(j){I=j==="next"?(C=P,_):(C=D,E),N.sort(M)},L._addAlgorithm(function(j,F,U){for(var W,ae=j.key;C(ae);)if(++A===N.length)return F(U),!1;return!P(W=ae)&&!D(W)||(m._cmp(ae,N[A][1])===0||m._cmp(ae,N[A][0])===0||F(function(){I===_?j.continue(N[A][0]):j.continue(N[A][1])}),!1)}),L},St.prototype.startsWithAnyOf=function(){var l=re.apply(Y,arguments);return l.every(function(f){return typeof f=="string"})?l.length===0?ji(this):this.inAnyRange(l.map(function(f){return[f,f+Wn]})):Qt(this,"startsWithAnyOf() only works with strings")},St);function St(){}function Mr(l){return at(function(f){return ka(f),l(f.target.error),!1})}function ka(l){l.stopPropagation&&l.stopPropagation(),l.preventDefault&&l.preventDefault()}var Ia="storagemutated",Qc="x-storagemutated-1",En=Ea(null,Ia),Qw=(Lr.prototype._lock=function(){return z(!ve.global),++this._reculock,this._reculock!==1||ve.global||(ve.lockOwnerFor=this),this},Lr.prototype._unlock=function(){if(z(!ve.global),--this._reculock==0)for(ve.global||(ve.lockOwnerFor=null);0<this._blockedFuncs.length&&!this._locked();){var l=this._blockedFuncs.shift();try{Gn(l[1],l[0])}catch{}}return this},Lr.prototype._locked=function(){return this._reculock&&ve.lockOwnerFor!==this},Lr.prototype.create=function(l){var f=this;if(!this.mode)return this;var m=this.db.idbdb,v=this.db._state.dbOpenError;if(z(!this.idbtrans),!l&&!m)switch(v&&v.name){case"DatabaseClosedError":throw new we.DatabaseClosed(v);case"MissingAPIError":throw new we.MissingAPI(v.message,v);default:throw new we.OpenFailed(v)}if(!this.active)throw new we.TransactionInactive;return z(this._completion._state===null),(l=this.idbtrans=l||(this.db.core||m).transaction(this.storeNames,this.mode,{durability:this.chromeTransactionDurability})).onerror=at(function(_){ka(_),f._reject(l.error)}),l.onabort=at(function(_){ka(_),f.active&&f._reject(new we.Abort(l.error)),f.active=!1,f.on("abort").fire(_)}),l.oncomplete=at(function(){f.active=!1,f._resolve(),"mutatedParts"in l&&En.storagemutated.fire(l.mutatedParts)}),this},Lr.prototype._promise=function(l,f,m){var v=this;if(l==="readwrite"&&this.mode!=="readwrite")return lt(new we.ReadOnly("Transaction is readonly"));if(!this.active)return lt(new we.TransactionInactive);if(this._locked())return new oe(function(E,x){v._blockedFuncs.push([function(){v._promise(l,f,m).then(E,x)},ve])});if(m)return vn(function(){var E=new oe(function(x,k){v._lock();var R=f(x,k,v);R&&R.then&&R.then(x,k)});return E.finally(function(){return v._unlock()}),E._lib=!0,E});var _=new oe(function(E,x){var k=f(E,x,v);k&&k.then&&k.then(E,x)});return _._lib=!0,_},Lr.prototype._root=function(){return this.parent?this.parent._root():this},Lr.prototype.waitFor=function(l){var f,m=this._root(),v=oe.resolve(l);m._waitingFor?m._waitingFor=m._waitingFor.then(function(){return v}):(m._waitingFor=v,m._waitingQueue=[],f=m.idbtrans.objectStore(m.storeNames[0]),(function E(){for(++m._spinCount;m._waitingQueue.length;)m._waitingQueue.shift()();m._waitingFor&&(f.get(-1/0).onsuccess=E)})());var _=m._waitingFor;return new oe(function(E,x){v.then(function(k){return m._waitingQueue.push(at(E.bind(null,k)))},function(k){return m._waitingQueue.push(at(x.bind(null,k)))}).finally(function(){m._waitingFor===_&&(m._waitingFor=null)})})},Lr.prototype.abort=function(){this.active&&(this.active=!1,this.idbtrans&&this.idbtrans.abort(),this._reject(new we.Abort))},Lr.prototype.table=function(l){var f=this._memoizedTables||(this._memoizedTables={});if(h(f,l))return f[l];var m=this.schema[l];if(!m)throw new we.NotFound("Table "+l+" not part of transaction");return m=new this.db.Table(l,m,this),m.core=this.db.core.table(l),f[l]=m},Lr);function Lr(){}function Yc(l,f,m,v,_,E,x){return{name:l,keyPath:f,unique:m,multi:v,auto:_,compound:E,src:(m&&!x?"&":"")+(v?"*":"")+(_?"++":"")+gh(f)}}function gh(l){return typeof l=="string"?l:l?"["+[].join.call(l,"+")+"]":""}function Xc(l,f,m){return{name:l,primKey:f,indexes:m,mappedClass:null,idxByName:(v=function(_){return[_.name,_]},m.reduce(function(_,E,x){return x=v(E,x),x&&(_[x[0]]=x[1]),_},{}))};var v}var Oa=function(l){try{return l.only([[]]),Oa=function(){return[[]]},[[]]}catch{return Oa=function(){return Wn},Wn}};function eu(l){return l==null?function(){}:typeof l=="string"?(f=l).split(".").length===1?function(m){return m[f]}:function(m){return G(m,f)}:function(m){return G(m,l)};var f}function yh(l){return[].slice.call(l)}var Yw=0;function Ta(l){return l==null?":id":typeof l=="string"?l:"[".concat(l.join("+"),"]")}function Xw(l,f,R){function v(C){if(C.type===3)return null;if(C.type===4)throw new Error("Cannot convert never type to IDBKeyRange");var A=C.lower,P=C.upper,D=C.lowerOpen,C=C.upperOpen;return A===void 0?P===void 0?null:f.upperBound(P,!!C):P===void 0?f.lowerBound(A,!!D):f.bound(A,P,!!D,!!C)}function _(M){var A,P=M.name;return{name:P,schema:M,mutate:function(D){var C=D.trans,L=D.type,j=D.keys,F=D.values,U=D.range;return new Promise(function(W,ae){W=at(W);var V=C.objectStore(P),X=V.keyPath==null,se=L==="put"||L==="add";if(!se&&L!=="delete"&&L!=="deleteRange")throw new Error("Invalid operation type: "+L);var ne,de=(j||F||{length:1}).length;if(j&&F&&j.length!==F.length)throw new Error("Given keys array must have same length as given values array.");if(de===0)return W({numFailures:0,failures:{},results:[],lastResult:void 0});function Me(Mt){++Yt,ka(Mt)}var Fe=[],Be=[],Yt=0;if(L==="deleteRange"){if(U.type===4)return W({numFailures:Yt,failures:Be,results:[],lastResult:void 0});U.type===3?Fe.push(ne=V.clear()):Fe.push(ne=V.delete(v(U)))}else{var X=se?X?[F,j]:[F,null]:[j,null],Ne=X[0],$t=X[1];if(se)for(var Ct=0;Ct<de;++Ct)Fe.push(ne=$t&&$t[Ct]!==void 0?V[L](Ne[Ct],$t[Ct]):V[L](Ne[Ct])),ne.onerror=Me;else for(Ct=0;Ct<de;++Ct)Fe.push(ne=V[L](Ne[Ct])),ne.onerror=Me}function lo(Mt){Mt=Mt.target.result,Fe.forEach(function(Qn,vu){return Qn.error!=null&&(Be[vu]=Qn.error)}),W({numFailures:Yt,failures:Be,results:L==="delete"?j:Fe.map(function(Qn){return Qn.result}),lastResult:Mt})}ne.onerror=function(Mt){Me(Mt),lo(Mt)},ne.onsuccess=lo})},getMany:function(D){var C=D.trans,L=D.keys;return new Promise(function(j,F){j=at(j);for(var U,W=C.objectStore(P),ae=L.length,V=new Array(ae),X=0,se=0,ne=function(Fe){Fe=Fe.target,V[Fe._pos]=Fe.result,++se===X&&j(V)},de=Mr(F),Me=0;Me<ae;++Me)L[Me]!=null&&((U=W.get(L[Me]))._pos=Me,U.onsuccess=ne,U.onerror=de,++X);X===0&&j(V)})},get:function(D){var C=D.trans,L=D.key;return new Promise(function(j,F){j=at(j);var U=C.objectStore(P).get(L);U.onsuccess=function(W){return j(W.target.result)},U.onerror=Mr(F)})},query:(A=$,function(D){return new Promise(function(C,L){C=at(C);var j,F,U,X=D.trans,W=D.values,ae=D.limit,ne=D.query,V=ae===1/0?void 0:ae,se=ne.index,ne=ne.range,X=X.objectStore(P),se=se.isPrimaryKey?X:X.index(se.name),ne=v(ne);if(ae===0)return C({result:[]});A?((V=W?se.getAll(ne,V):se.getAllKeys(ne,V)).onsuccess=function(de){return C({result:de.target.result})},V.onerror=Mr(L)):(j=0,F=!W&&"openKeyCursor"in se?se.openKeyCursor(ne):se.openCursor(ne),U=[],F.onsuccess=function(de){var Me=F.result;return Me?(U.push(W?Me.value:Me.primaryKey),++j===ae?C({result:U}):void Me.continue()):C({result:U})},F.onerror=Mr(L))})}),openCursor:function(D){var C=D.trans,L=D.values,j=D.query,F=D.reverse,U=D.unique;return new Promise(function(W,ae){W=at(W);var se=j.index,V=j.range,X=C.objectStore(P),X=se.isPrimaryKey?X:X.index(se.name),se=F?U?"prevunique":"prev":U?"nextunique":"next",ne=!L&&"openKeyCursor"in X?X.openKeyCursor(v(V),se):X.openCursor(v(V),se);ne.onerror=Mr(ae),ne.onsuccess=at(function(de){var Me,Fe,Be,Yt,Ne=ne.result;Ne?(Ne.___id=++Yw,Ne.done=!1,Me=Ne.continue.bind(Ne),Fe=(Fe=Ne.continuePrimaryKey)&&Fe.bind(Ne),Be=Ne.advance.bind(Ne),Yt=function(){throw new Error("Cursor not stopped")},Ne.trans=C,Ne.stop=Ne.continue=Ne.continuePrimaryKey=Ne.advance=function(){throw new Error("Cursor not started")},Ne.fail=at(ae),Ne.next=function(){var $t=this,Ct=1;return this.start(function(){return Ct--?$t.continue():$t.stop()}).then(function(){return $t})},Ne.start=function($t){function Ct(){if(ne.result)try{$t()}catch(Mt){Ne.fail(Mt)}else Ne.done=!0,Ne.start=function(){throw new Error("Cursor behind last entry")},Ne.stop()}var lo=new Promise(function(Mt,Qn){Mt=at(Mt),ne.onerror=Mr(Qn),Ne.fail=Qn,Ne.stop=function(vu){Ne.stop=Ne.continue=Ne.continuePrimaryKey=Ne.advance=Yt,Mt(vu)}});return ne.onsuccess=at(function(Mt){ne.onsuccess=Ct,Ct()}),Ne.continue=Me,Ne.continuePrimaryKey=Fe,Ne.advance=Be,Ct(),lo},W(Ne)):W(null)},ae)})},count:function(D){var C=D.query,L=D.trans,j=C.index,F=C.range;return new Promise(function(U,W){var ae=L.objectStore(P),V=j.isPrimaryKey?ae:ae.index(j.name),ae=v(F),V=ae?V.count(ae):V.count();V.onsuccess=at(function(X){return U(X.target.result)}),V.onerror=Mr(W)})}}}var E,x,k,N=(x=R,k=yh((E=l).objectStoreNames),{schema:{name:E.name,tables:k.map(function(M){return x.objectStore(M)}).map(function(M){var A=M.keyPath,C=M.autoIncrement,P=o(A),D={},C={name:M.name,primaryKey:{name:null,isPrimaryKey:!0,outbound:A==null,compound:P,keyPath:A,autoIncrement:C,unique:!0,extractKey:eu(A)},indexes:yh(M.indexNames).map(function(L){return M.index(L)}).map(function(U){var j=U.name,F=U.unique,W=U.multiEntry,U=U.keyPath,W={name:j,compound:o(U),keyPath:U,unique:F,multiEntry:W,extractKey:eu(U)};return D[Ta(U)]=W}),getIndexByKeyPath:function(L){return D[Ta(L)]}};return D[":id"]=C.primaryKey,A!=null&&(D[Ta(A)]=C.primaryKey),C})},hasGetAll:0<k.length&&"getAll"in x.objectStore(k[0])&&!(typeof navigator<"u"&&/Safari/.test(navigator.userAgent)&&!/(Chrome\/|Edge\/)/.test(navigator.userAgent)&&[].concat(navigator.userAgent.match(/Safari\/(\d*)/))[1]<604)}),R=N.schema,$=N.hasGetAll,N=R.tables.map(_),I={};return N.forEach(function(M){return I[M.name]=M}),{stack:"dbcore",transaction:l.transaction.bind(l),table:function(M){if(!I[M])throw new Error("Table '".concat(M,"' not found"));return I[M]},MIN_KEY:-1/0,MAX_KEY:Oa(f),schema:R}}function eb(l,f,m,v){var _=m.IDBKeyRange;return m.indexedDB,{dbcore:(v=Xw(f,_,v),l.dbcore.reduce(function(E,x){return x=x.create,n(n({},E),x(E))},v))}}function Ys(l,v){var m=v.db,v=eb(l._middlewares,m,l._deps,v);l.core=v.dbcore,l.tables.forEach(function(_){var E=_.name;l.core.schema.tables.some(function(x){return x.name===E})&&(_.core=l.core.table(E),l[E]instanceof l.Table&&(l[E].core=_.core))})}function Xs(l,f,m,v){m.forEach(function(_){var E=v[_];f.forEach(function(x){var k=(function R($,N){return b($,N)||($=u($))&&R($,N)})(x,_);(!k||"value"in k&&k.value===void 0)&&(x===l.Transaction.prototype||x instanceof l.Transaction?g(x,_,{get:function(){return this.table(_)},set:function(R){y(this,_,{value:R,writable:!0,configurable:!0,enumerable:!0})}}):x[_]=new l.Table(_,E))})})}function tu(l,f){f.forEach(function(m){for(var v in m)m[v]instanceof l.Table&&delete m[v]})}function tb(l,f){return l._cfg.version-f._cfg.version}function rb(l,f,m,v){var _=l._dbSchema;m.objectStoreNames.contains("$meta")&&!_.$meta&&(_.$meta=Xc("$meta",_h("")[0],[]),l._storeNames.push("$meta"));var E=l._createTransaction("readwrite",l._storeNames,_);E.create(m),E._completion.catch(v);var x=E._reject.bind(E),k=ve.transless||ve;vn(function(){return ve.trans=E,ve.transless=k,f!==0?(Ys(l,m),$=f,((R=E).storeNames.includes("$meta")?R.table("$meta").get("version").then(function(N){return N??$}):oe.resolve($)).then(function(N){return M=N,A=E,P=m,D=[],N=(I=l)._versions,C=I._dbSchema=to(0,I.idbdb,P),(N=N.filter(function(L){return L._cfg.version>=M})).length!==0?(N.forEach(function(L){D.push(function(){var j=C,F=L._cfg.dbschema;ro(I,j,P),ro(I,F,P),C=I._dbSchema=F;var U=ru(j,F);U.add.forEach(function(se){nu(P,se[0],se[1].primKey,se[1].indexes)}),U.change.forEach(function(se){if(se.recreate)throw new we.Upgrade("Not yet support for changing primary key");var ne=P.objectStore(se.name);se.add.forEach(function(de){return eo(ne,de)}),se.change.forEach(function(de){ne.deleteIndex(de.name),eo(ne,de)}),se.del.forEach(function(de){return ne.deleteIndex(de)})});var W=L._cfg.contentUpgrade;if(W&&L._cfg.version>M){Ys(I,P),A._memoizedTables={};var ae=K(F);U.del.forEach(function(se){ae[se]=j[se]}),tu(I,[I.Transaction.prototype]),Xs(I,[I.Transaction.prototype],s(ae),ae),A.schema=ae;var V,X=xe(W);return X&&Di(),U=oe.follow(function(){var se;(V=W(A))&&X&&(se=_n.bind(null,null),V.then(se,se))}),V&&typeof V.then=="function"?oe.resolve(V):U.then(function(){return V})}}),D.push(function(j){var F,U,W=L._cfg.dbschema;F=W,U=j,[].slice.call(U.db.objectStoreNames).forEach(function(ae){return F[ae]==null&&U.db.deleteObjectStore(ae)}),tu(I,[I.Transaction.prototype]),Xs(I,[I.Transaction.prototype],I._storeNames,I._dbSchema),A.schema=I._dbSchema}),D.push(function(j){I.idbdb.objectStoreNames.contains("$meta")&&(Math.ceil(I.idbdb.version/10)===L._cfg.version?(I.idbdb.deleteObjectStore("$meta"),delete I._dbSchema.$meta,I._storeNames=I._storeNames.filter(function(F){return F!=="$meta"})):j.objectStore("$meta").put(L._cfg.version,"version"))})}),(function L(){return D.length?oe.resolve(D.shift()(A.idbtrans)).then(L):oe.resolve()})().then(function(){vh(C,P)})):oe.resolve();var I,M,A,P,D,C}).catch(x)):(s(_).forEach(function(N){nu(m,N,_[N].primKey,_[N].indexes)}),Ys(l,m),void oe.follow(function(){return l.on.populate.fire(E)}).catch(x));var R,$})}function nb(l,f){vh(l._dbSchema,f),f.db.version%10!=0||f.objectStoreNames.contains("$meta")||f.db.createObjectStore("$meta").add(Math.ceil(f.db.version/10-1),"version");var m=to(0,l.idbdb,f);ro(l,l._dbSchema,f);for(var v=0,_=ru(m,l._dbSchema).change;v<_.length;v++){var E=(function(x){if(x.change.length||x.recreate)return console.warn("Unable to patch indexes of table ".concat(x.name," because it has changes on the type of index or primary key.")),{value:void 0};var k=f.objectStore(x.name);x.add.forEach(function(R){Dt&&console.debug("Dexie upgrade patch: Creating missing index ".concat(x.name,".").concat(R.src)),eo(k,R)})})(_[v]);if(typeof E=="object")return E.value}}function ru(l,f){var m,v={del:[],add:[],change:[]};for(m in l)f[m]||v.del.push(m);for(m in f){var _=l[m],E=f[m];if(_){var x={name:m,def:E,recreate:!1,del:[],add:[],change:[]};if(""+(_.primKey.keyPath||"")!=""+(E.primKey.keyPath||"")||_.primKey.auto!==E.primKey.auto)x.recreate=!0,v.change.push(x);else{var k=_.idxByName,R=E.idxByName,$=void 0;for($ in k)R[$]||x.del.push($);for($ in R){var N=k[$],I=R[$];N?N.src!==I.src&&x.change.push(I):x.add.push(I)}(0<x.del.length||0<x.add.length||0<x.change.length)&&v.change.push(x)}}else v.add.push([m,E])}return v}function nu(l,f,m,v){var _=l.db.createObjectStore(f,m.keyPath?{keyPath:m.keyPath,autoIncrement:m.auto}:{autoIncrement:m.auto});return v.forEach(function(E){return eo(_,E)}),_}function vh(l,f){s(l).forEach(function(m){f.db.objectStoreNames.contains(m)||(Dt&&console.debug("Dexie: Creating missing table",m),nu(f,m,l[m].primKey,l[m].indexes))})}function eo(l,f){l.createIndex(f.name,f.keyPath,{unique:f.unique,multiEntry:f.multi})}function to(l,f,m){var v={};return O(f.objectStoreNames,0).forEach(function(_){for(var E=m.objectStore(_),x=Yc(gh($=E.keyPath),$||"",!0,!1,!!E.autoIncrement,$&&typeof $!="string",!0),k=[],R=0;R<E.indexNames.length;++R){var N=E.index(E.indexNames[R]),$=N.keyPath,N=Yc(N.name,$,!!N.unique,!!N.multiEntry,!1,$&&typeof $!="string",!1);k.push(N)}v[_]=Xc(_,x,k)}),v}function ro(l,f,m){for(var v=m.db.objectStoreNames,_=0;_<v.length;++_){var E=v[_],x=m.objectStore(E);l._hasGetAll="getAll"in x;for(var k=0;k<x.indexNames.length;++k){var R=x.indexNames[k],$=x.index(R).keyPath,N=typeof $=="string"?$:"["+O($).join("+")+"]";!f[E]||($=f[E].idxByName[N])&&($.name=R,delete f[E].idxByName[N],f[E].idxByName[R]=$)}}typeof navigator<"u"&&/Safari/.test(navigator.userAgent)&&!/(Chrome\/|Edge\/)/.test(navigator.userAgent)&&a.WorkerGlobalScope&&a instanceof a.WorkerGlobalScope&&[].concat(navigator.userAgent.match(/Safari\/(\d*)/))[1]<604&&(l._hasGetAll=!1)}function _h(l){return l.split(",").map(function(f,m){var v=(f=f.trim()).replace(/([&*]|\+\+)/g,""),_=/^\[/.test(v)?v.match(/^\[(.*)\]$/)[1].split("+"):v;return Yc(v,_||null,/\&/.test(f),/\*/.test(f),/\+\+/.test(f),o(_),m===0)})}var ib=(no.prototype._parseStoresSpec=function(l,f){s(l).forEach(function(m){if(l[m]!==null){var v=_h(l[m]),_=v.shift();if(_.unique=!0,_.multi)throw new we.Schema("Primary key cannot be multi-valued");v.forEach(function(E){if(E.auto)throw new we.Schema("Only primary key can be marked as autoIncrement (++)");if(!E.keyPath)throw new we.Schema("Index must have a name and cannot be an empty string")}),f[m]=Xc(m,_,v)}})},no.prototype.stores=function(m){var f=this.db;this._cfg.storesSource=this._cfg.storesSource?c(this._cfg.storesSource,m):m;var m=f._versions,v={},_={};return m.forEach(function(E){c(v,E._cfg.storesSource),_=E._cfg.dbschema={},E._parseStoresSpec(v,_)}),f._dbSchema=_,tu(f,[f._allTables,f,f.Transaction.prototype]),Xs(f,[f._allTables,f,f.Transaction.prototype,this._cfg.tables],s(_),_),f._storeNames=s(_),this},no.prototype.upgrade=function(l){return this._cfg.contentUpgrade=ce(this._cfg.contentUpgrade||Ke,l),this},no);function no(){}function iu(l,f){var m=l._dbNamesDB;return m||(m=l._dbNamesDB=new Jr(Ws,{addons:[],indexedDB:l,IDBKeyRange:f})).version(1).stores({dbnames:"name"}),m.table("dbnames")}function au(l){return l&&typeof l.databases=="function"}function su(l){return vn(function(){return ve.letThrough=!0,l()})}function ou(l){return!("from"in l)}var At=function(l,f){if(!this){var m=new At;return l&&"d"in l&&c(m,l),m}c(this,arguments.length?{d:1,from:l,to:1<arguments.length?f:l}:{d:0})};function Ra(l,f,m){var v=He(f,m);if(!isNaN(v)){if(0<v)throw RangeError();if(ou(l))return c(l,{from:f,to:m,d:1});var _=l.l,v=l.r;if(He(m,l.from)<0)return _?Ra(_,f,m):l.l={from:f,to:m,d:1,l:null,r:null},bh(l);if(0<He(f,l.to))return v?Ra(v,f,m):l.r={from:f,to:m,d:1,l:null,r:null},bh(l);He(f,l.from)<0&&(l.from=f,l.l=null,l.d=v?v.d+1:1),0<He(m,l.to)&&(l.to=m,l.r=null,l.d=l.l?l.l.d+1:1),m=!l.r,_&&!l.l&&Aa(l,_),v&&m&&Aa(l,v)}}function Aa(l,f){ou(f)||(function m(v,R){var E=R.from,x=R.to,k=R.l,R=R.r;Ra(v,E,x),k&&m(v,k),R&&m(v,R)})(l,f)}function wh(l,f){var m=io(f),v=m.next();if(v.done)return!1;for(var _=v.value,E=io(l),x=E.next(_.from),k=x.value;!v.done&&!x.done;){if(He(k.from,_.to)<=0&&0<=He(k.to,_.from))return!0;He(_.from,k.from)<0?_=(v=m.next(k.from)).value:k=(x=E.next(_.from)).value}return!1}function io(l){var f=ou(l)?null:{s:0,n:l};return{next:function(m){for(var v=0<arguments.length;f;)switch(f.s){case 0:if(f.s=1,v)for(;f.n.l&&He(m,f.n.from)<0;)f={up:f,n:f.n.l,s:1};else for(;f.n.l;)f={up:f,n:f.n.l,s:1};case 1:if(f.s=2,!v||He(m,f.n.to)<=0)return{value:f.n,done:!1};case 2:if(f.n.r){f.s=3,f={up:f,n:f.n.r,s:0};continue}case 3:f=f.up}return{done:!0}}}}function bh(l){var f,m,v=(((f=l.r)===null||f===void 0?void 0:f.d)||0)-(((m=l.l)===null||m===void 0?void 0:m.d)||0),_=1<v?"r":v<-1?"l":"";_&&(f=_=="r"?"l":"r",m=n({},l),v=l[_],l.from=v.from,l.to=v.to,l[_]=v[_],m[_]=v[f],(l[f]=m).d=Eh(m)),l.d=Eh(l)}function Eh(m){var f=m.r,m=m.l;return(f?m?Math.max(f.d,m.d):f.d:m?m.d:0)+1}function ao(l,f){return s(f).forEach(function(m){l[m]?Aa(l[m],f[m]):l[m]=(function v(_){var E,x,k={};for(E in _)h(_,E)&&(x=_[E],k[E]=!x||typeof x!="object"||qe.has(x.constructor)?x:v(x));return k})(f[m])}),l}function cu(l,f){return l.all||f.all||Object.keys(l).some(function(m){return f[m]&&wh(f[m],l[m])})}p(At.prototype,((hr={add:function(l){return Aa(this,l),this},addKey:function(l){return Ra(this,l,l),this},addKeys:function(l){var f=this;return l.forEach(function(m){return Ra(f,m,m)}),this},hasKey:function(l){var f=io(this).next(l).value;return f&&He(f.from,l)<=0&&0<=He(f.to,l)}})[fe]=function(){return io(this)},hr));var Zn={},uu={},lu=!1;function so(l){ao(uu,l),lu||(lu=!0,setTimeout(function(){lu=!1,du(uu,!(uu={}))},0))}function du(l,f){f===void 0&&(f=!1);var m=new Set;if(l.all)for(var v=0,_=Object.values(Zn);v<_.length;v++)xh(x=_[v],l,m,f);else for(var E in l){var x,k=/^idb\:\/\/(.*)\/(.*)\//.exec(E);k&&(E=k[1],k=k[2],(x=Zn["idb://".concat(E,"/").concat(k)])&&xh(x,l,m,f))}m.forEach(function(R){return R()})}function xh(l,f,m,v){for(var _=[],E=0,x=Object.entries(l.queries.query);E<x.length;E++){for(var k=x[E],R=k[0],$=[],N=0,I=k[1];N<I.length;N++){var M=I[N];cu(f,M.obsSet)?M.subscribers.forEach(function(C){return m.add(C)}):v&&$.push(M)}v&&_.push([R,$])}if(v)for(var A=0,P=_;A<P.length;A++){var D=P[A],R=D[0],$=D[1];l.queries.query[R]=$}}function ab(l){var f=l._state,m=l._deps.indexedDB;if(f.isBeingOpened||l.idbdb)return f.dbReadyPromise.then(function(){return f.dbOpenError?lt(f.dbOpenError):l});f.isBeingOpened=!0,f.dbOpenError=null,f.openComplete=!1;var v=f.openCanceller,_=Math.round(10*l.verno),E=!1;function x(){if(f.openCanceller!==v)throw new we.DatabaseClosed("db.open() was cancelled")}function k(){return new oe(function(M,A){if(x(),!m)throw new we.MissingAPI;var P=l.name,D=f.autoSchema||!_?m.open(P):m.open(P,_);if(!D)throw new we.MissingAPI;D.onerror=Mr(A),D.onblocked=at(l._fireOnBlocked),D.onupgradeneeded=at(function(C){var L;N=D.transaction,f.autoSchema&&!l._options.allowEmptyDB?(D.onerror=ka,N.abort(),D.result.close(),(L=m.deleteDatabase(P)).onsuccess=L.onerror=at(function(){A(new we.NoSuchDatabase("Database ".concat(P," doesnt exist")))})):(N.onerror=Mr(A),C=C.oldVersion>Math.pow(2,62)?0:C.oldVersion,I=C<1,l.idbdb=D.result,E&&nb(l,N),rb(l,C/10,N,A))},A),D.onsuccess=at(function(){N=null;var C,L,j,F,U,W=l.idbdb=D.result,ae=O(W.objectStoreNames);if(0<ae.length)try{var V=W.transaction((F=ae).length===1?F[0]:F,"readonly");if(f.autoSchema)L=W,j=V,(C=l).verno=L.version/10,j=C._dbSchema=to(0,L,j),C._storeNames=O(L.objectStoreNames,0),Xs(C,[C._allTables],s(j),j);else if(ro(l,l._dbSchema,V),((U=ru(to(0,(U=l).idbdb,V),U._dbSchema)).add.length||U.change.some(function(X){return X.add.length||X.change.length}))&&!E)return console.warn("Dexie SchemaDiff: Schema was extended without increasing the number passed to db.version(). Dexie will add missing parts and increment native version number to workaround this."),W.close(),_=W.version+1,E=!0,M(k());Ys(l,V)}catch{}Mi.push(l),W.onversionchange=at(function(X){f.vcFired=!0,l.on("versionchange").fire(X)}),W.onclose=at(function(X){l.on("close").fire(X)}),I&&(U=l._deps,V=P,W=U.indexedDB,U=U.IDBKeyRange,au(W)||V===Ws||iu(W,U).put({name:V}).catch(Ke)),M()},A)}).catch(function(M){switch(M?.name){case"UnknownError":if(0<f.PR1398_maxLoop)return f.PR1398_maxLoop--,console.warn("Dexie: Workaround for Chrome UnknownError on open()"),k();break;case"VersionError":if(0<_)return _=0,k()}return oe.reject(M)})}var R,$=f.dbReadyResolve,N=null,I=!1;return oe.race([v,(typeof navigator>"u"?oe.resolve():!navigator.userAgentData&&/Safari\//.test(navigator.userAgent)&&!/Chrom(e|ium)\//.test(navigator.userAgent)&&indexedDB.databases?new Promise(function(M){function A(){return indexedDB.databases().finally(M)}R=setInterval(A,100),A()}).finally(function(){return clearInterval(R)}):Promise.resolve()).then(k)]).then(function(){return x(),f.onReadyBeingFired=[],oe.resolve(su(function(){return l.on.ready.fire(l.vip)})).then(function M(){if(0<f.onReadyBeingFired.length){var A=f.onReadyBeingFired.reduce(ce,Ke);return f.onReadyBeingFired=[],oe.resolve(su(function(){return A(l.vip)})).then(M)}})}).finally(function(){f.openCanceller===v&&(f.onReadyBeingFired=null,f.isBeingOpened=!1)}).catch(function(M){f.dbOpenError=M;try{N&&N.abort()}catch{}return v===f.openCanceller&&l._close(),lt(M)}).finally(function(){f.openComplete=!0,$()}).then(function(){var M;return I&&(M={},l.tables.forEach(function(A){A.schema.indexes.forEach(function(P){P.name&&(M["idb://".concat(l.name,"/").concat(A.name,"/").concat(P.name)]=new At(-1/0,[[[]]]))}),M["idb://".concat(l.name,"/").concat(A.name,"/")]=M["idb://".concat(l.name,"/").concat(A.name,"/:dels")]=new At(-1/0,[[[]]])}),En(Ia).fire(M),du(M,!0)),l})}function fu(l){function f(E){return l.next(E)}var m=_(f),v=_(function(E){return l.throw(E)});function _(E){return function(R){var k=E(R),R=k.value;return k.done?R:R&&typeof R.then=="function"?R.then(m,v):o(R)?Promise.all(R).then(m,v):m(R)}}return _(f)()}function oo(l,f,m){for(var v=o(l)?l.slice():[l],_=0;_<m;++_)v.push(f);return v}var sb={stack:"dbcore",name:"VirtualIndexMiddleware",level:1,create:function(l){return n(n({},l),{table:function(f){var m=l.table(f),v=m.schema,_={},E=[];function x(I,M,A){var P=Ta(I),D=_[P]=_[P]||[],C=I==null?0:typeof I=="string"?1:I.length,L=0<M,L=n(n({},A),{name:L?"".concat(P,"(virtual-from:").concat(A.name,")"):A.name,lowLevelIndex:A,isVirtual:L,keyTail:M,keyLength:C,extractKey:eu(I),unique:!L&&A.unique});return D.push(L),L.isPrimaryKey||E.push(L),1<C&&x(C===2?I[0]:I.slice(0,C-1),M+1,A),D.sort(function(j,F){return j.keyTail-F.keyTail}),L}f=x(v.primaryKey.keyPath,0,v.primaryKey),_[":id"]=[f];for(var k=0,R=v.indexes;k<R.length;k++){var $=R[k];x($.keyPath,0,$)}function N(I){var M,A=I.query.index;return A.isVirtual?n(n({},I),{query:{index:A.lowLevelIndex,range:(M=I.query.range,A=A.keyTail,{type:M.type===1?2:M.type,lower:oo(M.lower,M.lowerOpen?l.MAX_KEY:l.MIN_KEY,A),lowerOpen:!0,upper:oo(M.upper,M.upperOpen?l.MIN_KEY:l.MAX_KEY,A),upperOpen:!0})}}):I}return n(n({},m),{schema:n(n({},v),{primaryKey:f,indexes:E,getIndexByKeyPath:function(I){return(I=_[Ta(I)])&&I[0]}}),count:function(I){return m.count(N(I))},query:function(I){return m.query(N(I))},openCursor:function(I){var M=I.query.index,A=M.keyTail,P=M.isVirtual,D=M.keyLength;return P?m.openCursor(N(I)).then(function(L){return L&&C(L)}):m.openCursor(I);function C(L){return Object.create(L,{continue:{value:function(j){j!=null?L.continue(oo(j,I.reverse?l.MAX_KEY:l.MIN_KEY,A)):I.unique?L.continue(L.key.slice(0,D).concat(I.reverse?l.MIN_KEY:l.MAX_KEY,A)):L.continue()}},continuePrimaryKey:{value:function(j,F){L.continuePrimaryKey(oo(j,l.MAX_KEY,A),F)}},primaryKey:{get:function(){return L.primaryKey}},key:{get:function(){var j=L.key;return D===1?j[0]:j.slice(0,D)}},value:{get:function(){return L.value}}})}}})}})}};function hu(l,f,m,v){return m=m||{},v=v||"",s(l).forEach(function(_){var E,x,k;h(f,_)?(E=l[_],x=f[_],typeof E=="object"&&typeof x=="object"&&E&&x?(k=H(E))!==H(x)?m[v+_]=f[_]:k==="Object"?hu(E,x,m,v+_+"."):E!==x&&(m[v+_]=f[_]):E!==x&&(m[v+_]=f[_])):m[v+_]=void 0}),s(f).forEach(function(_){h(l,_)||(m[v+_]=f[_])}),m}function pu(l,f){return f.type==="delete"?f.keys:f.keys||f.values.map(l.extractKey)}var ob={stack:"dbcore",name:"HooksMiddleware",level:2,create:function(l){return n(n({},l),{table:function(f){var m=l.table(f),v=m.schema.primaryKey;return n(n({},m),{mutate:function(_){var E=ve.trans,x=E.table(f).hook,k=x.deleting,R=x.creating,$=x.updating;switch(_.type){case"add":if(R.fire===Ke)break;return E._promise("readwrite",function(){return N(_)},!0);case"put":if(R.fire===Ke&&$.fire===Ke)break;return E._promise("readwrite",function(){return N(_)},!0);case"delete":if(k.fire===Ke)break;return E._promise("readwrite",function(){return N(_)},!0);case"deleteRange":if(k.fire===Ke)break;return E._promise("readwrite",function(){return(function I(M,A,P){return m.query({trans:M,values:!1,query:{index:v,range:A},limit:P}).then(function(D){var C=D.result;return N({type:"delete",keys:C,trans:M}).then(function(L){return 0<L.numFailures?Promise.reject(L.failures[0]):C.length<P?{failures:[],numFailures:0,lastResult:void 0}:I(M,n(n({},A),{lower:C[C.length-1],lowerOpen:!0}),P)})})})(_.trans,_.range,1e4)},!0)}return m.mutate(_);function N(I){var M,A,P,D=ve.trans,C=I.keys||pu(v,I);if(!C)throw new Error("Keys missing");return(I=I.type==="add"||I.type==="put"?n(n({},I),{keys:C}):n({},I)).type!=="delete"&&(I.values=i([],I.values)),I.keys&&(I.keys=i([],I.keys)),M=m,P=C,((A=I).type==="add"?Promise.resolve([]):M.getMany({trans:A.trans,keys:P,cache:"immutable"})).then(function(L){var j=C.map(function(F,U){var W,ae,V,X=L[U],se={onerror:null,onsuccess:null};return I.type==="delete"?k.fire.call(se,F,X,D):I.type==="add"||X===void 0?(W=R.fire.call(se,F,I.values[U],D),F==null&&W!=null&&(I.keys[U]=F=W,v.outbound||q(I.values[U],v.keyPath,F))):(W=hu(X,I.values[U]),(ae=$.fire.call(se,W,F,X,D))&&(V=I.values[U],Object.keys(ae).forEach(function(ne){h(V,ne)?V[ne]=ae[ne]:q(V,ne,ae[ne])}))),se});return m.mutate(I).then(function(F){for(var U=F.failures,W=F.results,ae=F.numFailures,F=F.lastResult,V=0;V<C.length;++V){var X=(W||C)[V],se=j[V];X==null?se.onerror&&se.onerror(U[V]):se.onsuccess&&se.onsuccess(I.type==="put"&&L[V]?I.values[V]:X)}return{failures:U,results:W,numFailures:ae,lastResult:F}}).catch(function(F){return j.forEach(function(U){return U.onerror&&U.onerror(F)}),Promise.reject(F)})})}}})}})}};function Sh(l,f,m){try{if(!f||f.keys.length<l.length)return null;for(var v=[],_=0,E=0;_<f.keys.length&&E<l.length;++_)He(f.keys[_],l[E])===0&&(v.push(m?Ve(f.values[_]):f.values[_]),++E);return v.length===l.length?v:null}catch{return null}}var cb={stack:"dbcore",level:-1,create:function(l){return{table:function(f){var m=l.table(f);return n(n({},m),{getMany:function(v){if(!v.cache)return m.getMany(v);var _=Sh(v.keys,v.trans._cache,v.cache==="clone");return _?oe.resolve(_):m.getMany(v).then(function(E){return v.trans._cache={keys:v.keys,values:v.cache==="clone"?Ve(E):E},E})},mutate:function(v){return v.type!=="add"&&(v.trans._cache=null),m.mutate(v)}})}}}};function kh(l,f){return l.trans.mode==="readonly"&&!!l.subscr&&!l.trans.explicit&&l.trans.db._options.cache!=="disabled"&&!f.schema.primaryKey.outbound}function Ih(l,f){switch(l){case"query":return f.values&&!f.unique;case"get":case"getMany":case"count":case"openCursor":return!1}}var ub={stack:"dbcore",level:0,name:"Observability",create:function(l){var f=l.schema.name,m=new At(l.MIN_KEY,l.MAX_KEY);return n(n({},l),{transaction:function(v,_,E){if(ve.subscr&&_!=="readonly")throw new we.ReadOnly("Readwrite transaction in liveQuery context. Querier source: ".concat(ve.querier));return l.transaction(v,_,E)},table:function(v){var _=l.table(v),E=_.schema,x=E.primaryKey,I=E.indexes,k=x.extractKey,R=x.outbound,$=x.autoIncrement&&I.filter(function(A){return A.compound&&A.keyPath.includes(x.keyPath)}),N=n(n({},_),{mutate:function(A){function P(ne){return ne="idb://".concat(f,"/").concat(v,"/").concat(ne),F[ne]||(F[ne]=new At)}var D,C,L,j=A.trans,F=A.mutatedParts||(A.mutatedParts={}),U=P(""),W=P(":dels"),ae=A.type,se=A.type==="deleteRange"?[A.range]:A.type==="delete"?[A.keys]:A.values.length<50?[pu(x,A).filter(function(ne){return ne}),A.values]:[],V=se[0],X=se[1],se=A.trans._cache;return o(V)?(U.addKeys(V),(se=ae==="delete"||V.length===X.length?Sh(V,se):null)||W.addKeys(V),(se||X)&&(D=P,C=se,L=X,E.indexes.forEach(function(ne){var de=D(ne.name||"");function Me(Be){return Be!=null?ne.extractKey(Be):null}function Fe(Be){return ne.multiEntry&&o(Be)?Be.forEach(function(Yt){return de.addKey(Yt)}):de.addKey(Be)}(C||L).forEach(function(Be,$t){var Ne=C&&Me(C[$t]),$t=L&&Me(L[$t]);He(Ne,$t)!==0&&(Ne!=null&&Fe(Ne),$t!=null&&Fe($t))})}))):V?(X={from:(X=V.lower)!==null&&X!==void 0?X:l.MIN_KEY,to:(X=V.upper)!==null&&X!==void 0?X:l.MAX_KEY},W.add(X),U.add(X)):(U.add(m),W.add(m),E.indexes.forEach(function(ne){return P(ne.name).add(m)})),_.mutate(A).then(function(ne){return!V||A.type!=="add"&&A.type!=="put"||(U.addKeys(ne.results),$&&$.forEach(function(de){for(var Me=A.values.map(function(Ne){return de.extractKey(Ne)}),Fe=de.keyPath.findIndex(function(Ne){return Ne===x.keyPath}),Be=0,Yt=ne.results.length;Be<Yt;++Be)Me[Be][Fe]=ne.results[Be];P(de.name).addKeys(Me)})),j.mutatedParts=ao(j.mutatedParts||{},F),ne})}}),I=function(P){var D=P.query,P=D.index,D=D.range;return[P,new At((P=D.lower)!==null&&P!==void 0?P:l.MIN_KEY,(D=D.upper)!==null&&D!==void 0?D:l.MAX_KEY)]},M={get:function(A){return[x,new At(A.key)]},getMany:function(A){return[x,new At().addKeys(A.keys)]},count:I,query:I,openCursor:I};return s(M).forEach(function(A){N[A]=function(P){var D=ve.subscr,C=!!D,L=kh(ve,_)&&Ih(A,P)?P.obsSet={}:D;if(C){var j=function(X){return X="idb://".concat(f,"/").concat(v,"/").concat(X),L[X]||(L[X]=new At)},F=j(""),U=j(":dels"),D=M[A](P),C=D[0],D=D[1];if((A==="query"&&C.isPrimaryKey&&!P.values?U:j(C.name||"")).add(D),!C.isPrimaryKey){if(A!=="count"){var W=A==="query"&&R&&P.values&&_.query(n(n({},P),{values:!1}));return _[A].apply(this,arguments).then(function(X){if(A==="query"){if(R&&P.values)return W.then(function(Me){return Me=Me.result,F.addKeys(Me),X});var se=P.values?X.result.map(k):X.result;(P.values?F:U).addKeys(se)}else if(A==="openCursor"){var ne=X,de=P.values;return ne&&Object.create(ne,{key:{get:function(){return U.addKey(ne.primaryKey),ne.key}},primaryKey:{get:function(){var Me=ne.primaryKey;return U.addKey(Me),Me}},value:{get:function(){return de&&F.addKey(ne.primaryKey),ne.value}}})}return X})}U.add(m)}}return _[A].apply(this,arguments)}}),N}})}};function Oh(l,f,m){if(m.numFailures===0)return f;if(f.type==="deleteRange")return null;var v=f.keys?f.keys.length:"values"in f&&f.values?f.values.length:1;return m.numFailures===v?null:(f=n({},f),o(f.keys)&&(f.keys=f.keys.filter(function(_,E){return!(E in m.failures)})),"values"in f&&o(f.values)&&(f.values=f.values.filter(function(_,E){return!(E in m.failures)})),f)}function mu(l,f){return m=l,((v=f).lower===void 0||(v.lowerOpen?0<He(m,v.lower):0<=He(m,v.lower)))&&(l=l,(f=f).upper===void 0||(f.upperOpen?He(l,f.upper)<0:He(l,f.upper)<=0));var m,v}function Th(l,f,M,v,_,E){if(!M||M.length===0)return l;var x=f.query.index,k=x.multiEntry,R=f.query.range,$=v.schema.primaryKey.extractKey,N=x.extractKey,I=(x.lowLevelIndex||x).extractKey,M=M.reduce(function(A,P){var D=A,C=[];if(P.type==="add"||P.type==="put")for(var L=new At,j=P.values.length-1;0<=j;--j){var F,U=P.values[j],W=$(U);L.hasKey(W)||(F=N(U),(k&&o(F)?F.some(function(ne){return mu(ne,R)}):mu(F,R))&&(L.addKey(W),C.push(U)))}switch(P.type){case"add":var ae=new At().addKeys(f.values?A.map(function(de){return $(de)}):A),D=A.concat(f.values?C.filter(function(de){return de=$(de),!ae.hasKey(de)&&(ae.addKey(de),!0)}):C.map(function(de){return $(de)}).filter(function(de){return!ae.hasKey(de)&&(ae.addKey(de),!0)}));break;case"put":var V=new At().addKeys(P.values.map(function(de){return $(de)}));D=A.filter(function(de){return!V.hasKey(f.values?$(de):de)}).concat(f.values?C:C.map(function(de){return $(de)}));break;case"delete":var X=new At().addKeys(P.keys);D=A.filter(function(de){return!X.hasKey(f.values?$(de):de)});break;case"deleteRange":var se=P.range;D=A.filter(function(de){return!mu($(de),se)})}return D},l);return M===l?l:(M.sort(function(A,P){return He(I(A),I(P))||He($(A),$(P))}),f.limit&&f.limit<1/0&&(M.length>f.limit?M.length=f.limit:l.length===f.limit&&M.length<f.limit&&(_.dirty=!0)),E?Object.freeze(M):M)}function Rh(l,f){return He(l.lower,f.lower)===0&&He(l.upper,f.upper)===0&&!!l.lowerOpen==!!f.lowerOpen&&!!l.upperOpen==!!f.upperOpen}function lb(l,f){return(function(m,v,_,E){if(m===void 0)return v!==void 0?-1:0;if(v===void 0)return 1;if((v=He(m,v))===0){if(_&&E)return 0;if(_)return 1;if(E)return-1}return v})(l.lower,f.lower,l.lowerOpen,f.lowerOpen)<=0&&0<=(function(m,v,_,E){if(m===void 0)return v!==void 0?1:0;if(v===void 0)return-1;if((v=He(m,v))===0){if(_&&E)return 0;if(_)return-1;if(E)return 1}return v})(l.upper,f.upper,l.upperOpen,f.upperOpen)}function db(l,f,m,v){l.subscribers.add(m),v.addEventListener("abort",function(){var _,E;l.subscribers.delete(m),l.subscribers.size===0&&(_=l,E=f,setTimeout(function(){_.subscribers.size===0&&te(E,_)},3e3))})}var fb={stack:"dbcore",level:0,name:"Cache",create:function(l){var f=l.schema.name;return n(n({},l),{transaction:function(m,v,_){var E,x,k=l.transaction(m,v,_);return v==="readwrite"&&(x=(E=new AbortController).signal,_=function(R){return function(){if(E.abort(),v==="readwrite"){for(var $=new Set,N=0,I=m;N<I.length;N++){var M=I[N],A=Zn["idb://".concat(f,"/").concat(M)];if(A){var P=l.table(M),D=A.optimisticOps.filter(function(de){return de.trans===k});if(k._explicit&&R&&k.mutatedParts)for(var C=0,L=Object.values(A.queries.query);C<L.length;C++)for(var j=0,F=(ae=L[C]).slice();j<F.length;j++)cu((V=F[j]).obsSet,k.mutatedParts)&&(te(ae,V),V.subscribers.forEach(function(de){return $.add(de)}));else if(0<D.length){A.optimisticOps=A.optimisticOps.filter(function(de){return de.trans!==k});for(var U=0,W=Object.values(A.queries.query);U<W.length;U++)for(var ae,V,X,se=0,ne=(ae=W[U]).slice();se<ne.length;se++)(V=ne[se]).res!=null&&k.mutatedParts&&(R&&!V.dirty?(X=Object.isFrozen(V.res),X=Th(V.res,V.req,D,P,V,X),V.dirty?(te(ae,V),V.subscribers.forEach(function(de){return $.add(de)})):X!==V.res&&(V.res=X,V.promise=oe.resolve({result:X}))):(V.dirty&&te(ae,V),V.subscribers.forEach(function(de){return $.add(de)})))}}}$.forEach(function(de){return de()})}}},k.addEventListener("abort",_(!1),{signal:x}),k.addEventListener("error",_(!1),{signal:x}),k.addEventListener("complete",_(!0),{signal:x})),k},table:function(m){var v=l.table(m),_=v.schema.primaryKey;return n(n({},v),{mutate:function(E){var x=ve.trans;if(_.outbound||x.db._options.cache==="disabled"||x.explicit||x.idbtrans.mode!=="readwrite")return v.mutate(E);var k=Zn["idb://".concat(f,"/").concat(m)];return k?(x=v.mutate(E),E.type!=="add"&&E.type!=="put"||!(50<=E.values.length||pu(_,E).some(function(R){return R==null}))?(k.optimisticOps.push(E),E.mutatedParts&&so(E.mutatedParts),x.then(function(R){0<R.numFailures&&(te(k.optimisticOps,E),(R=Oh(0,E,R))&&k.optimisticOps.push(R),E.mutatedParts&&so(E.mutatedParts))}),x.catch(function(){te(k.optimisticOps,E),E.mutatedParts&&so(E.mutatedParts)})):x.then(function(R){var $=Oh(0,n(n({},E),{values:E.values.map(function(N,I){var M;return R.failures[I]?N:(N=(M=_.keyPath)!==null&&M!==void 0&&M.includes(".")?Ve(N):n({},N),q(N,_.keyPath,R.results[I]),N)})}),R);k.optimisticOps.push($),queueMicrotask(function(){return E.mutatedParts&&so(E.mutatedParts)})}),x):v.mutate(E)},query:function(E){if(!kh(ve,v)||!Ih("query",E))return v.query(E);var x=(($=ve.trans)===null||$===void 0?void 0:$.db._options.cache)==="immutable",I=ve,k=I.requery,R=I.signal,$=(function(P,D,C,L){var j=Zn["idb://".concat(P,"/").concat(D)];if(!j)return[];if(!(D=j.queries[C]))return[null,!1,j,null];var F=D[(L.query?L.query.index.name:null)||""];if(!F)return[null,!1,j,null];switch(C){case"query":var U=F.find(function(W){return W.req.limit===L.limit&&W.req.values===L.values&&Rh(W.req.query.range,L.query.range)});return U?[U,!0,j,F]:[F.find(function(W){return("limit"in W.req?W.req.limit:1/0)>=L.limit&&(!L.values||W.req.values)&&lb(W.req.query.range,L.query.range)}),!1,j,F];case"count":return U=F.find(function(W){return Rh(W.req.query.range,L.query.range)}),[U,!!U,j,F]}})(f,m,"query",E),N=$[0],I=$[1],M=$[2],A=$[3];return N&&I?N.obsSet=E.obsSet:(I=v.query(E).then(function(P){var D=P.result;if(N&&(N.res=D),x){for(var C=0,L=D.length;C<L;++C)Object.freeze(D[C]);Object.freeze(D)}else P.result=Ve(D);return P}).catch(function(P){return A&&N&&te(A,N),Promise.reject(P)}),N={obsSet:E.obsSet,promise:I,subscribers:new Set,type:"query",req:E,dirty:!1},A?A.push(N):(A=[N],(M=M||(Zn["idb://".concat(f,"/").concat(m)]={queries:{query:{},count:{}},objs:new Map,optimisticOps:[],unsignaledParts:{}})).queries.query[E.query.index.name||""]=A)),db(N,A,k,R),N.promise.then(function(P){return{result:Th(P.result,E,M?.optimisticOps,v,N,x)}})}})}})}};function co(l,f){return new Proxy(l,{get:function(m,v,_){return v==="db"?f:Reflect.get(m,v,_)}})}var Jr=(dt.prototype.version=function(l){if(isNaN(l)||l<.1)throw new we.Type("Given version is not a positive number");if(l=Math.round(10*l)/10,this.idbdb||this._state.isBeingOpened)throw new we.Schema("Cannot add version when database is open");this.verno=Math.max(this.verno,l);var f=this._versions,m=f.filter(function(v){return v._cfg.version===l})[0];return m||(m=new this.Version(l),f.push(m),f.sort(tb),m.stores({}),this._state.autoSchema=!1,m)},dt.prototype._whenReady=function(l){var f=this;return this.idbdb&&(this._state.openComplete||ve.letThrough||this._vip)?l():new oe(function(m,v){if(f._state.openComplete)return v(new we.DatabaseClosed(f._state.dbOpenError));if(!f._state.isBeingOpened){if(!f._state.autoOpen)return void v(new we.DatabaseClosed);f.open().catch(Ke)}f._state.dbReadyPromise.then(m,v)}).then(l)},dt.prototype.use=function(l){var f=l.stack,m=l.create,v=l.level,_=l.name;return _&&this.unuse({stack:f,name:_}),l=this._middlewares[f]||(this._middlewares[f]=[]),l.push({stack:f,create:m,level:v??10,name:_}),l.sort(function(E,x){return E.level-x.level}),this},dt.prototype.unuse=function(l){var f=l.stack,m=l.name,v=l.create;return f&&this._middlewares[f]&&(this._middlewares[f]=this._middlewares[f].filter(function(_){return v?_.create!==v:!!m&&_.name!==m})),this},dt.prototype.open=function(){var l=this;return Gn(yn,function(){return ab(l)})},dt.prototype._close=function(){var l=this._state,f=Mi.indexOf(this);if(0<=f&&Mi.splice(f,1),this.idbdb){try{this.idbdb.close()}catch{}this.idbdb=null}l.isBeingOpened||(l.dbReadyPromise=new oe(function(m){l.dbReadyResolve=m}),l.openCanceller=new oe(function(m,v){l.cancelOpen=v}))},dt.prototype.close=function(m){var f=(m===void 0?{disableAutoOpen:!0}:m).disableAutoOpen,m=this._state;f?(m.isBeingOpened&&m.cancelOpen(new we.DatabaseClosed),this._close(),m.autoOpen=!1,m.dbOpenError=new we.DatabaseClosed):(this._close(),m.autoOpen=this._options.autoOpen||m.isBeingOpened,m.openComplete=!1,m.dbOpenError=null)},dt.prototype.delete=function(l){var f=this;l===void 0&&(l={disableAutoOpen:!0});var m=0<arguments.length&&typeof arguments[0]!="object",v=this._state;return new oe(function(_,E){function x(){f.close(l);var k=f._deps.indexedDB.deleteDatabase(f.name);k.onsuccess=at(function(){var R,$,N;R=f._deps,$=f.name,N=R.indexedDB,R=R.IDBKeyRange,au(N)||$===Ws||iu(N,R).delete($).catch(Ke),_()}),k.onerror=Mr(E),k.onblocked=f._fireOnBlocked}if(m)throw new we.InvalidArgument("Invalid closeOptions argument to db.delete()");v.isBeingOpened?v.dbReadyPromise.then(x):x()})},dt.prototype.backendDB=function(){return this.idbdb},dt.prototype.isOpen=function(){return this.idbdb!==null},dt.prototype.hasBeenClosed=function(){var l=this._state.dbOpenError;return l&&l.name==="DatabaseClosed"},dt.prototype.hasFailed=function(){return this._state.dbOpenError!==null},dt.prototype.dynamicallyOpened=function(){return this._state.autoSchema},Object.defineProperty(dt.prototype,"tables",{get:function(){var l=this;return s(this._allTables).map(function(f){return l._allTables[f]})},enumerable:!1,configurable:!0}),dt.prototype.transaction=function(){var l=(function(f,m,v){var _=arguments.length;if(_<2)throw new we.InvalidArgument("Too few arguments");for(var E=new Array(_-1);--_;)E[_-1]=arguments[_];return v=E.pop(),[f,Le(E),v]}).apply(this,arguments);return this._transaction.apply(this,l)},dt.prototype._transaction=function(l,f,m){var v=this,_=ve.trans;_&&_.db===this&&l.indexOf("!")===-1||(_=null);var E,x,k=l.indexOf("?")!==-1;l=l.replace("!","").replace("?","");try{if(x=f.map(function($){if($=$ instanceof v.Table?$.name:$,typeof $!="string")throw new TypeError("Invalid table argument to Dexie.transaction(). Only Table or String are allowed");return $}),l=="r"||l===Gc)E=Gc;else{if(l!="rw"&&l!=Wc)throw new we.InvalidArgument("Invalid transaction mode: "+l);E=Wc}if(_){if(_.mode===Gc&&E===Wc){if(!k)throw new we.SubTransaction("Cannot enter a sub-transaction with READWRITE mode when parent transaction is READONLY");_=null}_&&x.forEach(function($){if(_&&_.storeNames.indexOf($)===-1){if(!k)throw new we.SubTransaction("Table "+$+" not included in parent transaction.");_=null}}),k&&_&&!_.active&&(_=null)}}catch($){return _?_._promise(null,function(N,I){I($)}):lt($)}var R=(function $(N,I,M,A,P){return oe.resolve().then(function(){var D=ve.transless||ve,C=N._createTransaction(I,M,N._dbSchema,A);if(C.explicit=!0,D={trans:C,transless:D},A)C.idbtrans=A.idbtrans;else try{C.create(),C.idbtrans._explicit=!0,N._state.PR1398_maxLoop=3}catch(F){return F.name===qn.InvalidState&&N.isOpen()&&0<--N._state.PR1398_maxLoop?(console.warn("Dexie: Need to reopen db"),N.close({disableAutoOpen:!1}),N.open().then(function(){return $(N,I,M,null,P)})):lt(F)}var L,j=xe(P);return j&&Di(),D=oe.follow(function(){var F;(L=P.call(C,C))&&(j?(F=_n.bind(null,null),L.then(F,F)):typeof L.next=="function"&&typeof L.throw=="function"&&(L=fu(L)))},D),(L&&typeof L.then=="function"?oe.resolve(L).then(function(F){return C.active?F:lt(new we.PrematureCommit("Transaction committed too early. See http://bit.ly/2kdckMn"))}):D.then(function(){return L})).then(function(F){return A&&C._resolve(),C._completion.then(function(){return F})}).catch(function(F){return C._reject(F),lt(F)})})}).bind(null,this,E,x,_,m);return _?_._promise(E,R,"lock"):ve.trans?Gn(ve.transless,function(){return v._whenReady(R)}):this._whenReady(R)},dt.prototype.table=function(l){if(!h(this._allTables,l))throw new we.InvalidTable("Table ".concat(l," does not exist"));return this._allTables[l]},dt);function dt(l,f){var m=this;this._middlewares={},this.verno=0;var v=dt.dependencies;this._options=f=n({addons:dt.addons,autoOpen:!0,indexedDB:v.indexedDB,IDBKeyRange:v.IDBKeyRange,cache:"cloned"},f),this._deps={indexedDB:f.indexedDB,IDBKeyRange:f.IDBKeyRange},v=f.addons,this._dbSchema={},this._versions=[],this._storeNames=[],this._allTables={},this.idbdb=null,this._novip=this;var _,E,x,k,R,$={dbOpenError:null,isBeingOpened:!1,onReadyBeingFired:null,openComplete:!1,dbReadyResolve:Ke,dbReadyPromise:null,cancelOpen:Ke,openCanceller:null,autoSchema:!0,PR1398_maxLoop:3,autoOpen:f.autoOpen};$.dbReadyPromise=new oe(function(I){$.dbReadyResolve=I}),$.openCanceller=new oe(function(I,M){$.cancelOpen=M}),this._state=$,this.name=l,this.on=Ea(this,"populate","blocked","versionchange","close",{ready:[ce,Ke]}),this.on.ready.subscribe=T(this.on.ready.subscribe,function(I){return function(M,A){dt.vip(function(){var P,D=m._state;D.openComplete?(D.dbOpenError||oe.resolve().then(M),A&&I(M)):D.onReadyBeingFired?(D.onReadyBeingFired.push(M),A&&I(M)):(I(M),P=m,A||I(function C(){P.on.ready.unsubscribe(M),P.on.ready.unsubscribe(C)}))})}}),this.Collection=(_=this,xa(Vw.prototype,function(L,C){this.db=_;var A=sh,P=null;if(C)try{A=C()}catch(j){P=j}var D=L._ctx,C=D.table,L=C.hook.reading.fire;this._ctx={table:C,index:D.index,isPrimKey:!D.index||C.schema.primKey.keyPath&&D.index===C.schema.primKey.name,range:A,keysOnly:!1,dir:"next",unique:"",algorithm:null,filter:null,replayFilter:null,justLimit:!0,isMatch:null,offset:0,limit:1/0,error:P,or:D.or,valueMapper:L!==br?L:null}})),this.Table=(E=this,xa(lh.prototype,function(I,M,A){this.db=E,this._tx=A,this.name=I,this.schema=M,this.hook=E._allTables[I]?E._allTables[I].hook:Ea(null,{creating:[$i,Ke],reading:[Ai,br],updating:[Ci,Ke],deleting:[Fs,Ke]})})),this.Transaction=(x=this,xa(Qw.prototype,function(I,M,A,P,D){var C=this;this.db=x,this.mode=I,this.storeNames=M,this.schema=A,this.chromeTransactionDurability=P,this.idbtrans=null,this.on=Ea(this,"complete","error","abort"),this.parent=D||null,this.active=!0,this._reculock=0,this._blockedFuncs=[],this._resolve=null,this._reject=null,this._waitingFor=null,this._waitingQueue=null,this._spinCount=0,this._completion=new oe(function(L,j){C._resolve=L,C._reject=j}),this._completion.then(function(){C.active=!1,C.on.complete.fire()},function(L){var j=C.active;return C.active=!1,C.on.error.fire(L),C.parent?C.parent._reject(L):j&&C.idbtrans&&C.idbtrans.abort(),lt(L)})})),this.Version=(k=this,xa(ib.prototype,function(I){this.db=k,this._cfg={version:I,storesSource:null,dbschema:{},tables:{},contentUpgrade:null}})),this.WhereClause=(R=this,xa(mh.prototype,function(I,M,A){if(this.db=R,this._ctx={table:I,index:M===":id"?null:M,or:A},this._cmp=this._ascending=He,this._descending=function(P,D){return He(D,P)},this._max=function(P,D){return 0<He(P,D)?P:D},this._min=function(P,D){return He(P,D)<0?P:D},this._IDBKeyRange=R._deps.IDBKeyRange,!this._IDBKeyRange)throw new we.MissingAPI})),this.on("versionchange",function(I){0<I.newVersion?console.warn("Another connection wants to upgrade database '".concat(m.name,"'. Closing db now to resume the upgrade.")):console.warn("Another connection wants to delete database '".concat(m.name,"'. Closing db now to resume the delete request.")),m.close({disableAutoOpen:!1})}),this.on("blocked",function(I){!I.newVersion||I.newVersion<I.oldVersion?console.warn("Dexie.delete('".concat(m.name,"') was blocked")):console.warn("Upgrade '".concat(m.name,"' blocked by other connection holding version ").concat(I.oldVersion/10))}),this._maxKey=Oa(f.IDBKeyRange),this._createTransaction=function(I,M,A,P){return new m.Transaction(I,M,A,m._options.chromeTransactionDurability,P)},this._fireOnBlocked=function(I){m.on("blocked").fire(I),Mi.filter(function(M){return M.name===m.name&&M!==m&&!M._state.vcFired}).map(function(M){return M.on("versionchange").fire(I)})},this.use(cb),this.use(fb),this.use(ub),this.use(sb),this.use(ob);var N=new Proxy(this,{get:function(I,M,A){if(M==="_vip")return!0;if(M==="table")return function(D){return co(m.table(D),N)};var P=Reflect.get(I,M,A);return P instanceof lh?co(P,N):M==="tables"?P.map(function(D){return co(D,N)}):M==="_createTransaction"?function(){return co(P.apply(this,arguments),N)}:P}});this.vip=N,v.forEach(function(I){return I(m)})}var uo,hr=typeof Symbol<"u"&&"observable"in Symbol?Symbol.observable:"@@observable",hb=(gu.prototype.subscribe=function(l,f,m){return this._subscribe(l&&typeof l!="function"?l:{next:l,error:f,complete:m})},gu.prototype[hr]=function(){return this},gu);function gu(l){this._subscribe=l}try{uo={indexedDB:a.indexedDB||a.mozIndexedDB||a.webkitIndexedDB||a.msIndexedDB,IDBKeyRange:a.IDBKeyRange||a.webkitIDBKeyRange}}catch{uo={indexedDB:null,IDBKeyRange:null}}function Ah(l){var f,m=!1,v=new hb(function(_){var E=xe(l),x,k=!1,R={},$={},N={get closed(){return k},unsubscribe:function(){k||(k=!0,x&&x.abort(),I&&En.storagemutated.unsubscribe(A))}};_.start&&_.start(N);var I=!1,M=function(){return Kc(P)},A=function(D){ao(R,D),cu($,R)&&M()},P=function(){var D,C,L;!k&&uo.indexedDB&&(R={},D={},x&&x.abort(),x=new AbortController,L=(function(j){var F=Pi();try{E&&Di();var U=vn(l,j);return U=E?U.finally(_n):U}finally{F&&Ni()}})(C={subscr:D,signal:x.signal,requery:M,querier:l,trans:null}),Promise.resolve(L).then(function(j){m=!0,f=j,k||C.signal.aborted||(R={},(function(F){for(var U in F)if(h(F,U))return;return 1})($=D)||I||(En(Ia,A),I=!0),Kc(function(){return!k&&_.next&&_.next(j)}))},function(j){m=!1,["DatabaseClosedError","AbortError"].includes(j?.name)||k||Kc(function(){k||_.error&&_.error(j)})}))};return setTimeout(M,0),N});return v.hasValue=function(){return m},v.getValue=function(){return f},v}var Jn=Jr;function yu(l){var f=xn;try{xn=!0,En.storagemutated.fire(l),du(l,!0)}finally{xn=f}}p(Jn,n(n({},dr),{delete:function(l){return new Jn(l,{addons:[]}).delete()},exists:function(l){return new Jn(l,{addons:[]}).open().then(function(f){return f.close(),!0}).catch("NoSuchDatabaseError",function(){return!1})},getDatabaseNames:function(l){try{return f=Jn.dependencies,m=f.indexedDB,f=f.IDBKeyRange,(au(m)?Promise.resolve(m.databases()).then(function(v){return v.map(function(_){return _.name}).filter(function(_){return _!==Ws})}):iu(m,f).toCollection().primaryKeys()).then(l)}catch{return lt(new we.MissingAPI)}var f,m},defineClass:function(){return function(l){c(this,l)}},ignoreTransaction:function(l){return ve.trans?Gn(ve.transless,l):l()},vip:su,async:function(l){return function(){try{var f=fu(l.apply(this,arguments));return f&&typeof f.then=="function"?f:oe.resolve(f)}catch(m){return lt(m)}}},spawn:function(l,f,m){try{var v=fu(l.apply(m,f||[]));return v&&typeof v.then=="function"?v:oe.resolve(v)}catch(_){return lt(_)}},currentTransaction:{get:function(){return ve.trans||null}},waitFor:function(l,f){return f=oe.resolve(typeof l=="function"?Jn.ignoreTransaction(l):l).timeout(f||6e4),ve.trans?ve.trans.waitFor(f):f},Promise:oe,debug:{get:function(){return Dt},set:function(l){ke(l)}},derive:w,extend:c,props:p,override:T,Events:Ea,on:En,liveQuery:Ah,extendObservabilitySet:ao,getByKeyPath:G,setByKeyPath:q,delByKeyPath:function(l,f){typeof f=="string"?q(l,f,void 0):"length"in f&&[].map.call(f,function(m){q(l,m,void 0)})},shallowClone:K,deepClone:Ve,getObjectDiff:hu,cmp:He,asap:B,minKey:-1/0,addons:[],connections:Mi,errnames:qn,dependencies:uo,cache:Zn,semVer:"4.0.10",version:"4.0.10".split(".").map(function(l){return parseInt(l)}).reduce(function(l,f,m){return l+f/Math.pow(10,2*m)})})),Jn.maxKey=Oa(Jn.dependencies.IDBKeyRange),typeof dispatchEvent<"u"&&typeof addEventListener<"u"&&(En(Ia,function(l){xn||(l=new CustomEvent(Qc,{detail:l}),xn=!0,dispatchEvent(l),xn=!1)}),addEventListener(Qc,function(l){l=l.detail,xn||yu(l)}));var Fi,xn=!1,$h=function(){};return typeof BroadcastChannel<"u"&&(($h=function(){(Fi=new BroadcastChannel(Qc)).onmessage=function(l){return l.data&&yu(l.data)}})(),typeof Fi.unref=="function"&&Fi.unref(),En(Ia,function(l){xn||Fi.postMessage(l)})),typeof addEventListener<"u"&&(addEventListener("pagehide",function(l){if(!Jr.disableBfCache&&l.persisted){Dt&&console.debug("Dexie: handling persisted pagehide"),Fi?.close();for(var f=0,m=Mi;f<m.length;f++)m[f].close({disableAutoOpen:!1})}}),addEventListener("pageshow",function(l){!Jr.disableBfCache&&l.persisted&&(Dt&&console.debug("Dexie: handling persisted pageshow"),$h(),yu({all:new At(-1/0,[[]])}))})),oe.rejectionMapper=function(l,f){return!l||l instanceof Te||l instanceof TypeError||l instanceof SyntaxError||!l.name||!Nr[l.name]?l:(f=new Nr[l.name](f||l.message,l),"stack"in l&&g(f,"stack",{get:function(){return this.inner.stack}}),f)},ke(Dt),n(Jr,Object.freeze({__proto__:null,Dexie:Jr,liveQuery:Ah,Entity:oh,cmp:He,PropModSymbol:Zr,PropModification:Sa,replacePrefix:function(l,f){return new Sa({replacePrefix:[l,f]})},add:function(l){return new Sa({add:l})},remove:function(l){return new Sa({remove:l})},default:Jr,RangeSet:At,mergeRanges:Aa,rangesOverlap:wh}),{default:Jr}),Jr})})(Lo)),Lo.exports}var VI=WI();const Ed=fa(VI),_p=Symbol.for("Dexie"),tc=globalThis[_p]||(globalThis[_p]=Ed);if(Ed.semVer!==tc.semVer)throw new Error(`Two different versions of Dexie loaded in the same app: ${Ed.semVer} and ${tc.semVer}`);const{liveQuery:LN,mergeRanges:jN,rangesOverlap:FN,RangeSet:BN,cmp:zN,Entity:UN,PropModSymbol:qN,PropModification:HN,replacePrefix:KN,add:GN,remove:WN}=tc;var rc="docs",ZI="changes",wp="attachments",Yv="dexie",bp=new Map,jo=new Map;function JI(e,t,r,n){var i="rxdb-dexie-"+e+"--"+n.version+"--"+t,a=sn(bp,i,()=>{var s=(async()=>{var o=it(r);o.autoOpen=!1;var c=new tc(i,o),u={[rc]:XI(n),[ZI]:"++sequence, id",[wp]:"id"};return c.version(1).stores(u),await c.open(),{dexieDb:c,dexieTable:c[rc],dexieAttachmentsTable:c[wp],booleanIndexes:eO(n)}})();return bp.set(i,a),jo.set(a,0),s});return a}async function QI(e){var t=await e,r=jo.get(e),n=r-1;n===0?(t.dexieDb.close(),jo.delete(e)):jo.set(e,n)}var xd="__";function ya(e){var t=e.split(".");if(t.length>1)return t.map(n=>ya(n)).join(".");if(e.startsWith("|")){var r=e.substring(1);return xd+r}else return e}function Xv(e){var t=e.split(".");if(t.length>1)return t.map(n=>Xv(n)).join(".");if(e.startsWith(xd)){var r=e.substring(xd.length);return"|"+r}else return e}function YI(e,t){if(!t)return t;var r=it(t);return r=Sd(r),e.forEach(n=>{var i=Mn(t,n),a=i?"1":"0",s=ya(n);ly(r,s,a)}),r}function e_(e,t){return t&&(t=it(t),t=kd(t),e.forEach(r=>{var n=Mn(t,r),i=n==="1";ly(t,r,i)}),t)}function Sd(e){if(!e||typeof e=="string"||typeof e=="number"||typeof e=="boolean")return e;if(Array.isArray(e))return e.map(r=>Sd(r));if(typeof e=="object"){var t={};return Object.entries(e).forEach(([r,n])=>{typeof n=="object"&&(n=Sd(n)),t[ya(r)]=n}),t}}function kd(e){if(!e||typeof e=="string"||typeof e=="number"||typeof e=="boolean")return e;if(Array.isArray(e))return e.map(r=>kd(r));if(typeof e=="object"){var t={};return Object.entries(e).forEach(([r,n])=>{(typeof n=="object"||Array.isArray(e))&&(n=kd(n)),t[Xv(r)]=n}),t}}function XI(e){var t=[],r=cr(e.primaryKey);t.push([r]),t.push(["_deleted",r]),e.indexes&&e.indexes.forEach(a=>{var s=Qd(a);t.push(s)}),t.push(["_meta.lwt",r]),t.push(["_meta.lwt"]),t=t.map(a=>a.map(s=>ya(s)));var n=t.map(a=>a.length===1?a[0]:"["+a.join("+")+"]");n=n.filter((a,s,o)=>o.indexOf(a)===s);var i=n.join(", ");return i}async function Ep(e,t){var r=await e,n=await r.dexieTable.bulkGet(t);return n.map(i=>e_(r.booleanIndexes,i))}function mo(e,t){return e+"||"+t}function eO(e){var t=new Set,r=[];return e.indexes?(e.indexes.forEach(n=>{var i=Qd(n);i.forEach(a=>{if(!t.has(a)){t.add(a);var s=Xi(e,a);s.type==="boolean"&&r.push(a)}})}),r.push("_deleted"),Lb(r)):r}function xp(e){return e===Qi?-1/0:e}function Sp(e,t,r){if(e.includes(t)){var n=r===Ji||r===!0?"1":"0";return n}else return r}function t_(e,t,r){if(!r){if(typeof window>"u")throw new Error("IDBKeyRange missing");r=window.IDBKeyRange}var n=t.startKeys.map((s,o)=>{var c=t.index[o];return Sp(e,c,s)}).map(xp),i=t.endKeys.map((s,o)=>{var c=t.index[o];return Sp(e,c,s)}).map(xp),a=r.bound(n,i,!t.inclusiveStart,!t.inclusiveEnd);return a}async function kp(e,t){var r=await e.internals,n=t.query,i=n.skip?n.skip:0,a=n.limit?n.limit:1/0,s=i+a,o=t.queryPlan,c=!1;o.selectorSatisfiedByIndex||(c=wf(e.schema,t.query));var u=t_(r.booleanIndexes,o,r.dexieDb._options.IDBKeyRange),d=o.index,h=[];if(await r.dexieDb.transaction("r",r.dexieTable,async y=>{var g=y.idbtrans,w=g.objectStore(rc),b,S;S="["+d.map(T=>ya(T)).join("+")+"]",b=w.index(S);var O=b.openCursor(u);await new Promise(T=>{O.onsuccess=function(z){var B=z.target.result;if(B){var G=e_(r.booleanIndexes,B.value);(!c||c(G))&&h.push(G),o.sortSatisfiedByIndex&&h.length===s?T():B.continue()}else T()}})}),!o.sortSatisfiedByIndex){var p=yv(e.schema,t.query);h=h.sort(p)}return h=h.slice(i,s),{documents:h}}async function tO(e,t){var r=await e.internals,n=t.queryPlan,i=n.index,a=t_(r.booleanIndexes,n,r.dexieDb._options.IDBKeyRange),s=-1;return await r.dexieDb.transaction("r",r.dexieTable,async o=>{var c=o.idbtrans,u=c.objectStore(rc),d,h;h="["+i.map(y=>ya(y)).join("+")+"]",d=u.index(h);var p=d.count(a);s=await new Promise((y,g)=>{p.onsuccess=function(){y(p.result)},p.onerror=w=>g(w)})}),s}var rO=Tt(),Du=!1,nO=(function(){function e(r,n,i,a,s,o,c,u){this.changes$=new nr,this.instanceId=rO++,this.storage=r,this.databaseName=n,this.collectionName=i,this.schema=a,this.internals=s,this.options=o,this.settings=c,this.devMode=u,this.primaryPath=cr(this.schema.primaryKey)}var t=e.prototype;return t.bulkWrite=async function(n,i){ei(this),!Du&&(!xu.premium||typeof xu.premium!="string"||await sy(xu.premium)!==p0)&&console.warn(["-------------- RxDB Open Core RxStorage -------------------------------","You are using the free Dexie.js based RxStorage implementation from RxDB https://rxdb.info/rx-storage-dexie.html?console=dexie ","While this is a great option, we want to let you know that there are faster storage solutions available in our premium plugins.","For professional users and production environments, we highly recommend considering these premium options to enhance performance and reliability."," https://rxdb.info/premium?console=dexie ","If you already purchased premium access you can disable this log by calling the setPremiumFlag() function from rxdb-premium/plugins/shared.","---------------------------------------------------------------------"].join(`
`)),Du=!0,n.forEach(d=>{if(!d.document._rev||d.previous&&!d.previous._rev)throw ye("SNH",{args:{row:d}})});var a=await this.internals,s={error:[]};this.devMode&&(n=n.map(d=>{var h=Ps(d.document);return{previous:d.previous,document:h}}));var o=n.map(d=>d.document[this.primaryPath]),c;if(await a.dexieDb.transaction("rw",a.dexieTable,a.dexieAttachmentsTable,async()=>{var d=new Map,h=await Ep(this.internals,o);h.forEach(g=>{var w=g;return w&&d.set(w[this.primaryPath],w),w}),c=VS(this,this.primaryPath,d,n,i),s.error=c.errors;var p=[];c.bulkInsertDocs.forEach(g=>{p.push(g.document)}),c.bulkUpdateDocs.forEach(g=>{p.push(g.document)}),p=p.map(g=>YI(a.booleanIndexes,g)),p.length>0&&await a.dexieTable.bulkPut(p);var y=[];c.attachmentsAdd.forEach(g=>{y.push({id:mo(g.documentId,g.attachmentId),data:g.attachmentData.data})}),c.attachmentsUpdate.forEach(g=>{y.push({id:mo(g.documentId,g.attachmentId),data:g.attachmentData.data})}),await a.dexieAttachmentsTable.bulkPut(y),await a.dexieAttachmentsTable.bulkDelete(c.attachmentsRemove.map(g=>mo(g.documentId,g.attachmentId)))}),c=ze(c),c.eventBulk.events.length>0){var u=ze(c.newestRow).document;c.eventBulk.checkpoint={id:u[this.primaryPath],lwt:u._meta.lwt},c.eventBulk.endTime=Tt(),this.changes$.next(c.eventBulk)}return s},t.findDocumentsById=async function(n,i){ei(this);var a=await this.internals,s=[];return await a.dexieDb.transaction("r",a.dexieTable,async()=>{var o=await Ep(this.internals,n);o.forEach(c=>{c&&(!c._deleted||i)&&s.push(c)})}),s},t.query=function(n){return ei(this),kp(this,n)},t.count=async function(n){if(n.queryPlan.selectorSatisfiedByIndex){var i=await tO(this,n);return{count:i,mode:"fast"}}else{var a=await kp(this,n);return{count:a.documents.length,mode:"slow"}}},t.changeStream=function(){return ei(this),this.changes$.asObservable()},t.cleanup=async function(n){ei(this);var i=await this.internals;return await i.dexieDb.transaction("rw",i.dexieTable,async()=>{var a=Tt()-n,s=await i.dexieTable.where("_meta.lwt").below(a).toArray(),o=[];s.forEach(c=>{c._deleted==="1"&&o.push(c[this.primaryPath])}),await i.dexieTable.bulkDelete(o)}),!0},t.getAttachmentData=async function(n,i,a){ei(this);var s=await this.internals,o=mo(n,i);return await s.dexieDb.transaction("r",s.dexieAttachmentsTable,async()=>{var c=await s.dexieAttachmentsTable.get(o);if(c)return c.data;throw new Error("attachment missing documentId: "+n+" attachmentId: "+i)})},t.remove=async function(){ei(this);var n=await this.internals;return await n.dexieTable.clear(),this.close()},t.close=function(){return this.closed?this.closed:(this.closed=(async()=>{this.changes$.complete(),await QI(this.internals)})(),this.closed)},t.conflictResultionTasks=function(){return new nr},t.resolveConflictResultionTask=async function(n){},e})();async function iO(e,t,r){var n=JI(t.databaseName,t.collectionName,r,t.schema),i=new nO(e,t.databaseName,t.collectionName,t.schema,n,t.options,r,t.devMode);return await KI(Yv,t,i),Promise.resolve(i)}function ei(e){if(e.closed)throw new Error("RxStorageInstanceDexie is closed "+e.databaseName+"-"+e.collectionName)}var aO=(function(){function e(r){this.name=Yv,this.rxdbVersion=dy,this.settings=r}var t=e.prototype;return t.createStorageInstance=function(n){return QS(n),iO(this,n,this.settings)},e})();function sO(e={}){var t=new aO(e);return t}var oO=["__proto__","constructor","prototype"];function Ba(e,t){Object.keys(t).forEach(r=>{oO.includes(r)||(typeof e[r]>"u"?e[r]=t[r]:Za(t[r])?Ba(e[r],t[r]):e[r]=t[r])})}function Za(e){return e.toString()==="[object Object]"}var Rc=(function(){function e(r,n){if(this.options={},this._conditions={},this._fields={},this._path=n,r){var i=this;r.selector&&i.find(r.selector),r.limit&&i.limit(r.limit),r.skip&&i.skip(r.skip),r.sort&&r.sort.forEach(a=>i.sort(a))}}var t=e.prototype;return t.where=function(n,i){if(!arguments.length)return this;var a=typeof arguments[0];if(a==="string")return this._path=arguments[0],arguments.length===2&&(this._conditions[this._path]=arguments[1]),this;if(a==="object"&&!Array.isArray(arguments[0]))return this.merge(arguments[0]);throw tr("MQ1",{path:arguments[0]})},t.equals=function(n){this._ensurePath("equals");var i=this._path;return this._conditions[i]=n,this},t.eq=function(n){this._ensurePath("eq");var i=this._path;return this._conditions[i]=n,this},t.or=function(n){var i=this._conditions.$or||(this._conditions.$or=[]);return Array.isArray(n)||(n=[n]),i.push.apply(i,n),this},t.nor=function(n){var i=this._conditions.$nor||(this._conditions.$nor=[]);return Array.isArray(n)||(n=[n]),i.push.apply(i,n),this},t.and=function(n){var i=this._conditions.$and||(this._conditions.$and=[]);return Array.isArray(n)||(n=[n]),i.push.apply(i,n),this},t.mod=function(n,i){var a,s;arguments.length===1?(this._ensurePath("mod"),a=arguments[0],s=this._path):arguments.length===2&&!Array.isArray(arguments[1])?(this._ensurePath("mod"),a=arguments.slice(),s=this._path):arguments.length===3?(a=arguments.slice(1),s=arguments[0]):(a=arguments[1],s=arguments[0]);var o=this._conditions[s]||(this._conditions[s]={});return o.$mod=a,this},t.exists=function(n,i){var a,s;arguments.length===0?(this._ensurePath("exists"),a=this._path,s=!0):arguments.length===1?typeof arguments[0]=="boolean"?(this._ensurePath("exists"),a=this._path,s=arguments[0]):(a=arguments[0],s=!0):arguments.length===2&&(a=arguments[0],s=arguments[1]);var o=this._conditions[a]||(this._conditions[a]={});return o.$exists=s,this},t.elemMatch=function(n,i){if(arguments[0]===null)throw tr("MQ2");var a,s,o;if(typeof arguments[0]=="function")this._ensurePath("elemMatch"),s=this._path,a=arguments[0];else if(Za(arguments[0]))this._ensurePath("elemMatch"),s=this._path,o=arguments[0];else if(typeof arguments[1]=="function")s=arguments[0],a=arguments[1];else if(arguments[1]&&Za(arguments[1]))s=arguments[0],o=arguments[1];else throw tr("MQ2");a&&(o=new e,a(o),o=o._conditions);var c=this._conditions[s]||(this._conditions[s]={});return c.$elemMatch=o,this},t.sort=function(n){if(!n)return this;var i,a=typeof n;if(Array.isArray(n)){i=n.length;for(var s=0;s<n.length;++s)uO(this.options,n[s][0],n[s][1]);return this}if(arguments.length===1&&a==="string"){n=n.split(/\s+/),i=n.length;for(var o=0;o<i;++o){var c=n[o];if(c){var u=c[0]==="-"?-1:1;u===-1&&(c=c.substring(1)),Ip(this.options,c,u)}}return this}if(Za(n)){var d=Object.keys(n);return d.forEach(h=>Ip(this.options,h,n[h])),this}throw tr("MQ3",{args:arguments})},t.merge=function(n){if(!n)return this;if(!Op(n))throw tr("MQ4",{source:n});return n instanceof e?(n._conditions&&Ba(this._conditions,n._conditions),n._fields&&(this._fields||(this._fields={}),Ba(this._fields,n._fields)),n.options&&(this.options||(this.options={}),Ba(this.options,n.options)),n._distinct&&(this._distinct=n._distinct),this):(Ba(this._conditions,n),this)},t.find=function(n){return Op(n)&&this.merge(n),this},t._ensurePath=function(n){if(!this._path)throw ye("MQ5",{method:n})},t.toJSON=function(){var n={selector:this._conditions};return this.options.skip&&(n.skip=this.options.skip),this.options.limit&&(n.limit=this.options.limit),this.options.sort&&(n.sort=cO(this.options.sort)),{query:n,path:this._path}},e})();function cO(e){return Object.entries(e).map(([t,r])=>{var n=r===1?"asc":"desc",i={[t]:n};return i})}var r_=["limit","skip","maxScan","batchSize","comment"];r_.forEach(function(e){Rc.prototype[e]=function(t){return this.options[e]=t,this}});var n_=["gt","gte","lt","lte","ne","in","nin","all","regex","size"];n_.forEach(function(e){Rc.prototype[e]=function(){var t,r;arguments.length===1?(this._ensurePath(e),r=arguments[0],t=this._path):(r=arguments[1],t=arguments[0]);var n=this._conditions[t]===null||typeof this._conditions[t]=="object"?this._conditions[t]:this._conditions[t]={};if(e==="regex"){if(r instanceof RegExp)throw ye("QU16",{field:t,query:this._conditions});typeof r=="string"?n["$"+e]=r:(n["$"+e]=r.$regex,r.$options&&(n.$options=r.$options))}else n["$"+e]=r;return this}});function Ip(e,t,r){if(Array.isArray(e.sort))throw tr("MQ6",{opts:e,field:t,value:r});if(r&&r.$meta){var n=e.sort||(e.sort={});n[t]={$meta:r.$meta};return}var i=String(r||1).toLowerCase();if(!/^(?:ascending|asc|descending|desc|1|-1)$/.test(i))throw Array.isArray(r)&&(r="["+r+"]"),tr("MQ7",{field:t,value:r});var a=e.sort||(e.sort={}),s=r.toString().replace("asc","1").replace("ascending","1").replace("desc","-1").replace("descending","-1");a[t]=parseInt(s,10)}function uO(e,t,r){if(e.sort=e.sort||[],!Array.isArray(e.sort))throw tr("MQ8",{opts:e,field:t,value:r});e.sort.push([t,r])}function Op(e){return e instanceof Rc||Za(e)}function lO(e,t){return new Rc(e,t)}var Tp="queryBuilderPath";function dO(e,t,r){var n=lO(zt(e.mangoQuery),e.other[Tp]);n[t](r);var i=n.toJSON();return Ui(e.op,i.query,e.collection,{...e.other,[Tp]:i.path})}function Mu(e,t){e[t]=function(r){if(rt.isDevMode()&&this.op==="findByIds")throw ye("QU17",{collection:this.collection.name,query:this.mangoQuery});return dO(this,t,r)}}var fO={name:"query-builder",rxdb:!0,prototypes:{RxQuery(e){["where","equals","eq","or","nor","and","mod","exists","elemMatch","sort"].forEach(t=>{Mu(e,t)}),r_.forEach(t=>{Mu(e,t)}),n_.forEach(t=>{Mu(e,t)})}}};async function i_(e){var t=R0(e.collection.schema.jsonSchema).map(n=>e.collection.name+"-"+n),r=await e.database.internalStore.findDocumentsById(t.map(n=>sa(n,li)),!1);if(r.length>1)throw new Error("more than one old collection meta found");return r[0]}function hO(e,t,r){var n=it(r._attachments),i=zt(r),a=i._meta;delete i._meta,i._attachments=n;for(var s=t+1,o=Promise.resolve(i),c=function(){var u=s;o=o.then(d=>pO(e,u,d)),s++};s<=e.schema.version;)c();return o.then(u=>u===null?ef:(u._meta=a,u))}function pO(e,t,r){if(r===null)return ef;var n=e.migrationStrategies[t](r,e),i=s0(n);return i}async function a_(e){if(e.collection.schema.version===0)return Tr;var t=await i_(e);return!!t}var mO=200,s_=new WeakMap;function gO(e){var t=o_(e.database),r=t.getValue().slice(0);r.push(e),t.next(r)}function o_(e){return sn(s_,e,()=>new ii([]))}function yO(e){var t=s_.get(e);t&&t.complete()}var vO=(function(){function e(r,n,i=[r.name,"v",r.schema.version].join("-")){this.started=!1,this.updateStatusHandlers=[],this.updateStatusQueue=o0,this.collection=r,this.migrationStrategies=n,this.statusDocKey=i,this.database=r.database,this.oldCollectionMeta=i_(this),this.mustMigrate=a_(this),this.statusDocId=sa(this.statusDocKey,Do),gO(this),this.$=WS(this.database.internalStore,this.statusDocId).pipe(tt(a=>!!a),wt(a=>ze(a).data),Ts(xs))}var t=e.prototype;return t.getStatus=function(){return oi(this.$)},t.startMigration=async function(n=mO){var i=await this.mustMigrate;if(i){if(this.started)throw ye("DM1");this.started=!0;var a=void 0;if(this.database.multiInstance){a=new Tc(["rx-migration-state",this.database.name,this.collection.name,this.collection.schema.version].join("|"));var s=qI(a);await s.awaitLeadership()}var o=await this.oldCollectionMeta,c=await this.database.storage.createStorageInstance({databaseName:this.database.name,collectionName:this.collection.name,databaseInstanceToken:this.database.token,multiInstance:this.database.multiInstance,options:{},schema:o.data.schema,password:this.database.password,devMode:rt.isDevMode()}),u=await this.getConnectedStorageInstances(),d=await this.countAllDoucments([c].concat(u.map(h=>h.oldStorage)));await this.updateStatus(h=>(h.count.total=d,h));try{await Promise.all(u.map(async h=>{await ak(this.collection,h.newStorage.collectionName,h.newStorage.schema),await this.migrateStorage(h.oldStorage,h.newStorage,n),await h.newStorage.close()})),await this.migrateStorage(c,this.collection.storageInstance.originalStorageInstance,n)}catch(h){await c.close(),await this.updateStatus(p=>(p.status="ERROR",p.error=h0(h),p));return}await cs(this.database.internalStore,{previous:o,document:Object.assign({},o,{_deleted:!0})},"rx-migration-remove-collection-meta"),await this.updateStatus(h=>(h.status="DONE",h)),a&&await a.close()}},t.updateStatus=function(n){return this.updateStatusHandlers.push(n),this.updateStatusQueue=this.updateStatusQueue.then(async()=>{if(this.updateStatusHandlers.length!==0){var i=this.updateStatusHandlers;for(this.updateStatusHandlers=[];;){var a=await Cs(this.database.internalStore,this.statusDocId),s=zt(a);a||(s={id:this.statusDocId,key:this.statusDocKey,context:Do,data:{collectionName:this.collection.name,status:"RUNNING",count:{total:0,handled:0,percent:0}},_deleted:!1,_meta:xi(),_rev:yr(),_attachments:{}});var o=ze(s).data;for(var c of i)o=c(o);if(o.count.percent=Math.round(o.count.handled/o.count.total*100),s&&a&&ts(s.data,a.data))break;try{await cs(this.database.internalStore,{previous:a,document:ze(s)},Do);break}catch(u){if(!_c(u))throw u}}}}),this.updateStatusQueue},t.migrateStorage=async function(n,i,a){var s=await this.database.storage.createStorageInstance({databaseName:this.database.name,collectionName:"rx-migration-state-meta-"+this.collection.name+"-"+this.collection.schema.version,databaseInstanceToken:this.database.token,multiInstance:this.database.multiInstance,options:{},schema:up(n.schema,gd(n.schema)),password:this.database.password,devMode:rt.isDevMode()}),o=wk(i,Yo,this.database.token,!0),c=vk({keepMeta:!0,identifier:["rx-migration-state",this.collection.name,n.schema.version,this.collection.schema.version].join("-"),replicationHandler:{masterChangesSince(){return Promise.resolve({checkpoint:null,documents:[]})},masterWrite:async d=>{d=await Promise.all(d.map(async p=>{var y=p.newDocumentState;if(i.schema.title===Mo&&(y=p.newDocumentState.docData,p.newDocumentState.isCheckpoint==="1"))return{assumedMasterState:void 0,newDocumentState:p.newDocumentState};var g=await hO(this.collection,n.schema.version,y),w={assumedMasterState:void 0,newDocumentState:i.schema.title===Mo?Object.assign({},p.newDocumentState,{docData:g}):g};return w})),d=d.filter(p=>!!p.newDocumentState);var h=await o.masterWrite(d);return h},masterChangeStream$:new nr().asObservable()},forkInstance:n,metaInstance:s,pushBatchSize:a,pullBatchSize:0,conflictHandler:Yo,hashFunction:this.database.hashFunction}),u=!1;if(c.events.error.subscribe(d=>u=d),c.events.processed.up.subscribe(()=>{this.updateStatus(d=>(d.count.handled=d.count.handled+1,d))}),await _k(c),await bk(c),await this.updateStatusQueue,u)throw await s.close(),u;await Promise.all([n.remove(),s.remove()])},t.countAllDoucments=async function(n){var i=0;return await Promise.all(n.map(async a=>{var s=Sc(a.schema,os(a.schema,{selector:{}})),o=await a.count(s);i+=o.count})),i},t.getConnectedStorageInstances=async function(){var n=await this.oldCollectionMeta,i=[];return await Promise.all(await Promise.all(n.data.connectedStorages.map(async a=>{if(a.schema.title!==Mo)throw new Error("unknown migration handling for schema");var s=up(zt(this.collection.schema.jsonSchema),gd(a.schema));s.version=this.collection.schema.version;var[o,c]=await Promise.all([this.database.storage.createStorageInstance({databaseInstanceToken:this.database.token,databaseName:this.database.name,devMode:rt.isDevMode(),multiInstance:this.database.multiInstance,options:{},schema:a.schema,password:this.database.password,collectionName:a.collectionName}),this.database.storage.createStorageInstance({databaseInstanceToken:this.database.token,databaseName:this.database.name,devMode:rt.isDevMode(),multiInstance:this.database.multiInstance,options:{},schema:s,password:this.database.password,collectionName:a.collectionName})]);i.push({oldStorage:o,newStorage:c})}))),i},t.migratePromise=async function(n){this.startMigration(n);var i=await this.mustMigrate;if(!i)return{status:"DONE",collectionName:this.collection.name,count:{handled:0,percent:0,total:0}};var a=await Promise.race([oi(this.$.pipe(tt(s=>s.status==="DONE"))),oi(this.$.pipe(tt(s=>s.status==="ERROR")))]);if(a.status==="ERROR")throw ye("DM4",{collection:this.collection.name,error:a.error});return a},e})(),_O=Iv(),wO=(function(e){function t(r,n,i){var a;return a=e.call(this,null,n)||this,a.id=r,a.parent=i,a}return tf(t,e),t})(_O),Ja={get isLocal(){return!0},get allAttachments$(){throw ye("LD1",{document:this})},get primaryPath(){return"id"},get primary(){return this.id},get $(){var e=this,t=gi(Id,this.parent);return e.parent.$.pipe(tt(r=>r.documentId===this.primary),tt(r=>r.isLocal),wt(r=>My(r)),Rs(t.docCache.getLatestDocumentData(this.primary)),is((r,n)=>r._rev===n._rev),wt(r=>t.docCache.getCachedRxDocument(r)),Ts(xs))},get $$(){var e=this,t=Lu(e),r=t.getReactivityFactory();return r.fromObservable(e.$,e.getLatest()._data,t)},get deleted$$(){var e=this,t=Lu(e),r=t.getReactivityFactory();return r.fromObservable(e.deleted$,e.getLatest().deleted,t)},getLatest(){var e=gi(Id,this.parent),t=e.docCache.getLatestDocumentData(this.primary);return e.docCache.getCachedRxDocument(t)},get(e){if(e="data."+e,!!this._data){if(typeof e!="string")throw tr("LD2",{objPath:e});var t=Mn(this._data,e);return t=rt.deepFreezeWhenDevMode(t),t}},get$(e){if(e="data."+e,rt.isDevMode()){if(e.includes(".item."))throw ye("LD3",{objPath:e});if(e===this.primaryPath)throw ye("LD4")}return this.$.pipe(wt(t=>t._data),wt(t=>Mn(t,e)),is())},get$$(e){var t=Lu(this),r=t.getReactivityFactory();return r.fromObservable(this.get$(e),this.getLatest().get(e),t)},async incrementalModify(e){var t=await Qa(this.parent);return t.incrementalWriteQueue.addWrite(this._data,async r=>(r.data=await e(r.data,this),r)).then(r=>t.docCache.getCachedRxDocument(r))},incrementalPatch(e){return this.incrementalModify(t=>(Object.entries(e).forEach(([r,n])=>{t[r]=n}),t))},async _saveData(e){var t=await Qa(this.parent),r=this._data;e.id=this.id;var n=[{previous:r,document:e}];return t.storageInstance.bulkWrite(n,"local-document-save-data").then(i=>{if(i.error[0])throw i.error[0];var a=sr(this.collection.schema.primaryPath,n,i)[0];e=it(e),e._rev=a._rev})},async remove(){var e=await Qa(this.parent),t=it(this._data);return t._deleted=!0,cs(e.storageInstance,{previous:this._data,document:t},"local-document-remove").then(r=>e.docCache.getCachedRxDocument(r))}},Rp=!1,bO=()=>{if(!Rp){Rp=!0;var e=kc,t=Object.getOwnPropertyNames(e);t.forEach(n=>{var i=Object.getOwnPropertyDescriptor(Ja,n);if(!i){var a=Object.getOwnPropertyDescriptor(e,n);Object.defineProperty(Ja,n,a)}});var r=n=>()=>{throw ye("LD6",{functionName:n})};["populate","update","putAttachment","getAttachment","allAttachments"].forEach(n=>Ja[n]=r(n))}};function EO(e,t){bO();var r=new wO(e.id,e,t);return Object.setPrototypeOf(r,Ja),r.prototype=Ja,r}function Lu(e){var t=e.parent;return $k(t)?t:t.database}var nc=new WeakMap,Id=new WeakMap;function Ap(e){var t=e.database?e.database:e,r=e.database?e.name:"",n=(async()=>{var i=await c_(t.token,t.storage,t.name,r,t.instanceCreationOptions,t.multiInstance);i=bf(t,i,u_);var a=new _v("id",t.eventBulks$.pipe(tt(d=>{var h=!1;return(r===""&&!d.collectionName||r!==""&&d.collectionName===r)&&(h=!0),h&&d.events[0].isLocal}),wt(d=>d.events)),d=>EO(d,e)),s=new kv(i,"id",()=>{},()=>{}),o=await t.storageToken,c=i.changeStream().subscribe(d=>{for(var h=new Array(d.events.length),p=d.events,y=e.database?e.name:void 0,g=0;g<p.length;g++){var w=p[g];h[g]={documentId:w.documentId,collectionName:y,isLocal:!0,operation:w.operation,documentData:rt.deepFreezeWhenDevMode(w.documentData),previousDocumentData:rt.deepFreezeWhenDevMode(w.previousDocumentData)}}var b={id:d.id,internal:!1,collectionName:e.database?e.name:void 0,storageToken:o,events:h,databaseToken:t.token,checkpoint:d.checkpoint,context:d.context,endTime:d.endTime,startTime:d.startTime};t.$emit(b)});e._subs.push(c);var u={database:t,parent:e,storageInstance:i,docCache:a,incrementalWriteQueue:s};return Id.set(e,u),u})();nc.set(e,n)}function Qa(e){var t=nc.get(e);if(!t){var r=e.database?e.database:e,n=e.database?e.name:"";throw ye("LD8",{database:r.name,collection:n})}return t}function c_(e,t,r,n,i,a){return t.createStorageInstance({databaseInstanceToken:e,databaseName:r,collectionName:xO(n),schema:u_,options:i,multiInstance:a,devMode:rt.isDevMode()})}function $p(e){var t=nc.get(e);if(t)return nc.delete(e),t.then(r=>r.storageInstance.close())}async function Cp(e,t,r){var n=Es(10),i=await c_(n,e,t,r,{},!1);await i.remove()}function xO(e){return"plugin-local-documents-"+e}var u_=wc({title:"RxLocalDocument",version:0,primaryKey:"id",type:"object",properties:{id:{type:"string",maxLength:128},data:{type:"object",additionalProperties:!0}},required:["id","data"]});async function Pp(e,t){var r=await Qa(this),n={id:e,data:t,_deleted:!1,_meta:xi(),_rev:yr(),_attachments:{}};return cs(r.storageInstance,{document:n},"local-document-insert").then(i=>r.docCache.getCachedRxDocument(i))}function Np(e,t){return this.getLocal(e).then(r=>{if(r)return r.incrementalModify(()=>t);var n=this.insertLocal(e,t);return n})}async function Dp(e){var t=await Qa(this),r=t.docCache,n=r.getLatestDocumentDataIfExists(e);return n?Promise.resolve(r.getCachedRxDocument(n)):Cs(t.storageInstance,e).then(i=>i?t.docCache.getCachedRxDocument(i):null)}function Mp(e){return this.$.pipe(Rs(null),cn(async t=>{if(t)return{changeEvent:t};var r=await this.getLocal(e);return{doc:r}}),cn(async t=>{if(t.changeEvent){var r=t.changeEvent;if(!r.isLocal||r.documentId!==e)return{use:!1};var n=await this.getLocal(e);return{use:!0,doc:n}}else return{use:!0,doc:t.doc}}),tt(t=>t.use),wt(t=>t.doc))}var SO={name:"local-documents",rxdb:!0,prototypes:{RxCollection:e=>{e.insertLocal=Pp,e.upsertLocal=Np,e.getLocal=Dp,e.getLocal$=Mp},RxDatabase:e=>{e.insertLocal=Pp,e.upsertLocal=Np,e.getLocal=Dp,e.getLocal$=Mp}},hooks:{createRxDatabase:{before:e=>{e.creator.localDocuments&&Ap(e.database)}},createRxCollection:{before:e=>{e.creator.localDocuments&&Ap(e.collection)}},preDestroyRxDatabase:{after:e=>$p(e)},postDestroyRxCollection:{after:e=>$p(e)},postRemoveRxDatabase:{after:e=>Cp(e.storage,e.databaseName,"")},postRemoveRxCollection:{after:e=>Cp(e.storage,e.databaseName,e.collectionName)}},overwritable:{}},kO=new WeakMap,IO={name:"migration-schema",rxdb:!0,init(){Ic(SO)},hooks:{preDestroyRxDatabase:{after:yO}},prototypes:{RxDatabase:e=>{e.migrationStates=function(){return o_(this).pipe(Ts(xs))}},RxCollection:e=>{e.getMigrationState=function(){return sn(kO,this,()=>new vO(this.asRxCollection,this.migrationStrategies))},e.migrationNeeded=function(){return this.schema.version===0?Tr:a_(this.getMigrationState())}}}},OO=IO;const Ac=e=>Nt((t,r,n)=>{let i=0;if(r instanceof Array)for(const a of r)i=i|1<<a;else i=r;return e(t&i,i)}),TO=Ac((e,t)=>e==0),RO=Ac((e,t)=>e==t),AO=Ac((e,t)=>e<t),$O=Ac((e,t)=>e>0),CO=Object.freeze(Object.defineProperty({__proto__:null,$all:xS,$and:ev,$bitsAllClear:TO,$bitsAllSet:RO,$bitsAnyClear:AO,$bitsAnySet:$O,$elemMatch:hv,$eq:nv,$exists:mv,$expr:wS,$gt:iv,$gte:av,$in:sv,$jsonSchema:bS,$lt:ov,$lte:cv,$mod:dv,$ne:uv,$nin:lv,$nor:tv,$not:rv,$or:_f,$regex:fv,$size:pv,$type:gv,$where:ES},Symbol.toStringTag,{value:"Module"})),Rf=(e,t)=>{switch(e){case"deep":return cd(t);case"copy":return Go(t)?new Date(t):vt(t)?[...t]:st(t)?{...t}:t;default:return t}},PO=/^[a-z]+[a-zA-Z0-9]*$/;function l_(e){if(!e.includes(".$"))return[{parent:e,selector:e},[]];const t=e.indexOf(".$"),r=e.indexOf("]"),n=e.substring(0,t),i=e.substring(t+3,r);yt(i===""||PO.test(i),"The filter <identifier> must begin with a lowercase letter and contain only alphanumeric characters.");const a=e.substring(r+2),[s,o]=a?l_(a):[];return[{selector:e,parent:n,child:i||"$",next:s},[i,...o||[]].filter(Boolean)]}const Jt=(e,t,r,n,i)=>{const{parent:a,child:s,next:o}=t;if(!s){let u=!1;return ss(e,a,(h,p)=>u=!!n(h,p)||u,i),u}const c=ma(e,a);return vt(c)?c.map((u,d)=>r[s]&&!r[s].test({[s]:u})?!1:o?Jt(u,o,r,n,i):n(c,d)).some(Boolean):!1};function lr(e,t,r,n){const i=[];for(const[a,s]of Object.entries(e)){const[o,c]=l_(a);if(!c.length)n(s,o,{})&&i.push(o.parent);else{const u={};t.forEach(h=>{Object.keys(h).forEach(p=>{c.forEach(y=>{(p===y||p.startsWith(y+"."))&&(u[y]=u[y]||{},Object.assign(u[y],{[p]:h[p]}))})})});const d={};for(const[h,p]of Object.entries(u))d[h]=new dn(p,r.queryOptions);n(s,o,d)&&i.push(o.parent)}}return i}const NO=(e,t,r=[],n={})=>lr(t,r,n,(i,a,s)=>{const o={$each:[i]};return st(i)&&ir(i,"$each")&&Object.assign(o,i),Jt(e,a,s,(c,u)=>{const d=c[u]||=[];return yf([d,o.$each]).length===o.$each.length?!1:(c[u]=Rf(n.cloneMode,Nx(d.concat(o.$each))),!0)},{buildGraph:!0})}),DO=new Set(["and","or","xor"]),MO=(e,t,r=[],n={})=>lr(t,r,n,(i,a,s)=>{const o=Object.keys(i);return yt(o.length===1&&DO.has(o[0]),`Invalid bit operator '${o[0]}'. Must be one of 'and', 'or', or 'xor'.`),Jt(e,a,s,(c,u)=>{let d=c[u];const h=i[o[0]];if(d!==void 0&&!(rr(d)&&rr(h)))return!1;switch(d=d||0,o[0]){case"and":c[u]=d&h;break;case"or":c[u]=d|h;break;case"xor":c[u]=d^h;break}return c[u]!==d},{buildGraph:!0})}),LO=(e,t,r=[],n={})=>{const i=Date.now();return lr(t,r,n,(a,s,o)=>Jt(e,s,o,(c,u)=>(c[u]=i,!0),{buildGraph:!0}))},jO=(e,t,r=[],n={})=>lr(t,r,n,(i,a,s)=>{if(!a.child){const o=ma(e,a.parent);yt(o===void 0||rr(o),"cannot apply $inc to a value of non-numeric type")}return Jt(e,a,s,(o,c)=>(o[c]=(o[c]||=0)+i,!0),{buildGraph:!0})}),FO=(e,t,r=[],n={})=>lr(t,r,n,(i,a,s)=>Jt(e,a,s,(o,c)=>o[c]!==void 0&&Wt(o[c],i)>-1?!1:(o[c]=i,!0),{buildGraph:!0})),BO=(e,t,r=[],n={})=>lr(t,r,n,(i,a,s)=>Jt(e,a,s,(o,c)=>o[c]!==void 0&&Wt(o[c],i)<1?!1:(o[c]=i,!0),{buildGraph:!0})),zO=(e,t,r=[],n={})=>lr(t,r,n,(i,a,s)=>Jt(e,a,s,(o,c)=>{const u=o[c];return o[c]=o[c]===void 0?0:o[c]*i,o[c]!==u},{buildGraph:!0})),UO=(e,t,r=[],n={})=>lr(t,r,n,(i,a,s)=>Jt(e,a,s,(o,c)=>{const u=o[c];return yt(vt(u),`path '${a.selector}' contains an element of non-array type.`),u.length?(i===-1?u.splice(0,1):u.pop(),!0):!1})),d_=(e,t,r=[],n={})=>lr(t,r,n,(i,a,s)=>{const o=!st(i)||Object.keys(i).some(Oi),c=new dn(o?{k:i}:i,n.queryOptions),u=o?d=>c.test({k:d}):d=>c.test(d);return Jt(e,a,s,(d,h)=>{const p=d[h],y=new Array;return p.map(w=>{const b=u(w);return b||y.push(w),b}).some(Boolean)?(d[h]=y,!0):!1})}),qO=(e,t,r=[],n={})=>{const i={};return Object.entries(t).forEach(([a,s])=>{i[a]={$in:s}}),d_(e,i,r,n)},HO=Object.freeze(["$each","$slice","$sort","$position"]),KO=(e,t,r=[],n={})=>lr(t,r,n,(i,a,s)=>{const o={$each:[i]};return st(i)&&HO.some(c=>ir(i,c))&&Object.assign(o,i),Jt(e,a,s,(c,u)=>{const d=c[u]||=[],h=d.slice(0,o.$slice||d.length),p=d.length,y=rr(o.$position)?o.$position:d.length;if(d.splice(y,0,...Rf(n.cloneMode,o.$each)),o.$sort){const g=st(o.$sort)?Object.keys(o.$sort||{}).pop():"",w=g?o.$sort[g]:o.$sort,b=g?S=>ma(S,g):S=>S;d.sort((S,O)=>w*Wt(b(S),b(O)))}return rr(o.$slice)&&(o.$slice<0?d.splice(0,d.length+o.$slice):d.splice(o.$slice)),p!=d.length||!Hr(h,d)},{descendArray:!0,buildGraph:!0})}),f_=(e,t,r=[],n={})=>lr(t,r,n,(i,a,s)=>Jt(e,a,s,(o,c)=>Hr(o[c],i)?!1:(o[c]=Rf(n.cloneMode,i),!0),{buildGraph:!0})),GO=(e,t,r=[],n={})=>{const i=[],a=lr(t,r,n,(s,o,c)=>Jt(e,o,c,(u,d)=>ir(u,d)?(i.push(...f_(e,{[s]:u[d]},r,n)),delete u[d],!0):!1));return Array.from(new Set(a.concat(i)))},WO=(e,t,r=[],n={})=>lr(t,r,n,(i,a,s)=>Jt(e,a,s,(o,c)=>ir(o,c)?(vt(o)?o[c]=null:delete o[c],!0):!1)),Lp=Object.freeze(Object.defineProperty({__proto__:null,$addToSet:NO,$bit:MO,$currentDate:LO,$inc:jO,$max:FO,$min:BO,$mul:zO,$pop:UO,$pull:d_,$pullAll:qO,$push:KO,$rename:GO,$set:f_,$unset:WO},Symbol.toStringTag,{value:"Module"}));function h_(e){return e={...e,queryOptions:Wo(e.queryOptions)},e.queryOptions.context.addQueryOps(CO).addExpressionOps(cS).addExpressionOps(gS),(t,r,n=[],i={},a={})=>{const s=Object.assign({cloneMode:"copy"},e,a);Object.assign(s,{queryOptions:Wo(Object.assign({useStrictMode:!1},s?.queryOptions))}),n=n||[],i=i||{};const o=Object.entries(r);yt(o.length===1,"Update expression must contain only one operator.");const[c,u]=o[0];yt(ir(Lp,c),`Update operator '${c}' is not supported.`);const d=Lp[c];return Object.keys(i).length&&!(i instanceof dn?i:new dn(i,s.queryOptions)).test(t)?[]:d(t,u,n,s)}}h_({});var ju;function p_(e,t){if(!ju){var r=h_({cloneMode:"none"});ju=(n,i)=>{var a=zt(n);return r(a,i),a}}return ju(e,t)}function VO(e){return this.incrementalModify(t=>{var r=p_(t,e);return r})}function ZO(e){var t=this._data,r=p_(t,e);return this._saveData(r,t)}async function JO(e){return zi(this.asRxQuery,t=>t.update(e))}var QO={name:"update",rxdb:!0,prototypes:{RxDocument:e=>{e.update=ZO,e.incrementalUpdate=VO},RxQuery:e=>{e.update=JO}}},YO=Object.defineProperty,bt=(e,t)=>{for(var r in t)YO(e,r,{get:t[r],enumerable:!0})},m_=class{pageContent;metadata;id;constructor(e){this.pageContent=e.pageContent!==void 0?e.pageContent.toString():"",this.metadata=e.metadata??{},this.id=e.id}},Fu,jp;function XO(){return jp||(jp=1,Fu=function(e,t){if(typeof e!="string")throw new TypeError("Expected a string");return t=typeof t>"u"?"_":t,e.replace(/([a-z\d])([A-Z])/g,"$1"+t+"$2").replace(/([A-Z]+)([A-Z][a-z\d]+)/g,"$1"+t+"$2").toLowerCase()}),Fu}var eT=XO();const tT=fa(eT);var go={exports:{}},Fp;function rT(){if(Fp)return go.exports;Fp=1;const e=/[\p{Lu}]/u,t=/[\p{Ll}]/u,r=/^[\p{Lu}](?![\p{Lu}])/gu,n=/([\p{Alpha}\p{N}_]|$)/u,i=/[_.\- ]+/,a=new RegExp("^"+i.source),s=new RegExp(i.source+n.source,"gu"),o=new RegExp("\\d+"+n.source,"gu"),c=(p,y,g)=>{let w=!1,b=!1,S=!1;for(let O=0;O<p.length;O++){const T=p[O];w&&e.test(T)?(p=p.slice(0,O)+"-"+p.slice(O),w=!1,S=b,b=!0,O++):b&&S&&t.test(T)?(p=p.slice(0,O-1)+"-"+p.slice(O-1),S=b,b=!1,w=!0):(w=y(T)===T&&g(T)!==T,S=b,b=g(T)===T&&y(T)!==T)}return p},u=(p,y)=>(r.lastIndex=0,p.replace(r,g=>y(g))),d=(p,y)=>(s.lastIndex=0,o.lastIndex=0,p.replace(s,(g,w)=>y(w)).replace(o,g=>y(g))),h=(p,y)=>{if(!(typeof p=="string"||Array.isArray(p)))throw new TypeError("Expected the input to be `string | string[]`");if(y={pascalCase:!1,preserveConsecutiveUppercase:!1,...y},Array.isArray(p)?p=p.map(S=>S.trim()).filter(S=>S.length).join("-"):p=p.trim(),p.length===0)return"";const g=y.locale===!1?S=>S.toLowerCase():S=>S.toLocaleLowerCase(y.locale),w=y.locale===!1?S=>S.toUpperCase():S=>S.toLocaleUpperCase(y.locale);return p.length===1?y.pascalCase?w(p):g(p):(p!==g(p)&&(p=c(p,g,w)),p=p.replace(a,""),y.preserveConsecutiveUppercase?p=u(p,g):p=g(p),y.pascalCase&&(p=w(p.charAt(0))+p.slice(1)),d(p,w))};return go.exports=h,go.exports.default=h,go.exports}rT();function nT(e,t){return t?.[e]||tT(e)}function iT(e,t,r){const n={};for(const i in e)Object.hasOwn(e,i)&&(n[t(i,r)]=e[i]);return n}var aT={};bt(aT,{Serializable:()=>ls,get_lc_unique_name:()=>Af});function Bp(e){return Array.isArray(e)?[...e]:{...e}}function sT(e,t){const r=Bp(e);for(const[n,i]of Object.entries(t)){const[a,...s]=n.split(".").reverse();let o=r;for(const c of s.reverse()){if(o[c]===void 0)break;o[c]=Bp(o[c]),o=o[c]}o[a]!==void 0&&(o[a]={lc:1,type:"secret",id:[i]})}return r}function Af(e){const t=Object.getPrototypeOf(e);return typeof e.lc_name=="function"&&(typeof t.lc_name!="function"||e.lc_name()!==t.lc_name())?e.lc_name():e.name}var ls=class g_{lc_serializable=!1;lc_kwargs;static lc_name(){return this.name}get lc_id(){return[...this.lc_namespace,Af(this.constructor)]}get lc_secrets(){}get lc_attributes(){}get lc_aliases(){}get lc_serializable_keys(){}constructor(t,...r){this.lc_serializable_keys!==void 0?this.lc_kwargs=Object.fromEntries(Object.entries(t||{}).filter(([n])=>this.lc_serializable_keys?.includes(n))):this.lc_kwargs=t??{}}toJSON(){if(!this.lc_serializable)return this.toJSONNotImplemented();if(this.lc_kwargs instanceof g_||typeof this.lc_kwargs!="object"||Array.isArray(this.lc_kwargs))return this.toJSONNotImplemented();const t={},r={},n=Object.keys(this.lc_kwargs).reduce((i,a)=>(i[a]=a in this?this[a]:this.lc_kwargs[a],i),{});for(let i=Object.getPrototypeOf(this);i;i=Object.getPrototypeOf(i))Object.assign(t,Reflect.get(i,"lc_aliases",this)),Object.assign(r,Reflect.get(i,"lc_secrets",this)),Object.assign(n,Reflect.get(i,"lc_attributes",this));return Object.keys(r).forEach(i=>{let a=this,s=n;const[o,...c]=i.split(".").reverse();for(const u of c.reverse()){if(!(u in a)||a[u]===void 0)return;(!(u in s)||s[u]===void 0)&&(typeof a[u]=="object"&&a[u]!=null?s[u]={}:Array.isArray(a[u])&&(s[u]=[])),a=a[u],s=s[u]}o in a&&a[o]!==void 0&&(s[o]=s[o]||a[o])}),{lc:1,type:"constructor",id:this.lc_id,kwargs:iT(Object.keys(r).length?sT(n,r):n,nT,t)}}toJSONNotImplemented(){return{lc:1,type:"not_implemented",id:this.lc_id}}};function oT(e){return!!(e&&typeof e=="object"&&"type"in e&&e.type==="tool_call")}var cT=class extends Error{output;constructor(e,t){super(e),this.output=t}};const y_=Symbol.for("ls:tracing_async_local_storage"),Ya=Symbol.for("lc:context_variables"),uT=e=>{globalThis[y_]=e},ds=()=>globalThis[y_];function fs(e){return typeof e=="object"&&e!==null&&"type"in e&&typeof e.type=="string"&&"source_type"in e&&(e.source_type==="url"||e.source_type==="base64"||e.source_type==="text"||e.source_type==="id")}function lT(e){return fs(e)&&e.source_type==="url"&&"url"in e&&typeof e.url=="string"}function dT(e){return fs(e)&&e.source_type==="base64"&&"data"in e&&typeof e.data=="string"}function fT(e){return fs(e)&&e.source_type==="id"&&"id"in e&&typeof e.id=="string"}function zp({dataUrl:e,asTypedArray:t=!1}){const r=e.match(/^data:(\w+\/\w+);base64,([A-Za-z0-9+/]+=*)$/);let n;if(r){n=r[1].toLowerCase();const i=t?Uint8Array.from(atob(r[2]),a=>a.charCodeAt(0)):r[2];return{mime_type:n,data:i}}}function Ee(e,t){return Ce(e)&&e.type===t}function Ce(e){return typeof e=="object"&&e!==null}function Ur(e){return Array.isArray(e)}function he(e){return typeof e=="string"}function Ir(e){return typeof e=="number"}function $f(e){return e instanceof Uint8Array}function Up(e){try{return JSON.parse(e)}catch{return}}const hs=e=>e();function hT(e){if(e.type==="char_location"&&he(e.document_title)&&Ir(e.start_char_index)&&Ir(e.end_char_index)&&he(e.cited_text)){const{document_title:t,start_char_index:r,end_char_index:n,cited_text:i,...a}=e;return{...a,type:"citation",source:"char",title:t??void 0,startIndex:r,endIndex:n,citedText:i}}if(e.type==="page_location"&&he(e.document_title)&&Ir(e.start_page_number)&&Ir(e.end_page_number)&&he(e.cited_text)){const{document_title:t,start_page_number:r,end_page_number:n,cited_text:i,...a}=e;return{...a,type:"citation",source:"page",title:t??void 0,startIndex:r,endIndex:n,citedText:i}}if(e.type==="content_block_location"&&he(e.document_title)&&Ir(e.start_block_index)&&Ir(e.end_block_index)&&he(e.cited_text)){const{document_title:t,start_block_index:r,end_block_index:n,cited_text:i,...a}=e;return{...a,type:"citation",source:"block",title:t??void 0,startIndex:r,endIndex:n,citedText:i}}if(e.type==="web_search_result_location"&&he(e.url)&&he(e.title)&&he(e.encrypted_index)&&he(e.cited_text)){const{url:t,title:r,encrypted_index:n,cited_text:i,...a}=e;return{...a,type:"citation",source:"url",url:t,title:r,startIndex:Number(n),endIndex:Number(n),citedText:i}}if(e.type==="search_result_location"&&he(e.source)&&he(e.title)&&Ir(e.start_block_index)&&Ir(e.end_block_index)&&he(e.cited_text)){const{source:t,title:r,start_block_index:n,end_block_index:i,cited_text:a,...s}=e;return{...s,type:"citation",source:"search",url:t,title:r??void 0,startIndex:n,endIndex:i,citedText:a}}}function v_(e){if(Ee(e,"document")&&Ce(e.source)&&"type"in e.source){if(e.source.type==="base64"&&he(e.source.media_type)&&he(e.source.data))return{type:"file",mimeType:e.source.media_type,data:e.source.data};if(e.source.type==="url"&&he(e.source.url))return{type:"file",url:e.source.url};if(e.source.type==="file"&&he(e.source.file_id))return{type:"file",fileId:e.source.file_id};if(e.source.type==="text"&&he(e.source.data))return{type:"file",mimeType:String(e.source.media_type??"text/plain"),data:e.source.data}}else if(Ee(e,"image")&&Ce(e.source)&&"type"in e.source){if(e.source.type==="base64"&&he(e.source.media_type)&&he(e.source.data))return{type:"image",mimeType:e.source.media_type,data:e.source.data};if(e.source.type==="url"&&he(e.source.url))return{type:"image",url:e.source.url};if(e.source.type==="file"&&he(e.source.file_id))return{type:"image",fileId:e.source.file_id}}}function pT(e){function*t(){for(const r of e){const n=v_(r);n?yield n:yield r}}return Array.from(t())}function qp(e){function*t(){const r=typeof e.content=="string"?[{type:"text",text:e.content}]:e.content;for(const n of r){if(Ee(n,"text")&&he(n.text)){const{text:i,citations:a,...s}=n;if(Ur(a)&&a.length){const o=a.reduce((c,u)=>{const d=hT(u);return d?[...c,d]:c},[]);yield{...s,type:"text",text:i,annotations:o};continue}else{yield{...s,type:"text",text:i};continue}}else if(Ee(n,"thinking")&&he(n.thinking)){const{thinking:i,signature:a,...s}=n;yield{...s,type:"reasoning",reasoning:i,signature:a};continue}else if(Ee(n,"redacted_thinking")){yield{type:"non_standard",value:n};continue}else if(Ee(n,"tool_use")&&he(n.name)&&he(n.id)){yield{type:"tool_call",id:n.id,name:n.name,args:n.input};continue}else if(Ee(n,"input_json_delta")){if(gT(e)&&e.tool_call_chunks?.length){const i=e.tool_call_chunks[0];yield{type:"tool_call_chunk",id:i.id,name:i.name,args:i.args,index:i.index};continue}}else if(Ee(n,"server_tool_use")&&he(n.name)&&he(n.id)){const{name:i,id:a}=n;if(i==="web_search"){const s=hs(()=>{if(typeof n.input=="string")return n.input;if(Ce(n.input)&&he(n.input.query))return n.input.query;if(he(n.partial_json)){const o=Up(n.partial_json);if(o?.query)return o.query}return""});yield{id:a,type:"server_tool_call",name:"web_search",args:{query:s}};continue}else if(n.name==="code_execution"){const s=hs(()=>{if(typeof n.input=="string")return n.input;if(Ce(n.input)&&he(n.input.code))return n.input.code;if(he(n.partial_json)){const o=Up(n.partial_json);if(o?.code)return o.code}return""});yield{id:a,type:"server_tool_call",name:"code_execution",args:{code:s}};continue}}else if(Ee(n,"web_search_tool_result")&&he(n.tool_use_id)&&Ur(n.content)){const{content:i,tool_use_id:a}=n,s=i.reduce((o,c)=>Ee(c,"web_search_result")?[...o,c.url]:o,[]);yield{type:"server_tool_call_result",name:"web_search",toolCallId:a,status:"success",output:{urls:s}};continue}else if(Ee(n,"code_execution_tool_result")&&he(n.tool_use_id)&&Ce(n.content)){yield{type:"server_tool_call_result",name:"code_execution",toolCallId:n.tool_use_id,status:"success",output:n.content};continue}else if(Ee(n,"mcp_tool_use")){yield{id:n.id,type:"server_tool_call",name:"mcp_tool_use",args:n.input};continue}else if(Ee(n,"mcp_tool_result")&&he(n.tool_use_id)&&Ce(n.content)){yield{type:"server_tool_call_result",name:"mcp_tool_use",toolCallId:n.tool_use_id,status:"success",output:n.content};continue}else if(Ee(n,"container_upload")){yield{type:"server_tool_call",name:"container_upload",args:n.input};continue}else if(Ee(n,"search_result")){yield{id:n.id,type:"non_standard",value:n};continue}else if(Ee(n,"tool_result")){yield{id:n.id,type:"non_standard",value:n};continue}else{const i=v_(n);if(i){yield i;continue}}yield{type:"non_standard",value:n}}}return Array.from(t())}const mT={translateContent:qp,translateContentChunk:qp};function gT(e){return typeof e?._getType=="function"&&typeof e.concat=="function"&&e._getType()==="ai"}function yT(e){return lT(e)?{type:e.type,mimeType:e.mime_type,url:e.url,metadata:e.metadata}:dT(e)?{type:e.type,mimeType:e.mime_type??"application/octet-stream",data:e.data,metadata:e.metadata}:fT(e)?{type:e.type,mimeType:e.mime_type,fileId:e.id,metadata:e.metadata}:e}function vT(e){return e.map(yT)}function _T(e){return!!(Ee(e,"image_url")&&Ce(e.image_url)||Ee(e,"input_audio")&&Ce(e.input_audio)||Ee(e,"file")&&Ce(e.file))}function wT(e){if(Ee(e,"image_url")&&Ce(e.image_url)&&he(e.image_url.url)){const t=zp({dataUrl:e.image_url.url});return t?{type:"image",mimeType:t.mime_type,data:t.data}:{type:"image",url:e.image_url.url}}else{if(Ee(e,"input_audio")&&Ce(e.input_audio)&&he(e.input_audio.data)&&he(e.input_audio.format))return{type:"audio",data:e.input_audio.data,mimeType:`audio/${e.input_audio.format}`};if(Ee(e,"file")&&Ce(e.file)&&he(e.file.data)){const t=zp({dataUrl:e.file.data});if(t)return{type:"file",data:t.data,mimeType:t.mime_type};if(he(e.file.file_id))return{type:"file",fileId:e.file.file_id}}}return e}function bT(e){const t=[];typeof e.content=="string"?t.push({type:"text",text:e.content}):t.push(...Cf(e.content));for(const r of e.tool_calls??[])t.push({type:"tool_call",id:r.id,name:r.name,args:r.args});return t}function ET(e){const t=[];typeof e.content=="string"?t.push({type:"text",text:e.content}):t.push(...Cf(e.content));for(const r of e.tool_calls??[])t.push({type:"tool_call",id:r.id,name:r.name,args:r.args});return t}function Cf(e){const t=[];for(const r of e)_T(r)?t.push(wT(r)):t.push(r);return t}function xT(e){if(e.type==="url_citation"){const{url:t,title:r,start_index:n,end_index:i}=e;return{type:"citation",url:t,title:r,startIndex:n,endIndex:i}}if(e.type==="file_citation"){const{file_id:t,filename:r,index:n}=e;return{type:"citation",title:r,startIndex:n,endIndex:n,fileId:t}}return e}function __(e){function*t(){Ce(e.additional_kwargs?.reasoning)&&Ur(e.additional_kwargs.reasoning.summary)&&(yield{type:"reasoning",reasoning:e.additional_kwargs.reasoning.summary.reduce((i,a)=>Ce(a)&&he(a.text)?`${i}${a.text}`:i,"")});const r=typeof e.content=="string"?[{type:"text",text:e.content}]:e.content;for(const n of r)if(Ee(n,"text")){const{text:i,annotations:a,...s}=n;Array.isArray(a)?yield{...s,type:"text",text:String(i),annotations:a.map(xT)}:yield{...s,type:"text",text:String(i)}}for(const n of e.tool_calls??[])yield{type:"tool_call",id:n.id,name:n.name,args:n.args};if(Ce(e.additional_kwargs)&&Ur(e.additional_kwargs.tool_outputs))for(const n of e.additional_kwargs.tool_outputs){if(Ee(n,"web_search_call")){yield{id:n.id,type:"server_tool_call",name:"web_search",args:{query:n.query}};continue}else if(Ee(n,"file_search_call")){yield{id:n.id,type:"server_tool_call",name:"file_search",args:{query:n.query}};continue}else if(Ee(n,"computer_call")){yield{type:"non_standard",value:n};continue}else if(Ee(n,"code_interpreter_call")){if(he(n.code)&&(yield{id:n.id,type:"server_tool_call",name:"code_interpreter",args:{code:n.code}}),Ur(n.outputs)){const i=hs(()=>{if(n.status!=="in_progress"){if(n.status==="completed")return 0;if(n.status==="incomplete")return 127;if(n.status!=="interpreting"&&n.status==="failed")return 1}});for(const a of n.outputs)if(Ee(a,"logs")){yield{type:"server_tool_call_result",toolCallId:n.id??"",status:"success",output:{type:"code_interpreter_output",returnCode:i??0,stderr:[0,void 0].includes(i)?void 0:String(a.logs),stdout:[0,void 0].includes(i)?String(a.logs):void 0}};continue}}continue}else if(Ee(n,"mcp_call")){yield{id:n.id,type:"server_tool_call",name:"mcp_call",args:n.input};continue}else if(Ee(n,"mcp_list_tools")){yield{id:n.id,type:"server_tool_call",name:"mcp_list_tools",args:n.input};continue}else if(Ee(n,"mcp_approval_request")){yield{type:"non_standard",value:n};continue}else if(Ee(n,"image_generation_call")){yield{type:"non_standard",value:n};continue}Ce(n)&&(yield{type:"non_standard",value:n})}}return Array.from(t())}function ST(e){function*t(){yield*__(e);for(const r of e.tool_call_chunks??[])yield{type:"tool_call_chunk",id:r.id,name:r.name,args:r.args}}return Array.from(t())}const kT={translateContent:e=>typeof e.content=="string"?bT(e):__(e),translateContentChunk:e=>typeof e.content=="string"?ET(e):ST(e)};function IT(e){return typeof e=="object"&&e!==null&&"type"in e&&"content"in e&&(typeof e.content=="string"||Array.isArray(e.content))}function OT(e,t="pretty"){return t==="pretty"?TT(e):JSON.stringify(e)}function TT(e){const t=[],r=` ${e.type.charAt(0).toUpperCase()+e.type.slice(1)} Message `,n=Math.floor((80-r.length)/2),i="=".repeat(n),a=r.length%2===0?i:`${i}=`;if(t.push(`${i}${r}${a}`),e.type==="ai"){const s=e;if(s.tool_calls&&s.tool_calls.length>0){t.push("Tool Calls:");for(const o of s.tool_calls){t.push(`  ${o.name} (${o.id})`),t.push(` Call ID: ${o.id}`),t.push("  Args:");for(const[c,u]of Object.entries(o.args))t.push(`    ${c}: ${u}`)}}}if(e.type==="tool"){const s=e;s.name&&t.push(`Name: ${s.name}`)}return typeof e.content=="string"&&e.content.trim()&&(t.length>1&&t.push(""),t.push(e.content)),t.join(`
`)}const Bu=Symbol.for("langchain.message");function w_(e,t){return typeof e=="string"?e===""?t:typeof t=="string"?e+t:Array.isArray(t)&&t.length===0?e:Array.isArray(t)&&t.some(r=>fs(r))?[{type:"text",source_type:"text",text:e},...t]:[{type:"text",text:e},...t]:Array.isArray(t)?$c(e,t)??[...e,...t]:t===""?e:Array.isArray(e)&&e.some(r=>fs(r))?[...e,{type:"file",source_type:"text",text:t}]:[...e,{type:"text",text:t}]}function RT(e,t){return e==="error"||t==="error"?"error":"success"}function AT(e,t){function r(n,i){if(typeof n!="object"||n===null||n===void 0)return n;if(i>=t)return Array.isArray(n)?"[Array]":"[Object]";if(Array.isArray(n))return n.map(s=>r(s,i+1));const a={};for(const s of Object.keys(n))a[s]=r(n[s],i+1);return a}return JSON.stringify(r(e,0),null,2)}var b_=class extends ls{lc_namespace=["langchain_core","messages"];lc_serializable=!0;get lc_aliases(){return{additional_kwargs:"additional_kwargs",response_metadata:"response_metadata"}}[Bu]=!0;id;name;content;additional_kwargs;response_metadata;_getType(){return this.type}getType(){return this._getType()}constructor(e){const t=typeof e=="string"||Array.isArray(e)?{content:e}:e;t.additional_kwargs||(t.additional_kwargs={}),t.response_metadata||(t.response_metadata={}),super(t),this.name=t.name,t.content===void 0&&t.contentBlocks!==void 0?(this.content=t.contentBlocks,this.response_metadata={output_version:"v1",...t.response_metadata}):t.content!==void 0?(this.content=t.content??[],this.response_metadata=t.response_metadata):(this.content=[],this.response_metadata=t.response_metadata),this.additional_kwargs=t.additional_kwargs,this.id=t.id}get text(){return typeof this.content=="string"?this.content:Array.isArray(this.content)?this.content.map(e=>typeof e=="string"?e:e.type==="text"?e.text:"").join(""):""}get contentBlocks(){const e=typeof this.content=="string"?[{type:"text",text:this.content}]:this.content;return[vT,Cf,pT].reduce((n,i)=>i(n),e)}toDict(){return{type:this.getType(),data:this.toJSON().kwargs}}static lc_name(){return"BaseMessage"}get _printableFields(){return{id:this.id,content:this.content,name:this.name,additional_kwargs:this.additional_kwargs,response_metadata:this.response_metadata}}static isInstance(e){return typeof e=="object"&&e!==null&&Bu in e&&e[Bu]===!0&&IT(e)}_updateId(e){this.id=e,this.lc_kwargs.id=e}get[Symbol.toStringTag](){return this.constructor.lc_name()}[Symbol.for("nodejs.util.inspect.custom")](e){if(e===null)return this;const t=AT(this._printableFields,Math.max(4,e));return`${this.constructor.lc_name()} ${t}`}toFormattedString(e="pretty"){return OT(this,e)}};function wi(e={},t={}){const r={...e};for(const[n,i]of Object.entries(t))if(r[n]==null)r[n]=i;else{if(i==null)continue;if(typeof r[n]!=typeof i||Array.isArray(r[n])!==Array.isArray(i))throw new Error(`field[${n}] already exists in the message chunk, but with a different type.`);if(typeof r[n]=="string"){if(n==="type")continue;["id","name","output_version","model_provider"].includes(n)?r[n]=i:r[n]+=i}else if(typeof r[n]=="object"&&!Array.isArray(r[n]))r[n]=wi(r[n],i);else if(Array.isArray(r[n]))r[n]=$c(r[n],i);else{if(r[n]===i)continue;console.warn(`field[${n}] already exists in this message chunk and value has unsupported type.`)}}return r}function $c(e,t){if(!(e===void 0&&t===void 0)){if(e===void 0||t===void 0)return e||t;{const r=[...e];for(const n of t)if(typeof n=="object"&&n!==null&&"index"in n&&typeof n.index=="number"){const i=r.findIndex(a=>{const s=typeof a=="object",o="index"in a&&a.index===n.index,c="id"in a&&"id"in n&&a?.id===n?.id,u=!("id"in a)||!a?.id||!("id"in n)||!n?.id;return s&&o&&(c||u)});i!==-1&&typeof r[i]=="object"&&r[i]!==null?r[i]=wi(r[i],n):r.push(n)}else{if(typeof n=="object"&&n!==null&&"text"in n&&n.text==="")continue;r.push(n)}return r}}}function $T(e,t){if(!e&&!t)throw new Error("Cannot merge two undefined objects.");if(!e||!t)return e||t;if(typeof e!=typeof t)throw new Error(`Cannot merge objects of different types.
Left ${typeof e}
Right ${typeof t}`);if(typeof e=="string"&&typeof t=="string")return e+t;if(Array.isArray(e)&&Array.isArray(t))return $c(e,t);if(typeof e=="object"&&typeof t=="object")return wi(e,t);if(e===t)return e;throw new Error(`Can not merge objects of different types.
Left ${e}
Right ${t}`)}var E_=class x_ extends b_{static isInstance(t){if(!super.isInstance(t))return!1;let r=Object.getPrototypeOf(t);for(;r!==null;){if(r===x_.prototype)return!0;r=Object.getPrototypeOf(r)}return!1}},CT={};bt(CT,{ToolMessage:()=>NT,ToolMessageChunk:()=>DT,defaultToolCallParser:()=>MT,isDirectToolOutput:()=>PT,isToolMessage:()=>LT,isToolMessageChunk:()=>jT});function PT(e){return e!=null&&typeof e=="object"&&"lc_direct_tool_output"in e&&e.lc_direct_tool_output===!0}var NT=class extends b_{static lc_name(){return"ToolMessage"}get lc_aliases(){return{tool_call_id:"tool_call_id"}}lc_direct_tool_output=!0;type="tool";status;tool_call_id;metadata;artifact;constructor(e,t,r){const n=typeof e=="string"||Array.isArray(e)?{content:e,name:r,tool_call_id:t}:e;super(n),this.tool_call_id=n.tool_call_id,this.artifact=n.artifact,this.status=n.status,this.metadata=n.metadata}static isInstance(e){return super.isInstance(e)&&e.type==="tool"}get _printableFields(){return{...super._printableFields,tool_call_id:this.tool_call_id,artifact:this.artifact}}},DT=class extends E_{type="tool";tool_call_id;status;artifact;constructor(e){super(e),this.tool_call_id=e.tool_call_id,this.artifact=e.artifact,this.status=e.status}static lc_name(){return"ToolMessageChunk"}concat(e){const t=this.constructor;return new t({content:w_(this.content,e.content),additional_kwargs:wi(this.additional_kwargs,e.additional_kwargs),response_metadata:wi(this.response_metadata,e.response_metadata),artifact:$T(this.artifact,e.artifact),tool_call_id:this.tool_call_id,id:this.id??e.id,status:RT(this.status,e.status)})}get _printableFields(){return{...super._printableFields,tool_call_id:this.tool_call_id,artifact:this.artifact}}};function MT(e){const t=[],r=[];for(const n of e)if(n.function){const i=n.function.name;try{const a=JSON.parse(n.function.arguments);t.push({name:i||"",args:a||{},id:n.id})}catch{r.push({name:i,args:n.function.arguments,id:n.id,error:"Malformed args."})}}else continue;return[t,r]}function LT(e){return typeof e=="object"&&e!==null&&"getType"in e&&typeof e.getType=="function"&&e.getType()==="tool"}function jT(e){return e._getType()==="tool"}function FT(e){if(typeof e>"u")return null;try{return JSON.parse(e)}catch{}let t="";const r=[];let n=!1,i=!1;for(let a of e){if(n)a==='"'&&!i?n=!1:a===`
`&&!i?a="\\n":a==="\\"?i=!i:i=!1;else if(a==='"')n=!0,i=!1;else if(a==="{")r.push("}");else if(a==="[")r.push("]");else if(a==="}"||a==="]")if(r&&r[r.length-1]===a)r.pop();else return null;t+=a}n&&(t+='"');for(let a=r.length-1;a>=0;a-=1)t+=r[a];try{return JSON.parse(t)}catch{return null}}function Pf(e){switch(e){case"csv":return"text/csv";case"doc":return"application/vnd.openxmlformats-officedocument.wordprocessingml.document";case"docx":return"application/vnd.openxmlformats-officedocument.wordprocessingml.document";case"html":return"text/html";case"md":return"text/markdown";case"pdf":return"application/pdf";case"txt":return"text/plain";case"xls":return"application/vnd.ms-excel";case"xlsx":return"application/vnd.openxmlformats-officedocument.spreadsheetml.sheet";case"gif":return"image/gif";case"jpeg":return"image/jpeg";case"jpg":return"image/jpeg";case"png":return"image/png";case"webp":return"image/webp";case"flv":return"video/flv";case"mkv":return"video/mkv";case"mov":return"video/mov";case"mp4":return"video/mp4";case"mpeg":return"video/mpeg";case"mpg":return"video/mpg";case"three_gp":return"video/three_gp";case"webm":return"video/webm";case"wmv":return"video/wmv";default:return"application/octet-stream"}}function BT(e){if(Ce(e.document)&&Ce(e.document.source)){const t=Ce(e.document)&&he(e.document.format)?e.document.format:"",r=Pf(t);if(Ce(e.document.source)){if(Ce(e.document.source.s3Location)&&he(e.document.source.s3Location.uri))return{type:"file",mimeType:r,fileId:e.document.source.s3Location.uri};if($f(e.document.source.bytes))return{type:"file",mimeType:r,data:e.document.source.bytes};if(he(e.document.source.text))return{type:"file",mimeType:r,data:Buffer.from(e.document.source.text).toString("base64")};if(Ur(e.document.source.content)){const n=e.document.source.content.reduce((i,a)=>Ce(a)&&he(a.text)?i+a.text:i,"");return{type:"file",mimeType:r,data:n}}}}return{type:"non_standard",value:e}}function zT(e){if(Ee(e,"image")&&Ce(e.image)){const t=Ce(e.image)&&he(e.image.format)?e.image.format:"",r=Pf(t);if(Ce(e.image.source)){if(Ce(e.image.source.s3Location)&&he(e.image.source.s3Location.uri))return{type:"image",mimeType:r,fileId:e.image.source.s3Location.uri};if($f(e.image.source.bytes))return{type:"image",mimeType:r,data:e.image.source.bytes}}}return{type:"non_standard",value:e}}function UT(e){if(Ee(e,"video")&&Ce(e.video)){const t=Ce(e.video)&&he(e.video.format)?e.video.format:"",r=Pf(t);if(Ce(e.video.source)){if(Ce(e.video.source.s3Location)&&he(e.video.source.s3Location.uri))return{type:"video",mimeType:r,fileId:e.video.source.s3Location.uri};if($f(e.video.source.bytes))return{type:"video",mimeType:r,data:e.video.source.bytes}}}return{type:"non_standard",value:e}}function Hp(e){function*t(){const r=typeof e.content=="string"?[{type:"text",text:e.content}]:e.content;for(const n of r){if(Ee(n,"cache_point")){yield{type:"non_standard",value:n};continue}else if(Ee(n,"citations_content")&&Ce(n.citationsContent)){const i=Ur(n.citationsContent.content)?n.citationsContent.content.reduce((s,o)=>Ce(o)&&he(o.text)?s+o.text:s,""):"",a=Ur(n.citationsContent.citations)?n.citationsContent.citations.reduce((s,o)=>{if(Ce(o)){const c=Ur(o.sourceContent)?o.sourceContent.reduce((d,h)=>Ce(h)&&he(h.text)?d+h.text:d,""):"",u=hs(()=>{if(Ce(o.location)){const d=o.location.documentChar||o.location.documentPage||o.location.documentChunk;if(Ce(d))return{source:Ir(d.documentIndex)?d.documentIndex.toString():void 0,startIndex:Ir(d.start)?d.start:void 0,endIndex:Ir(d.end)?d.end:void 0}}return{}});s.push({type:"citation",citedText:c,...u})}return s},[]):[];yield{type:"text",text:i,annotations:a};continue}else if(Ee(n,"document")&&Ce(n.document)){yield BT(n);continue}else if(Ee(n,"guard_content")){yield{type:"non_standard",value:n};continue}else if(Ee(n,"image")&&Ce(n.image)){yield zT(n);continue}else if(Ee(n,"reasoning_content")&&he(n.reasoningText)){yield{type:"reasoning",reasoning:n.reasoningText};continue}else if(Ee(n,"text")&&he(n.text)){yield{type:"text",text:n.text};continue}else if(Ee(n,"tool_result")){yield{type:"non_standard",value:n};continue}else{if(Ee(n,"tool_call"))continue;if(Ee(n,"video")&&Ce(n.video)){yield UT(n);continue}}yield{type:"non_standard",value:n}}}return Array.from(t())}const qT={translateContent:Hp,translateContentChunk:Hp};function Kp(e){function*t(){const r=typeof e.content=="string"?[{type:"text",text:e.content}]:e.content;for(const n of r){if(Ee(n,"text")&&he(n.text)){yield{type:"text",text:n.text};continue}else if(Ee(n,"inlineData")&&Ce(n.inlineData)&&he(n.inlineData.mimeType)&&he(n.inlineData.data)){yield{type:"file",mimeType:n.inlineData.mimeType,data:n.inlineData.data};continue}else if(Ee(n,"functionCall")&&Ce(n.functionCall)&&he(n.functionCall.name)&&Ce(n.functionCall.args)){yield{type:"tool_call",id:e.id,name:n.functionCall.name,args:n.functionCall.args};continue}else if(Ee(n,"functionResponse")){yield{type:"non_standard",value:n};continue}else if(Ee(n,"fileData")&&Ce(n.fileData)&&he(n.fileData.mimeType)&&he(n.fileData.fileUri)){yield{type:"file",mimeType:n.fileData.mimeType,fileId:n.fileData.fileUri};continue}else if(Ee(n,"executableCode")){yield{type:"non_standard",value:n};continue}else if(Ee(n,"codeExecutionResult")){yield{type:"non_standard",value:n};continue}yield{type:"non_standard",value:n}}}return Array.from(t())}const HT={translateContent:Kp,translateContentChunk:Kp};function Gp(e){function*t(){const r=typeof e.content=="string"?[{type:"text",text:e.content}]:e.content;for(const n of r){if(Ee(n,"reasoning")&&he(n.reasoning)){const i=hs(()=>{const a=r.indexOf(n);if(Ur(e.additional_kwargs?.signatures)&&a>=0)return e.additional_kwargs.signatures.at(a)});he(i)?yield{type:"reasoning",reasoning:n.reasoning,signature:i}:yield{type:"reasoning",reasoning:n.reasoning};continue}else if(Ee(n,"text")&&he(n.text)){yield{type:"text",text:n.text};continue}else if(Ee(n,"image_url")){if(he(n.image_url))if(n.image_url.startsWith("data:")){const i=/^data:([^;]+);base64,(.+)$/,a=n.image_url.match(i);a?yield{type:"image",data:a[2],mimeType:a[1]}:yield{type:"image",url:n.image_url}}else yield{type:"image",url:n.image_url};continue}else if(Ee(n,"media")&&he(n.mimeType)&&he(n.data)){yield{type:"file",mimeType:n.mimeType,data:n.data};continue}yield{type:"non_standard",value:n}}}return Array.from(t())}const KT={translateContent:Gp,translateContentChunk:Gp};globalThis.lc_block_translators_registry??=new Map([["anthropic",mT],["bedrock-converse",qT],["google-genai",HT],["google-vertexai",KT],["openai",kT]]);function GT(e){return globalThis.lc_block_translators_registry.get(e)}function WT(e,t){return wi(e??{},t??{})}function S_(e,t){const r={};return(e?.audio!==void 0||t?.audio!==void 0)&&(r.audio=(e?.audio??0)+(t?.audio??0)),(e?.image!==void 0||t?.image!==void 0)&&(r.image=(e?.image??0)+(t?.image??0)),(e?.video!==void 0||t?.video!==void 0)&&(r.video=(e?.video??0)+(t?.video??0)),(e?.document!==void 0||t?.document!==void 0)&&(r.document=(e?.document??0)+(t?.document??0)),(e?.text!==void 0||t?.text!==void 0)&&(r.text=(e?.text??0)+(t?.text??0)),r}function VT(e,t){const r={...S_(e,t)};return(e?.cache_read!==void 0||t?.cache_read!==void 0)&&(r.cache_read=(e?.cache_read??0)+(t?.cache_read??0)),(e?.cache_creation!==void 0||t?.cache_creation!==void 0)&&(r.cache_creation=(e?.cache_creation??0)+(t?.cache_creation??0)),r}function ZT(e,t){const r={...S_(e,t)};return(e?.reasoning!==void 0||t?.reasoning!==void 0)&&(r.reasoning=(e?.reasoning??0)+(t?.reasoning??0)),r}function JT(e,t){return{input_tokens:(e?.input_tokens??0)+(t?.input_tokens??0),output_tokens:(e?.output_tokens??0)+(t?.output_tokens??0),total_tokens:(e?.total_tokens??0)+(t?.total_tokens??0),input_token_details:VT(e?.input_token_details,t?.input_token_details),output_token_details:ZT(e?.output_token_details,t?.output_token_details)}}var k_=class extends E_{type="ai";tool_calls=[];invalid_tool_calls=[];tool_call_chunks=[];usage_metadata;constructor(e){let t;if(typeof e=="string"||Array.isArray(e))t={content:e,tool_calls:[],invalid_tool_calls:[],tool_call_chunks:[]};else if(e.tool_call_chunks===void 0||e.tool_call_chunks.length===0)t={...e,tool_calls:e.tool_calls??[],invalid_tool_calls:[],tool_call_chunks:[],usage_metadata:e.usage_metadata!==void 0?e.usage_metadata:void 0};else{const n=(e.tool_call_chunks??[]).reduce((s,o)=>{const c=s.findIndex(([u])=>"id"in o&&o.id&&"index"in o&&o.index!==void 0?o.id===u.id&&o.index===u.index:"id"in o&&o.id?o.id===u.id:"index"in o&&o.index!==void 0?o.index===u.index:!1);return c!==-1?s[c].push(o):s.push([o]),s},[]),i=[],a=[];for(const s of n){let o=null;const c=s[0]?.name??"",u=s.map(p=>p.args||"").join(""),d=u.length?u:"{}",h=s[0]?.id;try{if(o=FT(d),!h||o===null||typeof o!="object"||Array.isArray(o))throw new Error("Malformed tool call chunk args.");i.push({name:c,args:o,id:h,type:"tool_call"})}catch{a.push({name:c,args:d,id:h,error:"Malformed args.",type:"invalid_tool_call"})}}t={...e,tool_calls:i,invalid_tool_calls:a,usage_metadata:e.usage_metadata!==void 0?e.usage_metadata:void 0}}super(t),this.tool_call_chunks=t.tool_call_chunks??this.tool_call_chunks,this.tool_calls=t.tool_calls??this.tool_calls,this.invalid_tool_calls=t.invalid_tool_calls??this.invalid_tool_calls,this.usage_metadata=t.usage_metadata}get lc_aliases(){return{...super.lc_aliases,tool_calls:"tool_calls",invalid_tool_calls:"invalid_tool_calls",tool_call_chunks:"tool_call_chunks"}}static lc_name(){return"AIMessageChunk"}get contentBlocks(){if(this.response_metadata&&"output_version"in this.response_metadata&&this.response_metadata.output_version==="v1")return this.content;if(this.response_metadata&&"model_provider"in this.response_metadata&&typeof this.response_metadata.model_provider=="string"){const t=GT(this.response_metadata.model_provider);if(t)return t.translateContent(this)}const e=super.contentBlocks;if(this.tool_calls&&typeof this.content!="string"){const t=this.content.filter(r=>r.type==="tool_call").map(r=>r.id);for(const r of this.tool_calls)r.id&&!t.includes(r.id)&&e.push({...r,type:"tool_call",id:r.id,name:r.name,args:r.args})}return e}get _printableFields(){return{...super._printableFields,tool_calls:this.tool_calls,tool_call_chunks:this.tool_call_chunks,invalid_tool_calls:this.invalid_tool_calls,usage_metadata:this.usage_metadata}}concat(e){const t={content:w_(this.content,e.content),additional_kwargs:wi(this.additional_kwargs,e.additional_kwargs),response_metadata:WT(this.response_metadata,e.response_metadata),tool_call_chunks:[],id:this.id??e.id};if(this.tool_call_chunks!==void 0||e.tool_call_chunks!==void 0){const n=$c(this.tool_call_chunks,e.tool_call_chunks);n!==void 0&&n.length>0&&(t.tool_call_chunks=n)}(this.usage_metadata!==void 0||e.usage_metadata!==void 0)&&(t.usage_metadata=JT(this.usage_metadata,e.usage_metadata));const r=this.constructor;return new r(t)}static isInstance(e){return super.isInstance(e)&&e.type==="ai"}};function QT(e,t="Human",r="AI"){const n=[];for(const i of e){let a;if(i._getType()==="human")a=t;else if(i._getType()==="ai")a=r;else if(i._getType()==="system")a="System";else if(i._getType()==="tool")a="Tool";else if(i._getType()==="generic")a=i.role;else throw new Error(`Got unsupported message type: ${i._getType()}`);const s=i.name?`${i.name}, `:"",o=typeof i.content=="string"?i.content:JSON.stringify(i.content,null,2);n.push(`${a}: ${s}${o}`)}return n.join(`
`)}var YT={},XT={};bt(XT,{getEnv:()=>A_,getEnvironmentVariable:()=>fi,getRuntimeEnvironment:()=>$_,isBrowser:()=>I_,isDeno:()=>Cc,isJsDom:()=>T_,isNode:()=>R_,isWebWorker:()=>O_});const I_=()=>typeof window<"u"&&typeof window.document<"u",O_=()=>typeof globalThis=="object"&&globalThis.constructor&&globalThis.constructor.name==="DedicatedWorkerGlobalScope",T_=()=>typeof window<"u"&&window.name==="nodejs"||typeof navigator<"u"&&navigator.userAgent.includes("jsdom"),Cc=()=>typeof Deno<"u",R_=()=>typeof process<"u"&&typeof process.versions<"u"&&typeof process.versions.node<"u"&&!Cc(),A_=()=>{let e;return I_()?e="browser":R_()?e="node":O_()?e="webworker":T_()?e="jsdom":Cc()?e="deno":e="other",e};let zu;function $_(){return zu===void 0&&(zu={library:"langchain-js",runtime:A_()}),zu}function fi(e){try{return typeof process<"u"?YT?.[e]:Cc()?Deno?.env.get(e):void 0}catch{return}}const eR=/^(?:[0-9a-f]{8}-[0-9a-f]{4}-[1-8][0-9a-f]{3}-[89ab][0-9a-f]{3}-[0-9a-f]{12}|00000000-0000-0000-0000-000000000000|ffffffff-ffff-ffff-ffff-ffffffffffff)$/i;function Fo(e){return typeof e=="string"&&eR.test(e)}var It=[];for(var Uu=0;Uu<256;++Uu)It.push((Uu+256).toString(16).slice(1));function tR(e,t=0){return(It[e[t+0]]+It[e[t+1]]+It[e[t+2]]+It[e[t+3]]+"-"+It[e[t+4]]+It[e[t+5]]+"-"+It[e[t+6]]+It[e[t+7]]+"-"+It[e[t+8]]+It[e[t+9]]+"-"+It[e[t+10]]+It[e[t+11]]+It[e[t+12]]+It[e[t+13]]+It[e[t+14]]+It[e[t+15]]).toLowerCase()}var yo,rR=new Uint8Array(16);function nR(){if(!yo&&(yo=typeof crypto<"u"&&crypto.getRandomValues&&crypto.getRandomValues.bind(crypto),!yo))throw new Error("crypto.getRandomValues() not supported. See https://github.com/uuidjs/uuid#getrandomvalues-not-supported");return yo(rR)}var iR=typeof crypto<"u"&&crypto.randomUUID&&crypto.randomUUID.bind(crypto);const Wp={randomUUID:iR};function Xr(e,t,r){if(Wp.randomUUID&&!e)return Wp.randomUUID();e=e||{};var n=e.random||(e.rng||nR)();return n[6]=n[6]&15|64,n[8]=n[8]&63|128,tR(n)}var aR={};bt(aR,{BaseCallbackHandler:()=>Ms,callbackHandlerPrefersStreaming:()=>oR,isBaseCallbackHandler:()=>C_});var sR=class{};function oR(e){return"lc_prefer_streaming"in e&&e.lc_prefer_streaming}var Ms=class extends sR{lc_serializable=!1;get lc_namespace(){return["langchain_core","callbacks",this.name]}get lc_secrets(){}get lc_attributes(){}get lc_aliases(){}get lc_serializable_keys(){}static lc_name(){return this.name}get lc_id(){return[...this.lc_namespace,Af(this.constructor)]}lc_kwargs;ignoreLLM=!1;ignoreChain=!1;ignoreAgent=!1;ignoreRetriever=!1;ignoreCustomEvent=!1;raiseError=!1;awaitHandlers=fi("LANGCHAIN_CALLBACKS_BACKGROUND")==="false";constructor(e){super(),this.lc_kwargs=e||{},e&&(this.ignoreLLM=e.ignoreLLM??this.ignoreLLM,this.ignoreChain=e.ignoreChain??this.ignoreChain,this.ignoreAgent=e.ignoreAgent??this.ignoreAgent,this.ignoreRetriever=e.ignoreRetriever??this.ignoreRetriever,this.ignoreCustomEvent=e.ignoreCustomEvent??this.ignoreCustomEvent,this.raiseError=e.raiseError??this.raiseError,this.awaitHandlers=this.raiseError||(e._awaitHandler??this.awaitHandlers))}copy(){return new this.constructor(this)}toJSON(){return ls.prototype.toJSON.call(this)}toJSONNotImplemented(){return ls.prototype.toJSONNotImplemented.call(this)}static fromMethods(e){class t extends Ms{name=Xr();constructor(){super(),Object.assign(this,e)}}return new t}};const C_=e=>{const t=e;return t!==void 0&&typeof t.copy=="function"&&typeof t.name=="string"&&typeof t.awaitHandlers=="boolean"};var Ot=[];for(var qu=0;qu<256;++qu)Ot.push((qu+256).toString(16).slice(1));function P_(e,t=0){return(Ot[e[t+0]]+Ot[e[t+1]]+Ot[e[t+2]]+Ot[e[t+3]]+"-"+Ot[e[t+4]]+Ot[e[t+5]]+"-"+Ot[e[t+6]]+Ot[e[t+7]]+"-"+Ot[e[t+8]]+Ot[e[t+9]]+"-"+Ot[e[t+10]]+Ot[e[t+11]]+Ot[e[t+12]]+Ot[e[t+13]]+Ot[e[t+14]]+Ot[e[t+15]]).toLowerCase()}var vo,cR=new Uint8Array(16);function N_(){if(!vo&&(vo=typeof crypto<"u"&&crypto.getRandomValues&&crypto.getRandomValues.bind(crypto),!vo))throw new Error("crypto.getRandomValues() not supported. See https://github.com/uuidjs/uuid#getrandomvalues-not-supported");return vo(cR)}var uR=typeof crypto<"u"&&crypto.randomUUID&&crypto.randomUUID.bind(crypto);const Vp={randomUUID:uR};function $a(e,t,r){if(Vp.randomUUID&&!e)return Vp.randomUUID();e=e||{};var n=e.random||(e.rng||N_)();return n[6]=n[6]&15|64,n[8]=n[8]&63|128,P_(n)}var Zp=null,Jp=null,Er=0;function lR(e,t,r){e=e||{};var n=0,i=new Uint8Array(16),a=e.random||(e.rng||N_)(),s=e.msecs!==void 0?e.msecs:Date.now(),o=e.seq!==void 0?e.seq:null,c=Jp,u=Zp;return s>Er&&e.msecs===void 0&&(Er=s,o!==null&&(c=null,u=null)),o!==null&&(o>2147483647&&(o=2147483647),c=o>>>19&4095,u=o&524287),(c===null||u===null)&&(c=a[6]&127,c=c<<8|a[7],u=a[8]&63,u=u<<8|a[9],u=u<<5|a[10]>>>3),s+1e4>Er&&o===null?++u>524287&&(u=0,++c>4095&&(c=0,Er++)):Er=s,Jp=c,Zp=u,i[n++]=Er/1099511627776&255,i[n++]=Er/4294967296&255,i[n++]=Er/16777216&255,i[n++]=Er/65536&255,i[n++]=Er/256&255,i[n++]=Er&255,i[n++]=c>>>4&15|112,i[n++]=c&255,i[n++]=u>>>13&63|128,i[n++]=u>>>5&255,i[n++]=u<<3&255|a[10]&7,i[n++]=a[11],i[n++]=a[12],i[n++]=a[13],i[n++]=a[14],i[n++]=a[15],t||P_(i)}const dR="gen_ai.operation.name",fR="gen_ai.system",Qp="gen_ai.request.model",hR="gen_ai.response.model",Yp="gen_ai.usage.input_tokens",Xp="gen_ai.usage.output_tokens",em="gen_ai.usage.total_tokens",pR="gen_ai.request.max_tokens",mR="gen_ai.request.temperature",gR="gen_ai.request.top_p",yR="gen_ai.request.frequency_penalty",vR="gen_ai.request.presence_penalty",_R="gen_ai.response.finish_reasons",wR="gen_ai.prompt",bR="gen_ai.completion",ER="gen_ai.request.extra_query",xR="gen_ai.request.extra_body",SR="gen_ai.serialized.name",kR="gen_ai.serialized.signature",IR="gen_ai.serialized.doc",OR="gen_ai.response.id",TR="gen_ai.response.service_tier",RR="gen_ai.response.system_fingerprint",AR="gen_ai.usage.input_token_details",$R="gen_ai.usage.output_token_details",CR="langsmith.trace.session_id",PR="langsmith.trace.session_name",NR="langsmith.span.kind",DR="langsmith.trace.name",MR="langsmith.metadata",tm="langsmith.span.tags",LR="langsmith.request.streaming",jR="langsmith.request.headers",FR=(...e)=>fetch(...e),D_=Symbol.for("ls:fetch_implementation"),BR=()=>{const e=globalThis[D_];return e?typeof e=="function"&&"Headers"in e&&"Request"in e&&"Response"in e:!1},zR=e=>async(...t)=>{if(e||Kt("DEBUG")==="true"){const[n,i]=t;console.log(` ${i?.method||"GET"} ${n}`)}const r=await(globalThis[D_]??FR)(...t);return(e||Kt("DEBUG")==="true")&&console.log(` ${r.status} ${r.statusText} ${r.url}`),r},M_=()=>Kt("PROJECT")??Kr("LANGCHAIN_SESSION")??"default",rm={};function Od(e){rm[e]||(console.warn(e),rm[e]=!0)}const UR=/^[0-9a-f]{8}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{12}$/i;function De(e,t){if(!UR.test(e)){const r=t!==void 0?`Invalid UUID for ${t}: ${e}`:`Invalid UUID: ${e}`;throw new Error(r)}return e}function qR(e){const t=typeof e=="string"?Date.parse(e):e;return lR({msecs:t,seq:0})}const L_="0.3.81";var Td={};let jr;const HR=()=>typeof window<"u"&&typeof window.document<"u",KR=()=>typeof globalThis=="object"&&globalThis.constructor&&globalThis.constructor.name==="DedicatedWorkerGlobalScope",GR=()=>typeof window<"u"&&window.name==="nodejs"||typeof navigator<"u"&&navigator.userAgent.includes("jsdom"),j_=()=>typeof Deno<"u",WR=()=>typeof process<"u"&&typeof process.versions<"u"&&typeof process.versions.node<"u"&&!j_(),F_=()=>jr||(typeof Bun<"u"?jr="bun":HR()?jr="browser":WR()?jr="node":KR()?jr="webworker":GR()?jr="jsdom":j_()?jr="deno":jr="other",jr);let Hu;function B_(){if(Hu===void 0){const e=F_(),t=ZR();Hu={library:"langsmith",runtime:e,sdk:"langsmith-js",sdk_version:L_,...t}}return Hu}function z_(){const e=VR(),t={},r=["LANGCHAIN_API_KEY","LANGCHAIN_ENDPOINT","LANGCHAIN_TRACING_V2","LANGCHAIN_PROJECT","LANGCHAIN_SESSION","LANGSMITH_API_KEY","LANGSMITH_ENDPOINT","LANGSMITH_TRACING_V2","LANGSMITH_PROJECT","LANGSMITH_SESSION"];for(const[n,i]of Object.entries(e))typeof i=="string"&&!r.includes(n)&&!n.toLowerCase().includes("key")&&!n.toLowerCase().includes("secret")&&!n.toLowerCase().includes("token")&&(n==="LANGCHAIN_REVISION_ID"?t.revision_id=i:t[n]=i);return t}function VR(){const e={};try{if(typeof process<"u"&&Td)for(const[t,r]of Object.entries(Td))(t.startsWith("LANGCHAIN_")||t.startsWith("LANGSMITH_"))&&r!=null&&((t.toLowerCase().includes("key")||t.toLowerCase().includes("secret")||t.toLowerCase().includes("token"))&&typeof r=="string"?e[t]=r.slice(0,2)+"*".repeat(r.length-4)+r.slice(-2):e[t]=r)}catch{}return e}function Kr(e){try{return typeof process<"u"?Td?.[e]:void 0}catch{return}}function Kt(e){return Kr(`LANGSMITH_${e}`)||Kr(`LANGCHAIN_${e}`)}let Ku;function ZR(){if(Ku!==void 0)return Ku;const e=["VERCEL_GIT_COMMIT_SHA","NEXT_PUBLIC_VERCEL_GIT_COMMIT_SHA","COMMIT_REF","RENDER_GIT_COMMIT","CI_COMMIT_SHA","CIRCLE_SHA1","CF_PAGES_COMMIT_SHA","REACT_APP_GIT_SHA","SOURCE_VERSION","GITHUB_SHA","TRAVIS_COMMIT","GIT_COMMIT","BUILD_VCS_NUMBER","bamboo_planRepository_revision","Build.SourceVersion","BITBUCKET_COMMIT","DRONE_COMMIT_SHA","SEMAPHORE_GIT_SHA","BUILDKITE_COMMIT"],t={};for(const r of e){const n=Kr(r);n!==void 0&&(t[r]=n)}return Ku=t,t}function U_(){return Kr("OTEL_ENABLED")==="true"||Kt("OTEL_ENABLED")==="true"}class JR{constructor(){Object.defineProperty(this,"hasWarned",{enumerable:!0,configurable:!0,writable:!0,value:!1})}startActiveSpan(t,...r){!this.hasWarned&&U_()&&(console.warn('You have enabled OTEL export via the `OTEL_ENABLED` or `LANGSMITH_OTEL_ENABLED` environment variable, but have not initialized the required OTEL instances. Please add:\n```\nimport { initializeOTEL } from "langsmith/experimental/otel/setup";\ninitializeOTEL();\n```\nat the beginning of your code.'),this.hasWarned=!0);let n;if(r.length===1&&typeof r[0]=="function"?n=r[0]:r.length===2&&typeof r[1]=="function"?n=r[1]:r.length===3&&typeof r[2]=="function"&&(n=r[2]),typeof n=="function")return n()}}class QR{constructor(){Object.defineProperty(this,"mockTracer",{enumerable:!0,configurable:!0,writable:!0,value:new JR})}getTracer(t,r){return this.mockTracer}getActiveSpan(){}setSpan(t,r){return t}getSpan(t){}setSpanContext(t,r){return t}getTracerProvider(){}setGlobalTracerProvider(t){return!1}}class YR{active(){return{}}with(t,r){return r()}}const Gu=Symbol.for("ls:otel_trace"),Wu=Symbol.for("ls:otel_context"),nm=Symbol.for("ls:otel_get_default_otlp_tracer_provider"),XR=new QR,eA=new YR;class tA{getTraceInstance(){return globalThis[Gu]??XR}getContextInstance(){return globalThis[Wu]??eA}initializeGlobalInstances(t){globalThis[Gu]===void 0&&(globalThis[Gu]=t.trace),globalThis[Wu]===void 0&&(globalThis[Wu]=t.context)}setDefaultOTLPTracerComponents(t){globalThis[nm]=t}getDefaultOTLPTracerComponents(){return globalThis[nm]??void 0}}const Nf=new tA;function q_(){return Nf.getTraceInstance()}function rA(){return Nf.getContextInstance()}function nA(){return Nf.getDefaultOTLPTracerComponents()}const iA={llm:"chat",tool:"execute_tool",retriever:"embeddings",embedding:"embeddings",prompt:"chat"};function aA(e){return iA[e]||e}class sA{constructor(){Object.defineProperty(this,"spans",{enumerable:!0,configurable:!0,writable:!0,value:new Map})}exportBatch(t,r){for(const n of t)try{if(!n.run)continue;if(n.operation==="post"){const i=this.createSpanForRun(n,n.run,r.get(n.id));i&&!n.run.end_time&&this.spans.set(n.id,i)}else this.updateSpanForRun(n,n.run)}catch(i){console.error(`Error processing operation ${n.id}:`,i)}}createSpanForRun(t,r,n){const i=n&&q_().getSpan(n);if(i)try{return this.finishSpanSetup(i,r,t)}catch(a){console.error(`Failed to create span for run ${t.id}:`,a);return}}finishSpanSetup(t,r,n){return this.setSpanAttributes(t,r,n),r.error?(t.setStatus({code:2}),t.recordException(new Error(r.error))):t.setStatus({code:1}),r.end_time&&t.end(new Date(r.end_time)),t}updateSpanForRun(t,r){try{const n=this.spans.get(t.id);if(!n){console.debug(`No span found for run ${t.id} during update`);return}this.setSpanAttributes(n,r,t),r.error?(n.setStatus({code:2}),n.recordException(new Error(r.error))):n.setStatus({code:1});const i=r.end_time;i&&(n.end(new Date(i)),this.spans.delete(t.id))}catch(n){console.error(`Failed to update span for run ${t.id}:`,n)}}extractModelName(t){if(t.extra?.metadata){const r=t.extra.metadata;if(r.ls_model_name)return r.ls_model_name;if(r.invocation_params){const n=r.invocation_params;if(n.model)return n.model;if(n.model_name)return n.model_name}}}setSpanAttributes(t,r,n){if("run_type"in r&&r.run_type){t.setAttribute(NR,r.run_type);const o=aA(r.run_type||"chain");t.setAttribute(dR,o)}"name"in r&&r.name&&t.setAttribute(DR,r.name),"session_id"in r&&r.session_id&&t.setAttribute(CR,r.session_id),"session_name"in r&&r.session_name&&t.setAttribute(PR,r.session_name),this.setGenAiSystem(t,r);const i=this.extractModelName(r);i&&t.setAttribute(Qp,i),"prompt_tokens"in r&&typeof r.prompt_tokens=="number"&&t.setAttribute(Yp,r.prompt_tokens),"completion_tokens"in r&&typeof r.completion_tokens=="number"&&t.setAttribute(Xp,r.completion_tokens),"total_tokens"in r&&typeof r.total_tokens=="number"&&t.setAttribute(em,r.total_tokens),this.setInvocationParameters(t,r);const a=r.extra?.metadata||{};for(const[o,c]of Object.entries(a))c!=null&&t.setAttribute(`${MR}.${o}`,String(c));const s=r.tags;if(s&&Array.isArray(s)?t.setAttribute(tm,s.join(", ")):s&&t.setAttribute(tm,String(s)),"serialized"in r&&typeof r.serialized=="object"){const o=r.serialized;o.name&&t.setAttribute(SR,String(o.name)),o.signature&&t.setAttribute(kR,String(o.signature)),o.doc&&t.setAttribute(IR,String(o.doc))}this.setIOAttributes(t,n)}setGenAiSystem(t,r){let n="langchain";const i=this.extractModelName(r);if(i){const a=i.toLowerCase();a.includes("anthropic")||a.startsWith("claude")?n="anthropic":a.includes("bedrock")?n="aws.bedrock":a.includes("azure")&&a.includes("openai")?n="az.ai.openai":a.includes("azure")&&a.includes("inference")?n="az.ai.inference":a.includes("cohere")?n="cohere":a.includes("deepseek")?n="deepseek":a.includes("gemini")?n="gemini":a.includes("groq")?n="groq":a.includes("watson")||a.includes("ibm")?n="ibm.watsonx.ai":a.includes("mistral")?n="mistral_ai":a.includes("gpt")||a.includes("openai")?n="openai":a.includes("perplexity")||a.includes("sonar")?n="perplexity":a.includes("vertex")?n="vertex_ai":(a.includes("xai")||a.includes("grok"))&&(n="xai")}t.setAttribute(fR,n)}setInvocationParameters(t,r){if(!r.extra?.metadata?.invocation_params)return;const n=r.extra.metadata.invocation_params;n.max_tokens!==void 0&&t.setAttribute(pR,n.max_tokens),n.temperature!==void 0&&t.setAttribute(mR,n.temperature),n.top_p!==void 0&&t.setAttribute(gR,n.top_p),n.frequency_penalty!==void 0&&t.setAttribute(yR,n.frequency_penalty),n.presence_penalty!==void 0&&t.setAttribute(vR,n.presence_penalty)}setIOAttributes(t,r){if(r.run.inputs)try{const n=r.run.inputs;typeof n=="object"&&n!==null&&(n.model&&Array.isArray(n.messages)&&t.setAttribute(Qp,n.model),n.stream!==void 0&&t.setAttribute(LR,n.stream),n.extra_headers&&t.setAttribute(jR,JSON.stringify(n.extra_headers)),n.extra_query&&t.setAttribute(ER,JSON.stringify(n.extra_query)),n.extra_body&&t.setAttribute(xR,JSON.stringify(n.extra_body))),t.setAttribute(wR,JSON.stringify(n))}catch(n){console.debug(`Failed to process inputs for run ${r.id}`,n)}if(r.run.outputs)try{const n=r.run.outputs,i=this.getUnifiedRunTokens(n);if(i&&(t.setAttribute(Yp,i[0]),t.setAttribute(Xp,i[1]),t.setAttribute(em,i[0]+i[1])),n&&typeof n=="object"){if(n.model&&t.setAttribute(hR,String(n.model)),n.id&&t.setAttribute(OR,n.id),n.choices&&Array.isArray(n.choices)){const a=n.choices.map(s=>s.finish_reason).filter(s=>s).map(String);a.length>0&&t.setAttribute(_R,a.join(", "))}if(n.service_tier&&t.setAttribute(TR,n.service_tier),n.system_fingerprint&&t.setAttribute(RR,n.system_fingerprint),n.usage_metadata&&typeof n.usage_metadata=="object"){const a=n.usage_metadata;a.input_token_details&&t.setAttribute(AR,JSON.stringify(a.input_token_details)),a.output_token_details&&t.setAttribute($R,JSON.stringify(a.output_token_details))}}t.setAttribute(bR,JSON.stringify(n))}catch(n){console.debug(`Failed to process outputs for run ${r.id}`,n)}}getUnifiedRunTokens(t){if(!t)return null;let r=this.extractUnifiedRunTokens(t.usage_metadata);if(r)return r;const n=Object.keys(t);for(const s of n){const o=t[s];if(!(!o||typeof o!="object")&&(r=this.extractUnifiedRunTokens(o.usage_metadata),r||o.lc===1&&o.kwargs&&typeof o.kwargs=="object"&&(r=this.extractUnifiedRunTokens(o.kwargs.usage_metadata),r)))return r}const i=t.generations||[];if(!Array.isArray(i))return null;const a=Array.isArray(i[0])?i.flat():i;for(const s of a)if(typeof s=="object"&&s.message&&typeof s.message=="object"&&s.message.kwargs&&typeof s.message.kwargs=="object"&&(r=this.extractUnifiedRunTokens(s.message.kwargs.usage_metadata),r))return r;return null}extractUnifiedRunTokens(t){return!t||typeof t!="object"||typeof t.input_tokens!="number"||typeof t.output_tokens!="number"?null:[t.input_tokens,t.output_tokens]}}var Ca={exports:{}},Vu={},Zu,im;function oA(){if(im)return Zu;im=1;function e(t,r){typeof r=="boolean"&&(r={forever:r}),this._originalTimeouts=JSON.parse(JSON.stringify(t)),this._timeouts=t,this._options=r||{},this._maxRetryTime=r&&r.maxRetryTime||1/0,this._fn=null,this._errors=[],this._attempts=1,this._operationTimeout=null,this._operationTimeoutCb=null,this._timeout=null,this._operationStart=null,this._timer=null,this._options.forever&&(this._cachedTimeouts=this._timeouts.slice(0))}return Zu=e,e.prototype.reset=function(){this._attempts=1,this._timeouts=this._originalTimeouts.slice(0)},e.prototype.stop=function(){this._timeout&&clearTimeout(this._timeout),this._timer&&clearTimeout(this._timer),this._timeouts=[],this._cachedTimeouts=null},e.prototype.retry=function(t){if(this._timeout&&clearTimeout(this._timeout),!t)return!1;var r=new Date().getTime();if(t&&r-this._operationStart>=this._maxRetryTime)return this._errors.push(t),this._errors.unshift(new Error("RetryOperation timeout occurred")),!1;this._errors.push(t);var n=this._timeouts.shift();if(n===void 0)if(this._cachedTimeouts)this._errors.splice(0,this._errors.length-1),n=this._cachedTimeouts.slice(-1);else return!1;var i=this;return this._timer=setTimeout(function(){i._attempts++,i._operationTimeoutCb&&(i._timeout=setTimeout(function(){i._operationTimeoutCb(i._attempts)},i._operationTimeout),i._options.unref&&i._timeout.unref()),i._fn(i._attempts)},n),this._options.unref&&this._timer.unref(),!0},e.prototype.attempt=function(t,r){this._fn=t,r&&(r.timeout&&(this._operationTimeout=r.timeout),r.cb&&(this._operationTimeoutCb=r.cb));var n=this;this._operationTimeoutCb&&(this._timeout=setTimeout(function(){n._operationTimeoutCb()},n._operationTimeout)),this._operationStart=new Date().getTime(),this._fn(this._attempts)},e.prototype.try=function(t){console.log("Using RetryOperation.try() is deprecated"),this.attempt(t)},e.prototype.start=function(t){console.log("Using RetryOperation.start() is deprecated"),this.attempt(t)},e.prototype.start=e.prototype.try,e.prototype.errors=function(){return this._errors},e.prototype.attempts=function(){return this._attempts},e.prototype.mainError=function(){if(this._errors.length===0)return null;for(var t={},r=null,n=0,i=0;i<this._errors.length;i++){var a=this._errors[i],s=a.message,o=(t[s]||0)+1;t[s]=o,o>=n&&(r=a,n=o)}return r},Zu}var am;function cA(){return am||(am=1,(function(e){var t=oA();e.operation=function(r){var n=e.timeouts(r);return new t(n,{forever:r&&(r.forever||r.retries===1/0),unref:r&&r.unref,maxRetryTime:r&&r.maxRetryTime})},e.timeouts=function(r){if(r instanceof Array)return[].concat(r);var n={retries:10,factor:2,minTimeout:1*1e3,maxTimeout:1/0,randomize:!1};for(var i in r)n[i]=r[i];if(n.minTimeout>n.maxTimeout)throw new Error("minTimeout is greater than maxTimeout");for(var a=[],s=0;s<n.retries;s++)a.push(this.createTimeout(s,n));return r&&r.forever&&!a.length&&a.push(this.createTimeout(s,n)),a.sort(function(o,c){return o-c}),a},e.createTimeout=function(r,n){var i=n.randomize?Math.random()+1:1,a=Math.round(i*Math.max(n.minTimeout,1)*Math.pow(n.factor,r));return a=Math.min(a,n.maxTimeout),a},e.wrap=function(r,n,i){if(n instanceof Array&&(i=n,n=null),!i){i=[];for(var a in r)typeof r[a]=="function"&&i.push(a)}for(var s=0;s<i.length;s++){var o=i[s],c=r[o];r[o]=(function(d){var h=e.operation(n),p=Array.prototype.slice.call(arguments,1),y=p.pop();p.push(function(g){h.retry(g)||(g&&(arguments[0]=h.mainError()),y.apply(this,arguments))}),h.attempt(function(){d.apply(r,p)})}).bind(r,c),r[o].options=n}}})(Vu)),Vu}var Ju,sm;function uA(){return sm||(sm=1,Ju=cA()),Ju}var om;function lA(){if(om)return Ca.exports;om=1;const e=uA(),t=["Failed to fetch","NetworkError when attempting to fetch resource.","The Internet connection appears to be offline.","Network request failed"];class r extends Error{constructor(o){super(),o instanceof Error?(this.originalError=o,{message:o}=o):(this.originalError=new Error(o),this.originalError.stack=this.stack),this.name="AbortError",this.message=o}}const n=(s,o,c)=>{const u=c.retries-(o-1);return s.attemptNumber=o,s.retriesLeft=u,s},i=s=>t.includes(s),a=(s,o)=>new Promise((c,u)=>{o={onFailedAttempt:()=>{},retries:10,...o};const d=e.operation(o);d.attempt(async h=>{try{c(await s(h))}catch(p){if(!(p instanceof Error)){u(new TypeError(`Non-error was thrown: "${p}". You should only throw errors.`));return}if(p instanceof r)d.stop(),u(p.originalError);else if(p instanceof TypeError&&!i(p.message))d.stop(),u(p);else{n(p,h,o);try{await o.onFailedAttempt(p)}catch(y){u(y);return}d.retry(p)||u(d.mainError())}}})});return Ca.exports=a,Ca.exports.default=a,Ca.exports.AbortError=r,Ca.exports}var dA=lA();const fA=fa(dA);var _o={},Qu={exports:{}},cm;function hA(){return cm||(cm=1,(function(e){var t=Object.prototype.hasOwnProperty,r="~";function n(){}Object.create&&(n.prototype=Object.create(null),new n().__proto__||(r=!1));function i(c,u,d){this.fn=c,this.context=u,this.once=d||!1}function a(c,u,d,h,p){if(typeof d!="function")throw new TypeError("The listener must be a function");var y=new i(d,h||c,p),g=r?r+u:u;return c._events[g]?c._events[g].fn?c._events[g]=[c._events[g],y]:c._events[g].push(y):(c._events[g]=y,c._eventsCount++),c}function s(c,u){--c._eventsCount===0?c._events=new n:delete c._events[u]}function o(){this._events=new n,this._eventsCount=0}o.prototype.eventNames=function(){var u=[],d,h;if(this._eventsCount===0)return u;for(h in d=this._events)t.call(d,h)&&u.push(r?h.slice(1):h);return Object.getOwnPropertySymbols?u.concat(Object.getOwnPropertySymbols(d)):u},o.prototype.listeners=function(u){var d=r?r+u:u,h=this._events[d];if(!h)return[];if(h.fn)return[h.fn];for(var p=0,y=h.length,g=new Array(y);p<y;p++)g[p]=h[p].fn;return g},o.prototype.listenerCount=function(u){var d=r?r+u:u,h=this._events[d];return h?h.fn?1:h.length:0},o.prototype.emit=function(u,d,h,p,y,g){var w=r?r+u:u;if(!this._events[w])return!1;var b=this._events[w],S=arguments.length,O,T;if(b.fn){switch(b.once&&this.removeListener(u,b.fn,void 0,!0),S){case 1:return b.fn.call(b.context),!0;case 2:return b.fn.call(b.context,d),!0;case 3:return b.fn.call(b.context,d,h),!0;case 4:return b.fn.call(b.context,d,h,p),!0;case 5:return b.fn.call(b.context,d,h,p,y),!0;case 6:return b.fn.call(b.context,d,h,p,y,g),!0}for(T=1,O=new Array(S-1);T<S;T++)O[T-1]=arguments[T];b.fn.apply(b.context,O)}else{var z=b.length,B;for(T=0;T<z;T++)switch(b[T].once&&this.removeListener(u,b[T].fn,void 0,!0),S){case 1:b[T].fn.call(b[T].context);break;case 2:b[T].fn.call(b[T].context,d);break;case 3:b[T].fn.call(b[T].context,d,h);break;case 4:b[T].fn.call(b[T].context,d,h,p);break;default:if(!O)for(B=1,O=new Array(S-1);B<S;B++)O[B-1]=arguments[B];b[T].fn.apply(b[T].context,O)}}return!0},o.prototype.on=function(u,d,h){return a(this,u,d,h,!1)},o.prototype.once=function(u,d,h){return a(this,u,d,h,!0)},o.prototype.removeListener=function(u,d,h,p){var y=r?r+u:u;if(!this._events[y])return this;if(!d)return s(this,y),this;var g=this._events[y];if(g.fn)g.fn===d&&(!p||g.once)&&(!h||g.context===h)&&s(this,y);else{for(var w=0,b=[],S=g.length;w<S;w++)(g[w].fn!==d||p&&!g[w].once||h&&g[w].context!==h)&&b.push(g[w]);b.length?this._events[y]=b.length===1?b[0]:b:s(this,y)}return this},o.prototype.removeAllListeners=function(u){var d;return u?(d=r?r+u:u,this._events[d]&&s(this,d)):(this._events=new n,this._eventsCount=0),this},o.prototype.off=o.prototype.removeListener,o.prototype.addListener=o.prototype.on,o.prefixed=r,o.EventEmitter=o,e.exports=o})(Qu)),Qu.exports}var Pa={exports:{}},Yu,um;function pA(){return um||(um=1,Yu=(e,t)=>(t=t||(()=>{}),e.then(r=>new Promise(n=>{n(t())}).then(()=>r),r=>new Promise(n=>{n(t())}).then(()=>{throw r})))),Yu}var lm;function mA(){if(lm)return Pa.exports;lm=1;const e=pA();class t extends Error{constructor(i){super(i),this.name="TimeoutError"}}const r=(n,i,a)=>new Promise((s,o)=>{if(typeof i!="number"||i<0)throw new TypeError("Expected `milliseconds` to be a positive number");if(i===1/0){s(n);return}const c=setTimeout(()=>{if(typeof a=="function"){try{s(a())}catch(h){o(h)}return}const u=typeof a=="string"?a:`Promise timed out after ${i} milliseconds`,d=a instanceof Error?a:new t(u);typeof n.cancel=="function"&&n.cancel(),o(d)},i);e(n.then(s,o),()=>{clearTimeout(c)})});return Pa.exports=r,Pa.exports.default=r,Pa.exports.TimeoutError=t,Pa.exports}var wo={},bo={},dm;function gA(){if(dm)return bo;dm=1,Object.defineProperty(bo,"__esModule",{value:!0});function e(t,r,n){let i=0,a=t.length;for(;a>0;){const s=a/2|0;let o=i+s;n(t[o],r)<=0?(i=++o,a-=s+1):a=s}return i}return bo.default=e,bo}var fm;function yA(){if(fm)return wo;fm=1,Object.defineProperty(wo,"__esModule",{value:!0});const e=gA();class t{constructor(){this._queue=[]}enqueue(n,i){i=Object.assign({priority:0},i);const a={priority:i.priority,run:n};if(this.size&&this._queue[this.size-1].priority>=i.priority){this._queue.push(a);return}const s=e.default(this._queue,a,(o,c)=>c.priority-o.priority);this._queue.splice(s,0,a)}dequeue(){const n=this._queue.shift();return n?.run}filter(n){return this._queue.filter(i=>i.priority===n.priority).map(i=>i.run)}get size(){return this._queue.length}}return wo.default=t,wo}var hm;function vA(){if(hm)return _o;hm=1,Object.defineProperty(_o,"__esModule",{value:!0});const e=hA(),t=mA(),r=yA(),n=()=>{},i=new t.TimeoutError;class a extends e{constructor(o){var c,u,d,h;if(super(),this._intervalCount=0,this._intervalEnd=0,this._pendingCount=0,this._resolveEmpty=n,this._resolveIdle=n,o=Object.assign({carryoverConcurrencyCount:!1,intervalCap:1/0,interval:0,concurrency:1/0,autoStart:!0,queueClass:r.default},o),!(typeof o.intervalCap=="number"&&o.intervalCap>=1))throw new TypeError(`Expected \`intervalCap\` to be a number from 1 and up, got \`${(u=(c=o.intervalCap)===null||c===void 0?void 0:c.toString())!==null&&u!==void 0?u:""}\` (${typeof o.intervalCap})`);if(o.interval===void 0||!(Number.isFinite(o.interval)&&o.interval>=0))throw new TypeError(`Expected \`interval\` to be a finite number >= 0, got \`${(h=(d=o.interval)===null||d===void 0?void 0:d.toString())!==null&&h!==void 0?h:""}\` (${typeof o.interval})`);this._carryoverConcurrencyCount=o.carryoverConcurrencyCount,this._isIntervalIgnored=o.intervalCap===1/0||o.interval===0,this._intervalCap=o.intervalCap,this._interval=o.interval,this._queue=new o.queueClass,this._queueClass=o.queueClass,this.concurrency=o.concurrency,this._timeout=o.timeout,this._throwOnTimeout=o.throwOnTimeout===!0,this._isPaused=o.autoStart===!1}get _doesIntervalAllowAnother(){return this._isIntervalIgnored||this._intervalCount<this._intervalCap}get _doesConcurrentAllowAnother(){return this._pendingCount<this._concurrency}_next(){this._pendingCount--,this._tryToStartAnother(),this.emit("next")}_resolvePromises(){this._resolveEmpty(),this._resolveEmpty=n,this._pendingCount===0&&(this._resolveIdle(),this._resolveIdle=n,this.emit("idle"))}_onResumeInterval(){this._onInterval(),this._initializeIntervalIfNeeded(),this._timeoutId=void 0}_isIntervalPaused(){const o=Date.now();if(this._intervalId===void 0){const c=this._intervalEnd-o;if(c<0)this._intervalCount=this._carryoverConcurrencyCount?this._pendingCount:0;else return this._timeoutId===void 0&&(this._timeoutId=setTimeout(()=>{this._onResumeInterval()},c)),!0}return!1}_tryToStartAnother(){if(this._queue.size===0)return this._intervalId&&clearInterval(this._intervalId),this._intervalId=void 0,this._resolvePromises(),!1;if(!this._isPaused){const o=!this._isIntervalPaused();if(this._doesIntervalAllowAnother&&this._doesConcurrentAllowAnother){const c=this._queue.dequeue();return c?(this.emit("active"),c(),o&&this._initializeIntervalIfNeeded(),!0):!1}}return!1}_initializeIntervalIfNeeded(){this._isIntervalIgnored||this._intervalId!==void 0||(this._intervalId=setInterval(()=>{this._onInterval()},this._interval),this._intervalEnd=Date.now()+this._interval)}_onInterval(){this._intervalCount===0&&this._pendingCount===0&&this._intervalId&&(clearInterval(this._intervalId),this._intervalId=void 0),this._intervalCount=this._carryoverConcurrencyCount?this._pendingCount:0,this._processQueue()}_processQueue(){for(;this._tryToStartAnother(););}get concurrency(){return this._concurrency}set concurrency(o){if(!(typeof o=="number"&&o>=1))throw new TypeError(`Expected \`concurrency\` to be a number from 1 and up, got \`${o}\` (${typeof o})`);this._concurrency=o,this._processQueue()}async add(o,c={}){return new Promise((u,d)=>{const h=async()=>{this._pendingCount++,this._intervalCount++;try{const p=this._timeout===void 0&&c.timeout===void 0?o():t.default(Promise.resolve(o()),c.timeout===void 0?this._timeout:c.timeout,()=>{(c.throwOnTimeout===void 0?this._throwOnTimeout:c.throwOnTimeout)&&d(i)});u(await p)}catch(p){d(p)}this._next()};this._queue.enqueue(h,c),this._tryToStartAnother(),this.emit("add")})}async addAll(o,c){return Promise.all(o.map(async u=>this.add(u,c)))}start(){return this._isPaused?(this._isPaused=!1,this._processQueue(),this):this}pause(){this._isPaused=!0}clear(){this._queue=new this._queueClass}async onEmpty(){if(this._queue.size!==0)return new Promise(o=>{const c=this._resolveEmpty;this._resolveEmpty=()=>{c(),o()}})}async onIdle(){if(!(this._pendingCount===0&&this._queue.size===0))return new Promise(o=>{const c=this._resolveIdle;this._resolveIdle=()=>{c(),o()}})}get size(){return this._queue.size}sizeBy(o){return this._queue.filter(o).length}get pending(){return this._pendingCount}get isPaused(){return this._isPaused}get timeout(){return this._timeout}set timeout(o){this._timeout=o}}return _o.default=a,_o}var _A=vA();const nn=fa(_A),wA=[408,425,429,500,502,503,504];let pm=class{constructor(t){Object.defineProperty(this,"maxConcurrency",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"maxRetries",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"maxQueueSizeBytes",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"queue",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"onFailedResponseHook",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"queueSizeBytes",{enumerable:!0,configurable:!0,writable:!0,value:0}),this.maxConcurrency=t.maxConcurrency??1/0,this.maxRetries=t.maxRetries??6,this.maxQueueSizeBytes=t.maxQueueSizeBytes,"default"in nn?this.queue=new nn.default({concurrency:this.maxConcurrency}):this.queue=new nn({concurrency:this.maxConcurrency}),this.onFailedResponseHook=t?.onFailedResponseHook}call(t,...r){return this.callWithOptions({},t,...r)}callWithOptions(t,r,...n){const i=t.sizeBytes??0;if(this.maxQueueSizeBytes!==void 0&&i>0&&this.queueSizeBytes+i>this.maxQueueSizeBytes)return Promise.reject(new Error(`Queue size limit (${this.maxQueueSizeBytes} bytes) exceeded. Current queue size: ${this.queueSizeBytes} bytes, attempted addition: ${i} bytes.`));i>0&&(this.queueSizeBytes+=i);const a=this.onFailedResponseHook;let s=this.queue.add(()=>fA(()=>r(...n).catch(o=>{throw o instanceof Error?o:new Error(o)}),{async onFailedAttempt(o){if(o.message.startsWith("Cancel")||o.message.startsWith("TimeoutError")||o.name==="TimeoutError"||o.message.startsWith("AbortError")||o?.code==="ECONNABORTED")throw o;const c=o?.response;if(a&&await a(c))return;const u=c?.status??o?.status;if(u&&!wA.includes(+u))throw o},retries:this.maxRetries,randomize:!0}),{throwOnTimeout:!0});return i>0&&(s=s.finally(()=>{this.queueSizeBytes-=i})),t.signal?Promise.race([s,new Promise((o,c)=>{t.signal?.addEventListener("abort",()=>{c(new Error("AbortError"))})})]):s}};function mm(e){return typeof e?._getType=="function"}function gm(e){const t={type:e._getType(),data:{content:e.content}};return e?.additional_kwargs&&Object.keys(e.additional_kwargs).length>0&&(t.data.additional_kwargs={...e.additional_kwargs}),t}var Eo={exports:{}},Xu,ym;function Pc(){if(ym)return Xu;ym=1;const e="2.0.0",t=256,r=Number.MAX_SAFE_INTEGER||9007199254740991,n=16,i=t-6;return Xu={MAX_LENGTH:t,MAX_SAFE_COMPONENT_LENGTH:n,MAX_SAFE_BUILD_LENGTH:i,MAX_SAFE_INTEGER:r,RELEASE_TYPES:["major","premajor","minor","preminor","patch","prepatch","prerelease"],SEMVER_SPEC_VERSION:e,FLAG_INCLUDE_PRERELEASE:1,FLAG_LOOSE:2},Xu}var el,vm;function Nc(){if(vm)return el;vm=1;var e={};return el=typeof process=="object"&&e&&e.NODE_DEBUG&&/\bsemver\b/i.test(e.NODE_DEBUG)?(...r)=>console.error("SEMVER",...r):()=>{},el}var _m;function Ls(){return _m||(_m=1,(function(e,t){const{MAX_SAFE_COMPONENT_LENGTH:r,MAX_SAFE_BUILD_LENGTH:n,MAX_LENGTH:i}=Pc(),a=Nc();t=e.exports={};const s=t.re=[],o=t.safeRe=[],c=t.src=[],u=t.safeSrc=[],d=t.t={};let h=0;const p="[a-zA-Z0-9-]",y=[["\\s",1],["\\d",i],[p,n]],g=b=>{for(const[S,O]of y)b=b.split(`${S}*`).join(`${S}{0,${O}}`).split(`${S}+`).join(`${S}{1,${O}}`);return b},w=(b,S,O)=>{const T=g(S),z=h++;a(b,z,S),d[b]=z,c[z]=S,u[z]=T,s[z]=new RegExp(S,O?"g":void 0),o[z]=new RegExp(T,O?"g":void 0)};w("NUMERICIDENTIFIER","0|[1-9]\\d*"),w("NUMERICIDENTIFIERLOOSE","\\d+"),w("NONNUMERICIDENTIFIER",`\\d*[a-zA-Z-]${p}*`),w("MAINVERSION",`(${c[d.NUMERICIDENTIFIER]})\\.(${c[d.NUMERICIDENTIFIER]})\\.(${c[d.NUMERICIDENTIFIER]})`),w("MAINVERSIONLOOSE",`(${c[d.NUMERICIDENTIFIERLOOSE]})\\.(${c[d.NUMERICIDENTIFIERLOOSE]})\\.(${c[d.NUMERICIDENTIFIERLOOSE]})`),w("PRERELEASEIDENTIFIER",`(?:${c[d.NONNUMERICIDENTIFIER]}|${c[d.NUMERICIDENTIFIER]})`),w("PRERELEASEIDENTIFIERLOOSE",`(?:${c[d.NONNUMERICIDENTIFIER]}|${c[d.NUMERICIDENTIFIERLOOSE]})`),w("PRERELEASE",`(?:-(${c[d.PRERELEASEIDENTIFIER]}(?:\\.${c[d.PRERELEASEIDENTIFIER]})*))`),w("PRERELEASELOOSE",`(?:-?(${c[d.PRERELEASEIDENTIFIERLOOSE]}(?:\\.${c[d.PRERELEASEIDENTIFIERLOOSE]})*))`),w("BUILDIDENTIFIER",`${p}+`),w("BUILD",`(?:\\+(${c[d.BUILDIDENTIFIER]}(?:\\.${c[d.BUILDIDENTIFIER]})*))`),w("FULLPLAIN",`v?${c[d.MAINVERSION]}${c[d.PRERELEASE]}?${c[d.BUILD]}?`),w("FULL",`^${c[d.FULLPLAIN]}$`),w("LOOSEPLAIN",`[v=\\s]*${c[d.MAINVERSIONLOOSE]}${c[d.PRERELEASELOOSE]}?${c[d.BUILD]}?`),w("LOOSE",`^${c[d.LOOSEPLAIN]}$`),w("GTLT","((?:<|>)?=?)"),w("XRANGEIDENTIFIERLOOSE",`${c[d.NUMERICIDENTIFIERLOOSE]}|x|X|\\*`),w("XRANGEIDENTIFIER",`${c[d.NUMERICIDENTIFIER]}|x|X|\\*`),w("XRANGEPLAIN",`[v=\\s]*(${c[d.XRANGEIDENTIFIER]})(?:\\.(${c[d.XRANGEIDENTIFIER]})(?:\\.(${c[d.XRANGEIDENTIFIER]})(?:${c[d.PRERELEASE]})?${c[d.BUILD]}?)?)?`),w("XRANGEPLAINLOOSE",`[v=\\s]*(${c[d.XRANGEIDENTIFIERLOOSE]})(?:\\.(${c[d.XRANGEIDENTIFIERLOOSE]})(?:\\.(${c[d.XRANGEIDENTIFIERLOOSE]})(?:${c[d.PRERELEASELOOSE]})?${c[d.BUILD]}?)?)?`),w("XRANGE",`^${c[d.GTLT]}\\s*${c[d.XRANGEPLAIN]}$`),w("XRANGELOOSE",`^${c[d.GTLT]}\\s*${c[d.XRANGEPLAINLOOSE]}$`),w("COERCEPLAIN",`(^|[^\\d])(\\d{1,${r}})(?:\\.(\\d{1,${r}}))?(?:\\.(\\d{1,${r}}))?`),w("COERCE",`${c[d.COERCEPLAIN]}(?:$|[^\\d])`),w("COERCEFULL",c[d.COERCEPLAIN]+`(?:${c[d.PRERELEASE]})?(?:${c[d.BUILD]})?(?:$|[^\\d])`),w("COERCERTL",c[d.COERCE],!0),w("COERCERTLFULL",c[d.COERCEFULL],!0),w("LONETILDE","(?:~>?)"),w("TILDETRIM",`(\\s*)${c[d.LONETILDE]}\\s+`,!0),t.tildeTrimReplace="$1~",w("TILDE",`^${c[d.LONETILDE]}${c[d.XRANGEPLAIN]}$`),w("TILDELOOSE",`^${c[d.LONETILDE]}${c[d.XRANGEPLAINLOOSE]}$`),w("LONECARET","(?:\\^)"),w("CARETTRIM",`(\\s*)${c[d.LONECARET]}\\s+`,!0),t.caretTrimReplace="$1^",w("CARET",`^${c[d.LONECARET]}${c[d.XRANGEPLAIN]}$`),w("CARETLOOSE",`^${c[d.LONECARET]}${c[d.XRANGEPLAINLOOSE]}$`),w("COMPARATORLOOSE",`^${c[d.GTLT]}\\s*(${c[d.LOOSEPLAIN]})$|^$`),w("COMPARATOR",`^${c[d.GTLT]}\\s*(${c[d.FULLPLAIN]})$|^$`),w("COMPARATORTRIM",`(\\s*)${c[d.GTLT]}\\s*(${c[d.LOOSEPLAIN]}|${c[d.XRANGEPLAIN]})`,!0),t.comparatorTrimReplace="$1$2$3",w("HYPHENRANGE",`^\\s*(${c[d.XRANGEPLAIN]})\\s+-\\s+(${c[d.XRANGEPLAIN]})\\s*$`),w("HYPHENRANGELOOSE",`^\\s*(${c[d.XRANGEPLAINLOOSE]})\\s+-\\s+(${c[d.XRANGEPLAINLOOSE]})\\s*$`),w("STAR","(<|>)?=?\\s*\\*"),w("GTE0","^\\s*>=\\s*0\\.0\\.0\\s*$"),w("GTE0PRE","^\\s*>=\\s*0\\.0\\.0-0\\s*$")})(Eo,Eo.exports)),Eo.exports}var tl,wm;function Df(){if(wm)return tl;wm=1;const e=Object.freeze({loose:!0}),t=Object.freeze({});return tl=n=>n?typeof n!="object"?e:n:t,tl}var rl,bm;function H_(){if(bm)return rl;bm=1;const e=/^[0-9]+$/,t=(n,i)=>{if(typeof n=="number"&&typeof i=="number")return n===i?0:n<i?-1:1;const a=e.test(n),s=e.test(i);return a&&s&&(n=+n,i=+i),n===i?0:a&&!s?-1:s&&!a?1:n<i?-1:1};return rl={compareIdentifiers:t,rcompareIdentifiers:(n,i)=>t(i,n)},rl}var nl,Em;function Ut(){if(Em)return nl;Em=1;const e=Nc(),{MAX_LENGTH:t,MAX_SAFE_INTEGER:r}=Pc(),{safeRe:n,t:i}=Ls(),a=Df(),{compareIdentifiers:s}=H_();class o{constructor(u,d){if(d=a(d),u instanceof o){if(u.loose===!!d.loose&&u.includePrerelease===!!d.includePrerelease)return u;u=u.version}else if(typeof u!="string")throw new TypeError(`Invalid version. Must be a string. Got type "${typeof u}".`);if(u.length>t)throw new TypeError(`version is longer than ${t} characters`);e("SemVer",u,d),this.options=d,this.loose=!!d.loose,this.includePrerelease=!!d.includePrerelease;const h=u.trim().match(d.loose?n[i.LOOSE]:n[i.FULL]);if(!h)throw new TypeError(`Invalid Version: ${u}`);if(this.raw=u,this.major=+h[1],this.minor=+h[2],this.patch=+h[3],this.major>r||this.major<0)throw new TypeError("Invalid major version");if(this.minor>r||this.minor<0)throw new TypeError("Invalid minor version");if(this.patch>r||this.patch<0)throw new TypeError("Invalid patch version");h[4]?this.prerelease=h[4].split(".").map(p=>{if(/^[0-9]+$/.test(p)){const y=+p;if(y>=0&&y<r)return y}return p}):this.prerelease=[],this.build=h[5]?h[5].split("."):[],this.format()}format(){return this.version=`${this.major}.${this.minor}.${this.patch}`,this.prerelease.length&&(this.version+=`-${this.prerelease.join(".")}`),this.version}toString(){return this.version}compare(u){if(e("SemVer.compare",this.version,this.options,u),!(u instanceof o)){if(typeof u=="string"&&u===this.version)return 0;u=new o(u,this.options)}return u.version===this.version?0:this.compareMain(u)||this.comparePre(u)}compareMain(u){return u instanceof o||(u=new o(u,this.options)),this.major<u.major?-1:this.major>u.major?1:this.minor<u.minor?-1:this.minor>u.minor?1:this.patch<u.patch?-1:this.patch>u.patch?1:0}comparePre(u){if(u instanceof o||(u=new o(u,this.options)),this.prerelease.length&&!u.prerelease.length)return-1;if(!this.prerelease.length&&u.prerelease.length)return 1;if(!this.prerelease.length&&!u.prerelease.length)return 0;let d=0;do{const h=this.prerelease[d],p=u.prerelease[d];if(e("prerelease compare",d,h,p),h===void 0&&p===void 0)return 0;if(p===void 0)return 1;if(h===void 0)return-1;if(h===p)continue;return s(h,p)}while(++d)}compareBuild(u){u instanceof o||(u=new o(u,this.options));let d=0;do{const h=this.build[d],p=u.build[d];if(e("build compare",d,h,p),h===void 0&&p===void 0)return 0;if(p===void 0)return 1;if(h===void 0)return-1;if(h===p)continue;return s(h,p)}while(++d)}inc(u,d,h){if(u.startsWith("pre")){if(!d&&h===!1)throw new Error("invalid increment argument: identifier is empty");if(d){const p=`-${d}`.match(this.options.loose?n[i.PRERELEASELOOSE]:n[i.PRERELEASE]);if(!p||p[1]!==d)throw new Error(`invalid identifier: ${d}`)}}switch(u){case"premajor":this.prerelease.length=0,this.patch=0,this.minor=0,this.major++,this.inc("pre",d,h);break;case"preminor":this.prerelease.length=0,this.patch=0,this.minor++,this.inc("pre",d,h);break;case"prepatch":this.prerelease.length=0,this.inc("patch",d,h),this.inc("pre",d,h);break;case"prerelease":this.prerelease.length===0&&this.inc("patch",d,h),this.inc("pre",d,h);break;case"release":if(this.prerelease.length===0)throw new Error(`version ${this.raw} is not a prerelease`);this.prerelease.length=0;break;case"major":(this.minor!==0||this.patch!==0||this.prerelease.length===0)&&this.major++,this.minor=0,this.patch=0,this.prerelease=[];break;case"minor":(this.patch!==0||this.prerelease.length===0)&&this.minor++,this.patch=0,this.prerelease=[];break;case"patch":this.prerelease.length===0&&this.patch++,this.prerelease=[];break;case"pre":{const p=Number(h)?1:0;if(this.prerelease.length===0)this.prerelease=[p];else{let y=this.prerelease.length;for(;--y>=0;)typeof this.prerelease[y]=="number"&&(this.prerelease[y]++,y=-2);if(y===-1){if(d===this.prerelease.join(".")&&h===!1)throw new Error("invalid increment argument: identifier already exists");this.prerelease.push(p)}}if(d){let y=[d,p];h===!1&&(y=[d]),s(this.prerelease[0],d)===0?isNaN(this.prerelease[1])&&(this.prerelease=y):this.prerelease=y}break}default:throw new Error(`invalid increment argument: ${u}`)}return this.raw=this.format(),this.build.length&&(this.raw+=`+${this.build.join(".")}`),this}}return nl=o,nl}var il,xm;function va(){if(xm)return il;xm=1;const e=Ut();return il=(r,n,i=!1)=>{if(r instanceof e)return r;try{return new e(r,n)}catch(a){if(!i)return null;throw a}},il}var al,Sm;function bA(){if(Sm)return al;Sm=1;const e=va();return al=(r,n)=>{const i=e(r,n);return i?i.version:null},al}var sl,km;function EA(){if(km)return sl;km=1;const e=va();return sl=(r,n)=>{const i=e(r.trim().replace(/^[=v]+/,""),n);return i?i.version:null},sl}var ol,Im;function xA(){if(Im)return ol;Im=1;const e=Ut();return ol=(r,n,i,a,s)=>{typeof i=="string"&&(s=a,a=i,i=void 0);try{return new e(r instanceof e?r.version:r,i).inc(n,a,s).version}catch{return null}},ol}var cl,Om;function SA(){if(Om)return cl;Om=1;const e=va();return cl=(r,n)=>{const i=e(r,null,!0),a=e(n,null,!0),s=i.compare(a);if(s===0)return null;const o=s>0,c=o?i:a,u=o?a:i,d=!!c.prerelease.length;if(!!u.prerelease.length&&!d){if(!u.patch&&!u.minor)return"major";if(u.compareMain(c)===0)return u.minor&&!u.patch?"minor":"patch"}const p=d?"pre":"";return i.major!==a.major?p+"major":i.minor!==a.minor?p+"minor":i.patch!==a.patch?p+"patch":"prerelease"},cl}var ul,Tm;function kA(){if(Tm)return ul;Tm=1;const e=Ut();return ul=(r,n)=>new e(r,n).major,ul}var ll,Rm;function IA(){if(Rm)return ll;Rm=1;const e=Ut();return ll=(r,n)=>new e(r,n).minor,ll}var dl,Am;function OA(){if(Am)return dl;Am=1;const e=Ut();return dl=(r,n)=>new e(r,n).patch,dl}var fl,$m;function TA(){if($m)return fl;$m=1;const e=va();return fl=(r,n)=>{const i=e(r,n);return i&&i.prerelease.length?i.prerelease:null},fl}var hl,Cm;function Cr(){if(Cm)return hl;Cm=1;const e=Ut();return hl=(r,n,i)=>new e(r,i).compare(new e(n,i)),hl}var pl,Pm;function RA(){if(Pm)return pl;Pm=1;const e=Cr();return pl=(r,n,i)=>e(n,r,i),pl}var ml,Nm;function AA(){if(Nm)return ml;Nm=1;const e=Cr();return ml=(r,n)=>e(r,n,!0),ml}var gl,Dm;function Mf(){if(Dm)return gl;Dm=1;const e=Ut();return gl=(r,n,i)=>{const a=new e(r,i),s=new e(n,i);return a.compare(s)||a.compareBuild(s)},gl}var yl,Mm;function $A(){if(Mm)return yl;Mm=1;const e=Mf();return yl=(r,n)=>r.sort((i,a)=>e(i,a,n)),yl}var vl,Lm;function CA(){if(Lm)return vl;Lm=1;const e=Mf();return vl=(r,n)=>r.sort((i,a)=>e(a,i,n)),vl}var _l,jm;function Dc(){if(jm)return _l;jm=1;const e=Cr();return _l=(r,n,i)=>e(r,n,i)>0,_l}var wl,Fm;function Lf(){if(Fm)return wl;Fm=1;const e=Cr();return wl=(r,n,i)=>e(r,n,i)<0,wl}var bl,Bm;function K_(){if(Bm)return bl;Bm=1;const e=Cr();return bl=(r,n,i)=>e(r,n,i)===0,bl}var El,zm;function G_(){if(zm)return El;zm=1;const e=Cr();return El=(r,n,i)=>e(r,n,i)!==0,El}var xl,Um;function jf(){if(Um)return xl;Um=1;const e=Cr();return xl=(r,n,i)=>e(r,n,i)>=0,xl}var Sl,qm;function Ff(){if(qm)return Sl;qm=1;const e=Cr();return Sl=(r,n,i)=>e(r,n,i)<=0,Sl}var kl,Hm;function W_(){if(Hm)return kl;Hm=1;const e=K_(),t=G_(),r=Dc(),n=jf(),i=Lf(),a=Ff();return kl=(o,c,u,d)=>{switch(c){case"===":return typeof o=="object"&&(o=o.version),typeof u=="object"&&(u=u.version),o===u;case"!==":return typeof o=="object"&&(o=o.version),typeof u=="object"&&(u=u.version),o!==u;case"":case"=":case"==":return e(o,u,d);case"!=":return t(o,u,d);case">":return r(o,u,d);case">=":return n(o,u,d);case"<":return i(o,u,d);case"<=":return a(o,u,d);default:throw new TypeError(`Invalid operator: ${c}`)}},kl}var Il,Km;function PA(){if(Km)return Il;Km=1;const e=Ut(),t=va(),{safeRe:r,t:n}=Ls();return Il=(a,s)=>{if(a instanceof e)return a;if(typeof a=="number"&&(a=String(a)),typeof a!="string")return null;s=s||{};let o=null;if(!s.rtl)o=a.match(s.includePrerelease?r[n.COERCEFULL]:r[n.COERCE]);else{const y=s.includePrerelease?r[n.COERCERTLFULL]:r[n.COERCERTL];let g;for(;(g=y.exec(a))&&(!o||o.index+o[0].length!==a.length);)(!o||g.index+g[0].length!==o.index+o[0].length)&&(o=g),y.lastIndex=g.index+g[1].length+g[2].length;y.lastIndex=-1}if(o===null)return null;const c=o[2],u=o[3]||"0",d=o[4]||"0",h=s.includePrerelease&&o[5]?`-${o[5]}`:"",p=s.includePrerelease&&o[6]?`+${o[6]}`:"";return t(`${c}.${u}.${d}${h}${p}`,s)},Il}var Ol,Gm;function NA(){if(Gm)return Ol;Gm=1;class e{constructor(){this.max=1e3,this.map=new Map}get(r){const n=this.map.get(r);if(n!==void 0)return this.map.delete(r),this.map.set(r,n),n}delete(r){return this.map.delete(r)}set(r,n){if(!this.delete(r)&&n!==void 0){if(this.map.size>=this.max){const a=this.map.keys().next().value;this.delete(a)}this.map.set(r,n)}return this}}return Ol=e,Ol}var Tl,Wm;function Pr(){if(Wm)return Tl;Wm=1;const e=/\s+/g;class t{constructor(H,fe){if(fe=i(fe),H instanceof t)return H.loose===!!fe.loose&&H.includePrerelease===!!fe.includePrerelease?H:new t(H.raw,fe);if(H instanceof a)return this.raw=H.value,this.set=[[H]],this.formatted=void 0,this;if(this.options=fe,this.loose=!!fe.loose,this.includePrerelease=!!fe.includePrerelease,this.raw=H.trim().replace(e," "),this.set=this.raw.split("||").map(Q=>this.parseRange(Q.trim())).filter(Q=>Q.length),!this.set.length)throw new TypeError(`Invalid SemVer Range: ${this.raw}`);if(this.set.length>1){const Q=this.set[0];if(this.set=this.set.filter(te=>!w(te[0])),this.set.length===0)this.set=[Q];else if(this.set.length>1){for(const te of this.set)if(te.length===1&&b(te[0])){this.set=[te];break}}}this.formatted=void 0}get range(){if(this.formatted===void 0){this.formatted="";for(let H=0;H<this.set.length;H++){H>0&&(this.formatted+="||");const fe=this.set[H];for(let Q=0;Q<fe.length;Q++)Q>0&&(this.formatted+=" "),this.formatted+=fe[Q].toString().trim()}}return this.formatted}format(){return this.range}toString(){return this.range}parseRange(H){const Q=((this.options.includePrerelease&&y)|(this.options.loose&&g))+":"+H,te=n.get(Q);if(te)return te;const Y=this.options.loose,re=Y?c[u.HYPHENRANGELOOSE]:c[u.HYPHENRANGE];H=H.replace(re,$e(this.options.includePrerelease)),s("hyphen replace",H),H=H.replace(c[u.COMPARATORTRIM],d),s("comparator trim",H),H=H.replace(c[u.TILDETRIM],h),s("tilde trim",H),H=H.replace(c[u.CARETTRIM],p),s("caret trim",H);let xe=H.split(" ").map(je=>O(je,this.options)).join(" ").split(/\s+/).map(je=>qe(je,this.options));Y&&(xe=xe.filter(je=>(s("loose invalid filter",je,this.options),!!je.match(c[u.COMPARATORLOOSE])))),s("range list",xe);const Re=new Map,Te=xe.map(je=>new a(je,this.options));for(const je of Te){if(w(je))return[je];Re.set(je.value,je)}Re.size>1&&Re.has("")&&Re.delete("");const Ge=[...Re.values()];return n.set(Q,Ge),Ge}intersects(H,fe){if(!(H instanceof t))throw new TypeError("a Range is required");return this.set.some(Q=>S(Q,fe)&&H.set.some(te=>S(te,fe)&&Q.every(Y=>te.every(re=>Y.intersects(re,fe)))))}test(H){if(!H)return!1;if(typeof H=="string")try{H=new o(H,this.options)}catch{return!1}for(let fe=0;fe<this.set.length;fe++)if(Ve(this.set[fe],H,this.options))return!0;return!1}}Tl=t;const r=NA(),n=new r,i=Df(),a=Mc(),s=Nc(),o=Ut(),{safeRe:c,t:u,comparatorTrimReplace:d,tildeTrimReplace:h,caretTrimReplace:p}=Ls(),{FLAG_INCLUDE_PRERELEASE:y,FLAG_LOOSE:g}=Pc(),w=Z=>Z.value==="<0.0.0-0",b=Z=>Z.value==="",S=(Z,H)=>{let fe=!0;const Q=Z.slice();let te=Q.pop();for(;fe&&Q.length;)fe=Q.every(Y=>te.intersects(Y,H)),te=Q.pop();return fe},O=(Z,H)=>(Z=Z.replace(c[u.BUILD],""),s("comp",Z,H),Z=G(Z,H),s("caret",Z),Z=z(Z,H),s("tildes",Z),Z=K(Z,H),s("xrange",Z),Z=Le(Z,H),s("stars",Z),Z),T=Z=>!Z||Z.toLowerCase()==="x"||Z==="*",z=(Z,H)=>Z.trim().split(/\s+/).map(fe=>B(fe,H)).join(" "),B=(Z,H)=>{const fe=H.loose?c[u.TILDELOOSE]:c[u.TILDE];return Z.replace(fe,(Q,te,Y,re,xe)=>{s("tilde",Z,Q,te,Y,re,xe);let Re;return T(te)?Re="":T(Y)?Re=`>=${te}.0.0 <${+te+1}.0.0-0`:T(re)?Re=`>=${te}.${Y}.0 <${te}.${+Y+1}.0-0`:xe?(s("replaceTilde pr",xe),Re=`>=${te}.${Y}.${re}-${xe} <${te}.${+Y+1}.0-0`):Re=`>=${te}.${Y}.${re} <${te}.${+Y+1}.0-0`,s("tilde return",Re),Re})},G=(Z,H)=>Z.trim().split(/\s+/).map(fe=>q(fe,H)).join(" "),q=(Z,H)=>{s("caret",Z,H);const fe=H.loose?c[u.CARETLOOSE]:c[u.CARET],Q=H.includePrerelease?"-0":"";return Z.replace(fe,(te,Y,re,xe,Re)=>{s("caret",Z,te,Y,re,xe,Re);let Te;return T(Y)?Te="":T(re)?Te=`>=${Y}.0.0${Q} <${+Y+1}.0.0-0`:T(xe)?Y==="0"?Te=`>=${Y}.${re}.0${Q} <${Y}.${+re+1}.0-0`:Te=`>=${Y}.${re}.0${Q} <${+Y+1}.0.0-0`:Re?(s("replaceCaret pr",Re),Y==="0"?re==="0"?Te=`>=${Y}.${re}.${xe}-${Re} <${Y}.${re}.${+xe+1}-0`:Te=`>=${Y}.${re}.${xe}-${Re} <${Y}.${+re+1}.0-0`:Te=`>=${Y}.${re}.${xe}-${Re} <${+Y+1}.0.0-0`):(s("no pr"),Y==="0"?re==="0"?Te=`>=${Y}.${re}.${xe}${Q} <${Y}.${re}.${+xe+1}-0`:Te=`>=${Y}.${re}.${xe}${Q} <${Y}.${+re+1}.0-0`:Te=`>=${Y}.${re}.${xe} <${+Y+1}.0.0-0`),s("caret return",Te),Te})},K=(Z,H)=>(s("replaceXRanges",Z,H),Z.split(/\s+/).map(fe=>Oe(fe,H)).join(" ")),Oe=(Z,H)=>{Z=Z.trim();const fe=H.loose?c[u.XRANGELOOSE]:c[u.XRANGE];return Z.replace(fe,(Q,te,Y,re,xe,Re)=>{s("xRange",Z,Q,te,Y,re,xe,Re);const Te=T(Y),Ge=Te||T(re),je=Ge||T(xe),_t=je;return te==="="&&_t&&(te=""),Re=H.includePrerelease?"-0":"",Te?te===">"||te==="<"?Q="<0.0.0-0":Q="*":te&&_t?(Ge&&(re=0),xe=0,te===">"?(te=">=",Ge?(Y=+Y+1,re=0,xe=0):(re=+re+1,xe=0)):te==="<="&&(te="<",Ge?Y=+Y+1:re=+re+1),te==="<"&&(Re="-0"),Q=`${te+Y}.${re}.${xe}${Re}`):Ge?Q=`>=${Y}.0.0${Re} <${+Y+1}.0.0-0`:je&&(Q=`>=${Y}.${re}.0${Re} <${Y}.${+re+1}.0-0`),s("xRange return",Q),Q})},Le=(Z,H)=>(s("replaceStars",Z,H),Z.trim().replace(c[u.STAR],"")),qe=(Z,H)=>(s("replaceGTE0",Z,H),Z.trim().replace(c[H.includePrerelease?u.GTE0PRE:u.GTE0],"")),$e=Z=>(H,fe,Q,te,Y,re,xe,Re,Te,Ge,je,_t)=>(T(Q)?fe="":T(te)?fe=`>=${Q}.0.0${Z?"-0":""}`:T(Y)?fe=`>=${Q}.${te}.0${Z?"-0":""}`:re?fe=`>=${fe}`:fe=`>=${fe}${Z?"-0":""}`,T(Te)?Re="":T(Ge)?Re=`<${+Te+1}.0.0-0`:T(je)?Re=`<${Te}.${+Ge+1}.0-0`:_t?Re=`<=${Te}.${Ge}.${je}-${_t}`:Z?Re=`<${Te}.${Ge}.${+je+1}-0`:Re=`<=${Re}`,`${fe} ${Re}`.trim()),Ve=(Z,H,fe)=>{for(let Q=0;Q<Z.length;Q++)if(!Z[Q].test(H))return!1;if(H.prerelease.length&&!fe.includePrerelease){for(let Q=0;Q<Z.length;Q++)if(s(Z[Q].semver),Z[Q].semver!==a.ANY&&Z[Q].semver.prerelease.length>0){const te=Z[Q].semver;if(te.major===H.major&&te.minor===H.minor&&te.patch===H.patch)return!0}return!1}return!0};return Tl}var Rl,Vm;function Mc(){if(Vm)return Rl;Vm=1;const e=Symbol("SemVer ANY");class t{static get ANY(){return e}constructor(d,h){if(h=r(h),d instanceof t){if(d.loose===!!h.loose)return d;d=d.value}d=d.trim().split(/\s+/).join(" "),s("comparator",d,h),this.options=h,this.loose=!!h.loose,this.parse(d),this.semver===e?this.value="":this.value=this.operator+this.semver.version,s("comp",this)}parse(d){const h=this.options.loose?n[i.COMPARATORLOOSE]:n[i.COMPARATOR],p=d.match(h);if(!p)throw new TypeError(`Invalid comparator: ${d}`);this.operator=p[1]!==void 0?p[1]:"",this.operator==="="&&(this.operator=""),p[2]?this.semver=new o(p[2],this.options.loose):this.semver=e}toString(){return this.value}test(d){if(s("Comparator.test",d,this.options.loose),this.semver===e||d===e)return!0;if(typeof d=="string")try{d=new o(d,this.options)}catch{return!1}return a(d,this.operator,this.semver,this.options)}intersects(d,h){if(!(d instanceof t))throw new TypeError("a Comparator is required");return this.operator===""?this.value===""?!0:new c(d.value,h).test(this.value):d.operator===""?d.value===""?!0:new c(this.value,h).test(d.semver):(h=r(h),h.includePrerelease&&(this.value==="<0.0.0-0"||d.value==="<0.0.0-0")||!h.includePrerelease&&(this.value.startsWith("<0.0.0")||d.value.startsWith("<0.0.0"))?!1:!!(this.operator.startsWith(">")&&d.operator.startsWith(">")||this.operator.startsWith("<")&&d.operator.startsWith("<")||this.semver.version===d.semver.version&&this.operator.includes("=")&&d.operator.includes("=")||a(this.semver,"<",d.semver,h)&&this.operator.startsWith(">")&&d.operator.startsWith("<")||a(this.semver,">",d.semver,h)&&this.operator.startsWith("<")&&d.operator.startsWith(">")))}}Rl=t;const r=Df(),{safeRe:n,t:i}=Ls(),a=W_(),s=Nc(),o=Ut(),c=Pr();return Rl}var Al,Zm;function Lc(){if(Zm)return Al;Zm=1;const e=Pr();return Al=(r,n,i)=>{try{n=new e(n,i)}catch{return!1}return n.test(r)},Al}var $l,Jm;function DA(){if(Jm)return $l;Jm=1;const e=Pr();return $l=(r,n)=>new e(r,n).set.map(i=>i.map(a=>a.value).join(" ").trim().split(" ")),$l}var Cl,Qm;function MA(){if(Qm)return Cl;Qm=1;const e=Ut(),t=Pr();return Cl=(n,i,a)=>{let s=null,o=null,c=null;try{c=new t(i,a)}catch{return null}return n.forEach(u=>{c.test(u)&&(!s||o.compare(u)===-1)&&(s=u,o=new e(s,a))}),s},Cl}var Pl,Ym;function LA(){if(Ym)return Pl;Ym=1;const e=Ut(),t=Pr();return Pl=(n,i,a)=>{let s=null,o=null,c=null;try{c=new t(i,a)}catch{return null}return n.forEach(u=>{c.test(u)&&(!s||o.compare(u)===1)&&(s=u,o=new e(s,a))}),s},Pl}var Nl,Xm;function jA(){if(Xm)return Nl;Xm=1;const e=Ut(),t=Pr(),r=Dc();return Nl=(i,a)=>{i=new t(i,a);let s=new e("0.0.0");if(i.test(s)||(s=new e("0.0.0-0"),i.test(s)))return s;s=null;for(let o=0;o<i.set.length;++o){const c=i.set[o];let u=null;c.forEach(d=>{const h=new e(d.semver.version);switch(d.operator){case">":h.prerelease.length===0?h.patch++:h.prerelease.push(0),h.raw=h.format();case"":case">=":(!u||r(h,u))&&(u=h);break;case"<":case"<=":break;default:throw new Error(`Unexpected operation: ${d.operator}`)}}),u&&(!s||r(s,u))&&(s=u)}return s&&i.test(s)?s:null},Nl}var Dl,eg;function FA(){if(eg)return Dl;eg=1;const e=Pr();return Dl=(r,n)=>{try{return new e(r,n).range||"*"}catch{return null}},Dl}var Ml,tg;function Bf(){if(tg)return Ml;tg=1;const e=Ut(),t=Mc(),{ANY:r}=t,n=Pr(),i=Lc(),a=Dc(),s=Lf(),o=Ff(),c=jf();return Ml=(d,h,p,y)=>{d=new e(d,y),h=new n(h,y);let g,w,b,S,O;switch(p){case">":g=a,w=o,b=s,S=">",O=">=";break;case"<":g=s,w=c,b=a,S="<",O="<=";break;default:throw new TypeError('Must provide a hilo val of "<" or ">"')}if(i(d,h,y))return!1;for(let T=0;T<h.set.length;++T){const z=h.set[T];let B=null,G=null;if(z.forEach(q=>{q.semver===r&&(q=new t(">=0.0.0")),B=B||q,G=G||q,g(q.semver,B.semver,y)?B=q:b(q.semver,G.semver,y)&&(G=q)}),B.operator===S||B.operator===O||(!G.operator||G.operator===S)&&w(d,G.semver))return!1;if(G.operator===O&&b(d,G.semver))return!1}return!0},Ml}var Ll,rg;function BA(){if(rg)return Ll;rg=1;const e=Bf();return Ll=(r,n,i)=>e(r,n,">",i),Ll}var jl,ng;function zA(){if(ng)return jl;ng=1;const e=Bf();return jl=(r,n,i)=>e(r,n,"<",i),jl}var Fl,ig;function UA(){if(ig)return Fl;ig=1;const e=Pr();return Fl=(r,n,i)=>(r=new e(r,i),n=new e(n,i),r.intersects(n,i)),Fl}var Bl,ag;function qA(){if(ag)return Bl;ag=1;const e=Lc(),t=Cr();return Bl=(r,n,i)=>{const a=[];let s=null,o=null;const c=r.sort((p,y)=>t(p,y,i));for(const p of c)e(p,n,i)?(o=p,s||(s=p)):(o&&a.push([s,o]),o=null,s=null);s&&a.push([s,null]);const u=[];for(const[p,y]of a)p===y?u.push(p):!y&&p===c[0]?u.push("*"):y?p===c[0]?u.push(`<=${y}`):u.push(`${p} - ${y}`):u.push(`>=${p}`);const d=u.join(" || "),h=typeof n.raw=="string"?n.raw:String(n);return d.length<h.length?d:n},Bl}var zl,sg;function HA(){if(sg)return zl;sg=1;const e=Pr(),t=Mc(),{ANY:r}=t,n=Lc(),i=Cr(),a=(h,p,y={})=>{if(h===p)return!0;h=new e(h,y),p=new e(p,y);let g=!1;e:for(const w of h.set){for(const b of p.set){const S=c(w,b,y);if(g=g||S!==null,S)continue e}if(g)return!1}return!0},s=[new t(">=0.0.0-0")],o=[new t(">=0.0.0")],c=(h,p,y)=>{if(h===p)return!0;if(h.length===1&&h[0].semver===r){if(p.length===1&&p[0].semver===r)return!0;y.includePrerelease?h=s:h=o}if(p.length===1&&p[0].semver===r){if(y.includePrerelease)return!0;p=o}const g=new Set;let w,b;for(const K of h)K.operator===">"||K.operator===">="?w=u(w,K,y):K.operator==="<"||K.operator==="<="?b=d(b,K,y):g.add(K.semver);if(g.size>1)return null;let S;if(w&&b){if(S=i(w.semver,b.semver,y),S>0)return null;if(S===0&&(w.operator!==">="||b.operator!=="<="))return null}for(const K of g){if(w&&!n(K,String(w),y)||b&&!n(K,String(b),y))return null;for(const Oe of p)if(!n(K,String(Oe),y))return!1;return!0}let O,T,z,B,G=b&&!y.includePrerelease&&b.semver.prerelease.length?b.semver:!1,q=w&&!y.includePrerelease&&w.semver.prerelease.length?w.semver:!1;G&&G.prerelease.length===1&&b.operator==="<"&&G.prerelease[0]===0&&(G=!1);for(const K of p){if(B=B||K.operator===">"||K.operator===">=",z=z||K.operator==="<"||K.operator==="<=",w){if(q&&K.semver.prerelease&&K.semver.prerelease.length&&K.semver.major===q.major&&K.semver.minor===q.minor&&K.semver.patch===q.patch&&(q=!1),K.operator===">"||K.operator===">="){if(O=u(w,K,y),O===K&&O!==w)return!1}else if(w.operator===">="&&!n(w.semver,String(K),y))return!1}if(b){if(G&&K.semver.prerelease&&K.semver.prerelease.length&&K.semver.major===G.major&&K.semver.minor===G.minor&&K.semver.patch===G.patch&&(G=!1),K.operator==="<"||K.operator==="<="){if(T=d(b,K,y),T===K&&T!==b)return!1}else if(b.operator==="<="&&!n(b.semver,String(K),y))return!1}if(!K.operator&&(b||w)&&S!==0)return!1}return!(w&&z&&!b&&S!==0||b&&B&&!w&&S!==0||q||G)},u=(h,p,y)=>{if(!h)return p;const g=i(h.semver,p.semver,y);return g>0?h:g<0||p.operator===">"&&h.operator===">="?p:h},d=(h,p,y)=>{if(!h)return p;const g=i(h.semver,p.semver,y);return g<0?h:g>0||p.operator==="<"&&h.operator==="<="?p:h};return zl=a,zl}var Ul,og;function KA(){if(og)return Ul;og=1;const e=Ls(),t=Pc(),r=Ut(),n=H_(),i=va(),a=bA(),s=EA(),o=xA(),c=SA(),u=kA(),d=IA(),h=OA(),p=TA(),y=Cr(),g=RA(),w=AA(),b=Mf(),S=$A(),O=CA(),T=Dc(),z=Lf(),B=K_(),G=G_(),q=jf(),K=Ff(),Oe=W_(),Le=PA(),qe=Mc(),$e=Pr(),Ve=Lc(),Z=DA(),H=MA(),fe=LA(),Q=jA(),te=FA(),Y=Bf(),re=BA(),xe=zA(),Re=UA(),Te=qA(),Ge=HA();return Ul={parse:i,valid:a,clean:s,inc:o,diff:c,major:u,minor:d,patch:h,prerelease:p,compare:y,rcompare:g,compareLoose:w,compareBuild:b,sort:S,rsort:O,gt:T,lt:z,eq:B,neq:G,gte:q,lte:K,cmp:Oe,coerce:Le,Comparator:qe,Range:$e,satisfies:Ve,toComparators:Z,maxSatisfying:H,minSatisfying:fe,minVersion:Q,validRange:te,outside:Y,gtr:re,ltr:xe,intersects:Re,simplifyRange:Te,subset:Ge,SemVer:r,re:e.re,src:e.src,tokens:e.t,SEMVER_SPEC_VERSION:t.SEMVER_SPEC_VERSION,RELEASE_TYPES:t.RELEASE_TYPES,compareIdentifiers:n.compareIdentifiers,rcompareIdentifiers:n.rcompareIdentifiers},Ul}KA();function kn(e){if(!e||e.split("/").length>2||e.startsWith("/")||e.endsWith("/")||e.split(":").length>2)throw new Error(`Invalid identifier format: ${e}`);const[t,r]=e.split(":"),n=r||"latest";if(t.includes("/")){const[i,a]=t.split("/",2);if(!i||!a)throw new Error(`Invalid identifier format: ${e}`);return[i,a,n]}else{if(!t)throw new Error(`Invalid identifier format: ${e}`);return["-",t,n]}}class GA extends Error{constructor(t){super(t),Object.defineProperty(this,"status",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.name="LangSmithConflictError",this.status=409}}async function _e(e,t,r){let n;if(e.ok){r&&(n=await e.text());return}if(e.status===403)try{(await e.json())?.error==="org_scoped_key_requires_workspace"&&(n="This API key is org-scoped and requires workspace specification. Please provide 'workspaceId' parameter, or set LANGSMITH_WORKSPACE_ID environment variable.")}catch{const o=new Error(`${e.status} ${e.statusText}`);throw o.status=e?.status,o}if(n===void 0)try{n=await e.text()}catch{n=""}const i=`Failed to ${t}. Received status [${e.status}]: ${e.statusText}. Message: ${n}`;if(e.status===409)throw new GA(i);const a=new Error(i);throw a.status=e.status,a}const V_="ERR_CONFLICTING_ENDPOINTS";class WA extends Error{constructor(){super("You cannot provide both LANGSMITH_ENDPOINT / LANGCHAIN_ENDPOINT and LANGSMITH_RUNS_ENDPOINTS."),Object.defineProperty(this,"code",{enumerable:!0,configurable:!0,writable:!0,value:V_}),this.name="ConflictingEndpointsError"}}function VA(e){return typeof e=="object"&&e!==null&&e.code===V_}var cg="[...]",ZA={result:"[Circular]"},ic=[],Gi=[];const JA=new TextEncoder;function QA(){return{depthLimit:Number.MAX_SAFE_INTEGER,edgesLimit:Number.MAX_SAFE_INTEGER}}function xo(e){return JA.encode(e)}function Z_(e){if(e&&typeof e=="object"&&e!==null){if(e instanceof Map)return Object.fromEntries(e);if(e instanceof Set)return Array.from(e);if(e instanceof Date)return e.toISOString();if(e instanceof RegExp)return e.toString();if(e instanceof Error)return{name:e.name,message:e.message}}else if(typeof e=="bigint")return e.toString();return e}function YA(e){return function(t,r){return Z_(r)}}function Xt(e,t,r,n,i){try{const a=JSON.stringify(e,YA(r),n);return xo(a)}catch(a){if(!a.message?.includes("Converting circular structure to JSON"))return console.warn(`[WARNING]: LangSmith received unserializable value.${t?`
Context: ${t}`:""}`),xo("[Unserializable]");Kt("SUPPRESS_CIRCULAR_JSON_WARNINGS")!=="true"&&console.warn(`[WARNING]: LangSmith received circular JSON. This will decrease tracer performance. ${t?`
Context: ${t}`:""}`),typeof i>"u"&&(i=QA()),Rd(e,"",0,[],void 0,0,i);let s;try{Gi.length===0?s=JSON.stringify(e,r,n):s=JSON.stringify(e,XA(r),n)}catch{return xo("[unable to serialize, circular reference is too complex to analyze]")}finally{for(;ic.length!==0;){const o=ic.pop();o.length===4?Object.defineProperty(o[0],o[1],o[3]):o[0][o[1]]=o[2]}}return xo(s)}}function ql(e,t,r,n){var i=Object.getOwnPropertyDescriptor(n,r);i.get!==void 0?i.configurable?(Object.defineProperty(n,r,{value:e}),ic.push([n,r,t,i])):Gi.push([t,r,e]):(n[r]=e,ic.push([n,r,t]))}function Rd(e,t,r,n,i,a,s){a+=1;var o;if(typeof e=="object"&&e!==null){for(o=0;o<n.length;o++)if(n[o]===e){ql(ZA,e,t,i);return}if(typeof s.depthLimit<"u"&&a>s.depthLimit){ql(cg,e,t,i);return}if(typeof s.edgesLimit<"u"&&r+1>s.edgesLimit){ql(cg,e,t,i);return}if(n.push(e),Array.isArray(e))for(o=0;o<e.length;o++)Rd(e[o],o,o,n,e,a,s);else{e=Z_(e);var c=Object.keys(e);for(o=0;o<c.length;o++){var u=c[o];Rd(e[u],u,o,n,e,a,s)}}n.pop()}}function XA(e){return e=typeof e<"u"?e:function(t,r){return r},function(t,r){if(Gi.length>0)for(var n=0;n<Gi.length;n++){var i=Gi[n];if(i[1]===t&&i[0]===r){r=i[2],Gi.splice(n,1);break}}return e.call(this,t,r)}}function ug(e,t){const r=B_(),n=t??z_(),i=e.extra??{},a=i.metadata;return e.extra={...i,runtime:{...r,...i?.runtime},metadata:{...n,...n.revision_id||"revision_id"in e&&e.revision_id?{revision_id:("revision_id"in e?e.revision_id:void 0)??n.revision_id}:{},...a}},e}const e$=e=>{const t=e?.toString()??Kt("TRACING_SAMPLING_RATE");if(t===void 0)return;const r=parseFloat(t);if(r<0||r>1)throw new Error(`LANGSMITH_TRACING_SAMPLING_RATE must be between 0 and 1 if set. Got: ${r}`);return r},t$=e=>{const r=e.replace("http://","").replace("https://","").split("/")[0].split(":")[0];return r==="localhost"||r==="127.0.0.1"||r==="::1"};async function r$(e){const t=[];for await(const r of e)t.push(r);return t}function So(e){if(e!==void 0)return e.trim().replace(/^"(.*)"$/,"$1").replace(/^'(.*)'$/,"$1")}const n$=async e=>{if(e?.status===429){const t=parseInt(e.headers.get("retry-after")??"10",10)*1e3;if(t>0)return await new Promise(r=>setTimeout(r,t)),!0}return!1};function lg(e){return typeof e=="number"?Number(e.toFixed(4)):e}const i$=24*1024*1024,J_=1024*1024*1024,a$=1e4,s$=100,dg="https://api.smith.langchain.com";class o${constructor(t){Object.defineProperty(this,"items",{enumerable:!0,configurable:!0,writable:!0,value:[]}),Object.defineProperty(this,"sizeBytes",{enumerable:!0,configurable:!0,writable:!0,value:0}),Object.defineProperty(this,"maxSizeBytes",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.maxSizeBytes=t??J_}peek(){return this.items[0]}push(t){let r;const n=new Promise(a=>{r=a}),i=Xt(t.item,`Serializing run with id: ${t.item.id}`).length;return this.sizeBytes+i>this.maxSizeBytes&&this.items.length>0?(console.warn(`AutoBatchQueue size limit (${this.maxSizeBytes} bytes) exceeded. Dropping run with id: ${t.item.id}. Current queue size: ${this.sizeBytes} bytes, attempted addition: ${i} bytes.`),r(),n):(this.items.push({action:t.action,payload:t.item,otelContext:t.otelContext,apiKey:t.apiKey,apiUrl:t.apiUrl,itemPromiseResolve:r,itemPromise:n,size:i}),this.sizeBytes+=i,n)}pop({upToSizeBytes:t,upToSize:r}){if(t<1)throw new Error("Number of bytes to pop off may not be less than 1.");const n=[];let i=0;for(;i+(this.peek()?.size??0)<t&&this.items.length>0&&n.length<r;){const a=this.items.shift();a&&(n.push(a),i+=a.size,this.sizeBytes-=a.size)}if(n.length===0&&this.items.length>0){const a=this.items.shift();n.push(a),i+=a.size,this.sizeBytes-=a.size}return[n.map(a=>({action:a.action,item:a.payload,otelContext:a.otelContext,apiKey:a.apiKey,apiUrl:a.apiUrl,size:a.size})),()=>n.forEach(a=>a.itemPromiseResolve())]}}class ps{get _fetch(){return this.fetchImplementation||zR(this.debug)}constructor(t={}){Object.defineProperty(this,"apiKey",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"apiUrl",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"webUrl",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"workspaceId",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"caller",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"batchIngestCaller",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"timeout_ms",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"_tenantId",{enumerable:!0,configurable:!0,writable:!0,value:null}),Object.defineProperty(this,"hideInputs",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"hideOutputs",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"tracingSampleRate",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"filteredPostUuids",{enumerable:!0,configurable:!0,writable:!0,value:new Set}),Object.defineProperty(this,"autoBatchTracing",{enumerable:!0,configurable:!0,writable:!0,value:!0}),Object.defineProperty(this,"autoBatchQueue",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"autoBatchTimeout",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"autoBatchAggregationDelayMs",{enumerable:!0,configurable:!0,writable:!0,value:250}),Object.defineProperty(this,"batchSizeBytesLimit",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"batchSizeLimit",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"fetchOptions",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"settings",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"blockOnRootRunFinalization",{enumerable:!0,configurable:!0,writable:!0,value:Kr("LANGSMITH_TRACING_BACKGROUND")==="false"}),Object.defineProperty(this,"traceBatchConcurrency",{enumerable:!0,configurable:!0,writable:!0,value:5}),Object.defineProperty(this,"_serverInfo",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"_getServerInfoPromise",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"manualFlushMode",{enumerable:!0,configurable:!0,writable:!0,value:!1}),Object.defineProperty(this,"langSmithToOTELTranslator",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"fetchImplementation",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"cachedLSEnvVarsForMetadata",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"multipartStreamingDisabled",{enumerable:!0,configurable:!0,writable:!0,value:!1}),Object.defineProperty(this,"debug",{enumerable:!0,configurable:!0,writable:!0,value:Kr("LANGSMITH_DEBUG")==="true"});const r=ps.getDefaultClientConfig();if(this.tracingSampleRate=e$(t.tracingSamplingRate),this.apiUrl=So(t.apiUrl??r.apiUrl)??"",this.apiUrl.endsWith("/")&&(this.apiUrl=this.apiUrl.slice(0,-1)),this.apiKey=So(t.apiKey??r.apiKey),this.webUrl=So(t.webUrl??r.webUrl),this.webUrl?.endsWith("/")&&(this.webUrl=this.webUrl.slice(0,-1)),this.workspaceId=So(t.workspaceId??Kt("WORKSPACE_ID")),this.timeout_ms=t.timeout_ms??9e4,this.caller=new pm({...t.callerOptions??{},maxRetries:4,debug:t.debug??this.debug}),this.traceBatchConcurrency=t.traceBatchConcurrency??this.traceBatchConcurrency,this.traceBatchConcurrency<1)throw new Error("Trace batch concurrency must be positive.");this.debug=t.debug??this.debug,this.fetchImplementation=t.fetchImplementation;const n=t.maxIngestMemoryBytes??J_;this.batchIngestCaller=new pm({maxRetries:4,maxConcurrency:this.traceBatchConcurrency,maxQueueSizeBytes:n,...t.callerOptions??{},onFailedResponseHook:n$,debug:t.debug??this.debug}),this.hideInputs=t.hideInputs??t.anonymizer??r.hideInputs,this.hideOutputs=t.hideOutputs??t.anonymizer??r.hideOutputs,this.autoBatchTracing=t.autoBatchTracing??this.autoBatchTracing,this.autoBatchQueue=new o$(n),this.blockOnRootRunFinalization=t.blockOnRootRunFinalization??this.blockOnRootRunFinalization,this.batchSizeBytesLimit=t.batchSizeBytesLimit,this.batchSizeLimit=t.batchSizeLimit,this.fetchOptions=t.fetchOptions||{},this.manualFlushMode=t.manualFlushMode??this.manualFlushMode,U_()&&(this.langSmithToOTELTranslator=new sA),this.cachedLSEnvVarsForMetadata=z_()}static getDefaultClientConfig(){const t=Kt("API_KEY"),r=Kt("ENDPOINT")??dg,n=Kt("HIDE_INPUTS")==="true",i=Kt("HIDE_OUTPUTS")==="true";return{apiUrl:r,apiKey:t,webUrl:void 0,hideInputs:n,hideOutputs:i}}getHostUrl(){return this.webUrl?this.webUrl:t$(this.apiUrl)?(this.webUrl="http://localhost:3000",this.webUrl):this.apiUrl.endsWith("/api/v1")?(this.webUrl=this.apiUrl.replace("/api/v1",""),this.webUrl):this.apiUrl.includes("/api")&&!this.apiUrl.split(".",1)[0].endsWith("api")?(this.webUrl=this.apiUrl.replace("/api",""),this.webUrl):this.apiUrl.split(".",1)[0].includes("dev")?(this.webUrl="https://dev.smith.langchain.com",this.webUrl):this.apiUrl.split(".",1)[0].includes("eu")?(this.webUrl="https://eu.smith.langchain.com",this.webUrl):this.apiUrl.split(".",1)[0].includes("beta")?(this.webUrl="https://beta.smith.langchain.com",this.webUrl):(this.webUrl="https://smith.langchain.com",this.webUrl)}get headers(){const t={"User-Agent":`langsmith-js/${L_}`};return this.apiKey&&(t["x-api-key"]=`${this.apiKey}`),this.workspaceId&&(t["x-tenant-id"]=this.workspaceId),t}_getPlatformEndpointPath(t){return this.apiUrl.slice(-3)!=="/v1"&&this.apiUrl.slice(-4)!=="/v1/"?`/v1/platform/${t}`:`/platform/${t}`}async processInputs(t){return this.hideInputs===!1?t:this.hideInputs===!0?{}:typeof this.hideInputs=="function"?this.hideInputs(t):t}async processOutputs(t){return this.hideOutputs===!1?t:this.hideOutputs===!0?{}:typeof this.hideOutputs=="function"?this.hideOutputs(t):t}async prepareRunCreateOrUpdateInputs(t){const r={...t};return r.inputs!==void 0&&(r.inputs=await this.processInputs(r.inputs)),r.outputs!==void 0&&(r.outputs=await this.processOutputs(r.outputs)),r}async _getResponse(t,r){const n=r?.toString()??"",i=`${this.apiUrl}${t}?${n}`;return await this.caller.call(async()=>{const s=await this._fetch(i,{method:"GET",headers:this.headers,signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});return await _e(s,`fetch ${t}`),s})}async _get(t,r){return(await this._getResponse(t,r)).json()}async*_getPaginated(t,r=new URLSearchParams,n){let i=Number(r.get("offset"))||0;const a=Number(r.get("limit"))||100;for(;;){r.set("offset",String(i)),r.set("limit",String(a));const s=`${this.apiUrl}${t}?${r}`,o=await this.caller.call(async()=>{const u=await this._fetch(s,{method:"GET",headers:this.headers,signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});return await _e(u,`fetch ${t}`),u}),c=n?n(await o.json()):await o.json();if(c.length===0||(yield c,c.length<a))break;i+=c.length}}async*_getCursorPaginatedList(t,r=null,n="POST",i="runs"){const a=r?{...r}:{};for(;;){const s=JSON.stringify(a),c=await(await this.caller.call(async()=>{const d=await this._fetch(`${this.apiUrl}${t}`,{method:n,headers:{...this.headers,"Content-Type":"application/json"},signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions,body:s});return await _e(d,`fetch ${t}`),d})).json();if(!c||!c[i])break;yield c[i];const u=c.cursors;if(!u||!u.next)break;a.cursor=u.next}}_shouldSample(){return this.tracingSampleRate===void 0?!0:Math.random()<this.tracingSampleRate}_filterForSampling(t,r=!1){if(this.tracingSampleRate===void 0)return t;if(r){const n=[];for(const i of t)this.filteredPostUuids.has(i.trace_id)?i.id===i.trace_id&&this.filteredPostUuids.delete(i.trace_id):n.push(i);return n}else{const n=[];for(const i of t){const a=i.trace_id??i.id;this.filteredPostUuids.has(a)||(i.id===a?this._shouldSample()?n.push(i):this.filteredPostUuids.add(a):n.push(i))}return n}}async _getBatchSizeLimitBytes(){const t=await this._ensureServerInfo();return this.batchSizeBytesLimit??t.batch_ingest_config?.size_limit_bytes??i$}async _getBatchSizeLimit(){const t=await this._ensureServerInfo();return this.batchSizeLimit??t.batch_ingest_config?.size_limit??s$}async _getDatasetExamplesMultiPartSupport(){return(await this._ensureServerInfo()).instance_flags?.dataset_examples_multipart_enabled??!1}drainAutoBatchQueue({batchSizeLimitBytes:t,batchSizeLimit:r}){const n=[];for(;this.autoBatchQueue.items.length>0;){const[i,a]=this.autoBatchQueue.pop({upToSizeBytes:t,upToSize:r});if(!i.length){a();break}const s=i.reduce((u,d)=>{const h=d.apiUrl??this.apiUrl,p=d.apiKey??this.apiKey,g=d.apiKey===this.apiKey&&d.apiUrl===this.apiUrl?"default":`${h}|${p}`;return u[g]||(u[g]=[]),u[g].push(d),u},{}),o=[];for(const[u,d]of Object.entries(s)){const h=this._processBatch(d,{apiUrl:u==="default"?void 0:u.split("|")[0],apiKey:u==="default"?void 0:u.split("|")[1]});o.push(h)}const c=Promise.all(o).finally(a);n.push(c)}return Promise.all(n)}async _processBatch(t,r){if(!t.length)return;const n=t.reduce((i,a)=>i+(a.size??0),0);try{if(this.langSmithToOTELTranslator!==void 0)this._sendBatchToOTELTranslator(t);else{const i={runCreates:t.filter(s=>s.action==="create").map(s=>s.item),runUpdates:t.filter(s=>s.action==="update").map(s=>s.item)},a=await this._ensureServerInfo();if(a?.batch_ingest_config?.use_multipart_endpoint){const s=a?.instance_flags?.gzip_body_enabled;await this.multipartIngestRuns(i,{...r,useGzip:s,sizeBytes:n})}else await this.batchIngestRuns(i,{...r,sizeBytes:n})}}catch(i){console.error("Error exporting batch:",i)}}_sendBatchToOTELTranslator(t){if(this.langSmithToOTELTranslator!==void 0){const r=new Map,n=[];for(const i of t)i.item.id&&i.otelContext&&(r.set(i.item.id,i.otelContext),i.action==="create"?n.push({operation:"post",id:i.item.id,trace_id:i.item.trace_id??i.item.id,run:i.item}):n.push({operation:"patch",id:i.item.id,trace_id:i.item.trace_id??i.item.id,run:i.item}));this.langSmithToOTELTranslator.exportBatch(n,r)}}async processRunOperation(t){clearTimeout(this.autoBatchTimeout),this.autoBatchTimeout=void 0,t.item=ug(t.item,this.cachedLSEnvVarsForMetadata);const r=this.autoBatchQueue.push(t);if(this.manualFlushMode)return r;const n=await this._getBatchSizeLimitBytes(),i=await this._getBatchSizeLimit();return(this.autoBatchQueue.sizeBytes>n||this.autoBatchQueue.items.length>i)&&this.drainAutoBatchQueue({batchSizeLimitBytes:n,batchSizeLimit:i}),this.autoBatchQueue.items.length>0&&(this.autoBatchTimeout=setTimeout(()=>{this.autoBatchTimeout=void 0,this.drainAutoBatchQueue({batchSizeLimitBytes:n,batchSizeLimit:i})},this.autoBatchAggregationDelayMs)),r}async _getServerInfo(){const r=await(await this.caller.call(async()=>{const n=await this._fetch(`${this.apiUrl}/info`,{method:"GET",headers:{Accept:"application/json"},signal:AbortSignal.timeout(a$),...this.fetchOptions});return await _e(n,"get server info"),n})).json();return this.debug&&console.log(`
=== LangSmith Server Configuration ===
`+JSON.stringify(r,null,2)+`
`),r}async _ensureServerInfo(){return this._getServerInfoPromise===void 0&&(this._getServerInfoPromise=(async()=>{if(this._serverInfo===void 0)try{this._serverInfo=await this._getServerInfo()}catch(t){console.warn(`[LANGSMITH]: Failed to fetch info on supported operations. Falling back to batch operations and default limits. Info: ${t.status??"Unspecified status code"} ${t.message}`)}return this._serverInfo??{}})()),this._getServerInfoPromise.then(t=>(this._serverInfo===void 0&&(this._getServerInfoPromise=void 0),t))}async _getSettings(){return this.settings||(this.settings=this._get("/settings")),await this.settings}async flush(){const t=await this._getBatchSizeLimitBytes(),r=await this._getBatchSizeLimit();await this.drainAutoBatchQueue({batchSizeLimitBytes:t,batchSizeLimit:r})}_cloneCurrentOTELContext(){const t=q_(),r=rA();if(this.langSmithToOTELTranslator!==void 0){const n=t.getActiveSpan();if(n)return t.setSpan(r.active(),n)}}async createRun(t,r){if(!this._filterForSampling([t]).length)return;const n={...this.headers,"Content-Type":"application/json"},i=t.project_name;delete t.project_name;const a=await this.prepareRunCreateOrUpdateInputs({session_name:i,...t,start_time:t.start_time??Date.now()});if(this.autoBatchTracing&&a.trace_id!==void 0&&a.dotted_order!==void 0){const c=this._cloneCurrentOTELContext();this.processRunOperation({action:"create",item:a,otelContext:c,apiKey:r?.apiKey,apiUrl:r?.apiUrl}).catch(console.error);return}const s=ug(a,this.cachedLSEnvVarsForMetadata);r?.apiKey!==void 0&&(n["x-api-key"]=r.apiKey),r?.workspaceId!==void 0&&(n["x-tenant-id"]=r.workspaceId);const o=Xt(s,`Creating run with id: ${s.id}`);await this.caller.call(async()=>{const c=await this._fetch(`${r?.apiUrl??this.apiUrl}/runs`,{method:"POST",headers:n,signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions,body:o});return await _e(c,"create run",!0),c})}async batchIngestRuns({runCreates:t,runUpdates:r},n){if(t===void 0&&r===void 0)return;let i=await Promise.all(t?.map(c=>this.prepareRunCreateOrUpdateInputs(c))??[]),a=await Promise.all(r?.map(c=>this.prepareRunCreateOrUpdateInputs(c))??[]);if(i.length>0&&a.length>0){const c=i.reduce((d,h)=>(h.id&&(d[h.id]=h),d),{}),u=[];for(const d of a)d.id!==void 0&&c[d.id]?c[d.id]={...c[d.id],...d}:u.push(d);i=Object.values(c),a=u}const s={post:i,patch:a};if(!s.post.length&&!s.patch.length)return;const o={post:[],patch:[]};for(const c of["post","patch"]){const u=c,d=s[u].reverse();let h=d.pop();for(;h!==void 0;)o[u].push(h),h=d.pop()}if(o.post.length>0||o.patch.length>0){const c=o.post.map(u=>u.id).concat(o.patch.map(u=>u.id)).join(",");await this._postBatchIngestRuns(Xt(o,`Ingesting runs with ids: ${c}`),n)}}async _postBatchIngestRuns(t,r){const n={...this.headers,"Content-Type":"application/json",Accept:"application/json"};r?.apiKey!==void 0&&(n["x-api-key"]=r.apiKey),await this.batchIngestCaller.callWithOptions({sizeBytes:r?.sizeBytes},async()=>{const i=await this._fetch(`${r?.apiUrl??this.apiUrl}/runs/batch`,{method:"POST",headers:n,signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions,body:t});return await _e(i,"batch create run",!0),i})}async multipartIngestRuns({runCreates:t,runUpdates:r},n){if(t===void 0&&r===void 0)return;const i={};let a=[];for(const h of t??[]){const p=await this.prepareRunCreateOrUpdateInputs(h);p.id!==void 0&&p.attachments!==void 0&&(i[p.id]=p.attachments),delete p.attachments,a.push(p)}let s=[];for(const h of r??[])s.push(await this.prepareRunCreateOrUpdateInputs(h));if(a.find(h=>h.trace_id===void 0||h.dotted_order===void 0)!==void 0)throw new Error('Multipart ingest requires "trace_id" and "dotted_order" to be set when creating a run');if(s.find(h=>h.trace_id===void 0||h.dotted_order===void 0)!==void 0)throw new Error('Multipart ingest requires "trace_id" and "dotted_order" to be set when updating a run');if(a.length>0&&s.length>0){const h=a.reduce((y,g)=>(g.id&&(y[g.id]=g),y),{}),p=[];for(const y of s)y.id!==void 0&&h[y.id]?h[y.id]={...h[y.id],...y}:p.push(y);a=Object.values(h),s=p}if(a.length===0&&s.length===0)return;const u=[],d=[];for(const[h,p]of[["post",a],["patch",s]])for(const y of p){const{inputs:g,outputs:w,events:b,extra:S,error:O,serialized:T,attachments:z,...B}=y,G={inputs:g,outputs:w,events:b,extra:S,error:O,serialized:T},q=Xt(B,`Serializing for multipart ingestion of run with id: ${B.id}`);d.push({name:`${h}.${B.id}`,payload:new Blob([q],{type:`application/json; length=${q.length}`})});for(const[K,Oe]of Object.entries(G)){if(Oe===void 0)continue;const Le=Xt(Oe,`Serializing ${K} for multipart ingestion of run with id: ${B.id}`);d.push({name:`${h}.${B.id}.${K}`,payload:new Blob([Le],{type:`application/json; length=${Le.length}`})})}if(B.id!==void 0){const K=i[B.id];if(K){delete i[B.id];for(const[Oe,Le]of Object.entries(K)){let qe,$e;if(Array.isArray(Le)?[qe,$e]=Le:(qe=Le.mimeType,$e=Le.data),Oe.includes(".")){console.warn(`Skipping attachment '${Oe}' for run ${B.id}: Invalid attachment name. Attachment names must not contain periods ('.'). Please rename the attachment and try again.`);continue}d.push({name:`attachment.${B.id}.${Oe}`,payload:new Blob([$e],{type:`${qe}; length=${$e.byteLength}`})})}}}u.push(`trace=${B.trace_id},id=${B.id}`)}await this._sendMultipartRequest(d,u.join("; "),n)}async _createNodeFetchBody(t,r){const n=[];for(const s of t)n.push(new Blob([`--${r}\r
`])),n.push(new Blob([`Content-Disposition: form-data; name="${s.name}"\r
`,`Content-Type: ${s.payload.type}\r
\r
`])),n.push(s.payload),n.push(new Blob([`\r
`]));return n.push(new Blob([`--${r}--\r
`])),await new Blob(n).arrayBuffer()}async _createMultipartStream(t,r){const n=new TextEncoder;return new ReadableStream({async start(a){const s=async o=>{typeof o=="string"?a.enqueue(n.encode(o)):a.enqueue(o)};for(const o of t){await s(`--${r}\r
`),await s(`Content-Disposition: form-data; name="${o.name}"\r
`),await s(`Content-Type: ${o.payload.type}\r
\r
`);const u=o.payload.stream().getReader();try{let d;for(;!(d=await u.read()).done;)a.enqueue(d.value)}finally{u.releaseLock()}await s(`\r
`)}await s(`--${r}--\r
`),a.close()}})}async _sendMultipartRequest(t,r,n){const i="----LangSmithFormBoundary"+Math.random().toString(36).slice(2),a=BR(),s=()=>this._createNodeFetchBody(t,i),o=()=>this._createMultipartStream(t,i),c=async u=>this.batchIngestCaller.callWithOptions({sizeBytes:n?.sizeBytes},async()=>{const d=await u(),h={...this.headers,"Content-Type":`multipart/form-data; boundary=${i}`};n?.apiKey!==void 0&&(h["x-api-key"]=n.apiKey);let p=d;n?.useGzip&&typeof d=="object"&&"pipeThrough"in d&&(p=d.pipeThrough(new CompressionStream("gzip")),h["Content-Encoding"]="gzip");const y=await this._fetch(`${n?.apiUrl??this.apiUrl}/runs/multipart`,{method:"POST",headers:h,body:p,duplex:"half",signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});return await _e(y,"Failed to send multipart request",!0),y});try{let u,d=!1;!a&&!this.multipartStreamingDisabled&&F_()!=="bun"?(d=!0,u=await c(o)):u=await c(s),(!this.multipartStreamingDisabled||d)&&u.status===422&&(n?.apiUrl??this.apiUrl)!==dg&&(console.warn(`Streaming multipart upload to ${n?.apiUrl??this.apiUrl}/runs/multipart failed. This usually means the host does not support chunked uploads. Retrying with a buffered upload for operation "${r}".`),this.multipartStreamingDisabled=!0,u=await c(s))}catch(u){console.warn(`${u.message.trim()}

Context: ${r}`)}}async updateRun(t,r,n){De(t),r.inputs&&(r.inputs=await this.processInputs(r.inputs)),r.outputs&&(r.outputs=await this.processOutputs(r.outputs));const i={...r,id:t};if(!this._filterForSampling([i],!0).length)return;if(this.autoBatchTracing&&i.trace_id!==void 0&&i.dotted_order!==void 0){const o=this._cloneCurrentOTELContext();if(r.end_time!==void 0&&i.parent_run_id===void 0&&this.blockOnRootRunFinalization&&!this.manualFlushMode){await this.processRunOperation({action:"update",item:i,otelContext:o,apiKey:n?.apiKey,apiUrl:n?.apiUrl}).catch(console.error);return}else this.processRunOperation({action:"update",item:i,otelContext:o,apiKey:n?.apiKey,apiUrl:n?.apiUrl}).catch(console.error);return}const a={...this.headers,"Content-Type":"application/json"};n?.apiKey!==void 0&&(a["x-api-key"]=n.apiKey),n?.workspaceId!==void 0&&(a["x-tenant-id"]=n.workspaceId);const s=Xt(r,`Serializing payload to update run with id: ${t}`);await this.caller.call(async()=>{const o=await this._fetch(`${n?.apiUrl??this.apiUrl}/runs/${t}`,{method:"PATCH",headers:a,signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions,body:s});return await _e(o,"update run",!0),o})}async readRun(t,{loadChildRuns:r}={loadChildRuns:!1}){De(t);let n=await this._get(`/runs/${t}`);return r&&(n=await this._loadChildRuns(n)),n}async getRunUrl({runId:t,run:r,projectOpts:n}){if(r!==void 0){let i;r.session_id?i=r.session_id:n?.projectName?i=(await this.readProject({projectName:n?.projectName})).id:n?.projectId?i=n?.projectId:i=(await this.readProject({projectName:Kt("PROJECT")||"default"})).id;const a=await this._getTenantId();return`${this.getHostUrl()}/o/${a}/projects/p/${i}/r/${r.id}?poll=true`}else if(t!==void 0){const i=await this.readRun(t);if(!i.app_path)throw new Error(`Run ${t} has no app_path`);return`${this.getHostUrl()}${i.app_path}`}else throw new Error("Must provide either runId or run")}async _loadChildRuns(t){const r=await r$(this.listRuns({isRoot:!1,projectId:t.session_id,traceId:t.trace_id})),n={},i={};r.sort((a,s)=>(a?.dotted_order??"").localeCompare(s?.dotted_order??""));for(const a of r){if(a.parent_run_id===null||a.parent_run_id===void 0)throw new Error(`Child run ${a.id} has no parent`);a.dotted_order?.startsWith(t.dotted_order??"")&&a.id!==t.id&&(a.parent_run_id in n||(n[a.parent_run_id]=[]),n[a.parent_run_id].push(a),i[a.id]=a)}t.child_runs=n[t.id]||[];for(const a in n)a!==t.id&&(i[a].child_runs=n[a]);return t}async*listRuns(t){const{projectId:r,projectName:n,parentRunId:i,traceId:a,referenceExampleId:s,startTime:o,executionOrder:c,isRoot:u,runType:d,error:h,id:p,query:y,filter:g,traceFilter:w,treeFilter:b,limit:S,select:O,order:T}=t;let z=[];if(r&&(z=Array.isArray(r)?r:[r]),n){const K=Array.isArray(n)?n:[n],Oe=await Promise.all(K.map(Le=>this.readProject({projectName:Le}).then(qe=>qe.id)));z.push(...Oe)}const B=["app_path","completion_cost","completion_tokens","dotted_order","end_time","error","events","extra","feedback_stats","first_token_time","id","inputs","name","outputs","parent_run_id","parent_run_ids","prompt_cost","prompt_tokens","reference_example_id","run_type","session_id","start_time","status","tags","total_cost","total_tokens","trace_id"],G={session:z.length?z:null,run_type:d,reference_example:s,query:y,filter:g,trace_filter:w,tree_filter:b,execution_order:c,parent_run:i,start_time:o?o.toISOString():null,error:h,id:p,limit:S,trace:a,select:O||B,is_root:u,order:T};G.select.includes("child_run_ids")&&Od("Deprecated: 'child_run_ids' in the listRuns select parameter is deprecated and will be removed in a future version.");let q=0;for await(const K of this._getCursorPaginatedList("/runs/query",G))if(S){if(q>=S)break;if(K.length+q>S){yield*K.slice(0,S-q);break}q+=K.length,yield*K}else yield*K}async*listGroupRuns(t){const{projectId:r,projectName:n,groupBy:i,filter:a,startTime:s,endTime:o,limit:c,offset:u}=t,h={session_id:r||(await this.readProject({projectName:n})).id,group_by:i,filter:a,start_time:s?s.toISOString():null,end_time:o?o.toISOString():null,limit:Number(c)||100};let p=Number(u)||0;const y="/runs/group",g=`${this.apiUrl}${y}`;for(;;){const w={...h,offset:p},b=Object.fromEntries(Object.entries(w).filter(([G,q])=>q!==void 0)),S=JSON.stringify(b),T=await(await this.caller.call(async()=>{const G=await this._fetch(g,{method:"POST",headers:{...this.headers,"Content-Type":"application/json"},signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions,body:S});return await _e(G,`Failed to fetch ${y}`),G})).json(),{groups:z,total:B}=T;if(z.length===0)break;for(const G of z)yield G;if(p+=z.length,p>=B)break}}async getRunStats({id:t,trace:r,parentRun:n,runType:i,projectNames:a,projectIds:s,referenceExampleIds:o,startTime:c,endTime:u,error:d,query:h,filter:p,traceFilter:y,treeFilter:g,isRoot:w,dataSourceType:b}){let S=s||[];a&&(S=[...s||[],...await Promise.all(a.map(q=>this.readProject({projectName:q}).then(K=>K.id)))]);const T=Object.fromEntries(Object.entries({id:t,trace:r,parent_run:n,run_type:i,session:S,reference_example:o,start_time:c,end_time:u,error:d,query:h,filter:p,trace_filter:y,tree_filter:g,is_root:w,data_source_type:b}).filter(([q,K])=>K!==void 0)),z=JSON.stringify(T);return await(await this.caller.call(async()=>{const q=await this._fetch(`${this.apiUrl}/runs/stats`,{method:"POST",headers:{...this.headers,"Content-Type":"application/json"},signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions,body:z});return await _e(q,"get run stats"),q})).json()}async shareRun(t,{shareId:r}={}){const n={run_id:t,share_token:r||$a()};De(t);const i=JSON.stringify(n),s=await(await this.caller.call(async()=>{const o=await this._fetch(`${this.apiUrl}/runs/${t}/share`,{method:"PUT",headers:this.headers,signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions,body:i});return await _e(o,"share run"),o})).json();if(s===null||!("share_token"in s))throw new Error("Invalid response from server");return`${this.getHostUrl()}/public/${s.share_token}/r`}async unshareRun(t){De(t),await this.caller.call(async()=>{const r=await this._fetch(`${this.apiUrl}/runs/${t}/share`,{method:"DELETE",headers:this.headers,signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});return await _e(r,"unshare run",!0),r})}async readRunSharedLink(t){De(t);const n=await(await this.caller.call(async()=>{const i=await this._fetch(`${this.apiUrl}/runs/${t}/share`,{method:"GET",headers:this.headers,signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});return await _e(i,"read run shared link"),i})).json();if(!(n===null||!("share_token"in n)))return`${this.getHostUrl()}/public/${n.share_token}/r`}async listSharedRuns(t,{runIds:r}={}){const n=new URLSearchParams({share_token:t});if(r!==void 0)for(const s of r)n.append("id",s);return De(t),await(await this.caller.call(async()=>{const s=await this._fetch(`${this.apiUrl}/public/${t}/runs${n}`,{method:"GET",headers:this.headers,signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});return await _e(s,"list shared runs"),s})).json()}async readDatasetSharedSchema(t,r){if(!t&&!r)throw new Error("Either datasetId or datasetName must be given");t||(t=(await this.readDataset({datasetName:r})).id),De(t);const i=await(await this.caller.call(async()=>{const a=await this._fetch(`${this.apiUrl}/datasets/${t}/share`,{method:"GET",headers:this.headers,signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});return await _e(a,"read dataset shared schema"),a})).json();return i.url=`${this.getHostUrl()}/public/${i.share_token}/d`,i}async shareDataset(t,r){if(!t&&!r)throw new Error("Either datasetId or datasetName must be given");t||(t=(await this.readDataset({datasetName:r})).id);const n={dataset_id:t};De(t);const i=JSON.stringify(n),s=await(await this.caller.call(async()=>{const o=await this._fetch(`${this.apiUrl}/datasets/${t}/share`,{method:"PUT",headers:this.headers,signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions,body:i});return await _e(o,"share dataset"),o})).json();return s.url=`${this.getHostUrl()}/public/${s.share_token}/d`,s}async unshareDataset(t){De(t),await this.caller.call(async()=>{const r=await this._fetch(`${this.apiUrl}/datasets/${t}/share`,{method:"DELETE",headers:this.headers,signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});return await _e(r,"unshare dataset",!0),r})}async readSharedDataset(t){return De(t),await(await this.caller.call(async()=>{const i=await this._fetch(`${this.apiUrl}/public/${t}/datasets`,{method:"GET",headers:this.headers,signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});return await _e(i,"read shared dataset"),i})).json()}async listSharedExamples(t,r){const n={};r?.exampleIds&&(n.id=r.exampleIds);const i=new URLSearchParams;Object.entries(n).forEach(([o,c])=>{Array.isArray(c)?c.forEach(u=>i.append(o,u)):i.append(o,c)});const a=await this.caller.call(async()=>{const o=await this._fetch(`${this.apiUrl}/public/${t}/examples?${i.toString()}`,{method:"GET",headers:this.headers,signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});return await _e(o,"list shared examples"),o}),s=await a.json();if(!a.ok)throw"detail"in s?new Error(`Failed to list shared examples.
Status: ${a.status}
Message: ${Array.isArray(s.detail)?s.detail.join(`
`):"Unspecified error"}`):new Error(`Failed to list shared examples: ${a.status} ${a.statusText}`);return s.map(o=>({...o,_hostUrl:this.getHostUrl()}))}async createProject({projectName:t,description:r=null,metadata:n=null,upsert:i=!1,projectExtra:a=null,referenceDatasetId:s=null}){const o=i?"?upsert=true":"",c=`${this.apiUrl}/sessions${o}`,u=a||{};n&&(u.metadata=n);const d={name:t,extra:u,description:r};s!==null&&(d.reference_dataset_id=s);const h=JSON.stringify(d);return await(await this.caller.call(async()=>{const g=await this._fetch(c,{method:"POST",headers:{...this.headers,"Content-Type":"application/json"},signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions,body:h});return await _e(g,"create project"),g})).json()}async updateProject(t,{name:r=null,description:n=null,metadata:i=null,projectExtra:a=null,endTime:s=null}){const o=`${this.apiUrl}/sessions/${t}`;let c=a;i&&(c={...c||{},metadata:i});const u=JSON.stringify({name:r,extra:c,description:n,end_time:s?new Date(s).toISOString():null});return await(await this.caller.call(async()=>{const p=await this._fetch(o,{method:"PATCH",headers:{...this.headers,"Content-Type":"application/json"},signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions,body:u});return await _e(p,"update project"),p})).json()}async hasProject({projectId:t,projectName:r}){let n="/sessions";const i=new URLSearchParams;if(t!==void 0&&r!==void 0)throw new Error("Must provide either projectName or projectId, not both");if(t!==void 0)De(t),n+=`/${t}`;else if(r!==void 0)i.append("name",r);else throw new Error("Must provide projectName or projectId");const a=await this.caller.call(async()=>{const s=await this._fetch(`${this.apiUrl}${n}?${i}`,{method:"GET",headers:this.headers,signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});return await _e(s,"has project"),s});try{const s=await a.json();return a.ok?Array.isArray(s)?s.length>0:!0:!1}catch{return!1}}async readProject({projectId:t,projectName:r,includeStats:n}){let i="/sessions";const a=new URLSearchParams;if(t!==void 0&&r!==void 0)throw new Error("Must provide either projectName or projectId, not both");if(t!==void 0)De(t),i+=`/${t}`;else if(r!==void 0)a.append("name",r);else throw new Error("Must provide projectName or projectId");n!==void 0&&a.append("include_stats",n.toString());const s=await this._get(i,a);let o;if(Array.isArray(s)){if(s.length===0)throw new Error(`Project[id=${t}, name=${r}] not found`);o=s[0]}else o=s;return o}async getProjectUrl({projectId:t,projectName:r}){if(t===void 0&&r===void 0)throw new Error("Must provide either projectName or projectId");const n=await this.readProject({projectId:t,projectName:r}),i=await this._getTenantId();return`${this.getHostUrl()}/o/${i}/projects/p/${n.id}`}async getDatasetUrl({datasetId:t,datasetName:r}){if(t===void 0&&r===void 0)throw new Error("Must provide either datasetName or datasetId");const n=await this.readDataset({datasetId:t,datasetName:r}),i=await this._getTenantId();return`${this.getHostUrl()}/o/${i}/datasets/${n.id}`}async _getTenantId(){if(this._tenantId!==null)return this._tenantId;const t=new URLSearchParams({limit:"1"});for await(const r of this._getPaginated("/sessions",t))return this._tenantId=r[0].tenant_id,r[0].tenant_id;throw new Error("No projects found to resolve tenant.")}async*listProjects({projectIds:t,name:r,nameContains:n,referenceDatasetId:i,referenceDatasetName:a,includeStats:s,datasetVersion:o,referenceFree:c,metadata:u}={}){const d=new URLSearchParams;if(t!==void 0)for(const h of t)d.append("id",h);if(r!==void 0&&d.append("name",r),n!==void 0&&d.append("name_contains",n),i!==void 0)d.append("reference_dataset",i);else if(a!==void 0){const h=await this.readDataset({datasetName:a});d.append("reference_dataset",h.id)}s!==void 0&&d.append("include_stats",s.toString()),o!==void 0&&d.append("dataset_version",o),c!==void 0&&d.append("reference_free",c.toString()),u!==void 0&&d.append("metadata",JSON.stringify(u));for await(const h of this._getPaginated("/sessions",d))yield*h}async deleteProject({projectId:t,projectName:r}){let n;if(t===void 0&&r===void 0)throw new Error("Must provide projectName or projectId");if(t!==void 0&&r!==void 0)throw new Error("Must provide either projectName or projectId, not both");t===void 0?n=(await this.readProject({projectName:r})).id:n=t,De(n),await this.caller.call(async()=>{const i=await this._fetch(`${this.apiUrl}/sessions/${n}`,{method:"DELETE",headers:this.headers,signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});return await _e(i,`delete session ${n} (${r})`,!0),i})}async uploadCsv({csvFile:t,fileName:r,inputKeys:n,outputKeys:i,description:a,dataType:s,name:o}){const c=`${this.apiUrl}/datasets/upload`,u=new FormData;return u.append("file",t,r),n.forEach(p=>{u.append("input_keys",p)}),i.forEach(p=>{u.append("output_keys",p)}),a&&u.append("description",a),s&&u.append("data_type",s),o&&u.append("name",o),await(await this.caller.call(async()=>{const p=await this._fetch(c,{method:"POST",headers:this.headers,signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions,body:u});return await _e(p,"upload CSV"),p})).json()}async createDataset(t,{description:r,dataType:n,inputsSchema:i,outputsSchema:a,metadata:s}={}){const o={name:t,description:r,extra:s?{metadata:s}:void 0};n&&(o.data_type=n),i&&(o.inputs_schema_definition=i),a&&(o.outputs_schema_definition=a);const c=JSON.stringify(o);return await(await this.caller.call(async()=>{const h=await this._fetch(`${this.apiUrl}/datasets`,{method:"POST",headers:{...this.headers,"Content-Type":"application/json"},signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions,body:c});return await _e(h,"create dataset"),h})).json()}async readDataset({datasetId:t,datasetName:r}){let n="/datasets";const i=new URLSearchParams({limit:"1"});if(t&&r)throw new Error("Must provide either datasetName or datasetId, not both");if(t)De(t),n+=`/${t}`;else if(r)i.append("name",r);else throw new Error("Must provide datasetName or datasetId");const a=await this._get(n,i);let s;if(Array.isArray(a)){if(a.length===0)throw new Error(`Dataset[id=${t}, name=${r}] not found`);s=a[0]}else s=a;return s}async hasDataset({datasetId:t,datasetName:r}){try{return await this.readDataset({datasetId:t,datasetName:r}),!0}catch(n){if(n instanceof Error&&n.message.toLocaleLowerCase().includes("not found"))return!1;throw n}}async diffDatasetVersions({datasetId:t,datasetName:r,fromVersion:n,toVersion:i}){let a=t;if(a===void 0&&r===void 0)throw new Error("Must provide either datasetName or datasetId");if(a!==void 0&&r!==void 0)throw new Error("Must provide either datasetName or datasetId, not both");a===void 0&&(a=(await this.readDataset({datasetName:r})).id);const s=new URLSearchParams({from_version:typeof n=="string"?n:n.toISOString(),to_version:typeof i=="string"?i:i.toISOString()});return await this._get(`/datasets/${a}/versions/diff`,s)}async readDatasetOpenaiFinetuning({datasetId:t,datasetName:r}){const n="/datasets";if(t===void 0)if(r!==void 0)t=(await this.readDataset({datasetName:r})).id;else throw new Error("Must provide either datasetName or datasetId");return(await(await this._getResponse(`${n}/${t}/openai_ft`)).text()).trim().split(`
`).map(o=>JSON.parse(o))}async*listDatasets({limit:t=100,offset:r=0,datasetIds:n,datasetName:i,datasetNameContains:a,metadata:s}={}){const o="/datasets",c=new URLSearchParams({limit:t.toString(),offset:r.toString()});if(n!==void 0)for(const u of n)c.append("id",u);i!==void 0&&c.append("name",i),a!==void 0&&c.append("name_contains",a),s!==void 0&&c.append("metadata",JSON.stringify(s));for await(const u of this._getPaginated(o,c))yield*u}async updateDataset(t){const{datasetId:r,datasetName:n,...i}=t;if(!r&&!n)throw new Error("Must provide either datasetName or datasetId");const a=r??(await this.readDataset({datasetName:n})).id;De(a);const s=JSON.stringify(i);return await(await this.caller.call(async()=>{const c=await this._fetch(`${this.apiUrl}/datasets/${a}`,{method:"PATCH",headers:{...this.headers,"Content-Type":"application/json"},signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions,body:s});return await _e(c,"update dataset"),c})).json()}async updateDatasetTag(t){const{datasetId:r,datasetName:n,asOf:i,tag:a}=t;if(!r&&!n)throw new Error("Must provide either datasetName or datasetId");const s=r??(await this.readDataset({datasetName:n})).id;De(s);const o=JSON.stringify({as_of:typeof i=="string"?i:i.toISOString(),tag:a});await this.caller.call(async()=>{const c=await this._fetch(`${this.apiUrl}/datasets/${s}/tags`,{method:"PUT",headers:{...this.headers,"Content-Type":"application/json"},signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions,body:o});return await _e(c,"update dataset tags",!0),c})}async deleteDataset({datasetId:t,datasetName:r}){let n="/datasets",i=t;if(t!==void 0&&r!==void 0)throw new Error("Must provide either datasetName or datasetId, not both");if(r!==void 0&&(i=(await this.readDataset({datasetName:r})).id),i!==void 0)De(i),n+=`/${i}`;else throw new Error("Must provide datasetName or datasetId");await this.caller.call(async()=>{const a=await this._fetch(this.apiUrl+n,{method:"DELETE",headers:this.headers,signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});return await _e(a,`delete ${n}`,!0),a})}async indexDataset({datasetId:t,datasetName:r,tag:n}){let i=t;if(!i&&!r)throw new Error("Must provide either datasetName or datasetId");if(i&&r)throw new Error("Must provide either datasetName or datasetId, not both");i||(i=(await this.readDataset({datasetName:r})).id),De(i);const s=JSON.stringify({tag:n});await(await this.caller.call(async()=>{const c=await this._fetch(`${this.apiUrl}/datasets/${i}/index`,{method:"POST",headers:{...this.headers,"Content-Type":"application/json"},signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions,body:s});return await _e(c,"index dataset"),c})).json()}async similarExamples(t,r,n,{filter:i}={}){const a={limit:n,inputs:t};i!==void 0&&(a.filter=i),De(r);const s=JSON.stringify(a);return(await(await this.caller.call(async()=>{const u=await this._fetch(`${this.apiUrl}/datasets/${r}/search`,{headers:{...this.headers,"Content-Type":"application/json"},signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions,method:"POST",body:s});return await _e(u,"fetch similar examples"),u})).json()).examples}async createExample(t,r,n){if(fg(t)&&(r!==void 0||n!==void 0))throw new Error("Cannot provide outputs or options when using ExampleCreate object");let i=r?n?.datasetId:t.dataset_id;const a=r?n?.datasetName:t.dataset_name;if(i===void 0&&a===void 0)throw new Error("Must provide either datasetName or datasetId");if(i!==void 0&&a!==void 0)throw new Error("Must provide either datasetName or datasetId, not both");i===void 0&&(i=(await this.readDataset({datasetName:a})).id);const s=(r?n?.createdAt:t.created_at)||new Date;let o;fg(t)?o=t:o={inputs:t,outputs:r,created_at:s?.toISOString(),id:n?.exampleId,metadata:n?.metadata,split:n?.split,source_run_id:n?.sourceRunId,use_source_run_io:n?.useSourceRunIO,use_source_run_attachments:n?.useSourceRunAttachments,attachments:n?.attachments};const c=await this._uploadExamplesMultipart(i,[o]);return await this.readExample(c.example_ids?.[0]??$a())}async createExamples(t){if(Array.isArray(t)){if(t.length===0)return[];const O=t;let T=O[0].dataset_id;const z=O[0].dataset_name;if(T===void 0&&z===void 0)throw new Error("Must provide either datasetName or datasetId");if(T!==void 0&&z!==void 0)throw new Error("Must provide either datasetName or datasetId, not both");T===void 0&&(T=(await this.readDataset({datasetName:z})).id);const B=await this._uploadExamplesMultipart(T,O);return await Promise.all(B.example_ids.map(q=>this.readExample(q)))}const{inputs:r,outputs:n,metadata:i,splits:a,sourceRunIds:s,useSourceRunIOs:o,useSourceRunAttachments:c,attachments:u,exampleIds:d,datasetId:h,datasetName:p}=t;if(r===void 0)throw new Error("Must provide inputs when using legacy parameters");let y=h;const g=p;if(y===void 0&&g===void 0)throw new Error("Must provide either datasetName or datasetId");if(y!==void 0&&g!==void 0)throw new Error("Must provide either datasetName or datasetId, not both");y===void 0&&(y=(await this.readDataset({datasetName:g})).id);const w=r.map((O,T)=>({dataset_id:y,inputs:O,outputs:n?.[T],metadata:i?.[T],split:a?.[T],id:d?.[T],attachments:u?.[T],source_run_id:s?.[T],use_source_run_io:o?.[T],use_source_run_attachments:c?.[T]})),b=await this._uploadExamplesMultipart(y,w);return await Promise.all(b.example_ids.map(O=>this.readExample(O)))}async createLLMExample(t,r,n){return this.createExample({input:t},{output:r},n)}async createChatExample(t,r,n){const i=t.map(s=>mm(s)?gm(s):s),a=mm(r)?gm(r):r;return this.createExample({input:i},{output:a},n)}async readExample(t){De(t);const r=`/examples/${t}`,n=await this._get(r),{attachment_urls:i,...a}=n,s=a;return i&&(s.attachments=Object.entries(i).reduce((o,[c,u])=>(o[c.slice(11)]={presigned_url:u.presigned_url,mime_type:u.mime_type},o),{})),s}async*listExamples({datasetId:t,datasetName:r,exampleIds:n,asOf:i,splits:a,inlineS3Urls:s,metadata:o,limit:c,offset:u,filter:d,includeAttachments:h}={}){let p;if(t!==void 0&&r!==void 0)throw new Error("Must provide either datasetName or datasetId, not both");if(t!==void 0)p=t;else if(r!==void 0)p=(await this.readDataset({datasetName:r})).id;else throw new Error("Must provide a datasetName or datasetId");const y=new URLSearchParams({dataset:p}),g=i?typeof i=="string"?i:i?.toISOString():void 0;g&&y.append("as_of",g);const w=s??!0;if(y.append("inline_s3_urls",w.toString()),n!==void 0)for(const S of n)y.append("id",S);if(a!==void 0)for(const S of a)y.append("splits",S);if(o!==void 0){const S=JSON.stringify(o);y.append("metadata",S)}c!==void 0&&y.append("limit",c.toString()),u!==void 0&&y.append("offset",u.toString()),d!==void 0&&y.append("filter",d),h===!0&&["attachment_urls","outputs","metadata"].forEach(S=>y.append("select",S));let b=0;for await(const S of this._getPaginated("/examples",y)){for(const O of S){const{attachment_urls:T,...z}=O,B=z;T&&(B.attachments=Object.entries(T).reduce((G,[q,K])=>(G[q.slice(11)]={presigned_url:K.presigned_url,mime_type:K.mime_type||void 0},G),{})),yield B,b++}if(c!==void 0&&b>=c)break}}async deleteExample(t){De(t);const r=`/examples/${t}`;await this.caller.call(async()=>{const n=await this._fetch(this.apiUrl+r,{method:"DELETE",headers:this.headers,signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});return await _e(n,`delete ${r}`,!0),n})}async updateExample(t,r){let n;r?n=t:n=t.id,De(n);let i;r?i={id:n,...r}:i=t;let a;return i.dataset_id!==void 0?a=i.dataset_id:a=(await this.readExample(n)).dataset_id,this._updateExamplesMultipart(a,[i])}async updateExamples(t){let r;return t[0].dataset_id===void 0?r=(await this.readExample(t[0].id)).dataset_id:r=t[0].dataset_id,this._updateExamplesMultipart(r,t)}async readDatasetVersion({datasetId:t,datasetName:r,asOf:n,tag:i}){let a;if(t?a=t:a=(await this.readDataset({datasetName:r})).id,De(a),n&&i||!n&&!i)throw new Error("Exactly one of asOf and tag must be specified.");const s=new URLSearchParams;return n!==void 0&&s.append("as_of",typeof n=="string"?n:n.toISOString()),i!==void 0&&s.append("tag",i),await(await this.caller.call(async()=>{const c=await this._fetch(`${this.apiUrl}/datasets/${a}/version?${s.toString()}`,{method:"GET",headers:{...this.headers},signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});return await _e(c,"read dataset version"),c})).json()}async listDatasetSplits({datasetId:t,datasetName:r,asOf:n}){let i;if(t===void 0&&r===void 0)throw new Error("Must provide dataset name or ID");if(t!==void 0&&r!==void 0)throw new Error("Must provide either datasetName or datasetId, not both");t===void 0?i=(await this.readDataset({datasetName:r})).id:i=t,De(i);const a=new URLSearchParams,s=n?typeof n=="string"?n:n?.toISOString():void 0;return s&&a.append("as_of",s),await this._get(`/datasets/${i}/splits`,a)}async updateDatasetSplits({datasetId:t,datasetName:r,splitName:n,exampleIds:i,remove:a=!1}){let s;if(t===void 0&&r===void 0)throw new Error("Must provide dataset name or ID");if(t!==void 0&&r!==void 0)throw new Error("Must provide either datasetName or datasetId, not both");t===void 0?s=(await this.readDataset({datasetName:r})).id:s=t,De(s);const o={split_name:n,examples:i.map(u=>(De(u),u)),remove:a},c=JSON.stringify(o);await this.caller.call(async()=>{const u=await this._fetch(`${this.apiUrl}/datasets/${s}/splits`,{method:"PUT",headers:{...this.headers,"Content-Type":"application/json"},signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions,body:c});return await _e(u,"update dataset splits",!0),u})}async evaluateRun(t,r,{sourceInfo:n,loadChildRuns:i,referenceExample:a}={loadChildRuns:!1}){Od("This method is deprecated and will be removed in future LangSmith versions, use `evaluate` from `langsmith/evaluation` instead.");let s;if(typeof t=="string")s=await this.readRun(t,{loadChildRuns:i});else if(typeof t=="object"&&"id"in t)s=t;else throw new Error(`Invalid run type: ${typeof t}`);s.reference_example_id!==null&&s.reference_example_id!==void 0&&(a=await this.readExample(s.reference_example_id));const o=await r.evaluateRun(s,a),[c,u]=await this._logEvaluationFeedback(o,s,n);return u[0]}async createFeedback(t,r,{score:n,value:i,correction:a,comment:s,sourceInfo:o,feedbackSourceType:c="api",sourceRunId:u,feedbackId:d,feedbackConfig:h,projectId:p,comparativeExperimentId:y}){if(!t&&!p)throw new Error("One of runId or projectId must be provided");if(t&&p)throw new Error("Only one of runId or projectId can be provided");const g={type:c??"api",metadata:o??{}};u!==void 0&&g?.metadata!==void 0&&!g.metadata.__run&&(g.metadata.__run={run_id:u}),g?.metadata!==void 0&&g.metadata.__run?.run_id!==void 0&&De(g.metadata.__run.run_id);const w={id:d??$a(),run_id:t,key:r,score:lg(n),value:i,correction:a,comment:s,feedback_source:g,comparative_experiment_id:y,feedbackConfig:h,session_id:p},b=JSON.stringify(w),S=`${this.apiUrl}/feedback`;return await this.caller.call(async()=>{const O=await this._fetch(S,{method:"POST",headers:{...this.headers,"Content-Type":"application/json"},signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions,body:b});return await _e(O,"create feedback",!0),O}),w}async updateFeedback(t,{score:r,value:n,correction:i,comment:a}){const s={};r!=null&&(s.score=lg(r)),n!=null&&(s.value=n),i!=null&&(s.correction=i),a!=null&&(s.comment=a),De(t);const o=JSON.stringify(s);await this.caller.call(async()=>{const c=await this._fetch(`${this.apiUrl}/feedback/${t}`,{method:"PATCH",headers:{...this.headers,"Content-Type":"application/json"},signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions,body:o});return await _e(c,"update feedback",!0),c})}async readFeedback(t){De(t);const r=`/feedback/${t}`;return await this._get(r)}async deleteFeedback(t){De(t);const r=`/feedback/${t}`;await this.caller.call(async()=>{const n=await this._fetch(this.apiUrl+r,{method:"DELETE",headers:this.headers,signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});return await _e(n,`delete ${r}`,!0),n})}async*listFeedback({runIds:t,feedbackKeys:r,feedbackSourceTypes:n}={}){const i=new URLSearchParams;if(t)for(const a of t)De(a),i.append("run",a);if(r)for(const a of r)i.append("key",a);if(n)for(const a of n)i.append("source",a);for await(const a of this._getPaginated("/feedback",i))yield*a}async createPresignedFeedbackToken(t,r,{expiration:n,feedbackConfig:i}={}){const a={run_id:t,feedback_key:r,feedback_config:i};n?typeof n=="string"?a.expires_at=n:(n?.hours||n?.minutes||n?.days)&&(a.expires_in=n):a.expires_in={hours:3};const s=JSON.stringify(a);return await(await this.caller.call(async()=>{const c=await this._fetch(`${this.apiUrl}/feedback/tokens`,{method:"POST",headers:{...this.headers,"Content-Type":"application/json"},signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions,body:s});return await _e(c,"create presigned feedback token"),c})).json()}async createComparativeExperiment({name:t,experimentIds:r,referenceDatasetId:n,createdAt:i,description:a,metadata:s,id:o}){if(r.length===0)throw new Error("At least one experiment is required");if(n||(n=(await this.readProject({projectId:r[0]})).reference_dataset_id),!n==null)throw new Error("A reference dataset is required");const c={id:o,name:t,experiment_ids:r,reference_dataset_id:n,description:a,created_at:(i??new Date)?.toISOString(),extra:{}};s&&(c.extra.metadata=s);const u=JSON.stringify(c);return(await this.caller.call(async()=>{const h=await this._fetch(`${this.apiUrl}/datasets/comparative`,{method:"POST",headers:{...this.headers,"Content-Type":"application/json"},signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions,body:u});return await _e(h,"create comparative experiment"),h})).json()}async*listPresignedFeedbackTokens(t){De(t);const r=new URLSearchParams({run_id:t});for await(const n of this._getPaginated("/feedback/tokens",r))yield*n}_selectEvalResults(t){let r;return"results"in t?r=t.results:Array.isArray(t)?r=t:r=[t],r}async _logEvaluationFeedback(t,r,n){const i=this._selectEvalResults(t),a=[];for(const s of i){let o=n||{};s.evaluatorInfo&&(o={...s.evaluatorInfo,...o});let c=null;s.targetRunId?c=s.targetRunId:r&&(c=r.id),a.push(await this.createFeedback(c,s.key,{score:s.score,value:s.value,comment:s.comment,correction:s.correction,sourceInfo:o,sourceRunId:s.sourceRunId,feedbackConfig:s.feedbackConfig,feedbackSourceType:"model"}))}return[i,a]}async logEvaluationFeedback(t,r,n){const[i]=await this._logEvaluationFeedback(t,r,n);return i}async*listAnnotationQueues(t={}){const{queueIds:r,name:n,nameContains:i,limit:a}=t,s=new URLSearchParams;r&&r.forEach((c,u)=>{De(c,`queueIds[${u}]`),s.append("ids",c)}),n&&s.append("name",n),i&&s.append("name_contains",i),s.append("limit",(a!==void 0?Math.min(a,100):100).toString());let o=0;for await(const c of this._getPaginated("/annotation-queues",s))if(yield*c,o++,a!==void 0&&o>=a)break}async createAnnotationQueue(t){const{name:r,description:n,queueId:i,rubricInstructions:a}=t,s={name:r,description:n,id:i||$a(),rubric_instructions:a},o=JSON.stringify(Object.fromEntries(Object.entries(s).filter(([u,d])=>d!==void 0)));return(await this.caller.call(async()=>{const u=await this._fetch(`${this.apiUrl}/annotation-queues`,{method:"POST",headers:{...this.headers,"Content-Type":"application/json"},signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions,body:o});return await _e(u,"create annotation queue"),u})).json()}async readAnnotationQueue(t){return(await this.caller.call(async()=>{const n=await this._fetch(`${this.apiUrl}/annotation-queues/${De(t,"queueId")}`,{method:"GET",headers:this.headers,signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});return await _e(n,"read annotation queue"),n})).json()}async updateAnnotationQueue(t,r){const{name:n,description:i,rubricInstructions:a}=r,s=JSON.stringify({name:n,description:i,rubric_instructions:a});await this.caller.call(async()=>{const o=await this._fetch(`${this.apiUrl}/annotation-queues/${De(t,"queueId")}`,{method:"PATCH",headers:{...this.headers,"Content-Type":"application/json"},signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions,body:s});return await _e(o,"update annotation queue",!0),o})}async deleteAnnotationQueue(t){await this.caller.call(async()=>{const r=await this._fetch(`${this.apiUrl}/annotation-queues/${De(t,"queueId")}`,{method:"DELETE",headers:{...this.headers,Accept:"application/json"},signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});return await _e(r,"delete annotation queue",!0),r})}async addRunsToAnnotationQueue(t,r){const n=JSON.stringify(r.map((i,a)=>De(i,`runIds[${a}]`).toString()));await this.caller.call(async()=>{const i=await this._fetch(`${this.apiUrl}/annotation-queues/${De(t,"queueId")}/runs`,{method:"POST",headers:{...this.headers,"Content-Type":"application/json"},signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions,body:n});return await _e(i,"add runs to annotation queue",!0),i})}async getRunFromAnnotationQueue(t,r){const n=`/annotation-queues/${De(t,"queueId")}/run`;return(await this.caller.call(async()=>{const a=await this._fetch(`${this.apiUrl}${n}/${r}`,{method:"GET",headers:this.headers,signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});return await _e(a,"get run from annotation queue"),a})).json()}async deleteRunFromAnnotationQueue(t,r){await this.caller.call(async()=>{const n=await this._fetch(`${this.apiUrl}/annotation-queues/${De(t,"queueId")}/runs/${De(r,"queueRunId")}`,{method:"DELETE",headers:{...this.headers,Accept:"application/json"},signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});return await _e(n,"delete run from annotation queue",!0),n})}async getSizeFromAnnotationQueue(t){return(await this.caller.call(async()=>{const n=await this._fetch(`${this.apiUrl}/annotation-queues/${De(t,"queueId")}/size`,{method:"GET",headers:this.headers,signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});return await _e(n,"get size from annotation queue"),n})).json()}async _currentTenantIsOwner(t){const r=await this._getSettings();return t=="-"||r.tenant_handle===t}async _ownerConflictError(t,r){const n=await this._getSettings();return new Error(`Cannot ${t} for another tenant.

      Current tenant: ${n.tenant_handle}

      Requested tenant: ${r}`)}async _getLatestCommitHash(t){const n=await(await this.caller.call(async()=>{const i=await this._fetch(`${this.apiUrl}/commits/${t}/?limit=1&offset=0`,{method:"GET",headers:this.headers,signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});return await _e(i,"get latest commit hash"),i})).json();if(n.commits.length!==0)return n.commits[0].commit_hash}async _likeOrUnlikePrompt(t,r){const[n,i,a]=kn(t),s=JSON.stringify({like:r});return(await this.caller.call(async()=>{const c=await this._fetch(`${this.apiUrl}/likes/${n}/${i}`,{method:"POST",headers:{...this.headers,"Content-Type":"application/json"},signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions,body:s});return await _e(c,`${r?"like":"unlike"} prompt`),c})).json()}async _getPromptUrl(t){const[r,n,i]=kn(t);if(await this._currentTenantIsOwner(r)){const a=await this._getSettings();return i!=="latest"?`${this.getHostUrl()}/prompts/${n}/${i.substring(0,8)}?organizationId=${a.id}`:`${this.getHostUrl()}/prompts/${n}?organizationId=${a.id}`}else return i!=="latest"?`${this.getHostUrl()}/hub/${r}/${n}/${i.substring(0,8)}`:`${this.getHostUrl()}/hub/${r}/${n}`}async promptExists(t){return!!await this.getPrompt(t)}async likePrompt(t){return this._likeOrUnlikePrompt(t,!0)}async unlikePrompt(t){return this._likeOrUnlikePrompt(t,!1)}async*listCommits(t){for await(const r of this._getPaginated(`/commits/${t}/`,new URLSearchParams,n=>n.commits))yield*r}async*listPrompts(t){const r=new URLSearchParams;r.append("sort_field",t?.sortField??"updated_at"),r.append("sort_direction","desc"),r.append("is_archived",(!!t?.isArchived).toString()),t?.isPublic!==void 0&&r.append("is_public",t.isPublic.toString()),t?.query&&r.append("query",t.query);for await(const n of this._getPaginated("/repos",r,i=>i.repos))yield*n}async getPrompt(t){const[r,n,i]=kn(t),s=await(await this.caller.call(async()=>{const o=await this._fetch(`${this.apiUrl}/repos/${r}/${n}`,{method:"GET",headers:this.headers,signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});return o?.status===404?null:(await _e(o,"get prompt"),o)}))?.json();return s?.repo?s.repo:null}async createPrompt(t,r){const n=await this._getSettings();if(r?.isPublic&&!n.tenant_handle)throw new Error(`Cannot create a public prompt without first

        creating a LangChain Hub handle.
        You can add a handle by creating a public prompt at:

        https://smith.langchain.com/prompts`);const[i,a,s]=kn(t);if(!await this._currentTenantIsOwner(i))throw await this._ownerConflictError("create a prompt",i);const o={repo_handle:a,...r?.description&&{description:r.description},...r?.readme&&{readme:r.readme},...r?.tags&&{tags:r.tags},is_public:!!r?.isPublic},c=JSON.stringify(o),u=await this.caller.call(async()=>{const h=await this._fetch(`${this.apiUrl}/repos/`,{method:"POST",headers:{...this.headers,"Content-Type":"application/json"},signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions,body:c});return await _e(h,"create prompt"),h}),{repo:d}=await u.json();return d}async createCommit(t,r,n){if(!await this.promptExists(t))throw new Error("Prompt does not exist, you must create it first.");const[i,a,s]=kn(t),o=n?.parentCommitHash==="latest"||!n?.parentCommitHash?await this._getLatestCommitHash(`${i}/${a}`):n?.parentCommitHash,c={manifest:JSON.parse(JSON.stringify(r)),parent_commit:o},u=JSON.stringify(c),h=await(await this.caller.call(async()=>{const p=await this._fetch(`${this.apiUrl}/commits/${i}/${a}`,{method:"POST",headers:{...this.headers,"Content-Type":"application/json"},signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions,body:u});return await _e(p,"create commit"),p})).json();return this._getPromptUrl(`${i}/${a}${h.commit_hash?`:${h.commit_hash}`:""}`)}async updateExamplesMultipart(t,r=[]){return this._updateExamplesMultipart(t,r)}async _updateExamplesMultipart(t,r=[]){if(!await this._getDatasetExamplesMultiPartSupport())throw new Error("Your LangSmith deployment does not allow using the multipart examples endpoint, please upgrade your deployment to the latest version.");const n=new FormData;for(const s of r){const o=s.id,c={...s.metadata&&{metadata:s.metadata},...s.split&&{split:s.split}},u=Xt(c,`Serializing body for example with id: ${o}`),d=new Blob([u],{type:"application/json"});if(n.append(o,d),s.inputs){const h=Xt(s.inputs,`Serializing inputs for example with id: ${o}`),p=new Blob([h],{type:"application/json"});n.append(`${o}.inputs`,p)}if(s.outputs){const h=Xt(s.outputs,`Serializing outputs whle updating example with id: ${o}`),p=new Blob([h],{type:"application/json"});n.append(`${o}.outputs`,p)}if(s.attachments)for(const[h,p]of Object.entries(s.attachments)){let y,g;Array.isArray(p)?[y,g]=p:(y=p.mimeType,g=p.data);const w=new Blob([g],{type:`${y}; length=${g.byteLength}`});n.append(`${o}.attachment.${h}`,w)}if(s.attachments_operations){const h=Xt(s.attachments_operations,`Serializing attachments while updating example with id: ${o}`),p=new Blob([h],{type:"application/json"});n.append(`${o}.attachments_operations`,p)}}const i=t??r[0]?.dataset_id;return(await this.caller.call(async()=>{const s=await this._fetch(`${this.apiUrl}${this._getPlatformEndpointPath(`datasets/${i}/examples`)}`,{method:"PATCH",headers:this.headers,signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions,body:n});return await _e(s,"update examples"),s})).json()}async uploadExamplesMultipart(t,r=[]){return this._uploadExamplesMultipart(t,r)}async _uploadExamplesMultipart(t,r=[]){if(!await this._getDatasetExamplesMultiPartSupport())throw new Error("Your LangSmith deployment does not allow using the multipart examples endpoint, please upgrade your deployment to the latest version.");const n=new FormData;for(const a of r){const s=(a.id??$a()).toString(),o={created_at:a.created_at,...a.metadata&&{metadata:a.metadata},...a.split&&{split:a.split},...a.source_run_id&&{source_run_id:a.source_run_id},...a.use_source_run_io&&{use_source_run_io:a.use_source_run_io},...a.use_source_run_attachments&&{use_source_run_attachments:a.use_source_run_attachments}},c=Xt(o,`Serializing body for uploaded example with id: ${s}`),u=new Blob([c],{type:"application/json"});if(n.append(s,u),a.inputs){const d=Xt(a.inputs,`Serializing inputs for uploaded example with id: ${s}`),h=new Blob([d],{type:"application/json"});n.append(`${s}.inputs`,h)}if(a.outputs){const d=Xt(a.outputs,`Serializing outputs for uploaded example with id: ${s}`),h=new Blob([d],{type:"application/json"});n.append(`${s}.outputs`,h)}if(a.attachments)for(const[d,h]of Object.entries(a.attachments)){let p,y;Array.isArray(h)?[p,y]=h:(p=h.mimeType,y=h.data);const g=new Blob([y],{type:`${p}; length=${y.byteLength}`});n.append(`${s}.attachment.${d}`,g)}}return(await this.caller.call(async()=>{const a=await this._fetch(`${this.apiUrl}${this._getPlatformEndpointPath(`datasets/${t}/examples`)}`,{method:"POST",headers:this.headers,signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions,body:n});return await _e(a,"upload examples"),a})).json()}async updatePrompt(t,r){if(!await this.promptExists(t))throw new Error("Prompt does not exist, you must create it first.");const[n,i]=kn(t);if(!await this._currentTenantIsOwner(n))throw await this._ownerConflictError("update a prompt",n);const a={};if(r?.description!==void 0&&(a.description=r.description),r?.readme!==void 0&&(a.readme=r.readme),r?.tags!==void 0&&(a.tags=r.tags),r?.isPublic!==void 0&&(a.is_public=r.isPublic),r?.isArchived!==void 0&&(a.is_archived=r.isArchived),Object.keys(a).length===0)throw new Error("No valid update options provided");const s=JSON.stringify(a);return(await this.caller.call(async()=>{const c=await this._fetch(`${this.apiUrl}/repos/${n}/${i}`,{method:"PATCH",headers:{...this.headers,"Content-Type":"application/json"},signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions,body:s});return await _e(c,"update prompt"),c})).json()}async deletePrompt(t){if(!await this.promptExists(t))throw new Error("Prompt does not exist, you must create it first.");const[r,n,i]=kn(t);if(!await this._currentTenantIsOwner(r))throw await this._ownerConflictError("delete a prompt",r);return(await this.caller.call(async()=>{const s=await this._fetch(`${this.apiUrl}/repos/${r}/${n}`,{method:"DELETE",headers:this.headers,signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});return await _e(s,"delete prompt"),s})).json()}async pullPromptCommit(t,r){const[n,i,a]=kn(t),o=await(await this.caller.call(async()=>{const c=await this._fetch(`${this.apiUrl}/commits/${n}/${i}/${a}${r?.includeModel?"?include_model=true":""}`,{method:"GET",headers:this.headers,signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});return await _e(c,"pull prompt commit"),c})).json();return{owner:n,repo:i,commit_hash:o.commit_hash,manifest:o.manifest,examples:o.examples}}async _pullPrompt(t,r){const n=await this.pullPromptCommit(t,{includeModel:r?.includeModel});return JSON.stringify(n.manifest)}async pushPrompt(t,r){return await this.promptExists(t)?r&&Object.keys(r).some(i=>i!=="object")&&await this.updatePrompt(t,{description:r?.description,readme:r?.readme,tags:r?.tags,isPublic:r?.isPublic}):await this.createPrompt(t,{description:r?.description,readme:r?.readme,tags:r?.tags,isPublic:r?.isPublic}),r?.object?await this.createCommit(t,r?.object,{parentCommitHash:r?.parentCommitHash}):await this._getPromptUrl(t)}async clonePublicDataset(t,r={}){const{sourceApiUrl:n=this.apiUrl,datasetName:i}=r,[a,s]=this.parseTokenOrUrl(t,n),o=new ps({apiUrl:a,apiKey:"placeholder"}),c=await o.readSharedDataset(s),u=i||c.name;try{if(await this.hasDataset({datasetId:u})){console.log(`Dataset ${u} already exists in your tenant. Skipping.`);return}}catch{}const d=await o.listSharedExamples(s),h=await this.createDataset(u,{description:c.description,dataType:c.data_type||"kv",inputsSchema:c.inputs_schema_definition??void 0,outputsSchema:c.outputs_schema_definition??void 0});try{await this.createExamples({inputs:d.map(p=>p.inputs),outputs:d.flatMap(p=>p.outputs?[p.outputs]:[]),datasetId:h.id})}catch(p){throw console.error(`An error occurred while creating dataset ${u}. You should delete it manually.`),p}}parseTokenOrUrl(t,r,n=2,i="dataset"){try{return De(t),[r,t]}catch{}try{const s=new URL(t).pathname.split("/").filter(o=>o!=="");if(s.length>=n){const o=s[s.length-n];return[r,o]}else throw new Error(`Invalid public ${i} URL: ${t}`)}catch{throw new Error(`Invalid public ${i} URL or token: ${t}`)}}async awaitPendingTraceBatches(){if(this.manualFlushMode)return console.warn("[WARNING]: When tracing in manual flush mode, you must call `await client.flush()` manually to submit trace batches."),Promise.resolve();await Promise.all([...this.autoBatchQueue.items.map(({itemPromise:t})=>t),this.batchIngestCaller.queue.onIdle()]),this.langSmithToOTELTranslator!==void 0&&await nA()?.DEFAULT_LANGSMITH_SPAN_PROCESSOR?.forceFlush()}}function fg(e){return"dataset_id"in e||"dataset_name"in e}const c$=e=>!!["TRACING_V2","TRACING"].find(r=>Kt(r)==="true"),Hl=Symbol.for("lc:context_variables");function u$(e){return e.replace(/[-:.]/g,"")}function Q_(e,t=1){const r=t.toFixed(0).slice(0,3).padStart(3,"0");return`${new Date(e).toISOString().slice(0,-1)}${r}Z`}function Y_(e,t,r=1){const n=Q_(e,r);return{dottedOrder:u$(n)+t,microsecondPrecisionDatestring:n}}class ac{constructor(t,r,n,i){Object.defineProperty(this,"metadata",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"tags",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"project_name",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"replicas",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.metadata=t,this.tags=r,this.project_name=n,this.replicas=i}static fromHeader(t){const r=t.split(",");let n={},i=[],a,s;for(const o of r){const[c,u]=o.split("="),d=decodeURIComponent(u);c==="langsmith-metadata"?n=JSON.parse(d):c==="langsmith-tags"?i=d.split(","):c==="langsmith-project"?a=d:c==="langsmith-replicas"&&(s=JSON.parse(d))}return new ac(n,i,a,s)}toHeader(){const t=[];return this.metadata&&Object.keys(this.metadata).length>0&&t.push(`langsmith-metadata=${encodeURIComponent(JSON.stringify(this.metadata))}`),this.tags&&this.tags.length>0&&t.push(`langsmith-tags=${encodeURIComponent(this.tags.join(","))}`),this.project_name&&t.push(`langsmith-project=${encodeURIComponent(this.project_name)}`),t.join(",")}}class Ht{constructor(t){if(Object.defineProperty(this,"id",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"name",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"run_type",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"project_name",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"parent_run",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"parent_run_id",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"child_runs",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"start_time",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"end_time",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"extra",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"tags",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"error",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"serialized",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"inputs",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"outputs",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"reference_example_id",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"client",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"events",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"trace_id",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"dotted_order",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"tracingEnabled",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"execution_order",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"child_execution_order",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"attachments",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"replicas",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"_serialized_start_time",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),l$(t)){Object.assign(this,{...t});return}const r=Ht.getDefaultConfig(),{metadata:n,...i}=t,a=i.client??Ht.getSharedClient(),s={...n,...i?.extra?.metadata};if(i.extra={...i.extra,metadata:s},"id"in i&&i.id==null&&delete i.id,Object.assign(this,{...r,...i,client:a}),this.execution_order??=1,this.child_execution_order??=1,this.dotted_order||(this._serialized_start_time=Q_(this.start_time,this.execution_order)),this.id||(this.id=qR(this._serialized_start_time??this.start_time)),this.trace_id||(this.parent_run?this.trace_id=this.parent_run.trace_id??this.id:this.trace_id=this.id),this.replicas=p$(this.replicas),!this.dotted_order){const{dottedOrder:o}=Y_(this.start_time,this.id,this.execution_order);this.parent_run?this.dotted_order=this.parent_run.dotted_order+"."+o:this.dotted_order=o}}set metadata(t){this.extra={...this.extra,metadata:{...this.extra?.metadata,...t}}}get metadata(){return this.extra?.metadata}static getDefaultConfig(){const t=Date.now();return{run_type:"chain",project_name:M_(),child_runs:[],api_url:Kr("LANGCHAIN_ENDPOINT")??"http://localhost:1984",api_key:Kr("LANGCHAIN_API_KEY"),caller_options:{},start_time:t,serialized:{},inputs:{},extra:{}}}static getSharedClient(){return Ht.sharedClient||(Ht.sharedClient=new ps),Ht.sharedClient}createChild(t){const r=this.child_execution_order+1,n=new Ht({...t,parent_run:this,project_name:this.project_name,replicas:this.replicas,client:this.client,tracingEnabled:this.tracingEnabled,execution_order:r,child_execution_order:r});Hl in this&&(n[Hl]=this[Hl]);const i=Symbol.for("lc:child_config"),a=t.extra?.[i]??this.extra[i];if(f$(a)){const c={...a},u=d$(c.callbacks)?c.callbacks.copy?.():void 0;u&&(Object.assign(u,{_parentRunId:n.id}),u.handlers?.find(X_)?.updateFromRunTree?.(n),c.callbacks=u),n.extra[i]=c}const s=new Set;let o=this;for(;o!=null&&!s.has(o.id);)s.add(o.id),o.child_execution_order=Math.max(o.child_execution_order,r),o=o.parent_run;return this.child_runs.push(n),n}async end(t,r,n=Date.now(),i){this.outputs=this.outputs??t,this.error=this.error??r,this.end_time=this.end_time??n,i&&Object.keys(i).length>0&&(this.extra=this.extra?{...this.extra,metadata:{...this.extra.metadata,...i}}:{metadata:i})}_convertToCreate(t,r,n=!0){const i=t.extra??{};if(i?.runtime?.library===void 0&&(i.runtime||(i.runtime={}),r))for(const[o,c]of Object.entries(r))i.runtime[o]||(i.runtime[o]=c);let a,s;return n?(s=t.parent_run?.id??t.parent_run_id,a=[]):(a=t.child_runs.map(o=>this._convertToCreate(o,r,n)),s=void 0),{id:t.id,name:t.name,start_time:t._serialized_start_time??t.start_time,end_time:t.end_time,run_type:t.run_type,reference_example_id:t.reference_example_id,extra:i,serialized:t.serialized,error:t.error,inputs:t.inputs,outputs:t.outputs,session_name:t.project_name,child_runs:a,parent_run_id:s,trace_id:t.trace_id,dotted_order:t.dotted_order,tags:t.tags,attachments:t.attachments,events:t.events}}_remapForProject(t,r,n=!0){return{...this._convertToCreate(this,r,n),session_name:t}}async postRun(t=!0){try{const r=B_();if(this.replicas&&this.replicas.length>0)for(const{projectName:n,apiKey:i,apiUrl:a,workspaceId:s}of this.replicas){const o=this._remapForProject(n??this.project_name,r,!0);await this.client.createRun(o,{apiKey:i,apiUrl:a,workspaceId:s})}else{const n=this._convertToCreate(this,r,t);await this.client.createRun(n)}if(!t){Od("Posting with excludeChildRuns=false is deprecated and will be removed in a future version.");for(const n of this.child_runs)await n.postRun(!1)}}catch(r){console.error(`Error in postRun for run ${this.id}:`,r)}}async patchRun(t){if(this.replicas&&this.replicas.length>0)for(const{projectName:r,apiKey:n,apiUrl:i,workspaceId:a,updates:s}of this.replicas){const o=this._remapForProject(r??this.project_name),c={id:o.id,name:o.name,run_type:o.run_type,start_time:o.start_time,outputs:o.outputs,error:o.error,parent_run_id:o.parent_run_id,session_name:o.session_name,reference_example_id:o.reference_example_id,end_time:o.end_time,dotted_order:o.dotted_order,trace_id:o.trace_id,events:o.events,tags:o.tags,extra:o.extra,attachments:this.attachments,...s};t?.excludeInputs||(c.inputs=o.inputs),await this.client.updateRun(o.id,c,{apiKey:n,apiUrl:i,workspaceId:a})}else try{const r={name:this.name,run_type:this.run_type,start_time:this._serialized_start_time??this.start_time,end_time:this.end_time,error:this.error,outputs:this.outputs,parent_run_id:this.parent_run?.id??this.parent_run_id,reference_example_id:this.reference_example_id,extra:this.extra,events:this.events,dotted_order:this.dotted_order,trace_id:this.trace_id,tags:this.tags,attachments:this.attachments,session_name:this.project_name};t?.excludeInputs||(r.inputs=this.inputs),await this.client.updateRun(this.id,r)}catch(r){console.error(`Error in patchRun for run ${this.id}`,r)}}toJSON(){return this._convertToCreate(this,void 0,!1)}addEvent(t){this.events||(this.events=[]),typeof t=="string"?this.events.push({name:"event",time:new Date().toISOString(),message:t}):this.events.push({...t,time:t.time??new Date().toISOString()})}static fromRunnableConfig(t,r){const n=t?.callbacks;let i,a,s,o=c$();if(n){const u=n?.getParentRunId?.()??"",d=n?.handlers?.find(h=>h?.name=="langchain_tracer");i=d?.getRun?.(u),a=d?.projectName,s=d?.client,o=o||!!d}return i?new Ht({name:i.name,id:i.id,trace_id:i.trace_id,dotted_order:i.dotted_order,client:s,tracingEnabled:o,project_name:a,tags:[...new Set((i?.tags??[]).concat(t?.tags??[]))],extra:{metadata:{...i?.extra?.metadata,...t?.metadata}}}).createChild(r):new Ht({...r,client:s,tracingEnabled:o,project_name:a})}static fromDottedOrder(t){return this.fromHeaders({"langsmith-trace":t})}static fromHeaders(t,r){const n="get"in t&&typeof t.get=="function"?{"langsmith-trace":t.get("langsmith-trace"),baggage:t.get("baggage")}:t,i=n["langsmith-trace"];if(!i||typeof i!="string")return;const a=i.trim(),s=a.split(".").map(u=>{const[d,h]=u.split("Z");return{strTime:d,time:Date.parse(d+"Z"),uuid:h}}),o=s[0].uuid,c={...r,name:r?.name??"parent",run_type:r?.run_type??"chain",start_time:r?.start_time??Date.now(),id:s.at(-1)?.uuid,trace_id:o,dotted_order:a};if(n.baggage&&typeof n.baggage=="string"){const u=ac.fromHeader(n.baggage);c.metadata=u.metadata,c.tags=u.tags,c.project_name=u.project_name,c.replicas=u.replicas}return new Ht(c)}toHeaders(t){const r={"langsmith-trace":this.dotted_order,baggage:new ac(this.extra?.metadata,this.tags,this.project_name,this.replicas).toHeader()};if(t)for(const[n,i]of Object.entries(r))t.set(n,i);return r}}Object.defineProperty(Ht,"sharedClient",{enumerable:!0,configurable:!0,writable:!0,value:null});function l$(e){return e!=null&&typeof e.createChild=="function"&&typeof e.postRun=="function"}function X_(e){return typeof e=="object"&&e!=null&&typeof e.name=="string"&&e.name==="langchain_tracer"}function hg(e){return Array.isArray(e)&&e.some(t=>X_(t))}function d$(e){return typeof e=="object"&&e!=null&&Array.isArray(e.handlers)}function f$(e){return e!=null&&typeof e.callbacks=="object"&&(hg(e.callbacks?.handlers)||hg(e.callbacks))}function h$(){const e=Kr("LANGSMITH_RUNS_ENDPOINTS");if(!e)return[];try{const t=JSON.parse(e);if(Array.isArray(t)){const r=[];for(const n of t){if(typeof n!="object"||n===null){console.warn(`Invalid item type in LANGSMITH_RUNS_ENDPOINTS: expected object, got ${typeof n}`);continue}if(typeof n.api_url!="string"){console.warn(`Invalid api_url type in LANGSMITH_RUNS_ENDPOINTS: expected string, got ${typeof n.api_url}`);continue}if(typeof n.api_key!="string"){console.warn(`Invalid api_key type in LANGSMITH_RUNS_ENDPOINTS: expected string, got ${typeof n.api_key}`);continue}r.push({apiUrl:n.api_url.replace(/\/$/,""),apiKey:n.api_key})}return r}else if(typeof t=="object"&&t!==null){m$(t);const r=[];for(const[n,i]of Object.entries(t)){const a=n.replace(/\/$/,"");if(typeof i=="string")r.push({apiUrl:a,apiKey:i});else{console.warn(`Invalid value type in LANGSMITH_RUNS_ENDPOINTS for URL ${n}: expected string, got ${typeof i}`);continue}}return r}else return console.warn(`Invalid LANGSMITH_RUNS_ENDPOINTS  must be valid JSON array of objects with api_url and api_key properties, or object mapping url->apiKey, got ${typeof t}`),[]}catch(t){if(VA(t))throw t;return console.warn("Invalid LANGSMITH_RUNS_ENDPOINTS  must be valid JSON array of objects with api_url and api_key properties, or object mapping url->apiKey"),[]}}function p$(e){return e?e.map(t=>Array.isArray(t)?{projectName:t[0],updates:t[1]}:t):h$()}function m$(e){if(Object.keys(e).length>0&&Kt("ENDPOINT"))throw new WA}var g$={};bt(g$,{BaseTracer:()=>_a,isBaseTracer:()=>qi});const y$=e=>{if(e)return e.events=e.events??[],e.child_runs=e.child_runs??[],e};function Ad(e,t){if(e)return new Ht({...e,start_time:e._serialized_start_time??e.start_time,parent_run:Ad(t),child_runs:e.child_runs.map(r=>Ad(r)).filter(r=>r!==void 0),extra:{...e.extra,runtime:$_()},tracingEnabled:!1})}function Kl(e,t){return e&&!Array.isArray(e)&&typeof e=="object"?e:{[t]:e}}function qi(e){return typeof e._addRunToRunMap=="function"}var _a=class extends Ms{runMap=new Map;runTreeMap=new Map;usesRunTreeMap=!1;constructor(e){super(...arguments)}copy(){return this}getRunById(e){if(e!==void 0)return this.usesRunTreeMap?y$(this.runTreeMap.get(e)):this.runMap.get(e)}stringifyError(e){return e instanceof Error?e.message+(e?.stack?`

${e.stack}`:""):typeof e=="string"?e:`${e}`}_addChildRun(e,t){e.child_runs.push(t)}_addRunToRunMap(e){const{dottedOrder:t,microsecondPrecisionDatestring:r}=Y_(new Date(e.start_time).getTime(),e.id,e.execution_order),n={...e},i=this.getRunById(n.parent_run_id);if(n.parent_run_id!==void 0?i&&(this._addChildRun(i,n),i.child_execution_order=Math.max(i.child_execution_order,n.child_execution_order),n.trace_id=i.trace_id,i.dotted_order!==void 0&&(n.dotted_order=[i.dotted_order,t].join("."),n._serialized_start_time=r)):(n.trace_id=n.id,n.dotted_order=t,n._serialized_start_time=r),this.usesRunTreeMap){const a=Ad(n,i);a!==void 0&&this.runTreeMap.set(n.id,a)}else this.runMap.set(n.id,n);return n}async _endTrace(e){const t=e.parent_run_id!==void 0&&this.getRunById(e.parent_run_id);t?t.child_execution_order=Math.max(t.child_execution_order,e.child_execution_order):await this.persistRun(e),await this.onRunUpdate?.(e),this.usesRunTreeMap?this.runTreeMap.delete(e.id):this.runMap.delete(e.id)}_getExecutionOrder(e){const t=e!==void 0&&this.getRunById(e);return t?t.child_execution_order+1:1}_createRunForLLMStart(e,t,r,n,i,a,s,o){const c=this._getExecutionOrder(n),u=Date.now(),d=s?{...i,metadata:s}:i,h={id:r,name:o??e.id[e.id.length-1],parent_run_id:n,start_time:u,serialized:e,events:[{name:"start",time:new Date(u).toISOString()}],inputs:{prompts:t},execution_order:c,child_runs:[],child_execution_order:c,run_type:"llm",extra:d??{},tags:a||[]};return this._addRunToRunMap(h)}async handleLLMStart(e,t,r,n,i,a,s,o){const c=this.getRunById(r)??this._createRunForLLMStart(e,t,r,n,i,a,s,o);return await this.onRunCreate?.(c),await this.onLLMStart?.(c),c}_createRunForChatModelStart(e,t,r,n,i,a,s,o){const c=this._getExecutionOrder(n),u=Date.now(),d=s?{...i,metadata:s}:i,h={id:r,name:o??e.id[e.id.length-1],parent_run_id:n,start_time:u,serialized:e,events:[{name:"start",time:new Date(u).toISOString()}],inputs:{messages:t},execution_order:c,child_runs:[],child_execution_order:c,run_type:"llm",extra:d??{},tags:a||[]};return this._addRunToRunMap(h)}async handleChatModelStart(e,t,r,n,i,a,s,o){const c=this.getRunById(r)??this._createRunForChatModelStart(e,t,r,n,i,a,s,o);return await this.onRunCreate?.(c),await this.onLLMStart?.(c),c}async handleLLMEnd(e,t,r,n,i){const a=this.getRunById(t);if(!a||a?.run_type!=="llm")throw new Error("No LLM run to end.");return a.end_time=Date.now(),a.outputs=e,a.events.push({name:"end",time:new Date(a.end_time).toISOString()}),a.extra={...a.extra,...i},await this.onLLMEnd?.(a),await this._endTrace(a),a}async handleLLMError(e,t,r,n,i){const a=this.getRunById(t);if(!a||a?.run_type!=="llm")throw new Error("No LLM run to end.");return a.end_time=Date.now(),a.error=this.stringifyError(e),a.events.push({name:"error",time:new Date(a.end_time).toISOString()}),a.extra={...a.extra,...i},await this.onLLMError?.(a),await this._endTrace(a),a}_createRunForChainStart(e,t,r,n,i,a,s,o){const c=this._getExecutionOrder(n),u=Date.now(),d={id:r,name:o??e.id[e.id.length-1],parent_run_id:n,start_time:u,serialized:e,events:[{name:"start",time:new Date(u).toISOString()}],inputs:t,execution_order:c,child_execution_order:c,run_type:s??"chain",child_runs:[],extra:a?{metadata:a}:{},tags:i||[]};return this._addRunToRunMap(d)}async handleChainStart(e,t,r,n,i,a,s,o){const c=this.getRunById(r)??this._createRunForChainStart(e,t,r,n,i,a,s,o);return await this.onRunCreate?.(c),await this.onChainStart?.(c),c}async handleChainEnd(e,t,r,n,i){const a=this.getRunById(t);if(!a)throw new Error("No chain run to end.");return a.end_time=Date.now(),a.outputs=Kl(e,"output"),a.events.push({name:"end",time:new Date(a.end_time).toISOString()}),i?.inputs!==void 0&&(a.inputs=Kl(i.inputs,"input")),await this.onChainEnd?.(a),await this._endTrace(a),a}async handleChainError(e,t,r,n,i){const a=this.getRunById(t);if(!a)throw new Error("No chain run to end.");return a.end_time=Date.now(),a.error=this.stringifyError(e),a.events.push({name:"error",time:new Date(a.end_time).toISOString()}),i?.inputs!==void 0&&(a.inputs=Kl(i.inputs,"input")),await this.onChainError?.(a),await this._endTrace(a),a}_createRunForToolStart(e,t,r,n,i,a,s){const o=this._getExecutionOrder(n),c=Date.now(),u={id:r,name:s??e.id[e.id.length-1],parent_run_id:n,start_time:c,serialized:e,events:[{name:"start",time:new Date(c).toISOString()}],inputs:{input:t},execution_order:o,child_execution_order:o,run_type:"tool",child_runs:[],extra:a?{metadata:a}:{},tags:i||[]};return this._addRunToRunMap(u)}async handleToolStart(e,t,r,n,i,a,s){const o=this.getRunById(r)??this._createRunForToolStart(e,t,r,n,i,a,s);return await this.onRunCreate?.(o),await this.onToolStart?.(o),o}async handleToolEnd(e,t){const r=this.getRunById(t);if(!r||r?.run_type!=="tool")throw new Error("No tool run to end");return r.end_time=Date.now(),r.outputs={output:e},r.events.push({name:"end",time:new Date(r.end_time).toISOString()}),await this.onToolEnd?.(r),await this._endTrace(r),r}async handleToolError(e,t){const r=this.getRunById(t);if(!r||r?.run_type!=="tool")throw new Error("No tool run to end");return r.end_time=Date.now(),r.error=this.stringifyError(e),r.events.push({name:"error",time:new Date(r.end_time).toISOString()}),await this.onToolError?.(r),await this._endTrace(r),r}async handleAgentAction(e,t){const r=this.getRunById(t);if(!r||r?.run_type!=="chain")return;const n=r;n.actions=n.actions||[],n.actions.push(e),n.events.push({name:"agent_action",time:new Date().toISOString(),kwargs:{action:e}}),await this.onAgentAction?.(r)}async handleAgentEnd(e,t){const r=this.getRunById(t);!r||r?.run_type!=="chain"||(r.events.push({name:"agent_end",time:new Date().toISOString(),kwargs:{action:e}}),await this.onAgentEnd?.(r))}_createRunForRetrieverStart(e,t,r,n,i,a,s){const o=this._getExecutionOrder(n),c=Date.now(),u={id:r,name:s??e.id[e.id.length-1],parent_run_id:n,start_time:c,serialized:e,events:[{name:"start",time:new Date(c).toISOString()}],inputs:{query:t},execution_order:o,child_execution_order:o,run_type:"retriever",child_runs:[],extra:a?{metadata:a}:{},tags:i||[]};return this._addRunToRunMap(u)}async handleRetrieverStart(e,t,r,n,i,a,s){const o=this.getRunById(r)??this._createRunForRetrieverStart(e,t,r,n,i,a,s);return await this.onRunCreate?.(o),await this.onRetrieverStart?.(o),o}async handleRetrieverEnd(e,t){const r=this.getRunById(t);if(!r||r?.run_type!=="retriever")throw new Error("No retriever run to end");return r.end_time=Date.now(),r.outputs={documents:e},r.events.push({name:"end",time:new Date(r.end_time).toISOString()}),await this.onRetrieverEnd?.(r),await this._endTrace(r),r}async handleRetrieverError(e,t){const r=this.getRunById(t);if(!r||r?.run_type!=="retriever")throw new Error("No retriever run to end");return r.end_time=Date.now(),r.error=this.stringifyError(e),r.events.push({name:"error",time:new Date(r.end_time).toISOString()}),await this.onRetrieverError?.(r),await this._endTrace(r),r}async handleText(e,t){const r=this.getRunById(t);!r||r?.run_type!=="chain"||(r.events.push({name:"text",time:new Date().toISOString(),kwargs:{text:e}}),await this.onText?.(r))}async handleLLMNewToken(e,t,r,n,i,a){const s=this.getRunById(r);if(!s||s?.run_type!=="llm")throw new Error('Invalid "runId" provided to "handleLLMNewToken" callback.');return s.events.push({name:"new_token",time:new Date().toISOString(),kwargs:{token:e,idx:t,chunk:a?.chunk}}),await this.onLLMNewToken?.(s,e,{chunk:a?.chunk}),s}},Bo={exports:{}};Bo.exports;var pg;function v$(){return pg||(pg=1,(function(e){const r=(a=0)=>s=>`\x1B[${38+a};5;${s}m`,n=(a=0)=>(s,o,c)=>`\x1B[${38+a};2;${s};${o};${c}m`;function i(){const a=new Map,s={modifier:{reset:[0,0],bold:[1,22],dim:[2,22],italic:[3,23],underline:[4,24],overline:[53,55],inverse:[7,27],hidden:[8,28],strikethrough:[9,29]},color:{black:[30,39],red:[31,39],green:[32,39],yellow:[33,39],blue:[34,39],magenta:[35,39],cyan:[36,39],white:[37,39],blackBright:[90,39],redBright:[91,39],greenBright:[92,39],yellowBright:[93,39],blueBright:[94,39],magentaBright:[95,39],cyanBright:[96,39],whiteBright:[97,39]},bgColor:{bgBlack:[40,49],bgRed:[41,49],bgGreen:[42,49],bgYellow:[43,49],bgBlue:[44,49],bgMagenta:[45,49],bgCyan:[46,49],bgWhite:[47,49],bgBlackBright:[100,49],bgRedBright:[101,49],bgGreenBright:[102,49],bgYellowBright:[103,49],bgBlueBright:[104,49],bgMagentaBright:[105,49],bgCyanBright:[106,49],bgWhiteBright:[107,49]}};s.color.gray=s.color.blackBright,s.bgColor.bgGray=s.bgColor.bgBlackBright,s.color.grey=s.color.blackBright,s.bgColor.bgGrey=s.bgColor.bgBlackBright;for(const[o,c]of Object.entries(s)){for(const[u,d]of Object.entries(c))s[u]={open:`\x1B[${d[0]}m`,close:`\x1B[${d[1]}m`},c[u]=s[u],a.set(d[0],d[1]);Object.defineProperty(s,o,{value:c,enumerable:!1})}return Object.defineProperty(s,"codes",{value:a,enumerable:!1}),s.color.close="\x1B[39m",s.bgColor.close="\x1B[49m",s.color.ansi256=r(),s.color.ansi16m=n(),s.bgColor.ansi256=r(10),s.bgColor.ansi16m=n(10),Object.defineProperties(s,{rgbToAnsi256:{value:(o,c,u)=>o===c&&c===u?o<8?16:o>248?231:Math.round((o-8)/247*24)+232:16+36*Math.round(o/255*5)+6*Math.round(c/255*5)+Math.round(u/255*5),enumerable:!1},hexToRgb:{value:o=>{const c=/(?<colorString>[a-f\d]{6}|[a-f\d]{3})/i.exec(o.toString(16));if(!c)return[0,0,0];let{colorString:u}=c.groups;u.length===3&&(u=u.split("").map(h=>h+h).join(""));const d=Number.parseInt(u,16);return[d>>16&255,d>>8&255,d&255]},enumerable:!1},hexToAnsi256:{value:o=>s.rgbToAnsi256(...s.hexToRgb(o)),enumerable:!1}}),s}Object.defineProperty(e,"exports",{enumerable:!0,get:i})})(Bo)),Bo.exports}var _$=v$();const ew=fa(_$);var w$={};bt(w$,{ConsoleCallbackHandler:()=>$d});function Lt(e,t){return`${e.open}${t}${e.close}`}function mr(e,t){try{return JSON.stringify(e,null,2)}catch{return t}}function mg(e){return typeof e=="string"?e.trim():e==null?e:mr(e,e.toString())}function In(e){if(!e.end_time)return"";const t=e.end_time-e.start_time;return t<1e3?`${t}ms`:`${(t/1e3).toFixed(2)}s`}const{color:qt}=ew;var $d=class extends _a{name="console_callback_handler";persistRun(e){return Promise.resolve()}getParents(e){const t=[];let r=e;for(;r.parent_run_id;){const n=this.runMap.get(r.parent_run_id);if(n)t.push(n),r=n;else break}return t}getBreadcrumbs(e){const r=[...this.getParents(e).reverse(),e].map((n,i,a)=>{const s=`${n.execution_order}:${n.run_type}:${n.name}`;return i===a.length-1?Lt(ew.bold,s):s}).join(" > ");return Lt(qt.grey,r)}onChainStart(e){const t=this.getBreadcrumbs(e);console.log(`${Lt(qt.green,"[chain/start]")} [${t}] Entering Chain run with input: ${mr(e.inputs,"[inputs]")}`)}onChainEnd(e){const t=this.getBreadcrumbs(e);console.log(`${Lt(qt.cyan,"[chain/end]")} [${t}] [${In(e)}] Exiting Chain run with output: ${mr(e.outputs,"[outputs]")}`)}onChainError(e){const t=this.getBreadcrumbs(e);console.log(`${Lt(qt.red,"[chain/error]")} [${t}] [${In(e)}] Chain run errored with error: ${mr(e.error,"[error]")}`)}onLLMStart(e){const t=this.getBreadcrumbs(e),r="prompts"in e.inputs?{prompts:e.inputs.prompts.map(n=>n.trim())}:e.inputs;console.log(`${Lt(qt.green,"[llm/start]")} [${t}] Entering LLM run with input: ${mr(r,"[inputs]")}`)}onLLMEnd(e){const t=this.getBreadcrumbs(e);console.log(`${Lt(qt.cyan,"[llm/end]")} [${t}] [${In(e)}] Exiting LLM run with output: ${mr(e.outputs,"[response]")}`)}onLLMError(e){const t=this.getBreadcrumbs(e);console.log(`${Lt(qt.red,"[llm/error]")} [${t}] [${In(e)}] LLM run errored with error: ${mr(e.error,"[error]")}`)}onToolStart(e){const t=this.getBreadcrumbs(e);console.log(`${Lt(qt.green,"[tool/start]")} [${t}] Entering Tool run with input: "${mg(e.inputs.input)}"`)}onToolEnd(e){const t=this.getBreadcrumbs(e);console.log(`${Lt(qt.cyan,"[tool/end]")} [${t}] [${In(e)}] Exiting Tool run with output: "${mg(e.outputs?.output)}"`)}onToolError(e){const t=this.getBreadcrumbs(e);console.log(`${Lt(qt.red,"[tool/error]")} [${t}] [${In(e)}] Tool run errored with error: ${mr(e.error,"[error]")}`)}onRetrieverStart(e){const t=this.getBreadcrumbs(e);console.log(`${Lt(qt.green,"[retriever/start]")} [${t}] Entering Retriever run with input: ${mr(e.inputs,"[inputs]")}`)}onRetrieverEnd(e){const t=this.getBreadcrumbs(e);console.log(`${Lt(qt.cyan,"[retriever/end]")} [${t}] [${In(e)}] Exiting Retriever run with output: ${mr(e.outputs,"[outputs]")}`)}onRetrieverError(e){const t=this.getBreadcrumbs(e);console.log(`${Lt(qt.red,"[retriever/error]")} [${t}] [${In(e)}] Retriever run errored with error: ${mr(e.error,"[error]")}`)}onAgentAction(e){const t=e,r=this.getBreadcrumbs(e);console.log(`${Lt(qt.blue,"[agent/action]")} [${r}] Agent selected action: ${mr(t.actions[t.actions.length-1],"[action]")}`)}};let Gl;const tw=()=>{if(Gl===void 0){const e=fi("LANGCHAIN_CALLBACKS_BACKGROUND")==="false"?{blockOnRootRunFinalization:!0}:{};Gl=new ps(e)}return Gl};let b$=class{getStore(){}run(t,r){return r()}};const Wl=Symbol.for("ls:tracing_async_local_storage"),E$=new b$;let x$=class{getInstance(){return globalThis[Wl]??E$}initializeGlobalInstance(t){globalThis[Wl]===void 0&&(globalThis[Wl]=t)}};const S$=new x$;function k$(e=!1){const t=S$.getInstance().getStore();if(!e&&t===void 0)throw new Error(`Could not get the current run tree.

Please make sure you are calling this method within a traceable function and that tracing is enabled.`);return t}function zf(e){return typeof e=="function"&&"langsmith:traceable"in e}var I$={};bt(I$,{LangChainTracer:()=>zo});var zo=class rw extends _a{name="langchain_tracer";projectName;exampleId;client;replicas;usesRunTreeMap=!0;constructor(t={}){super(t);const{exampleId:r,projectName:n,client:i,replicas:a}=t;this.projectName=n??M_(),this.replicas=a,this.exampleId=r,this.client=i??tw();const s=rw.getTraceableRunTree();s&&this.updateFromRunTree(s)}async persistRun(t){}async onRunCreate(t){await this.getRunTreeWithTracingConfig(t.id)?.postRun()}async onRunUpdate(t){await this.getRunTreeWithTracingConfig(t.id)?.patchRun()}getRun(t){return this.runTreeMap.get(t)}updateFromRunTree(t){this.runTreeMap.set(t.id,t);let r=t;const n=new Set;for(;r.parent_run&&!(n.has(r.id)||(n.add(r.id),!r.parent_run));)r=r.parent_run;n.clear();const i=[r];for(;i.length>0;){const a=i.shift();!a||n.has(a.id)||(n.add(a.id),this.runTreeMap.set(a.id,a),a.child_runs&&i.push(...a.child_runs))}this.client=t.client??this.client,this.replicas=t.replicas??this.replicas,this.projectName=t.project_name??this.projectName,this.exampleId=t.reference_example_id??this.exampleId}getRunTreeWithTracingConfig(t){const r=this.runTreeMap.get(t);if(r)return new Ht({...r,client:this.client,project_name:this.projectName,replicas:this.replicas,reference_example_id:this.exampleId,tracingEnabled:!0})}static getTraceableRunTree(){try{return k$(!0)}catch{return}}};let hi;function O$(){const e="default"in nn?nn.default:nn;return new e({autoStart:!0,concurrency:1})}function T$(){return typeof hi>"u"&&(hi=O$()),hi}async function mt(e,t){if(t===!0){const r=ds();r!==void 0?await r.run(void 0,async()=>e()):await e()}else hi=T$(),hi.add(async()=>{const r=ds();r!==void 0?await r.run(void 0,async()=>e()):await e()})}async function R$(){const e=tw();await Promise.allSettled([typeof hi<"u"?hi.onIdle():Promise.resolve(),e.awaitPendingTraceBatches()])}var A$={};bt(A$,{awaitAllCallbacks:()=>R$,consumeCallback:()=>mt});const $$=e=>!!["LANGSMITH_TRACING_V2","LANGCHAIN_TRACING_V2","LANGSMITH_TRACING","LANGCHAIN_TRACING"].find(r=>fi(r)==="true");function nw(e){const t=ds();return t===void 0?void 0:t.getStore()?.[Ya]?.[e]}const C$=Symbol("lc:configure_hooks"),P$=()=>nw(C$)||[];var N$={};bt(N$,{BaseCallbackManager:()=>iw,BaseRunManager:()=>js,CallbackManager:()=>Ti,CallbackManagerForChainRun:()=>sw,CallbackManagerForLLMRun:()=>Cd,CallbackManagerForRetrieverRun:()=>aw,CallbackManagerForToolRun:()=>ow,ensureHandler:()=>ms,parseCallbackConfigArg:()=>D$});function D$(e){return e?Array.isArray(e)||"name"in e?{callbacks:e}:e:{}}var iw=class{setHandler(e){return this.setHandlers([e])}},js=class{constructor(e,t,r,n,i,a,s,o){this.runId=e,this.handlers=t,this.inheritableHandlers=r,this.tags=n,this.inheritableTags=i,this.metadata=a,this.inheritableMetadata=s,this._parentRunId=o}get parentRunId(){return this._parentRunId}async handleText(e){await Promise.all(this.handlers.map(t=>mt(async()=>{try{await t.handleText?.(e,this.runId,this._parentRunId,this.tags)}catch(r){if((t.raiseError?console.error:console.warn)(`Error in handler ${t.constructor.name}, handleText: ${r}`),t.raiseError)throw r}},t.awaitHandlers)))}async handleCustomEvent(e,t,r,n,i){await Promise.all(this.handlers.map(a=>mt(async()=>{try{await a.handleCustomEvent?.(e,t,this.runId,this.tags,this.metadata)}catch(s){if((a.raiseError?console.error:console.warn)(`Error in handler ${a.constructor.name}, handleCustomEvent: ${s}`),a.raiseError)throw s}},a.awaitHandlers)))}},aw=class extends js{getChild(e){const t=new Ti(this.runId);return t.setHandlers(this.inheritableHandlers),t.addTags(this.inheritableTags),t.addMetadata(this.inheritableMetadata),e&&t.addTags([e],!1),t}async handleRetrieverEnd(e){await Promise.all(this.handlers.map(t=>mt(async()=>{if(!t.ignoreRetriever)try{await t.handleRetrieverEnd?.(e,this.runId,this._parentRunId,this.tags)}catch(r){if((t.raiseError?console.error:console.warn)(`Error in handler ${t.constructor.name}, handleRetriever`),t.raiseError)throw r}},t.awaitHandlers)))}async handleRetrieverError(e){await Promise.all(this.handlers.map(t=>mt(async()=>{if(!t.ignoreRetriever)try{await t.handleRetrieverError?.(e,this.runId,this._parentRunId,this.tags)}catch(r){if((t.raiseError?console.error:console.warn)(`Error in handler ${t.constructor.name}, handleRetrieverError: ${r}`),t.raiseError)throw e}},t.awaitHandlers)))}},Cd=class extends js{async handleLLMNewToken(e,t,r,n,i,a){await Promise.all(this.handlers.map(s=>mt(async()=>{if(!s.ignoreLLM)try{await s.handleLLMNewToken?.(e,t??{prompt:0,completion:0},this.runId,this._parentRunId,this.tags,a)}catch(o){if((s.raiseError?console.error:console.warn)(`Error in handler ${s.constructor.name}, handleLLMNewToken: ${o}`),s.raiseError)throw o}},s.awaitHandlers)))}async handleLLMError(e,t,r,n,i){await Promise.all(this.handlers.map(a=>mt(async()=>{if(!a.ignoreLLM)try{await a.handleLLMError?.(e,this.runId,this._parentRunId,this.tags,i)}catch(s){if((a.raiseError?console.error:console.warn)(`Error in handler ${a.constructor.name}, handleLLMError: ${s}`),a.raiseError)throw s}},a.awaitHandlers)))}async handleLLMEnd(e,t,r,n,i){await Promise.all(this.handlers.map(a=>mt(async()=>{if(!a.ignoreLLM)try{await a.handleLLMEnd?.(e,this.runId,this._parentRunId,this.tags,i)}catch(s){if((a.raiseError?console.error:console.warn)(`Error in handler ${a.constructor.name}, handleLLMEnd: ${s}`),a.raiseError)throw s}},a.awaitHandlers)))}},sw=class extends js{getChild(e){const t=new Ti(this.runId);return t.setHandlers(this.inheritableHandlers),t.addTags(this.inheritableTags),t.addMetadata(this.inheritableMetadata),e&&t.addTags([e],!1),t}async handleChainError(e,t,r,n,i){await Promise.all(this.handlers.map(a=>mt(async()=>{if(!a.ignoreChain)try{await a.handleChainError?.(e,this.runId,this._parentRunId,this.tags,i)}catch(s){if((a.raiseError?console.error:console.warn)(`Error in handler ${a.constructor.name}, handleChainError: ${s}`),a.raiseError)throw s}},a.awaitHandlers)))}async handleChainEnd(e,t,r,n,i){await Promise.all(this.handlers.map(a=>mt(async()=>{if(!a.ignoreChain)try{await a.handleChainEnd?.(e,this.runId,this._parentRunId,this.tags,i)}catch(s){if((a.raiseError?console.error:console.warn)(`Error in handler ${a.constructor.name}, handleChainEnd: ${s}`),a.raiseError)throw s}},a.awaitHandlers)))}async handleAgentAction(e){await Promise.all(this.handlers.map(t=>mt(async()=>{if(!t.ignoreAgent)try{await t.handleAgentAction?.(e,this.runId,this._parentRunId,this.tags)}catch(r){if((t.raiseError?console.error:console.warn)(`Error in handler ${t.constructor.name}, handleAgentAction: ${r}`),t.raiseError)throw r}},t.awaitHandlers)))}async handleAgentEnd(e){await Promise.all(this.handlers.map(t=>mt(async()=>{if(!t.ignoreAgent)try{await t.handleAgentEnd?.(e,this.runId,this._parentRunId,this.tags)}catch(r){if((t.raiseError?console.error:console.warn)(`Error in handler ${t.constructor.name}, handleAgentEnd: ${r}`),t.raiseError)throw r}},t.awaitHandlers)))}},ow=class extends js{getChild(e){const t=new Ti(this.runId);return t.setHandlers(this.inheritableHandlers),t.addTags(this.inheritableTags),t.addMetadata(this.inheritableMetadata),e&&t.addTags([e],!1),t}async handleToolError(e){await Promise.all(this.handlers.map(t=>mt(async()=>{if(!t.ignoreAgent)try{await t.handleToolError?.(e,this.runId,this._parentRunId,this.tags)}catch(r){if((t.raiseError?console.error:console.warn)(`Error in handler ${t.constructor.name}, handleToolError: ${r}`),t.raiseError)throw r}},t.awaitHandlers)))}async handleToolEnd(e){await Promise.all(this.handlers.map(t=>mt(async()=>{if(!t.ignoreAgent)try{await t.handleToolEnd?.(e,this.runId,this._parentRunId,this.tags)}catch(r){if((t.raiseError?console.error:console.warn)(`Error in handler ${t.constructor.name}, handleToolEnd: ${r}`),t.raiseError)throw r}},t.awaitHandlers)))}},Ti=class za extends iw{handlers=[];inheritableHandlers=[];tags=[];inheritableTags=[];metadata={};inheritableMetadata={};name="callback_manager";_parentRunId;constructor(t,r){super(),this.handlers=r?.handlers??this.handlers,this.inheritableHandlers=r?.inheritableHandlers??this.inheritableHandlers,this.tags=r?.tags??this.tags,this.inheritableTags=r?.inheritableTags??this.inheritableTags,this.metadata=r?.metadata??this.metadata,this.inheritableMetadata=r?.inheritableMetadata??this.inheritableMetadata,this._parentRunId=t}getParentRunId(){return this._parentRunId}async handleLLMStart(t,r,n=void 0,i=void 0,a=void 0,s=void 0,o=void 0,c=void 0){return Promise.all(r.map(async(u,d)=>{const h=d===0&&n?n:Xr();return await Promise.all(this.handlers.map(p=>{if(!p.ignoreLLM)return qi(p)&&p._createRunForLLMStart(t,[u],h,this._parentRunId,a,this.tags,this.metadata,c),mt(async()=>{try{await p.handleLLMStart?.(t,[u],h,this._parentRunId,a,this.tags,this.metadata,c)}catch(y){if((p.raiseError?console.error:console.warn)(`Error in handler ${p.constructor.name}, handleLLMStart: ${y}`),p.raiseError)throw y}},p.awaitHandlers)})),new Cd(h,this.handlers,this.inheritableHandlers,this.tags,this.inheritableTags,this.metadata,this.inheritableMetadata,this._parentRunId)}))}async handleChatModelStart(t,r,n=void 0,i=void 0,a=void 0,s=void 0,o=void 0,c=void 0){return Promise.all(r.map(async(u,d)=>{const h=d===0&&n?n:Xr();return await Promise.all(this.handlers.map(p=>{if(!p.ignoreLLM)return qi(p)&&p._createRunForChatModelStart(t,[u],h,this._parentRunId,a,this.tags,this.metadata,c),mt(async()=>{try{if(p.handleChatModelStart)await p.handleChatModelStart?.(t,[u],h,this._parentRunId,a,this.tags,this.metadata,c);else if(p.handleLLMStart){const y=QT(u);await p.handleLLMStart?.(t,[y],h,this._parentRunId,a,this.tags,this.metadata,c)}}catch(y){if((p.raiseError?console.error:console.warn)(`Error in handler ${p.constructor.name}, handleLLMStart: ${y}`),p.raiseError)throw y}},p.awaitHandlers)})),new Cd(h,this.handlers,this.inheritableHandlers,this.tags,this.inheritableTags,this.metadata,this.inheritableMetadata,this._parentRunId)}))}async handleChainStart(t,r,n=Xr(),i=void 0,a=void 0,s=void 0,o=void 0){return await Promise.all(this.handlers.map(c=>{if(!c.ignoreChain)return qi(c)&&c._createRunForChainStart(t,r,n,this._parentRunId,this.tags,this.metadata,i,o),mt(async()=>{try{await c.handleChainStart?.(t,r,n,this._parentRunId,this.tags,this.metadata,i,o)}catch(u){if((c.raiseError?console.error:console.warn)(`Error in handler ${c.constructor.name}, handleChainStart: ${u}`),c.raiseError)throw u}},c.awaitHandlers)})),new sw(n,this.handlers,this.inheritableHandlers,this.tags,this.inheritableTags,this.metadata,this.inheritableMetadata,this._parentRunId)}async handleToolStart(t,r,n=Xr(),i=void 0,a=void 0,s=void 0,o=void 0){return await Promise.all(this.handlers.map(c=>{if(!c.ignoreAgent)return qi(c)&&c._createRunForToolStart(t,r,n,this._parentRunId,this.tags,this.metadata,o),mt(async()=>{try{await c.handleToolStart?.(t,r,n,this._parentRunId,this.tags,this.metadata,o)}catch(u){if((c.raiseError?console.error:console.warn)(`Error in handler ${c.constructor.name}, handleToolStart: ${u}`),c.raiseError)throw u}},c.awaitHandlers)})),new ow(n,this.handlers,this.inheritableHandlers,this.tags,this.inheritableTags,this.metadata,this.inheritableMetadata,this._parentRunId)}async handleRetrieverStart(t,r,n=Xr(),i=void 0,a=void 0,s=void 0,o=void 0){return await Promise.all(this.handlers.map(c=>{if(!c.ignoreRetriever)return qi(c)&&c._createRunForRetrieverStart(t,r,n,this._parentRunId,this.tags,this.metadata,o),mt(async()=>{try{await c.handleRetrieverStart?.(t,r,n,this._parentRunId,this.tags,this.metadata,o)}catch(u){if((c.raiseError?console.error:console.warn)(`Error in handler ${c.constructor.name}, handleRetrieverStart: ${u}`),c.raiseError)throw u}},c.awaitHandlers)})),new aw(n,this.handlers,this.inheritableHandlers,this.tags,this.inheritableTags,this.metadata,this.inheritableMetadata,this._parentRunId)}async handleCustomEvent(t,r,n,i,a){await Promise.all(this.handlers.map(s=>mt(async()=>{if(!s.ignoreCustomEvent)try{await s.handleCustomEvent?.(t,r,n,this.tags,this.metadata)}catch(o){if((s.raiseError?console.error:console.warn)(`Error in handler ${s.constructor.name}, handleCustomEvent: ${o}`),s.raiseError)throw o}},s.awaitHandlers)))}addHandler(t,r=!0){this.handlers.push(t),r&&this.inheritableHandlers.push(t)}removeHandler(t){this.handlers=this.handlers.filter(r=>r!==t),this.inheritableHandlers=this.inheritableHandlers.filter(r=>r!==t)}setHandlers(t,r=!0){this.handlers=[],this.inheritableHandlers=[];for(const n of t)this.addHandler(n,r)}addTags(t,r=!0){this.removeTags(t),this.tags.push(...t),r&&this.inheritableTags.push(...t)}removeTags(t){this.tags=this.tags.filter(r=>!t.includes(r)),this.inheritableTags=this.inheritableTags.filter(r=>!t.includes(r))}addMetadata(t,r=!0){this.metadata={...this.metadata,...t},r&&(this.inheritableMetadata={...this.inheritableMetadata,...t})}removeMetadata(t){for(const r of Object.keys(t))delete this.metadata[r],delete this.inheritableMetadata[r]}copy(t=[],r=!0){const n=new za(this._parentRunId);for(const i of this.handlers){const a=this.inheritableHandlers.includes(i);n.addHandler(i,a)}for(const i of this.tags){const a=this.inheritableTags.includes(i);n.addTags([i],a)}for(const i of Object.keys(this.metadata)){const a=Object.keys(this.inheritableMetadata).includes(i);n.addMetadata({[i]:this.metadata[i]},a)}for(const i of t)n.handlers.filter(a=>a.name==="console_callback_handler").some(a=>a.name===i.name)||n.addHandler(i,r);return n}static fromHandlers(t){class r extends Ms{name=Xr();constructor(){super(),Object.assign(this,t)}}const n=new this;return n.addHandler(new r),n}static configure(t,r,n,i,a,s,o){return this._configureSync(t,r,n,i,a,s,o)}static _configureSync(t,r,n,i,a,s,o){let c;(t||r)&&(Array.isArray(t)||!t?(c=new za,c.setHandlers(t?.map(ms)??[],!0)):c=t,c=c.copy(Array.isArray(r)?r.map(ms):r?.handlers,!1));const u=fi("LANGCHAIN_VERBOSE")==="true"||o?.verbose,d=zo.getTraceableRunTree()?.tracingEnabled||$$(),h=d||(fi("LANGCHAIN_TRACING")??!1);if(u||h){if(c||(c=new za),u&&!c.handlers.some(p=>p.name===$d.prototype.name)){const p=new $d;c.addHandler(p,!0)}if(h&&!c.handlers.some(p=>p.name==="langchain_tracer")&&d){const p=new zo;c.addHandler(p,!0)}if(d){const p=zo.getTraceableRunTree();p&&c._parentRunId===void 0&&(c._parentRunId=p.id,c.handlers.find(g=>g.name==="langchain_tracer")?.updateFromRunTree(p))}}for(const{contextVar:p,inheritable:y=!0,handlerClass:g,envVar:w}of P$()){const b=w&&fi(w)==="true"&&g;let S;const O=p!==void 0?nw(p):void 0;O&&C_(O)?S=O:b&&(S=new g({})),S!==void 0&&(c||(c=new za),c.handlers.some(T=>T.name===S.name)||c.addHandler(S,y))}return(n||i)&&c&&(c.addTags(n??[]),c.addTags(i??[],!1)),(a||s)&&c&&(c.addMetadata(a??{}),c.addMetadata(s??{},!1)),c}};function ms(e){return"name"in e?e:Ms.fromMethods(e)}var cw=class{getStore(){}run(e,t){return t()}enterWith(e){}};const M$=new cw,gg=Symbol.for("lc:child_config");var L$=class{getInstance(){return ds()??M$}getRunnableConfig(){return this.getInstance().getStore()?.extra?.[gg]}runWithConfig(e,t,r){const n=Ti._configureSync(e?.callbacks,void 0,e?.tags,void 0,e?.metadata),i=this.getInstance(),a=i.getStore(),s=n?.getParentRunId(),o=n?.handlers?.find(u=>u?.name==="langchain_tracer");let c;return o&&s?c=o.getRunTreeWithTracingConfig(s):r||(c=new Ht({name:"<runnable_lambda>",tracingEnabled:!1})),c&&(c.extra={...c.extra,[gg]:e}),a!==void 0&&a[Ya]!==void 0&&(c===void 0&&(c={}),c[Ya]=a[Ya]),i.run(c,t)}initializeGlobalInstance(e){ds()===void 0&&uT(e)}};const hn=new L$;var j$={};bt(j$,{AsyncLocalStorageProviderSingleton:()=>hn,MockAsyncLocalStorage:()=>cw,_CONTEXT_VARIABLES_KEY:()=>Ya});const Vl=25;async function Rr(e){return Ti._configureSync(e?.callbacks,void 0,e?.tags,void 0,e?.metadata)}function yg(...e){const t={};for(const r of e.filter(n=>!!n))for(const n of Object.keys(r))if(n==="metadata")t[n]={...t[n],...r[n]};else if(n==="tags"){const i=t[n]??[];t[n]=[...new Set(i.concat(r[n]??[]))]}else if(n==="configurable")t[n]={...t[n],...r[n]};else if(n==="timeout")t.timeout===void 0?t.timeout=r.timeout:r.timeout!==void 0&&(t.timeout=Math.min(t.timeout,r.timeout));else if(n==="signal")t.signal===void 0?t.signal=r.signal:r.signal!==void 0&&("any"in AbortSignal?t.signal=AbortSignal.any([t.signal,r.signal]):t.signal=r.signal);else if(n==="callbacks"){const i=t.callbacks,a=r.callbacks;if(Array.isArray(a))if(!i)t.callbacks=a;else if(Array.isArray(i))t.callbacks=i.concat(a);else{const s=i.copy();for(const o of a)s.addHandler(ms(o),!0);t.callbacks=s}else if(a)if(!i)t.callbacks=a;else if(Array.isArray(i)){const s=a.copy();for(const o of i)s.addHandler(ms(o),!0);t.callbacks=s}else t.callbacks=new Ti(a._parentRunId,{handlers:i.handlers.concat(a.handlers),inheritableHandlers:i.inheritableHandlers.concat(a.inheritableHandlers),tags:Array.from(new Set(i.tags.concat(a.tags))),inheritableTags:Array.from(new Set(i.inheritableTags.concat(a.inheritableTags))),metadata:{...i.metadata,...a.metadata}})}else{const i=n;t[i]=r[i]??t[i]}return t}const F$=new Set(["string","number","boolean"]);function Xe(e){const t=hn.getRunnableConfig();let r={tags:[],metadata:{},recursionLimit:25,runId:void 0};if(t){const{runId:n,runName:i,...a}=t;r=Object.entries(a).reduce((s,[o,c])=>(c!==void 0&&(s[o]=c),s),r)}if(e&&(r=Object.entries(e).reduce((n,[i,a])=>(a!==void 0&&(n[i]=a),n),r)),r?.configurable)for(const n of Object.keys(r.configurable))F$.has(typeof r.configurable[n])&&!r.metadata?.[n]&&(r.metadata||(r.metadata={}),r.metadata[n]=r.configurable[n]);if(r.timeout!==void 0){if(r.timeout<=0)throw new Error("Timeout must be a positive number");const n=AbortSignal.timeout(r.timeout);r.signal!==void 0?"any"in AbortSignal&&(r.signal=AbortSignal.any([r.signal,n])):r.signal=n,delete r.timeout}return r}function Bt(e={},{callbacks:t,maxConcurrency:r,recursionLimit:n,runName:i,configurable:a,runId:s}={}){const o=Xe(e);return t!==void 0&&(delete o.runName,o.callbacks=t),n!==void 0&&(o.recursionLimit=n),r!==void 0&&(o.maxConcurrency=r),i!==void 0&&(o.runName=i),a!==void 0&&(o.configurable={...o.configurable,...a}),s!==void 0&&delete o.runId,o}function oa(e){if(e)return{configurable:e.configurable,recursionLimit:e.recursionLimit,callbacks:e.callbacks,tags:e.tags,metadata:e.metadata,maxConcurrency:e.maxConcurrency,timeout:e.timeout,signal:e.signal,store:e.store}}async function Ln(e,t){if(t===void 0)return e;let r;return Promise.race([e.catch(n=>{if(!t?.aborted)throw n}),new Promise((n,i)=>{r=()=>{i(sc(t))},t.addEventListener("abort",r),t.aborted&&i(sc(t))})]).finally(()=>t.removeEventListener("abort",r))}function sc(e){return e?.reason instanceof Error?e.reason:typeof e?.reason=="string"?new Error(e.reason):new Error("Aborted")}var B$={};bt(B$,{AsyncGeneratorWithSetup:()=>Ri,IterableReadableStream:()=>Ar,atee:()=>Uf,concat:()=>qf,pipeGeneratorWithSetup:()=>uw});var Ar=class Pd extends ReadableStream{reader;ensureReader(){this.reader||(this.reader=this.getReader())}async next(){this.ensureReader();try{const t=await this.reader.read();return t.done?(this.reader.releaseLock(),{done:!0,value:void 0}):{done:!1,value:t.value}}catch(t){throw this.reader.releaseLock(),t}}async return(){if(this.ensureReader(),this.locked){const t=this.reader.cancel();this.reader.releaseLock(),await t}return{done:!0,value:void 0}}async throw(t){if(this.ensureReader(),this.locked){const r=this.reader.cancel();this.reader.releaseLock(),await r}throw t}[Symbol.asyncIterator](){return this}async[Symbol.asyncDispose](){await this.return()}static fromReadableStream(t){const r=t.getReader();return new Pd({start(n){return i();function i(){return r.read().then(({done:a,value:s})=>{if(a){n.close();return}return n.enqueue(s),i()})}},cancel(){r.releaseLock()}})}static fromAsyncGenerator(t){return new Pd({async pull(r){const{value:n,done:i}=await t.next();i&&r.close(),r.enqueue(n)},async cancel(r){await t.return(r)}})}};function Uf(e,t=2){const r=Array.from({length:t},()=>[]);return r.map(async function*(i){for(;;)if(i.length===0){const a=await e.next();for(const s of r)s.push(a)}else{if(i[0].done)return;yield i.shift().value}})}function qf(e,t){if(Array.isArray(e)&&Array.isArray(t))return e.concat(t);if(typeof e=="string"&&typeof t=="string")return e+t;if(typeof e=="number"&&typeof t=="number")return e+t;if("concat"in e&&typeof e.concat=="function")return e.concat(t);if(typeof e=="object"&&typeof t=="object"){const r={...e};for(const[n,i]of Object.entries(t))n in r&&!Array.isArray(r[n])?r[n]=qf(r[n],i):r[n]=i;return r}else throw new Error(`Cannot concat ${typeof e} and ${typeof t}`)}var Ri=class{generator;setup;config;signal;firstResult;firstResultUsed=!1;constructor(e){this.generator=e.generator,this.config=e.config,this.signal=e.signal??this.config?.signal,this.setup=new Promise((t,r)=>{hn.runWithConfig(oa(e.config),async()=>{this.firstResult=e.generator.next(),e.startSetup?this.firstResult.then(e.startSetup).then(t,r):this.firstResult.then(n=>t(void 0),r)},!0)})}async next(...e){return this.signal?.throwIfAborted(),this.firstResultUsed?hn.runWithConfig(oa(this.config),this.signal?async()=>Ln(this.generator.next(...e),this.signal):async()=>this.generator.next(...e),!0):(this.firstResultUsed=!0,this.firstResult)}async return(e){return this.generator.return(e)}async throw(e){return this.generator.throw(e)}[Symbol.asyncIterator](){return this}async[Symbol.asyncDispose](){await this.return()}};async function uw(e,t,r,n,...i){const a=new Ri({generator:t,startSetup:r,signal:n}),s=await a.setup;return{output:e(a,s,...i),setup:s}}const z$=Object.prototype.hasOwnProperty;function U$(e,t){return z$.call(e,t)}function q$(e){if(Array.isArray(e)){const r=new Array(e.length);for(let n=0;n<r.length;n++)r[n]=""+n;return r}if(Object.keys)return Object.keys(e);let t=[];for(let r in e)U$(e,r)&&t.push(r);return t}function bi(e){switch(typeof e){case"object":return JSON.parse(JSON.stringify(e));case"undefined":return null;default:return e}}function Nd(e){let t=0;const r=e.length;let n;for(;t<r;){if(n=e.charCodeAt(t),n>=48&&n<=57){t++;continue}return!1}return!0}function H$(e){return e.replace(/~1/g,"/").replace(/~0/g,"~")}function Dd(e){if(e===void 0)return!0;if(e){if(Array.isArray(e)){for(let r=0,n=e.length;r<n;r++)if(Dd(e[r]))return!0}else if(typeof e=="object"){const r=q$(e),n=r.length;for(var t=0;t<n;t++)if(Dd(e[r[t]]))return!0}}return!1}function vg(e,t){const r=[e];for(const n in t){const i=typeof t[n]=="object"?JSON.stringify(t[n],null,2):t[n];typeof i<"u"&&r.push(`${n}: ${i}`)}return r.join(`
`)}var K$=class extends Error{constructor(e,t,r,n,i){super(vg(e,{name:t,index:r,operation:n,tree:i})),this.name=t,this.index=r,this.operation=n,this.tree=i,Object.setPrototypeOf(this,new.target.prototype),this.message=vg(e,{name:t,index:r,operation:n,tree:i})}},lw={};bt(lw,{JsonPatchError:()=>ut,_areEquals:()=>ys,applyOperation:()=>pi,applyPatch:()=>gs,applyReducer:()=>V$,deepClone:()=>G$,getValueByPointer:()=>oc,validate:()=>dw,validator:()=>cc});const ut=K$,G$=bi,Wi={add:function(e,t,r){return e[t]=this.value,{newDocument:r}},remove:function(e,t,r){var n=e[t];return delete e[t],{newDocument:r,removed:n}},replace:function(e,t,r){var n=e[t];return e[t]=this.value,{newDocument:r,removed:n}},move:function(e,t,r){let n=oc(r,this.path);n&&(n=bi(n));const i=pi(r,{op:"remove",path:this.from}).removed;return pi(r,{op:"add",path:this.path,value:i}),{newDocument:r,removed:n}},copy:function(e,t,r){const n=oc(r,this.from);return pi(r,{op:"add",path:this.path,value:bi(n)}),{newDocument:r}},test:function(e,t,r){return{newDocument:r,test:ys(e[t],this.value)}},_get:function(e,t,r){return this.value=e[t],{newDocument:r}}};var W$={add:function(e,t,r){return Nd(t)?e.splice(t,0,this.value):e[t]=this.value,{newDocument:r,index:t}},remove:function(e,t,r){var n=e.splice(t,1);return{newDocument:r,removed:n[0]}},replace:function(e,t,r){var n=e[t];return e[t]=this.value,{newDocument:r,removed:n}},move:Wi.move,copy:Wi.copy,test:Wi.test,_get:Wi._get};function oc(e,t){if(t=="")return e;var r={op:"_get",path:t};return pi(e,r),r.value}function pi(e,t,r=!1,n=!0,i=!0,a=0){if(r&&(typeof r=="function"?r(t,0,e,t.path):cc(t,0)),t.path===""){let s={newDocument:e};if(t.op==="add")return s.newDocument=t.value,s;if(t.op==="replace")return s.newDocument=t.value,s.removed=e,s;if(t.op==="move"||t.op==="copy")return s.newDocument=oc(e,t.from),t.op==="move"&&(s.removed=e),s;if(t.op==="test"){if(s.test=ys(e,t.value),s.test===!1)throw new ut("Test operation failed","TEST_OPERATION_FAILED",a,t,e);return s.newDocument=e,s}else{if(t.op==="remove")return s.removed=e,s.newDocument=null,s;if(t.op==="_get")return t.value=e,s;if(r)throw new ut("Operation `op` property is not one of operations defined in RFC-6902","OPERATION_OP_INVALID",a,t,e);return s}}else{n||(e=bi(e));const o=(t.path||"").split("/");let c=e,u=1,d=o.length,h,p,y;for(typeof r=="function"?y=r:y=cc;;){if(p=o[u],p&&p.indexOf("~")!=-1&&(p=H$(p)),i&&(p=="__proto__"||p=="prototype"&&u>0&&o[u-1]=="constructor"))throw new TypeError("JSON-Patch: modifying `__proto__` or `constructor/prototype` prop is banned for security reasons, if this was on purpose, please set `banPrototypeModifications` flag false and pass it to this function. More info in fast-json-patch README");if(r&&h===void 0&&(c[p]===void 0?h=o.slice(0,u).join("/"):u==d-1&&(h=t.path),h!==void 0&&y(t,0,e,h)),u++,Array.isArray(c)){if(p==="-")p=c.length;else{if(r&&!Nd(p))throw new ut("Expected an unsigned base-10 integer value, making the new referenced value the array element with the zero-based index","OPERATION_PATH_ILLEGAL_ARRAY_INDEX",a,t,e);Nd(p)&&(p=~~p)}if(u>=d){if(r&&t.op==="add"&&p>c.length)throw new ut("The specified index MUST NOT be greater than the number of elements in the array","OPERATION_VALUE_OUT_OF_BOUNDS",a,t,e);const g=W$[t.op].call(t,c,p,e);if(g.test===!1)throw new ut("Test operation failed","TEST_OPERATION_FAILED",a,t,e);return g}}else if(u>=d){const g=Wi[t.op].call(t,c,p,e);if(g.test===!1)throw new ut("Test operation failed","TEST_OPERATION_FAILED",a,t,e);return g}if(c=c[p],r&&u<d&&(!c||typeof c!="object"))throw new ut("Cannot perform operation at the desired path","OPERATION_PATH_UNRESOLVABLE",a,t,e)}}}function gs(e,t,r,n=!0,i=!0){if(r&&!Array.isArray(t))throw new ut("Patch sequence must be an array","SEQUENCE_NOT_AN_ARRAY");n||(e=bi(e));const a=new Array(t.length);for(let s=0,o=t.length;s<o;s++)a[s]=pi(e,t[s],r,!0,i,s),e=a[s].newDocument;return a.newDocument=e,a}function V$(e,t,r){const n=pi(e,t);if(n.test===!1)throw new ut("Test operation failed","TEST_OPERATION_FAILED",r,t,e);return n.newDocument}function cc(e,t,r,n){if(typeof e!="object"||e===null||Array.isArray(e))throw new ut("Operation is not an object","OPERATION_NOT_AN_OBJECT",t,e,r);if(Wi[e.op]){if(typeof e.path!="string")throw new ut("Operation `path` property is not a string","OPERATION_PATH_INVALID",t,e,r);if(e.path.indexOf("/")!==0&&e.path.length>0)throw new ut('Operation `path` property must start with "/"',"OPERATION_PATH_INVALID",t,e,r);if((e.op==="move"||e.op==="copy")&&typeof e.from!="string")throw new ut("Operation `from` property is not present (applicable in `move` and `copy` operations)","OPERATION_FROM_REQUIRED",t,e,r);if((e.op==="add"||e.op==="replace"||e.op==="test")&&e.value===void 0)throw new ut("Operation `value` property is not present (applicable in `add`, `replace` and `test` operations)","OPERATION_VALUE_REQUIRED",t,e,r);if((e.op==="add"||e.op==="replace"||e.op==="test")&&Dd(e.value))throw new ut("Operation `value` property is not present (applicable in `add`, `replace` and `test` operations)","OPERATION_VALUE_CANNOT_CONTAIN_UNDEFINED",t,e,r);if(r){if(e.op=="add"){var i=e.path.split("/").length,a=n.split("/").length;if(i!==a+1&&i!==a)throw new ut("Cannot perform an `add` operation at the desired path","OPERATION_PATH_CANNOT_ADD",t,e,r)}else if(e.op==="replace"||e.op==="remove"||e.op==="_get"){if(e.path!==n)throw new ut("Cannot perform the operation at a path that does not exist","OPERATION_PATH_UNRESOLVABLE",t,e,r)}else if(e.op==="move"||e.op==="copy"){var s={op:"_get",path:e.from,value:void 0},o=dw([s],r);if(o&&o.name==="OPERATION_PATH_UNRESOLVABLE")throw new ut("Cannot perform the operation from a path that does not exist","OPERATION_FROM_UNRESOLVABLE",t,e,r)}}}else throw new ut("Operation `op` property is not one of operations defined in RFC-6902","OPERATION_OP_INVALID",t,e,r)}function dw(e,t,r){try{if(!Array.isArray(e))throw new ut("Patch sequence must be an array","SEQUENCE_NOT_AN_ARRAY");if(t)gs(bi(t),bi(e),r||!0);else{r=r||cc;for(var n=0;n<e.length;n++)r(e[n],n,t,void 0)}}catch(i){if(i instanceof ut)return i;throw i}}function ys(e,t){if(e===t)return!0;if(e&&t&&typeof e=="object"&&typeof t=="object"){var r=Array.isArray(e),n=Array.isArray(t),i,a,s;if(r&&n){if(a=e.length,a!=t.length)return!1;for(i=a;i--!==0;)if(!ys(e[i],t[i]))return!1;return!0}if(r!=n)return!1;var o=Object.keys(e);if(a=o.length,a!==Object.keys(t).length)return!1;for(i=a;i--!==0;)if(!t.hasOwnProperty(o[i]))return!1;for(i=a;i--!==0;)if(s=o[i],!ys(e[s],t[s]))return!1;return!0}return e!==e&&t!==t}({...lw});var Z$={};bt(Z$,{LogStreamCallbackHandler:()=>Ld,RunLog:()=>Hf,RunLogPatch:()=>en,isLogStreamHandler:()=>fw});var en=class{ops;constructor(e){this.ops=e.ops??[]}concat(e){const t=this.ops.concat(e.ops),r=gs({},t);return new Hf({ops:t,state:r[r.length-1].newDocument})}},Hf=class Md extends en{state;constructor(t){super(t),this.state=t.state}concat(t){const r=this.ops.concat(t.ops),n=gs(this.state,t.ops);return new Md({ops:r,state:n[n.length-1].newDocument})}static fromRunLogPatch(t){const r=gs({},t.ops);return new Md({ops:t.ops,state:r[r.length-1].newDocument})}};const fw=e=>e.name==="log_stream_tracer";async function _g(e,t){if(t==="original")throw new Error("Do not assign inputs with original schema drop the key for now. When inputs are added to streamLog they should be added with standardized schema for streaming events.");const{inputs:r}=e;if(["retriever","llm","prompt"].includes(e.run_type))return r;if(!(Object.keys(r).length===1&&r?.input===""))return r.input}async function wg(e,t){const{outputs:r}=e;return t==="original"||["retriever","llm","prompt"].includes(e.run_type)?r:r!==void 0&&Object.keys(r).length===1&&r?.output!==void 0?r.output:r}function J$(e){return e!==void 0&&e.message!==void 0}var Ld=class extends _a{autoClose=!0;includeNames;includeTypes;includeTags;excludeNames;excludeTypes;excludeTags;_schemaFormat="original";rootId;keyMapByRunId={};counterMapByRunName={};transformStream;writer;receiveStream;name="log_stream_tracer";lc_prefer_streaming=!0;constructor(e){super({_awaitHandler:!0,...e}),this.autoClose=e?.autoClose??!0,this.includeNames=e?.includeNames,this.includeTypes=e?.includeTypes,this.includeTags=e?.includeTags,this.excludeNames=e?.excludeNames,this.excludeTypes=e?.excludeTypes,this.excludeTags=e?.excludeTags,this._schemaFormat=e?._schemaFormat??this._schemaFormat,this.transformStream=new TransformStream,this.writer=this.transformStream.writable.getWriter(),this.receiveStream=Ar.fromReadableStream(this.transformStream.readable)}[Symbol.asyncIterator](){return this.receiveStream}async persistRun(e){}_includeRun(e){if(e.id===this.rootId)return!1;const t=e.tags??[];let r=this.includeNames===void 0&&this.includeTags===void 0&&this.includeTypes===void 0;return this.includeNames!==void 0&&(r=r||this.includeNames.includes(e.name)),this.includeTypes!==void 0&&(r=r||this.includeTypes.includes(e.run_type)),this.includeTags!==void 0&&(r=r||t.find(n=>this.includeTags?.includes(n))!==void 0),this.excludeNames!==void 0&&(r=r&&!this.excludeNames.includes(e.name)),this.excludeTypes!==void 0&&(r=r&&!this.excludeTypes.includes(e.run_type)),this.excludeTags!==void 0&&(r=r&&t.every(n=>!this.excludeTags?.includes(n))),r}async*tapOutputIterable(e,t){for await(const r of t){if(e!==this.rootId){const n=this.keyMapByRunId[e];n&&await this.writer.write(new en({ops:[{op:"add",path:`/logs/${n}/streamed_output/-`,value:r}]}))}yield r}}async onRunCreate(e){if(this.rootId===void 0&&(this.rootId=e.id,await this.writer.write(new en({ops:[{op:"replace",path:"",value:{id:e.id,name:e.name,type:e.run_type,streamed_output:[],final_output:void 0,logs:{}}}]}))),!this._includeRun(e))return;this.counterMapByRunName[e.name]===void 0&&(this.counterMapByRunName[e.name]=0),this.counterMapByRunName[e.name]+=1;const t=this.counterMapByRunName[e.name];this.keyMapByRunId[e.id]=t===1?e.name:`${e.name}:${t}`;const r={id:e.id,name:e.name,type:e.run_type,tags:e.tags??[],metadata:e.extra?.metadata??{},start_time:new Date(e.start_time).toISOString(),streamed_output:[],streamed_output_str:[],final_output:void 0,end_time:void 0};this._schemaFormat==="streaming_events"&&(r.inputs=await _g(e,this._schemaFormat)),await this.writer.write(new en({ops:[{op:"add",path:`/logs/${this.keyMapByRunId[e.id]}`,value:r}]}))}async onRunUpdate(e){try{const t=this.keyMapByRunId[e.id];if(t===void 0)return;const r=[];this._schemaFormat==="streaming_events"&&r.push({op:"replace",path:`/logs/${t}/inputs`,value:await _g(e,this._schemaFormat)}),r.push({op:"add",path:`/logs/${t}/final_output`,value:await wg(e,this._schemaFormat)}),e.end_time!==void 0&&r.push({op:"add",path:`/logs/${t}/end_time`,value:new Date(e.end_time).toISOString()});const n=new en({ops:r});await this.writer.write(n)}finally{if(e.id===this.rootId){const t=new en({ops:[{op:"replace",path:"/final_output",value:await wg(e,this._schemaFormat)}]});await this.writer.write(t),this.autoClose&&await this.writer.close()}}}async onLLMNewToken(e,t,r){const n=this.keyMapByRunId[e.id];if(n===void 0)return;const i=e.inputs.messages!==void 0;let a;i?J$(r?.chunk)?a=r?.chunk:a=new k_({id:`run-${e.id}`,content:t}):a=t;const s=new en({ops:[{op:"add",path:`/logs/${n}/streamed_output_str/-`,value:t},{op:"add",path:`/logs/${n}/streamed_output/-`,value:a}]});await this.writer.write(s)}},Q$={};bt(Q$,{ChatGenerationChunk:()=>X$,GenerationChunk:()=>uc,RUN_KEY:()=>Y$});const Y$="__run";var uc=class hw{text;generationInfo;constructor(t){this.text=t.text,this.generationInfo=t.generationInfo}concat(t){return new hw({text:this.text+t.text,generationInfo:{...this.generationInfo,...t.generationInfo}})}},X$=class pw extends uc{message;constructor(t){super(t),this.message=t.message}concat(t){return new pw({text:this.text+t.text,generationInfo:{...this.generationInfo,...t.generationInfo},message:this.message.concat(t.message)})}};function ko({name:e,serialized:t}){return e!==void 0?e:t?.name!==void 0?t.name:t?.id!==void 0&&Array.isArray(t?.id)?t.id[t.id.length-1]:"Unnamed"}const eC=e=>e.name==="event_stream_tracer";var tC=class extends _a{autoClose=!0;includeNames;includeTypes;includeTags;excludeNames;excludeTypes;excludeTags;runInfoMap=new Map;tappedPromises=new Map;transformStream;writer;receiveStream;name="event_stream_tracer";lc_prefer_streaming=!0;constructor(e){super({_awaitHandler:!0,...e}),this.autoClose=e?.autoClose??!0,this.includeNames=e?.includeNames,this.includeTypes=e?.includeTypes,this.includeTags=e?.includeTags,this.excludeNames=e?.excludeNames,this.excludeTypes=e?.excludeTypes,this.excludeTags=e?.excludeTags,this.transformStream=new TransformStream,this.writer=this.transformStream.writable.getWriter(),this.receiveStream=Ar.fromReadableStream(this.transformStream.readable)}[Symbol.asyncIterator](){return this.receiveStream}async persistRun(e){}_includeRun(e){const t=e.tags??[];let r=this.includeNames===void 0&&this.includeTags===void 0&&this.includeTypes===void 0;return this.includeNames!==void 0&&(r=r||this.includeNames.includes(e.name)),this.includeTypes!==void 0&&(r=r||this.includeTypes.includes(e.runType)),this.includeTags!==void 0&&(r=r||t.find(n=>this.includeTags?.includes(n))!==void 0),this.excludeNames!==void 0&&(r=r&&!this.excludeNames.includes(e.name)),this.excludeTypes!==void 0&&(r=r&&!this.excludeTypes.includes(e.runType)),this.excludeTags!==void 0&&(r=r&&t.every(n=>!this.excludeTags?.includes(n))),r}async*tapOutputIterable(e,t){const r=await t.next();if(r.done)return;const n=this.runInfoMap.get(e);if(n===void 0){yield r.value;return}function i(s,o){return s==="llm"&&typeof o=="string"?new uc({text:o}):o}let a=this.tappedPromises.get(e);if(a===void 0){let s;a=new Promise(o=>{s=o}),this.tappedPromises.set(e,a);try{const o={event:`on_${n.runType}_stream`,run_id:e,name:n.name,tags:n.tags,metadata:n.metadata,data:{}};await this.send({...o,data:{chunk:i(n.runType,r.value)}},n),yield r.value;for await(const c of t)n.runType!=="tool"&&n.runType!=="retriever"&&await this.send({...o,data:{chunk:i(n.runType,c)}},n),yield c}finally{s?.()}}else{yield r.value;for await(const s of t)yield s}}async send(e,t){this._includeRun(t)&&await this.writer.write(e)}async sendEndEvent(e,t){const r=this.tappedPromises.get(e.run_id);r!==void 0?r.then(()=>{this.send(e,t)}):await this.send(e,t)}async onLLMStart(e){const t=ko(e),r=e.inputs.messages!==void 0?"chat_model":"llm",n={tags:e.tags??[],metadata:e.extra?.metadata??{},name:t,runType:r,inputs:e.inputs};this.runInfoMap.set(e.id,n);const i=`on_${r}_start`;await this.send({event:i,data:{input:e.inputs},name:t,tags:e.tags??[],run_id:e.id,metadata:e.extra?.metadata??{}},n)}async onLLMNewToken(e,t,r){const n=this.runInfoMap.get(e.id);let i,a;if(n===void 0)throw new Error(`onLLMNewToken: Run ID ${e.id} not found in run map.`);if(this.runInfoMap.size!==1){if(n.runType==="chat_model")a="on_chat_model_stream",r?.chunk===void 0?i=new k_({content:t,id:`run-${e.id}`}):i=r.chunk.message;else if(n.runType==="llm")a="on_llm_stream",r?.chunk===void 0?i=new uc({text:t}):i=r.chunk;else throw new Error(`Unexpected run type ${n.runType}`);await this.send({event:a,data:{chunk:i},run_id:e.id,name:n.name,tags:n.tags,metadata:n.metadata},n)}}async onLLMEnd(e){const t=this.runInfoMap.get(e.id);this.runInfoMap.delete(e.id);let r;if(t===void 0)throw new Error(`onLLMEnd: Run ID ${e.id} not found in run map.`);const n=e.outputs?.generations;let i;if(t.runType==="chat_model"){for(const a of n??[]){if(i!==void 0)break;i=a[0]?.message}r="on_chat_model_end"}else if(t.runType==="llm")i={generations:n?.map(a=>a.map(s=>({text:s.text,generationInfo:s.generationInfo}))),llmOutput:e.outputs?.llmOutput??{}},r="on_llm_end";else throw new Error(`onLLMEnd: Unexpected run type: ${t.runType}`);await this.sendEndEvent({event:r,data:{output:i,input:t.inputs},run_id:e.id,name:t.name,tags:t.tags,metadata:t.metadata},t)}async onChainStart(e){const t=ko(e),r=e.run_type??"chain",n={tags:e.tags??[],metadata:e.extra?.metadata??{},name:t,runType:e.run_type};let i={};e.inputs.input===""&&Object.keys(e.inputs).length===1?(i={},n.inputs={}):e.inputs.input!==void 0?(i.input=e.inputs.input,n.inputs=e.inputs.input):(i.input=e.inputs,n.inputs=e.inputs),this.runInfoMap.set(e.id,n),await this.send({event:`on_${r}_start`,data:i,name:t,tags:e.tags??[],run_id:e.id,metadata:e.extra?.metadata??{}},n)}async onChainEnd(e){const t=this.runInfoMap.get(e.id);if(this.runInfoMap.delete(e.id),t===void 0)throw new Error(`onChainEnd: Run ID ${e.id} not found in run map.`);const r=`on_${e.run_type}_end`,n=e.inputs??t.inputs??{},a={output:e.outputs?.output??e.outputs,input:n};n.input&&Object.keys(n).length===1&&(a.input=n.input,t.inputs=n.input),await this.sendEndEvent({event:r,data:a,run_id:e.id,name:t.name,tags:t.tags,metadata:t.metadata??{}},t)}async onToolStart(e){const t=ko(e),r={tags:e.tags??[],metadata:e.extra?.metadata??{},name:t,runType:"tool",inputs:e.inputs??{}};this.runInfoMap.set(e.id,r),await this.send({event:"on_tool_start",data:{input:e.inputs??{}},name:t,run_id:e.id,tags:e.tags??[],metadata:e.extra?.metadata??{}},r)}async onToolEnd(e){const t=this.runInfoMap.get(e.id);if(this.runInfoMap.delete(e.id),t===void 0)throw new Error(`onToolEnd: Run ID ${e.id} not found in run map.`);if(t.inputs===void 0)throw new Error(`onToolEnd: Run ID ${e.id} is a tool call, and is expected to have traced inputs.`);const r=e.outputs?.output===void 0?e.outputs:e.outputs.output;await this.sendEndEvent({event:"on_tool_end",data:{output:r,input:t.inputs},run_id:e.id,name:t.name,tags:t.tags,metadata:t.metadata},t)}async onRetrieverStart(e){const t=ko(e),n={tags:e.tags??[],metadata:e.extra?.metadata??{},name:t,runType:"retriever",inputs:{query:e.inputs.query}};this.runInfoMap.set(e.id,n),await this.send({event:"on_retriever_start",data:{input:{query:e.inputs.query}},name:t,tags:e.tags??[],run_id:e.id,metadata:e.extra?.metadata??{}},n)}async onRetrieverEnd(e){const t=this.runInfoMap.get(e.id);if(this.runInfoMap.delete(e.id),t===void 0)throw new Error(`onRetrieverEnd: Run ID ${e.id} not found in run map.`);await this.sendEndEvent({event:"on_retriever_end",data:{output:e.outputs?.documents??e.outputs,input:t.inputs},run_id:e.id,name:t.name,tags:t.tags,metadata:t.metadata},t)}async handleCustomEvent(e,t,r){const n=this.runInfoMap.get(r);if(n===void 0)throw new Error(`handleCustomEvent: Run ID ${r} not found in run map.`);await this.send({event:"on_custom_event",run_id:r,name:e,tags:n.tags,metadata:n.metadata,data:t},n)}async finish(){const e=[...this.tappedPromises.values()];Promise.all(e).finally(()=>{this.writer.close()})}};const rC=Object.prototype.toString,nC=e=>rC.call(e)==="[object Error]",iC=new Set(["network error","Failed to fetch","NetworkError when attempting to fetch resource.","The Internet connection appears to be offline.","Network request failed","fetch failed","terminated"," A network error occurred.","Network connection lost"]);function aC(e){if(!(e&&nC(e)&&e.name==="TypeError"&&typeof e.message=="string"))return!1;const{message:r,stack:n}=e;return r==="Load failed"?n===void 0||"__sentry_captured__"in e:r.startsWith("error sending request for url")?!0:iC.has(r)}function sC(e){if(typeof e=="number"){if(e<0)throw new TypeError("Expected `retries` to be a non-negative number.");if(Number.isNaN(e))throw new TypeError("Expected `retries` to be a valid number or Infinity, got NaN.")}else if(e!==void 0)throw new TypeError("Expected `retries` to be a number or Infinity.")}function Io(e,t,{min:r=0,allowInfinity:n=!1}={}){if(t!==void 0){if(typeof t!="number"||Number.isNaN(t))throw new TypeError(`Expected \`${e}\` to be a number${n?" or Infinity":""}.`);if(!n&&!Number.isFinite(t))throw new TypeError(`Expected \`${e}\` to be a finite number.`);if(t<r)throw new TypeError(`Expected \`${e}\` to be  ${r}.`)}}class oC extends Error{constructor(t){super(),t instanceof Error?(this.originalError=t,{message:t}=t):(this.originalError=new Error(t),this.originalError.stack=this.stack),this.name="AbortError",this.message=t}}function cC(e,t){const r=Math.max(1,e+1),n=t.randomize?Math.random()+1:1;let i=Math.round(n*t.minTimeout*t.factor**(r-1));return i=Math.min(i,t.maxTimeout),i}function bg(e,t){return Number.isFinite(t)?t-(performance.now()-e):t}async function uC({error:e,attemptNumber:t,retriesConsumed:r,startTime:n,options:i}){const a=e instanceof Error?e:new TypeError(`Non-error was thrown: "${e}". You should only throw errors.`);if(a instanceof oC)throw a.originalError;const s=Number.isFinite(i.retries)?Math.max(0,i.retries-r):i.retries,o=i.maxRetryTime??Number.POSITIVE_INFINITY,c=Object.freeze({error:a,attemptNumber:t,retriesLeft:s,retriesConsumed:r});if(await i.onFailedAttempt(c),bg(n,o)<=0)throw a;const u=await i.shouldConsumeRetry(c),d=bg(n,o);if(d<=0||s<=0)throw a;if(a instanceof TypeError&&!aC(a)){if(u)throw a;return i.signal?.throwIfAborted(),!1}if(!await i.shouldRetry(c))throw a;if(!u)return i.signal?.throwIfAborted(),!1;const h=cC(r,i),p=Math.min(h,d);return p>0&&await new Promise((y,g)=>{const w=()=>{clearTimeout(b),i.signal?.removeEventListener("abort",w),g(i.signal.reason)},b=setTimeout(()=>{i.signal?.removeEventListener("abort",w),y()},p);i.unref&&b.unref?.(),i.signal?.addEventListener("abort",w,{once:!0})}),i.signal?.throwIfAborted(),!0}async function jd(e,t={}){if(t={...t},sC(t.retries),Object.hasOwn(t,"forever"))throw new Error("The `forever` option is no longer supported. For many use-cases, you can set `retries: Infinity` instead.");t.retries??=10,t.factor??=2,t.minTimeout??=1e3,t.maxTimeout??=Number.POSITIVE_INFINITY,t.maxRetryTime??=Number.POSITIVE_INFINITY,t.randomize??=!1,t.onFailedAttempt??=()=>{},t.shouldRetry??=()=>!0,t.shouldConsumeRetry??=()=>!0,Io("factor",t.factor,{min:0,allowInfinity:!1}),Io("minTimeout",t.minTimeout,{min:0,allowInfinity:!1}),Io("maxTimeout",t.maxTimeout,{min:0,allowInfinity:!0}),Io("maxRetryTime",t.maxRetryTime,{min:0,allowInfinity:!0}),t.factor>0||(t.factor=1),t.signal?.throwIfAborted();let r=0,n=0;const i=performance.now();for(;!Number.isFinite(t.retries)||n<=t.retries;){r++;try{t.signal?.throwIfAborted();const a=await e(r);return t.signal?.throwIfAborted(),a}catch(a){await uC({error:a,attemptNumber:r,retriesConsumed:n,startTime:i,options:t})&&n++}}throw new Error("Retry attempts exhausted without throwing an error.")}var lC={};bt(lC,{AsyncCaller:()=>Kf});const dC=[400,401,402,403,404,405,406,407,409],fC=e=>{if(e.message.startsWith("Cancel")||e.message.startsWith("AbortError")||e.name==="AbortError"||e?.code==="ECONNABORTED")throw e;const t=e?.response?.status??e?.status;if(t&&dC.includes(+t))throw e;if(e?.error?.code==="insufficient_quota"){const r=new Error(e?.message);throw r.name="InsufficientQuotaError",r}};var Kf=class{maxConcurrency;maxRetries;onFailedAttempt;queue;constructor(e){this.maxConcurrency=e.maxConcurrency??1/0,this.maxRetries=e.maxRetries??6,this.onFailedAttempt=e.onFailedAttempt??fC;const t="default"in nn?nn.default:nn;this.queue=new t({concurrency:this.maxConcurrency})}call(e,...t){return this.queue.add(()=>jd(()=>e(...t).catch(r=>{throw r instanceof Error?r:new Error(r)}),{onFailedAttempt:({error:r})=>this.onFailedAttempt?.(r),retries:this.maxRetries,randomize:!0}),{throwOnTimeout:!0})}callWithOptions(e,t,...r){if(e.signal){let n;return Promise.race([this.call(t,...r),new Promise((i,a)=>{n=()=>{a(sc(e.signal))},e.signal?.addEventListener("abort",n)})]).finally(()=>{e.signal&&n&&e.signal.removeEventListener("abort",n)})}return this.call(t,...r)}fetch(...e){return this.call(()=>fetch(...e).then(t=>t.ok?t:Promise.reject(t)))}},mw=class extends _a{name="RootListenersTracer";rootId;config;argOnStart;argOnEnd;argOnError;constructor({config:e,onStart:t,onEnd:r,onError:n}){super({_awaitHandler:!0}),this.config=e,this.argOnStart=t,this.argOnEnd=r,this.argOnError=n}persistRun(e){return Promise.resolve()}async onRunCreate(e){this.rootId||(this.rootId=e.id,this.argOnStart&&await this.argOnStart(e,this.config))}async onRunUpdate(e){e.id===this.rootId&&(e.error?this.argOnError&&await this.argOnError(e,this.config):this.argOnEnd&&await this.argOnEnd(e,this.config))}};function Gf(e){return e?e.lc_runnable:!1}var hC=class{includeNames;includeTypes;includeTags;excludeNames;excludeTypes;excludeTags;constructor(e){this.includeNames=e.includeNames,this.includeTypes=e.includeTypes,this.includeTags=e.includeTags,this.excludeNames=e.excludeNames,this.excludeTypes=e.excludeTypes,this.excludeTags=e.excludeTags}includeEvent(e,t){let r=this.includeNames===void 0&&this.includeTypes===void 0&&this.includeTags===void 0;const n=e.tags??[];return this.includeNames!==void 0&&(r=r||this.includeNames.includes(e.name)),this.includeTypes!==void 0&&(r=r||this.includeTypes.includes(t)),this.includeTags!==void 0&&(r=r||n.some(i=>this.includeTags?.includes(i))),this.excludeNames!==void 0&&(r=r&&!this.excludeNames.includes(e.name)),this.excludeTypes!==void 0&&(r=r&&!this.excludeTypes.includes(t)),this.excludeTags!==void 0&&(r=r&&n.every(i=>!this.excludeTags?.includes(i))),r}};function jc(e,t,r){function n(o,c){if(o._zod||Object.defineProperty(o,"_zod",{value:{def:c,constr:s,traits:new Set},enumerable:!1}),o._zod.traits.has(e))return;o._zod.traits.add(e),t(o,c);const u=s.prototype,d=Object.keys(u);for(let h=0;h<d.length;h++){const p=d[h];p in o||(o[p]=u[p].bind(o))}}const i=r?.Parent??Object;class a extends i{}Object.defineProperty(a,"name",{value:e});function s(o){var c;const u=r?.Parent?new a:this;n(u,o),(c=u._zod).deferred??(c.deferred=[]);for(const d of u._zod.deferred)d();return u}return Object.defineProperty(s,"init",{value:n}),Object.defineProperty(s,Symbol.hasInstance,{value:o=>r?.Parent&&o instanceof r.Parent?!0:o?._zod?.traits?.has(e)}),Object.defineProperty(s,"name",{value:e}),s}class Uo extends Error{constructor(){super("Encountered Promise during synchronous parse. Use .parseAsync() instead.")}}const pC={};function Wf(e){return pC}function mC(e){const t=Object.values(e).filter(n=>typeof n=="number");return Object.entries(e).filter(([n,i])=>t.indexOf(+n)===-1).map(([n,i])=>i)}function gC(e,t){return typeof t=="bigint"?t.toString():t}const yC="captureStackTrace"in Error?Error.captureStackTrace:(...e)=>{};function lc(e,t,r){const n=new e._zod.constr(t??e._zod.def);return(!t||r?.parent)&&(n._zod.parent=e),n}function vC(e){return{}}function Oo(e,t=0){if(e.aborted===!0)return!0;for(let r=t;r<e.issues.length;r++)if(e.issues[r]?.continue!==!0)return!0;return!1}function To(e){return typeof e=="string"?e:e?.message}function Vf(e,t,r){const n={...e,path:e.path??[]};if(!e.message){const i=To(e.inst?._zod.def?.error?.(e))??To(t?.error?.(e))??To(r.customError?.(e))??To(r.localeError?.(e))??"Invalid input";n.message=i}return delete n.inst,delete n.continue,t?.reportInput||delete n.input,n}const gw=(e,t)=>{e.name="$ZodError",Object.defineProperty(e,"_zod",{value:e._zod,enumerable:!1}),Object.defineProperty(e,"issues",{value:t,enumerable:!1}),e.message=JSON.stringify(t,gC,2),Object.defineProperty(e,"toString",{value:()=>e.message,enumerable:!1})},_C=jc("$ZodError",gw),Zf=jc("$ZodError",gw,{Parent:Error}),wC=e=>async(t,r,n,i)=>{const a=n?Object.assign(n,{async:!0}):{async:!0};let s=t._zod.run({value:r,issues:[]},a);if(s instanceof Promise&&(s=await s),s.issues.length){const o=new(i?.Err??e)(s.issues.map(c=>Vf(c,a,Wf())));throw yC(o,i?.callee),o}return s.value},bC=wC(Zf),EC=e=>(t,r,n)=>{const i=n?{...n,async:!1}:{async:!1},a=t._zod.run({value:r,issues:[]},i);if(a instanceof Promise)throw new Uo;return a.issues.length?{success:!1,error:new(e??_C)(a.issues.map(s=>Vf(s,i,Wf())))}:{success:!0,data:a.value}},xC=EC(Zf),SC=e=>async(t,r,n)=>{const i=n?Object.assign(n,{async:!0}):{async:!0};let a=t._zod.run({value:r,issues:[]},i);return a instanceof Promise&&(a=await a),a.issues.length?{success:!1,error:new e(a.issues.map(s=>Vf(s,i,Wf())))}:{success:!0,data:a.value}},kC=SC(Zf),IC={major:4,minor:1,patch:13},OC=jc("$ZodType",(e,t)=>{var r;e??(e={}),e._zod.def=t,e._zod.bag=e._zod.bag||{},e._zod.version=IC;const n=[...e._zod.def.checks??[]];e._zod.traits.has("$ZodCheck")&&n.unshift(e);for(const i of n)for(const a of i._zod.onattach)a(e);if(n.length===0)(r=e._zod).deferred??(r.deferred=[]),e._zod.deferred?.push(()=>{e._zod.run=e._zod.parse});else{const i=(s,o,c)=>{let u=Oo(s),d;for(const h of o){if(h._zod.def.when){if(!h._zod.def.when(s))continue}else if(u)continue;const p=s.issues.length,y=h._zod.check(s);if(y instanceof Promise&&c?.async===!1)throw new Uo;if(d||y instanceof Promise)d=(d??Promise.resolve()).then(async()=>{await y,s.issues.length!==p&&(u||(u=Oo(s,p)))});else{if(s.issues.length===p)continue;u||(u=Oo(s,p))}}return d?d.then(()=>s):s},a=(s,o,c)=>{if(Oo(s))return s.aborted=!0,s;const u=i(o,n,c);if(u instanceof Promise){if(c.async===!1)throw new Uo;return u.then(d=>e._zod.parse(d,c))}return e._zod.parse(u,c)};e._zod.run=(s,o)=>{if(o.skipChecks)return e._zod.parse(s,o);if(o.direction==="backward"){const u=e._zod.parse({value:s.value,issues:[]},{...o,skipChecks:!0});return u instanceof Promise?u.then(d=>a(d,s,o)):a(u,s,o)}const c=e._zod.parse(s,o);if(c instanceof Promise){if(o.async===!1)throw new Uo;return c.then(u=>i(u,n,o))}return i(c,n,o)}}e["~standard"]={validate:i=>{try{const a=xC(e,i);return a.success?{value:a.data}:{issues:a.error?.issues}}catch{return kC(e,i).then(s=>s.success?{value:s.data}:{issues:s.error?.issues})}},vendor:"zod",version:1}}),TC=jc("$ZodNever",(e,t)=>{OC.init(e,t),e._zod.parse=(r,n)=>(r.issues.push({expected:"never",code:"invalid_type",input:r.value,inst:e}),r)});var Eg;class yw{constructor(){this._map=new WeakMap,this._idmap=new Map}add(t,...r){const n=r[0];if(this._map.set(t,n),n&&typeof n=="object"&&"id"in n){if(this._idmap.has(n.id))throw new Error(`ID ${n.id} already exists in the registry`);this._idmap.set(n.id,t)}return this}clear(){return this._map=new WeakMap,this._idmap=new Map,this}remove(t){const r=this._map.get(t);return r&&typeof r=="object"&&"id"in r&&this._idmap.delete(r.id),this._map.delete(t),this}get(t){const r=t._zod.parent;if(r){const n={...this.get(r)??{}};delete n.id;const i={...n,...this._map.get(t)};return Object.keys(i).length?i:void 0}return this._map.get(t)}has(t){return this._map.has(t)}}function RC(){return new yw}(Eg=globalThis).__zod_globalRegistry??(Eg.__zod_globalRegistry=RC());const Rn=globalThis.__zod_globalRegistry;function AC(e,t){return new e({type:"never",...vC()})}class xg{constructor(t){this.counter=0,this.metadataRegistry=t?.metadata??Rn,this.target=t?.target??"draft-2020-12",this.unrepresentable=t?.unrepresentable??"throw",this.override=t?.override??(()=>{}),this.io=t?.io??"output",this.seen=new Map}process(t,r={path:[],schemaPath:[]}){var n;const i=t._zod.def,a={guid:"uuid",url:"uri",datetime:"date-time",json_string:"json-string",regex:""},s=this.seen.get(t);if(s)return s.count++,r.schemaPath.includes(t)&&(s.cycle=r.path),s.schema;const o={schema:{},count:1,cycle:void 0,path:r.path};this.seen.set(t,o);const c=t._zod.toJSONSchema?.();if(c)o.schema=c;else{const h={...r,schemaPath:[...r.schemaPath,t],path:r.path},p=t._zod.parent;if(p)o.ref=p,this.process(p,h),this.seen.get(p).isParent=!0;else{const y=o.schema;switch(i.type){case"string":{const g=y;g.type="string";const{minimum:w,maximum:b,format:S,patterns:O,contentEncoding:T}=t._zod.bag;if(typeof w=="number"&&(g.minLength=w),typeof b=="number"&&(g.maxLength=b),S&&(g.format=a[S]??S,g.format===""&&delete g.format),T&&(g.contentEncoding=T),O&&O.size>0){const z=[...O];z.length===1?g.pattern=z[0].source:z.length>1&&(o.schema.allOf=[...z.map(B=>({...this.target==="draft-7"||this.target==="draft-4"||this.target==="openapi-3.0"?{type:"string"}:{},pattern:B.source}))])}break}case"number":{const g=y,{minimum:w,maximum:b,format:S,multipleOf:O,exclusiveMaximum:T,exclusiveMinimum:z}=t._zod.bag;typeof S=="string"&&S.includes("int")?g.type="integer":g.type="number",typeof z=="number"&&(this.target==="draft-4"||this.target==="openapi-3.0"?(g.minimum=z,g.exclusiveMinimum=!0):g.exclusiveMinimum=z),typeof w=="number"&&(g.minimum=w,typeof z=="number"&&this.target!=="draft-4"&&(z>=w?delete g.minimum:delete g.exclusiveMinimum)),typeof T=="number"&&(this.target==="draft-4"||this.target==="openapi-3.0"?(g.maximum=T,g.exclusiveMaximum=!0):g.exclusiveMaximum=T),typeof b=="number"&&(g.maximum=b,typeof T=="number"&&this.target!=="draft-4"&&(T<=b?delete g.maximum:delete g.exclusiveMaximum)),typeof O=="number"&&(g.multipleOf=O);break}case"boolean":{const g=y;g.type="boolean";break}case"bigint":{if(this.unrepresentable==="throw")throw new Error("BigInt cannot be represented in JSON Schema");break}case"symbol":{if(this.unrepresentable==="throw")throw new Error("Symbols cannot be represented in JSON Schema");break}case"null":{this.target==="openapi-3.0"?(y.type="string",y.nullable=!0,y.enum=[null]):y.type="null";break}case"any":break;case"unknown":break;case"undefined":{if(this.unrepresentable==="throw")throw new Error("Undefined cannot be represented in JSON Schema");break}case"void":{if(this.unrepresentable==="throw")throw new Error("Void cannot be represented in JSON Schema");break}case"never":{y.not={};break}case"date":{if(this.unrepresentable==="throw")throw new Error("Date cannot be represented in JSON Schema");break}case"array":{const g=y,{minimum:w,maximum:b}=t._zod.bag;typeof w=="number"&&(g.minItems=w),typeof b=="number"&&(g.maxItems=b),g.type="array",g.items=this.process(i.element,{...h,path:[...h.path,"items"]});break}case"object":{const g=y;g.type="object",g.properties={};const w=i.shape;for(const O in w)g.properties[O]=this.process(w[O],{...h,path:[...h.path,"properties",O]});const b=new Set(Object.keys(w)),S=new Set([...b].filter(O=>{const T=i.shape[O]._zod;return this.io==="input"?T.optin===void 0:T.optout===void 0}));S.size>0&&(g.required=Array.from(S)),i.catchall?._zod.def.type==="never"?g.additionalProperties=!1:i.catchall?i.catchall&&(g.additionalProperties=this.process(i.catchall,{...h,path:[...h.path,"additionalProperties"]})):this.io==="output"&&(g.additionalProperties=!1);break}case"union":{const g=y,w=i.discriminator!==void 0,b=i.options.map((S,O)=>this.process(S,{...h,path:[...h.path,w?"oneOf":"anyOf",O]}));w?g.oneOf=b:g.anyOf=b;break}case"intersection":{const g=y,w=this.process(i.left,{...h,path:[...h.path,"allOf",0]}),b=this.process(i.right,{...h,path:[...h.path,"allOf",1]}),S=T=>"allOf"in T&&Object.keys(T).length===1,O=[...S(w)?w.allOf:[w],...S(b)?b.allOf:[b]];g.allOf=O;break}case"tuple":{const g=y;g.type="array";const w=this.target==="draft-2020-12"?"prefixItems":"items",b=this.target==="draft-2020-12"||this.target==="openapi-3.0"?"items":"additionalItems",S=i.items.map((B,G)=>this.process(B,{...h,path:[...h.path,w,G]})),O=i.rest?this.process(i.rest,{...h,path:[...h.path,b,...this.target==="openapi-3.0"?[i.items.length]:[]]}):null;this.target==="draft-2020-12"?(g.prefixItems=S,O&&(g.items=O)):this.target==="openapi-3.0"?(g.items={anyOf:S},O&&g.items.anyOf.push(O),g.minItems=S.length,O||(g.maxItems=S.length)):(g.items=S,O&&(g.additionalItems=O));const{minimum:T,maximum:z}=t._zod.bag;typeof T=="number"&&(g.minItems=T),typeof z=="number"&&(g.maxItems=z);break}case"record":{const g=y;g.type="object",(this.target==="draft-7"||this.target==="draft-2020-12")&&(g.propertyNames=this.process(i.keyType,{...h,path:[...h.path,"propertyNames"]})),g.additionalProperties=this.process(i.valueType,{...h,path:[...h.path,"additionalProperties"]});break}case"map":{if(this.unrepresentable==="throw")throw new Error("Map cannot be represented in JSON Schema");break}case"set":{if(this.unrepresentable==="throw")throw new Error("Set cannot be represented in JSON Schema");break}case"enum":{const g=y,w=mC(i.entries);w.every(b=>typeof b=="number")&&(g.type="number"),w.every(b=>typeof b=="string")&&(g.type="string"),g.enum=w;break}case"literal":{const g=y,w=[];for(const b of i.values)if(b===void 0){if(this.unrepresentable==="throw")throw new Error("Literal `undefined` cannot be represented in JSON Schema")}else if(typeof b=="bigint"){if(this.unrepresentable==="throw")throw new Error("BigInt literals cannot be represented in JSON Schema");w.push(Number(b))}else w.push(b);if(w.length!==0)if(w.length===1){const b=w[0];g.type=b===null?"null":typeof b,this.target==="draft-4"||this.target==="openapi-3.0"?g.enum=[b]:g.const=b}else w.every(b=>typeof b=="number")&&(g.type="number"),w.every(b=>typeof b=="string")&&(g.type="string"),w.every(b=>typeof b=="boolean")&&(g.type="string"),w.every(b=>b===null)&&(g.type="null"),g.enum=w;break}case"file":{const g=y,w={type:"string",format:"binary",contentEncoding:"binary"},{minimum:b,maximum:S,mime:O}=t._zod.bag;b!==void 0&&(w.minLength=b),S!==void 0&&(w.maxLength=S),O?O.length===1?(w.contentMediaType=O[0],Object.assign(g,w)):g.anyOf=O.map(T=>({...w,contentMediaType:T})):Object.assign(g,w);break}case"transform":{if(this.unrepresentable==="throw")throw new Error("Transforms cannot be represented in JSON Schema");break}case"nullable":{const g=this.process(i.innerType,h);this.target==="openapi-3.0"?(o.ref=i.innerType,y.nullable=!0):y.anyOf=[g,{type:"null"}];break}case"nonoptional":{this.process(i.innerType,h),o.ref=i.innerType;break}case"success":{const g=y;g.type="boolean";break}case"default":{this.process(i.innerType,h),o.ref=i.innerType,y.default=JSON.parse(JSON.stringify(i.defaultValue));break}case"prefault":{this.process(i.innerType,h),o.ref=i.innerType,this.io==="input"&&(y._prefault=JSON.parse(JSON.stringify(i.defaultValue)));break}case"catch":{this.process(i.innerType,h),o.ref=i.innerType;let g;try{g=i.catchValue(void 0)}catch{throw new Error("Dynamic catch values are not supported in JSON Schema")}y.default=g;break}case"nan":{if(this.unrepresentable==="throw")throw new Error("NaN cannot be represented in JSON Schema");break}case"template_literal":{const g=y,w=t._zod.pattern;if(!w)throw new Error("Pattern not found in template literal");g.type="string",g.pattern=w.source;break}case"pipe":{const g=this.io==="input"?i.in._zod.def.type==="transform"?i.out:i.in:i.out;this.process(g,h),o.ref=g;break}case"readonly":{this.process(i.innerType,h),o.ref=i.innerType,y.readOnly=!0;break}case"promise":{this.process(i.innerType,h),o.ref=i.innerType;break}case"optional":{this.process(i.innerType,h),o.ref=i.innerType;break}case"lazy":{const g=t._zod.innerType;this.process(g,h),o.ref=g;break}case"custom":{if(this.unrepresentable==="throw")throw new Error("Custom types cannot be represented in JSON Schema");break}case"function":{if(this.unrepresentable==="throw")throw new Error("Function types cannot be represented in JSON Schema");break}}}}const u=this.metadataRegistry.get(t);return u&&Object.assign(o.schema,u),this.io==="input"&&Ft(t)&&(delete o.schema.examples,delete o.schema.default),this.io==="input"&&o.schema._prefault&&((n=o.schema).default??(n.default=o.schema._prefault)),delete o.schema._prefault,this.seen.get(t).schema}emit(t,r){const n={cycles:r?.cycles??"ref",reused:r?.reused??"inline",external:r?.external??void 0},i=this.seen.get(t);if(!i)throw new Error("Unprocessed schema. This is a bug in Zod.");const a=d=>{const h=this.target==="draft-2020-12"?"$defs":"definitions";if(n.external){const w=n.external.registry.get(d[0])?.id,b=n.external.uri??(O=>O);if(w)return{ref:b(w)};const S=d[1].defId??d[1].schema.id??`schema${this.counter++}`;return d[1].defId=S,{defId:S,ref:`${b("__shared")}#/${h}/${S}`}}if(d[1]===i)return{ref:"#"};const y=`#/${h}/`,g=d[1].schema.id??`__schema${this.counter++}`;return{defId:g,ref:y+g}},s=d=>{if(d[1].schema.$ref)return;const h=d[1],{ref:p,defId:y}=a(d);h.def={...h.schema},y&&(h.defId=y);const g=h.schema;for(const w in g)delete g[w];g.$ref=p};if(n.cycles==="throw")for(const d of this.seen.entries()){const h=d[1];if(h.cycle)throw new Error(`Cycle detected: #/${h.cycle?.join("/")}/<root>

Set the \`cycles\` parameter to \`"ref"\` to resolve cyclical schemas with defs.`)}for(const d of this.seen.entries()){const h=d[1];if(t===d[0]){s(d);continue}if(n.external){const y=n.external.registry.get(d[0])?.id;if(t!==d[0]&&y){s(d);continue}}if(this.metadataRegistry.get(d[0])?.id){s(d);continue}if(h.cycle){s(d);continue}if(h.count>1&&n.reused==="ref"){s(d);continue}}const o=(d,h)=>{const p=this.seen.get(d),y=p.def??p.schema,g={...y};if(p.ref===null)return;const w=p.ref;if(p.ref=null,w){o(w,h);const b=this.seen.get(w).schema;b.$ref&&(h.target==="draft-7"||h.target==="draft-4"||h.target==="openapi-3.0")?(y.allOf=y.allOf??[],y.allOf.push(b)):(Object.assign(y,b),Object.assign(y,g))}p.isParent||this.override({zodSchema:d,jsonSchema:y,path:p.path??[]})};for(const d of[...this.seen.entries()].reverse())o(d[0],{target:this.target});const c={};if(this.target==="draft-2020-12"?c.$schema="https://json-schema.org/draft/2020-12/schema":this.target==="draft-7"?c.$schema="http://json-schema.org/draft-07/schema#":this.target==="draft-4"?c.$schema="http://json-schema.org/draft-04/schema#":this.target==="openapi-3.0"||console.warn(`Invalid target: ${this.target}`),n.external?.uri){const d=n.external.registry.get(t)?.id;if(!d)throw new Error("Schema is missing an `id` property");c.$id=n.external.uri(d)}Object.assign(c,i.def);const u=n.external?.defs??{};for(const d of this.seen.entries()){const h=d[1];h.def&&h.defId&&(u[h.defId]=h.def)}n.external||Object.keys(u).length>0&&(this.target==="draft-2020-12"?c.$defs=u:c.definitions=u);try{return JSON.parse(JSON.stringify(c))}catch{throw new Error("Error converting schema to JSON.")}}}function Sg(e,t){if(e instanceof yw){const n=new xg(t),i={};for(const o of e._idmap.entries()){const[c,u]=o;n.process(u)}const a={},s={registry:e,uri:t?.uri,defs:i};for(const o of e._idmap.entries()){const[c,u]=o;a[c]=n.emit(u,{...t,external:s})}if(Object.keys(i).length>0){const o=n.target==="draft-2020-12"?"$defs":"definitions";a.__shared={[o]:i}}return{schemas:a}}const r=new xg(t);return r.process(e),r.emit(e,t)}function Ft(e,t){const r=t??{seen:new Set};if(r.seen.has(e))return!1;r.seen.add(e);const n=e._zod.def;if(n.type==="transform")return!0;if(n.type==="array")return Ft(n.element,r);if(n.type==="set")return Ft(n.valueType,r);if(n.type==="lazy")return Ft(n.getter(),r);if(n.type==="promise"||n.type==="optional"||n.type==="nonoptional"||n.type==="nullable"||n.type==="readonly"||n.type==="default"||n.type==="prefault")return Ft(n.innerType,r);if(n.type==="intersection")return Ft(n.left,r)||Ft(n.right,r);if(n.type==="record"||n.type==="map")return Ft(n.keyType,r)||Ft(n.valueType,r);if(n.type==="pipe")return Ft(n.in,r)||Ft(n.out,r);if(n.type==="object"){for(const i in n.shape)if(Ft(n.shape[i],r))return!0;return!1}if(n.type==="union"){for(const i of n.options)if(Ft(i,r))return!0;return!1}if(n.type==="tuple"){for(const i of n.items)if(Ft(i,r))return!0;return!!(n.rest&&Ft(n.rest,r))}return!1}function gn(e){if(typeof e!="object"||e===null)return!1;const t=e;if(!("_zod"in t))return!1;const r=t._zod;return typeof r=="object"&&r!==null&&"def"in r}function Un(e){if(typeof e!="object"||e===null)return!1;const t=e;if(!("_def"in t)||"_zod"in t)return!1;const r=t._def;return typeof r=="object"&&r!=null&&"typeName"in r}function $C(e){return!e||typeof e!="object"||Array.isArray(e)?!1:!!(gn(e)||Un(e))}async function CC(e,t){if(gn(e))return await bC(e,t);if(Un(e))return await e.parseAsync(t);throw new Error("Schema must be an instance of z3.ZodType or z4.$ZodType")}function PC(e){if(gn(e))return Rn.get(e)?.description;if(Un(e)||"description"in e&&typeof e.description=="string")return e.description}function NC(e){return $C(e)?Un(e)?e._def.typeName==="ZodString":gn(e)?e._zod.def.type==="string":!1:!1}function Xa(e){return gn(e)?typeof e=="object"&&e!==null&&"_zod"in e&&typeof e._zod=="object"&&e._zod!==null&&"def"in e._zod&&typeof e._zod.def=="object"&&e._zod.def!==null&&"type"in e._zod.def&&e._zod.def.type==="object":!1}function vw(e){return gn(e)?typeof e=="object"&&e!==null&&"_zod"in e&&typeof e._zod=="object"&&e._zod!==null&&"def"in e._zod&&typeof e._zod.def=="object"&&e._zod.def!==null&&"type"in e._zod.def&&e._zod.def.type==="array":!1}function Fd(e,t=!1){if(Un(e))return e.strict();if(Xa(e)){const r=e._zod.def.shape;if(t)for(const[a,s]of Object.entries(e._zod.def.shape)){if(Xa(s)){const c=Fd(s,t);r[a]=c}else if(vw(s)){let c=s._zod.def.element;Xa(c)&&(c=Fd(c,t)),r[a]=lc(s,{...s._zod.def,element:c})}else r[a]=s;const o=Rn.get(s);o&&Rn.add(r[a],o)}const n=lc(e,{...e._zod.def,shape:r,catchall:AC(TC)}),i=Rn.get(e);return i&&Rn.add(n,i),n}throw new Error("Schema must be an instance of z3.ZodObject or z4.$ZodObject")}function DC(e){return Un(e)&&"typeName"in e._def&&e._def.typeName==="ZodEffects"}function MC(e){return gn(e)&&e._zod.def.type==="pipe"}function Ua(e,t,r){const n=r.get(e);if(n!==void 0)return n;if(Un(e))return DC(e)?Ua(e._def.schema,t,r):e;if(gn(e)){let i=e;if(MC(e)&&(i=Ua(e._zod.def.in,t,r)),t){if(Xa(i)){const s=i._zod.def.shape;for(const[o,c]of Object.entries(i._zod.def.shape))s[o]=Ua(c,t,r);i=lc(i,{...i._zod.def,shape:s})}else if(vw(i)){const s=Ua(i._zod.def.element,t,r);i=lc(i,{...i._zod.def,element:s})}}const a=Rn.get(e);return a&&Rn.add(i,a),r.set(e,i),i}throw new Error("Schema must be an instance of z3.ZodType or z4.$ZodType")}function LC(e,t=!1){return Ua(e,t,new WeakMap)}function Zl(e){return e.replace(/[^a-zA-Z-_0-9]/g,"_")}const jC=["*","_","`"];function FC(e){let t="";for(const[r,n]of Object.entries(e))t+=`	classDef ${r} ${n};
`;return t}function BC(e,t,r){const{firstNode:n,lastNode:i,nodeColors:a,withStyles:s=!0,curveStyle:o="linear",wrapLabelNWords:c=9}=r??{};let u=s?`%%{init: {'flowchart': {'curve': '${o}'}}}%%
graph TD;
`:`graph TD;
`;if(s){const y="default",g={[y]:"{0}({1})"};n!==void 0&&(g[n]="{0}([{1}]):::first"),i!==void 0&&(g[i]="{0}([{1}]):::last");for(const[w,b]of Object.entries(e)){const S=b.name.split(":").pop()??"";let T=jC.some(B=>S.startsWith(B)&&S.endsWith(B))?`<p>${S}</p>`:S;Object.keys(b.metadata??{}).length&&(T+=`<hr/><small><em>${Object.entries(b.metadata??{}).map(([B,G])=>`${B} = ${G}`).join(`
`)}</em></small>`);const z=(g[w]??g[y]).replace("{0}",Zl(w)).replace("{1}",T);u+=`	${z}
`}}const d={};for(const y of t){const g=y.source.split(":"),w=y.target.split(":"),b=g.filter((S,O)=>S===w[O]).join(":");d[b]||(d[b]=[]),d[b].push(y)}const h=new Set;function p(y,g){const w=y.length===1&&y[0].source===y[0].target;if(g&&!w){const b=g.split(":").pop();if(h.has(b))throw new Error(`Found duplicate subgraph '${b}' -- this likely means that you're reusing a subgraph node with the same name. Please adjust your graph to have subgraph nodes with unique names.`);h.add(b),u+=`	subgraph ${b}
`}for(const b of y){const{source:S,target:O,data:T,conditional:z}=b;let B="";if(T!==void 0){let G=T;const q=G.split(" ");q.length>c&&(G=Array.from({length:Math.ceil(q.length/c)},(K,Oe)=>q.slice(Oe*c,(Oe+1)*c).join(" ")).join("&nbsp;<br>&nbsp;")),B=z?` -. &nbsp;${G}&nbsp; .-> `:` -- &nbsp;${G}&nbsp; --> `}else B=z?" -.-> ":" --> ";u+=`	${Zl(S)}${B}${Zl(O)};
`}for(const b in d)b.startsWith(`${g}:`)&&b!==g&&p(d[b],b);g&&!w&&(u+=`	end
`)}p(d[""]??[],"");for(const y in d)!y.includes(":")&&y!==""&&p(d[y],y);return s&&(u+=FC(a??{})),u}async function zC(e,t){let r=t?.backgroundColor??"white";const n=t?.imageType??"png",i=btoa(e);r!==void 0&&(/^#(?:[0-9a-fA-F]{3}){1,2}$/.test(r)||(r=`!${r}`));const a=`https://mermaid.ink/img/${i}?bgColor=${r}&type=${n}`,s=await fetch(a);if(!s.ok)throw new Error(["Failed to render the graph using the Mermaid.INK API.",`Status code: ${s.status}`,`Status text: ${s.statusText}`].join(`
`));return await s.blob()}const UC=Symbol("Let zodToJsonSchema decide on which parser to use"),qC={name:void 0,$refStrategy:"root",basePath:["#"],effectStrategy:"input",pipeStrategy:"all",dateStrategy:"format:date-time",mapStrategy:"entries",removeAdditionalStrategy:"passthrough",allowedAdditionalProperties:!0,rejectedAdditionalProperties:!1,definitionPath:"definitions",target:"jsonSchema7",strictUnions:!1,definitions:{},errorMessages:!1,markdownDescription:!1,patternStrategy:"escape",applyRegexFlags:!1,emailStrategy:"format:email",base64Strategy:"contentEncoding:base64",nameStrategy:"ref",openAiAnyTypeName:"OpenAiAnyType"},HC=e=>({...qC,...e}),KC=e=>{const t=HC(e),r=t.name!==void 0?[...t.basePath,t.definitionPath,t.name]:t.basePath;return{...t,flags:{hasReferencedOpenAiAnyType:!1},currentPath:r,propertyPath:void 0,seen:new Map(Object.entries(t.definitions).map(([n,i])=>[i._def,{def:i._def,path:[...t.basePath,t.definitionPath,n],jsonSchema:void 0}]))}},_w=(e,t)=>{let r=0;for(;r<e.length&&r<t.length&&e[r]===t[r];r++);return[(e.length-r).toString(),...t.slice(r)].join("/")};function Vt(e){if(e.target!=="openAi")return{};const t=[...e.basePath,e.definitionPath,e.openAiAnyTypeName];return e.flags.hasReferencedOpenAiAnyType=!0,{$ref:e.$refStrategy==="relative"?_w(t,e.currentPath):t.join("/")}}function ww(e,t,r,n){n?.errorMessages&&r&&(e.errorMessage={...e.errorMessage,[t]:r})}function Ye(e,t,r,n,i){e[t]=r,ww(e,t,n,i)}var Je;(function(e){e.assertEqual=i=>{};function t(i){}e.assertIs=t;function r(i){throw new Error}e.assertNever=r,e.arrayToEnum=i=>{const a={};for(const s of i)a[s]=s;return a},e.getValidEnumValues=i=>{const a=e.objectKeys(i).filter(o=>typeof i[i[o]]!="number"),s={};for(const o of a)s[o]=i[o];return e.objectValues(s)},e.objectValues=i=>e.objectKeys(i).map(function(a){return i[a]}),e.objectKeys=typeof Object.keys=="function"?i=>Object.keys(i):i=>{const a=[];for(const s in i)Object.prototype.hasOwnProperty.call(i,s)&&a.push(s);return a},e.find=(i,a)=>{for(const s of i)if(a(s))return s},e.isInteger=typeof Number.isInteger=="function"?i=>Number.isInteger(i):i=>typeof i=="number"&&Number.isFinite(i)&&Math.floor(i)===i;function n(i,a=" | "){return i.map(s=>typeof s=="string"?`'${s}'`:s).join(a)}e.joinValues=n,e.jsonStringifyReplacer=(i,a)=>typeof a=="bigint"?a.toString():a})(Je||(Je={}));var kg;(function(e){e.mergeShapes=(t,r)=>({...t,...r})})(kg||(kg={}));const pe=Je.arrayToEnum(["string","nan","number","integer","float","boolean","date","bigint","symbol","function","undefined","null","array","object","unknown","promise","void","never","map","set"]),Tn=e=>{switch(typeof e){case"undefined":return pe.undefined;case"string":return pe.string;case"number":return Number.isNaN(e)?pe.nan:pe.number;case"boolean":return pe.boolean;case"function":return pe.function;case"bigint":return pe.bigint;case"symbol":return pe.symbol;case"object":return Array.isArray(e)?pe.array:e===null?pe.null:e.then&&typeof e.then=="function"&&e.catch&&typeof e.catch=="function"?pe.promise:typeof Map<"u"&&e instanceof Map?pe.map:typeof Set<"u"&&e instanceof Set?pe.set:typeof Date<"u"&&e instanceof Date?pe.date:pe.object;default:return pe.unknown}},J=Je.arrayToEnum(["invalid_type","invalid_literal","custom","invalid_union","invalid_union_discriminator","invalid_enum_value","unrecognized_keys","invalid_arguments","invalid_return_type","invalid_date","invalid_string","too_small","too_big","invalid_intersection_types","not_multiple_of","not_finite"]);class pn extends Error{get errors(){return this.issues}constructor(t){super(),this.issues=[],this.addIssue=n=>{this.issues=[...this.issues,n]},this.addIssues=(n=[])=>{this.issues=[...this.issues,...n]};const r=new.target.prototype;Object.setPrototypeOf?Object.setPrototypeOf(this,r):this.__proto__=r,this.name="ZodError",this.issues=t}format(t){const r=t||function(a){return a.message},n={_errors:[]},i=a=>{for(const s of a.issues)if(s.code==="invalid_union")s.unionErrors.map(i);else if(s.code==="invalid_return_type")i(s.returnTypeError);else if(s.code==="invalid_arguments")i(s.argumentsError);else if(s.path.length===0)n._errors.push(r(s));else{let o=n,c=0;for(;c<s.path.length;){const u=s.path[c];c===s.path.length-1?(o[u]=o[u]||{_errors:[]},o[u]._errors.push(r(s))):o[u]=o[u]||{_errors:[]},o=o[u],c++}}};return i(this),n}static assert(t){if(!(t instanceof pn))throw new Error(`Not a ZodError: ${t}`)}toString(){return this.message}get message(){return JSON.stringify(this.issues,Je.jsonStringifyReplacer,2)}get isEmpty(){return this.issues.length===0}flatten(t=r=>r.message){const r=Object.create(null),n=[];for(const i of this.issues)if(i.path.length>0){const a=i.path[0];r[a]=r[a]||[],r[a].push(t(i))}else n.push(t(i));return{formErrors:n,fieldErrors:r}}get formErrors(){return this.flatten()}}pn.create=e=>new pn(e);const Bd=(e,t)=>{let r;switch(e.code){case J.invalid_type:e.received===pe.undefined?r="Required":r=`Expected ${e.expected}, received ${e.received}`;break;case J.invalid_literal:r=`Invalid literal value, expected ${JSON.stringify(e.expected,Je.jsonStringifyReplacer)}`;break;case J.unrecognized_keys:r=`Unrecognized key(s) in object: ${Je.joinValues(e.keys,", ")}`;break;case J.invalid_union:r="Invalid input";break;case J.invalid_union_discriminator:r=`Invalid discriminator value. Expected ${Je.joinValues(e.options)}`;break;case J.invalid_enum_value:r=`Invalid enum value. Expected ${Je.joinValues(e.options)}, received '${e.received}'`;break;case J.invalid_arguments:r="Invalid function arguments";break;case J.invalid_return_type:r="Invalid function return type";break;case J.invalid_date:r="Invalid date";break;case J.invalid_string:typeof e.validation=="object"?"includes"in e.validation?(r=`Invalid input: must include "${e.validation.includes}"`,typeof e.validation.position=="number"&&(r=`${r} at one or more positions greater than or equal to ${e.validation.position}`)):"startsWith"in e.validation?r=`Invalid input: must start with "${e.validation.startsWith}"`:"endsWith"in e.validation?r=`Invalid input: must end with "${e.validation.endsWith}"`:Je.assertNever(e.validation):e.validation!=="regex"?r=`Invalid ${e.validation}`:r="Invalid";break;case J.too_small:e.type==="array"?r=`Array must contain ${e.exact?"exactly":e.inclusive?"at least":"more than"} ${e.minimum} element(s)`:e.type==="string"?r=`String must contain ${e.exact?"exactly":e.inclusive?"at least":"over"} ${e.minimum} character(s)`:e.type==="number"?r=`Number must be ${e.exact?"exactly equal to ":e.inclusive?"greater than or equal to ":"greater than "}${e.minimum}`:e.type==="bigint"?r=`Number must be ${e.exact?"exactly equal to ":e.inclusive?"greater than or equal to ":"greater than "}${e.minimum}`:e.type==="date"?r=`Date must be ${e.exact?"exactly equal to ":e.inclusive?"greater than or equal to ":"greater than "}${new Date(Number(e.minimum))}`:r="Invalid input";break;case J.too_big:e.type==="array"?r=`Array must contain ${e.exact?"exactly":e.inclusive?"at most":"less than"} ${e.maximum} element(s)`:e.type==="string"?r=`String must contain ${e.exact?"exactly":e.inclusive?"at most":"under"} ${e.maximum} character(s)`:e.type==="number"?r=`Number must be ${e.exact?"exactly":e.inclusive?"less than or equal to":"less than"} ${e.maximum}`:e.type==="bigint"?r=`BigInt must be ${e.exact?"exactly":e.inclusive?"less than or equal to":"less than"} ${e.maximum}`:e.type==="date"?r=`Date must be ${e.exact?"exactly":e.inclusive?"smaller than or equal to":"smaller than"} ${new Date(Number(e.maximum))}`:r="Invalid input";break;case J.custom:r="Invalid input";break;case J.invalid_intersection_types:r="Intersection results could not be merged";break;case J.not_multiple_of:r=`Number must be a multiple of ${e.multipleOf}`;break;case J.not_finite:r="Number must be finite";break;default:r=t.defaultError,Je.assertNever(e)}return{message:r}};let GC=Bd;function WC(){return GC}const VC=e=>{const{data:t,path:r,errorMaps:n,issueData:i}=e,a=[...r,...i.path||[]],s={...i,path:a};if(i.message!==void 0)return{...i,path:a,message:i.message};let o="";const c=n.filter(u=>!!u).slice().reverse();for(const u of c)o=u(s,{data:t,defaultError:o}).message;return{...i,path:a,message:o}};function le(e,t){const r=WC(),n=VC({issueData:t,data:e.data,path:e.path,errorMaps:[e.common.contextualErrorMap,e.schemaErrorMap,r,r===Bd?void 0:Bd].filter(i=>!!i)});e.common.issues.push(n)}class or{constructor(){this.value="valid"}dirty(){this.value==="valid"&&(this.value="dirty")}abort(){this.value!=="aborted"&&(this.value="aborted")}static mergeArray(t,r){const n=[];for(const i of r){if(i.status==="aborted")return Pe;i.status==="dirty"&&t.dirty(),n.push(i.value)}return{status:t.value,value:n}}static async mergeObjectAsync(t,r){const n=[];for(const i of r){const a=await i.key,s=await i.value;n.push({key:a,value:s})}return or.mergeObjectSync(t,n)}static mergeObjectSync(t,r){const n={};for(const i of r){const{key:a,value:s}=i;if(a.status==="aborted"||s.status==="aborted")return Pe;a.status==="dirty"&&t.dirty(),s.status==="dirty"&&t.dirty(),a.value!=="__proto__"&&(typeof s.value<"u"||i.alwaysSet)&&(n[a.value]=s.value)}return{status:t.value,value:n}}}const Pe=Object.freeze({status:"aborted"}),qa=e=>({status:"dirty",value:e}),_r=e=>({status:"valid",value:e}),Ig=e=>e.status==="aborted",Og=e=>e.status==="dirty",ca=e=>e.status==="valid",dc=e=>typeof Promise<"u"&&e instanceof Promise;var ge;(function(e){e.errToObj=t=>typeof t=="string"?{message:t}:t||{},e.toString=t=>typeof t=="string"?t:t?.message})(ge||(ge={}));class jn{constructor(t,r,n,i){this._cachedPath=[],this.parent=t,this.data=r,this._path=n,this._key=i}get path(){return this._cachedPath.length||(Array.isArray(this._key)?this._cachedPath.push(...this._path,...this._key):this._cachedPath.push(...this._path,this._key)),this._cachedPath}}const Tg=(e,t)=>{if(ca(t))return{success:!0,data:t.value};if(!e.common.issues.length)throw new Error("Validation failed but no issues detected.");return{success:!1,get error(){if(this._error)return this._error;const r=new pn(e.common.issues);return this._error=r,this._error}}};function Ue(e){if(!e)return{};const{errorMap:t,invalid_type_error:r,required_error:n,description:i}=e;if(t&&(r||n))throw new Error(`Can't use "invalid_type_error" or "required_error" in conjunction with custom error map.`);return t?{errorMap:t,description:i}:{errorMap:(s,o)=>{const{message:c}=e;return s.code==="invalid_enum_value"?{message:c??o.defaultError}:typeof o.data>"u"?{message:c??n??o.defaultError}:s.code!=="invalid_type"?{message:o.defaultError}:{message:c??r??o.defaultError}},description:i}}class We{get description(){return this._def.description}_getType(t){return Tn(t.data)}_getOrReturnCtx(t,r){return r||{common:t.parent.common,data:t.data,parsedType:Tn(t.data),schemaErrorMap:this._def.errorMap,path:t.path,parent:t.parent}}_processInputParams(t){return{status:new or,ctx:{common:t.parent.common,data:t.data,parsedType:Tn(t.data),schemaErrorMap:this._def.errorMap,path:t.path,parent:t.parent}}}_parseSync(t){const r=this._parse(t);if(dc(r))throw new Error("Synchronous parse encountered promise.");return r}_parseAsync(t){const r=this._parse(t);return Promise.resolve(r)}parse(t,r){const n=this.safeParse(t,r);if(n.success)return n.data;throw n.error}safeParse(t,r){const n={common:{issues:[],async:r?.async??!1,contextualErrorMap:r?.errorMap},path:r?.path||[],schemaErrorMap:this._def.errorMap,parent:null,data:t,parsedType:Tn(t)},i=this._parseSync({data:t,path:n.path,parent:n});return Tg(n,i)}"~validate"(t){const r={common:{issues:[],async:!!this["~standard"].async},path:[],schemaErrorMap:this._def.errorMap,parent:null,data:t,parsedType:Tn(t)};if(!this["~standard"].async)try{const n=this._parseSync({data:t,path:[],parent:r});return ca(n)?{value:n.value}:{issues:r.common.issues}}catch(n){n?.message?.toLowerCase()?.includes("encountered")&&(this["~standard"].async=!0),r.common={issues:[],async:!0}}return this._parseAsync({data:t,path:[],parent:r}).then(n=>ca(n)?{value:n.value}:{issues:r.common.issues})}async parseAsync(t,r){const n=await this.safeParseAsync(t,r);if(n.success)return n.data;throw n.error}async safeParseAsync(t,r){const n={common:{issues:[],contextualErrorMap:r?.errorMap,async:!0},path:r?.path||[],schemaErrorMap:this._def.errorMap,parent:null,data:t,parsedType:Tn(t)},i=this._parse({data:t,path:n.path,parent:n}),a=await(dc(i)?i:Promise.resolve(i));return Tg(n,a)}refine(t,r){const n=i=>typeof r=="string"||typeof r>"u"?{message:r}:typeof r=="function"?r(i):r;return this._refinement((i,a)=>{const s=t(i),o=()=>a.addIssue({code:J.custom,...n(i)});return typeof Promise<"u"&&s instanceof Promise?s.then(c=>c?!0:(o(),!1)):s?!0:(o(),!1)})}refinement(t,r){return this._refinement((n,i)=>t(n)?!0:(i.addIssue(typeof r=="function"?r(n,i):r),!1))}_refinement(t){return new la({schema:this,typeName:ee.ZodEffects,effect:{type:"refinement",refinement:t}})}superRefine(t){return this._refinement(t)}constructor(t){this.spa=this.safeParseAsync,this._def=t,this.parse=this.parse.bind(this),this.safeParse=this.safeParse.bind(this),this.parseAsync=this.parseAsync.bind(this),this.safeParseAsync=this.safeParseAsync.bind(this),this.spa=this.spa.bind(this),this.refine=this.refine.bind(this),this.refinement=this.refinement.bind(this),this.superRefine=this.superRefine.bind(this),this.optional=this.optional.bind(this),this.nullable=this.nullable.bind(this),this.nullish=this.nullish.bind(this),this.array=this.array.bind(this),this.promise=this.promise.bind(this),this.or=this.or.bind(this),this.and=this.and.bind(this),this.transform=this.transform.bind(this),this.brand=this.brand.bind(this),this.default=this.default.bind(this),this.catch=this.catch.bind(this),this.describe=this.describe.bind(this),this.pipe=this.pipe.bind(this),this.readonly=this.readonly.bind(this),this.isNullable=this.isNullable.bind(this),this.isOptional=this.isOptional.bind(this),this["~standard"]={version:1,vendor:"zod",validate:r=>this["~validate"](r)}}optional(){return Nn.create(this,this._def)}nullable(){return da.create(this,this._def)}nullish(){return this.nullable().optional()}array(){return qr.create(this)}promise(){return mc.create(this,this._def)}or(t){return hc.create([this,t],this._def)}and(t){return pc.create(this,t,this._def)}transform(t){return new la({...Ue(this._def),schema:this,typeName:ee.ZodEffects,effect:{type:"transform",transform:t}})}default(t){const r=typeof t=="function"?t:()=>t;return new qd({...Ue(this._def),innerType:this,defaultValue:r,typeName:ee.ZodDefault})}brand(){return new y1({typeName:ee.ZodBranded,type:this,...Ue(this._def)})}catch(t){const r=typeof t=="function"?t:()=>t;return new Hd({...Ue(this._def),innerType:this,catchValue:r,typeName:ee.ZodCatch})}describe(t){const r=this.constructor;return new r({...this._def,description:t})}pipe(t){return Jf.create(this,t)}readonly(){return Kd.create(this)}isOptional(){return this.safeParse(void 0).success}isNullable(){return this.safeParse(null).success}}const ZC=/^c[^\s-]{8,}$/i,JC=/^[0-9a-z]+$/,QC=/^[0-9A-HJKMNP-TV-Z]{26}$/i,YC=/^[0-9a-fA-F]{8}\b-[0-9a-fA-F]{4}\b-[0-9a-fA-F]{4}\b-[0-9a-fA-F]{4}\b-[0-9a-fA-F]{12}$/i,XC=/^[a-z0-9_-]{21}$/i,e1=/^[A-Za-z0-9-_]+\.[A-Za-z0-9-_]+\.[A-Za-z0-9-_]*$/,t1=/^[-+]?P(?!$)(?:(?:[-+]?\d+Y)|(?:[-+]?\d+[.,]\d+Y$))?(?:(?:[-+]?\d+M)|(?:[-+]?\d+[.,]\d+M$))?(?:(?:[-+]?\d+W)|(?:[-+]?\d+[.,]\d+W$))?(?:(?:[-+]?\d+D)|(?:[-+]?\d+[.,]\d+D$))?(?:T(?=[\d+-])(?:(?:[-+]?\d+H)|(?:[-+]?\d+[.,]\d+H$))?(?:(?:[-+]?\d+M)|(?:[-+]?\d+[.,]\d+M$))?(?:[-+]?\d+(?:[.,]\d+)?S)?)??$/,r1=/^(?!\.)(?!.*\.\.)([A-Z0-9_'+\-\.]*)[A-Z0-9_+-]@([A-Z0-9][A-Z0-9\-]*\.)+[A-Z]{2,}$/i,n1="^(\\p{Extended_Pictographic}|\\p{Emoji_Component})+$";let Jl;const i1=/^(?:(?:25[0-5]|2[0-4][0-9]|1[0-9][0-9]|[1-9][0-9]|[0-9])\.){3}(?:25[0-5]|2[0-4][0-9]|1[0-9][0-9]|[1-9][0-9]|[0-9])$/,a1=/^(?:(?:25[0-5]|2[0-4][0-9]|1[0-9][0-9]|[1-9][0-9]|[0-9])\.){3}(?:25[0-5]|2[0-4][0-9]|1[0-9][0-9]|[1-9][0-9]|[0-9])\/(3[0-2]|[12]?[0-9])$/,s1=/^(([0-9a-fA-F]{1,4}:){7,7}[0-9a-fA-F]{1,4}|([0-9a-fA-F]{1,4}:){1,7}:|([0-9a-fA-F]{1,4}:){1,6}:[0-9a-fA-F]{1,4}|([0-9a-fA-F]{1,4}:){1,5}(:[0-9a-fA-F]{1,4}){1,2}|([0-9a-fA-F]{1,4}:){1,4}(:[0-9a-fA-F]{1,4}){1,3}|([0-9a-fA-F]{1,4}:){1,3}(:[0-9a-fA-F]{1,4}){1,4}|([0-9a-fA-F]{1,4}:){1,2}(:[0-9a-fA-F]{1,4}){1,5}|[0-9a-fA-F]{1,4}:((:[0-9a-fA-F]{1,4}){1,6})|:((:[0-9a-fA-F]{1,4}){1,7}|:)|fe80:(:[0-9a-fA-F]{0,4}){0,4}%[0-9a-zA-Z]{1,}|::(ffff(:0{1,4}){0,1}:){0,1}((25[0-5]|(2[0-4]|1{0,1}[0-9]){0,1}[0-9])\.){3,3}(25[0-5]|(2[0-4]|1{0,1}[0-9]){0,1}[0-9])|([0-9a-fA-F]{1,4}:){1,4}:((25[0-5]|(2[0-4]|1{0,1}[0-9]){0,1}[0-9])\.){3,3}(25[0-5]|(2[0-4]|1{0,1}[0-9]){0,1}[0-9]))$/,o1=/^(([0-9a-fA-F]{1,4}:){7,7}[0-9a-fA-F]{1,4}|([0-9a-fA-F]{1,4}:){1,7}:|([0-9a-fA-F]{1,4}:){1,6}:[0-9a-fA-F]{1,4}|([0-9a-fA-F]{1,4}:){1,5}(:[0-9a-fA-F]{1,4}){1,2}|([0-9a-fA-F]{1,4}:){1,4}(:[0-9a-fA-F]{1,4}){1,3}|([0-9a-fA-F]{1,4}:){1,3}(:[0-9a-fA-F]{1,4}){1,4}|([0-9a-fA-F]{1,4}:){1,2}(:[0-9a-fA-F]{1,4}){1,5}|[0-9a-fA-F]{1,4}:((:[0-9a-fA-F]{1,4}){1,6})|:((:[0-9a-fA-F]{1,4}){1,7}|:)|fe80:(:[0-9a-fA-F]{0,4}){0,4}%[0-9a-zA-Z]{1,}|::(ffff(:0{1,4}){0,1}:){0,1}((25[0-5]|(2[0-4]|1{0,1}[0-9]){0,1}[0-9])\.){3,3}(25[0-5]|(2[0-4]|1{0,1}[0-9]){0,1}[0-9])|([0-9a-fA-F]{1,4}:){1,4}:((25[0-5]|(2[0-4]|1{0,1}[0-9]){0,1}[0-9])\.){3,3}(25[0-5]|(2[0-4]|1{0,1}[0-9]){0,1}[0-9]))\/(12[0-8]|1[01][0-9]|[1-9]?[0-9])$/,c1=/^([0-9a-zA-Z+/]{4})*(([0-9a-zA-Z+/]{2}==)|([0-9a-zA-Z+/]{3}=))?$/,u1=/^([0-9a-zA-Z-_]{4})*(([0-9a-zA-Z-_]{2}(==)?)|([0-9a-zA-Z-_]{3}(=)?))?$/,bw="((\\d\\d[2468][048]|\\d\\d[13579][26]|\\d\\d0[48]|[02468][048]00|[13579][26]00)-02-29|\\d{4}-((0[13578]|1[02])-(0[1-9]|[12]\\d|3[01])|(0[469]|11)-(0[1-9]|[12]\\d|30)|(02)-(0[1-9]|1\\d|2[0-8])))",l1=new RegExp(`^${bw}$`);function Ew(e){let t="[0-5]\\d";e.precision?t=`${t}\\.\\d{${e.precision}}`:e.precision==null&&(t=`${t}(\\.\\d+)?`);const r=e.precision?"+":"?";return`([01]\\d|2[0-3]):[0-5]\\d(:${t})${r}`}function d1(e){return new RegExp(`^${Ew(e)}$`)}function f1(e){let t=`${bw}T${Ew(e)}`;const r=[];return r.push(e.local?"Z?":"Z"),e.offset&&r.push("([+-]\\d{2}:?\\d{2})"),t=`${t}(${r.join("|")})`,new RegExp(`^${t}$`)}function h1(e,t){return!!((t==="v4"||!t)&&i1.test(e)||(t==="v6"||!t)&&s1.test(e))}function p1(e,t){if(!e1.test(e))return!1;try{const[r]=e.split(".");if(!r)return!1;const n=r.replace(/-/g,"+").replace(/_/g,"/").padEnd(r.length+(4-r.length%4)%4,"="),i=JSON.parse(atob(n));return!(typeof i!="object"||i===null||"typ"in i&&i?.typ!=="JWT"||!i.alg||t&&i.alg!==t)}catch{return!1}}function m1(e,t){return!!((t==="v4"||!t)&&a1.test(e)||(t==="v6"||!t)&&o1.test(e))}class An extends We{_parse(t){if(this._def.coerce&&(t.data=String(t.data)),this._getType(t)!==pe.string){const a=this._getOrReturnCtx(t);return le(a,{code:J.invalid_type,expected:pe.string,received:a.parsedType}),Pe}const n=new or;let i;for(const a of this._def.checks)if(a.kind==="min")t.data.length<a.value&&(i=this._getOrReturnCtx(t,i),le(i,{code:J.too_small,minimum:a.value,type:"string",inclusive:!0,exact:!1,message:a.message}),n.dirty());else if(a.kind==="max")t.data.length>a.value&&(i=this._getOrReturnCtx(t,i),le(i,{code:J.too_big,maximum:a.value,type:"string",inclusive:!0,exact:!1,message:a.message}),n.dirty());else if(a.kind==="length"){const s=t.data.length>a.value,o=t.data.length<a.value;(s||o)&&(i=this._getOrReturnCtx(t,i),s?le(i,{code:J.too_big,maximum:a.value,type:"string",inclusive:!0,exact:!0,message:a.message}):o&&le(i,{code:J.too_small,minimum:a.value,type:"string",inclusive:!0,exact:!0,message:a.message}),n.dirty())}else if(a.kind==="email")r1.test(t.data)||(i=this._getOrReturnCtx(t,i),le(i,{validation:"email",code:J.invalid_string,message:a.message}),n.dirty());else if(a.kind==="emoji")Jl||(Jl=new RegExp(n1,"u")),Jl.test(t.data)||(i=this._getOrReturnCtx(t,i),le(i,{validation:"emoji",code:J.invalid_string,message:a.message}),n.dirty());else if(a.kind==="uuid")YC.test(t.data)||(i=this._getOrReturnCtx(t,i),le(i,{validation:"uuid",code:J.invalid_string,message:a.message}),n.dirty());else if(a.kind==="nanoid")XC.test(t.data)||(i=this._getOrReturnCtx(t,i),le(i,{validation:"nanoid",code:J.invalid_string,message:a.message}),n.dirty());else if(a.kind==="cuid")ZC.test(t.data)||(i=this._getOrReturnCtx(t,i),le(i,{validation:"cuid",code:J.invalid_string,message:a.message}),n.dirty());else if(a.kind==="cuid2")JC.test(t.data)||(i=this._getOrReturnCtx(t,i),le(i,{validation:"cuid2",code:J.invalid_string,message:a.message}),n.dirty());else if(a.kind==="ulid")QC.test(t.data)||(i=this._getOrReturnCtx(t,i),le(i,{validation:"ulid",code:J.invalid_string,message:a.message}),n.dirty());else if(a.kind==="url")try{new URL(t.data)}catch{i=this._getOrReturnCtx(t,i),le(i,{validation:"url",code:J.invalid_string,message:a.message}),n.dirty()}else a.kind==="regex"?(a.regex.lastIndex=0,a.regex.test(t.data)||(i=this._getOrReturnCtx(t,i),le(i,{validation:"regex",code:J.invalid_string,message:a.message}),n.dirty())):a.kind==="trim"?t.data=t.data.trim():a.kind==="includes"?t.data.includes(a.value,a.position)||(i=this._getOrReturnCtx(t,i),le(i,{code:J.invalid_string,validation:{includes:a.value,position:a.position},message:a.message}),n.dirty()):a.kind==="toLowerCase"?t.data=t.data.toLowerCase():a.kind==="toUpperCase"?t.data=t.data.toUpperCase():a.kind==="startsWith"?t.data.startsWith(a.value)||(i=this._getOrReturnCtx(t,i),le(i,{code:J.invalid_string,validation:{startsWith:a.value},message:a.message}),n.dirty()):a.kind==="endsWith"?t.data.endsWith(a.value)||(i=this._getOrReturnCtx(t,i),le(i,{code:J.invalid_string,validation:{endsWith:a.value},message:a.message}),n.dirty()):a.kind==="datetime"?f1(a).test(t.data)||(i=this._getOrReturnCtx(t,i),le(i,{code:J.invalid_string,validation:"datetime",message:a.message}),n.dirty()):a.kind==="date"?l1.test(t.data)||(i=this._getOrReturnCtx(t,i),le(i,{code:J.invalid_string,validation:"date",message:a.message}),n.dirty()):a.kind==="time"?d1(a).test(t.data)||(i=this._getOrReturnCtx(t,i),le(i,{code:J.invalid_string,validation:"time",message:a.message}),n.dirty()):a.kind==="duration"?t1.test(t.data)||(i=this._getOrReturnCtx(t,i),le(i,{validation:"duration",code:J.invalid_string,message:a.message}),n.dirty()):a.kind==="ip"?h1(t.data,a.version)||(i=this._getOrReturnCtx(t,i),le(i,{validation:"ip",code:J.invalid_string,message:a.message}),n.dirty()):a.kind==="jwt"?p1(t.data,a.alg)||(i=this._getOrReturnCtx(t,i),le(i,{validation:"jwt",code:J.invalid_string,message:a.message}),n.dirty()):a.kind==="cidr"?m1(t.data,a.version)||(i=this._getOrReturnCtx(t,i),le(i,{validation:"cidr",code:J.invalid_string,message:a.message}),n.dirty()):a.kind==="base64"?c1.test(t.data)||(i=this._getOrReturnCtx(t,i),le(i,{validation:"base64",code:J.invalid_string,message:a.message}),n.dirty()):a.kind==="base64url"?u1.test(t.data)||(i=this._getOrReturnCtx(t,i),le(i,{validation:"base64url",code:J.invalid_string,message:a.message}),n.dirty()):Je.assertNever(a);return{status:n.value,value:t.data}}_regex(t,r,n){return this.refinement(i=>t.test(i),{validation:r,code:J.invalid_string,...ge.errToObj(n)})}_addCheck(t){return new An({...this._def,checks:[...this._def.checks,t]})}email(t){return this._addCheck({kind:"email",...ge.errToObj(t)})}url(t){return this._addCheck({kind:"url",...ge.errToObj(t)})}emoji(t){return this._addCheck({kind:"emoji",...ge.errToObj(t)})}uuid(t){return this._addCheck({kind:"uuid",...ge.errToObj(t)})}nanoid(t){return this._addCheck({kind:"nanoid",...ge.errToObj(t)})}cuid(t){return this._addCheck({kind:"cuid",...ge.errToObj(t)})}cuid2(t){return this._addCheck({kind:"cuid2",...ge.errToObj(t)})}ulid(t){return this._addCheck({kind:"ulid",...ge.errToObj(t)})}base64(t){return this._addCheck({kind:"base64",...ge.errToObj(t)})}base64url(t){return this._addCheck({kind:"base64url",...ge.errToObj(t)})}jwt(t){return this._addCheck({kind:"jwt",...ge.errToObj(t)})}ip(t){return this._addCheck({kind:"ip",...ge.errToObj(t)})}cidr(t){return this._addCheck({kind:"cidr",...ge.errToObj(t)})}datetime(t){return typeof t=="string"?this._addCheck({kind:"datetime",precision:null,offset:!1,local:!1,message:t}):this._addCheck({kind:"datetime",precision:typeof t?.precision>"u"?null:t?.precision,offset:t?.offset??!1,local:t?.local??!1,...ge.errToObj(t?.message)})}date(t){return this._addCheck({kind:"date",message:t})}time(t){return typeof t=="string"?this._addCheck({kind:"time",precision:null,message:t}):this._addCheck({kind:"time",precision:typeof t?.precision>"u"?null:t?.precision,...ge.errToObj(t?.message)})}duration(t){return this._addCheck({kind:"duration",...ge.errToObj(t)})}regex(t,r){return this._addCheck({kind:"regex",regex:t,...ge.errToObj(r)})}includes(t,r){return this._addCheck({kind:"includes",value:t,position:r?.position,...ge.errToObj(r?.message)})}startsWith(t,r){return this._addCheck({kind:"startsWith",value:t,...ge.errToObj(r)})}endsWith(t,r){return this._addCheck({kind:"endsWith",value:t,...ge.errToObj(r)})}min(t,r){return this._addCheck({kind:"min",value:t,...ge.errToObj(r)})}max(t,r){return this._addCheck({kind:"max",value:t,...ge.errToObj(r)})}length(t,r){return this._addCheck({kind:"length",value:t,...ge.errToObj(r)})}nonempty(t){return this.min(1,ge.errToObj(t))}trim(){return new An({...this._def,checks:[...this._def.checks,{kind:"trim"}]})}toLowerCase(){return new An({...this._def,checks:[...this._def.checks,{kind:"toLowerCase"}]})}toUpperCase(){return new An({...this._def,checks:[...this._def.checks,{kind:"toUpperCase"}]})}get isDatetime(){return!!this._def.checks.find(t=>t.kind==="datetime")}get isDate(){return!!this._def.checks.find(t=>t.kind==="date")}get isTime(){return!!this._def.checks.find(t=>t.kind==="time")}get isDuration(){return!!this._def.checks.find(t=>t.kind==="duration")}get isEmail(){return!!this._def.checks.find(t=>t.kind==="email")}get isURL(){return!!this._def.checks.find(t=>t.kind==="url")}get isEmoji(){return!!this._def.checks.find(t=>t.kind==="emoji")}get isUUID(){return!!this._def.checks.find(t=>t.kind==="uuid")}get isNANOID(){return!!this._def.checks.find(t=>t.kind==="nanoid")}get isCUID(){return!!this._def.checks.find(t=>t.kind==="cuid")}get isCUID2(){return!!this._def.checks.find(t=>t.kind==="cuid2")}get isULID(){return!!this._def.checks.find(t=>t.kind==="ulid")}get isIP(){return!!this._def.checks.find(t=>t.kind==="ip")}get isCIDR(){return!!this._def.checks.find(t=>t.kind==="cidr")}get isBase64(){return!!this._def.checks.find(t=>t.kind==="base64")}get isBase64url(){return!!this._def.checks.find(t=>t.kind==="base64url")}get minLength(){let t=null;for(const r of this._def.checks)r.kind==="min"&&(t===null||r.value>t)&&(t=r.value);return t}get maxLength(){let t=null;for(const r of this._def.checks)r.kind==="max"&&(t===null||r.value<t)&&(t=r.value);return t}}An.create=e=>new An({checks:[],typeName:ee.ZodString,coerce:e?.coerce??!1,...Ue(e)});function g1(e,t){const r=(e.toString().split(".")[1]||"").length,n=(t.toString().split(".")[1]||"").length,i=r>n?r:n,a=Number.parseInt(e.toFixed(i).replace(".","")),s=Number.parseInt(t.toFixed(i).replace(".",""));return a%s/10**i}class vs extends We{constructor(){super(...arguments),this.min=this.gte,this.max=this.lte,this.step=this.multipleOf}_parse(t){if(this._def.coerce&&(t.data=Number(t.data)),this._getType(t)!==pe.number){const a=this._getOrReturnCtx(t);return le(a,{code:J.invalid_type,expected:pe.number,received:a.parsedType}),Pe}let n;const i=new or;for(const a of this._def.checks)a.kind==="int"?Je.isInteger(t.data)||(n=this._getOrReturnCtx(t,n),le(n,{code:J.invalid_type,expected:"integer",received:"float",message:a.message}),i.dirty()):a.kind==="min"?(a.inclusive?t.data<a.value:t.data<=a.value)&&(n=this._getOrReturnCtx(t,n),le(n,{code:J.too_small,minimum:a.value,type:"number",inclusive:a.inclusive,exact:!1,message:a.message}),i.dirty()):a.kind==="max"?(a.inclusive?t.data>a.value:t.data>=a.value)&&(n=this._getOrReturnCtx(t,n),le(n,{code:J.too_big,maximum:a.value,type:"number",inclusive:a.inclusive,exact:!1,message:a.message}),i.dirty()):a.kind==="multipleOf"?g1(t.data,a.value)!==0&&(n=this._getOrReturnCtx(t,n),le(n,{code:J.not_multiple_of,multipleOf:a.value,message:a.message}),i.dirty()):a.kind==="finite"?Number.isFinite(t.data)||(n=this._getOrReturnCtx(t,n),le(n,{code:J.not_finite,message:a.message}),i.dirty()):Je.assertNever(a);return{status:i.value,value:t.data}}gte(t,r){return this.setLimit("min",t,!0,ge.toString(r))}gt(t,r){return this.setLimit("min",t,!1,ge.toString(r))}lte(t,r){return this.setLimit("max",t,!0,ge.toString(r))}lt(t,r){return this.setLimit("max",t,!1,ge.toString(r))}setLimit(t,r,n,i){return new vs({...this._def,checks:[...this._def.checks,{kind:t,value:r,inclusive:n,message:ge.toString(i)}]})}_addCheck(t){return new vs({...this._def,checks:[...this._def.checks,t]})}int(t){return this._addCheck({kind:"int",message:ge.toString(t)})}positive(t){return this._addCheck({kind:"min",value:0,inclusive:!1,message:ge.toString(t)})}negative(t){return this._addCheck({kind:"max",value:0,inclusive:!1,message:ge.toString(t)})}nonpositive(t){return this._addCheck({kind:"max",value:0,inclusive:!0,message:ge.toString(t)})}nonnegative(t){return this._addCheck({kind:"min",value:0,inclusive:!0,message:ge.toString(t)})}multipleOf(t,r){return this._addCheck({kind:"multipleOf",value:t,message:ge.toString(r)})}finite(t){return this._addCheck({kind:"finite",message:ge.toString(t)})}safe(t){return this._addCheck({kind:"min",inclusive:!0,value:Number.MIN_SAFE_INTEGER,message:ge.toString(t)})._addCheck({kind:"max",inclusive:!0,value:Number.MAX_SAFE_INTEGER,message:ge.toString(t)})}get minValue(){let t=null;for(const r of this._def.checks)r.kind==="min"&&(t===null||r.value>t)&&(t=r.value);return t}get maxValue(){let t=null;for(const r of this._def.checks)r.kind==="max"&&(t===null||r.value<t)&&(t=r.value);return t}get isInt(){return!!this._def.checks.find(t=>t.kind==="int"||t.kind==="multipleOf"&&Je.isInteger(t.value))}get isFinite(){let t=null,r=null;for(const n of this._def.checks){if(n.kind==="finite"||n.kind==="int"||n.kind==="multipleOf")return!0;n.kind==="min"?(r===null||n.value>r)&&(r=n.value):n.kind==="max"&&(t===null||n.value<t)&&(t=n.value)}return Number.isFinite(r)&&Number.isFinite(t)}}vs.create=e=>new vs({checks:[],typeName:ee.ZodNumber,coerce:e?.coerce||!1,...Ue(e)});class _s extends We{constructor(){super(...arguments),this.min=this.gte,this.max=this.lte}_parse(t){if(this._def.coerce)try{t.data=BigInt(t.data)}catch{return this._getInvalidInput(t)}if(this._getType(t)!==pe.bigint)return this._getInvalidInput(t);let n;const i=new or;for(const a of this._def.checks)a.kind==="min"?(a.inclusive?t.data<a.value:t.data<=a.value)&&(n=this._getOrReturnCtx(t,n),le(n,{code:J.too_small,type:"bigint",minimum:a.value,inclusive:a.inclusive,message:a.message}),i.dirty()):a.kind==="max"?(a.inclusive?t.data>a.value:t.data>=a.value)&&(n=this._getOrReturnCtx(t,n),le(n,{code:J.too_big,type:"bigint",maximum:a.value,inclusive:a.inclusive,message:a.message}),i.dirty()):a.kind==="multipleOf"?t.data%a.value!==BigInt(0)&&(n=this._getOrReturnCtx(t,n),le(n,{code:J.not_multiple_of,multipleOf:a.value,message:a.message}),i.dirty()):Je.assertNever(a);return{status:i.value,value:t.data}}_getInvalidInput(t){const r=this._getOrReturnCtx(t);return le(r,{code:J.invalid_type,expected:pe.bigint,received:r.parsedType}),Pe}gte(t,r){return this.setLimit("min",t,!0,ge.toString(r))}gt(t,r){return this.setLimit("min",t,!1,ge.toString(r))}lte(t,r){return this.setLimit("max",t,!0,ge.toString(r))}lt(t,r){return this.setLimit("max",t,!1,ge.toString(r))}setLimit(t,r,n,i){return new _s({...this._def,checks:[...this._def.checks,{kind:t,value:r,inclusive:n,message:ge.toString(i)}]})}_addCheck(t){return new _s({...this._def,checks:[...this._def.checks,t]})}positive(t){return this._addCheck({kind:"min",value:BigInt(0),inclusive:!1,message:ge.toString(t)})}negative(t){return this._addCheck({kind:"max",value:BigInt(0),inclusive:!1,message:ge.toString(t)})}nonpositive(t){return this._addCheck({kind:"max",value:BigInt(0),inclusive:!0,message:ge.toString(t)})}nonnegative(t){return this._addCheck({kind:"min",value:BigInt(0),inclusive:!0,message:ge.toString(t)})}multipleOf(t,r){return this._addCheck({kind:"multipleOf",value:t,message:ge.toString(r)})}get minValue(){let t=null;for(const r of this._def.checks)r.kind==="min"&&(t===null||r.value>t)&&(t=r.value);return t}get maxValue(){let t=null;for(const r of this._def.checks)r.kind==="max"&&(t===null||r.value<t)&&(t=r.value);return t}}_s.create=e=>new _s({checks:[],typeName:ee.ZodBigInt,coerce:e?.coerce??!1,...Ue(e)});class Rg extends We{_parse(t){if(this._def.coerce&&(t.data=!!t.data),this._getType(t)!==pe.boolean){const n=this._getOrReturnCtx(t);return le(n,{code:J.invalid_type,expected:pe.boolean,received:n.parsedType}),Pe}return _r(t.data)}}Rg.create=e=>new Rg({typeName:ee.ZodBoolean,coerce:e?.coerce||!1,...Ue(e)});class fc extends We{_parse(t){if(this._def.coerce&&(t.data=new Date(t.data)),this._getType(t)!==pe.date){const a=this._getOrReturnCtx(t);return le(a,{code:J.invalid_type,expected:pe.date,received:a.parsedType}),Pe}if(Number.isNaN(t.data.getTime())){const a=this._getOrReturnCtx(t);return le(a,{code:J.invalid_date}),Pe}const n=new or;let i;for(const a of this._def.checks)a.kind==="min"?t.data.getTime()<a.value&&(i=this._getOrReturnCtx(t,i),le(i,{code:J.too_small,message:a.message,inclusive:!0,exact:!1,minimum:a.value,type:"date"}),n.dirty()):a.kind==="max"?t.data.getTime()>a.value&&(i=this._getOrReturnCtx(t,i),le(i,{code:J.too_big,message:a.message,inclusive:!0,exact:!1,maximum:a.value,type:"date"}),n.dirty()):Je.assertNever(a);return{status:n.value,value:new Date(t.data.getTime())}}_addCheck(t){return new fc({...this._def,checks:[...this._def.checks,t]})}min(t,r){return this._addCheck({kind:"min",value:t.getTime(),message:ge.toString(r)})}max(t,r){return this._addCheck({kind:"max",value:t.getTime(),message:ge.toString(r)})}get minDate(){let t=null;for(const r of this._def.checks)r.kind==="min"&&(t===null||r.value>t)&&(t=r.value);return t!=null?new Date(t):null}get maxDate(){let t=null;for(const r of this._def.checks)r.kind==="max"&&(t===null||r.value<t)&&(t=r.value);return t!=null?new Date(t):null}}fc.create=e=>new fc({checks:[],coerce:e?.coerce||!1,typeName:ee.ZodDate,...Ue(e)});class Ag extends We{_parse(t){if(this._getType(t)!==pe.symbol){const n=this._getOrReturnCtx(t);return le(n,{code:J.invalid_type,expected:pe.symbol,received:n.parsedType}),Pe}return _r(t.data)}}Ag.create=e=>new Ag({typeName:ee.ZodSymbol,...Ue(e)});class $g extends We{_parse(t){if(this._getType(t)!==pe.undefined){const n=this._getOrReturnCtx(t);return le(n,{code:J.invalid_type,expected:pe.undefined,received:n.parsedType}),Pe}return _r(t.data)}}$g.create=e=>new $g({typeName:ee.ZodUndefined,...Ue(e)});class Cg extends We{_parse(t){if(this._getType(t)!==pe.null){const n=this._getOrReturnCtx(t);return le(n,{code:J.invalid_type,expected:pe.null,received:n.parsedType}),Pe}return _r(t.data)}}Cg.create=e=>new Cg({typeName:ee.ZodNull,...Ue(e)});class zd extends We{constructor(){super(...arguments),this._any=!0}_parse(t){return _r(t.data)}}zd.create=e=>new zd({typeName:ee.ZodAny,...Ue(e)});class Pg extends We{constructor(){super(...arguments),this._unknown=!0}_parse(t){return _r(t.data)}}Pg.create=e=>new Pg({typeName:ee.ZodUnknown,...Ue(e)});class Fn extends We{_parse(t){const r=this._getOrReturnCtx(t);return le(r,{code:J.invalid_type,expected:pe.never,received:r.parsedType}),Pe}}Fn.create=e=>new Fn({typeName:ee.ZodNever,...Ue(e)});class Ng extends We{_parse(t){if(this._getType(t)!==pe.undefined){const n=this._getOrReturnCtx(t);return le(n,{code:J.invalid_type,expected:pe.void,received:n.parsedType}),Pe}return _r(t.data)}}Ng.create=e=>new Ng({typeName:ee.ZodVoid,...Ue(e)});class qr extends We{_parse(t){const{ctx:r,status:n}=this._processInputParams(t),i=this._def;if(r.parsedType!==pe.array)return le(r,{code:J.invalid_type,expected:pe.array,received:r.parsedType}),Pe;if(i.exactLength!==null){const s=r.data.length>i.exactLength.value,o=r.data.length<i.exactLength.value;(s||o)&&(le(r,{code:s?J.too_big:J.too_small,minimum:o?i.exactLength.value:void 0,maximum:s?i.exactLength.value:void 0,type:"array",inclusive:!0,exact:!0,message:i.exactLength.message}),n.dirty())}if(i.minLength!==null&&r.data.length<i.minLength.value&&(le(r,{code:J.too_small,minimum:i.minLength.value,type:"array",inclusive:!0,exact:!1,message:i.minLength.message}),n.dirty()),i.maxLength!==null&&r.data.length>i.maxLength.value&&(le(r,{code:J.too_big,maximum:i.maxLength.value,type:"array",inclusive:!0,exact:!1,message:i.maxLength.message}),n.dirty()),r.common.async)return Promise.all([...r.data].map((s,o)=>i.type._parseAsync(new jn(r,s,r.path,o)))).then(s=>or.mergeArray(n,s));const a=[...r.data].map((s,o)=>i.type._parseSync(new jn(r,s,r.path,o)));return or.mergeArray(n,a)}get element(){return this._def.type}min(t,r){return new qr({...this._def,minLength:{value:t,message:ge.toString(r)}})}max(t,r){return new qr({...this._def,maxLength:{value:t,message:ge.toString(r)}})}length(t,r){return new qr({...this._def,exactLength:{value:t,message:ge.toString(r)}})}nonempty(t){return this.min(1,t)}}qr.create=(e,t)=>new qr({type:e,minLength:null,maxLength:null,exactLength:null,typeName:ee.ZodArray,...Ue(t)});function Hi(e){if(e instanceof pt){const t={};for(const r in e.shape){const n=e.shape[r];t[r]=Nn.create(Hi(n))}return new pt({...e._def,shape:()=>t})}else return e instanceof qr?new qr({...e._def,type:Hi(e.element)}):e instanceof Nn?Nn.create(Hi(e.unwrap())):e instanceof da?da.create(Hi(e.unwrap())):e instanceof Ei?Ei.create(e.items.map(t=>Hi(t))):e}class pt extends We{constructor(){super(...arguments),this._cached=null,this.nonstrict=this.passthrough,this.augment=this.extend}_getCached(){if(this._cached!==null)return this._cached;const t=this._def.shape(),r=Je.objectKeys(t);return this._cached={shape:t,keys:r},this._cached}_parse(t){if(this._getType(t)!==pe.object){const u=this._getOrReturnCtx(t);return le(u,{code:J.invalid_type,expected:pe.object,received:u.parsedType}),Pe}const{status:n,ctx:i}=this._processInputParams(t),{shape:a,keys:s}=this._getCached(),o=[];if(!(this._def.catchall instanceof Fn&&this._def.unknownKeys==="strip"))for(const u in i.data)s.includes(u)||o.push(u);const c=[];for(const u of s){const d=a[u],h=i.data[u];c.push({key:{status:"valid",value:u},value:d._parse(new jn(i,h,i.path,u)),alwaysSet:u in i.data})}if(this._def.catchall instanceof Fn){const u=this._def.unknownKeys;if(u==="passthrough")for(const d of o)c.push({key:{status:"valid",value:d},value:{status:"valid",value:i.data[d]}});else if(u==="strict")o.length>0&&(le(i,{code:J.unrecognized_keys,keys:o}),n.dirty());else if(u!=="strip")throw new Error("Internal ZodObject error: invalid unknownKeys value.")}else{const u=this._def.catchall;for(const d of o){const h=i.data[d];c.push({key:{status:"valid",value:d},value:u._parse(new jn(i,h,i.path,d)),alwaysSet:d in i.data})}}return i.common.async?Promise.resolve().then(async()=>{const u=[];for(const d of c){const h=await d.key,p=await d.value;u.push({key:h,value:p,alwaysSet:d.alwaysSet})}return u}).then(u=>or.mergeObjectSync(n,u)):or.mergeObjectSync(n,c)}get shape(){return this._def.shape()}strict(t){return ge.errToObj,new pt({...this._def,unknownKeys:"strict",...t!==void 0?{errorMap:(r,n)=>{const i=this._def.errorMap?.(r,n).message??n.defaultError;return r.code==="unrecognized_keys"?{message:ge.errToObj(t).message??i}:{message:i}}}:{}})}strip(){return new pt({...this._def,unknownKeys:"strip"})}passthrough(){return new pt({...this._def,unknownKeys:"passthrough"})}extend(t){return new pt({...this._def,shape:()=>({...this._def.shape(),...t})})}merge(t){return new pt({unknownKeys:t._def.unknownKeys,catchall:t._def.catchall,shape:()=>({...this._def.shape(),...t._def.shape()}),typeName:ee.ZodObject})}setKey(t,r){return this.augment({[t]:r})}catchall(t){return new pt({...this._def,catchall:t})}pick(t){const r={};for(const n of Je.objectKeys(t))t[n]&&this.shape[n]&&(r[n]=this.shape[n]);return new pt({...this._def,shape:()=>r})}omit(t){const r={};for(const n of Je.objectKeys(this.shape))t[n]||(r[n]=this.shape[n]);return new pt({...this._def,shape:()=>r})}deepPartial(){return Hi(this)}partial(t){const r={};for(const n of Je.objectKeys(this.shape)){const i=this.shape[n];t&&!t[n]?r[n]=i:r[n]=i.optional()}return new pt({...this._def,shape:()=>r})}required(t){const r={};for(const n of Je.objectKeys(this.shape))if(t&&!t[n])r[n]=this.shape[n];else{let a=this.shape[n];for(;a instanceof Nn;)a=a._def.innerType;r[n]=a}return new pt({...this._def,shape:()=>r})}keyof(){return xw(Je.objectKeys(this.shape))}}pt.create=(e,t)=>new pt({shape:()=>e,unknownKeys:"strip",catchall:Fn.create(),typeName:ee.ZodObject,...Ue(t)});pt.strictCreate=(e,t)=>new pt({shape:()=>e,unknownKeys:"strict",catchall:Fn.create(),typeName:ee.ZodObject,...Ue(t)});pt.lazycreate=(e,t)=>new pt({shape:e,unknownKeys:"strip",catchall:Fn.create(),typeName:ee.ZodObject,...Ue(t)});class hc extends We{_parse(t){const{ctx:r}=this._processInputParams(t),n=this._def.options;function i(a){for(const o of a)if(o.result.status==="valid")return o.result;for(const o of a)if(o.result.status==="dirty")return r.common.issues.push(...o.ctx.common.issues),o.result;const s=a.map(o=>new pn(o.ctx.common.issues));return le(r,{code:J.invalid_union,unionErrors:s}),Pe}if(r.common.async)return Promise.all(n.map(async a=>{const s={...r,common:{...r.common,issues:[]},parent:null};return{result:await a._parseAsync({data:r.data,path:r.path,parent:s}),ctx:s}})).then(i);{let a;const s=[];for(const c of n){const u={...r,common:{...r.common,issues:[]},parent:null},d=c._parseSync({data:r.data,path:r.path,parent:u});if(d.status==="valid")return d;d.status==="dirty"&&!a&&(a={result:d,ctx:u}),u.common.issues.length&&s.push(u.common.issues)}if(a)return r.common.issues.push(...a.ctx.common.issues),a.result;const o=s.map(c=>new pn(c));return le(r,{code:J.invalid_union,unionErrors:o}),Pe}}get options(){return this._def.options}}hc.create=(e,t)=>new hc({options:e,typeName:ee.ZodUnion,...Ue(t)});function Ud(e,t){const r=Tn(e),n=Tn(t);if(e===t)return{valid:!0,data:e};if(r===pe.object&&n===pe.object){const i=Je.objectKeys(t),a=Je.objectKeys(e).filter(o=>i.indexOf(o)!==-1),s={...e,...t};for(const o of a){const c=Ud(e[o],t[o]);if(!c.valid)return{valid:!1};s[o]=c.data}return{valid:!0,data:s}}else if(r===pe.array&&n===pe.array){if(e.length!==t.length)return{valid:!1};const i=[];for(let a=0;a<e.length;a++){const s=e[a],o=t[a],c=Ud(s,o);if(!c.valid)return{valid:!1};i.push(c.data)}return{valid:!0,data:i}}else return r===pe.date&&n===pe.date&&+e==+t?{valid:!0,data:e}:{valid:!1}}class pc extends We{_parse(t){const{status:r,ctx:n}=this._processInputParams(t),i=(a,s)=>{if(Ig(a)||Ig(s))return Pe;const o=Ud(a.value,s.value);return o.valid?((Og(a)||Og(s))&&r.dirty(),{status:r.value,value:o.data}):(le(n,{code:J.invalid_intersection_types}),Pe)};return n.common.async?Promise.all([this._def.left._parseAsync({data:n.data,path:n.path,parent:n}),this._def.right._parseAsync({data:n.data,path:n.path,parent:n})]).then(([a,s])=>i(a,s)):i(this._def.left._parseSync({data:n.data,path:n.path,parent:n}),this._def.right._parseSync({data:n.data,path:n.path,parent:n}))}}pc.create=(e,t,r)=>new pc({left:e,right:t,typeName:ee.ZodIntersection,...Ue(r)});class Ei extends We{_parse(t){const{status:r,ctx:n}=this._processInputParams(t);if(n.parsedType!==pe.array)return le(n,{code:J.invalid_type,expected:pe.array,received:n.parsedType}),Pe;if(n.data.length<this._def.items.length)return le(n,{code:J.too_small,minimum:this._def.items.length,inclusive:!0,exact:!1,type:"array"}),Pe;!this._def.rest&&n.data.length>this._def.items.length&&(le(n,{code:J.too_big,maximum:this._def.items.length,inclusive:!0,exact:!1,type:"array"}),r.dirty());const a=[...n.data].map((s,o)=>{const c=this._def.items[o]||this._def.rest;return c?c._parse(new jn(n,s,n.path,o)):null}).filter(s=>!!s);return n.common.async?Promise.all(a).then(s=>or.mergeArray(r,s)):or.mergeArray(r,a)}get items(){return this._def.items}rest(t){return new Ei({...this._def,rest:t})}}Ei.create=(e,t)=>{if(!Array.isArray(e))throw new Error("You must pass an array of schemas to z.tuple([ ... ])");return new Ei({items:e,typeName:ee.ZodTuple,rest:null,...Ue(t)})};class Dg extends We{get keySchema(){return this._def.keyType}get valueSchema(){return this._def.valueType}_parse(t){const{status:r,ctx:n}=this._processInputParams(t);if(n.parsedType!==pe.map)return le(n,{code:J.invalid_type,expected:pe.map,received:n.parsedType}),Pe;const i=this._def.keyType,a=this._def.valueType,s=[...n.data.entries()].map(([o,c],u)=>({key:i._parse(new jn(n,o,n.path,[u,"key"])),value:a._parse(new jn(n,c,n.path,[u,"value"]))}));if(n.common.async){const o=new Map;return Promise.resolve().then(async()=>{for(const c of s){const u=await c.key,d=await c.value;if(u.status==="aborted"||d.status==="aborted")return Pe;(u.status==="dirty"||d.status==="dirty")&&r.dirty(),o.set(u.value,d.value)}return{status:r.value,value:o}})}else{const o=new Map;for(const c of s){const u=c.key,d=c.value;if(u.status==="aborted"||d.status==="aborted")return Pe;(u.status==="dirty"||d.status==="dirty")&&r.dirty(),o.set(u.value,d.value)}return{status:r.value,value:o}}}}Dg.create=(e,t,r)=>new Dg({valueType:t,keyType:e,typeName:ee.ZodMap,...Ue(r)});class ws extends We{_parse(t){const{status:r,ctx:n}=this._processInputParams(t);if(n.parsedType!==pe.set)return le(n,{code:J.invalid_type,expected:pe.set,received:n.parsedType}),Pe;const i=this._def;i.minSize!==null&&n.data.size<i.minSize.value&&(le(n,{code:J.too_small,minimum:i.minSize.value,type:"set",inclusive:!0,exact:!1,message:i.minSize.message}),r.dirty()),i.maxSize!==null&&n.data.size>i.maxSize.value&&(le(n,{code:J.too_big,maximum:i.maxSize.value,type:"set",inclusive:!0,exact:!1,message:i.maxSize.message}),r.dirty());const a=this._def.valueType;function s(c){const u=new Set;for(const d of c){if(d.status==="aborted")return Pe;d.status==="dirty"&&r.dirty(),u.add(d.value)}return{status:r.value,value:u}}const o=[...n.data.values()].map((c,u)=>a._parse(new jn(n,c,n.path,u)));return n.common.async?Promise.all(o).then(c=>s(c)):s(o)}min(t,r){return new ws({...this._def,minSize:{value:t,message:ge.toString(r)}})}max(t,r){return new ws({...this._def,maxSize:{value:t,message:ge.toString(r)}})}size(t,r){return this.min(t,r).max(t,r)}nonempty(t){return this.min(1,t)}}ws.create=(e,t)=>new ws({valueType:e,minSize:null,maxSize:null,typeName:ee.ZodSet,...Ue(t)});class Mg extends We{get schema(){return this._def.getter()}_parse(t){const{ctx:r}=this._processInputParams(t);return this._def.getter()._parse({data:r.data,path:r.path,parent:r})}}Mg.create=(e,t)=>new Mg({getter:e,typeName:ee.ZodLazy,...Ue(t)});class Lg extends We{_parse(t){if(t.data!==this._def.value){const r=this._getOrReturnCtx(t);return le(r,{received:r.data,code:J.invalid_literal,expected:this._def.value}),Pe}return{status:"valid",value:t.data}}get value(){return this._def.value}}Lg.create=(e,t)=>new Lg({value:e,typeName:ee.ZodLiteral,...Ue(t)});function xw(e,t){return new ua({values:e,typeName:ee.ZodEnum,...Ue(t)})}class ua extends We{_parse(t){if(typeof t.data!="string"){const r=this._getOrReturnCtx(t),n=this._def.values;return le(r,{expected:Je.joinValues(n),received:r.parsedType,code:J.invalid_type}),Pe}if(this._cache||(this._cache=new Set(this._def.values)),!this._cache.has(t.data)){const r=this._getOrReturnCtx(t),n=this._def.values;return le(r,{received:r.data,code:J.invalid_enum_value,options:n}),Pe}return _r(t.data)}get options(){return this._def.values}get enum(){const t={};for(const r of this._def.values)t[r]=r;return t}get Values(){const t={};for(const r of this._def.values)t[r]=r;return t}get Enum(){const t={};for(const r of this._def.values)t[r]=r;return t}extract(t,r=this._def){return ua.create(t,{...this._def,...r})}exclude(t,r=this._def){return ua.create(this.options.filter(n=>!t.includes(n)),{...this._def,...r})}}ua.create=xw;class jg extends We{_parse(t){const r=Je.getValidEnumValues(this._def.values),n=this._getOrReturnCtx(t);if(n.parsedType!==pe.string&&n.parsedType!==pe.number){const i=Je.objectValues(r);return le(n,{expected:Je.joinValues(i),received:n.parsedType,code:J.invalid_type}),Pe}if(this._cache||(this._cache=new Set(Je.getValidEnumValues(this._def.values))),!this._cache.has(t.data)){const i=Je.objectValues(r);return le(n,{received:n.data,code:J.invalid_enum_value,options:i}),Pe}return _r(t.data)}get enum(){return this._def.values}}jg.create=(e,t)=>new jg({values:e,typeName:ee.ZodNativeEnum,...Ue(t)});class mc extends We{unwrap(){return this._def.type}_parse(t){const{ctx:r}=this._processInputParams(t);if(r.parsedType!==pe.promise&&r.common.async===!1)return le(r,{code:J.invalid_type,expected:pe.promise,received:r.parsedType}),Pe;const n=r.parsedType===pe.promise?r.data:Promise.resolve(r.data);return _r(n.then(i=>this._def.type.parseAsync(i,{path:r.path,errorMap:r.common.contextualErrorMap})))}}mc.create=(e,t)=>new mc({type:e,typeName:ee.ZodPromise,...Ue(t)});class la extends We{innerType(){return this._def.schema}sourceType(){return this._def.schema._def.typeName===ee.ZodEffects?this._def.schema.sourceType():this._def.schema}_parse(t){const{status:r,ctx:n}=this._processInputParams(t),i=this._def.effect||null,a={addIssue:s=>{le(n,s),s.fatal?r.abort():r.dirty()},get path(){return n.path}};if(a.addIssue=a.addIssue.bind(a),i.type==="preprocess"){const s=i.transform(n.data,a);if(n.common.async)return Promise.resolve(s).then(async o=>{if(r.value==="aborted")return Pe;const c=await this._def.schema._parseAsync({data:o,path:n.path,parent:n});return c.status==="aborted"?Pe:c.status==="dirty"||r.value==="dirty"?qa(c.value):c});{if(r.value==="aborted")return Pe;const o=this._def.schema._parseSync({data:s,path:n.path,parent:n});return o.status==="aborted"?Pe:o.status==="dirty"||r.value==="dirty"?qa(o.value):o}}if(i.type==="refinement"){const s=o=>{const c=i.refinement(o,a);if(n.common.async)return Promise.resolve(c);if(c instanceof Promise)throw new Error("Async refinement encountered during synchronous parse operation. Use .parseAsync instead.");return o};if(n.common.async===!1){const o=this._def.schema._parseSync({data:n.data,path:n.path,parent:n});return o.status==="aborted"?Pe:(o.status==="dirty"&&r.dirty(),s(o.value),{status:r.value,value:o.value})}else return this._def.schema._parseAsync({data:n.data,path:n.path,parent:n}).then(o=>o.status==="aborted"?Pe:(o.status==="dirty"&&r.dirty(),s(o.value).then(()=>({status:r.value,value:o.value}))))}if(i.type==="transform")if(n.common.async===!1){const s=this._def.schema._parseSync({data:n.data,path:n.path,parent:n});if(!ca(s))return Pe;const o=i.transform(s.value,a);if(o instanceof Promise)throw new Error("Asynchronous transform encountered during synchronous parse operation. Use .parseAsync instead.");return{status:r.value,value:o}}else return this._def.schema._parseAsync({data:n.data,path:n.path,parent:n}).then(s=>ca(s)?Promise.resolve(i.transform(s.value,a)).then(o=>({status:r.value,value:o})):Pe);Je.assertNever(i)}}la.create=(e,t,r)=>new la({schema:e,typeName:ee.ZodEffects,effect:t,...Ue(r)});la.createWithPreprocess=(e,t,r)=>new la({schema:t,effect:{type:"preprocess",transform:e},typeName:ee.ZodEffects,...Ue(r)});class Nn extends We{_parse(t){return this._getType(t)===pe.undefined?_r(void 0):this._def.innerType._parse(t)}unwrap(){return this._def.innerType}}Nn.create=(e,t)=>new Nn({innerType:e,typeName:ee.ZodOptional,...Ue(t)});class da extends We{_parse(t){return this._getType(t)===pe.null?_r(null):this._def.innerType._parse(t)}unwrap(){return this._def.innerType}}da.create=(e,t)=>new da({innerType:e,typeName:ee.ZodNullable,...Ue(t)});class qd extends We{_parse(t){const{ctx:r}=this._processInputParams(t);let n=r.data;return r.parsedType===pe.undefined&&(n=this._def.defaultValue()),this._def.innerType._parse({data:n,path:r.path,parent:r})}removeDefault(){return this._def.innerType}}qd.create=(e,t)=>new qd({innerType:e,typeName:ee.ZodDefault,defaultValue:typeof t.default=="function"?t.default:()=>t.default,...Ue(t)});class Hd extends We{_parse(t){const{ctx:r}=this._processInputParams(t),n={...r,common:{...r.common,issues:[]}},i=this._def.innerType._parse({data:n.data,path:n.path,parent:{...n}});return dc(i)?i.then(a=>({status:"valid",value:a.status==="valid"?a.value:this._def.catchValue({get error(){return new pn(n.common.issues)},input:n.data})})):{status:"valid",value:i.status==="valid"?i.value:this._def.catchValue({get error(){return new pn(n.common.issues)},input:n.data})}}removeCatch(){return this._def.innerType}}Hd.create=(e,t)=>new Hd({innerType:e,typeName:ee.ZodCatch,catchValue:typeof t.catch=="function"?t.catch:()=>t.catch,...Ue(t)});class Fg extends We{_parse(t){if(this._getType(t)!==pe.nan){const n=this._getOrReturnCtx(t);return le(n,{code:J.invalid_type,expected:pe.nan,received:n.parsedType}),Pe}return{status:"valid",value:t.data}}}Fg.create=e=>new Fg({typeName:ee.ZodNaN,...Ue(e)});class y1 extends We{_parse(t){const{ctx:r}=this._processInputParams(t),n=r.data;return this._def.type._parse({data:n,path:r.path,parent:r})}unwrap(){return this._def.type}}class Jf extends We{_parse(t){const{status:r,ctx:n}=this._processInputParams(t);if(n.common.async)return(async()=>{const a=await this._def.in._parseAsync({data:n.data,path:n.path,parent:n});return a.status==="aborted"?Pe:a.status==="dirty"?(r.dirty(),qa(a.value)):this._def.out._parseAsync({data:a.value,path:n.path,parent:n})})();{const i=this._def.in._parseSync({data:n.data,path:n.path,parent:n});return i.status==="aborted"?Pe:i.status==="dirty"?(r.dirty(),{status:"dirty",value:i.value}):this._def.out._parseSync({data:i.value,path:n.path,parent:n})}}static create(t,r){return new Jf({in:t,out:r,typeName:ee.ZodPipeline})}}class Kd extends We{_parse(t){const r=this._def.innerType._parse(t),n=i=>(ca(i)&&(i.value=Object.freeze(i.value)),i);return dc(r)?r.then(i=>n(i)):n(r)}unwrap(){return this._def.innerType}}Kd.create=(e,t)=>new Kd({innerType:e,typeName:ee.ZodReadonly,...Ue(t)});var ee;(function(e){e.ZodString="ZodString",e.ZodNumber="ZodNumber",e.ZodNaN="ZodNaN",e.ZodBigInt="ZodBigInt",e.ZodBoolean="ZodBoolean",e.ZodDate="ZodDate",e.ZodSymbol="ZodSymbol",e.ZodUndefined="ZodUndefined",e.ZodNull="ZodNull",e.ZodAny="ZodAny",e.ZodUnknown="ZodUnknown",e.ZodNever="ZodNever",e.ZodVoid="ZodVoid",e.ZodArray="ZodArray",e.ZodObject="ZodObject",e.ZodUnion="ZodUnion",e.ZodDiscriminatedUnion="ZodDiscriminatedUnion",e.ZodIntersection="ZodIntersection",e.ZodTuple="ZodTuple",e.ZodRecord="ZodRecord",e.ZodMap="ZodMap",e.ZodSet="ZodSet",e.ZodFunction="ZodFunction",e.ZodLazy="ZodLazy",e.ZodLiteral="ZodLiteral",e.ZodEnum="ZodEnum",e.ZodEffects="ZodEffects",e.ZodNativeEnum="ZodNativeEnum",e.ZodOptional="ZodOptional",e.ZodNullable="ZodNullable",e.ZodDefault="ZodDefault",e.ZodCatch="ZodCatch",e.ZodPromise="ZodPromise",e.ZodBranded="ZodBranded",e.ZodPipeline="ZodPipeline",e.ZodReadonly="ZodReadonly"})(ee||(ee={}));const v1=An.create,Bg=zd.create;Fn.create;qr.create;const _1=pt.create;hc.create;pc.create;Ei.create;ua.create;mc.create;Nn.create;da.create;function w1(e,t){const r={type:"array"};return e.type?._def&&e.type?._def?.typeName!==ee.ZodAny&&(r.items=Qe(e.type._def,{...t,currentPath:[...t.currentPath,"items"]})),e.minLength&&Ye(r,"minItems",e.minLength.value,e.minLength.message,t),e.maxLength&&Ye(r,"maxItems",e.maxLength.value,e.maxLength.message,t),e.exactLength&&(Ye(r,"minItems",e.exactLength.value,e.exactLength.message,t),Ye(r,"maxItems",e.exactLength.value,e.exactLength.message,t)),r}function b1(e,t){const r={type:"integer",format:"int64"};if(!e.checks)return r;for(const n of e.checks)switch(n.kind){case"min":t.target==="jsonSchema7"?n.inclusive?Ye(r,"minimum",n.value,n.message,t):Ye(r,"exclusiveMinimum",n.value,n.message,t):(n.inclusive||(r.exclusiveMinimum=!0),Ye(r,"minimum",n.value,n.message,t));break;case"max":t.target==="jsonSchema7"?n.inclusive?Ye(r,"maximum",n.value,n.message,t):Ye(r,"exclusiveMaximum",n.value,n.message,t):(n.inclusive||(r.exclusiveMaximum=!0),Ye(r,"maximum",n.value,n.message,t));break;case"multipleOf":Ye(r,"multipleOf",n.value,n.message,t);break}return r}function E1(){return{type:"boolean"}}function Sw(e,t){return Qe(e.type._def,t)}const x1=(e,t)=>Qe(e.innerType._def,t);function kw(e,t,r){const n=r??t.dateStrategy;if(Array.isArray(n))return{anyOf:n.map(i=>kw(e,t,i))};switch(n){case"string":case"format:date-time":return{type:"string",format:"date-time"};case"format:date":return{type:"string",format:"date"};case"integer":return S1(e,t)}}const S1=(e,t)=>{const r={type:"integer",format:"unix-time"};if(t.target==="openApi3")return r;for(const n of e.checks)switch(n.kind){case"min":Ye(r,"minimum",n.value,n.message,t);break;case"max":Ye(r,"maximum",n.value,n.message,t);break}return r};function k1(e,t){return{...Qe(e.innerType._def,t),default:e.defaultValue()}}function I1(e,t){return t.effectStrategy==="input"?Qe(e.schema._def,t):Vt(t)}function O1(e){return{type:"string",enum:Array.from(e.values)}}const T1=e=>"type"in e&&e.type==="string"?!1:"allOf"in e;function R1(e,t){const r=[Qe(e.left._def,{...t,currentPath:[...t.currentPath,"allOf","0"]}),Qe(e.right._def,{...t,currentPath:[...t.currentPath,"allOf","1"]})].filter(a=>!!a);let n=t.target==="jsonSchema2019-09"?{unevaluatedProperties:!1}:void 0;const i=[];return r.forEach(a=>{if(T1(a))i.push(...a.allOf),a.unevaluatedProperties===void 0&&(n=void 0);else{let s=a;if("additionalProperties"in a&&a.additionalProperties===!1){const{additionalProperties:o,...c}=a;s=c}else n=void 0;i.push(s)}}),i.length?{allOf:i,...n}:void 0}function A1(e,t){const r=typeof e.value;return r!=="bigint"&&r!=="number"&&r!=="boolean"&&r!=="string"?{type:Array.isArray(e.value)?"array":"object"}:t.target==="openApi3"?{type:r==="bigint"?"integer":r,enum:[e.value]}:{type:r==="bigint"?"integer":r,const:e.value}}let Ql;const xr={cuid:/^[cC][^\s-]{8,}$/,cuid2:/^[0-9a-z]+$/,ulid:/^[0-9A-HJKMNP-TV-Z]{26}$/,email:/^(?!\.)(?!.*\.\.)([a-zA-Z0-9_'+\-\.]*)[a-zA-Z0-9_+-]@([a-zA-Z0-9][a-zA-Z0-9\-]*\.)+[a-zA-Z]{2,}$/,emoji:()=>(Ql===void 0&&(Ql=RegExp("^(\\p{Extended_Pictographic}|\\p{Emoji_Component})+$","u")),Ql),uuid:/^[0-9a-fA-F]{8}\b-[0-9a-fA-F]{4}\b-[0-9a-fA-F]{4}\b-[0-9a-fA-F]{4}\b-[0-9a-fA-F]{12}$/,ipv4:/^(?:(?:25[0-5]|2[0-4][0-9]|1[0-9][0-9]|[1-9][0-9]|[0-9])\.){3}(?:25[0-5]|2[0-4][0-9]|1[0-9][0-9]|[1-9][0-9]|[0-9])$/,ipv4Cidr:/^(?:(?:25[0-5]|2[0-4][0-9]|1[0-9][0-9]|[1-9][0-9]|[0-9])\.){3}(?:25[0-5]|2[0-4][0-9]|1[0-9][0-9]|[1-9][0-9]|[0-9])\/(3[0-2]|[12]?[0-9])$/,ipv6:/^(([a-f0-9]{1,4}:){7}|::([a-f0-9]{1,4}:){0,6}|([a-f0-9]{1,4}:){1}:([a-f0-9]{1,4}:){0,5}|([a-f0-9]{1,4}:){2}:([a-f0-9]{1,4}:){0,4}|([a-f0-9]{1,4}:){3}:([a-f0-9]{1,4}:){0,3}|([a-f0-9]{1,4}:){4}:([a-f0-9]{1,4}:){0,2}|([a-f0-9]{1,4}:){5}:([a-f0-9]{1,4}:){0,1})([a-f0-9]{1,4}|(((25[0-5])|(2[0-4][0-9])|(1[0-9]{2})|([0-9]{1,2}))\.){3}((25[0-5])|(2[0-4][0-9])|(1[0-9]{2})|([0-9]{1,2})))$/,ipv6Cidr:/^(([0-9a-fA-F]{1,4}:){7,7}[0-9a-fA-F]{1,4}|([0-9a-fA-F]{1,4}:){1,7}:|([0-9a-fA-F]{1,4}:){1,6}:[0-9a-fA-F]{1,4}|([0-9a-fA-F]{1,4}:){1,5}(:[0-9a-fA-F]{1,4}){1,2}|([0-9a-fA-F]{1,4}:){1,4}(:[0-9a-fA-F]{1,4}){1,3}|([0-9a-fA-F]{1,4}:){1,3}(:[0-9a-fA-F]{1,4}){1,4}|([0-9a-fA-F]{1,4}:){1,2}(:[0-9a-fA-F]{1,4}){1,5}|[0-9a-fA-F]{1,4}:((:[0-9a-fA-F]{1,4}){1,6})|:((:[0-9a-fA-F]{1,4}){1,7}|:)|fe80:(:[0-9a-fA-F]{0,4}){0,4}%[0-9a-zA-Z]{1,}|::(ffff(:0{1,4}){0,1}:){0,1}((25[0-5]|(2[0-4]|1{0,1}[0-9]){0,1}[0-9])\.){3,3}(25[0-5]|(2[0-4]|1{0,1}[0-9]){0,1}[0-9])|([0-9a-fA-F]{1,4}:){1,4}:((25[0-5]|(2[0-4]|1{0,1}[0-9]){0,1}[0-9])\.){3,3}(25[0-5]|(2[0-4]|1{0,1}[0-9]){0,1}[0-9]))\/(12[0-8]|1[01][0-9]|[1-9]?[0-9])$/,base64:/^([0-9a-zA-Z+/]{4})*(([0-9a-zA-Z+/]{2}==)|([0-9a-zA-Z+/]{3}=))?$/,base64url:/^([0-9a-zA-Z-_]{4})*(([0-9a-zA-Z-_]{2}(==)?)|([0-9a-zA-Z-_]{3}(=)?))?$/,nanoid:/^[a-zA-Z0-9_-]{21}$/,jwt:/^[A-Za-z0-9-_]+\.[A-Za-z0-9-_]+\.[A-Za-z0-9-_]*$/};function Iw(e,t){const r={type:"string"};if(e.checks)for(const n of e.checks)switch(n.kind){case"min":Ye(r,"minLength",typeof r.minLength=="number"?Math.max(r.minLength,n.value):n.value,n.message,t);break;case"max":Ye(r,"maxLength",typeof r.maxLength=="number"?Math.min(r.maxLength,n.value):n.value,n.message,t);break;case"email":switch(t.emailStrategy){case"format:email":Sr(r,"email",n.message,t);break;case"format:idn-email":Sr(r,"idn-email",n.message,t);break;case"pattern:zod":jt(r,xr.email,n.message,t);break}break;case"url":Sr(r,"uri",n.message,t);break;case"uuid":Sr(r,"uuid",n.message,t);break;case"regex":jt(r,n.regex,n.message,t);break;case"cuid":jt(r,xr.cuid,n.message,t);break;case"cuid2":jt(r,xr.cuid2,n.message,t);break;case"startsWith":jt(r,RegExp(`^${Yl(n.value,t)}`),n.message,t);break;case"endsWith":jt(r,RegExp(`${Yl(n.value,t)}$`),n.message,t);break;case"datetime":Sr(r,"date-time",n.message,t);break;case"date":Sr(r,"date",n.message,t);break;case"time":Sr(r,"time",n.message,t);break;case"duration":Sr(r,"duration",n.message,t);break;case"length":Ye(r,"minLength",typeof r.minLength=="number"?Math.max(r.minLength,n.value):n.value,n.message,t),Ye(r,"maxLength",typeof r.maxLength=="number"?Math.min(r.maxLength,n.value):n.value,n.message,t);break;case"includes":jt(r,RegExp(Yl(n.value,t)),n.message,t);break;case"ip":n.version!=="v6"&&Sr(r,"ipv4",n.message,t),n.version!=="v4"&&Sr(r,"ipv6",n.message,t);break;case"base64url":jt(r,xr.base64url,n.message,t);break;case"jwt":jt(r,xr.jwt,n.message,t);break;case"cidr":n.version!=="v6"&&jt(r,xr.ipv4Cidr,n.message,t),n.version!=="v4"&&jt(r,xr.ipv6Cidr,n.message,t);break;case"emoji":jt(r,xr.emoji(),n.message,t);break;case"ulid":jt(r,xr.ulid,n.message,t);break;case"base64":switch(t.base64Strategy){case"format:binary":Sr(r,"binary",n.message,t);break;case"contentEncoding:base64":Ye(r,"contentEncoding","base64",n.message,t);break;case"pattern:zod":jt(r,xr.base64,n.message,t);break}break;case"nanoid":jt(r,xr.nanoid,n.message,t);break}return r}function Yl(e,t){return t.patternStrategy==="escape"?C1(e):e}const $1=new Set("ABCDEFGHIJKLMNOPQRSTUVXYZabcdefghijklmnopqrstuvxyz0123456789");function C1(e){let t="";for(let r=0;r<e.length;r++)$1.has(e[r])||(t+="\\"),t+=e[r];return t}function Sr(e,t,r,n){e.format||e.anyOf?.some(i=>i.format)?(e.anyOf||(e.anyOf=[]),e.format&&(e.anyOf.push({format:e.format,...e.errorMessage&&n.errorMessages&&{errorMessage:{format:e.errorMessage.format}}}),delete e.format,e.errorMessage&&(delete e.errorMessage.format,Object.keys(e.errorMessage).length===0&&delete e.errorMessage)),e.anyOf.push({format:t,...r&&n.errorMessages&&{errorMessage:{format:r}}})):Ye(e,"format",t,r,n)}function jt(e,t,r,n){e.pattern||e.allOf?.some(i=>i.pattern)?(e.allOf||(e.allOf=[]),e.pattern&&(e.allOf.push({pattern:e.pattern,...e.errorMessage&&n.errorMessages&&{errorMessage:{pattern:e.errorMessage.pattern}}}),delete e.pattern,e.errorMessage&&(delete e.errorMessage.pattern,Object.keys(e.errorMessage).length===0&&delete e.errorMessage)),e.allOf.push({pattern:zg(t,n),...r&&n.errorMessages&&{errorMessage:{pattern:r}}})):Ye(e,"pattern",zg(t,n),r,n)}function zg(e,t){if(!t.applyRegexFlags||!e.flags)return e.source;const r={i:e.flags.includes("i"),m:e.flags.includes("m"),s:e.flags.includes("s")},n=r.i?e.source.toLowerCase():e.source;let i="",a=!1,s=!1,o=!1;for(let c=0;c<n.length;c++){if(a){i+=n[c],a=!1;continue}if(r.i){if(s){if(n[c].match(/[a-z]/)){o?(i+=n[c],i+=`${n[c-2]}-${n[c]}`.toUpperCase(),o=!1):n[c+1]==="-"&&n[c+2]?.match(/[a-z]/)?(i+=n[c],o=!0):i+=`${n[c]}${n[c].toUpperCase()}`;continue}}else if(n[c].match(/[a-z]/)){i+=`[${n[c]}${n[c].toUpperCase()}]`;continue}}if(r.m){if(n[c]==="^"){i+=`(^|(?<=[\r
]))`;continue}else if(n[c]==="$"){i+=`($|(?=[\r
]))`;continue}}if(r.s&&n[c]==="."){i+=s?`${n[c]}\r
`:`[${n[c]}\r
]`;continue}i+=n[c],n[c]==="\\"?a=!0:s&&n[c]==="]"?s=!1:!s&&n[c]==="["&&(s=!0)}try{new RegExp(i)}catch{return console.warn(`Could not convert regex pattern at ${t.currentPath.join("/")} to a flag-independent form! Falling back to the flag-ignorant source`),e.source}return i}function Ow(e,t){if(t.target==="openAi"&&console.warn("Warning: OpenAI may not support records in schemas! Try an array of key-value pairs instead."),t.target==="openApi3"&&e.keyType?._def.typeName===ee.ZodEnum)return{type:"object",required:e.keyType._def.values,properties:e.keyType._def.values.reduce((n,i)=>({...n,[i]:Qe(e.valueType._def,{...t,currentPath:[...t.currentPath,"properties",i]})??Vt(t)}),{}),additionalProperties:t.rejectedAdditionalProperties};const r={type:"object",additionalProperties:Qe(e.valueType._def,{...t,currentPath:[...t.currentPath,"additionalProperties"]})??t.allowedAdditionalProperties};if(t.target==="openApi3")return r;if(e.keyType?._def.typeName===ee.ZodString&&e.keyType._def.checks?.length){const{type:n,...i}=Iw(e.keyType._def,t);return{...r,propertyNames:i}}else{if(e.keyType?._def.typeName===ee.ZodEnum)return{...r,propertyNames:{enum:e.keyType._def.values}};if(e.keyType?._def.typeName===ee.ZodBranded&&e.keyType._def.type._def.typeName===ee.ZodString&&e.keyType._def.type._def.checks?.length){const{type:n,...i}=Sw(e.keyType._def,t);return{...r,propertyNames:i}}}return r}function P1(e,t){if(t.mapStrategy==="record")return Ow(e,t);const r=Qe(e.keyType._def,{...t,currentPath:[...t.currentPath,"items","items","0"]})||Vt(t),n=Qe(e.valueType._def,{...t,currentPath:[...t.currentPath,"items","items","1"]})||Vt(t);return{type:"array",maxItems:125,items:{type:"array",items:[r,n],minItems:2,maxItems:2}}}function N1(e){const t=e.values,n=Object.keys(e.values).filter(a=>typeof t[t[a]]!="number").map(a=>t[a]),i=Array.from(new Set(n.map(a=>typeof a)));return{type:i.length===1?i[0]==="string"?"string":"number":["string","number"],enum:n}}function D1(e){return e.target==="openAi"?void 0:{not:Vt({...e,currentPath:[...e.currentPath,"not"]})}}function M1(e){return e.target==="openApi3"?{enum:["null"],nullable:!0}:{type:"null"}}const gc={ZodString:"string",ZodNumber:"number",ZodBigInt:"integer",ZodBoolean:"boolean",ZodNull:"null"};function L1(e,t){if(t.target==="openApi3")return Ug(e,t);const r=e.options instanceof Map?Array.from(e.options.values()):e.options;if(r.every(n=>n._def.typeName in gc&&(!n._def.checks||!n._def.checks.length))){const n=r.reduce((i,a)=>{const s=gc[a._def.typeName];return s&&!i.includes(s)?[...i,s]:i},[]);return{type:n.length>1?n:n[0]}}else if(r.every(n=>n._def.typeName==="ZodLiteral"&&!n.description)){const n=r.reduce((i,a)=>{const s=typeof a._def.value;switch(s){case"string":case"number":case"boolean":return[...i,s];case"bigint":return[...i,"integer"];case"object":return a._def.value===null?[...i,"null"]:i;case"symbol":case"undefined":case"function":default:return i}},[]);if(n.length===r.length){const i=n.filter((a,s,o)=>o.indexOf(a)===s);return{type:i.length>1?i:i[0],enum:r.reduce((a,s)=>a.includes(s._def.value)?a:[...a,s._def.value],[])}}}else if(r.every(n=>n._def.typeName==="ZodEnum"))return{type:"string",enum:r.reduce((n,i)=>[...n,...i._def.values.filter(a=>!n.includes(a))],[])};return Ug(e,t)}const Ug=(e,t)=>{const r=(e.options instanceof Map?Array.from(e.options.values()):e.options).map((n,i)=>Qe(n._def,{...t,currentPath:[...t.currentPath,"anyOf",`${i}`]})).filter(n=>!!n&&(!t.strictUnions||typeof n=="object"&&Object.keys(n).length>0));return r.length?{anyOf:r}:void 0};function j1(e,t){if(["ZodString","ZodNumber","ZodBigInt","ZodBoolean","ZodNull"].includes(e.innerType._def.typeName)&&(!e.innerType._def.checks||!e.innerType._def.checks.length))return t.target==="openApi3"?{type:gc[e.innerType._def.typeName],nullable:!0}:{type:[gc[e.innerType._def.typeName],"null"]};if(t.target==="openApi3"){const n=Qe(e.innerType._def,{...t,currentPath:[...t.currentPath]});return n&&"$ref"in n?{allOf:[n],nullable:!0}:n&&{...n,nullable:!0}}const r=Qe(e.innerType._def,{...t,currentPath:[...t.currentPath,"anyOf","0"]});return r&&{anyOf:[r,{type:"null"}]}}function F1(e,t){const r={type:"number"};if(!e.checks)return r;for(const n of e.checks)switch(n.kind){case"int":r.type="integer",ww(r,"type",n.message,t);break;case"min":t.target==="jsonSchema7"?n.inclusive?Ye(r,"minimum",n.value,n.message,t):Ye(r,"exclusiveMinimum",n.value,n.message,t):(n.inclusive||(r.exclusiveMinimum=!0),Ye(r,"minimum",n.value,n.message,t));break;case"max":t.target==="jsonSchema7"?n.inclusive?Ye(r,"maximum",n.value,n.message,t):Ye(r,"exclusiveMaximum",n.value,n.message,t):(n.inclusive||(r.exclusiveMaximum=!0),Ye(r,"maximum",n.value,n.message,t));break;case"multipleOf":Ye(r,"multipleOf",n.value,n.message,t);break}return r}function B1(e,t){const r=t.target==="openAi",n={type:"object",properties:{}},i=[],a=e.shape();for(const o in a){let c=a[o];if(c===void 0||c._def===void 0)continue;let u=U1(c);u&&r&&(c._def.typeName==="ZodOptional"&&(c=c._def.innerType),c.isNullable()||(c=c.nullable()),u=!1);const d=Qe(c._def,{...t,currentPath:[...t.currentPath,"properties",o],propertyPath:[...t.currentPath,"properties",o]});d!==void 0&&(n.properties[o]=d,u||i.push(o))}i.length&&(n.required=i);const s=z1(e,t);return s!==void 0&&(n.additionalProperties=s),n}function z1(e,t){if(e.catchall._def.typeName!=="ZodNever")return Qe(e.catchall._def,{...t,currentPath:[...t.currentPath,"additionalProperties"]});switch(e.unknownKeys){case"passthrough":return t.allowedAdditionalProperties;case"strict":return t.rejectedAdditionalProperties;case"strip":return t.removeAdditionalStrategy==="strict"?t.allowedAdditionalProperties:t.rejectedAdditionalProperties}}function U1(e){try{return e.isOptional()}catch{return!0}}const q1=(e,t)=>{if(t.currentPath.toString()===t.propertyPath?.toString())return Qe(e.innerType._def,t);const r=Qe(e.innerType._def,{...t,currentPath:[...t.currentPath,"anyOf","1"]});return r?{anyOf:[{not:Vt(t)},r]}:Vt(t)},H1=(e,t)=>{if(t.pipeStrategy==="input")return Qe(e.in._def,t);if(t.pipeStrategy==="output")return Qe(e.out._def,t);const r=Qe(e.in._def,{...t,currentPath:[...t.currentPath,"allOf","0"]}),n=Qe(e.out._def,{...t,currentPath:[...t.currentPath,"allOf",r?"1":"0"]});return{allOf:[r,n].filter(i=>i!==void 0)}};function K1(e,t){return Qe(e.type._def,t)}function G1(e,t){const n={type:"array",uniqueItems:!0,items:Qe(e.valueType._def,{...t,currentPath:[...t.currentPath,"items"]})};return e.minSize&&Ye(n,"minItems",e.minSize.value,e.minSize.message,t),e.maxSize&&Ye(n,"maxItems",e.maxSize.value,e.maxSize.message,t),n}function W1(e,t){return e.rest?{type:"array",minItems:e.items.length,items:e.items.map((r,n)=>Qe(r._def,{...t,currentPath:[...t.currentPath,"items",`${n}`]})).reduce((r,n)=>n===void 0?r:[...r,n],[]),additionalItems:Qe(e.rest._def,{...t,currentPath:[...t.currentPath,"additionalItems"]})}:{type:"array",minItems:e.items.length,maxItems:e.items.length,items:e.items.map((r,n)=>Qe(r._def,{...t,currentPath:[...t.currentPath,"items",`${n}`]})).reduce((r,n)=>n===void 0?r:[...r,n],[])}}function V1(e){return{not:Vt(e)}}function Z1(e){return Vt(e)}const J1=(e,t)=>Qe(e.innerType._def,t),Q1=(e,t,r)=>{switch(t){case ee.ZodString:return Iw(e,r);case ee.ZodNumber:return F1(e,r);case ee.ZodObject:return B1(e,r);case ee.ZodBigInt:return b1(e,r);case ee.ZodBoolean:return E1();case ee.ZodDate:return kw(e,r);case ee.ZodUndefined:return V1(r);case ee.ZodNull:return M1(r);case ee.ZodArray:return w1(e,r);case ee.ZodUnion:case ee.ZodDiscriminatedUnion:return L1(e,r);case ee.ZodIntersection:return R1(e,r);case ee.ZodTuple:return W1(e,r);case ee.ZodRecord:return Ow(e,r);case ee.ZodLiteral:return A1(e,r);case ee.ZodEnum:return O1(e);case ee.ZodNativeEnum:return N1(e);case ee.ZodNullable:return j1(e,r);case ee.ZodOptional:return q1(e,r);case ee.ZodMap:return P1(e,r);case ee.ZodSet:return G1(e,r);case ee.ZodLazy:return()=>e.getter()._def;case ee.ZodPromise:return K1(e,r);case ee.ZodNaN:case ee.ZodNever:return D1(r);case ee.ZodEffects:return I1(e,r);case ee.ZodAny:return Vt(r);case ee.ZodUnknown:return Z1(r);case ee.ZodDefault:return k1(e,r);case ee.ZodBranded:return Sw(e,r);case ee.ZodReadonly:return J1(e,r);case ee.ZodCatch:return x1(e,r);case ee.ZodPipeline:return H1(e,r);case ee.ZodFunction:case ee.ZodVoid:case ee.ZodSymbol:return;default:return(n=>{})()}};function Qe(e,t,r=!1){const n=t.seen.get(e);if(t.override){const o=t.override?.(e,t,n,r);if(o!==UC)return o}if(n&&!r){const o=Y1(n,t);if(o!==void 0)return o}const i={def:e,path:t.currentPath,jsonSchema:void 0};t.seen.set(e,i);const a=Q1(e,e.typeName,t),s=typeof a=="function"?Qe(a(),t):a;if(s&&X1(e,t,s),t.postProcess){const o=t.postProcess(s,e,t);return i.jsonSchema=s,o}return i.jsonSchema=s,s}const Y1=(e,t)=>{switch(t.$refStrategy){case"root":return{$ref:e.path.join("/")};case"relative":return{$ref:_w(t.currentPath,e.path)};case"none":case"seen":return e.path.length<t.currentPath.length&&e.path.every((r,n)=>t.currentPath[n]===r)?(console.warn(`Recursive reference detected at ${t.currentPath.join("/")}! Defaulting to any`),Vt(t)):t.$refStrategy==="seen"?Vt(t):void 0}},X1=(e,t,r)=>(e.description&&(r.description=e.description,t.markdownDescription&&(r.markdownDescription=e.description)),r),eP=(e,t)=>{const r=KC(t);let n=typeof t=="object"&&t.definitions?Object.entries(t.definitions).reduce((o,[c,u])=>({...o,[c]:Qe(u._def,{...r,currentPath:[...r.basePath,r.definitionPath,c]},!0)??Vt(r)}),{}):void 0;const i=typeof t=="string"?t:t?.name,a=Qe(e._def,r,!1)??Vt(r);r.flags.hasReferencedOpenAiAnyType&&(n||(n={}),n[r.openAiAnyTypeName]||(n[r.openAiAnyTypeName]={type:["string","number","integer","boolean","array","null"],items:{$ref:r.$refStrategy==="relative"?"1":[...r.basePath,r.definitionPath,r.openAiAnyTypeName].join("/")}}));const s=i===void 0?n?{...a,[r.definitionPath]:n}:a:{$ref:[...r.$refStrategy==="relative"?[]:r.basePath,r.definitionPath,i].join("/"),[r.definitionPath]:{...n,[i]:a}};return r.target==="jsonSchema7"?s.$schema="http://json-schema.org/draft-07/schema#":(r.target==="jsonSchema2019-09"||r.target==="openAi")&&(s.$schema="https://json-schema.org/draft/2019-09/schema#"),r.target==="openAi"&&("anyOf"in s||"oneOf"in s||"allOf"in s||"type"in s&&Array.isArray(s.type))&&console.warn("Warning: OpenAI may not support schemas with unions as roots! Try wrapping it in an object property."),s};function Yi(e,t){const r=typeof e;if(r!==typeof t)return!1;if(Array.isArray(e)){if(!Array.isArray(t))return!1;const n=e.length;if(n!==t.length)return!1;for(let i=0;i<n;i++)if(!Yi(e[i],t[i]))return!1;return!0}if(r==="object"){if(!e||!t)return e===t;const n=Object.keys(e),i=Object.keys(t);if(n.length!==i.length)return!1;for(const s of n)if(!Yi(e[s],t[s]))return!1;return!0}return e===t}function kr(e){return encodeURI(tP(e))}function tP(e){return e.replace(/~/g,"~0").replace(/\//g,"~1")}const rP={prefixItems:!0,items:!0,allOf:!0,anyOf:!0,oneOf:!0},nP={$defs:!0,definitions:!0,properties:!0,patternProperties:!0,dependentSchemas:!0},iP={id:!0,$id:!0,$ref:!0,$schema:!0,$anchor:!0,$vocabulary:!0,$comment:!0,default:!0,enum:!0,const:!0,required:!0,type:!0,maximum:!0,minimum:!0,exclusiveMaximum:!0,exclusiveMinimum:!0,multipleOf:!0,maxLength:!0,minLength:!0,pattern:!0,format:!0,maxItems:!0,minItems:!0,uniqueItems:!0,maxProperties:!0,minProperties:!0};let aP=typeof self<"u"&&self.location&&self.location.origin!=="null"?new URL(self.location.origin+self.location.pathname+location.search):new URL("https://github.com/cfworker");function $n(e,t=Object.create(null),r=aP,n=""){if(e&&typeof e=="object"&&!Array.isArray(e)){const a=e.$id||e.id;if(a){const s=new URL(a,r.href);s.hash.length>1?t[s.href]=e:(s.hash="",n===""?r=s:$n(e,t,r))}}else if(e!==!0&&e!==!1)return t;const i=r.href+(n?"#"+n:"");if(t[i]!==void 0)throw new Error(`Duplicate schema URI "${i}".`);if(t[i]=e,e===!0||e===!1)return t;if(e.__absolute_uri__===void 0&&Object.defineProperty(e,"__absolute_uri__",{enumerable:!1,value:i}),e.$ref&&e.__absolute_ref__===void 0){const a=new URL(e.$ref,r.href);a.hash=a.hash,Object.defineProperty(e,"__absolute_ref__",{enumerable:!1,value:a.href})}if(e.$recursiveRef&&e.__absolute_recursive_ref__===void 0){const a=new URL(e.$recursiveRef,r.href);a.hash=a.hash,Object.defineProperty(e,"__absolute_recursive_ref__",{enumerable:!1,value:a.href})}if(e.$anchor){const a=new URL("#"+e.$anchor,r.href);t[a.href]=e}for(let a in e){if(iP[a])continue;const s=`${n}/${kr(a)}`,o=e[a];if(Array.isArray(o)){if(rP[a]){const c=o.length;for(let u=0;u<c;u++)$n(o[u],t,r,`${s}/${u}`)}}else if(nP[a])for(let c in o)$n(o[c],t,r,`${s}/${kr(c)}`);else $n(o,t,r,s)}return t}const sP=/^(\d\d\d\d)-(\d\d)-(\d\d)$/,oP=[0,31,28,31,30,31,30,31,31,30,31,30,31],cP=/^(\d\d):(\d\d):(\d\d)(\.\d+)?(z|[+-]\d\d(?::?\d\d)?)?$/i,uP=/^(?=.{1,253}\.?$)[a-z0-9](?:[a-z0-9-]{0,61}[a-z0-9])?(?:\.[a-z0-9](?:[-0-9a-z]{0,61}[0-9a-z])?)*\.?$/i,lP=/^(?:[a-z][a-z0-9+\-.]*:)?(?:\/?\/(?:(?:[a-z0-9\-._~!$&'()*+,;=:]|%[0-9a-f]{2})*@)?(?:\[(?:(?:(?:(?:[0-9a-f]{1,4}:){6}|::(?:[0-9a-f]{1,4}:){5}|(?:[0-9a-f]{1,4})?::(?:[0-9a-f]{1,4}:){4}|(?:(?:[0-9a-f]{1,4}:){0,1}[0-9a-f]{1,4})?::(?:[0-9a-f]{1,4}:){3}|(?:(?:[0-9a-f]{1,4}:){0,2}[0-9a-f]{1,4})?::(?:[0-9a-f]{1,4}:){2}|(?:(?:[0-9a-f]{1,4}:){0,3}[0-9a-f]{1,4})?::[0-9a-f]{1,4}:|(?:(?:[0-9a-f]{1,4}:){0,4}[0-9a-f]{1,4})?::)(?:[0-9a-f]{1,4}:[0-9a-f]{1,4}|(?:(?:25[0-5]|2[0-4]\d|[01]?\d\d?)\.){3}(?:25[0-5]|2[0-4]\d|[01]?\d\d?))|(?:(?:[0-9a-f]{1,4}:){0,5}[0-9a-f]{1,4})?::[0-9a-f]{1,4}|(?:(?:[0-9a-f]{1,4}:){0,6}[0-9a-f]{1,4})?::)|[Vv][0-9a-f]+\.[a-z0-9\-._~!$&'()*+,;=:]+)\]|(?:(?:25[0-5]|2[0-4]\d|[01]?\d\d?)\.){3}(?:25[0-5]|2[0-4]\d|[01]?\d\d?)|(?:[a-z0-9\-._~!$&'"()*+,;=]|%[0-9a-f]{2})*)(?::\d*)?(?:\/(?:[a-z0-9\-._~!$&'"()*+,;=:@]|%[0-9a-f]{2})*)*|\/(?:(?:[a-z0-9\-._~!$&'"()*+,;=:@]|%[0-9a-f]{2})+(?:\/(?:[a-z0-9\-._~!$&'"()*+,;=:@]|%[0-9a-f]{2})*)*)?|(?:[a-z0-9\-._~!$&'"()*+,;=:@]|%[0-9a-f]{2})+(?:\/(?:[a-z0-9\-._~!$&'"()*+,;=:@]|%[0-9a-f]{2})*)*)?(?:\?(?:[a-z0-9\-._~!$&'"()*+,;=:@/?]|%[0-9a-f]{2})*)?(?:#(?:[a-z0-9\-._~!$&'"()*+,;=:@/?]|%[0-9a-f]{2})*)?$/i,dP=/^(?:(?:[^\x00-\x20"'<>%\\^`{|}]|%[0-9a-f]{2})|\{[+#./;?&=,!@|]?(?:[a-z0-9_]|%[0-9a-f]{2})+(?::[1-9][0-9]{0,3}|\*)?(?:,(?:[a-z0-9_]|%[0-9a-f]{2})+(?::[1-9][0-9]{0,3}|\*)?)*\})*$/i,fP=/^(?:(?:https?|ftp):\/\/)(?:\S+(?::\S*)?@)?(?:(?!10(?:\.\d{1,3}){3})(?!127(?:\.\d{1,3}){3})(?!169\.254(?:\.\d{1,3}){2})(?!192\.168(?:\.\d{1,3}){2})(?!172\.(?:1[6-9]|2\d|3[0-1])(?:\.\d{1,3}){2})(?:[1-9]\d?|1\d\d|2[01]\d|22[0-3])(?:\.(?:1?\d{1,2}|2[0-4]\d|25[0-5])){2}(?:\.(?:[1-9]\d?|1\d\d|2[0-4]\d|25[0-4]))|(?:(?:[a-z\u{00a1}-\u{ffff}0-9]+-?)*[a-z\u{00a1}-\u{ffff}0-9]+)(?:\.(?:[a-z\u{00a1}-\u{ffff}0-9]+-?)*[a-z\u{00a1}-\u{ffff}0-9]+)*(?:\.(?:[a-z\u{00a1}-\u{ffff}]{2,})))(?::\d{2,5})?(?:\/[^\s]*)?$/iu,hP=/^(?:urn:uuid:)?[0-9a-f]{8}-(?:[0-9a-f]{4}-){3}[0-9a-f]{12}$/i,pP=/^(?:\/(?:[^~/]|~0|~1)*)*$/,mP=/^#(?:\/(?:[a-z0-9_\-.!$&'()*+,;:=@]|%[0-9a-f]{2}|~0|~1)*)*$/i,gP=/^(?:0|[1-9][0-9]*)(?:#|(?:\/(?:[^~/]|~0|~1)*)*)$/,yP=e=>{if(e[0]==='"')return!1;const[t,r,...n]=e.split("@");return!t||!r||n.length!==0||t.length>64||r.length>253||t[0]==="."||t.endsWith(".")||t.includes("..")||!/^[a-z0-9.-]+$/i.test(r)||!/^[a-z0-9.!#$%&'*+/=?^_`{|}~-]+$/i.test(t)?!1:r.split(".").every(i=>/^[a-z0-9]([a-z0-9-]{0,61}[a-z0-9])?$/i.test(i))},vP=/^(?:(?:25[0-5]|2[0-4]\d|[01]?\d\d?)\.){3}(?:25[0-5]|2[0-4]\d|[01]?\d\d?)$/,_P=/^((([0-9a-f]{1,4}:){7}([0-9a-f]{1,4}|:))|(([0-9a-f]{1,4}:){6}(:[0-9a-f]{1,4}|((25[0-5]|2[0-4]\d|1\d\d|[1-9]?\d)(\.(25[0-5]|2[0-4]\d|1\d\d|[1-9]?\d)){3})|:))|(([0-9a-f]{1,4}:){5}(((:[0-9a-f]{1,4}){1,2})|:((25[0-5]|2[0-4]\d|1\d\d|[1-9]?\d)(\.(25[0-5]|2[0-4]\d|1\d\d|[1-9]?\d)){3})|:))|(([0-9a-f]{1,4}:){4}(((:[0-9a-f]{1,4}){1,3})|((:[0-9a-f]{1,4})?:((25[0-5]|2[0-4]\d|1\d\d|[1-9]?\d)(\.(25[0-5]|2[0-4]\d|1\d\d|[1-9]?\d)){3}))|:))|(([0-9a-f]{1,4}:){3}(((:[0-9a-f]{1,4}){1,4})|((:[0-9a-f]{1,4}){0,2}:((25[0-5]|2[0-4]\d|1\d\d|[1-9]?\d)(\.(25[0-5]|2[0-4]\d|1\d\d|[1-9]?\d)){3}))|:))|(([0-9a-f]{1,4}:){2}(((:[0-9a-f]{1,4}){1,5})|((:[0-9a-f]{1,4}){0,3}:((25[0-5]|2[0-4]\d|1\d\d|[1-9]?\d)(\.(25[0-5]|2[0-4]\d|1\d\d|[1-9]?\d)){3}))|:))|(([0-9a-f]{1,4}:){1}(((:[0-9a-f]{1,4}){1,6})|((:[0-9a-f]{1,4}){0,4}:((25[0-5]|2[0-4]\d|1\d\d|[1-9]?\d)(\.(25[0-5]|2[0-4]\d|1\d\d|[1-9]?\d)){3}))|:))|(:(((:[0-9a-f]{1,4}){1,7})|((:[0-9a-f]{1,4}){0,5}:((25[0-5]|2[0-4]\d|1\d\d|[1-9]?\d)(\.(25[0-5]|2[0-4]\d|1\d\d|[1-9]?\d)){3}))|:)))$/i,wP=e=>e.length>1&&e.length<80&&(/^P\d+([.,]\d+)?W$/.test(e)||/^P[\dYMDTHS]*(\d[.,]\d+)?[YMDHS]$/.test(e)&&/^P([.,\d]+Y)?([.,\d]+M)?([.,\d]+D)?(T([.,\d]+H)?([.,\d]+M)?([.,\d]+S)?)?$/.test(e));function Fr(e){return e.test.bind(e)}const qg={date:Tw,time:Rw.bind(void 0,!1),"date-time":xP,duration:wP,uri:IP,"uri-reference":Fr(lP),"uri-template":Fr(dP),url:Fr(fP),email:yP,hostname:Fr(uP),ipv4:Fr(vP),ipv6:Fr(_P),regex:TP,uuid:Fr(hP),"json-pointer":Fr(pP),"json-pointer-uri-fragment":Fr(mP),"relative-json-pointer":Fr(gP)};function bP(e){return e%4===0&&(e%100!==0||e%400===0)}function Tw(e){const t=e.match(sP);if(!t)return!1;const r=+t[1],n=+t[2],i=+t[3];return n>=1&&n<=12&&i>=1&&i<=(n==2&&bP(r)?29:oP[n])}function Rw(e,t){const r=t.match(cP);if(!r)return!1;const n=+r[1],i=+r[2],a=+r[3],s=!!r[5];return(n<=23&&i<=59&&a<=59||n==23&&i==59&&a==60)&&(!e||s)}const EP=/t|\s/i;function xP(e){const t=e.split(EP);return t.length==2&&Tw(t[0])&&Rw(!0,t[1])}const SP=/\/|:/,kP=/^(?:[a-z][a-z0-9+\-.]*:)(?:\/?\/(?:(?:[a-z0-9\-._~!$&'()*+,;=:]|%[0-9a-f]{2})*@)?(?:\[(?:(?:(?:(?:[0-9a-f]{1,4}:){6}|::(?:[0-9a-f]{1,4}:){5}|(?:[0-9a-f]{1,4})?::(?:[0-9a-f]{1,4}:){4}|(?:(?:[0-9a-f]{1,4}:){0,1}[0-9a-f]{1,4})?::(?:[0-9a-f]{1,4}:){3}|(?:(?:[0-9a-f]{1,4}:){0,2}[0-9a-f]{1,4})?::(?:[0-9a-f]{1,4}:){2}|(?:(?:[0-9a-f]{1,4}:){0,3}[0-9a-f]{1,4})?::[0-9a-f]{1,4}:|(?:(?:[0-9a-f]{1,4}:){0,4}[0-9a-f]{1,4})?::)(?:[0-9a-f]{1,4}:[0-9a-f]{1,4}|(?:(?:25[0-5]|2[0-4]\d|[01]?\d\d?)\.){3}(?:25[0-5]|2[0-4]\d|[01]?\d\d?))|(?:(?:[0-9a-f]{1,4}:){0,5}[0-9a-f]{1,4})?::[0-9a-f]{1,4}|(?:(?:[0-9a-f]{1,4}:){0,6}[0-9a-f]{1,4})?::)|[Vv][0-9a-f]+\.[a-z0-9\-._~!$&'()*+,;=:]+)\]|(?:(?:25[0-5]|2[0-4]\d|[01]?\d\d?)\.){3}(?:25[0-5]|2[0-4]\d|[01]?\d\d?)|(?:[a-z0-9\-._~!$&'()*+,;=]|%[0-9a-f]{2})*)(?::\d*)?(?:\/(?:[a-z0-9\-._~!$&'()*+,;=:@]|%[0-9a-f]{2})*)*|\/(?:(?:[a-z0-9\-._~!$&'()*+,;=:@]|%[0-9a-f]{2})+(?:\/(?:[a-z0-9\-._~!$&'()*+,;=:@]|%[0-9a-f]{2})*)*)?|(?:[a-z0-9\-._~!$&'()*+,;=:@]|%[0-9a-f]{2})+(?:\/(?:[a-z0-9\-._~!$&'()*+,;=:@]|%[0-9a-f]{2})*)*)(?:\?(?:[a-z0-9\-._~!$&'()*+,;=:@/?]|%[0-9a-f]{2})*)?(?:#(?:[a-z0-9\-._~!$&'()*+,;=:@/?]|%[0-9a-f]{2})*)?$/i;function IP(e){return SP.test(e)&&kP.test(e)}const OP=/[^\\]\\Z/;function TP(e){if(OP.test(e))return!1;try{return new RegExp(e,"u"),!0}catch{return!1}}function RP(e){let t=0,r=e.length,n=0,i;for(;n<r;)t++,i=e.charCodeAt(n++),i>=55296&&i<=56319&&n<r&&(i=e.charCodeAt(n),(i&64512)==56320&&n++);return t}function ot(e,t,r="2019-09",n=$n(t),i=!0,a=null,s="#",o="#",c=Object.create(null)){if(t===!0)return{valid:!0,errors:[]};if(t===!1)return{valid:!1,errors:[{instanceLocation:s,keyword:"false",keywordLocation:s,error:"False boolean schema."}]};const u=typeof e;let d;switch(u){case"boolean":case"number":case"string":d=u;break;case"object":e===null?d="null":Array.isArray(e)?d="array":d="object";break;default:throw new Error(`Instances of "${u}" type are not supported.`)}const{$ref:h,$recursiveRef:p,$recursiveAnchor:y,type:g,const:w,enum:b,required:S,not:O,anyOf:T,allOf:z,oneOf:B,if:G,then:q,else:K,format:Oe,properties:Le,patternProperties:qe,additionalProperties:$e,unevaluatedProperties:Ve,minProperties:Z,maxProperties:H,propertyNames:fe,dependentRequired:Q,dependentSchemas:te,dependencies:Y,prefixItems:re,items:xe,additionalItems:Re,unevaluatedItems:Te,contains:Ge,minContains:je,maxContains:_t,minItems:qn,maxItems:wa,uniqueItems:we,minimum:Nr,maximum:dr,exclusiveMinimum:Ke,exclusiveMaximum:br,multipleOf:Ai,minLength:fr,maxLength:$i,pattern:Fs,__absolute_ref__:Ci,__absolute_recursive_ref__:Fc}=t,ce=[];if(y===!0&&a===null&&(a=t),p==="#"){const ke=a===null?n[Fc]:a,me=`${o}/$recursiveRef`,Ae=ot(e,a===null?t:a,r,n,i,ke,s,me,c);Ae.valid||ce.push({instanceLocation:s,keyword:"$recursiveRef",keywordLocation:me,error:"A subschema had errors."},...Ae.errors)}if(h!==void 0){const me=n[Ci||h];if(me===void 0){let ie=`Unresolved $ref "${h}".`;throw Ci&&Ci!==h&&(ie+=`  Absolute URI "${Ci}".`),ie+=`
Known schemas:
- ${Object.keys(n).join(`
- `)}`,new Error(ie)}const Ae=`${o}/$ref`,ue=ot(e,me,r,n,i,a,s,Ae,c);if(ue.valid||ce.push({instanceLocation:s,keyword:"$ref",keywordLocation:Ae,error:"A subschema had errors."},...ue.errors),r==="4"||r==="7")return{valid:ce.length===0,errors:ce}}if(Array.isArray(g)){let ke=g.length,me=!1;for(let Ae=0;Ae<ke;Ae++)if(d===g[Ae]||g[Ae]==="integer"&&d==="number"&&e%1===0&&e===e){me=!0;break}me||ce.push({instanceLocation:s,keyword:"type",keywordLocation:`${o}/type`,error:`Instance type "${d}" is invalid. Expected "${g.join('", "')}".`})}else g==="integer"?(d!=="number"||e%1||e!==e)&&ce.push({instanceLocation:s,keyword:"type",keywordLocation:`${o}/type`,error:`Instance type "${d}" is invalid. Expected "${g}".`}):g!==void 0&&d!==g&&ce.push({instanceLocation:s,keyword:"type",keywordLocation:`${o}/type`,error:`Instance type "${d}" is invalid. Expected "${g}".`});if(w!==void 0&&(d==="object"||d==="array"?Yi(e,w)||ce.push({instanceLocation:s,keyword:"const",keywordLocation:`${o}/const`,error:`Instance does not match ${JSON.stringify(w)}.`}):e!==w&&ce.push({instanceLocation:s,keyword:"const",keywordLocation:`${o}/const`,error:`Instance does not match ${JSON.stringify(w)}.`})),b!==void 0&&(d==="object"||d==="array"?b.some(ke=>Yi(e,ke))||ce.push({instanceLocation:s,keyword:"enum",keywordLocation:`${o}/enum`,error:`Instance does not match any of ${JSON.stringify(b)}.`}):b.some(ke=>e===ke)||ce.push({instanceLocation:s,keyword:"enum",keywordLocation:`${o}/enum`,error:`Instance does not match any of ${JSON.stringify(b)}.`})),O!==void 0){const ke=`${o}/not`;ot(e,O,r,n,i,a,s,ke).valid&&ce.push({instanceLocation:s,keyword:"not",keywordLocation:ke,error:'Instance matched "not" schema.'})}let Dt=[];if(T!==void 0){const ke=`${o}/anyOf`,me=ce.length;let Ae=!1;for(let ue=0;ue<T.length;ue++){const ie=T[ue],Ie=Object.create(c),Se=ot(e,ie,r,n,i,y===!0?a:null,s,`${ke}/${ue}`,Ie);ce.push(...Se.errors),Ae=Ae||Se.valid,Se.valid&&Dt.push(Ie)}Ae?ce.length=me:ce.splice(me,0,{instanceLocation:s,keyword:"anyOf",keywordLocation:ke,error:"Instance does not match any subschemas."})}if(z!==void 0){const ke=`${o}/allOf`,me=ce.length;let Ae=!0;for(let ue=0;ue<z.length;ue++){const ie=z[ue],Ie=Object.create(c),Se=ot(e,ie,r,n,i,y===!0?a:null,s,`${ke}/${ue}`,Ie);ce.push(...Se.errors),Ae=Ae&&Se.valid,Se.valid&&Dt.push(Ie)}Ae?ce.length=me:ce.splice(me,0,{instanceLocation:s,keyword:"allOf",keywordLocation:ke,error:"Instance does not match every subschema."})}if(B!==void 0){const ke=`${o}/oneOf`,me=ce.length,Ae=B.filter((ue,ie)=>{const Ie=Object.create(c),Se=ot(e,ue,r,n,i,y===!0?a:null,s,`${ke}/${ie}`,Ie);return ce.push(...Se.errors),Se.valid&&Dt.push(Ie),Se.valid}).length;Ae===1?ce.length=me:ce.splice(me,0,{instanceLocation:s,keyword:"oneOf",keywordLocation:ke,error:`Instance does not match exactly one subschema (${Ae} matches).`})}if((d==="object"||d==="array")&&Object.assign(c,...Dt),G!==void 0){const ke=`${o}/if`;if(ot(e,G,r,n,i,a,s,ke,c).valid){if(q!==void 0){const Ae=ot(e,q,r,n,i,a,s,`${o}/then`,c);Ae.valid||ce.push({instanceLocation:s,keyword:"if",keywordLocation:ke,error:'Instance does not match "then" schema.'},...Ae.errors)}}else if(K!==void 0){const Ae=ot(e,K,r,n,i,a,s,`${o}/else`,c);Ae.valid||ce.push({instanceLocation:s,keyword:"if",keywordLocation:ke,error:'Instance does not match "else" schema.'},...Ae.errors)}}if(d==="object"){if(S!==void 0)for(const ue of S)ue in e||ce.push({instanceLocation:s,keyword:"required",keywordLocation:`${o}/required`,error:`Instance does not have required property "${ue}".`});const ke=Object.keys(e);if(Z!==void 0&&ke.length<Z&&ce.push({instanceLocation:s,keyword:"minProperties",keywordLocation:`${o}/minProperties`,error:`Instance does not have at least ${Z} properties.`}),H!==void 0&&ke.length>H&&ce.push({instanceLocation:s,keyword:"maxProperties",keywordLocation:`${o}/maxProperties`,error:`Instance does not have at least ${H} properties.`}),fe!==void 0){const ue=`${o}/propertyNames`;for(const ie in e){const Ie=`${s}/${kr(ie)}`,Se=ot(ie,fe,r,n,i,a,Ie,ue);Se.valid||ce.push({instanceLocation:s,keyword:"propertyNames",keywordLocation:ue,error:`Property name "${ie}" does not match schema.`},...Se.errors)}}if(Q!==void 0){const ue=`${o}/dependantRequired`;for(const ie in Q)if(ie in e){const Ie=Q[ie];for(const Se of Ie)Se in e||ce.push({instanceLocation:s,keyword:"dependentRequired",keywordLocation:ue,error:`Instance has "${ie}" but does not have "${Se}".`})}}if(te!==void 0)for(const ue in te){const ie=`${o}/dependentSchemas`;if(ue in e){const Ie=ot(e,te[ue],r,n,i,a,s,`${ie}/${kr(ue)}`,c);Ie.valid||ce.push({instanceLocation:s,keyword:"dependentSchemas",keywordLocation:ie,error:`Instance has "${ue}" but does not match dependant schema.`},...Ie.errors)}}if(Y!==void 0){const ue=`${o}/dependencies`;for(const ie in Y)if(ie in e){const Ie=Y[ie];if(Array.isArray(Ie))for(const Se of Ie)Se in e||ce.push({instanceLocation:s,keyword:"dependencies",keywordLocation:ue,error:`Instance has "${ie}" but does not have "${Se}".`});else{const Se=ot(e,Ie,r,n,i,a,s,`${ue}/${kr(ie)}`);Se.valid||ce.push({instanceLocation:s,keyword:"dependencies",keywordLocation:ue,error:`Instance has "${ie}" but does not match dependant schema.`},...Se.errors)}}}const me=Object.create(null);let Ae=!1;if(Le!==void 0){const ue=`${o}/properties`;for(const ie in Le){if(!(ie in e))continue;const Ie=`${s}/${kr(ie)}`,Se=ot(e[ie],Le[ie],r,n,i,a,Ie,`${ue}/${kr(ie)}`);if(Se.valid)c[ie]=me[ie]=!0;else if(Ae=i,ce.push({instanceLocation:s,keyword:"properties",keywordLocation:ue,error:`Property "${ie}" does not match schema.`},...Se.errors),Ae)break}}if(!Ae&&qe!==void 0){const ue=`${o}/patternProperties`;for(const ie in qe){const Ie=new RegExp(ie,"u"),Se=qe[ie];for(const Et in e){if(!Ie.test(Et))continue;const Hn=`${s}/${kr(Et)}`,Dr=ot(e[Et],Se,r,n,i,a,Hn,`${ue}/${kr(ie)}`);Dr.valid?c[Et]=me[Et]=!0:(Ae=i,ce.push({instanceLocation:s,keyword:"patternProperties",keywordLocation:ue,error:`Property "${Et}" matches pattern "${ie}" but does not match associated schema.`},...Dr.errors))}}}if(!Ae&&$e!==void 0){const ue=`${o}/additionalProperties`;for(const ie in e){if(me[ie])continue;const Ie=`${s}/${kr(ie)}`,Se=ot(e[ie],$e,r,n,i,a,Ie,ue);Se.valid?c[ie]=!0:(Ae=i,ce.push({instanceLocation:s,keyword:"additionalProperties",keywordLocation:ue,error:`Property "${ie}" does not match additional properties schema.`},...Se.errors))}}else if(!Ae&&Ve!==void 0){const ue=`${o}/unevaluatedProperties`;for(const ie in e)if(!c[ie]){const Ie=`${s}/${kr(ie)}`,Se=ot(e[ie],Ve,r,n,i,a,Ie,ue);Se.valid?c[ie]=!0:ce.push({instanceLocation:s,keyword:"unevaluatedProperties",keywordLocation:ue,error:`Property "${ie}" does not match unevaluated properties schema.`},...Se.errors)}}}else if(d==="array"){wa!==void 0&&e.length>wa&&ce.push({instanceLocation:s,keyword:"maxItems",keywordLocation:`${o}/maxItems`,error:`Array has too many items (${e.length} > ${wa}).`}),qn!==void 0&&e.length<qn&&ce.push({instanceLocation:s,keyword:"minItems",keywordLocation:`${o}/minItems`,error:`Array has too few items (${e.length} < ${qn}).`});const ke=e.length;let me=0,Ae=!1;if(re!==void 0){const ue=`${o}/prefixItems`,ie=Math.min(re.length,ke);for(;me<ie;me++){const Ie=ot(e[me],re[me],r,n,i,a,`${s}/${me}`,`${ue}/${me}`);if(c[me]=!0,!Ie.valid&&(Ae=i,ce.push({instanceLocation:s,keyword:"prefixItems",keywordLocation:ue,error:"Items did not match schema."},...Ie.errors),Ae))break}}if(xe!==void 0){const ue=`${o}/items`;if(Array.isArray(xe)){const ie=Math.min(xe.length,ke);for(;me<ie;me++){const Ie=ot(e[me],xe[me],r,n,i,a,`${s}/${me}`,`${ue}/${me}`);if(c[me]=!0,!Ie.valid&&(Ae=i,ce.push({instanceLocation:s,keyword:"items",keywordLocation:ue,error:"Items did not match schema."},...Ie.errors),Ae))break}}else for(;me<ke;me++){const ie=ot(e[me],xe,r,n,i,a,`${s}/${me}`,ue);if(c[me]=!0,!ie.valid&&(Ae=i,ce.push({instanceLocation:s,keyword:"items",keywordLocation:ue,error:"Items did not match schema."},...ie.errors),Ae))break}if(!Ae&&Re!==void 0){const ie=`${o}/additionalItems`;for(;me<ke;me++){const Ie=ot(e[me],Re,r,n,i,a,`${s}/${me}`,ie);c[me]=!0,Ie.valid||(Ae=i,ce.push({instanceLocation:s,keyword:"additionalItems",keywordLocation:ie,error:"Items did not match additional items schema."},...Ie.errors))}}}if(Ge!==void 0)if(ke===0&&je===void 0)ce.push({instanceLocation:s,keyword:"contains",keywordLocation:`${o}/contains`,error:"Array is empty. It must contain at least one item matching the schema."});else if(je!==void 0&&ke<je)ce.push({instanceLocation:s,keyword:"minContains",keywordLocation:`${o}/minContains`,error:`Array has less items (${ke}) than minContains (${je}).`});else{const ue=`${o}/contains`,ie=ce.length;let Ie=0;for(let Se=0;Se<ke;Se++){const Et=ot(e[Se],Ge,r,n,i,a,`${s}/${Se}`,ue);Et.valid?(c[Se]=!0,Ie++):ce.push(...Et.errors)}Ie>=(je||0)&&(ce.length=ie),je===void 0&&_t===void 0&&Ie===0?ce.splice(ie,0,{instanceLocation:s,keyword:"contains",keywordLocation:ue,error:"Array does not contain item matching schema."}):je!==void 0&&Ie<je?ce.push({instanceLocation:s,keyword:"minContains",keywordLocation:`${o}/minContains`,error:`Array must contain at least ${je} items matching schema. Only ${Ie} items were found.`}):_t!==void 0&&Ie>_t&&ce.push({instanceLocation:s,keyword:"maxContains",keywordLocation:`${o}/maxContains`,error:`Array may contain at most ${_t} items matching schema. ${Ie} items were found.`})}if(!Ae&&Te!==void 0){const ue=`${o}/unevaluatedItems`;for(me;me<ke;me++){if(c[me])continue;const ie=ot(e[me],Te,r,n,i,a,`${s}/${me}`,ue);c[me]=!0,ie.valid||ce.push({instanceLocation:s,keyword:"unevaluatedItems",keywordLocation:ue,error:"Items did not match unevaluated items schema."},...ie.errors)}}if(we)for(let ue=0;ue<ke;ue++){const ie=e[ue],Ie=typeof ie=="object"&&ie!==null;for(let Se=0;Se<ke;Se++){if(ue===Se)continue;const Et=e[Se];(ie===Et||Ie&&(typeof Et=="object"&&Et!==null)&&Yi(ie,Et))&&(ce.push({instanceLocation:s,keyword:"uniqueItems",keywordLocation:`${o}/uniqueItems`,error:`Duplicate items at indexes ${ue} and ${Se}.`}),ue=Number.MAX_SAFE_INTEGER,Se=Number.MAX_SAFE_INTEGER)}}}else if(d==="number"){if(r==="4"?(Nr!==void 0&&(Ke===!0&&e<=Nr||e<Nr)&&ce.push({instanceLocation:s,keyword:"minimum",keywordLocation:`${o}/minimum`,error:`${e} is less than ${Ke?"or equal to ":""} ${Nr}.`}),dr!==void 0&&(br===!0&&e>=dr||e>dr)&&ce.push({instanceLocation:s,keyword:"maximum",keywordLocation:`${o}/maximum`,error:`${e} is greater than ${br?"or equal to ":""} ${dr}.`})):(Nr!==void 0&&e<Nr&&ce.push({instanceLocation:s,keyword:"minimum",keywordLocation:`${o}/minimum`,error:`${e} is less than ${Nr}.`}),dr!==void 0&&e>dr&&ce.push({instanceLocation:s,keyword:"maximum",keywordLocation:`${o}/maximum`,error:`${e} is greater than ${dr}.`}),Ke!==void 0&&e<=Ke&&ce.push({instanceLocation:s,keyword:"exclusiveMinimum",keywordLocation:`${o}/exclusiveMinimum`,error:`${e} is less than ${Ke}.`}),br!==void 0&&e>=br&&ce.push({instanceLocation:s,keyword:"exclusiveMaximum",keywordLocation:`${o}/exclusiveMaximum`,error:`${e} is greater than or equal to ${br}.`})),Ai!==void 0){const ke=e%Ai;Math.abs(0-ke)>=11920929e-14&&Math.abs(Ai-ke)>=11920929e-14&&ce.push({instanceLocation:s,keyword:"multipleOf",keywordLocation:`${o}/multipleOf`,error:`${e} is not a multiple of ${Ai}.`})}}else if(d==="string"){const ke=fr===void 0&&$i===void 0?0:RP(e);fr!==void 0&&ke<fr&&ce.push({instanceLocation:s,keyword:"minLength",keywordLocation:`${o}/minLength`,error:`String is too short (${ke} < ${fr}).`}),$i!==void 0&&ke>$i&&ce.push({instanceLocation:s,keyword:"maxLength",keywordLocation:`${o}/maxLength`,error:`String is too long (${ke} > ${$i}).`}),Fs!==void 0&&!new RegExp(Fs,"u").test(e)&&ce.push({instanceLocation:s,keyword:"pattern",keywordLocation:`${o}/pattern`,error:"String does not match pattern."}),Oe!==void 0&&qg[Oe]&&!qg[Oe](e)&&ce.push({instanceLocation:s,keyword:"format",keywordLocation:`${o}/format`,error:`String does not match format "${Oe}".`})}return{valid:ce.length===0,errors:ce}}class AP{schema;draft;shortCircuit;lookup;constructor(t,r="2019-09",n=!0){this.schema=t,this.draft=r,this.shortCircuit=n,this.lookup=$n(t)}validate(t){return ot(t,this.schema,this.draft,this.lookup,this.shortCircuit)}addSchema(t,r){r&&(t={...t,$id:r}),$n(t,this.lookup)}}var $P={};bt($P,{Validator:()=>AP,deepCompareStrict:()=>Yi,toJsonSchema:()=>Aw,validatesOnlyStrings:()=>qo});function Aw(e){if(gn(e)){const t=LC(e,!0);if(Xa(t)){const r=Fd(t,!0);return Sg(r)}else return Sg(e)}return Un(e)?eP(e):e}function qo(e){if(!e||typeof e!="object"||Object.keys(e).length===0||Array.isArray(e))return!1;if("type"in e)return typeof e.type=="string"?e.type==="string":Array.isArray(e.type)?e.type.every(t=>t==="string"):!1;if("enum"in e)return Array.isArray(e.enum)&&e.enum.length>0&&e.enum.every(t=>typeof t=="string");if("const"in e)return typeof e.const=="string";if("allOf"in e&&Array.isArray(e.allOf))return e.allOf.some(t=>qo(t));if("anyOf"in e&&Array.isArray(e.anyOf)||"oneOf"in e&&Array.isArray(e.oneOf)){const t="anyOf"in e?e.anyOf:e.oneOf;return t.length>0&&t.every(r=>qo(r))}if("not"in e)return!1;if("$ref"in e&&typeof e.$ref=="string"){const t=e.$ref,r=$n(e);return r[t]?qo(r[t]):!1}return!1}var CP={};bt(CP,{Graph:()=>Qf});function PP(e,t){if(e!==void 0&&!Fo(e))return e;if(Gf(t))try{let r=t.getName();return r=r.startsWith("Runnable")?r.slice(8):r,r}catch{return t.getName()}else return t.name??"UnknownSchema"}function NP(e){return Gf(e.data)?{type:"runnable",data:{id:e.data.lc_id,name:e.data.getName()}}:{type:"schema",data:{...Aw(e.data.schema),title:e.data.name}}}var Qf=class $w{nodes={};edges=[];constructor(t){this.nodes=t?.nodes??this.nodes,this.edges=t?.edges??this.edges}toJSON(){const t={};return Object.values(this.nodes).forEach((r,n)=>{t[r.id]=Fo(r.id)?n:r.id}),{nodes:Object.values(this.nodes).map(r=>({id:t[r.id],...NP(r)})),edges:this.edges.map(r=>{const n={source:t[r.source],target:t[r.target]};return typeof r.data<"u"&&(n.data=r.data),typeof r.conditional<"u"&&(n.conditional=r.conditional),n})}}addNode(t,r,n){if(r!==void 0&&this.nodes[r]!==void 0)throw new Error(`Node with id ${r} already exists`);const i=r??Xr(),a={id:i,data:t,name:PP(r,t),metadata:n};return this.nodes[i]=a,a}removeNode(t){delete this.nodes[t.id],this.edges=this.edges.filter(r=>r.source!==t.id&&r.target!==t.id)}addEdge(t,r,n,i){if(this.nodes[t.id]===void 0)throw new Error(`Source node ${t.id} not in graph`);if(this.nodes[r.id]===void 0)throw new Error(`Target node ${r.id} not in graph`);const a={source:t.id,target:r.id,data:n,conditional:i};return this.edges.push(a),a}firstNode(){return Hg(this)}lastNode(){return Kg(this)}extend(t,r=""){let n=r;Object.values(t.nodes).map(u=>u.id).every(Fo)&&(n="");const a=u=>n?`${n}:${u}`:u;Object.entries(t.nodes).forEach(([u,d])=>{this.nodes[a(u)]={...d,id:a(u)}});const s=t.edges.map(u=>({...u,source:a(u.source),target:a(u.target)}));this.edges=[...this.edges,...s];const o=t.firstNode(),c=t.lastNode();return[o?{id:a(o.id),data:o.data}:void 0,c?{id:a(c.id),data:c.data}:void 0]}trimFirstNode(){const t=this.firstNode();t&&Hg(this,[t.id])&&this.removeNode(t)}trimLastNode(){const t=this.lastNode();t&&Kg(this,[t.id])&&this.removeNode(t)}reid(){const t=Object.fromEntries(Object.values(this.nodes).map(i=>[i.id,i.name])),r=new Map;Object.values(t).forEach(i=>{r.set(i,(r.get(i)||0)+1)});const n=i=>{const a=t[i];return Fo(i)&&r.get(a)===1?a:i};return new $w({nodes:Object.fromEntries(Object.entries(this.nodes).map(([i,a])=>[n(i),{...a,id:n(i)}])),edges:this.edges.map(i=>({...i,source:n(i.source),target:n(i.target)}))})}drawMermaid(t){const{withStyles:r,curveStyle:n,nodeColors:i={default:"fill:#f2f0ff,line-height:1.2",first:"fill-opacity:0",last:"fill:#bfb6fc"},wrapLabelNWords:a}=t??{},s=this.reid(),o=s.firstNode(),c=s.lastNode();return BC(s.nodes,s.edges,{firstNode:o?.id,lastNode:c?.id,withStyles:r,curveStyle:n,nodeColors:i,wrapLabelNWords:a})}async drawMermaidPng(t){const r=this.drawMermaid(t);return zC(r,{backgroundColor:t?.backgroundColor})}};function Hg(e,t=[]){const r=new Set(e.edges.filter(i=>!t.includes(i.source)).map(i=>i.target)),n=[];for(const i of Object.values(e.nodes))!t.includes(i.id)&&!r.has(i.id)&&n.push(i);return n.length===1?n[0]:void 0}function Kg(e,t=[]){const r=new Set(e.edges.filter(i=>!t.includes(i.target)).map(i=>i.source)),n=[];for(const i of Object.values(e.nodes))!t.includes(i.id)&&!r.has(i.id)&&n.push(i);return n.length===1?n[0]:void 0}function DP(e){const t=new TextEncoder,r=new ReadableStream({async start(n){for await(const i of e)n.enqueue(t.encode(`event: data
data: ${JSON.stringify(i)}

`));n.enqueue(t.encode(`event: end

`)),n.close()}});return Ar.fromReadableStream(r)}function Gg(e){return typeof e=="object"&&e!==null&&typeof e[Symbol.iterator]=="function"&&typeof e.next=="function"}const MP=e=>e!=null&&typeof e=="object"&&"next"in e&&typeof e.next=="function";function Gd(e){return typeof e=="object"&&e!==null&&typeof e[Symbol.asyncIterator]=="function"}function*Wg(e,t){for(;;){const{value:r,done:n}=hn.runWithConfig(oa(e),t.next.bind(t),!0);if(n)break;yield r}}async function*Wd(e,t){const r=t[Symbol.asyncIterator]();for(;;){const{value:n,done:i}=await hn.runWithConfig(oa(e),r.next.bind(t),!0);if(i)break;yield n}}function kt(e,t){return e&&!Array.isArray(e)&&!(e instanceof Date)&&typeof e=="object"?e:{[t]:e}}var Gt=class extends ls{lc_runnable=!0;name;getName(e){const t=this.name??this.constructor.lc_name()??this.constructor.name;return e?`${t}${e}`:t}withRetry(e){return new Pw({bound:this,kwargs:{},config:{},maxAttemptNumber:e?.stopAfterAttempt,...e})}withConfig(e){return new yc({bound:this,config:e,kwargs:{}})}withFallbacks(e){const t=Array.isArray(e)?e:e.fallbacks;return new FP({runnable:this,fallbacks:t})}_getOptionsList(e,t=0){if(Array.isArray(e)&&e.length!==t)throw new Error(`Passed "options" must be an array with the same length as the inputs, but got ${e.length} options for ${t} inputs`);if(Array.isArray(e))return e.map(Xe);if(t>1&&!Array.isArray(e)&&e.runId){console.warn("Provided runId will be used only for the first element of the batch.");const r=Object.fromEntries(Object.entries(e).filter(([n])=>n!=="runId"));return Array.from({length:t},(n,i)=>Xe(i===0?e:r))}return Array.from({length:t},()=>Xe(e))}async batch(e,t,r){const n=this._getOptionsList(t??{},e.length),i=n[0]?.maxConcurrency??r?.maxConcurrency,a=new Kf({maxConcurrency:i,onFailedAttempt:o=>{throw o}}),s=e.map((o,c)=>a.call(async()=>{try{return await this.invoke(o,n[c])}catch(u){if(r?.returnExceptions)return u;throw u}}));return Promise.all(s)}async*_streamIterator(e,t){yield this.invoke(e,t)}async stream(e,t){const r=Xe(t),n=new Ri({generator:this._streamIterator(e,r),config:r});return await n.setup,Ar.fromAsyncGenerator(n)}_separateRunnableConfigFromCallOptions(e){let t;e===void 0?t=Xe(e):t=Xe({callbacks:e.callbacks,tags:e.tags,metadata:e.metadata,runName:e.runName,configurable:e.configurable,recursionLimit:e.recursionLimit,maxConcurrency:e.maxConcurrency,runId:e.runId,timeout:e.timeout,signal:e.signal});const r={...e};return delete r.callbacks,delete r.tags,delete r.metadata,delete r.runName,delete r.configurable,delete r.recursionLimit,delete r.maxConcurrency,delete r.runId,delete r.timeout,delete r.signal,[t,r]}async _callWithConfig(e,t,r){const n=Xe(r),a=await(await Rr(n))?.handleChainStart(this.toJSON(),kt(t,"input"),n.runId,n?.runType,void 0,void 0,n?.runName??this.getName());delete n.runId;let s;try{const o=e.call(this,t,n,a);s=await Ln(o,r?.signal)}catch(o){throw await a?.handleChainError(o),o}return await a?.handleChainEnd(kt(s,"output")),s}async _batchWithConfig(e,t,r,n){const i=this._getOptionsList(r??{},t.length),a=await Promise.all(i.map(Rr)),s=await Promise.all(a.map(async(c,u)=>{const d=await c?.handleChainStart(this.toJSON(),kt(t[u],"input"),i[u].runId,i[u].runType,void 0,void 0,i[u].runName??this.getName());return delete i[u].runId,d}));let o;try{const c=e.call(this,t,i,s,n);o=await Ln(c,i?.[0]?.signal)}catch(c){throw await Promise.all(s.map(u=>u?.handleChainError(c))),c}return await Promise.all(s.map(c=>c?.handleChainEnd(kt(o,"output")))),o}_concatOutputChunks(e,t){return qf(e,t)}async*_transformStreamWithConfig(e,t,r){let n,i=!0,a,s=!0;const o=Xe(r),c=await Rr(o),u=this;async function*d(){for await(const p of e){if(i)if(n===void 0)n=p;else try{n=u._concatOutputChunks(n,p)}catch{n=void 0,i=!1}yield p}}let h;try{const p=await uw(t.bind(this),d(),async()=>c?.handleChainStart(this.toJSON(),{input:""},o.runId,o.runType,void 0,void 0,o.runName??this.getName()),r?.signal,o);delete o.runId,h=p.setup;const y=h?.handlers.find(eC);let g=p.output;y!==void 0&&h!==void 0&&(g=y.tapOutputIterable(h.runId,g));const w=h?.handlers.find(fw);w!==void 0&&h!==void 0&&(g=w.tapOutputIterable(h.runId,g));for await(const b of g)if(yield b,s)if(a===void 0)a=b;else try{a=this._concatOutputChunks(a,b)}catch{a=void 0,s=!1}}catch(p){throw await h?.handleChainError(p,void 0,void 0,void 0,{inputs:kt(n,"input")}),p}await h?.handleChainEnd(a??{},void 0,void 0,void 0,{inputs:kt(n,"input")})}getGraph(e){const t=new Qf,r=t.addNode({name:`${this.getName()}Input`,schema:Bg()}),n=t.addNode(this),i=t.addNode({name:`${this.getName()}Output`,schema:Bg()});return t.addEdge(r,n),t.addEdge(n,i),t}pipe(e){return new Nw({first:this,last:si(e)})}pick(e){return this.pipe(new zP(e))}assign(e){return this.pipe(new BP(new Yf({steps:e})))}async*transform(e,t){let r;for await(const n of e)r===void 0?r=n:r=this._concatOutputChunks(r,n);yield*this._streamIterator(r,Xe(t))}async*streamLog(e,t,r){const n=new Ld({...r,autoClose:!1,_schemaFormat:"original"}),i=Xe(t);yield*this._streamLog(e,n,i)}async*_streamLog(e,t,r){const{callbacks:n}=r;if(n===void 0)r.callbacks=[t];else if(Array.isArray(n))r.callbacks=n.concat([t]);else{const o=n.copy();o.addHandler(t,!0),r.callbacks=o}const i=this.stream(e,r);async function a(){try{const o=await i;for await(const c of o){const u=new en({ops:[{op:"add",path:"/streamed_output/-",value:c}]});await t.writer.write(u)}}finally{await t.writer.close()}}const s=a();try{for await(const o of t)yield o}finally{await s}}streamEvents(e,t,r){let n;if(t.version==="v1")n=this._streamEventsV1(e,t,r);else if(t.version==="v2")n=this._streamEventsV2(e,t,r);else throw new Error('Only versions "v1" and "v2" of the schema are currently supported.');return t.encoding==="text/event-stream"?DP(n):Ar.fromAsyncGenerator(n)}async*_streamEventsV2(e,t,r){const n=new tC({...r,autoClose:!1}),i=Xe(t),a=i.runId??Xr();i.runId=a;const s=i.callbacks;if(s===void 0)i.callbacks=[n];else if(Array.isArray(s))i.callbacks=s.concat(n);else{const y=s.copy();y.addHandler(n,!0),i.callbacks=y}const o=new AbortController,c=this;async function u(){let y,g=null;try{t?.signal?"any"in AbortSignal?y=AbortSignal.any([o.signal,t.signal]):(y=t.signal,g=()=>{o.abort()},t.signal.addEventListener("abort",g,{once:!0})):y=o.signal;const w=await c.stream(e,{...i,signal:y}),b=n.tapOutputIterable(a,w);for await(const S of b)if(o.signal.aborted)break}finally{await n.finish(),y&&g&&y.removeEventListener("abort",g)}}const d=u();let h=!1,p;try{for await(const y of n){if(!h){y.data.input=e,h=!0,p=y.run_id,yield y;continue}y.run_id===p&&y.event.endsWith("_end")&&y.data?.input&&delete y.data.input,yield y}}finally{o.abort(),await d}}async*_streamEventsV1(e,t,r){let n,i=!1;const a=Xe(t),s=a.tags??[],o=a.metadata??{},c=a.runName??this.getName(),u=new Ld({...r,autoClose:!1,_schemaFormat:"streaming_events"}),d=new hC({...r}),h=this._streamLog(e,u,a);for await(const y of h){if(n?n=n.concat(y):n=Hf.fromRunLogPatch(y),n.state===void 0)throw new Error('Internal error: "streamEvents" state is missing. Please open a bug report.');if(!i){i=!0;const S={...n.state},O={run_id:S.id,event:`on_${S.type}_start`,name:c,tags:s,metadata:o,data:{input:e}};d.includeEvent(O,S.type)&&(yield O)}const g=y.ops.filter(S=>S.path.startsWith("/logs/")).map(S=>S.path.split("/")[2]),w=[...new Set(g)];for(const S of w){let O,T={};const z=n.state.logs[S];if(z.end_time===void 0?z.streamed_output.length>0?O="stream":O="start":O="end",O==="start")z.inputs!==void 0&&(T.input=z.inputs);else if(O==="end")z.inputs!==void 0&&(T.input=z.inputs),T.output=z.final_output;else if(O==="stream"){const B=z.streamed_output.length;if(B!==1)throw new Error(`Expected exactly one chunk of streamed output, got ${B} instead. Encountered in: "${z.name}"`);T={chunk:z.streamed_output[0]},z.streamed_output=[]}yield{event:`on_${z.type}_${O}`,name:z.name,run_id:z.id,tags:z.tags,metadata:z.metadata,data:T}}const{state:b}=n;if(b.streamed_output.length>0){const S=b.streamed_output.length;if(S!==1)throw new Error(`Expected exactly one chunk of streamed output, got ${S} instead. Encountered in: "${b.name}"`);const O={chunk:b.streamed_output[0]};b.streamed_output=[];const T={event:`on_${b.type}_stream`,run_id:b.id,tags:s,metadata:o,name:c,data:O};d.includeEvent(T,b.type)&&(yield T)}}const p=n?.state;if(p!==void 0){const y={event:`on_${p.type}_end`,name:c,run_id:p.id,tags:s,metadata:o,data:{output:p.final_output}};d.includeEvent(y,p.type)&&(yield y)}}static isRunnable(e){return Gf(e)}withListeners({onStart:e,onEnd:t,onError:r}){return new yc({bound:this,config:{},configFactories:[n=>({callbacks:[new mw({config:n,onStart:e,onEnd:t,onError:r})]})]})}asTool(e){return UP(this,e)}},yc=class Cw extends Gt{static lc_name(){return"RunnableBinding"}lc_namespace=["langchain_core","runnables"];lc_serializable=!0;bound;config;kwargs;configFactories;constructor(t){super(t),this.bound=t.bound,this.kwargs=t.kwargs,this.config=t.config,this.configFactories=t.configFactories}getName(t){return this.bound.getName(t)}async _mergeConfig(...t){const r=yg(this.config,...t);return yg(r,...this.configFactories?await Promise.all(this.configFactories.map(async n=>await n(r))):[])}withConfig(t){return new this.constructor({bound:this.bound,kwargs:this.kwargs,config:{...this.config,...t}})}withRetry(t){return new Pw({bound:this.bound,kwargs:this.kwargs,config:this.config,maxAttemptNumber:t?.stopAfterAttempt,...t})}async invoke(t,r){return this.bound.invoke(t,await this._mergeConfig(r,this.kwargs))}async batch(t,r,n){const i=Array.isArray(r)?await Promise.all(r.map(async a=>this._mergeConfig(Xe(a),this.kwargs))):await this._mergeConfig(Xe(r),this.kwargs);return this.bound.batch(t,i,n)}_concatOutputChunks(t,r){return this.bound._concatOutputChunks(t,r)}async*_streamIterator(t,r){yield*this.bound._streamIterator(t,await this._mergeConfig(Xe(r),this.kwargs))}async stream(t,r){return this.bound.stream(t,await this._mergeConfig(Xe(r),this.kwargs))}async*transform(t,r){yield*this.bound.transform(t,await this._mergeConfig(Xe(r),this.kwargs))}streamEvents(t,r,n){const i=this,a=async function*(){yield*i.bound.streamEvents(t,{...await i._mergeConfig(Xe(r),i.kwargs),version:r.version},n)};return Ar.fromAsyncGenerator(a())}static isRunnableBinding(t){return t.bound&&Gt.isRunnable(t.bound)}withListeners({onStart:t,onEnd:r,onError:n}){return new Cw({bound:this.bound,kwargs:this.kwargs,config:this.config,configFactories:[i=>({callbacks:[new mw({config:i,onStart:t,onEnd:r,onError:n})]})]})}},Pw=class extends yc{static lc_name(){return"RunnableRetry"}lc_namespace=["langchain_core","runnables"];maxAttemptNumber=3;onFailedAttempt=()=>{};constructor(e){super(e),this.maxAttemptNumber=e.maxAttemptNumber??this.maxAttemptNumber,this.onFailedAttempt=e.onFailedAttempt??this.onFailedAttempt}_patchConfigForRetry(e,t,r){const n=e>1?`retry:attempt:${e}`:void 0;return Bt(t,{callbacks:r?.getChild(n)})}async _invoke(e,t,r){return jd(n=>super.invoke(e,this._patchConfigForRetry(n,t,r)),{onFailedAttempt:({error:n})=>this.onFailedAttempt(n,e),retries:Math.max(this.maxAttemptNumber-1,0),randomize:!0})}async invoke(e,t){return this._callWithConfig(this._invoke.bind(this),e,t)}async _batch(e,t,r,n){const i={};try{await jd(async a=>{const s=e.map((h,p)=>p).filter(h=>i[h.toString()]===void 0||i[h.toString()]instanceof Error),o=s.map(h=>e[h]),c=s.map(h=>this._patchConfigForRetry(a,t?.[h],r?.[h])),u=await super.batch(o,c,{...n,returnExceptions:!0});let d;for(let h=0;h<u.length;h+=1){const p=u[h],y=s[h];p instanceof Error&&d===void 0&&(d=p,d.input=o[h]),i[y.toString()]=p}if(d)throw d;return u},{onFailedAttempt:({error:a})=>this.onFailedAttempt(a,a.input),retries:Math.max(this.maxAttemptNumber-1,0),randomize:!0})}catch(a){if(n?.returnExceptions!==!0)throw a}return Object.keys(i).sort((a,s)=>parseInt(a,10)-parseInt(s,10)).map(a=>i[parseInt(a,10)])}async batch(e,t,r){return this._batchWithConfig(this._batch.bind(this),e,t,r)}},Nw=class Ha extends Gt{static lc_name(){return"RunnableSequence"}first;middle=[];last;omitSequenceTags=!1;lc_serializable=!0;lc_namespace=["langchain_core","runnables"];constructor(t){super(t),this.first=t.first,this.middle=t.middle??this.middle,this.last=t.last,this.name=t.name,this.omitSequenceTags=t.omitSequenceTags??this.omitSequenceTags}get steps(){return[this.first,...this.middle,this.last]}async invoke(t,r){const n=Xe(r),a=await(await Rr(n))?.handleChainStart(this.toJSON(),kt(t,"input"),n.runId,void 0,void 0,void 0,n?.runName);delete n.runId;let s=t,o;try{const c=[this.first,...this.middle];for(let u=0;u<c.length;u+=1){const h=c[u].invoke(s,Bt(n,{callbacks:a?.getChild(this.omitSequenceTags?void 0:`seq:step:${u+1}`)}));s=await Ln(h,r?.signal)}if(r?.signal?.aborted)throw sc(r.signal);o=await this.last.invoke(s,Bt(n,{callbacks:a?.getChild(this.omitSequenceTags?void 0:`seq:step:${this.steps.length}`)}))}catch(c){throw await a?.handleChainError(c),c}return await a?.handleChainEnd(kt(o,"output")),o}async batch(t,r,n){const i=this._getOptionsList(r??{},t.length),a=await Promise.all(i.map(Rr)),s=await Promise.all(a.map(async(c,u)=>{const d=await c?.handleChainStart(this.toJSON(),kt(t[u],"input"),i[u].runId,void 0,void 0,void 0,i[u].runName);return delete i[u].runId,d}));let o=t;try{for(let c=0;c<this.steps.length;c+=1){const d=this.steps[c].batch(o,s.map((h,p)=>{const y=h?.getChild(this.omitSequenceTags?void 0:`seq:step:${c+1}`);return Bt(i[p],{callbacks:y})}),n);o=await Ln(d,i[0]?.signal)}}catch(c){throw await Promise.all(s.map(u=>u?.handleChainError(c))),c}return await Promise.all(s.map(c=>c?.handleChainEnd(kt(o,"output")))),o}_concatOutputChunks(t,r){return this.last._concatOutputChunks(t,r)}async*_streamIterator(t,r){const n=await Rr(r),{runId:i,...a}=r??{},s=await n?.handleChainStart(this.toJSON(),kt(t,"input"),i,void 0,void 0,void 0,a?.runName),o=[this.first,...this.middle,this.last];let c=!0,u;async function*d(){yield t}try{let h=o[0].transform(d(),Bt(a,{callbacks:s?.getChild(this.omitSequenceTags?void 0:"seq:step:1")}));for(let p=1;p<o.length;p+=1)h=await o[p].transform(h,Bt(a,{callbacks:s?.getChild(this.omitSequenceTags?void 0:`seq:step:${p+1}`)}));for await(const p of h)if(r?.signal?.throwIfAborted(),yield p,c)if(u===void 0)u=p;else try{u=this._concatOutputChunks(u,p)}catch{u=void 0,c=!1}}catch(h){throw await s?.handleChainError(h),h}await s?.handleChainEnd(kt(u,"output"))}getGraph(t){const r=new Qf;let n=null;return this.steps.forEach((i,a)=>{const s=i.getGraph(t);a!==0&&s.trimFirstNode(),a!==this.steps.length-1&&s.trimLastNode(),r.extend(s);const o=s.firstNode();if(!o)throw new Error(`Runnable ${i} has no first node`);n&&r.addEdge(n,o),n=s.lastNode()}),r}pipe(t){return Ha.isRunnableSequence(t)?new Ha({first:this.first,middle:this.middle.concat([this.last,t.first,...t.middle]),last:t.last,name:this.name??t.name}):new Ha({first:this.first,middle:[...this.middle,this.last],last:si(t),name:this.name})}static isRunnableSequence(t){return Array.isArray(t.middle)&&Gt.isRunnable(t)}static from([t,...r],n){let i={};return typeof n=="string"?i.name=n:n!==void 0&&(i=n),new Ha({...i,first:si(t),middle:r.slice(0,-1).map(si),last:si(r[r.length-1])})}},Yf=class Dw extends Gt{static lc_name(){return"RunnableMap"}lc_namespace=["langchain_core","runnables"];lc_serializable=!0;steps;getStepsKeys(){return Object.keys(this.steps)}constructor(t){super(t),this.steps={};for(const[r,n]of Object.entries(t.steps))this.steps[r]=si(n)}static from(t){return new Dw({steps:t})}async invoke(t,r){const n=Xe(r),a=await(await Rr(n))?.handleChainStart(this.toJSON(),{input:t},n.runId,void 0,void 0,void 0,n?.runName);delete n.runId;const s={};try{const o=Object.entries(this.steps).map(async([c,u])=>{s[c]=await u.invoke(t,Bt(n,{callbacks:a?.getChild(`map:key:${c}`)}))});await Ln(Promise.all(o),r?.signal)}catch(o){throw await a?.handleChainError(o),o}return await a?.handleChainEnd(s),s}async*_transform(t,r,n){const i={...this.steps},a=Uf(t,Object.keys(i).length),s=new Map(Object.entries(i).map(([o,c],u)=>{const d=c.transform(a[u],Bt(n,{callbacks:r?.getChild(`map:key:${o}`)}));return[o,d.next().then(h=>({key:o,gen:d,result:h}))]}));for(;s.size;){const o=Promise.race(s.values()),{key:c,result:u,gen:d}=await Ln(o,n?.signal);s.delete(c),u.done||(yield{[c]:u.value},s.set(c,d.next().then(h=>({key:c,gen:d,result:h}))))}}transform(t,r){return this._transformStreamWithConfig(t,this._transform.bind(this),r)}async stream(t,r){async function*n(){yield t}const i=Xe(r),a=new Ri({generator:this.transform(n(),i),config:i});return await a.setup,Ar.fromAsyncGenerator(a)}},LP=class Mw extends Gt{lc_serializable=!1;lc_namespace=["langchain_core","runnables"];func;constructor(t){if(super(t),!zf(t.func))throw new Error("RunnableTraceable requires a function that is wrapped in traceable higher-order function");this.func=t.func}async invoke(t,r){const[n]=this._getOptionsList(r??{},1),i=await Rr(n),a=this.func(Bt(n,{callbacks:i}),t);return Ln(a,n?.signal)}async*_streamIterator(t,r){const[n]=this._getOptionsList(r??{},1),i=await this.invoke(t,r);if(Gd(i)){for await(const a of i)n?.signal?.throwIfAborted(),yield a;return}if(MP(i)){for(;;){n?.signal?.throwIfAborted();const a=i.next();if(a.done)break;yield a.value}return}yield i}static from(t){return new Mw({func:t})}};function jP(e){if(zf(e))throw new Error("RunnableLambda requires a function that is not wrapped in traceable higher-order function. This shouldn't happen.")}var Lw=class jw extends Gt{static lc_name(){return"RunnableLambda"}lc_namespace=["langchain_core","runnables"];func;constructor(t){if(zf(t.func))return LP.from(t.func);super(t),jP(t.func),this.func=t.func}static from(t){return new jw({func:t})}async _invoke(t,r,n){return new Promise((i,a)=>{const s=Bt(r,{callbacks:n?.getChild(),recursionLimit:(r?.recursionLimit??Vl)-1});hn.runWithConfig(oa(s),async()=>{try{let o=await this.func(t,{...s});if(o&&Gt.isRunnable(o)){if(r?.recursionLimit===0)throw new Error("Recursion limit reached.");o=await o.invoke(t,{...s,recursionLimit:(s.recursionLimit??Vl)-1})}else if(Gd(o)){let c;for await(const u of Wd(s,o))if(r?.signal?.throwIfAborted(),c===void 0)c=u;else try{c=this._concatOutputChunks(c,u)}catch{c=u}o=c}else if(Gg(o)){let c;for(const u of Wg(s,o))if(r?.signal?.throwIfAborted(),c===void 0)c=u;else try{c=this._concatOutputChunks(c,u)}catch{c=u}o=c}i(o)}catch(o){a(o)}})})}async invoke(t,r){return this._callWithConfig(this._invoke.bind(this),t,r)}async*_transform(t,r,n){let i;for await(const o of t)if(i===void 0)i=o;else try{i=this._concatOutputChunks(i,o)}catch{i=o}const a=Bt(n,{callbacks:r?.getChild(),recursionLimit:(n?.recursionLimit??Vl)-1}),s=await new Promise((o,c)=>{hn.runWithConfig(oa(a),async()=>{try{const u=await this.func(i,{...a,config:a});o(u)}catch(u){c(u)}})});if(s&&Gt.isRunnable(s)){if(n?.recursionLimit===0)throw new Error("Recursion limit reached.");const o=await s.stream(i,a);for await(const c of o)yield c}else if(Gd(s))for await(const o of Wd(a,s))n?.signal?.throwIfAborted(),yield o;else if(Gg(s))for(const o of Wg(a,s))n?.signal?.throwIfAborted(),yield o;else yield s}transform(t,r){return this._transformStreamWithConfig(t,this._transform.bind(this),r)}async stream(t,r){async function*n(){yield t}const i=Xe(r),a=new Ri({generator:this.transform(n(),i),config:i});return await a.setup,Ar.fromAsyncGenerator(a)}},FP=class extends Gt{static lc_name(){return"RunnableWithFallbacks"}lc_namespace=["langchain_core","runnables"];lc_serializable=!0;runnable;fallbacks;constructor(e){super(e),this.runnable=e.runnable,this.fallbacks=e.fallbacks}*runnables(){yield this.runnable;for(const e of this.fallbacks)yield e}async invoke(e,t){const r=Xe(t),n=await Rr(r),{runId:i,...a}=r,s=await n?.handleChainStart(this.toJSON(),kt(e,"input"),i,void 0,void 0,void 0,a?.runName),o=Bt(a,{callbacks:s?.getChild()});return await hn.runWithConfig(o,async()=>{let u;for(const d of this.runnables()){r?.signal?.throwIfAborted();try{const h=await d.invoke(e,o);return await s?.handleChainEnd(kt(h,"output")),h}catch(h){u===void 0&&(u=h)}}throw u===void 0?new Error("No error stored at end of fallback."):(await s?.handleChainError(u),u)})}async*_streamIterator(e,t){const r=Xe(t),n=await Rr(r),{runId:i,...a}=r,s=await n?.handleChainStart(this.toJSON(),kt(e,"input"),i,void 0,void 0,void 0,a?.runName);let o,c;for(const d of this.runnables()){r?.signal?.throwIfAborted();const h=Bt(a,{callbacks:s?.getChild()});try{const p=await d.stream(e,h);c=Wd(h,p);break}catch(p){o===void 0&&(o=p)}}if(c===void 0){const d=o??new Error("No error stored at end of fallback.");throw await s?.handleChainError(d),d}let u;try{for await(const d of c){yield d;try{u=u===void 0?u:this._concatOutputChunks(u,d)}catch{u=void 0}}}catch(d){throw await s?.handleChainError(d),d}await s?.handleChainEnd(kt(u,"output"))}async batch(e,t,r){if(r?.returnExceptions)throw new Error("Not implemented.");const n=this._getOptionsList(t??{},e.length),i=await Promise.all(n.map(o=>Rr(o))),a=await Promise.all(i.map(async(o,c)=>{const u=await o?.handleChainStart(this.toJSON(),kt(e[c],"input"),n[c].runId,void 0,void 0,void 0,n[c].runName);return delete n[c].runId,u}));let s;for(const o of this.runnables()){n[0].signal?.throwIfAborted();try{const c=await o.batch(e,a.map((u,d)=>Bt(n[d],{callbacks:u?.getChild()})),r);return await Promise.all(a.map((u,d)=>u?.handleChainEnd(kt(c[d],"output")))),c}catch(c){s===void 0&&(s=c)}}throw s?(await Promise.all(a.map(o=>o?.handleChainError(s))),s):new Error("No error stored at end of fallbacks.")}};function si(e){if(typeof e=="function")return new Lw({func:e});if(Gt.isRunnable(e))return e;if(!Array.isArray(e)&&typeof e=="object"){const t={};for(const[r,n]of Object.entries(e))t[r]=si(n);return new Yf({steps:t})}else throw new Error(`Expected a Runnable, function or object.
Instead got an unsupported type.`)}var BP=class extends Gt{static lc_name(){return"RunnableAssign"}lc_namespace=["langchain_core","runnables"];lc_serializable=!0;mapper;constructor(e){e instanceof Yf&&(e={mapper:e}),super(e),this.mapper=e.mapper}async invoke(e,t){const r=await this.mapper.invoke(e,t);return{...e,...r}}async*_transform(e,t,r){const n=this.mapper.getStepsKeys(),[i,a]=Uf(e),s=this.mapper.transform(a,Bt(r,{callbacks:t?.getChild()})),o=s.next();for await(const c of i){if(typeof c!="object"||Array.isArray(c))throw new Error(`RunnableAssign can only be used with objects as input, got ${typeof c}`);const u=Object.fromEntries(Object.entries(c).filter(([d])=>!n.includes(d)));Object.keys(u).length>0&&(yield u)}yield(await o).value;for await(const c of s)yield c}transform(e,t){return this._transformStreamWithConfig(e,this._transform.bind(this),t)}async stream(e,t){async function*r(){yield e}const n=Xe(t),i=new Ri({generator:this.transform(r(),n),config:n});return await i.setup,Ar.fromAsyncGenerator(i)}},zP=class extends Gt{static lc_name(){return"RunnablePick"}lc_namespace=["langchain_core","runnables"];lc_serializable=!0;keys;constructor(e){(typeof e=="string"||Array.isArray(e))&&(e={keys:e}),super(e),this.keys=e.keys}async _pick(e){if(typeof this.keys=="string")return e[this.keys];{const t=this.keys.map(r=>[r,e[r]]).filter(r=>r[1]!==void 0);return t.length===0?void 0:Object.fromEntries(t)}}async invoke(e,t){return this._callWithConfig(this._pick.bind(this),e,t)}async*_transform(e){for await(const t of e){const r=await this._pick(t);r!==void 0&&(yield r)}}transform(e,t){return this._transformStreamWithConfig(e,this._transform.bind(this),t)}async stream(e,t){async function*r(){yield e}const n=Xe(t),i=new Ri({generator:this.transform(r(),n),config:n});return await i.setup,Ar.fromAsyncGenerator(i)}},Vg=class extends yc{name;description;schema;constructor(e){const t=Nw.from([Lw.from(async r=>{let n;if(oT(r))try{n=await CC(this.schema,r.args)}catch{throw new cT("Received tool input did not match expected schema",JSON.stringify(r.args))}else n=r;return n}).withConfig({runName:`${e.name}:parse_input`}),e.bound]).withConfig({runName:e.name});super({bound:t,config:e.config??{}}),this.name=e.name,this.description=e.description,this.schema=e.schema}static lc_name(){return"RunnableToolLike"}};function UP(e,t){const r=t.name??e.getName(),n=t.description??PC(t.schema);return NC(t.schema)?new Vg({name:r,description:n,schema:_1({input:v1()}).transform(i=>i.input),bound:e}):new Vg({name:r,description:n,schema:t.schema,bound:e})}var Xf=class extends Gt{lc_namespace=["langchain_core","documents","transformers"];invoke(e,t){return this.transformDocuments(e)}},qP=class extends Xf{async transformDocuments(e){const t=[];for(const r of e){const n=await this._transformDocument(r);t.push(n)}return t}},HP={};bt(HP,{BaseDocumentTransformer:()=>Xf,Document:()=>m_,MappingDocumentTransformer:()=>qP});var Na={},Zg;function KP(){if(Zg)return Na;Zg=1,Na.byteLength=o,Na.toByteArray=u,Na.fromByteArray=p;for(var e=[],t=[],r=typeof Uint8Array<"u"?Uint8Array:Array,n="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/",i=0,a=n.length;i<a;++i)e[i]=n[i],t[n.charCodeAt(i)]=i;t[45]=62,t[95]=63;function s(y){var g=y.length;if(g%4>0)throw new Error("Invalid string. Length must be a multiple of 4");var w=y.indexOf("=");w===-1&&(w=g);var b=w===g?0:4-w%4;return[w,b]}function o(y){var g=s(y),w=g[0],b=g[1];return(w+b)*3/4-b}function c(y,g,w){return(g+w)*3/4-w}function u(y){var g,w=s(y),b=w[0],S=w[1],O=new r(c(y,b,S)),T=0,z=S>0?b-4:b,B;for(B=0;B<z;B+=4)g=t[y.charCodeAt(B)]<<18|t[y.charCodeAt(B+1)]<<12|t[y.charCodeAt(B+2)]<<6|t[y.charCodeAt(B+3)],O[T++]=g>>16&255,O[T++]=g>>8&255,O[T++]=g&255;return S===2&&(g=t[y.charCodeAt(B)]<<2|t[y.charCodeAt(B+1)]>>4,O[T++]=g&255),S===1&&(g=t[y.charCodeAt(B)]<<10|t[y.charCodeAt(B+1)]<<4|t[y.charCodeAt(B+2)]>>2,O[T++]=g>>8&255,O[T++]=g&255),O}function d(y){return e[y>>18&63]+e[y>>12&63]+e[y>>6&63]+e[y&63]}function h(y,g,w){for(var b,S=[],O=g;O<w;O+=3)b=(y[O]<<16&16711680)+(y[O+1]<<8&65280)+(y[O+2]&255),S.push(d(b));return S.join("")}function p(y){for(var g,w=y.length,b=w%3,S=[],O=16383,T=0,z=w-b;T<z;T+=O)S.push(h(y,T,T+O>z?z:T+O));return b===1?(g=y[w-1],S.push(e[g>>2]+e[g<<4&63]+"==")):b===2&&(g=(y[w-2]<<8)+y[w-1],S.push(e[g>>10]+e[g>>4&63]+e[g<<2&63]+"=")),S.join("")}return Na}var GP=KP();const WP=fa(GP);var VP=Object.defineProperty,ZP=(e,t,r)=>t in e?VP(e,t,{enumerable:!0,configurable:!0,writable:!0,value:r}):e[t]=r,JP=(e,t,r)=>(ZP(e,t+"",r),r);function QP(e,t){let r=Array.from({length:e.length},(n,i)=>({start:i,end:i+1}));for(;r.length>1;){let n=null;for(let i=0;i<r.length-1;i++){const a=e.slice(r[i].start,r[i+1].end),s=t.get(a.join(","));s!=null&&(n==null||s<n[0])&&(n=[s,i])}if(n!=null){const i=n[1];r[i]={start:r[i].start,end:r[i+1].end},r.splice(i+1,1)}else break}return r}function YP(e,t){return e.length===1?[t.get(e.join(","))]:QP(e,t).map(r=>t.get(e.slice(r.start,r.end).join(","))).filter(r=>r!=null)}function XP(e){return e.replace(/[\\^$*+?.()|[\]{}]/g,"\\$&")}var Vd=class{specialTokens;inverseSpecialTokens;patStr;textEncoder=new TextEncoder;textDecoder=new TextDecoder("utf-8");rankMap=new Map;textMap=new Map;constructor(e,t){this.patStr=e.pat_str;const r=e.bpe_ranks.split(`
`).filter(Boolean).reduce((n,i)=>{const[a,s,...o]=i.split(" "),c=Number.parseInt(s,10);return o.forEach((u,d)=>n[u]=c+d),n},{});for(const[n,i]of Object.entries(r)){const a=WP.toByteArray(n);this.rankMap.set(a.join(","),i),this.textMap.set(i,a)}this.specialTokens={...e.special_tokens,...t},this.inverseSpecialTokens=Object.entries(this.specialTokens).reduce((n,[i,a])=>(n[a]=this.textEncoder.encode(i),n),{})}encode(e,t=[],r="all"){const n=new RegExp(this.patStr,"ug"),i=Vd.specialTokenRegex(Object.keys(this.specialTokens)),a=[],s=new Set(t==="all"?Object.keys(this.specialTokens):t),o=new Set(r==="all"?Object.keys(this.specialTokens).filter(u=>!s.has(u)):r);if(o.size>0){const u=Vd.specialTokenRegex([...o]),d=e.match(u);if(d!=null)throw new Error(`The text contains a special token that is not allowed: ${d[0]}`)}let c=0;for(;;){let u=null,d=c;for(;i.lastIndex=d,u=i.exec(e),!(u==null||s.has(u[0]));)d=u.index+1;const h=u?.index??e.length;for(const y of e.substring(c,h).matchAll(n)){const g=this.textEncoder.encode(y[0]),w=this.rankMap.get(g.join(","));if(w!=null){a.push(w);continue}a.push(...YP(g,this.rankMap))}if(u==null)break;let p=this.specialTokens[u[0]];a.push(p),c=u.index+u[0].length}return a}decode(e){const t=[];let r=0;for(let a=0;a<e.length;++a){const s=e[a],o=this.textMap.get(s)??this.inverseSpecialTokens[s];o!=null&&(t.push(o),r+=o.length)}const n=new Uint8Array(r);let i=0;for(const a of t)n.set(a,i),i+=a.length;return this.textDecoder.decode(n)}},Fw=Vd;JP(Fw,"specialTokenRegex",e=>new RegExp(e.map(t=>XP(t)).join("|"),"g"));function eN(e){switch(e){case"gpt2":return"gpt2";case"code-cushman-001":case"code-cushman-002":case"code-davinci-001":case"code-davinci-002":case"cushman-codex":case"davinci-codex":case"davinci-002":case"text-davinci-002":case"text-davinci-003":return"p50k_base";case"code-davinci-edit-001":case"text-davinci-edit-001":return"p50k_edit";case"ada":case"babbage":case"babbage-002":case"code-search-ada-code-001":case"code-search-babbage-code-001":case"curie":case"davinci":case"text-ada-001":case"text-babbage-001":case"text-curie-001":case"text-davinci-001":case"text-search-ada-doc-001":case"text-search-babbage-doc-001":case"text-search-curie-doc-001":case"text-search-davinci-doc-001":case"text-similarity-ada-001":case"text-similarity-babbage-001":case"text-similarity-curie-001":case"text-similarity-davinci-001":return"r50k_base";case"gpt-3.5-turbo-instruct-0914":case"gpt-3.5-turbo-instruct":case"gpt-3.5-turbo-16k-0613":case"gpt-3.5-turbo-16k":case"gpt-3.5-turbo-0613":case"gpt-3.5-turbo-0301":case"gpt-3.5-turbo":case"gpt-4-32k-0613":case"gpt-4-32k-0314":case"gpt-4-32k":case"gpt-4-0613":case"gpt-4-0314":case"gpt-4":case"gpt-3.5-turbo-1106":case"gpt-35-turbo":case"gpt-4-1106-preview":case"gpt-4-vision-preview":case"gpt-3.5-turbo-0125":case"gpt-4-turbo":case"gpt-4-turbo-2024-04-09":case"gpt-4-turbo-preview":case"gpt-4-0125-preview":case"text-embedding-ada-002":case"text-embedding-3-small":case"text-embedding-3-large":return"cl100k_base";case"gpt-4o":case"gpt-4o-2024-05-13":case"gpt-4o-2024-08-06":case"gpt-4o-2024-11-20":case"gpt-4o-mini-2024-07-18":case"gpt-4o-mini":case"gpt-4o-search-preview":case"gpt-4o-search-preview-2025-03-11":case"gpt-4o-mini-search-preview":case"gpt-4o-mini-search-preview-2025-03-11":case"gpt-4o-audio-preview":case"gpt-4o-audio-preview-2024-12-17":case"gpt-4o-audio-preview-2024-10-01":case"gpt-4o-mini-audio-preview":case"gpt-4o-mini-audio-preview-2024-12-17":case"o1":case"o1-2024-12-17":case"o1-mini":case"o1-mini-2024-09-12":case"o1-preview":case"o1-preview-2024-09-12":case"o1-pro":case"o1-pro-2025-03-19":case"o3":case"o3-2025-04-16":case"o3-mini":case"o3-mini-2025-01-31":case"o4-mini":case"o4-mini-2025-04-16":case"chatgpt-4o-latest":case"gpt-4o-realtime":case"gpt-4o-realtime-preview-2024-10-01":case"gpt-4o-realtime-preview-2024-12-17":case"gpt-4o-mini-realtime-preview":case"gpt-4o-mini-realtime-preview-2024-12-17":case"gpt-4.1":case"gpt-4.1-2025-04-14":case"gpt-4.1-mini":case"gpt-4.1-mini-2025-04-14":case"gpt-4.1-nano":case"gpt-4.1-nano-2025-04-14":case"gpt-4.5-preview":case"gpt-4.5-preview-2025-02-27":case"gpt-5":case"gpt-5-2025-08-07":case"gpt-5-nano":case"gpt-5-nano-2025-08-07":case"gpt-5-mini":case"gpt-5-mini-2025-08-07":case"gpt-5-chat-latest":return"o200k_base";default:throw new Error("Unknown model")}}var tN={};bt(tN,{encodingForModel:()=>nN,getEncoding:()=>Bw});const Ro={},rN=new Kf({});async function Bw(e){return e in Ro||(Ro[e]=rN.fetch(`https://tiktoken.pages.dev/js/${e}.json`).then(t=>t.json()).then(t=>new Fw(t)).catch(t=>{throw delete Ro[e],t})),await Ro[e]}async function nN(e){return Bw(eN(e))}var iN=class extends Xf{lc_namespace=["langchain","document_transformers","text_splitters"];chunkSize=1e3;chunkOverlap=200;keepSeparator=!1;lengthFunction;constructor(e){if(super(e),this.chunkSize=e?.chunkSize??this.chunkSize,this.chunkOverlap=e?.chunkOverlap??this.chunkOverlap,this.keepSeparator=e?.keepSeparator??this.keepSeparator,this.lengthFunction=e?.lengthFunction??(t=>t.length),this.chunkOverlap>=this.chunkSize)throw new Error("Cannot have chunkOverlap >= chunkSize")}async transformDocuments(e,t={}){return this.splitDocuments(e,t)}splitOnSeparator(e,t){let r;if(t)if(this.keepSeparator){const n=t.replace(/[/\-\\^$*+?.()|[\]{}]/g,"\\$&");r=e.split(new RegExp(`(?=${n})`))}else r=e.split(t);else r=e.split("");return r.filter(n=>n!=="")}async createDocuments(e,t=[],r={}){const n=t.length>0?t:[...Array(e.length)].map(()=>({})),{chunkHeader:i="",chunkOverlapHeader:a="(cont'd) ",appendChunkOverlapHeader:s=!1}=r,o=new Array;for(let c=0;c<e.length;c+=1){const u=e[c];let d=1,h=null,p=-1;for(const y of await this.splitText(u)){let g=i;const w=u.indexOf(y,p+1);if(h===null){const T=this.numberOfNewLines(u,0,w);d+=T}else{const T=p+await this.lengthFunction(h);if(T<w){const z=this.numberOfNewLines(u,T,w);d+=z}else if(T>w){const z=this.numberOfNewLines(u,w,T);d-=z}s&&(g+=a)}const b=this.numberOfNewLines(y),S=n[c].loc&&typeof n[c].loc=="object"?{...n[c].loc}:{};S.lines={from:d,to:d+b};const O={...n[c],loc:S};g+=y,o.push(new m_({pageContent:g,metadata:O})),d+=b,h=y,p=w}}return o}numberOfNewLines(e,t,r){return(e.slice(t,r).match(/\n/g)||[]).length}async splitDocuments(e,t={}){const r=e.filter(a=>a.pageContent!==void 0),n=r.map(a=>a.pageContent),i=r.map(a=>a.metadata);return this.createDocuments(n,i,t)}joinDocs(e,t){const r=e.join(t).trim();return r===""?null:r}async mergeSplits(e,t){const r=[],n=[];let i=0;for(const s of e){const o=await this.lengthFunction(s);if(i+o+n.length*t.length>this.chunkSize&&(i>this.chunkSize&&console.warn(`Created a chunk of size ${i}, +
which is longer than the specified ${this.chunkSize}`),n.length>0)){const c=this.joinDocs(n,t);for(c!==null&&r.push(c);i>this.chunkOverlap||i+o+n.length*t.length>this.chunkSize&&i>0;)i-=await this.lengthFunction(n[0]),n.shift()}n.push(s),i+=o}const a=this.joinDocs(n,t);return a!==null&&r.push(a),r}},aN=class Zd extends iN{static lc_name(){return"RecursiveCharacterTextSplitter"}separators=[`

`,`
`," ",""];constructor(t){super(t),this.separators=t?.separators??this.separators,this.keepSeparator=t?.keepSeparator??!0}async _splitText(t,r){const n=[];let i=r[r.length-1],a;for(let u=0;u<r.length;u+=1){const d=r[u];if(d===""){i=d;break}if(t.includes(d)){i=d,a=r.slice(u+1);break}}const s=this.splitOnSeparator(t,i);let o=[];const c=this.keepSeparator?"":i;for(const u of s)if(await this.lengthFunction(u)<this.chunkSize)o.push(u);else{if(o.length){const d=await this.mergeSplits(o,c);n.push(...d),o=[]}if(!a)n.push(u);else{const d=await this._splitText(u,a);n.push(...d)}}if(o.length){const u=await this.mergeSplits(o,c);n.push(...u)}return n}async splitText(t){return this._splitText(t,this.separators)}static fromLanguage(t,r){return new Zd({...r,separators:Zd.getSeparatorsForLanguage(t)})}static getSeparatorsForLanguage(t){if(t==="cpp")return[`
class `,`
void `,`
int `,`
float `,`
double `,`
if `,`
for `,`
while `,`
switch `,`
case `,`

`,`
`," ",""];if(t==="go")return[`
func `,`
var `,`
const `,`
type `,`
if `,`
for `,`
switch `,`
case `,`

`,`
`," ",""];if(t==="java")return[`
class `,`
public `,`
protected `,`
private `,`
static `,`
if `,`
for `,`
while `,`
switch `,`
case `,`

`,`
`," ",""];if(t==="js")return[`
function `,`
const `,`
let `,`
var `,`
class `,`
if `,`
for `,`
while `,`
switch `,`
case `,`
default `,`

`,`
`," ",""];if(t==="php")return[`
function `,`
class `,`
if `,`
foreach `,`
while `,`
do `,`
switch `,`
case `,`

`,`
`," ",""];if(t==="proto")return[`
message `,`
service `,`
enum `,`
option `,`
import `,`
syntax `,`

`,`
`," ",""];if(t==="python")return[`
class `,`
def `,`
	def `,`

`,`
`," ",""];if(t==="rst")return[`
===
`,`
---
`,`
***
`,`
.. `,`

`,`
`," ",""];if(t==="ruby")return[`
def `,`
class `,`
if `,`
unless `,`
while `,`
for `,`
do `,`
begin `,`
rescue `,`

`,`
`," ",""];if(t==="rust")return[`
fn `,`
const `,`
let `,`
if `,`
while `,`
for `,`
loop `,`
match `,`
const `,`

`,`
`," ",""];if(t==="scala")return[`
class `,`
object `,`
def `,`
val `,`
var `,`
if `,`
for `,`
while `,`
match `,`
case `,`

`,`
`," ",""];if(t==="swift")return[`
func `,`
class `,`
struct `,`
enum `,`
if `,`
for `,`
while `,`
do `,`
switch `,`
case `,`

`,`
`," ",""];if(t==="markdown")return[`
## `,`
### `,`
#### `,`
##### `,`
###### `,"```\n\n",`

***

`,`

---

`,`

___

`,`

`,`
`," ",""];if(t==="latex")return[`
\\chapter{`,`
\\section{`,`
\\subsection{`,`
\\subsubsection{`,`
\\begin{enumerate}`,`
\\begin{itemize}`,`
\\begin{description}`,`
\\begin{list}`,`
\\begin{quote}`,`
\\begin{quotation}`,`
\\begin{verse}`,`
\\begin{verbatim}`,`
\\begin{align}`,"$$","$",`

`,`
`," ",""];if(t==="html")return["<body>","<div>","<p>","<br>","<li>","<h1>","<h2>","<h3>","<h4>","<h5>","<h6>","<span>","<table>","<tr>","<td>","<th>","<ul>","<ol>","<header>","<footer>","<nav>","<head>","<style>","<script>","<meta>","<title>"," ",""];if(t==="sol")return[`
pragma `,`
using `,`
contract `,`
interface `,`
library `,`
constructor `,`
type `,`
function `,`
event `,`
modifier `,`
error `,`
struct `,`
enum `,`
if `,`
for `,`
while `,`
do while `,`
assembly `,`

`,`
`," ",""];throw new Error(`Language ${t} is not supported.`)}};const Bi=$r("EmbeddingService");Jd.allowRemoteModels=!0;Jd.allowLocalModels=!1;Jd.remoteHost="https://huggingface.co";class sN{constructor(){this.modelName="Xenova/all-MiniLM-L6-v2",this.EMBEDDING_DIMENSION=384,this.DEFAULT_OPTIONS={pooling:"mean",normalize:!0}}async initialize(){if(this.pipePromise)try{await this.pipePromise;return}catch{Bi.warn("Previous initialization failed, retrying..."),this.pipePromise=void 0}Bi.info(`Initializing embedding service with model: ${this.modelName}`);try{this.pipePromise=wb("feature-extraction",this.modelName,{quantized:!1}),await this.pipePromise,Bi.info("Embedding service initialized successfully")}catch(t){const r=t?.message||String(t),n=t?JSON.stringify(t):"";throw Bi.error(`Failed to initialize embedding service: ${r}${n?` - ${n}`:""}`),this.pipePromise=void 0,new Error(`Embedding service initialization failed: ${r}`)}}async generateEmbedding(t,r={}){this.pipePromise||await this.initialize();const n=await this.pipePromise,i={...this.DEFAULT_OPTIONS,...r};try{const a=await n(t,{pooling:i.pooling,normalize:i.normalize}),s=Array.from(a.data);return s.length!==this.EMBEDDING_DIMENSION&&Bi.warn(`Unexpected embedding dimension: ${s.length}, expected ${this.EMBEDDING_DIMENSION}`),s}catch(a){throw Bi.error(`Failed to generate embedding: ${a}`),a}}async generateEmbeddings(t,r={}){const n=[];for(const i of t){const a=await this.generateEmbedding(i,r);n.push(a)}return n}getEmbeddingDimension(){return this.EMBEDDING_DIMENSION}getModelName(){return this.modelName}}const Da=new sN,Bn={PREVIEW:500,CONTEXT:150},ti={FILE_NAME_MATCH:10,FILE_PATH_MATCH:5,CONTENT_MATCH:1,FILE_NAME_EXACT:20,FILE_PATH_EXACT:10,EXACT_PHRASE:5,TERM_COVERAGE:15},Ao={DEFAULT_LIMIT:5,MAX_LIMIT:20},oN={SAMPLE_VECTOR_COUNT:5},Ka=["idx0","idx1","idx2","idx3","idx4"],cN={LONG:1e3};function uN(e,t){if(e.length!==t.length)throw new Error(`Vector dimensions must match: ${e.length} vs ${t.length}`);let r=0;for(let n=0;n<e.length;n++){const i=e[n]-t[n];r+=i*i}return Math.sqrt(r)}function lN(e,t,r){const n=[];if(r&&r.length>0)for(let i=0;i<e;i++)if(i<r.length)n.push({vector:r[i],idx:i});else{const a=[];for(let s=0;s<t;s++)a.push(Math.random()*2-1);n.push({vector:a,idx:i})}else for(let i=0;i<e;i++){const a=[];for(let s=0;s<t;s++)a.push(Math.random()*2-1);n.push({vector:a,idx:i})}return n}function Jg(e,t){if(t.length!==Ka.length)throw new Error(`Sample vectors count (${t.length}) must match index field count (${Ka.length})`);const r={};for(let n=0;n<Ka.length;n++)r[Ka[n]]=uN(e,t[n].vector);return r}function dN(e,t){if(e.length!==t.length)throw new Error(`Vector dimensions must match: ${e.length} vs ${t.length}`);let r=0,n=0,i=0;for(let s=0;s<e.length;s++)r+=e[s]*t[s],n+=e[s]*e[s],i+=t[s]*t[s];const a=Math.sqrt(n)*Math.sqrt(i);return a===0?0:r/a}const fN=500,hN=50,pN=100;class Qg{constructor(t={}){this.chunkSize=t.chunkSize??fN,this.chunkOverlap=t.chunkOverlap??hN,this.minChunkSize=t.minChunkSize??pN}chunkDocument(t,r,n){if(r.length<=this.chunkSize){const c=`${n} ${r}`;return[{id:`${t}:chunk:0`,documentId:t,chunkIndex:0,text:c,startOffset:0,endOffset:r.length}]}const i=[],a=this.chunkSize-this.chunkOverlap;let s=0,o=0;for(;s<r.length;){const c=Math.min(s+this.chunkSize,r.length),u=r.substring(s,c);if(u.trim().length<this.minChunkSize&&i.length>0)break;const d=o===0?`${n} ${u}`:u;i.push({id:`${t}:chunk:${o}`,documentId:t,chunkIndex:o,text:d,startOffset:s,endOffset:c}),s+=a,o++}return i}getChunkContext(t,r){const n=t.chunkIndex>0?r[t.chunkIndex-1]:null,i=t.chunkIndex<r.length-1?r[t.chunkIndex+1]:null;let a="";return n&&(a+=`[Previous: ${n.text.substring(Math.max(0,n.text.length-Bn.CONTEXT))}]

`),a+=t.text,i&&(a+=`

[Next: ${i.text.substring(0,Bn.CONTEXT)}]`),a}}const Xl=$r("LangChainChunker"),mN=500,gN=75;function yN(e){return!e||e.trim().length===0?0:e.trim().split(/\s+/).filter(t=>t.length>0).length}class vN{constructor(t={}){this.chunkSize=t.chunkSize??mN,this.chunkOverlap=t.chunkOverlap??gN,this.textSplitter=new aN({chunkSize:this.chunkSize,chunkOverlap:this.chunkOverlap,lengthFunction:yN,separators:[`

`,`
`,". ","! ","? "," "],keepSeparator:!1})}async chunkDocument(t,r,n){try{const i=await this.textSplitter.splitText(r),a=[];let s=0;for(let o=0;o<i.length;o++){const c=i[o];let u;if(o===0){const p=r.indexOf(c);u=p!==-1?p:0,s=u}else{const p=a[o-1],y=Math.max(this.chunkOverlap*10,c.length),g=Math.max(0,p.endOffset-y),w=Math.min(r.length,p.endOffset+c.length),S=r.substring(g,w).indexOf(c);if(S!==-1){const O=g+S;O>=p.startOffset&&O<p.endOffset+c.length?u=O:u=p.endOffset}else u=p.endOffset;s=u}const d=Math.min(u+c.length,r.length),h=o===0?`${n} ${c}`:c;a.push({id:`${t}:chunk:${o}`,documentId:t,chunkIndex:o,text:h,startOffset:u,endOffset:d})}return this.validateNoWordSplitting(a,r,t),Xl.debug(`Document ${t} split into ${a.length} chunks using LangChain`),a}catch(i){throw Xl.warn(`LangChain chunking failed for ${t}, falling back to simple chunking: ${i}`),i}}validateNoWordSplitting(t,r,n){for(let i=0;i<t.length-1;i++){const a=t[i],s=t[i+1];if(a.endOffset<r.length&&s.startOffset>a.endOffset){const o=r.substring(a.endOffset,s.startOffset);if(o.trim().length>0&&!/^\s+$/.test(o)){const u=r[a.endOffset-1],d=r[s.startOffset];u&&d&&/[a-zA-Z0-9]/.test(u)&&/[a-zA-Z0-9]/.test(d)&&Xl.warn(`Potential word split detected in document ${n} between chunks ${i} and ${i+1}`)}}}}getChunkContext(t,r){const n=t.chunkIndex>0?r[t.chunkIndex-1]:null,i=t.chunkIndex<r.length-1?r[t.chunkIndex+1]:null;let a="";return n&&(a+=`[Previous: ${n.text.substring(Math.max(0,n.text.length-Bn.CONTEXT))}]

`),a+=t.text,i&&(a+=`

[Next: ${i.text.substring(0,Bn.CONTEXT)}]`),a}}const ed=$r("DocumentChunker");class zw{constructor(t={}){try{this.chunker=new vN(t),ed.debug("Using LangChain chunker")}catch(r){ed.warn(`Failed to initialize LangChain chunker, using fallback: ${r}`),this.chunker=new Qg(t)}}async chunkDocument(t,r,n){try{const i=this.chunker.chunkDocument(t,r,n);return await Promise.resolve(i)}catch(i){return ed.warn(`Primary chunker failed, falling back: ${i}`),new Qg().chunkDocument(t,r,n)}}getChunkContext(t,r){return this.chunker.getChunkContext(t,r)}}new zw;const Yg=$r("PDFJSExtractor");class Xg{canExtract(t){return t.toLowerCase()==="pdf"}async extractText(t,r={}){try{const n=await ay(()=>import("./pdf-UA8D4yGl.js"),[]);n.GlobalWorkerOptions.workerSrc||(n.GlobalWorkerOptions.workerSrc=`https://unpkg.com/pdfjs-dist@${n.version}/build/pdf.worker.min.mjs`);const a=await(await t.getContents({blob:!0})).arrayBuffer(),o=await n.getDocument({data:a,useSystemFonts:!0}).promise,c=o.numPages,u=[],d=r.includePageNumbers!==!1,h=r.pageSeparator||`

`;for(let y=1;y<=c;y++){const b=(await(await o.getPage(y)).getTextContent()).items.map(S=>S.str).join(" ");b.trim()&&(d?u.push(`[Page ${y}]
${b}`):u.push(b))}const p=u.join(h);if(!p||p.trim().length===0)throw new Error("PDF appears to contain no extractable text (may be image-based or scanned)");return Yg.debug(`Extracted ${c} pages from PDF: ${t.getName()}`),p}catch(n){throw Yg.warn(`Failed to extract text from PDF ${t.getName()}: ${n}`),new Error(`PDF text extraction failed: ${n}`)}}}const ey=$r("LLMOCRExtractor");class ty{canExtract(t){return["pdf","png","jpg","jpeg","tiff","tif"].includes(t.toLowerCase())}async extractText(t,r={}){const n=t.getName(),i=r?.fileType||n.split(".").pop()?.toLowerCase()||"pdf",s=(await bb.getProviders()).find(o=>o.ocrApiEndpoint&&o.name.toLowerCase().includes("mistral"));if(!s||!s.ocrApiEndpoint)throw new Error("Mistral OCR provider not configured. Please configure a provider with OCR endpoint in AI settings.");try{const o=await t.getContents({blob:!0}),c=await this.blobToBase64(o),u=this.getMimeType(i),d=await fetch(s.ocrApiEndpoint,{method:"POST",headers:{Authorization:`Bearer ${s.apiKey}`,"Content-Type":"application/json"},body:JSON.stringify({model:s.model||"mistral-ocr-latest",document:{type:"document_url",document_url:`data:${u};base64,${c}`},include_image_base64:!1})});if(!d.ok){const b=await d.text().catch(()=>"Unknown error");throw new Error(`OCR request failed: HTTP ${d.status}: ${b}`)}const h=await d.json();if(!h.pages||!Array.isArray(h.pages))throw new Error("Invalid OCR response format: missing pages array");const p=r.includePageNumbers!==!1,y=r.pageSeparator||`

`,g=h.pages.map((b,S)=>{const O=b?.markdown||b?.text||"";return O.trim()?p?`[Page ${S+1}]
${O}`:O:null}).filter(b=>b!==null);if(g.length===0)throw new Error("No text content found in OCR response");const w=g.join(y);return ey.debug(`Extracted ${h.pages.length} pages from ${i} file: ${n}`),w}catch(o){throw ey.warn(`Failed to extract text using OCR from ${n}: ${o}`),new Error(`OCR text extraction failed: ${o}`)}}async blobToBase64(t){return new Promise((r,n)=>{const i=new FileReader;i.onloadend=()=>{const s=i.result.split(",")[1];r(s)},i.onerror=n,i.readAsDataURL(t)})}getMimeType(t){return{pdf:"application/pdf",png:"image/png",jpg:"image/jpeg",jpeg:"image/jpeg",tiff:"image/tiff",tif:"image/tiff"}[t.toLowerCase()]||"application/octet-stream"}}const Ma=$r("DocumentExtractor");class _N{constructor(){this.extractors=[new ty,new Xg]}canExtract(t){return this.extractors.some(r=>r.canExtract(t))}async extractText(t,r){const n=t.getName(),i=r?.fileType||n.split(".").pop()?.toLowerCase()||"txt",a=this.extractors.filter(o=>o.canExtract(i));if(a.length===0)throw new Error(`No extractor available for file type: ${i}`);let s=null;for(const o of a)try{return Ma.debug(`Using ${o.constructor.name} for file type: ${i}`),await o.extractText(t,{...r,fileType:i})}catch(c){if(s=c instanceof Error?c:new Error(String(c)),Ma.warn(`${o.constructor.name} failed for ${n}: ${s.message}`),o instanceof ty&&a.length>1){const u=a.find(d=>d instanceof Xg);if(u){const d=`Mistral OCR extraction failed, falling back to PDF.js extractor for ${n}`;Ma.warn(d),_b(d);try{return Ma.debug(`Using ${u.constructor.name} as fallback for file type: ${i}`),await u.extractText(t,{...r,fileType:i})}catch(h){s=h instanceof Error?h:new Error(String(h)),Ma.warn(`Fallback extraction also failed for ${n}: ${s.message}`)}}}}throw s||new Error(`All extractors failed for file type: ${i}`)}}Ic(fO);Ic(OO);Ic(QO);const be=$r("DocumentIndexService");class wN{constructor(){this.sampleVectors=[],this.isInitialized=!1,this.DEFAULT_MAX_FILE_SIZE=5*1024*1024,this.chunker=new zw,this.documentExtractor=new _N,this.DEFAULT_INDEXABLE_TYPES=["md","txt","ts","tsx","js","jsx","json","geojson","kml","gpx","py","html","css","sql","xml","yaml","yml","pdf"]}async initialize(){if(!this.isInitialized){be.info("Initializing document index service with RxDB...");try{this.db=await Rk({name:"document-index-db",storage:sO(),ignoreDuplicate:!0});const n={documents:{schema:{version:0,primaryKey:"id",type:"object",properties:{id:{type:"string",maxLength:500},workspacePath:{type:"string"},filePath:{type:"string"},fileName:{type:"string"},fileType:{type:"string"},content:{type:"string"},contentHash:{type:"string"},metadata:{type:"object",properties:{size:{type:"number"},lastModified:{type:"number"},language:{type:"string"},tags:{type:"array",items:{type:"string"}}}},indexedAt:{type:"number"},updatedAt:{type:"number"}},required:["id","workspacePath","filePath","content","contentHash"],indexes:["workspacePath","filePath","fileType"]}},vectors:{schema:{version:1,primaryKey:"id",type:"object",properties:{id:{type:"string",maxLength:500},documentId:{type:"string",maxLength:500},embedding:{type:"array",items:{type:"number"}},idx0:{type:"number"},idx1:{type:"number"},idx2:{type:"number"},idx3:{type:"number"},idx4:{type:"number"},chunkIndex:{type:"number"},chunkStartOffset:{type:"number"},chunkEndOffset:{type:"number"}},required:["id","documentId","embedding","idx0","idx1","idx2","idx3","idx4"],indexes:["documentId","chunkIndex","idx0","idx1","idx2","idx3","idx4"]}}};try{await this.db.addCollections(n)}catch(s){if(s?.code==="DB8"||s?.message?.includes("already exists"))be.debug("Collections already exist, using existing collections");else throw s}this.documentsCollection=this.db.documents,this.vectorsCollection=this.db.vectors,await this.initializeSampleVectors(),await this.handleSchemaMigration(),this.isInitialized=!0;const i=await this.documentsCollection.count().exec(),a=await this.vectorsCollection.count().exec();be.info(`Document index service initialized with ${i} documents and ${a} embeddings`),Ch(mb,s=>{s&&this.handleWorkspaceChange(s).catch(o=>{be.error(`Failed to handle workspace connection: ${o}`)})}),Ch(gb,s=>{s&&this.handleWorkspaceChange(s).catch(o=>{be.error(`Failed to handle workspace change: ${o}`)})}),be.info("Document index service initialized")}catch(t){throw be.error(`Failed to initialize document index service: ${t}`),t}}}ensureInitialized(){if(!this.isInitialized||!this.documentsCollection||!this.vectorsCollection)throw new Error("Document index service not initialized. Call initialize() first.")}async initializeSampleVectors(){if(this.sampleVectors.length>0)return;const t=await this.vectorsCollection.find().limit(1e3).exec(),r=t.map(n=>n.embedding);this.sampleVectors=lN(oN.SAMPLE_VECTOR_COUNT,Da.getEmbeddingDimension(),r.length>0?r:void 0),be.info(`Sample vectors initialized for index range method: ${this.sampleVectors.length} vectors, ${t.length} existing embeddings`)}generateDocumentId(t,r){return`${t}:${r}`}async computeContentHash(t){const n=new TextEncoder().encode(t),i=await crypto.subtle.digest("SHA-256",n);return Array.from(new Uint8Array(i)).map(s=>s.toString(16).padStart(2,"0")).join("")}isIndexableFile(t,r){const n=t.getName().toLowerCase(),i=r?.fileTypes||this.DEFAULT_INDEXABLE_TYPES,a=n.split(".").pop();if(!a||!i.includes(a))return!1;if(r?.excludePatterns){for(const s of r.excludePatterns)if(n.includes(s)||t.getWorkspacePath().includes(s))return!1}return!0}detectLanguage(t){const r=t.split(".").pop()?.toLowerCase();return{ts:"typescript",tsx:"typescript",js:"javascript",jsx:"javascript",py:"python",md:"markdown",json:"json",geojson:"geojson",kml:"xml",gpx:"xml",html:"html",css:"css",sql:"sql",xml:"xml",yaml:"yaml",yml:"yaml",pdf:"pdf"}[r||""]||"text"}async indexDocument(t,r={}){this.isInitialized||await this.initialize(),this.ensureInitialized();const i=t.getWorkspace().getName(),a=t.getWorkspacePath(),s=t.getName(),o=this.generateDocumentId(i,a);if(!this.isIndexableFile(t,r))throw new Error(`File type not indexable: ${s}`);try{let c;const u=s.split(".").pop()?.toLowerCase()||"txt";if(this.documentExtractor.canExtract(u))c=await this.documentExtractor.extractText(t,{fileType:u});else{const q=await t.getContents({contentType:yb.TEXT});if(typeof q!="string")throw new Error(`File content is not text: ${s}`);c=q}if(!c||c.trim().length===0)throw new Error(`File appears to be empty or text extraction failed: ${s}`);const d=r.maxFileSize||this.DEFAULT_MAX_FILE_SIZE;if(c.length>d)throw new Error(`File too large to index: ${s} (${c.length} bytes)`);const h=await this.computeContentHash(c),p=Date.now(),y=await this.documentsCollection.findOne(o).exec(),g=y?y.toJSON():null,w=g?.metadata.tags||[],b=r.tags||[],S=[...new Set([...w,...b])],O=S.length!==w.length||b.some(q=>!w.includes(q));if(g&&g.contentHash===h&&!O)return be.debug(`Document already indexed and unchanged: ${o}`),g;const T=this.detectLanguage(s);let z=p;try{const q=t.getHandle?.();q&&(z=(await q.getFile()).lastModified)}catch(q){be.debug(`Could not get file modification time: ${q}`)}const B=!g||g.contentHash!==h,G={id:o,workspacePath:i,filePath:a,fileName:s,fileType:u,content:r.includeContent!==!1?c:"",contentHash:h,metadata:{size:c.length,lastModified:z,language:T,tags:S},indexedAt:g?.indexedAt||p,updatedAt:p};return await this.documentsCollection.upsert(G),B?await this.generateAndStoreEmbedding(G):be.debug(`Document content unchanged, skipping embedding regeneration: ${o}`),be.debug(`Indexed document: ${o}`),G}catch(c){throw be.error(`Failed to index document ${o}: ${c}`),c}}async getDocument(t){this.isInitialized||await this.initialize(),this.ensureInitialized();const r=await this.documentsCollection.findOne(t).exec();return r?r.toJSON():null}async getDocumentByPath(t,r){const n=this.generateDocumentId(t,r);return this.getDocument(n)}async listDocuments(t){this.isInitialized||await this.initialize(),this.ensureInitialized();let r=this.documentsCollection.find();return t&&(r=r.where("workspacePath").eq(t)),(await r.exec()).map(i=>i.toJSON())}async deleteDocument(t){this.isInitialized||await this.initialize(),this.ensureInitialized();const r=await this.documentsCollection.findOne(t).exec();if(r){await r.remove();const n=await this.vectorsCollection.find().where("documentId").eq(t).exec();for(const i of n)await i.remove();return be.debug(`Deleted document ${t} and ${n.length} associated embeddings`),!0}return!1}async deleteDocumentByPath(t,r){const n=this.generateDocumentId(t,r);return this.deleteDocument(n)}async handleSchemaMigration(){if(!(!this.vectorsCollection||!this.documentsCollection))try{const r=(await this.vectorsCollection.find().exec()).filter(i=>{const a=i.toJSON();return a.chunkIndex===void 0&&a.chunkStartOffset===void 0&&a.chunkEndOffset===void 0});if(r.length===0){be.debug("No vectors need migration - all have chunk information");return}be.info(`Detected ${r.length} vectors without chunk information. Invalidating and reindexing...`);const n=new Set;for(const i of r){const a=i.toJSON();n.add(a.documentId),await i.remove()}be.info(`Removed ${r.length} old vectors. Reindexing ${n.size} documents...`);for(const i of n){const a=await this.documentsCollection.findOne(i).exec();if(a){const s=a.toJSON();be.debug(`Reindexing document: ${s.fileName}`),await this.generateAndStoreEmbedding(s)}}be.info(`Schema migration completed. Reindexed ${n.size} documents.`)}catch(t){throw be.error(`Error during schema migration: ${t}`),t}}async deleteWorkspace(t){this.isInitialized||await this.initialize(),this.ensureInitialized();const r=await this.documentsCollection.find().where("workspacePath").eq(t).exec(),n=r.length;for(const i of r)await i.remove();return n>0&&be.info(`Deleted ${n} documents for workspace: ${t}`),n}async updateDocumentMetadata(t,r){this.isInitialized||await this.initialize(),this.ensureInitialized();const n=await this.documentsCollection.findOne(t).exec();if(!n)return null;const i=n.toJSON(),a={...i,metadata:{...i.metadata,...r.metadata},updatedAt:Date.now()};return await n.update({$set:a}),be.debug(`Updated document metadata: ${t}`),a}async indexWorkspace(t,r={}){this.isInitialized||await this.initialize();const n=t.getName();be.info(`Starting workspace indexing: ${n}`);const i=await this.collectFiles(t,r);be.info(`Found ${i.length} files to index`);let a=0,s=0;const o=[];for(const c of i)try{await this.indexDocument(c,r),a++}catch(u){s++;const d=`Failed to index ${c.getName()}: ${u}`;o.push(d),be.warn(d)}return be.info(`Workspace indexing complete: ${a} indexed, ${s} failed`),{indexed:a,failed:s,errors:o}}async collectFiles(t,r,n=[]){try{const i=await t.listChildren(!1);for(const a of i)a instanceof Or?this.isIndexableFile(a,r)&&n.push(a):a instanceof vb&&await this.collectFiles(a,r,n)}catch(i){be.warn(`Failed to collect files from ${t.getName()}: ${i}`)}return n}async reindexDocument(t,r={}){const i=t.getWorkspace().getName(),a=t.getWorkspacePath(),s=this.generateDocumentId(i,a),c=(await this.getDocument(s))?.metadata.tags||[],u=r.tags||[],d=[...new Set([...c,...u])];return await this.deleteDocument(s),this.indexDocument(t,{...r,tags:d})}async reindexAllDocuments(t={}){this.isInitialized||await this.initialize(),this.ensureInitialized();const r=await this.listDocuments();let n=0,i=0;for(const a of r)try{const s=await Vi.getWorkspace();if(!s||s.getName()!==a.workspacePath){be.warn(`Workspace not found: ${a.workspacePath}`),i++;continue}const o=await s.getResource(a.filePath);if(!o||!(o instanceof Or)){be.warn(`File not found: ${a.filePath}`),i++;continue}await this.reindexDocument(o,t),n++}catch(s){be.error(`Failed to reindex document ${a.id}: ${s}`),i++}return{total:r.length,succeeded:n,failed:i}}async getStats(){this.isInitialized||await this.initialize(),this.ensureInitialized();const t=await this.documentsCollection.count().exec(),r=await this.documentsCollection.find().exec(),n={};for(const i of r){const s=i.toJSON().workspacePath;n[s]=(n[s]||0)+1}return{totalDocuments:t,byWorkspace:n}}async handleWorkspaceChange(t){be.debug("Workspace changed, checking for document updates...")}async generateAndStoreEmbedding(t){try{if(!this.vectorsCollection){be.warn(`Vectors collection not initialized, cannot generate embedding for ${t.id}`);return}if(await Da.initialize(),this.sampleVectors.length===0&&await this.initializeSampleVectors(),this.sampleVectors.length===0){be.warn(`Sample vectors not initialized, cannot generate embedding for ${t.id}`);return}const r=await this.chunker.chunkDocument(t.id,t.content,t.fileName);be.debug(`Document ${t.id} split into ${r.length} chunks`);for(const n of r){const i=await Da.generateEmbedding(n.text),a=Jg(i,this.sampleVectors),s={id:n.id,documentId:t.id,chunkIndex:n.chunkIndex,chunkStartOffset:n.startOffset,chunkEndOffset:n.endOffset,embedding:i,...a};await this.vectorsCollection.upsert(s)}be.debug(`Generated and stored ${r.length} embeddings for document: ${t.id}`)}catch(r){be.warn(`Failed to generate embedding for document ${t.id}: ${r}`)}}async searchSimilar(t,r={}){this.isInitialized||await this.initialize(),this.ensureInitialized();const n=r.limit||10,i=r.indexDistance||2,a=r.docsPerIndexSide||100;if(!this.vectorsCollection||this.sampleVectors.length===0)throw be.warn("Vector search not available: vectors collection or sample vectors not initialized"),new Error("Vector search not available");const s=await this.vectorsCollection.find().exec();be.debug(`Starting vector search with indexDistance=${i}, limit=${n}, sampleVectors=${this.sampleVectors.length}, totalIndexedVectors=${s.length}`);try{await Da.initialize()}catch(g){throw be.error(`Failed to initialize embedding service for vector search: ${g}`),new Error(`Embedding service initialization failed: ${g}`)}let o;try{o=await Da.generateEmbedding(t)}catch(g){throw be.error(`Failed to generate query embedding: ${g}`),new Error(`Query embedding generation failed: ${g}`)}if(this.sampleVectors.length===0)throw be.warn("Sample vectors not initialized, cannot perform vector search"),new Error("Sample vectors not initialized");const c=Jg(o,this.sampleVectors);be.debug(`Query index values: ${JSON.stringify(c)}`);const u=new Set;try{for(const g of Ka){const w=c[g],b=w-i,S=w+i;be.debug(`Querying index ${g}: range [${b}, ${S}]`);const O=await this.vectorsCollection.find().where(g).gte(b).lte(S).limit(a).exec();be.debug(`Found ${O.length} candidates in index ${g}`);for(const T of O)u.add(T.documentId)}}catch(g){throw be.error(`Failed to query vector index: ${g}`),new Error(`Vector index query failed: ${g}`)}be.debug(`Total unique candidate IDs: ${u.size} (out of ${s.length} indexed vectors)`);const d=[];try{for(const g of u){const w=await this.vectorsCollection.find().where("documentId").eq(g).exec();for(const b of w){const S=b.toJSON();S&&S.embedding?d.push(S):be.warn(`Invalid vector data for document ${g}`)}}}catch(g){throw be.error(`Failed to fetch candidate vectors: ${g}`),new Error(`Failed to fetch candidate vectors: ${g}`)}be.debug(`Fetched ${d.length} candidate vectors`);const h=[];for(const g of d){const b=(dN(o,g.embedding)+1)/2;h.push({documentId:g.documentId,similarity:b,chunkIndex:g.chunkIndex,chunkStartOffset:g.chunkStartOffset,chunkEndOffset:g.chunkEndOffset})}h.sort((g,w)=>w.similarity-g.similarity),be.debug(`Computed similarities for ${h.length} candidates, top similarity: ${h[0]?.similarity||"N/A"}`);const p=h.slice(0,n),y=[];for(const g of p){const w=await this.documentsCollection.findOne(g.documentId).exec();if(w){const b=w.toJSON();if(r.workspacePath&&b.workspacePath!==r.workspacePath||r.fileType&&b.fileType!==r.fileType)continue;y.push({document:b,similarity:g.similarity,chunkIndex:g.chunkIndex,chunkStartOffset:g.chunkStartOffset,chunkEndOffset:g.chunkEndOffset})}}return y}async indexFileInContext(t,r,n={}){this.isInitialized||await this.initialize(),this.ensureInitialized();const a=t.getWorkspace().getName(),s=t.getWorkspacePath(),o=this.generateDocumentId(a,s),c=await this.documentsCollection.findOne(o).exec(),u=c?c.toJSON():null,d=r.tags||[],h=[...n.tags||[],...d];if(u){const p=u.metadata.tags||[],y=[...new Set([...p,...h])];return y.length!==p.length||h.some(w=>!p.includes(w))?(await this.updateDocumentMetadata(u.id,{metadata:{...u.metadata,tags:y}}),be.debug(`Added tags to existing document: ${o}`),{...u,metadata:{...u.metadata,tags:y}}):(be.debug(`Document already has all tags: ${o}`),u)}return this.indexDocument(t,{...n,tags:h})}async indexFilesInContext(t,r,n={}){let i=0,a=0;const s=r.tags||[];for(const o of t)try{await this.indexDocument(o,{...n,tags:[...n.tags||[],...s]}),i++,be.debug(`Indexed file with context tags: ${o.getWorkspacePath()}`)}catch(c){be.error(`Failed to index file ${o.getWorkspacePath()}: ${c}`),a++}return{succeeded:i,failed:a}}async reindexFileInContext(t,r,n={}){const i=r.tags||[];return this.reindexDocument(t,{...n,tags:[...n.tags||[],...i]})}async removeFileFromContext(t,r){this.isInitialized||await this.initialize(),this.ensureInitialized();const n=await this.getDocumentByPath(t.getWorkspace().getName(),t.getWorkspacePath());if(n&&r.tags&&r.tags.length>0){const i=new Set(r.tags),a=(n.metadata.tags||[]).filter(s=>!i.has(s));a.length!==n.metadata.tags?.length&&await this.updateDocumentMetadata(n.id,{metadata:{...n.metadata,tags:a}})}}async clearContext(t){if(!t.tags||t.tags.length===0)return;const r=new Set(t.tags),n=await this.listDocuments();for(const i of n)if(i.metadata.tags?.some(s=>r.has(s))){const s=i.metadata.tags.filter(o=>!r.has(o));try{const o=await Vi.getWorkspace();if(o&&o.getName()===i.workspacePath){const c=await o.getResource(i.filePath);c instanceof Or&&await this.indexDocument(c,{tags:s})}}catch(o){be.warn(`Failed to clear context tags from ${i.filePath}: ${o}`)}}}async getFilePathsInContext(t){if(!t.tags||t.tags.length===0)return[];const r=new Set(t.tags);return(await this.listDocuments()).filter(i=>i.metadata.tags?.some(a=>r.has(a))).map(i=>i.filePath)}}const ht=new wN;Eb.put("documentIndexService",ht);const ry=$r("WorkspaceUtils");async function bs(e){const t=await Vi.getWorkspace();if(!t)return ry.warn("No workspace connected"),null;const r=e||t.getName();return r?{workspace:t,workspacePath:r}:(ry.warn("No workspace path available"),null)}const bN=2;function Ga(e,t={}){if(!e||!e.trim())return[];const r=t.minTermLength??bN;return(t.caseSensitive?e:e.toLowerCase()).split(/\s+/).filter(i=>i.length>=r)}function Uw(e){return e.toLowerCase().trim()}const EN=10,xN=400,SN=400;class eh{constructor(t={}){this.maxSnippets=t.maxSnippets??EN,this.snippetLength=t.snippetLength??xN,this.minGap=t.minGap??SN}extractSnippets(t,r,n){const i=n??this.maxSnippets;if(r.length===0)return[];const a=t.toLowerCase(),s=[],o=new Set;for(const c of r){let u=a.indexOf(c);for(;u!==-1;){const d=Math.max(0,u-this.snippetLength/2),h=Math.min(t.length,u+c.length+this.snippetLength/2),p=t.substring(d,h).trim(),y=`${d}-${h}`;if(p&&!o.has(y)){o.add(y);const g=this.calculateSnippetScore(p,r);s.push({snippet:p,score:g,start:d})}u=a.indexOf(c,u+1)}}if(s.length===0&&r.length>0){const c=r[0],u=a.indexOf(c);if(u!==-1){const d=Math.max(0,u-this.snippetLength),h=Math.min(t.length,u+c.length+this.snippetLength),p=t.substring(d,h).trim();p&&s.push({snippet:p,score:10,start:d})}}return s.sort((c,u)=>u.score!==c.score?u.score-c.score:c.start-u.start),this.selectNonOverlappingSnippets(s,i)}calculateSnippetScore(t,r){const n=t.toLowerCase();let i=0;for(const c of r){const u=(n.match(new RegExp(c.replace(/[.*+?^${}()|[\]\\]/g,"\\$&"),"gi"))||[]).length;i+=u*10}const a=r.join(" ");n.includes(a)&&(i+=50);const s=r.filter(c=>n.includes(c)).length;i+=s*20;const o=s/r.length;return i+=o*30,i}selectNonOverlappingSnippets(t,r){const n=[],i=[];for(const a of t){if(n.length>=r)break;const s=a.start,o=a.start+a.snippet.length;i.some(u=>!(o<u.start-this.minGap||s>u.end+this.minGap))||(n.push(a.snippet),i.push({start:s,end:o}))}return n}extractSimpleSnippet(t,r=500){return t.substring(0,r)+(t.length>r?"...":"")}extractContextSnippets(t,r,n=150){const i=r.toLowerCase(),a=t.toLowerCase(),s=[];let o=a.indexOf(i);for(;o!==-1;)s.push(o),o=a.indexOf(i,o+1);if(s.length===0)return[];const c=[];for(const u of s){const d=Math.max(0,u-n),h=Math.min(t.length,u+r.length+n);c.push({start:d,end:h,matchIndex:u})}return c}}new eh;class kN{calculateRelevance(t,r){const n=Uw(r),i=Ga(r);let a=0;const s=t.fileName.toLowerCase(),o=t.filePath.toLowerCase(),c=t.content.toLowerCase(),u=i.filter(b=>s.includes(b)).length,d=i.filter(b=>o.includes(b)).length,h=i.filter(b=>c.includes(b)).length;a+=u*ti.FILE_NAME_MATCH,a+=d*ti.FILE_PATH_MATCH,a+=h*ti.CONTENT_MATCH,s.includes(n)&&(a+=ti.FILE_NAME_EXACT),o.includes(n)&&(a+=ti.FILE_PATH_EXACT);const p=(c.match(new RegExp(n.replace(/[.*+?^${}()|[\]\\]/g,"\\$&"),"g"))||[]).length;a+=p*ti.EXACT_PHRASE;const y=i.length,g=i.filter(b=>c.includes(b)).length,w=y>0?g/y:0;return a+=w*ti.TERM_COVERAGE,a}calculateFileNameRelevance(t,r){const n=t.fileName.toLowerCase(),i=r.toLowerCase();return n===i?100:n.includes(i)?80:0}}const ny=new kN;class IN{constructor(t){this.snippetExtractor=t}formatRAGContext(t){return t.length===0?"":`Here are relevant documents from the workspace that might help answer the question:

${t.map((n,i)=>{const a=n.document,s=n.matchedSnippets.map((o,c)=>`  [Snippet ${c+1}]
  ${o}`).join(`

`);return`[Document ${i+1}: ${a.fileName} (${a.filePath})]
Relevance: ${n.relevance.toFixed(2)}
${s.length>0?`Relevant snippets:
${s}`:`Content preview: ${this.snippetExtractor.extractSimpleSnippet(a.content,Bn.PREVIEW)}`}
---`}).join(`

`)}

Use the information from these documents to provide a helpful answer. Pay special attention to numbers, percentages, dates, and specific values mentioned in the snippets. If the documents don't contain relevant information, you can still answer based on your general knowledge.`}formatSearchResults(t){return t.map(r=>({file:r.document.fileName,path:r.document.filePath,relevance:r.relevance.toFixed(2),language:r.document.metadata.language,size:r.document.metadata.size,snippets:r.matchedSnippets,preview:this.snippetExtractor.extractSimpleSnippet(r.document.content,200)+"..."}))}formatCommandResults(t){return t.map(r=>({file:r.document.fileName,path:r.document.filePath,relevance:r.relevance,snippets:r.matchedSnippets}))}}const Qr=$r("RAGService"),Br=new eh,ON=new IN(Br);class TN{async searchDocuments(t,r={}){const n=Math.min(r.limit||Ao.DEFAULT_LIMIT,Ao.MAX_LIMIT),i=await bs(r.workspacePath);if(!i)return Qr.warn("No workspace connected, cannot search documents"),[];const{workspacePath:a}=i;if(r.filePath){const s=await ht.getDocumentByPath(a,r.filePath);if(s){const o=Ga(t),c=o.length>0?Br.extractSnippets(s.content,o,3):[Br.extractSimpleSnippet(s.content,Bn.PREVIEW)];return[{document:s,relevance:100,matchedSnippets:c}]}return Qr.warn(`Document not found: ${r.filePath}`),[]}if(r.fileName){const s=await ht.listDocuments(a),o=r.fileName.toLowerCase(),c=s.filter(u=>{const d=u.fileName.toLowerCase();return d===o||d.includes(o)});if(c.length>0){const u=[],d=Ga(t);for(const h of c.slice(0,n)){const p=d.length>0?Br.extractSnippets(h.content,d,3):[Br.extractSimpleSnippet(h.content,Bn.PREVIEW)];u.push({document:h,relevance:ny.calculateFileNameRelevance(h,r.fileName),matchedSnippets:p})}return u}return Qr.warn(`No documents found with name: ${r.fileName}`),[]}if(!t||!t.trim())return Qr.warn("No query provided and no filePath/fileName specified"),[];try{const s=await ht.searchSimilar(t,{limit:n*2,workspacePath:a,fileType:r.fileType}),o=[];for(const{document:c,similarity:u,chunkStartOffset:d,chunkEndOffset:h}of s){if(!this.matchesContextScope(c,r.documentSearchScope))continue;const p=u*100;if(r.minRelevance&&p<r.minRelevance)continue;const y=Uw(t),g=Ga(t);let w;if(d!==void 0&&h!==void 0){const b=c.content.substring(Math.max(0,d),Math.min(c.content.length,h));b.trim().length>0?w=[b.trim()]:w=Br.extractSnippets(c.content,g,15)}else w=Br.extractSnippets(c.content,g,15);if(w.length===0&&y.length>0)if(d!==void 0&&h!==void 0){const b=c.content.substring(Math.max(0,d),Math.min(c.content.length,h));b.trim().length>0?w=[b.trim()]:w=Br.extractSnippets(c.content,[y],10)}else w=Br.extractSnippets(c.content,[y],10);if(o.push({document:c,relevance:p,matchedSnippets:w}),o.length>=n)break}return o.length===0?(Qr.debug("Vector search returned no results, falling back to text search"),this.fallbackTextSearch(t,r)):o}catch(s){return Qr.warn(`Vector search failed, falling back to text search: ${s}`),Qr.debug(`Vector search error details: ${s}`),this.fallbackTextSearch(t,r)}}async fallbackTextSearch(t,r={}){const n=Math.min(r.limit||Ao.DEFAULT_LIMIT,Ao.MAX_LIMIT),i=await bs(r.workspacePath);if(!i)return Qr.warn("No workspace connected, cannot perform text search"),[];const{workspacePath:a}=i,s=await ht.listDocuments(a),o=Ga(t),c=[];for(const u of s){if(r.fileType&&u.fileType!==r.fileType||!this.matchesContextScope(u,r.documentSearchScope))continue;const d=ny.calculateRelevance(u,t);if(r.minRelevance&&d<r.minRelevance)continue;const h=Br.extractSnippets(u.content,o,3);c.push({document:u,relevance:d,matchedSnippets:h})}return c.sort((u,d)=>d.relevance-u.relevance),c.slice(0,n)}formatRAGContext(t){return ON.formatRAGContext(t)}matchesContextScope(t,r){if(!r)return!0;if(r.includePaths&&r.includePaths.length>0&&!r.includePaths.some(i=>i.includes("*")||i.includes("?")?new RegExp("^"+i.replace(/\*/g,".*").replace(/\?/g,".")+"$").test(t.filePath):t.filePath.startsWith(i)||t.filePath===i)||r.excludePaths&&r.excludePaths.length>0&&r.excludePaths.some(i=>i.includes("*")||i.includes("?")?new RegExp("^"+i.replace(/\*/g,".*").replace(/\?/g,".")+"$").test(t.filePath):t.filePath.startsWith(i)||t.filePath===i)||r.pathPattern&&!(r.pathPattern instanceof RegExp?r.pathPattern:new RegExp(r.pathPattern)).test(t.filePath))return!1;if(r.tags&&r.tags.length>0){const n=t.metadata.tags||[];if(!r.tags.every(a=>n.includes(a)))return!1}return!(r.metadataFilter&&!r.metadataFilter(t))}}const RN=new TN;async function AN(e,t={}){const r=await bs(t.workspacePath);return r?RN.searchDocuments(e,{...t,workspacePath:r.workspacePath}):(Qr.warn("No workspace connected, cannot search documents"),[])}var $N=Object.defineProperty,CN=Object.getOwnPropertyDescriptor,wr=(e,t,r,n)=>{for(var i=n>1?void 0:n?CN(t,r):t,a=e.length-1,s;a>=0;a--)(s=e[a])&&(i=(n?s(t,r,i):s(i))||i);return n&&i&&$N(t,r,i),i};const La=$r("RAGSystemManager"),iy=new eh;let Zt=class extends Ob{constructor(){super(...arguments),this.documents=[],this.stats={totalDocuments:0,byWorkspace:{}},this.loading=!1,this.selectedDocument=null,this.searchQuery="",this.filterWorkspace=null,this.filterByActiveWorkspace=!0,this.filteredDocuments=[],this.searchResults=new Map,this.reindexing=!1,this.treeRef=Tb(),this.searchInputValue=""}async doInitUI(){try{await ht.initialize(),await Promise.all([this.loadDocuments(),this.loadStats()])}catch(e){La.error(`Failed to initialize document index manager: ${e}`),ft(`Failed to initialize: ${e}`)}}async loadDocuments(){this.loading=!0,this.requestUpdate();try{let e;this.filterByActiveWorkspace&&(e=(await bs())?.workspacePath),this.documents=await ht.listDocuments(e),await this.updateFilteredDocuments()}catch(e){La.error(`Failed to load documents: ${e}`),ft(`Failed to load documents: ${e}`)}finally{this.loading=!1}}async updateFilteredDocuments(){this.filteredDocuments=await this.getFilteredDocuments(),this.requestUpdate()}async loadStats(){try{this.stats=await ht.getStats(),this.requestUpdate()}catch(e){La.error(`Failed to load stats: ${e}`)}}handleTreeSelection(e){let t=e.detail?.selection||[];if(t.length===0&&this.treeRef.value&&(t=this.treeRef.value.selectedItems||[]),t.length>0){const r=t[0];r?.model?this.selectedDocument=r.model:this.selectedDocument=null}else this.selectedDocument=null}async getFilteredDocuments(){if(!this.documents||this.documents.length===0)return[];if(this.searchQuery.trim())try{const t=await AN(this.searchQuery,{limit:50,workspacePath:this.filterWorkspace||void 0});this.searchResults.clear();const r=new Map,n=new Map;for(const a of t){const s=a.document.id;r.set(s,a.document);const o=n.get(s);if(!o)n.set(s,{document:a.document,relevance:a.relevance,matchedSnippets:[...a.matchedSnippets]});else{a.relevance>o.relevance&&(o.relevance=a.relevance);const c=new Set(o.matchedSnippets);for(const u of a.matchedSnippets)c.has(u)||(o.matchedSnippets.push(u),c.add(u))}}for(const[a,s]of n)this.searchResults.set(a,s);const i=Array.from(r.values());return this.filterWorkspace?i.filter(a=>a.workspacePath===this.filterWorkspace):i}catch(t){return La.debug(`RAG search failed in document manager: ${t}`),this.searchResults.clear(),[]}else this.searchResults.clear();let e=[...this.documents];return this.filterWorkspace&&(e=e.filter(t=>t.workspacePath===this.filterWorkspace)),e}highlightMatches(e,t){if(!t||!t.trim())return ct`${e}`;const r=t.toLowerCase(),n=e.toLowerCase(),i=[];let a=0,s=n.indexOf(r,a);for(;s!==-1;)s>a&&i.push(e.substring(a,s)),i.push(ct`<mark class="search-match">${e.substring(s,s+t.length)}</mark>`),a=s+t.length,s=n.indexOf(r,a);return a<e.length&&i.push(e.substring(a)),ct`${i}`}getContentPreview(e){const t=this.searchResults.get(e.id);if(t&&t.matchedSnippets.length>0)return ct`
                <table class="snippets-table">
                    <thead>
                        <tr>
                            <th class="snippet-number-col">#</th>
                            <th class="snippet-content-col">Content</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${t.matchedSnippets.map((n,i)=>ct`
                            <tr>
                                <td class="snippet-number">${i+1}</td>
                                <td class="snippet-content">${this.highlightMatches(n,this.searchQuery)}</td>
                            </tr>
                        `)}
                    </tbody>
                </table>
            `;if(this.searchQuery&&this.searchQuery.trim()){const n=iy.extractContextSnippets(e.content,this.searchQuery,Bn.CONTEXT);if(n.length>0)return ct`
                    <table class="snippets-table">
                        <thead>
                            <tr>
                                <th class="snippet-number-col">#</th>
                                <th class="snippet-content-col">Content</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${n.map((i,a)=>ct`
                                <tr>
                                    <td class="snippet-number">${a+1}</td>
                                    <td class="snippet-content">${this.highlightMatches(e.content.substring(i.start,i.end),this.searchQuery)}</td>
                                </tr>
                            `)}
                        </tbody>
                    </table>
                `}const r=iy.extractSimpleSnippet(e.content,cN.LONG);return ct`
            <div class="snippet-preview">${r}</div>
        `}async deleteDocument(e){try{await ht.deleteDocument(e.id),er(`Deleted: ${e.fileName}`),await this.loadDocuments(),await this.loadStats(),this.selectedDocument?.id===e.id&&(this.selectedDocument=null)}catch(t){ft(`Failed to delete document: ${t}`)}}async reindexDocument(e){try{const t=await bs();if(!t){ft("No workspace connected");return}const r=await t.workspace.getResource(e.filePath);if(!r){ft(`File not found: ${e.filePath}`);return}if(!(r instanceof Or)){ft(`Resource is not a file: ${e.filePath}`);return}const n=r;await Yr.runAsync("Reindexing document",async i=>{i.message=`Reindexing ${e.fileName}...`,await ht.reindexDocument(n),i.progress=100}),er(`Reindexed: ${e.fileName}`),await this.loadDocuments(),this.selectedDocument?.id===e.id&&(this.selectedDocument=await ht.getDocument(e.id))}catch(t){ft(`Failed to reindex document: ${t}`)}}async reindexAllDocuments(){if(this.reindexing)return;const e=await ht.getStats();if(e.totalDocuments===0){er("No documents to reindex");return}this.reindexing=!0,this.requestUpdate();try{const t=await Yr.runAsync("Reindexing all documents",async r=>{r.message="Starting reindexing...";const n=e.totalDocuments,i=await ht.reindexAllDocuments(),a=i.succeeded+i.failed;return r.progress=n>0?a/n*100:100,r.message=`Reindexed ${i.succeeded}/${n} documents${i.failed>0?` (${i.failed} failed)`:""}`,i});await this.loadDocuments(),await this.loadStats(),er(`Reindexing completed: ${t.succeeded} succeeded, ${t.failed} failed`)}catch(t){La.error(`Failed to reindex all documents: ${t}`),ft(`Failed to reindex all documents: ${t}`)}finally{this.reindexing=!1,this.requestUpdate()}}formatFileSize(e){return e<1024?`${e} B`:e<1024*1024?`${(e/1024).toFixed(1)} KB`:`${(e/(1024*1024)).toFixed(1)} MB`}formatDate(e){return new Date(e).toLocaleString()}getFileIcon(e){return td.getFileIcon(e)}renderToolbar(){const e=Object.keys(this.stats?.byWorkspace||{});return ct`
            <wa-input
                type="search"
                placeholder="Search documents..."
                .value=${this.searchInputValue}
                @input=${t=>{this.searchInputValue=t.target.value,this.searchDebounceTimer&&clearTimeout(this.searchDebounceTimer),this.searchDebounceTimer=window.setTimeout(async()=>{this.searchQuery=this.searchInputValue,await this.updateFilteredDocuments()},200)}}
                @wa-clear=${async()=>{this.searchDebounceTimer&&clearTimeout(this.searchDebounceTimer),this.searchInputValue="",this.searchQuery="",await this.updateFilteredDocuments()}}
                size="small"
                with-clear
                autocomplete="off"
                style="flex: 1; max-width: 400px;">
                <wa-icon name="magnifying-glass" slot="start"></wa-icon>
            </wa-input>
            
            <wa-switch
                .checked=${this.filterByActiveWorkspace}
                @change=${async t=>{this.filterByActiveWorkspace=t.target.checked,await this.loadDocuments()}}
                size="small">
                Active workspace only
            </wa-switch>
            
            ${e.length>1?ct`
                <wa-select 
                    .value=${this.filterWorkspace||""}
                    @change=${async t=>{this.filterWorkspace=t.target.value||null,await this.updateFilteredDocuments()}}
                    size="small"
                    style="width: 200px;">
                    <wa-option value="">All Workspaces</wa-option>
                    ${e.map(t=>ct`
                        <wa-option value="${t}">${t} (${this.stats.byWorkspace[t]})</wa-option>
                    `)}
                </wa-select>
            `:fo}
            
            <k-command 
                size="small" 
                icon="arrow-rotate-right"
                title="Refresh document list"
                .action=${()=>this.loadDocuments()}
                ?disabled=${this.reindexing}>
                Refresh
            </k-command>
            
            <k-command 
                size="small" 
                icon="database"
                title="Re-index all documents"
                .action=${()=>this.reindexAllDocuments()}
                ?disabled=${this.reindexing||this.loading}>
                ${this.reindexing?"Reindexing...":"Re-index All"}
            </k-command>
        `}render(){this.stats||(this.stats={totalDocuments:0,byWorkspace:{}});const e=this.filteredDocuments,t=Object.keys(this.stats.byWorkspace||{});return ct`
            <div class="rag-system-manager">
                <div class="header">
                    <div class="header-content">
                        <div class="stats">
                            <span>Total: ${this.stats.totalDocuments} documents</span>
                            ${t.length>0?ct`
                                <span>Workspaces: ${t.length}</span>
                            `:fo}
                        </div>
                    </div>
                </div>

                <wa-split-panel position="40" style="height: 100%;">
                    <div class="document-list" slot="start">
                        ${this.loading?ct`
                            <div class="loading">
                                <wa-spinner></wa-spinner>
                                <span>Loading documents...</span>
                            </div>
                        `:e.length===0?ct`
                            <div class="empty">
                                <wa-icon name="inbox" style="font-size: 3rem; opacity: 0.3;"></wa-icon>
                                <p>${this.searchQuery||this.filterWorkspace?"No documents match your filters":"No documents indexed yet"}</p>
                            </div>
                        `:ct`
                            <wa-tree 
                                ${Rb(this.treeRef)}
                                selection="leaf"
                                style="--indent-guide-width: 1px;"
                                @wa-selection-change=${r=>{this.handleTreeSelection(r)}}>
                                ${e.map(r=>ct`
                                    <wa-tree-item 
                                        .model=${r}
                                        ?selected=${this.selectedDocument?.id===r.id}>
                                        <wa-icon name="${this.getFileIcon(r.fileType)}"></wa-icon>
                                            <div class="tree-item-info">
                                                <strong class="tree-item-path">${r.filePath}</strong>
                                                <div class="tree-item-meta">
                                                    <small class="meta-size">${this.formatFileSize(r.metadata.size)}</small>
                                                    <small class="meta-date">${this.formatDate(r.indexedAt)}</small>
                                                </div>
                                            </div>
                                            <div class="tree-item-actions" @click=${n=>n.stopPropagation()}>
                                                <wa-button
                                                    variant="neutral"
                                                    appearance="plain"
                                                    size="small"
                                                    title="Reindex"
                                                    @click=${()=>this.reindexDocument(r)}>
                                                    <wa-icon name="arrow-rotate-right"></wa-icon>
                                                </wa-button>
                                                <wa-button
                                                    variant="danger"
                                                    appearance="plain"
                                                    size="small"
                                                    title="Delete"
                                                    @click=${()=>this.deleteDocument(r)}>
                                                    <wa-icon name="trash"></wa-icon>
                                                </wa-button>
                                            </div>
                                    </wa-tree-item>
                                `)}
                            </wa-tree>
                        `}
                    </div>

                    <div slot="end">
                        ${this.selectedDocument?ct`
                            <div class="document-details">
                                <div class="details-content">
                                    <div class="metadata-grid">
                                        <wa-input
                                            label="File Path"
                                            .value=${this.selectedDocument.filePath}
                                            readonly
                                            size="small">
                                            <wa-copy-button
                                                slot="end"
                                                .value=${this.selectedDocument.filePath}
                                                size="small"
                                                label="Copy file path">
                                            </wa-copy-button>
                                        </wa-input>
                                        
                                        <wa-input
                                            label="Workspace"
                                            .value=${this.selectedDocument.workspacePath}
                                            readonly
                                            size="small">
                                            <wa-copy-button
                                                slot="end"
                                                .value=${this.selectedDocument.workspacePath}
                                                size="small"
                                                label="Copy workspace">
                                            </wa-copy-button>
                                        </wa-input>
                                        
                                        <wa-input
                                            label="File Type"
                                            .value=${this.selectedDocument.fileType}
                                            readonly
                                            size="small">
                                            <wa-copy-button
                                                slot="end"
                                                .value=${this.selectedDocument.fileType}
                                                size="small"
                                                label="Copy file type">
                                            </wa-copy-button>
                                        </wa-input>
                                        
                                        <wa-input
                                            label="Size"
                                            .value=${this.formatFileSize(this.selectedDocument.metadata.size)}
                                            readonly
                                            size="small">
                                            <wa-copy-button
                                                slot="end"
                                                .value=${this.formatFileSize(this.selectedDocument.metadata.size)}
                                                size="small"
                                                label="Copy size">
                                            </wa-copy-button>
                                        </wa-input>
                                        
                                        <wa-input
                                            label="Indexed At"
                                            .value=${this.formatDate(this.selectedDocument.indexedAt)}
                                            readonly
                                            size="small">
                                            <wa-copy-button
                                                slot="end"
                                                .value=${this.formatDate(this.selectedDocument.indexedAt)}
                                                size="small"
                                                label="Copy indexed date">
                                            </wa-copy-button>
                                        </wa-input>
                                        
                                        <wa-input
                                            label="Last Updated"
                                            .value=${this.formatDate(this.selectedDocument.updatedAt)}
                                            readonly
                                            size="small">
                                            <wa-copy-button
                                                slot="end"
                                                .value=${this.formatDate(this.selectedDocument.updatedAt)}
                                                size="small"
                                                label="Copy updated date">
                                            </wa-copy-button>
                                        </wa-input>
                                    </div>
                                    
                                    ${this.selectedDocument.metadata.tags&&this.selectedDocument.metadata.tags.length>0?ct`
                                        <div class="tags-section">
                                            <wa-input
                                                label="Tags"
                                                .value=${this.selectedDocument.metadata.tags.join(", ")}
                                                readonly
                                                size="small">
                                                <wa-copy-button
                                                    slot="end"
                                                    .value=${this.selectedDocument.metadata.tags.join(", ")}
                                                    size="small"
                                                    label="Copy tags">
                                                </wa-copy-button>
                                            </wa-input>
                                        </div>
                                    `:fo}
                                
                                    <div class="detail-section">
                                        <label>Content Preview${this.searchQuery?ct` <span class="search-hint">(showing matches for "${this.searchQuery}")</span>`:fo}</label>
                                        <wa-scroller class="content-preview" orientation="vertical">
                                            <div class="content-preview-inner">
                                                ${this.getContentPreview(this.selectedDocument)}
                                            </div>
                                        </wa-scroller>
                                    </div>
                                </div>
                            </div>
                    `:ct`
                            <div class="document-details empty">
                                <wa-icon name="file-lines" style="font-size: 3rem; opacity: 0.3;"></wa-icon>
                                <p>Select a document to view details</p>
                            </div>
                        `}
                    </div>
                </wa-split-panel>
            </div>
        `}};Zt.styles=Sb`
        :host {
            display: flex;
            flex-direction: column;
            height: 100%;
            overflow: hidden;
            min-height: 0;
        }

        .rag-system-manager {
            display: flex;
            flex-direction: column;
            height: 100%;
            min-height: 0;
            overflow: hidden;
        }

        wa-split-panel {
            flex: 1;
            min-height: 0;
            overflow: hidden;
        }

        .document-list {
            height: 100%;
            overflow-y: auto;
        }

        .tree-item-info {
            flex: 1;
            min-width: 0;
        }

        .tree-item-path {
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        .tree-item-meta {
            display: flex;
            align-items: center;
            gap: var(--wa-space-xs);
            flex-wrap: wrap;
            margin-top: var(--wa-space-xs);
        }

        .tree-item-actions {
            opacity: 0;
        }

        wa-tree-item:hover .tree-item-actions {
            opacity: 1;
        }

        .document-details {
            height: 100%;
            display: flex;
            flex-direction: column;
            min-height: 0;
            overflow: hidden;
        }

        .details-content {
            flex: 1;
            display: flex;
            flex-direction: column;
            padding: var(--wa-space-s);
            min-height: 0;
            overflow: hidden;
        }

        .metadata-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: var(--wa-space-s);
            flex-shrink: 0;
        }

        .tags-section {
            margin-top: var(--wa-space-s);
            flex-shrink: 0;
            margin-bottom: var(--wa-space-s);
        }

        .detail-section {
            flex: 1;
            display: flex;
            flex-direction: column;
            min-height: 0;
            position: relative;
        }

        .detail-section label {
            flex-shrink: 0;
            margin-bottom: var(--wa-space-xs);
        }

        .content-preview {
            position: absolute;
            top: 0;
            right: 0;
            left: 0;
            bottom: 0;
        }

        .content-preview-inner {
            width: 100%;
        }

        .snippets-table {
            width: 100%;
            border-collapse: collapse;
            background-color: var(--wa-color-surface-raised);
        }

        .snippets-table thead {
            background-color: var(--wa-color-neutral-fill-quiet);
        }

        .snippets-table th {
            padding: var(--wa-space-xs) var(--wa-space-s);
            text-align: left;
            font-size: 0.75rem;
            font-weight: 600;
            color: var(--wa-color-text-quiet);
            border-bottom: 1px solid var(--wa-color-surface-border);
        }

        .snippets-table td {
            padding: var(--wa-space-s);
            border-bottom: 1px solid var(--wa-color-surface-border);
            vertical-align: top;
        }

        .snippets-table tbody tr:last-child td {
            border-bottom: none;
        }

        .snippets-table tbody tr:hover {
            background-color: var(--wa-color-neutral-fill-quiet);
        }

        .snippet-number-col {
            width: 3rem;
            text-align: center;
        }

        .snippet-content-col {
            width: auto;
        }

        .snippet-number {
            font-size: 0.75rem;
            font-weight: 600;
            color: var(--wa-color-text-quiet);
            text-align: center;
        }

        .snippet-content {
            white-space: pre-wrap;
            word-wrap: break-word;
            overflow-wrap: break-word;
            font-family: monospace;
            font-size: 0.875rem;
            line-height: 1.5;
            color: var(--wa-color-text-normal);
        }

        .snippet-preview {
            white-space: pre-wrap;
            word-wrap: break-word;
            overflow-wrap: break-word;
            font-family: monospace;
            font-size: 0.875rem;
            line-height: 1.5;
            color: var(--wa-color-text-normal);
            padding: var(--wa-space-s);
            background-color: var(--wa-color-surface-raised);
            border-radius: var(--wa-border-radius-medium);
        }

        .snippet-content mark.search-match {
            background: var(--wa-color-warning-fill-loud);
            color: var(--wa-color-warning-text-loud);
            padding: 0 2px;
            border-radius: 2px;
            font-weight: 600;
        }
    `;wr([kb({attribute:!1})],Zt.prototype,"input",2);wr([Gr()],Zt.prototype,"documents",2);wr([Gr()],Zt.prototype,"stats",2);wr([Gr()],Zt.prototype,"loading",2);wr([Gr()],Zt.prototype,"selectedDocument",2);wr([Gr()],Zt.prototype,"searchQuery",2);wr([Gr()],Zt.prototype,"filterWorkspace",2);wr([Gr()],Zt.prototype,"filterByActiveWorkspace",2);wr([Gr()],Zt.prototype,"filteredDocuments",2);wr([Gr()],Zt.prototype,"searchResults",2);wr([Gr()],Zt.prototype,"reindexing",2);Zt=wr([Ab("k-rag-system-manager")],Zt);const ri=$r("RAGSystemExtension");function PN(e){ht.initialize().catch(t=>{ri.error(`Failed to initialize document index service: ${t}`)}),Sn({command:{id:"rag-system.index-file",name:"Index Document",description:"Index the currently selected file for search and retrieval",parameters:[{name:"includeContent",description:"Whether to include full content in index (default: true)",required:!1}]},handler:{canExecute:t=>Yn.get()instanceof Or,execute:async t=>{const r=Yn.get();if(!(r instanceof Or)){ft("Please select a file to index");return}const n=t.params?.includeContent!==!1;await Yr.runAsync("Indexing document",async i=>{i.message=`Indexing ${r.getName()}...`;try{const a=await ht.indexDocument(r,{includeContent:n});i.progress=100,er(`Document indexed: ${a.fileName}`)}catch(a){throw ft(`Failed to index document: ${a}`),a}})}}}),Sn({command:{id:"rag-system.index-workspace",name:"Index Workspace",description:"Index all indexable files in the current workspace",parameters:[{name:"includeContent",description:"Whether to include full content in index (default: true)",required:!1},{name:"maxFileSize",description:"Maximum file size in bytes to index (default: 5MB)",required:!1}]},handler:{canExecute:t=>!0,execute:async t=>{const r=await Vi.getWorkspace();if(!r){ft("No workspace selected");return}const n=t.params?.includeContent!==!1,i=t.params?.maxFileSize?parseInt(t.params.maxFileSize):void 0;await Yr.runAsync("Indexing workspace",async a=>{a.message="Collecting files...",a.progress=0;try{const s=await ht.indexWorkspace(r,{includeContent:n,maxFileSize:i});a.progress=100,s.failed>0?ft(`Indexing complete: ${s.indexed} indexed, ${s.failed} failed. Check console for details.`):er(`Workspace indexed: ${s.indexed} documents`)}catch(s){throw ft(`Failed to index workspace: ${s}`),s}})}}}),Sn({command:{id:"rag-system.list-documents",name:"List Indexed Documents",description:"List all indexed documents in the current workspace",parameters:[]},handler:{canExecute:t=>!0,execute:async t=>{const n=(await Vi.getWorkspace())?.getName();await Yr.runAsync("Loading indexed documents",async i=>{try{const a=await ht.listDocuments(n);i.progress=100,a.length===0?er("No documents indexed in this workspace"):(ri.info(`Found ${a.length} indexed documents`),er(`Found ${a.length} indexed documents (check console for details)`))}catch(a){throw ft(`Failed to list documents: ${a}`),a}})}}}),Sn({command:{id:"rag-system.delete-document",name:"Delete Document from Index",description:"Remove the selected file from the document index",parameters:[]},handler:{canExecute:t=>Yn.get()instanceof Or,execute:async t=>{const r=Yn.get();if(!(r instanceof Or)){ft("Please select a file to remove from index");return}const i=r.getWorkspace().getName(),a=r.getWorkspacePath();await Yr.runAsync("Deleting document from index",async s=>{try{const o=await ht.deleteDocumentByPath(i,a);s.progress=100,o?er(`Document removed from index: ${r.getName()}`):er(`Document not found in index: ${r.getName()}`)}catch(o){throw ft(`Failed to delete document from index: ${o}`),o}})}}}),Sn({command:{id:"rag-system.clear-workspace",name:"Clear Workspace Index",description:"Remove all indexed documents from the current workspace",parameters:[]},handler:{canExecute:t=>!0,execute:async t=>{const r=await Vi.getWorkspace();if(!r){ft("No workspace selected");return}const n=r.getName();await Yr.runAsync("Clearing workspace index",async i=>{try{const a=await ht.deleteWorkspace(n);i.progress=100,er(`Removed ${a} documents from index`)}catch(a){throw ft(`Failed to clear workspace index: ${a}`),a}})}}}),Sn({command:{id:"rag-system.get-stats",name:"Document Index Statistics",description:"Get statistics about the document index",parameters:[]},handler:{canExecute:t=>!0,execute:async t=>{await Yr.runAsync("Loading statistics",async r=>{try{const n=await ht.getStats();r.progress=100,ri.info(`Document index statistics: ${JSON.stringify(n)}`),er(`Index statistics: ${n.totalDocuments} total documents. Check console for details.`)}catch(n){throw ft(`Failed to get statistics: ${n}`),n}})}}}),Sn({command:{id:"rag-system.reindex-file",name:"Reindex Document",description:"Reindex the selected file (useful after file changes)",parameters:[]},handler:{canExecute:t=>Yn.get()instanceof Or,execute:async t=>{const r=Yn.get();if(!(r instanceof Or)){ft("Please select a file to reindex");return}await Yr.runAsync("Reindexing document",async n=>{n.message=`Reindexing ${r.getName()}...`;try{const i=await ht.reindexDocument(r);n.progress=100,er(`Document reindexed: ${i.fileName}`)}catch(i){throw ft(`Failed to reindex document: ${i}`),i}})}}}),ri.info("RAG system extension loaded"),td.registerEditorInputHandler({ranking:1e3,canHandle:t=>t.key===".system.rag-system",handle:async t=>(t.editorId="rag-system-manager",t.widgetFactory=()=>ct`
                <k-rag-system-manager .input=${t}></k-rag-system-manager>
            `,t)}),Sn({command:{id:"open-rag-system-manager",name:"Open RAG System Manager",description:"Opens the RAG system manager to view and manage indexed documents",parameters:[]},handler:{execute:t=>{const r={title:"RAG System Manager",data:{},key:".system.rag-system",icon:"database",state:{}};td.loadEditor(r).catch(n=>{ri.error(`Failed to open document index manager: ${n}`)})}},contribution:{target:Ib,icon:"database",label:"RAG System"}}),xb.registerContribution("contextmenu:filebrowser",{command:"rag-system.index-file",icon:"database",label:"Index Document",disabled:()=>!(Yn.get()instanceof Or)}),ay(()=>import("./rag-integration-r3lrVB-9-DF5BZhW1.js"),__vite__mapDeps([0,1,2,3,4])).then(t=>{t.integrateRAGWithAI(),ri.info("RAG integration enabled")}).catch(t=>{ri.warn(`Failed to load RAG integration: ${t}`)})}const QN=Object.freeze(Object.defineProperty({__proto__:null,default:PN},Symbol.toStringTag,{value:"Module"}));export{IN as R,Ao as S,eh as a,QN as b,ht as d,bs as g,RN as r,AN as s};
