import{d as f,S as c,s as h,R as m,g as y,a as g,r as w}from"./rag-system-extension-CSByfAZw.js";import{A as x,h as l,j as P,r as A}from"./main-CapkNgdd.js";import"./index-ZfqTFlZV.js";const o=x("RAGIntegration"),u=new m(new g),k={priority:10,async enhance(e,t){try{return(await f.getStats()).totalDocuments===0?e:`IMPORTANT: When a user mentions a specific file name or path:
1. ALWAYS first check if the file is indexed using rag.check-indexed with the file path
2. If indexed: Use rag.search-documents with filePath parameter to get relevant content from the indexed document
3. If not indexed: Read the file directly using file commands (cat_file, ls, etc.)

NEVER use filePath or fileName parameters in rag.search-documents without first verifying the file is indexed with rag.check-indexed. If you use a non-indexed file path/name, the search will return no results.

For general searches (not specific files), use rag.search-documents with just the query parameter to search across all indexed documents. This is more efficient than reading files one by one.

${e}`}catch(r){return o.warn(`RAG enhancement failed: ${r}`),e}}};function N(){return{type:"function",function:{name:"search_workspace_documents",description:"Search workspace documents by content, filename, or path. Use this to find relevant files and content when answering questions about the workspace. Returns documents with relevance scores and matched snippets. To reference a specific document, use filePath (exact path) or fileName (name match).",parameters:{type:"object",properties:{query:{type:"string",description:"The search query describing what you want to find (keywords, phrases, or questions). Optional if filePath or fileName is provided."},limit:{type:"number",description:"Maximum number of results to return (default: 5, max: 20)"},fileType:{type:"string",description:"Optional: filter by file extension (e.g., 'md', 'ts', 'json', 'py')"},filePath:{type:"string",description:"Optional: get a specific document by its file path (e.g., 'src/utils/helper.ts'). If provided, this takes precedence over query search."},fileName:{type:"string",description:"Optional: get documents by file name (e.g., 'README.md'). If provided, searches for documents matching this name."},includePaths:{type:"array",items:{type:"string"},description:"Optional: scope search to specific file paths or patterns (e.g., ['src/**', 'docs/*.md']). Supports wildcards * and ?."},excludePaths:{type:"array",items:{type:"string"},description:"Optional: exclude specific file paths or patterns from search (e.g., ['node_modules/**', '*.test.ts']). Supports wildcards * and ?."},pathPattern:{type:"string",description:"Optional: regex pattern to match file paths (e.g., '^src/.*\\.ts$')"}},required:[]}}}}function S(){return async(e,t)=>{if(e==="search_workspace_documents"){const r=t.query||"",n=Math.min(t.limit||c.DEFAULT_LIMIT,c.MAX_LIMIT),i=t.fileType,a=t.filePath,s=t.fileName,p=t.includePaths||t.excludePaths||t.pathPattern?{includePaths:t.includePaths,excludePaths:t.excludePaths,pathPattern:t.pathPattern}:void 0,d=await h(r,{limit:n,fileType:i,filePath:a,fileName:s,documentSearchScope:p});return{results:u.formatSearchResults(d),total:d.length}}throw new Error(`Unknown RAG tool: ${e}`)}}function I(){l({command:{id:"rag.search-documents",name:"Search Workspace Documents (RAG)",description:"Search indexed workspace documents for relevant content. IMPORTANT: Only use filePath or fileName if you have already verified the file is indexed using rag.check-indexed. If the file is not indexed, this will return no results.",parameters:[{name:"query",description:"Search query (optional if filePath or fileName is provided)",required:!1},{name:"limit",description:"Maximum number of results",required:!1},{name:"fileType",description:"Filter by file type",required:!1},{name:"filePath",description:"Exact file path to search (relative to workspace root). Only use if you verified the file is indexed with rag.check-indexed.",required:!1},{name:"fileName",description:"File name to search for (partial match supported). Only use if you verified the file is indexed with rag.check-indexed.",required:!1}]},handler:{canExecute:()=>!0,execute:async e=>{const t=e.params?.query||"",r=e.params?.limit?Math.min(parseInt(e.params.limit),c.MAX_LIMIT):c.DEFAULT_LIMIT,n=e.params?.fileType,i=e.params?.filePath,a=e.params?.fileName;if(!t&&!i&&!a)throw new Error("Either query, filePath, or fileName parameter must be provided");const s=await h(t,{limit:r,fileType:n,filePath:i,fileName:a});return(i||a)&&s.length===0?{query:t||(i?`filePath: ${i}`:`fileName: ${a}`),results:[],warning:`No indexed document found for ${i?`file path "${i}"`:`file name "${a}"`}. The file may not be indexed. Use rag.check-indexed to verify if a file is indexed before searching.`}:{query:t||(i?`filePath: ${i}`:a?`fileName: ${a}`:""),results:u.formatCommandResults(s)}}}}),l({command:{id:"rag.check-indexed",name:"Check if File is Indexed",description:"Check if a specific file is indexed in the document index. Use this to determine if you should use RAG search or read the file directly.",parameters:[{name:"filePath",description:"The file path to check (relative to workspace root)",required:!0}]},handler:{canExecute:()=>!0,execute:async e=>{const t=e.params?.filePath;if(!t)throw new Error("File path parameter required");const r=await y();if(!r)return{indexed:!1,reason:"No workspace connected"};const{workspacePath:n}=r,i=await f.getDocumentByPath(n,t);return i?{indexed:!0,filePath:i.filePath,fileName:i.fileName,fileType:i.fileType,indexedAt:new Date(i.indexedAt).toISOString(),size:i.metadata.size}:{indexed:!1,filePath:t,reason:"File not found in document index"}}}})}function T(){try{I();const e=P.promptBuilder;e&&typeof e.addEnhancer=="function"?(e.addEnhancer(k),o.info("RAG prompt enhancer and commands registered - AI will be instructed to use RAG before reading files")):(o.warn("AI service prompt builder not available yet, will retry"),setTimeout(()=>T(),1e3))}catch(e){o.warn(`Failed to integrate RAG with AI: ${e}`)}}A.put("ragService",w);export{N as createRAGSearchTool,S as createRAGToolExecutor,T as integrateRAGWithAI,k as ragPromptEnhancer,I as registerRAGCommands};
