name: Continuous Integration

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]

jobs:
  test-node18:
    uses: ./.github/workflows/reusable-test.yml
    with:
      node-version: '18'
      coverage-flags: 'unittests-node18'
      coverage-name: 'codecov-node18'

  test-node20:
    uses: ./.github/workflows/reusable-test.yml
    with:
      node-version: '20'
      coverage-flags: 'unittests-node20'
      coverage-name: 'codecov-node20'

  build:
    uses: ./.github/workflows/reusable-build.yml
    needs: [test-node18, test-node20]
    with:
      node-version: '20'
      upload-artifacts: true
      artifact-name: 'ci-build-files'
      artifact-retention-days: 7

  test-results:
    runs-on: ubuntu-latest
    needs: [test-node18, test-node20]
    if: always()

    steps:
      - name: Test Results Summary
        run: |
          echo "## ðŸ§ª Test Results Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Test Status" >> $GITHUB_STEP_SUMMARY
          echo "- **Node.js 18**: ${{ needs.test-node18.result == 'success' && 'âœ… Passed' || 'âŒ Failed' }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Node.js 20**: ${{ needs.test-node20.result == 'success' && 'âœ… Passed' || 'âŒ Failed' }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Next Steps" >> $GITHUB_STEP_SUMMARY
          echo "- Review test results in the Actions tab" >> $GITHUB_STEP_SUMMARY
          echo "- Check coverage reports for any regressions" >> $GITHUB_STEP_SUMMARY
          echo "- Fix any failing tests before merging" >> $GITHUB_STEP_SUMMARY
